{"file_contents":{"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"design_guidelines.md":{"content":"# Design Guidelines: Local Micro-Events Social Network\n\n## Design Approach: Reference-Based (Social Community + Experience Platforms)\n\n**Primary References:** Bumble BFF (warmth & belonging), Airbnb Experiences (curated local experiences), Meetup (event discovery), with elements of LinkedIn Events (professionalism)\n\n**Core Principles:**\n- Warmth over sterility: Foster psychological safety through soft, inviting aesthetics\n- Clarity over cleverness: Transparent matching reasons and event details\n- Belonging over transactions: Community-first visual language\n- Accessibility as foundation: Mobile-first, inclusive, screen-reader friendly\n\n---\n\n## Color Palette\n\n**Light Mode:**\n- Primary: 280 45% 55% (Warm purple - trust, community, belonging)\n- Primary Dark: 280 50% 45%\n- Background: 0 0% 99%\n- Surface: 0 0% 100%\n- Text Primary: 220 15% 20%\n- Text Secondary: 220 10% 45%\n- Border: 220 10% 88%\n- Success: 145 60% 45% (confirmations, matches)\n- Warning: 35 85% 60% (safety alerts)\n\n**Dark Mode:**\n- Primary: 280 50% 65%\n- Primary Dark: 280 55% 55%\n- Background: 220 15% 10%\n- Surface: 220 12% 14%\n- Text Primary: 0 0% 95%\n- Text Secondary: 220 8% 65%\n- Border: 220 10% 22%\n- Success: 145 55% 55%\n- Warning: 35 80% 65%\n\n**Accent Colors (used sparingly):**\n- Compatibility indicators: 160 45% 50% (teal), 45 75% 60% (coral), 200 50% 55% (sky blue)\n\n---\n\n## Typography\n\n**Font Stack:**\n- Primary: 'Inter', -apple-system, system-ui (UI elements, body text)\n- Display: 'Outfit', sans-serif (headings, hero text)\n\n**Scale:**\n- Hero: text-5xl md:text-6xl font-bold (display font)\n- H1: text-4xl md:text-5xl font-bold\n- H2: text-3xl md:text-4xl font-semibold\n- H3: text-2xl md:text-3xl font-semibold\n- H4: text-xl md:text-2xl font-medium\n- Body Large: text-lg font-normal\n- Body: text-base font-normal\n- Small: text-sm font-normal\n- Caption: text-xs font-medium\n\n---\n\n## Layout System\n\n**Spacing Primitives:** Tailwind units 2, 4, 6, 8, 12, 16, 24\n- Micro spacing (cards, buttons): p-4, p-6\n- Section padding: py-12, py-16, py-24\n- Container gaps: gap-6, gap-8, gap-12\n\n**Grid System:**\n- Mobile: grid-cols-1\n- Tablet: grid-cols-2 (event cards, features)\n- Desktop: grid-cols-3 (event discovery), grid-cols-4 (category filters)\n\n**Container Widths:**\n- Full-width sections: w-full with max-w-7xl mx-auto\n- Content sections: max-w-6xl mx-auto\n- Forms/questionnaires: max-w-2xl mx-auto\n- Reading content: max-w-prose\n\n---\n\n## Component Library\n\n### Core Navigation\n- **Sticky Header:** bg-surface/90 backdrop-blur-md, shadow-sm, logo left, nav center, user avatar/CTA right\n- **Mobile Nav:** Bottom tab bar with icons (Home, Events, Profile, Matches), safe-area padding\n- **Breadcrumbs:** For event detail flows, text-sm with > separators\n\n### Event Cards\n- **Compact Card:** Rounded-2xl, overflow-hidden, image aspect-video, gradient overlay on image, attendee count badge, match % indicator\n- **Detailed Card:** Adds host info, venue details, accessibility icons, \"Why this match?\" expandable section\n- **Grid Layout:** grid gap-6, 1 col mobile, 2 cols tablet, 3 cols desktop\n\n### Profile Components\n- **Compatibility Bar:** Horizontal progress bar with gradient, percentage label, animated fill\n- **Personality Radar:** SVG chart showing 5-6 dimensions (personality traits from Big Five model)\n- **Social Role Cards:** Display user's primary and secondary social role archetypes\n\n### Forms & Questionnaires\n- **Progress Indicator:** Stepped circles with connecting lines, current step highlighted\n- **Question Cards:** Large rounded cards with single question, radio/checkbox styled as rounded buttons with icons\n- **Slider Inputs:** Custom styled range inputs with labels at ends (Introvert â† â†’ Extrovert)\n- **Multi-select Tags:** Pill buttons that fill on select, allow multiple selections\n\n### Event Detail Page\n- **Hero Section:** Full-width image h-64 md:h-96, gradient overlay, title + quick info overlay at bottom\n- **Info Grid:** 2-column on desktop (left: details, right: attendees preview + booking card)\n- **Sticky Booking Card:** Fixed on desktop, bottom sheet on mobile, contains CTA, price, attendee faces\n\n### Feedback & Ratings\n- **Star Rating:** Large interactive stars (text-3xl), with hover states\n- **Match Quality Slider:** 0-10 scale with emoji indicators at key points\n- **Quick Reactions:** Emoji-based buttons for speed (ğŸ˜Š Great atmosphere, ğŸ¤ Made connections, etc.)\n\n### Admin Panel\n- **Data Tables:** Striped rows, sortable headers, search/filter bar, action buttons right-aligned\n- **Event Creator:** Multi-step form (Details â†’ Attendees â†’ Schedule â†’ Review)\n- **Dashboard Cards:** Stats with icons, trend indicators, charts using recharts library\n\n### Trust & Safety\n- **Verification Badges:** Small icons next to usernames (âœ“ ID verified), tooltip on hover\n- **Safety Banner:** Top of event pages, soft background, icon + concise text + \"Read guidelines\" link\n- **Report Button:** Subtle flag icon, opens modal with categories and description field\n\n---\n\n## Interaction Patterns\n\n**Micro-interactions:**\n- Card hover: translate-y-[-4px] + shadow-lg transition\n- Button press: scale-95 active state\n- Loading states: Skeleton screens with pulse animation for cards\n- Success feedback: Checkmark animation + brief confetti on RSVP\n\n**Page Transitions:**\n- Slide-in modals for forms (transform + opacity)\n- Fade transitions for page changes\n- Stagger animation for event card lists (delay-[100ms] increments)\n\n**Empty States:**\n- Centered illustrations (use placeholder comments), large text, friendly CTA\n\n---\n\n## Images\n\n**Hero Image:** \n- Landing page hero: Warm, diverse group of 6-8 people laughing at a casual event (coffee shop/outdoor setting), aspect ratio 16:9, full-width, h-screen on desktop, h-[70vh] mobile\n\n**Supporting Images:**\n- Event cards: Venue/activity photos, aspect-video, object-cover\n- Attendee avatars: Circular, w-10 h-10, stacked with -ml-2 for groups\n- Empty states: Friendly illustrations (calendar, people connecting, stars aligning)\n- Features section: 3 images showing app screens or event moments in rounded devices\n\n**Image Treatment:**\n- Subtle border-radius (rounded-xl to rounded-2xl)\n- Gentle gradient overlays for text readability\n- Lazy loading with blur placeholders\n\n---\n\n## Accessibility & Responsive Behavior\n\n- Touch targets min 44x44px\n- Focus rings: ring-2 ring-primary ring-offset-2\n- Form labels always visible (no placeholder-only inputs)\n- Dark mode toggle in header, persistent preference\n- Reduced motion support: prefers-reduced-motion query for animations\n- Screen reader: aria-labels on icon buttons, landmark regions\n- Mobile: Bottom sheet modals, sticky CTAs, collapsible sections\n\n---\n\n## Key Page Layouts\n\n**Landing Page:** Hero with image + centered value prop â†’ 3-column feature grid â†’ testimonial carousel â†’ \"How it works\" stepped cards â†’ Final CTA\n\n**Event Discovery Feed:** Filter bar (sticky) â†’ Personalized recommendations section â†’ Grid of event cards â†’ \"More events\" infinite scroll\n\n**Onboarding Flow:** Full-screen cards with progress bar â†’ Single question per screen â†’ Summary page with profile preview â†’ \"Find your first event\" CTA\n\n**Event Detail:** Image hero â†’ Sticky booking sidebar (desktop) / bottom CTA (mobile) â†’ Info tabs (Details, Attendees, Host, Venue) â†’ Similar events carousel\n\n**User Profile:** Cover gradient + avatar â†’ Stats row (events attended, matches made) â†’ Social role cards â†’ Personality profile â†’ Activity timeline","size_bytes":7492},"client/src/components/QuizIntro.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Mic, Clock, Brain } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface QuizIntroProps {\n  onStart: (gender: \"female\" | \"male\") => void;\n  onSkip?: () => void;\n}\n\nexport default function QuizIntro({ onStart, onSkip }: QuizIntroProps) {\n  return (\n    <div className=\"space-y-4\">\n      <Card className=\"border-0 shadow-lg bg-gradient-to-br from-primary/10 via-primary/5 to-transparent\">\n        <CardContent className=\"p-6 space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <h2 className=\"text-xl font-display font-bold\">äº†è§£ä½ çš„ç¤¾äº¤é£æ ¼</h2>\n            <Badge className=\"bg-primary/20 text-primary border-0\">\n              ä¸“å±æµ‹è¯„\n            </Badge>\n          </div>\n\n          <p className=\"text-sm text-muted-foreground\">\n            AIæ•™ç»ƒå°†ç”¨è¯­éŸ³å¼•å¯¼ä½ å®Œæˆæµ‹è¯„ï¼Œæ·±å…¥äº†è§£ä½ çš„æ€§æ ¼ç‰¹è´¨ï¼Œå‘ç°æ½œåœ¨çš„ç¤¾äº¤æŒ‘æˆ˜ï¼Œå¹¶æ‰¾åˆ°æœ€é€‚åˆä½ çš„æœ‹å‹ç±»å‹ã€‚\n          </p>\n\n          <div className=\"grid gap-3 pt-2\">\n            <div className=\"flex items-start gap-3\">\n              <div className=\"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                <Clock className=\"h-4 w-4 text-primary\" />\n              </div>\n              <div className=\"flex-1 space-y-0.5\">\n                <p className=\"text-sm font-medium\">ä»…éœ€5åˆ†é’Ÿ</p>\n                <p className=\"text-xs text-muted-foreground\">5ä¸ªè¯­éŸ³é—®é¢˜ï¼Œæ¯ä¸ªçº¦30ç§’</p>\n              </div>\n            </div>\n\n            <div className=\"flex items-start gap-3\">\n              <div className=\"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                <Mic className=\"h-4 w-4 text-primary\" />\n              </div>\n              <div className=\"flex-1 space-y-0.5\">\n                <p className=\"text-sm font-medium\">AIæ•™ç»ƒè¯­éŸ³å¼•å¯¼</p>\n                <p className=\"text-xs text-muted-foreground\">ç”¨è‡ªç„¶çš„æ–¹å¼è¡¨è¾¾çœŸå®çš„ä½ </p>\n              </div>\n            </div>\n\n            <div className=\"flex items-start gap-3\">\n              <div className=\"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                <Brain className=\"h-4 w-4 text-primary\" />\n              </div>\n              <div className=\"flex-1 space-y-0.5\">\n                <p className=\"text-sm font-medium\">AIæ·±åº¦åˆ†æ</p>\n                <p className=\"text-xs text-muted-foreground\">è·å¾—ä¸ªæ€§åŒ–çš„ç¤¾äº¤å»ºè®®å’ŒåŒ¹é…æ¨è</p>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <div className=\"space-y-3\">\n        <p className=\"text-sm font-medium text-center\">é€‰æ‹©ä½ çš„AIæ•™ç»ƒ</p>\n        <div className=\"grid grid-cols-2 gap-3\">\n          <Card \n            className=\"border shadow-sm cursor-pointer hover-elevate active-elevate-2 transition-all\"\n            onClick={() => onStart(\"female\")}\n            data-testid=\"button-select-female-coach\"\n          >\n            <CardContent className=\"p-4 text-center space-y-2\">\n              <div className=\"h-16 w-16 rounded-full bg-gradient-to-br from-pink-400/20 to-rose-400/20 flex items-center justify-center mx-auto\">\n                <span className=\"text-2xl\">ğŸ‘©</span>\n              </div>\n              <div>\n                <p className=\"font-semibold text-sm\">å°å‘¨</p>\n                <p className=\"text-xs text-muted-foreground\">ä½ çš„å¥½å§å¦¹</p>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card \n            className=\"border shadow-sm cursor-pointer hover-elevate active-elevate-2 transition-all\"\n            onClick={() => onStart(\"male\")}\n            data-testid=\"button-select-male-coach\"\n          >\n            <CardContent className=\"p-4 text-center space-y-2\">\n              <div className=\"h-16 w-16 rounded-full bg-gradient-to-br from-blue-400/20 to-indigo-400/20 flex items-center justify-center mx-auto\">\n                <span className=\"text-2xl\">ğŸ‘¨</span>\n              </div>\n              <div>\n                <p className=\"font-semibold text-sm\">Ben</p>\n                <p className=\"text-xs text-muted-foreground\">ä½ çš„å¥½å…„å¼Ÿ</p>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {onSkip && (\n        <Button \n          variant=\"ghost\" \n          className=\"w-full\"\n          onClick={onSkip}\n          data-testid=\"button-skip-intro\"\n        >\n          è·³è¿‡ï¼Œç¨åå®Œæˆ\n        </Button>\n      )}\n    </div>\n  );\n}\n","size_bytes":4663},"client/src/components/PersonalityProfile.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Sparkles, Zap } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport PersonalityRadarChart from \"./PersonalityRadarChart\";\n\ninterface PersonalityTrait {\n  name: string;\n  score: number;\n  maxScore: number;\n}\n\ninterface PersonalityProfileProps {\n  traits: PersonalityTrait[];\n  challenges: string[];\n  idealMatch: string;\n  energyLevel?: number;\n  onRetakeQuiz?: () => void;\n}\n\nconst getEnergyLevelConfig = (level: number) => {\n  if (level >= 80) return { label: \"è¶…å¼ºèƒ½é‡\", color: \"from-orange-500 to-red-500\", icon: \"ğŸ”¥\" };\n  if (level >= 60) return { label: \"é«˜èƒ½é‡\", color: \"from-yellow-500 to-orange-500\", icon: \"âš¡\" };\n  if (level >= 40) return { label: \"ä¸­ç­‰èƒ½é‡\", color: \"from-blue-500 to-indigo-500\", icon: \"ğŸ’«\" };\n  if (level >= 20) return { label: \"æ¸©å’Œèƒ½é‡\", color: \"from-teal-500 to-cyan-500\", icon: \"ğŸŒŠ\" };\n  return { label: \"æ²‰é™èƒ½é‡\", color: \"from-slate-500 to-gray-500\", icon: \"ğŸŒ™\" };\n};\n\nexport default function PersonalityProfile({ \n  traits, \n  challenges, \n  idealMatch,\n  energyLevel = 75,\n  onRetakeQuiz \n}: PersonalityProfileProps) {\n  const energyConfig = getEnergyLevelConfig(energyLevel);\n\n  return (\n    <div className=\"space-y-4\">\n      <Card className=\"border shadow-sm\">\n        <CardContent className=\"p-4 space-y-4\">\n          <div className=\"flex items-center justify-between gap-3\">\n            <h3 className=\"font-semibold\">æ€§æ ¼ç‰¹è´¨</h3>\n            {onRetakeQuiz && (\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={onRetakeQuiz}\n                data-testid=\"button-retake-quiz\"\n              >\n                é‡æ–°æµ‹è¯•\n              </Button>\n            )}\n          </div>\n\n          <PersonalityRadarChart \n            affinityScore={traits.find(t => t.name === \"äº²å’ŒåŠ›\")?.score || 0}\n            opennessScore={traits.find(t => t.name === \"å¼€æ”¾æ€§\")?.score || 0}\n            conscientiousnessScore={traits.find(t => t.name === \"è´£ä»»å¿ƒ\")?.score || 0}\n            emotionalStabilityScore={traits.find(t => t.name === \"æƒ…ç»ªç¨³å®šæ€§\")?.score || 0}\n            extraversionScore={traits.find(t => t.name === \"å¤–å‘æ€§\")?.score || 0}\n            positivityScore={traits.find(t => t.name === \"æ­£èƒ½é‡æ€§\")?.score || 0}\n          />\n\n          <div className=\"grid grid-cols-2 gap-x-4 gap-y-2 pt-2\">\n            {traits.map((trait, index) => (\n              <div key={index} className=\"flex items-center justify-between text-xs\">\n                <span className=\"text-muted-foreground truncate mr-2\">{trait.name}</span>\n                <span className=\"font-medium flex-shrink-0\">{trait.score}/{trait.maxScore}</span>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card className={`border-0 shadow-sm bg-gradient-to-r ${energyConfig.color} text-white`}>\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-1 flex-1\">\n              <div className=\"flex items-center gap-2\">\n                <Zap className=\"h-4 w-4\" />\n                <h3 className=\"font-semibold text-sm\">èƒ½é‡å€¼</h3>\n              </div>\n              <p className=\"text-xs opacity-90\">\n                {energyLevel >= 60 \n                  ? \"ä½ æ˜¯æ´»åŠ¨ä¸­çš„èƒ½é‡æºï¼Œèƒ½å¸¦åŠ¨å…¨åœºæ°›å›´\" \n                  : energyLevel >= 40\n                  ? \"ä½ èƒ½ä¸ºæ´»åŠ¨å¸¦æ¥å¹³è¡¡çš„èƒ½é‡\"\n                  : \"ä½ ç”¨ç¨³å®šçš„èƒ½é‡æ”¯æŒå›¢é˜Ÿ\"}\n              </p>\n            </div>\n            <div className=\"text-center ml-4\">\n              <div className=\"text-3xl mb-1\">{energyConfig.icon}</div>\n              <Badge variant=\"secondary\" className=\"bg-white/20 text-white border-0\">\n                {energyConfig.label}\n              </Badge>\n            </div>\n          </div>\n          <div className=\"mt-3\">\n            <div className=\"h-2 bg-white/20 rounded-full overflow-hidden\">\n              <div \n                className=\"h-full bg-white transition-all duration-500\"\n                style={{ width: `${energyLevel}%` }}\n              />\n            </div>\n            <div className=\"flex justify-between mt-1\">\n              <span className=\"text-xs opacity-75\">0</span>\n              <span className=\"text-xs font-semibold\">{energyLevel}/100</span>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card className=\"border shadow-sm bg-destructive/5\">\n        <CardContent className=\"p-4 space-y-3\">\n          <h3 className=\"font-semibold text-sm\">æ½œåœ¨å‹è°ŠæŒ‘æˆ˜</h3>\n          <div className=\"space-y-2\">\n            {challenges.map((challenge, index) => (\n              <div key={index} className=\"flex items-start gap-2 text-xs\">\n                <Sparkles className=\"h-3.5 w-3.5 text-destructive mt-0.5 flex-shrink-0\" />\n                <span className=\"text-muted-foreground leading-relaxed\">{challenge}</span>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card className=\"border shadow-sm bg-primary/5\">\n        <CardContent className=\"p-4 space-y-3\">\n          <h3 className=\"font-semibold text-sm\">ç†æƒ³æœ‹å‹ç±»å‹</h3>\n          <p className=\"text-xs text-muted-foreground leading-relaxed\">{idealMatch}</p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":5472},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":689},"client/src/components/GroupSparkMeter.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\ninterface GroupSparkMeterProps {\n  energizers: number;\n  connectors: number;\n  reflectors: number;\n}\n\nexport default function GroupSparkMeter({ energizers, connectors, reflectors }: GroupSparkMeterProps) {\n  const total = energizers + connectors + reflectors;\n  const energizerPercent = (energizers / total) * 100;\n  const reflectorPercent = (reflectors / total) * 100;\n\n  return (\n    <Card className=\"border-0 bg-muted/30\">\n      <CardHeader className=\"pb-3\">\n        <CardTitle className=\"text-sm font-semibold\">ä»Šæ™šç»„åˆ</CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        <div>\n          <div className=\"flex justify-between text-xs mb-1.5\">\n            <span className=\"text-muted-foreground\">èƒ½é‡å¹³è¡¡</span>\n            <span className=\"font-medium\">å‡è¡¡</span>\n          </div>\n          <div className=\"flex h-2 rounded-full overflow-hidden bg-muted\">\n            <div className=\"bg-gradient-to-r from-orange-400 to-red-500\" style={{ width: `${energizerPercent}%` }} />\n            <div className=\"bg-gradient-to-r from-purple-400 to-indigo-400\" style={{ width: `${100 - energizerPercent - reflectorPercent}%` }} />\n            <div className=\"bg-gradient-to-r from-emerald-400 to-teal-400\" style={{ width: `${reflectorPercent}%` }} />\n          </div>\n        </div>\n\n        <div className=\"flex gap-3 text-xs\">\n          <div className=\"flex items-center gap-1\">\n            <span>âš¡</span>\n            <span>{energizers}ä½å¯åŠ¨è€…</span>\n          </div>\n          <div className=\"flex items-center gap-1\">\n            <span>ğŸ¤</span>\n            <span>{connectors}ä½è¿æ¥è€…</span>\n          </div>\n          <div className=\"flex items-center gap-1\">\n            <span>ğŸŒ¿</span>\n            <span>{reflectors}ä½æ€è€ƒè€…</span>\n          </div>\n        </div>\n\n        <div className=\"pt-2 border-t\">\n          <p className=\"text-xs text-muted-foreground\">\n            <span className=\"font-medium text-foreground\">å…±åŒå…´è¶£ï¼š</span>æ¡Œæ¸¸ã€å±…é…’å±‹ã€ä¸­è‹±åŒè¯­\n          </p>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":2186},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1209},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport { warmupDatabase } from \"./db\";\nimport { subscriptionService } from \"./subscriptionService\";\nimport { wsService } from \"./wsService\";\nimport { scanAllActivePools } from \"./poolRealtimeMatchingService\";\n\nconst app = express();\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"â€¦\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  // Initialize WebSocket server\n  wsService.initialize(server);\n\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n    \n    // Warmup database connection to prevent autosuspend issues\n    warmupDatabase();\n    \n    // Start subscription expiry checker (runs every hour)\n    subscriptionService.startExpiryChecker();\n    \n    // Start realtime matching scheduler (runs every hour)\n    const MATCHING_SCAN_INTERVAL = 60 * 60 * 1000; // 1 hour in milliseconds\n    setInterval(() => {\n      scanAllActivePools().catch(err => {\n        console.error('[Matching Scheduler] Error scanning pools:', err);\n      });\n    }, MATCHING_SCAN_INTERVAL);\n    \n    log(`Realtime matching scheduler started (scanning every 60 minutes)`);\n    log(`WebSocket server ready at ws://0.0.0.0:${port}/ws`);\n  });\n})();\n","size_bytes":3008},"client/src/components/HeroSection.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { ArrowRight, Users, Heart, Sparkles } from \"lucide-react\";\n\nexport default function HeroSection() {\n  return (\n    <section className=\"relative overflow-hidden\">\n      <div className=\"absolute inset-0 bg-gradient-to-br from-purple-500/10 via-pink-500/10 to-orange-500/10\" />\n      \n      <div className=\"container mx-auto px-4 py-24 md:py-32 relative\">\n        <div className=\"max-w-4xl mx-auto text-center space-y-8\">\n          <div className=\"inline-flex items-center gap-2 px-4 py-2 rounded-full bg-primary/10 text-primary text-sm font-medium\">\n            <Sparkles className=\"h-4 w-4\" />\n            AI-Powered Matchmaking\n          </div>\n          \n          <h1 className=\"text-4xl md:text-6xl lg:text-7xl font-display font-bold tracking-tight\">\n            Find Your People,\n            <br />\n            <span className=\"text-primary\">One Vibe at a Time</span>\n          </h1>\n          \n          <p className=\"text-lg md:text-xl text-muted-foreground max-w-2xl mx-auto\">\n            Join curated micro-events with 5-10 like-minded locals. Our AI matches you with people who share your energy, interests, and social vibe.\n          </p>\n\n          <div className=\"flex flex-col sm:flex-row gap-4 justify-center items-center\">\n            <Button size=\"lg\" className=\"text-base px-8\" data-testid=\"button-hero-get-started\">\n              Get Started Free\n              <ArrowRight className=\"ml-2 h-5 w-5\" />\n            </Button>\n            <Button size=\"lg\" variant=\"outline\" className=\"text-base px-8\" data-testid=\"button-hero-how-it-works\">\n              How It Works\n            </Button>\n          </div>\n\n          <div className=\"flex flex-wrap justify-center gap-8 pt-8 text-sm\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                <Users className=\"h-5 w-5 text-primary\" />\n              </div>\n              <div className=\"text-left\">\n                <div className=\"font-semibold\">5-10 People</div>\n                <div className=\"text-muted-foreground\">Perfect group size</div>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                <Sparkles className=\"h-5 w-5 text-primary\" />\n              </div>\n              <div className=\"text-left\">\n                <div className=\"font-semibold\">AI Matching</div>\n                <div className=\"text-muted-foreground\">Find your vibe</div>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                <Heart className=\"h-5 w-5 text-primary\" />\n              </div>\n              <div className=\"text-left\">\n                <div className=\"font-semibold\">Safe & Inclusive</div>\n                <div className=\"text-muted-foreground\">Curated experiences</div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </section>\n  );\n}\n","size_bytes":3218},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","size_bytes":1080},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","size_bytes":1642},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","size_bytes":1202},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\nimport { zhCN } from \"date-fns/locale\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  locale = zhCN,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      locale={locale}\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2773},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"Inter\", \"var(--font-sans)\"],\n        display: [\"Outfit\", \"sans-serif\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":4102},"client/src/components/CompactEventCard.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Calendar, MapPin, Users, Sparkles } from \"lucide-react\";\nimport AttendeeAvatars from \"./AttendeeAvatars\";\n\ninterface CompactEventCardProps {\n  title: string;\n  date: string;\n  time: string;\n  location: string;\n  attendees: Array<{ name: string; initials: string }>;\n  spotsLeft: number;\n  matchScore: number;\n  imageGradient?: string;\n}\n\nexport default function CompactEventCard({\n  title,\n  date,\n  time,\n  location,\n  attendees,\n  spotsLeft,\n  matchScore,\n  imageGradient = \"from-purple-500 to-pink-500\"\n}: CompactEventCardProps) {\n  return (\n    <Card className=\"overflow-hidden hover-elevate active-elevate-2 transition-all\" data-testid={`card-event-${title.toLowerCase().replace(/\\s+/g, '-')}`}>\n      <div className=\"flex gap-3 p-3\">\n        <div className={`w-20 h-20 rounded-lg bg-gradient-to-br ${imageGradient} flex-shrink-0 relative`}>\n          <Badge className=\"absolute -top-1 -right-1 h-5 px-1.5 text-[10px] bg-background/90 backdrop-blur-sm text-foreground border-0\">\n            <Sparkles className=\"h-2.5 w-2.5 mr-0.5\" />\n            {matchScore}%\n          </Badge>\n        </div>\n        \n        <CardContent className=\"flex-1 p-0 space-y-1.5\">\n          <h3 className=\"font-semibold text-sm leading-tight line-clamp-2\">{title}</h3>\n          \n          <div className=\"flex items-center text-xs text-muted-foreground gap-1\">\n            <Calendar className=\"h-3 w-3\" />\n            <span>{date}, {time}</span>\n          </div>\n          \n          <div className=\"flex items-center text-xs text-muted-foreground gap-1\">\n            <MapPin className=\"h-3 w-3\" />\n            <span className=\"line-clamp-1\">{location}</span>\n          </div>\n          \n          <div className=\"flex items-center justify-between pt-1\">\n            <AttendeeAvatars attendees={attendees} maxDisplay={3} />\n            <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n              <Users className=\"h-3 w-3\" />\n              <span>{spotsLeft} left</span>\n            </div>\n          </div>\n        </CardContent>\n      </div>\n    </Card>\n  );\n}\n","size_bytes":2187},"client/src/components/examples/CTASection.tsx":{"content":"import CTASection from '../CTASection';\n\nexport default function CTASectionExample() {\n  return <CTASection />;\n}\n","size_bytes":114},"client/src/pages/EventDetailPage.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ArrowLeft, Clock, MapPin, DollarSign, Users, ChevronDown, Sparkles } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\nimport GroupSparkMeter from \"@/components/GroupSparkMeter\";\nimport { useState } from \"react\";\n\nexport default function EventDetailPage() {\n  const [showSafety, setShowSafety] = useState(false);\n  const [, setLocation] = useLocation();\n\n  // Mock discount data - in real app, this would come from user's coupons\n  const userDiscount = 15;\n  const originalPrice = 88;\n  const discountedPrice = Math.round(originalPrice * (1 - userDiscount / 100));\n\n  return (\n    <div className=\"min-h-screen bg-background pb-20\">\n      <div className=\"sticky top-0 z-40 bg-background/95 backdrop-blur-sm border-b\">\n        <div className=\"flex items-center h-14 px-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            onClick={() => setLocation(\"/\")}\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"ml-2 font-semibold\">æ´»åŠ¨è¯¦æƒ…</h1>\n        </div>\n      </div>\n\n      <div className=\"px-4 py-4 space-y-4\">\n        <Card className=\"border-0 shadow-lg\">\n          <CardContent className=\"p-4 space-y-3\">\n            <div className=\"flex items-start justify-between gap-3\">\n              <h2 className=\"text-2xl font-display font-bold flex-1\">å¢¨è¥¿å“¥å·æŒ‘æˆ˜èµ›</h2>\n              <div className=\"text-right\">\n                {userDiscount > 0 && (\n                  <div className=\"flex items-center gap-1 text-xs text-muted-foreground line-through mb-0.5\">\n                    <span>Â¥{originalPrice}</span>\n                  </div>\n                )}\n                <div className=\"flex items-center gap-1.5\">\n                  <span className=\"text-xl font-bold text-primary\">Â¥{discountedPrice}</span>\n                  {userDiscount > 0 && (\n                    <Badge className=\"bg-primary/10 text-primary border-0 gap-1 text-xs\">\n                      <Sparkles className=\"h-3 w-3\" />\n                      -{userDiscount}%\n                    </Badge>\n                  )}\n                </div>\n              </div>\n            </div>\n\n            {userDiscount > 0 && (\n              <Card className=\"border-0 bg-primary/5\">\n                <CardContent className=\"p-2.5\">\n                  <p className=\"text-xs text-primary flex items-center gap-1.5\">\n                    <Sparkles className=\"h-3.5 w-3.5\" />\n                    <span className=\"font-medium\">å·²è‡ªåŠ¨åº”ç”¨èƒ½é‡å¥–åŠ±ä¼˜æƒ </span>\n                  </p>\n                </CardContent>\n              </Card>\n            )}\n            \n            <p className=\"text-sm text-muted-foreground\">\n              å¿«èŠ‚å¥æ¸¸æˆ+ç²¾é…¿å•¤é…’ã€‚æœŸå¾…æ¬¢ç¬‘ã€å›¢é˜Ÿè½®æ¢å’Œå‹å¥½çš„ä¸»æŒäººã€‚\n            </p>\n\n            <div className=\"flex items-center gap-2 pt-2\">\n              <Avatar className=\"h-8 w-8\">\n                <AvatarFallback className=\"bg-primary/10 text-primary text-xs\">LN</AvatarFallback>\n              </Avatar>\n              <div className=\"text-xs\">\n                <p className=\"font-medium\">ä¸»åŠ Luna</p>\n                <p className=\"text-muted-foreground\">å¯åŠ¨è€… & ç ´å†°ä¸“å®¶ âš¡</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <div className=\"grid grid-cols-2 gap-3\">\n          <Card className=\"border-0 bg-muted/30\">\n            <CardContent className=\"p-3 flex items-center gap-2\">\n              <Clock className=\"h-4 w-4 text-primary\" />\n              <div className=\"text-xs\">\n                <p className=\"font-medium\">å¼€å§‹æ—¶é—´</p>\n                <p className=\"text-muted-foreground\">ä»Šæ™š 7:30</p>\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"border-0 bg-muted/30\">\n            <CardContent className=\"p-3 flex items-center gap-2\">\n              <MapPin className=\"h-4 w-4 text-primary\" />\n              <div className=\"text-xs\">\n                <p className=\"font-medium\">åœ°ç‚¹</p>\n                <p className=\"text-muted-foreground\">ä¸­ç¯</p>\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"border-0 bg-muted/30\">\n            <CardContent className=\"p-3 flex items-center gap-2\">\n              <DollarSign className=\"h-4 w-4 text-primary\" />\n              <div className=\"text-xs\">\n                <p className=\"font-medium\">ä»·æ ¼</p>\n                <p className=\"text-muted-foreground\">Â¥{discountedPrice}</p>\n              </div>\n            </CardContent>\n          </Card>\n          <Card className=\"border-0 bg-muted/30\">\n            <CardContent className=\"p-3 flex items-center gap-2\">\n              <Users className=\"h-4 w-4 text-primary\" />\n              <div className=\"text-xs\">\n                <p className=\"font-medium\">å‰©ä½™åé¢</p>\n                <p className=\"text-muted-foreground\">3 / 8</p>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <GroupSparkMeter energizers={3} connectors={2} reflectors={3} />\n\n        <Card className=\"border-0 bg-muted/30\">\n          <CardContent className=\"p-4 space-y-3\">\n            <h3 className=\"font-semibold text-sm\">æ´»åŠ¨æµç¨‹</h3>\n            <div className=\"space-y-2 text-xs text-muted-foreground\">\n              <div className=\"flex gap-2\">\n                <span className=\"font-medium text-foreground\">7:30</span>\n                <span>çƒ­èº« â€¢ åˆ°åœºå–é¥®å“</span>\n              </div>\n              <div className=\"flex gap-2\">\n                <span className=\"font-medium text-foreground\">7:45</span>\n                <span>ç ´å†° â€¢ å¿«é€Ÿä»‹ç»æ¸¸æˆ</span>\n              </div>\n              <div className=\"flex gap-2\">\n                <span className=\"font-medium text-foreground\">8:00</span>\n                <span>å›¢é˜Ÿè½®æ¢ â€¢ å¢¨è¥¿å“¥å·æŒ‘æˆ˜èµ›</span>\n              </div>\n              <div className=\"flex gap-2\">\n                <span className=\"font-medium text-foreground\">9:00</span>\n                <span>æ”¾æ¾ â€¢ è‡ªç”±äº¤æµ+äº¤æ¢è”ç³»æ–¹å¼</span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card \n          className=\"border-0 bg-muted/30 cursor-pointer hover-elevate active-elevate-2 transition-all\"\n          onClick={() => setShowSafety(!showSafety)}\n          data-testid=\"card-safety-comfort\"\n        >\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <h3 className=\"font-semibold text-sm\">å®‰å…¨ä¸èˆ’é€‚</h3>\n              <ChevronDown className={`h-4 w-4 transition-transform ${showSafety ? 'rotate-180' : ''}`} />\n            </div>\n            {showSafety && (\n              <div className=\"mt-3 space-y-2 text-xs text-muted-foreground\">\n                <p>â€¢ æ— éšœç¢åœºåœ°</p>\n                <p>â€¢ æä¾›ç´ é£Ÿå’Œæ¸…çœŸé€‰æ‹©</p>\n                <p>â€¢ æ— é…’ç²¾é¥®å“</p>\n                <p>â€¢ å®‰é™ä¼‘æ¯åŒº</p>\n                <p>â€¢ è¡Œä¸ºå®ˆåˆ™ä¸¥æ ¼æ‰§è¡Œ</p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-0 bg-primary/5\">\n          <CardContent className=\"p-3 space-y-2\">\n            <p className=\"text-xs font-medium\">ä¸ºä»€ä¹ˆæ¨èç»™ä½ ï¼š</p>\n            <div className=\"flex flex-wrap gap-1.5\">\n              <Badge variant=\"secondary\" className=\"text-[10px]\">ä½  + 2ä½å¯åŠ¨è€… = å®Œç¾èŠ‚å¥</Badge>\n              <Badge variant=\"secondary\" className=\"text-[10px]\">å…±åŒå…´è¶£ï¼šæ¡Œæ¸¸ã€å±…é…’å±‹</Badge>\n              <Badge variant=\"secondary\" className=\"text-[10px]\">å¹³è¡¡ï¼š3ä½é«˜èƒ½é‡ã€4ä½æ²‰æ€å‹</Badge>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"fixed bottom-0 left-0 right-0 bg-background border-t p-4 flex gap-3\">\n        <Button variant=\"outline\" className=\"flex-1\" data-testid=\"button-shortlist\">\n          æ”¶è—æ›´å¤š\n        </Button>\n        <Button className=\"flex-1\" data-testid=\"button-join\">\n          åŠ å…¥è¿™ä¸ªæ°›å›´\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":8357},"client/src/pages/MatchesPage.tsx":{"content":"import MobileHeader from \"@/components/MobileHeader\";\nimport BottomNav from \"@/components/BottomNav\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Sparkles } from \"lucide-react\";\n\n//todo: remove mock functionality\nconst matches = [\n  {\n    name: \"Sarah Johnson\",\n    initials: \"SJ\",\n    matchScore: 94,\n    sharedVibes: [\"Coffee Chats\", \"Introvert\", \"Creative\"],\n    mutualEvents: 2\n  },\n  {\n    name: \"Michael Chen\",\n    initials: \"MC\",\n    matchScore: 89,\n    sharedVibes: [\"Book Lover\", \"Tech\", \"Weekend Vibes\"],\n    mutualEvents: 1\n  },\n  {\n    name: \"Emma Davis\",\n    initials: \"ED\",\n    matchScore: 86,\n    sharedVibes: [\"Art\", \"Music\", \"Chill\"],\n    mutualEvents: 3\n  }\n];\n\nexport default function MatchesPage() {\n  return (\n    <div className=\"min-h-screen bg-background pb-16\">\n      <MobileHeader title=\"Matches\" />\n      \n      <div className=\"px-4 py-4 space-y-3\">\n        <p className=\"text-sm text-muted-foreground\">\n          People you've connected with at events\n        </p>\n\n        {matches.map((match, i) => (\n          <Card key={i} className=\"hover-elevate active-elevate-2 transition-all\" data-testid={`card-match-${match.initials.toLowerCase()}`}>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <Avatar className=\"h-12 w-12\">\n                  <AvatarFallback className=\"bg-primary/10 text-primary font-semibold\">\n                    {match.initials}\n                  </AvatarFallback>\n                </Avatar>\n                \n                <div className=\"flex-1\">\n                  <div className=\"flex items-center gap-2\">\n                    <h3 className=\"font-semibold\">{match.name}</h3>\n                    <Badge variant=\"secondary\" className=\"h-5 px-1.5 text-[10px]\">\n                      <Sparkles className=\"h-2.5 w-2.5 mr-0.5\" />\n                      {match.matchScore}%\n                    </Badge>\n                  </div>\n                  \n                  <div className=\"flex flex-wrap gap-1 mt-2\">\n                    {match.sharedVibes.slice(0, 3).map((vibe, j) => (\n                      <Badge key={j} variant=\"outline\" className=\"text-[10px] h-5 px-2\">\n                        {vibe}\n                      </Badge>\n                    ))}\n                  </div>\n                  \n                  <p className=\"text-xs text-muted-foreground mt-1.5\">\n                    {match.mutualEvents} mutual event{match.mutualEvents !== 1 ? 's' : ''}\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      <BottomNav />\n    </div>\n  );\n}\n","size_bytes":2778},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"client/src/components/FeatureCard.tsx":{"content":"import { Card, CardContent, CardHeader } from \"@/components/ui/card\";\nimport { LucideIcon } from \"lucide-react\";\n\ninterface FeatureCardProps {\n  icon: LucideIcon;\n  title: string;\n  description: string;\n}\n\nexport default function FeatureCard({ icon: Icon, title, description }: FeatureCardProps) {\n  return (\n    <Card className=\"border-0 bg-card/50\">\n      <CardHeader>\n        <div className=\"h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center mb-4\">\n          <Icon className=\"h-6 w-6 text-primary\" />\n        </div>\n        <h3 className=\"text-xl font-semibold\">{title}</h3>\n      </CardHeader>\n      <CardContent>\n        <p className=\"text-muted-foreground\">{description}</p>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":739},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"client/src/components/VoiceQuiz.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Mic, MicOff, Loader2, Volume2, Phone } from \"lucide-react\";\nimport { useState, useRef, useEffect } from \"react\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface VoiceQuizProps {\n  onComplete: (results: any) => void;\n  onSkip?: () => void;\n  coachGender: \"female\" | \"male\";\n}\n\nconst CONVERSATION_FLOW = [\n  {\n    id: 1,\n    coachPrompt: {\n      female: \"å—¨ï¼è®©æˆ‘ä»¬å¼€å§‹å§ã€‚å…ˆèŠèŠä½ çš„å‘¨æœ«ï¼Œä½ æœ€å–œæ¬¢æ€ä¹ˆåº¦è¿‡ç©ºé—²æ—¶å…‰ï¼Ÿ\",\n      male: \"å˜¿ï¼æˆ‘ä»¬å¼€å§‹å§ã€‚å‘¨æœ«çš„æ—¶å€™ä½ ä¸€èˆ¬å–œæ¬¢å¹²ä»€ä¹ˆï¼Ÿ\"\n    }\n  },\n  {\n    id: 2,\n    coachPrompt: {\n      female: \"å¬èµ·æ¥ä¸é”™ï¼é‚£é‡åˆ°æ–°æœ‹å‹çš„æ—¶å€™ï¼Œä½ æ˜¯ä¸»åŠ¨å¼€èŠçš„é‚£ä¸ªï¼Œè¿˜æ˜¯æ¯”è¾ƒæ…¢çƒ­ï¼Ÿ\",\n      male: \"æœ‰æ„æ€ã€‚ç¢°åˆ°é™Œç”Ÿäººçš„æ—¶å€™ï¼Œä½ æ˜¯é‚£ç§ä¸»åŠ¨æ­è¯çš„ç±»å‹å—ï¼Ÿ\"\n    }\n  },\n  {\n    id: 3,\n    coachPrompt: {\n      female: \"æ˜ç™½äº†ã€‚ä½ æ˜¯å–œæ¬¢æŠŠäº‹æƒ…å®‰æ’å¾—æ˜æ˜ç™½ç™½ï¼Œè¿˜æ˜¯æ›´äº«å—è¯´èµ°å°±èµ°çš„æ„Ÿè§‰ï¼Ÿ\",\n      male: \"äº†è§£ã€‚ä½ åšäº‹å–œæ¬¢æå‰è§„åˆ’ï¼Œè¿˜æ˜¯éšæœºåº”å˜ï¼Ÿ\"\n    }\n  },\n  {\n    id: 4,\n    coachPrompt: {\n      female: \"å—¯å—¯ã€‚å¦‚æœæœ‹å‹æ¥æ‰¾ä½ åæ§½çƒ¦å¿ƒäº‹ï¼Œä½ ä¼šæ€ä¹ˆå›åº”ï¼Ÿ\",\n      male: \"çŸ¥é“äº†ã€‚æœ‹å‹æ‰¾ä½ èŠé—®é¢˜çš„æ—¶å€™ï¼Œä½ ä¸€èˆ¬æ€ä¹ˆå¤„ç†ï¼Ÿ\"\n    }\n  },\n  {\n    id: 5,\n    coachPrompt: {\n      female: \"æœ€åä¸€ä¸ªé—®é¢˜å•¦ï¼ä»€ä¹ˆäº‹æƒ…èƒ½çœŸæ­£ç‚¹ç‡ƒä½ çš„çƒ­æƒ…ï¼Œè®©ä½ ç‰¹åˆ«æœ‰åŠ¨åŠ›ï¼Ÿ\",\n      male: \"æœ€åé—®ä¸€ä¸ªï¼ä»€ä¹ˆä¸œè¥¿æœ€èƒ½è®©ä½ å…´å¥‹èµ·æ¥ï¼Ÿ\"\n    }\n  }\n];\n\nexport default function VoiceQuiz({ onComplete, onSkip, coachGender }: VoiceQuizProps) {\n  const [currentStep, setCurrentStep] = useState(0);\n  const [isRecording, setIsRecording] = useState(false);\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [isCoachSpeaking, setIsCoachSpeaking] = useState(false);\n  const [coachAudioTime, setCoachAudioTime] = useState(0);\n  const [recordingTime, setRecordingTime] = useState(0);\n  const [responses, setResponses] = useState<string[]>([]);\n  const [showIntro, setShowIntro] = useState(true);\n  const [canRecord, setCanRecord] = useState(false);\n  \n  const mediaRecorderRef = useRef<MediaRecorder | null>(null);\n  const chunksRef = useRef<Blob[]>([]);\n  const recordTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const coachTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const audioStreamRef = useRef<MediaStream | null>(null);\n\n  const coachName = coachGender === \"female\" ? \"å°å‘¨\" : \"Ben\";\n  const coachGreeting = coachGender === \"female\" \n    ? \"ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„å¥½å§å¦¹å°å‘¨\" \n    : \"ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„å¥½å…„å¼ŸBen\";\n\n  useEffect(() => {\n    return () => {\n      if (recordTimerRef.current) clearInterval(recordTimerRef.current);\n      if (coachTimerRef.current) clearInterval(coachTimerRef.current);\n      if (audioStreamRef.current) {\n        audioStreamRef.current.getTracks().forEach(track => track.stop());\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (!showIntro && currentStep < CONVERSATION_FLOW.length) {\n      playCoachPrompt();\n    }\n  }, [currentStep, showIntro]);\n\n  const playCoachPrompt = async () => {\n    const step = CONVERSATION_FLOW[currentStep];\n    const prompt = step.coachPrompt[coachGender];\n    \n    setIsCoachSpeaking(true);\n    setCoachAudioTime(0);\n    setCanRecord(false);\n    \n    const estimatedDuration = Math.min(6, prompt.length * 0.08);\n    \n    coachTimerRef.current = setInterval(() => {\n      setCoachAudioTime(prev => {\n        if (prev >= estimatedDuration) {\n          if (coachTimerRef.current) clearInterval(coachTimerRef.current);\n          setIsCoachSpeaking(false);\n          setCanRecord(true);\n          return estimatedDuration;\n        }\n        return prev + 0.1;\n      });\n    }, 100);\n  };\n\n  const startIntro = () => {\n    setShowIntro(false);\n  };\n\n  const toggleRecording = async () => {\n    if (isRecording) {\n      stopRecording();\n    } else {\n      await startRecording();\n    }\n  };\n\n  const startRecording = async () => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n      audioStreamRef.current = stream;\n      \n      const mediaRecorder = new MediaRecorder(stream);\n      mediaRecorderRef.current = mediaRecorder;\n      chunksRef.current = [];\n\n      mediaRecorder.ondataavailable = (e) => {\n        if (e.data.size > 0) {\n          chunksRef.current.push(e.data);\n        }\n      };\n\n      mediaRecorder.onstop = async () => {\n        const audioBlob = new Blob(chunksRef.current, { type: 'audio/webm' });\n        await processAudio(audioBlob);\n        \n        if (audioStreamRef.current) {\n          audioStreamRef.current.getTracks().forEach(track => track.stop());\n          audioStreamRef.current = null;\n        }\n      };\n\n      mediaRecorder.start();\n      setIsRecording(true);\n      setRecordingTime(0);\n\n      recordTimerRef.current = setInterval(() => {\n        setRecordingTime(prev => prev + 1);\n      }, 1000);\n    } catch (error) {\n      console.error('Error accessing microphone:', error);\n      alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');\n    }\n  };\n\n  const stopRecording = () => {\n    if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {\n      mediaRecorderRef.current.stop();\n      setIsRecording(false);\n      \n      if (recordTimerRef.current) {\n        clearInterval(recordTimerRef.current);\n        recordTimerRef.current = null;\n      }\n    }\n  };\n\n  const processAudio = async (audioBlob: Blob) => {\n    setIsProcessing(true);\n    setCanRecord(false);\n    \n    try {\n      await new Promise(resolve => setTimeout(resolve, 1000));\n      \n      const mockResponse = `ç”¨æˆ·çš„å›ç­” ${currentStep + 1}`;\n      const newResponses = [...responses, mockResponse];\n      setResponses(newResponses);\n\n      if (currentStep < CONVERSATION_FLOW.length - 1) {\n        setCurrentStep(currentStep + 1);\n      } else {\n        await analyzeResponses(newResponses);\n      }\n    } catch (error) {\n      console.error('Error processing audio:', error);\n      alert('å¤„ç†éŸ³é¢‘æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');\n      setCanRecord(true);\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  const analyzeResponses = async (allResponses: string[]) => {\n    setIsProcessing(true);\n    \n    try {\n      await new Promise(resolve => setTimeout(resolve, 2000));\n      \n      const results = {\n        traits: [\n          { name: \"äº²å’ŒåŠ›\", score: 8, maxScore: 10 },\n          { name: \"å¼€æ”¾æ€§\", score: 7, maxScore: 10 },\n          { name: \"è´£ä»»å¿ƒ\", score: 6, maxScore: 10 },\n          { name: \"å¤–å‘æ€§\", score: 5, maxScore: 10 },\n          { name: \"æƒ…ç»ªç¨³å®šæ€§\", score: 8, maxScore: 10 }\n        ],\n        challenges: [\n          \"å¯èƒ½å¯¹çªç„¶çš„è®¡åˆ’å˜æ›´æ„Ÿåˆ°ä¸é€‚åº”\",\n          \"åœ¨å¤§å‹ç¤¾äº¤åœºåˆä¸­å¯èƒ½éœ€è¦ç‹¬å¤„æ—¶é—´æ¢å¤èƒ½é‡\"\n        ],\n        idealMatch: \"ä½ ä¼šåœ¨ä¸åŒæ ·é‡è§†æ·±åº¦å¯¹è¯ã€æ¬£èµè®¡åˆ’æ€§æ´»åŠ¨ä½†ä¹Ÿèƒ½äº«å—å¶å°”å³å…´æ—¶åˆ»çš„æœ‹å‹ç›¸å¤„ä¸­æ„Ÿåˆ°æ„‰å¿«ã€‚å¯»æ‰¾é‚£äº›èƒ½ç†è§£ä½ éœ€è¦ç‹¬å¤„æ—¶é—´ã€åŒæ—¶ä¹Ÿäº«å—æœ‰æ„ä¹‰ç¤¾äº¤äº’åŠ¨çš„äººã€‚\",\n        energyLevel: 75\n      };\n\n      onComplete(results);\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  if (showIntro) {\n    return (\n      <Card className=\"border-0 shadow-lg bg-gradient-to-br from-primary/10 to-transparent\">\n        <CardContent className=\"p-8 flex flex-col items-center justify-center space-y-6 min-h-[400px]\">\n          <div className=\"relative\">\n            <div className=\"h-24 w-24 rounded-full bg-primary/20 flex items-center justify-center\">\n              <Phone className=\"h-12 w-12 text-primary\" />\n            </div>\n            <div className=\"absolute -inset-2 rounded-full bg-primary/10 animate-pulse\" />\n          </div>\n          \n          <div className=\"text-center space-y-2\">\n            <h3 className=\"text-xl font-display font-bold\">{coachName} æ•™ç»ƒ</h3>\n            <p className=\"text-sm text-muted-foreground max-w-xs\">\n              {coachGreeting}ã€‚æ¥ä¸‹æ¥å°±åƒæ‰“ç”µè¯èŠå¤©ä¸€æ ·ï¼Œæˆ‘é—®ä½ ç­”ï¼Œå¾ˆè½»æ¾ï¼\n            </p>\n          </div>\n\n          <Button \n            size=\"lg\"\n            onClick={startIntro}\n            data-testid=\"button-start-with-coach\"\n            className=\"mt-4\"\n          >\n            å¼€å§‹è¯­éŸ³é€šè¯\n          </Button>\n\n          {onSkip && (\n            <Button \n              variant=\"ghost\"\n              onClick={onSkip}\n              data-testid=\"button-skip-coach\"\n            >\n              è·³è¿‡è¯­éŸ³å¼•å¯¼\n            </Button>\n          )}\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const step = CONVERSATION_FLOW[currentStep];\n  const progress = ((currentStep + (isProcessing ? 1 : 0)) / CONVERSATION_FLOW.length) * 100;\n\n  if (isProcessing) {\n    return (\n      <Card className=\"border shadow-sm\">\n        <CardContent className=\"p-8 flex flex-col items-center justify-center space-y-4 min-h-[500px]\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n          <p className=\"text-sm text-muted-foreground text-center\">\n            {currentStep === CONVERSATION_FLOW.length - 1 \n              ? \"æ­£åœ¨åˆ†ææ‚¨çš„æ€§æ ¼ç‰¹è´¨...\" \n              : \"ç†è§£ä¸­...\"}\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n        <span>é—®é¢˜ {currentStep + 1} / {CONVERSATION_FLOW.length}</span>\n        <span>{Math.round(progress)}%</span>\n      </div>\n\n      <Card className=\"border-0 shadow-lg bg-gradient-to-br from-emerald-500/10 via-teal-500/5 to-transparent min-h-[500px] flex flex-col\">\n        <CardContent className=\"p-6 flex-1 flex flex-col\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <div className=\"flex items-center gap-2\">\n              <div className={`h-2 w-2 rounded-full ${isCoachSpeaking ? 'bg-primary animate-pulse' : 'bg-muted'}`} />\n              <span className=\"text-sm font-medium\">{coachName}</span>\n            </div>\n            {isCoachSpeaking && (\n              <Badge variant=\"secondary\" className=\"gap-1.5 text-xs\">\n                <Volume2 className=\"h-3 w-3\" />\n                {coachAudioTime.toFixed(1)}s\n              </Badge>\n            )}\n          </div>\n\n          <div className=\"flex-1 flex flex-col items-center justify-center space-y-8\">\n            <div className=\"relative w-full max-w-sm aspect-square flex items-center justify-center\">\n              {isCoachSpeaking ? (\n                <>\n                  <div className=\"absolute inset-0 flex items-center justify-center\">\n                    <div className=\"h-32 w-48 rounded-full border-4 border-primary/40\" \n                         style={{ \n                           transform: `scale(${1 + Math.sin(coachAudioTime * 3) * 0.1})`,\n                           transition: 'transform 0.1s ease-out'\n                         }} \n                    />\n                  </div>\n                  <div className=\"absolute inset-0 flex items-center justify-center\">\n                    <div className=\"h-40 w-56 rounded-full border-2 border-primary/20\" \n                         style={{ \n                           transform: `scale(${1 + Math.sin(coachAudioTime * 3 + 0.5) * 0.15})`,\n                           transition: 'transform 0.1s ease-out'\n                         }} \n                    />\n                  </div>\n                </>\n              ) : isRecording ? (\n                <>\n                  <div className=\"absolute inset-0 flex items-center justify-center\">\n                    <div className=\"h-32 w-48 rounded-full border-4 border-destructive/40\" \n                         style={{ \n                           transform: `scale(${1 + Math.sin(recordingTime * 2) * 0.08})`,\n                           transition: 'transform 0.1s ease-out'\n                         }} \n                    />\n                  </div>\n                  <div className=\"absolute inset-0 flex items-center justify-center\">\n                    <div className=\"h-40 w-56 rounded-full border-2 border-destructive/20\" \n                         style={{ \n                           transform: `scale(${1 + Math.sin(recordingTime * 2 + 0.5) * 0.12})`,\n                           transition: 'transform 0.1s ease-out'\n                         }} \n                    />\n                  </div>\n                </>\n              ) : (\n                <div className=\"h-32 w-48 rounded-full border-4 border-muted\" />\n              )}\n            </div>\n\n            <div className=\"text-center space-y-3 w-full px-4\">\n              <p className=\"text-base font-medium\">\n                {step.coachPrompt[coachGender]}\n              </p>\n              {canRecord && !isRecording && (\n                <p className=\"text-xs text-muted-foreground\">\n                  ç‚¹å‡»éº¦å…‹é£å›ç­”\n                </p>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flex flex-col items-center space-y-4 pt-4 mt-auto\">\n            <Button\n              size=\"icon\"\n              variant={isRecording ? \"destructive\" : \"default\"}\n              className=\"h-20 w-20 rounded-full\"\n              onClick={toggleRecording}\n              disabled={isCoachSpeaking || isProcessing}\n              data-testid={isRecording ? \"button-stop-recording\" : \"button-start-recording\"}\n            >\n              {isRecording ? (\n                <MicOff className=\"h-8 w-8\" />\n              ) : (\n                <Mic className=\"h-8 w-8\" />\n              )}\n            </Button>\n            \n            <div className=\"text-center\">\n              {isCoachSpeaking ? (\n                <p className=\"text-xs text-muted-foreground\">æ•™ç»ƒè¯´è¯ä¸­...</p>\n              ) : isRecording ? (\n                <Badge variant=\"destructive\" className=\"gap-1.5\">\n                  <div className=\"h-2 w-2 rounded-full bg-white animate-pulse\" />\n                  å½•éŸ³ä¸­ {recordingTime}s\n                </Badge>\n              ) : canRecord ? (\n                <p className=\"text-xs text-muted-foreground\">æŒ‰ä½éº¦å…‹é£è¯´è¯ï¼Œæ¾å¼€ç»“æŸ</p>\n              ) : (\n                <p className=\"text-xs text-muted-foreground\">ç­‰å¾…ä¸­...</p>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":14440},"client/src/components/BottomNav.tsx":{"content":"import { Compass, Calendar, MessageSquare, User } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useNotificationCounts } from \"@/hooks/useNotificationCounts\";\n\ninterface NavItem {\n  icon: any;\n  label: string;\n  path: string;\n  testId: string;\n  badgeCategory?: 'discover' | 'activities' | 'chat';\n}\n\nconst navItems: NavItem[] = [\n  { icon: Compass, label: \"å‘ç°\", path: \"/\", testId: \"nav-discover\", badgeCategory: 'discover' },\n  { icon: Calendar, label: \"æ´»åŠ¨\", path: \"/events\", testId: \"nav-events\", badgeCategory: 'activities' },\n  { icon: MessageSquare, label: \"èŠå¤©\", path: \"/chats\", testId: \"nav-chats\", badgeCategory: 'chat' },\n  { icon: User, label: \"æˆ‘çš„\", path: \"/profile\", testId: \"nav-profile\" }\n];\n\nexport default function BottomNav() {\n  const [location] = useLocation();\n  const { data: notificationCounts } = useNotificationCounts();\n\n  return (\n    <nav className=\"fixed bottom-0 left-0 right-0 bg-background border-t z-50 safe-area-pb\">\n      <div className=\"flex items-center justify-around h-16\">\n        {navItems.map((item) => {\n          const isActive = location === item.path;\n          const badgeCount = item.badgeCategory && notificationCounts \n            ? notificationCounts[item.badgeCategory] \n            : 0;\n          const showBadge = badgeCount > 0;\n          \n          return (\n            <a\n              key={item.path}\n              href={item.path}\n              className={`relative flex flex-col items-center justify-center flex-1 h-full gap-1 transition-colors ${\n                isActive ? \"text-primary\" : \"text-muted-foreground\"\n              }`}\n              data-testid={item.testId}\n            >\n              <div className=\"relative w-6 h-6 flex items-center justify-center\">\n                <item.icon className={`h-5 w-5 ${isActive ? \"fill-primary/20\" : \"\"}`} />\n                {showBadge && (\n                  <Badge \n                    className=\"absolute -top-2 -right-2 h-[18px] min-w-[18px] px-1.5 flex items-center justify-center text-[11px] font-semibold bg-primary text-primary-foreground animate-pulse pointer-events-none\"\n                    data-testid={`badge-${item.testId}`}\n                  >\n                    {badgeCount > 99 ? '99+' : badgeCount}\n                  </Badge>\n                )}\n              </div>\n              <span className=\"text-xs font-medium\">{item.label}</span>\n            </a>\n          );\n        })}\n      </div>\n    </nav>\n  );\n}\n","size_bytes":2520},"client/src/components/examples/MobileHeader.tsx":{"content":"import MobileHeader from '../MobileHeader';\n\nexport default function MobileHeaderExample() {\n  return <MobileHeader title=\"Discover\" showNotification={true} />;\n}\n","size_bytes":163},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"client/src/components/examples/JoyEventCard.tsx":{"content":"import JoyEventCard from '../JoyEventCard';\n\nexport default function JoyEventCardExample() {\n  return (\n    <div className=\"max-w-sm p-4\">\n      <JoyEventCard\n        id=\"1\"\n        title=\"å¢¨è¥¿å“¥å·æŒ‘æˆ˜èµ›\"\n        time=\"æ™šä¸Š 7:30\"\n        area=\"ä¸­ç¯\"\n        price=\"Â¥88\"\n        vibes={[\n          { emoji: \"âš¡\", label: \"æ´»åŠ›\", gradient: \"from-orange-400 to-red-500\" },\n          { emoji: \"ğŸˆ\", label: \"ç©ä¹\", gradient: \"from-pink-400 to-rose-400\" },\n          { emoji: \"ğŸ¤\", label: \"ç¤¾äº¤\", gradient: \"from-violet-400 to-purple-400\" }\n        ]}\n        spotsLeft={3}\n        myFit={92}\n        groupSpark=\"High\"\n        vibeGradient=\"from-orange-400 via-red-400 to-pink-500\"\n        iconName=\"pizza\"\n        socialProof=\"3ä½æœ‹å‹çš„æœ‹å‹å·²åŠ å…¥\"\n      />\n    </div>\n  );\n}\n","size_bytes":801},"client/src/pages/EventsPage.tsx":{"content":"import MobileHeader from \"@/components/MobileHeader\";\nimport BottomNav from \"@/components/BottomNav\";\nimport PendingMatchCard from \"@/components/PendingMatchCard\";\nimport MatchedEventCard from \"@/components/MatchedEventCard\";\nimport CompletedEventCard from \"@/components/CompletedEventCard\";\nimport PoolRegistrationCard from \"@/components/PoolRegistrationCard\";\nimport SlidingTabs from \"@/components/SlidingTabs\";\nimport { useState, useEffect } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMarkNotificationsAsRead } from \"@/hooks/useNotificationCounts\";\nimport { useWebSocket } from \"@/hooks/useWebSocket\";\nimport { invalidateCacheForEvent } from \"@/lib/cacheInvalidation\";\nimport type { BlindBoxEvent, EventFeedback } from \"@shared/schema\";\n\n// æ¸©åº¦ç­‰çº§emojiè¾…åŠ©å‡½æ•°\nfunction getTemperatureEmoji(temperatureLevel: string): string {\n  const emojiMap: Record<string, string> = {\n    \"fire\": \"ğŸ”¥\",\n    \"warm\": \"ğŸŒ¡ï¸\",\n    \"mild\": \"ğŸŒ¤ï¸\",\n    \"cold\": \"â„ï¸\"\n  };\n  return emojiMap[temperatureLevel] || \"ğŸŒ¤ï¸\";\n}\n\ninterface PoolRegistration {\n  id: string;\n  poolId: string;\n  matchStatus: \"pending\" | \"matched\" | \"completed\";\n  assignedGroupId: string | null;\n  matchScore: number | null;\n  registeredAt: string;\n  poolTitle: string;\n  poolEventType: string;\n  poolCity: string;\n  poolDistrict: string;\n  poolDateTime: string;\n  poolStatus: string;\n  budgetRange: string[];\n  preferredLanguages: string[];\n  socialGoals: string[];\n  invitationRole?: \"inviter\" | \"invitee\" | null;\n  relatedUserName?: string | null;\n}\n\nexport default function EventsPage() {\n  const [activeTab, setActiveTab] = useState<\"pending\" | \"matched\" | \"completed\">(\"pending\");\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const markAsRead = useMarkNotificationsAsRead();\n  const { subscribe } = useWebSocket();\n\n  // Auto-clear activities notifications when entering the page\n  useEffect(() => {\n    markAsRead.mutate('activities');\n  }, []);\n\n  // WebSocketå®æ—¶æ›´æ–°è®¢é˜…\n  useEffect(() => {\n    const unsubscribeMatched = subscribe('EVENT_MATCHED', async (message) => {\n      console.log('[User] Event matched:', message);\n      await invalidateCacheForEvent(message);\n      \n      const matchData = message.data as any;\n      toast({\n        title: \"åŒ¹é…æˆåŠŸï¼\",\n        description: `ä½ çš„æ´»åŠ¨å·²æˆåŠŸåŒ¹é…ï¼Œåœ°ç‚¹ï¼š${matchData.restaurantName || 'æœªçŸ¥'}`,\n      });\n      \n      // è‡ªåŠ¨åˆ‡æ¢åˆ°\"å·²åŒ¹é…\"æ ‡ç­¾\n      setActiveTab(\"matched\");\n    });\n\n    const unsubscribePoolMatched = subscribe('POOL_MATCHED', async (message) => {\n      console.log('[User] Pool matched:', message);\n      \n      // åˆ·æ–°æ´»åŠ¨æ± æŠ¥åè®°å½•ç¼“å­˜\n      await queryClient.invalidateQueries({ queryKey: [\"/api/my-pool-registrations\"] });\n      \n      const poolData = message.data as any;\n      const tempEmoji = getTemperatureEmoji(poolData.temperatureLevel || 'mild');\n      toast({\n        title: `${tempEmoji} æ´»åŠ¨æ± åŒ¹é…æˆåŠŸï¼`,\n        description: `ä½ å·²æˆåŠŸåŒ¹é…åˆ° ${poolData.poolTitle} çš„ç¬¬${poolData.groupNumber}ç»„ï¼Œå…±${poolData.memberCount}äººï¼ŒåŒ¹é…åº¦${poolData.matchScore}åˆ†`,\n      });\n      \n      // è‡ªåŠ¨åˆ‡æ¢åˆ°\"å·²åŒ¹é…\"æ ‡ç­¾\n      setActiveTab(\"matched\");\n    });\n\n    const unsubscribeStatus = subscribe('EVENT_STATUS_CHANGED', async (message) => {\n      console.log('[User] Event status changed:', message);\n      await invalidateCacheForEvent(message);\n      \n      const statusData = message.data as any;\n      if (statusData.newStatus === 'completed') {\n        toast({\n          title: \"æ´»åŠ¨å·²å®Œæˆ\",\n          description: \"æœŸå¾…ä½ çš„åé¦ˆï¼\",\n        });\n        setActiveTab(\"completed\");\n      } else if (statusData.newStatus === 'canceled') {\n        toast({\n          title: \"æ´»åŠ¨å·²å–æ¶ˆ\",\n          description: statusData.reason || \"æ´»åŠ¨å·²è¢«å–æ¶ˆ\",\n          variant: \"destructive\",\n        });\n      }\n    });\n\n    const unsubscribeCompleted = subscribe('EVENT_COMPLETED', async (message) => {\n      console.log('[User] Event completed:', message);\n      await invalidateCacheForEvent(message);\n    });\n\n    return () => {\n      unsubscribeMatched();\n      unsubscribePoolMatched();\n      unsubscribeStatus();\n      unsubscribeCompleted();\n    };\n  }, [subscribe, toast, queryClient]);\n\n  const { data: events, isLoading } = useQuery<Array<BlindBoxEvent>>({\n    queryKey: [\"/api/my-events\"],\n  });\n\n  // Fetch pool registrations\n  const { data: poolRegistrations, isLoading: isLoadingPoolRegistrations } = useQuery<Array<PoolRegistration>>({\n    queryKey: [\"/api/my-pool-registrations\"],\n  });\n\n  // Fetch feedback data for completed events\n  const { data: feedbacks } = useQuery<Array<EventFeedback>>({\n    queryKey: [\"/api/my-feedbacks\"],\n  });\n\n  const cancelMutation = useMutation({\n    mutationFn: async (eventId: string) => {\n      return await apiRequest(\"POST\", `/api/blind-box-events/${eventId}/cancel`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/my-events\"] });\n      toast({\n        title: \"å·²å–æ¶ˆ\",\n        description: \"æ´»åŠ¨å·²å–æ¶ˆï¼Œè´¹ç”¨å°†åŸè·¯é€€å›\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"å–æ¶ˆå¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const pendingEvents = events?.filter(e => e.status === \"pending_match\") || [];\n  const matchedEvents = events?.filter(e => e.status === \"matched\") || [];\n  const completedEvents = events?.filter(e => e.status === \"completed\") || [];\n\n  const pendingPoolRegistrations = poolRegistrations?.filter(r => r.matchStatus === \"pending\") || [];\n  const matchedPoolRegistrations = poolRegistrations?.filter(r => r.matchStatus === \"matched\") || [];\n  const completedPoolRegistrations = poolRegistrations?.filter(r => r.matchStatus === \"completed\") || [];\n\n  const totalPending = pendingEvents.length + pendingPoolRegistrations.length;\n  const totalMatched = matchedEvents.length + matchedPoolRegistrations.length;\n  const totalCompleted = completedEvents.length + completedPoolRegistrations.length;\n\n  if (isLoading || isLoadingPoolRegistrations) {\n    return (\n      <div className=\"min-h-screen bg-background pb-16\">\n        <MobileHeader title=\"æ´»åŠ¨\" />\n        <div className=\"flex items-center justify-center py-12\">\n          <div className=\"text-center space-y-4\">\n            <div className=\"h-8 w-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n            <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n          </div>\n        </div>\n        <BottomNav />\n      </div>\n    );\n  }\n\n  const tabs = [\n    { value: \"pending\", label: \"åŒ¹é…ä¸­\", count: totalPending },\n    { value: \"matched\", label: \"å·²åŒ¹é…\", count: totalMatched },\n    { value: \"completed\", label: \"å·²å®Œæˆ\", count: totalCompleted },\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-background pb-16\">\n      <MobileHeader title=\"æ´»åŠ¨\" />\n      \n      <div className=\"py-4 space-y-4\">\n        <p className=\"text-sm text-muted-foreground px-4\">\n          å±•ç¤ºä½ å·²æŠ¥åçš„ç›²ç›’ä¸å·²åŒ¹é…æ´»åŠ¨\n        </p>\n\n        <SlidingTabs \n          tabs={tabs}\n          activeTab={activeTab}\n          onTabChange={(value) => setActiveTab(value as typeof activeTab)}\n        />\n\n        <div className=\"px-4\">\n          {activeTab === \"pending\" && (\n            <div className=\"space-y-3\">\n              {totalPending === 0 ? (\n                <div className=\"text-center py-12\">\n                  <div className=\"mb-4\">\n                    <div className=\"h-16 w-16 rounded-full bg-muted mx-auto flex items-center justify-center\">\n                      <svg className=\"h-8 w-8 text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                      </svg>\n                    </div>\n                  </div>\n                  <h3 className=\"font-semibold mb-2\">æš‚æ— åŒ¹é…ä¸­çš„æ´»åŠ¨</h3>\n                  <p className=\"text-sm text-muted-foreground\">å»å‘ç°é¡µæŠ¥åæ–°æ´»åŠ¨å§</p>\n                </div>\n              ) : (\n                <>\n                  {pendingPoolRegistrations.map(registration => (\n                    <PoolRegistrationCard \n                      key={registration.id} \n                      registration={registration} \n                    />\n                  ))}\n                  {pendingEvents.map(event => (\n                    <PendingMatchCard \n                      key={event.id} \n                      event={event} \n                      onCancel={(eventId) => cancelMutation.mutate(eventId)}\n                    />\n                  ))}\n                </>\n              )}\n            </div>\n          )}\n\n          {activeTab === \"matched\" && (\n            <div className=\"space-y-3\">\n              {totalMatched === 0 ? (\n                <div className=\"text-center py-12\">\n                  <div className=\"mb-4\">\n                    <div className=\"h-16 w-16 rounded-full bg-muted mx-auto flex items-center justify-center\">\n                      <svg className=\"h-8 w-8 text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z\" />\n                      </svg>\n                    </div>\n                  </div>\n                  <h3 className=\"font-semibold mb-2\">æš‚æ— å·²åŒ¹é…çš„æ´»åŠ¨</h3>\n                  <p className=\"text-sm text-muted-foreground\">åŒ¹é…æˆåŠŸåä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>\n                </div>\n              ) : (\n                <>\n                  {matchedPoolRegistrations.map(registration => (\n                    <PoolRegistrationCard \n                      key={registration.id} \n                      registration={registration} \n                    />\n                  ))}\n                  {matchedEvents.map(event => (\n                    <MatchedEventCard key={event.id} event={event} />\n                  ))}\n                </>\n              )}\n            </div>\n          )}\n\n          {activeTab === \"completed\" && (\n            <div className=\"space-y-3\">\n              {totalCompleted === 0 ? (\n                <div className=\"text-center py-12\">\n                  <div className=\"mb-4\">\n                    <div className=\"h-16 w-16 rounded-full bg-muted mx-auto flex items-center justify-center\">\n                      <svg className=\"h-8 w-8 text-muted-foreground\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                      </svg>\n                    </div>\n                  </div>\n                  <h3 className=\"font-semibold mb-2\">æš‚æ— å·²å®Œæˆçš„æ´»åŠ¨</h3>\n                  <p className=\"text-sm text-muted-foreground\">å‚åŠ è¿‡çš„æ´»åŠ¨ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>\n                </div>\n              ) : (\n                <>\n                  {completedPoolRegistrations.map(registration => (\n                    <PoolRegistrationCard \n                      key={registration.id} \n                      registration={registration} \n                    />\n                  ))}\n                  {completedEvents.map(event => {\n                    const feedback = feedbacks?.find(f => f.eventId === event.id);\n                    return (\n                      <CompletedEventCard \n                        key={event.id} \n                        event={event} \n                        feedback={feedback}\n                      />\n                    );\n                  })}\n                </>\n              )}\n            </div>\n          )}\n        </div>\n      </div>\n\n      <BottomNav />\n    </div>\n  );\n}\n","size_bytes":12327},"client/src/components/Header.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport ThemeToggle from \"./ThemeToggle\";\nimport { Sparkles } from \"lucide-react\";\n\nexport default function Header() {\n  return (\n    <header className=\"sticky top-0 z-50 w-full border-b bg-background/80 backdrop-blur-md\">\n      <div className=\"container mx-auto flex h-16 items-center justify-between px-4\">\n        <div className=\"flex items-center gap-2\">\n          <Sparkles className=\"h-6 w-6 text-primary\" />\n          <span className=\"text-xl font-display font-bold\">Vibe</span>\n        </div>\n        \n        <nav className=\"hidden md:flex items-center gap-6\">\n          <a href=\"#events\" className=\"text-sm font-medium hover-elevate px-3 py-2 rounded-md transition-colors\" data-testid=\"link-events\">\n            Events\n          </a>\n          <a href=\"#how-it-works\" className=\"text-sm font-medium hover-elevate px-3 py-2 rounded-md transition-colors\" data-testid=\"link-how-it-works\">\n            How It Works\n          </a>\n          <a href=\"#community\" className=\"text-sm font-medium hover-elevate px-3 py-2 rounded-md transition-colors\" data-testid=\"link-community\">\n            Community\n          </a>\n        </nav>\n\n        <div className=\"flex items-center gap-2\">\n          <ThemeToggle />\n          <Button variant=\"ghost\" className=\"hidden md:inline-flex\" data-testid=\"button-login\">\n            Log In\n          </Button>\n          <Button data-testid=\"button-get-started\">Get Started</Button>\n        </div>\n      </div>\n    </header>\n  );\n}\n","size_bytes":1515},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"client/src/pages/ProfilePage.tsx":{"content":"import MobileHeader from \"@/components/MobileHeader\";\nimport BottomNav from \"@/components/BottomNav\";\nimport PersonalityProfile from \"@/components/PersonalityProfile\";\nimport SocialRoleCard from \"@/components/SocialRoleCard\";\nimport QuizIntro from \"@/components/QuizIntro\";\nimport EditFullProfileDialog from \"@/components/EditFullProfileDialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Edit, LogOut, Shield, HelpCircle, Sparkles, User, GraduationCap, Briefcase, Heart, Star, Quote, Target, Users } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { archetypeConfig } from \"@/lib/archetypes\";\nimport { archetypeGradients, archetypeAvatars, archetypeEmojis } from \"@/lib/archetypeAvatars\";\nimport { getTopCompatibleArchetypes, getCompatibilityCategory } from \"@/lib/archetypeCompatibility\";\nimport {\n  getGenderDisplay,\n  calculateAge,\n  formatAge,\n  getEducationDisplay,\n  getStudyLocaleDisplay,\n  getSeniorityDisplay,\n  getRelationshipDisplay,\n  getChildrenDisplay,\n  formatArray,\n} from \"@/lib/userFieldMappings\";\n\ntype SectionType = \"basic\" | \"education\" | \"work\" | \"personal\" | \"interests\";\n\nexport default function ProfilePage() {\n  const [, setLocation] = useLocation();\n  const [showQuizIntro, setShowQuizIntro] = useState(false);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const { toast } = useToast();\n  \n  const { data: user, isLoading: userLoading } = useQuery<any>({ queryKey: [\"/api/auth/user\"] });\n  const { data: personalityResults } = useQuery<any>({\n    queryKey: [\"/api/personality-test/results\"],\n    enabled: !!user?.hasCompletedPersonalityTest,\n  });\n  const { data: stats, isLoading: statsLoading } = useQuery<{ eventsCompleted: number; connectionsMade: number }>({\n    queryKey: [\"/api/profile/stats\"],\n    enabled: !!user,\n  });\n\n  const { data: roleDistribution } = useQuery<Record<string, number>>({\n    queryKey: [\"/api/personality/role-distribution\"],\n    enabled: !!personalityResults?.primaryRole,\n  });\n\n  const updateProfileMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"PATCH\", \"/api/profile\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"ä¿å­˜æˆåŠŸ\",\n        description: \"ä¸ªäººä¿¡æ¯å·²æ›´æ–°\",\n      });\n      setEditDialogOpen(false);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"ä¿å­˜å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleEditClick = () => {\n    setEditDialogOpen(true);\n  };\n\n  const handleSaveProfile = (data: any) => {\n    updateProfileMutation.mutate(data);\n  };\n\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", \"/api/auth/logout\");\n    },\n    onSuccess: () => {\n      queryClient.clear();\n      toast({\n        title: \"å·²é€€å‡ºç™»å½•\",\n        description: \"æ‚¨å·²æˆåŠŸé€€å‡ºç™»å½•\",\n      });\n      setLocation(\"/auth/phone\");\n    },\n    onError: () => {\n      toast({\n        title: \"é€€å‡ºå¤±è´¥\",\n        description: \"é€€å‡ºç™»å½•æ—¶å‡ºç°é—®é¢˜ï¼Œè¯·é‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleLogout = () => {\n    logoutMutation.mutate();\n  };\n\n  const hasCompletedQuiz = !!user?.hasCompletedPersonalityTest;\n  \n  const personalityData = hasCompletedQuiz && personalityResults ? {\n    traits: [\n      { name: \"äº²å’ŒåŠ›\", score: personalityResults.affinityScore || 0, maxScore: 10 },\n      { name: \"å¼€æ”¾æ€§\", score: personalityResults.opennessScore || 0, maxScore: 10 },\n      { name: \"è´£ä»»å¿ƒ\", score: personalityResults.conscientiousnessScore || 0, maxScore: 10 },\n      { name: \"å¤–å‘æ€§\", score: personalityResults.extraversionScore || 0, maxScore: 10 },\n      { name: \"æƒ…ç»ªç¨³å®šæ€§\", score: personalityResults.emotionalStabilityScore || 0, maxScore: 10 },\n      { name: \"æ­£èƒ½é‡æ€§\", score: personalityResults.positivityScore || 0, maxScore: 10 }\n    ],\n    challenges: personalityResults.challenges ? [personalityResults.challenges] : [],\n    idealMatch: personalityResults.idealFriendTypes?.join('ã€') || personalityResults.idealFriendTypes?.[0] || \"\",\n    energyLevel: 75 // Default energy level for now\n  } : null;\n\n  const handleStartQuiz = () => {\n    setLocation(\"/personality-test\");\n  };\n\n  const getUserName = () => {\n    if (user?.displayName) return user.displayName;\n    if (user?.firstName && user?.lastName) return `${user.firstName} ${user.lastName}`;\n    if (user?.firstName) return user.firstName;\n    return \"ç”¨æˆ·\";\n  };\n\n  const getArchetypeAvatar = () => {\n    const archetype = user?.primaryRole || \"è¿æ¥è€…\";\n    const config = archetypeConfig[archetype] || archetypeConfig[\"è¿æ¥è€…\"];\n    return {\n      icon: config.icon,\n      bgColor: config.bgColor,\n      color: config.color,\n    };\n  };\n\n  const getArchetypeDetails = () => {\n    const archetype = personalityResults?.primaryRole || user?.primaryRole;\n    if (!archetype) return null;\n    \n    const config = archetypeConfig[archetype];\n    if (!config) return null;\n    \n    return {\n      epicDescription: config.epicDescription,\n      styleQuote: config.styleQuote,\n      coreContributions: config.coreContributions,\n    };\n  };\n\n  const handleEditProfile = () => {\n    setLocation(\"/profile/edit\");\n  };\n\n  const avatarConfig = getArchetypeAvatar();\n  const archetypeDetails = getArchetypeDetails();\n\n  return (\n    <div className=\"min-h-screen bg-background pb-16\">\n      <MobileHeader \n        title=\"æˆ‘çš„\" \n        showSettings={true}\n      />\n      \n      <div className=\"px-4 py-4 space-y-4\">\n        {/* Profile Header Card */}\n        <Card className=\"border shadow-sm\">\n          <CardContent className=\"p-6\">\n            {userLoading || statsLoading ? (\n              <div className=\"flex items-center gap-4\">\n                <Skeleton className=\"h-16 w-16 rounded-full\" />\n                <div className=\"flex-1 space-y-2\">\n                  <Skeleton className=\"h-6 w-32\" />\n                  <Skeleton className=\"h-4 w-48\" />\n                </div>\n              </div>\n            ) : (\n              <div className=\"flex items-center gap-4\">\n                <div className={`h-16 w-16 rounded-full ${avatarConfig.bgColor} flex items-center justify-center text-3xl`}>\n                  {avatarConfig.icon}\n                </div>\n                <div className=\"flex-1\">\n                  <h2 className=\"text-xl font-bold\">{getUserName()}</h2>\n                  <div className=\"flex gap-4 mt-1 text-sm text-muted-foreground\">\n                    <span data-testid=\"text-events-completed\">{stats?.eventsCompleted || 0} æ¬¡æ´»åŠ¨</span>\n                    <span data-testid=\"text-connections-made\">{stats?.connectionsMade || 0} ä¸ªè¿æ¥</span>\n                  </div>\n                </div>\n                <Button \n                  variant=\"default\"\n                  onClick={handleEditProfile}\n                  data-testid=\"button-edit-profile\"\n                  className=\"shrink-0\"\n                >\n                  <Edit className=\"h-4 w-4 mr-2\" />\n                  ç¼–è¾‘èµ„æ–™\n                </Button>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Social Role Card - Show if test completed */}\n        {hasCompletedQuiz && personalityResults && (\n          <SocialRoleCard\n            primaryRole={personalityResults.primaryRole}\n            secondaryRole={personalityResults.secondaryRole}\n            primaryRoleScore={personalityResults.primaryRoleScore}\n            secondaryRoleScore={personalityResults.secondaryRoleScore}\n          />\n        )}\n\n        {/* Role Details Card - Show rich archetype content */}\n        {hasCompletedQuiz && personalityResults && archetypeDetails && (\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Sparkles className=\"w-5 h-5 text-primary\" />\n                è§’è‰²æ·±åº¦è§£è¯»\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {/* Epic Description */}\n              {archetypeDetails.epicDescription && (\n                <div className=\"space-y-2\">\n                  <p className=\"text-sm leading-relaxed text-foreground/90\" data-testid=\"text-epic-description\">\n                    {archetypeDetails.epicDescription}\n                  </p>\n                </div>\n              )}\n\n              {/* Style Quote */}\n              {archetypeDetails.styleQuote && (\n                <div className={`relative bg-gradient-to-br ${archetypeGradients[personalityResults.primaryRole] || 'from-purple-500 to-pink-500'} bg-opacity-10 rounded-lg p-4 border-l-4 border-primary/50`}>\n                  <Quote className=\"w-6 h-6 text-primary/40 absolute top-2 left-2\" />\n                  <p className=\"text-sm font-medium italic text-foreground pl-8\" data-testid=\"text-style-quote\">\n                    {archetypeDetails.styleQuote}\n                  </p>\n                </div>\n              )}\n\n              {/* Core Contributions */}\n              {archetypeDetails.coreContributions && (\n                <div className=\"flex items-start gap-3 bg-muted/30 rounded-lg p-3\">\n                  <Target className=\"w-5 h-5 text-primary mt-0.5 flex-shrink-0\" />\n                  <div className=\"space-y-1\">\n                    <p className=\"text-xs font-semibold text-muted-foreground\">æ ¸å¿ƒè´¡çŒ®</p>\n                    <p className=\"text-sm font-medium text-foreground\" data-testid=\"text-core-contributions\">\n                      {archetypeDetails.coreContributions}\n                    </p>\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Social Proof Card */}\n        {hasCompletedQuiz && personalityResults && roleDistribution && (\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Users className=\"w-5 h-5 text-primary\" />\n                å…¨å¹³å°ç¤¾ç¾¤åˆ†å¸ƒ\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <div className=\"text-center py-3\">\n                <div className=\"text-3xl font-bold text-primary mb-2\">\n                  {roleDistribution[personalityResults.primaryRole] || 8}%\n                </div>\n                <p className=\"text-sm text-muted-foreground\">\n                  å…¨å¹³å°<span className=\"font-semibold text-foreground\">{roleDistribution[personalityResults.primaryRole] || 8}%</span>çš„ç”¨æˆ·ä¹Ÿæ˜¯<span className=\"font-semibold text-foreground\">{personalityResults.primaryRole}</span>\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Archetype Compatibility Preview Card */}\n        {hasCompletedQuiz && personalityResults && (\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Heart className=\"w-5 h-5 text-red-500\" />\n                æœ€ä½³æ­æ¡£\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <p className=\"text-sm text-muted-foreground\">\n                ä½œä¸º<span className=\"font-semibold text-foreground\">{personalityResults.primaryRole}</span>ï¼Œä½ åœ¨æ´»åŠ¨ä¸­æœ€æœ‰åŒ–å­¦ååº”çš„è§’è‰²ï¼š\n              </p>\n              <div className=\"space-y-2\">\n                {getTopCompatibleArchetypes(personalityResults.primaryRole, 3).map((match) => (\n                  <div key={match.archetype} className=\"flex items-center justify-between p-3 rounded-lg bg-muted/30\">\n                    <div className=\"flex items-center gap-3 flex-1\">\n                      <img \n                        src={archetypeAvatars[match.archetype]} \n                        alt={match.archetype}\n                        className=\"h-10 w-10 rounded-full object-cover\"\n                      />\n                      <div>\n                        <div className=\"font-semibold text-sm\">{match.archetype}</div>\n                        <div className=\"text-xs text-muted-foreground\">{getCompatibilityCategory(match.score)}</div>\n                      </div>\n                    </div>\n                    <div className=\"text-lg font-bold text-primary\">{match.score}%</div>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {!hasCompletedQuiz ? (\n          <Card className=\"border shadow-sm bg-gradient-to-br from-primary/10 to-transparent cursor-pointer hover-elevate active-elevate-2\" onClick={() => setShowQuizIntro(true)}>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between gap-3\">\n                <div className=\"flex-1 space-y-1\">\n                  <div className=\"flex items-center gap-2\">\n                    <Sparkles className=\"h-4 w-4 text-primary\" />\n                    <p className=\"font-semibold text-sm\">å‘ç°ä½ çš„ç¤¾äº¤é£æ ¼</p>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    å®Œæˆ5åˆ†é’Ÿè¯­éŸ³æµ‹è¯„ï¼Œè·å¾—ä¸ªæ€§åŒ–çš„æœ‹å‹åŒ¹é…æ¨è\n                  </p>\n                </div>\n                <Button size=\"sm\" data-testid=\"button-take-quiz\">\n                  å¼€å§‹\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        ) : personalityData ? (\n          <PersonalityProfile\n            traits={personalityData.traits}\n            challenges={personalityData.challenges}\n            idealMatch={personalityData.idealMatch}\n            energyLevel={personalityData.energyLevel}\n            onRetakeQuiz={handleStartQuiz}\n          />\n        ) : null}\n\n        <Card className=\"border shadow-sm\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-base\">è´¦æˆ·</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-2\">\n            <Button variant=\"ghost\" className=\"w-full justify-start\" data-testid=\"button-safety\">\n              <Shield className=\"h-4 w-4 mr-3\" />\n              å®‰å…¨ä¸éšç§\n            </Button>\n            <Button variant=\"ghost\" className=\"w-full justify-start\" data-testid=\"button-help\">\n              <HelpCircle className=\"h-4 w-4 mr-3\" />\n              å¸®åŠ©ä¸æ”¯æŒ\n            </Button>\n            <Button \n              variant=\"ghost\" \n              className=\"w-full justify-start text-destructive\" \n              data-testid=\"button-logout\"\n              onClick={handleLogout}\n              disabled={logoutMutation.isPending}\n            >\n              <LogOut className=\"h-4 w-4 mr-3\" />\n              {logoutMutation.isPending ? \"é€€å‡ºä¸­...\" : \"é€€å‡ºç™»å½•\"}\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n\n      <BottomNav />\n\n      {showQuizIntro && (\n        <div className=\"fixed inset-0 bg-background z-50 overflow-y-auto\">\n          <div className=\"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b\">\n            <div className=\"flex items-center h-14 px-4\">\n              <Button \n                variant=\"ghost\" \n                size=\"icon\" \n                onClick={() => setShowQuizIntro(false)}\n                data-testid=\"button-close-quiz-intro\"\n              >\n                <span className=\"text-lg\">â†</span>\n              </Button>\n              <h1 className=\"ml-2 font-semibold\">æ€§æ ¼æµ‹è¯„</h1>\n            </div>\n          </div>\n          <div className=\"p-4\">\n            <QuizIntro \n              onStart={handleStartQuiz}\n              onSkip={() => setShowQuizIntro(false)}\n            />\n          </div>\n        </div>\n      )}\n\n    </div>\n  );\n}\n","size_bytes":16174},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4281},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"client/src/components/examples/JoyJoinLogo.tsx":{"content":"import JoyJoinLogo from '../JoyJoinLogo';\n\nexport default function JoyJoinLogoExample() {\n  return (\n    <div className=\"flex flex-col gap-4 p-4\">\n      <JoyJoinLogo size=\"sm\" />\n      <JoyJoinLogo size=\"md\" />\n      <JoyJoinLogo size=\"lg\" />\n      <JoyJoinLogo size=\"md\" showEnglish={false} />\n    </div>\n  );\n}\n","size_bytes":313},"client/src/components/examples/OnboardingPreview.tsx":{"content":"import OnboardingPreview from '../OnboardingPreview';\n\nexport default function OnboardingPreviewExample() {\n  return (\n    <div className=\"p-8\">\n      <OnboardingPreview />\n    </div>\n  );\n}\n","size_bytes":191},"client/src/components/OnboardingPreview.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useState } from \"react\";\n\nconst interests = [\n  \"Coffee Chats\", \"Board Games\", \"Hiking\", \"Art & Culture\", \n  \"Food & Drinks\", \"Tech & Startups\", \"Fitness\", \"Music\"\n];\n\nexport default function OnboardingPreview() {\n  const [energyLevel, setEnergyLevel] = useState([50]);\n  const [selectedInterests, setSelectedInterests] = useState<string[]>([]);\n\n  const toggleInterest = (interest: string) => {\n    setSelectedInterests(prev => \n      prev.includes(interest) \n        ? prev.filter(i => i !== interest)\n        : [...prev, interest]\n    );\n  };\n\n  return (\n    <Card className=\"max-w-2xl mx-auto\">\n      <CardHeader>\n        <div className=\"flex items-center justify-between mb-2\">\n          <span className=\"text-sm text-muted-foreground\">Step 1 of 5</span>\n          <div className=\"flex gap-1\">\n            {[1, 2, 3, 4, 5].map(step => (\n              <div \n                key={step}\n                className={`h-1.5 w-8 rounded-full ${step === 1 ? 'bg-primary' : 'bg-muted'}`}\n              />\n            ))}\n          </div>\n        </div>\n        <CardTitle className=\"text-2xl font-display\">What's your vibe?</CardTitle>\n        <p className=\"text-muted-foreground\">Help us understand your social energy and interests</p>\n      </CardHeader>\n      \n      <CardContent className=\"space-y-6\">\n        <div className=\"space-y-3\">\n          <Label className=\"text-base\">Energy Level</Label>\n          <div className=\"flex items-center gap-4\">\n            <span className=\"text-sm text-muted-foreground\">Introvert</span>\n            <Slider\n              value={energyLevel}\n              onValueChange={setEnergyLevel}\n              max={100}\n              step={1}\n              className=\"flex-1\"\n              data-testid=\"slider-energy-level\"\n            />\n            <span className=\"text-sm text-muted-foreground\">Extrovert</span>\n          </div>\n        </div>\n\n        <div className=\"space-y-3\">\n          <Label className=\"text-base\">Interests (Select all that apply)</Label>\n          <div className=\"flex flex-wrap gap-2\">\n            {interests.map(interest => (\n              <Badge\n                key={interest}\n                variant={selectedInterests.includes(interest) ? \"default\" : \"outline\"}\n                className=\"cursor-pointer hover-elevate active-elevate-2 px-4 py-2\"\n                onClick={() => toggleInterest(interest)}\n                data-testid={`badge-interest-${interest.toLowerCase().replace(/\\s+/g, '-')}`}\n              >\n                {interest}\n              </Badge>\n            ))}\n          </div>\n        </div>\n\n        <div className=\"flex gap-3 pt-4\">\n          <Button variant=\"outline\" className=\"flex-1\" data-testid=\"button-onboarding-back\">\n            Back\n          </Button>\n          <Button className=\"flex-1\" data-testid=\"button-onboarding-next\">\n            Next\n          </Button>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":3196},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":844},"replit.md":{"content":"# Local Micro-Events Social Network (JoyJoin)\n\n## Overview\n\nJoyJoin (æ‚¦èšÂ·Joy) is a social networking platform designed to connect individuals locally through small, curated micro-events (5-10 attendees). The platform leverages AI for intelligent user matching based on interests, personality, and social compatibility, with a strong emphasis on psychological safety and inclusivity. Primarily targeting the Hong Kong/Shenzhen market, JoyJoin aims to foster meaningful local connections and build community. Key capabilities include AI-powered matching for events and people, a comprehensive feedback system for continuous algorithm refinement, streamlined event management, and a robust Admin Portal for platform oversight and analytics. A core innovation is the 12-Archetype Animal Social Vibe System, which categorizes user social energy and personality for sophisticated group dynamics and chemistry matching.\n\n## Recent Changes\n\n### November 24, 2025 - Archetype Rich Content Enhancement\n- **Extended Archetype System:** Added 5 new rich content fields to all 12 animal archetypes:\n  - `nickname`: Vivid Chinese nickname (e.g., \"æ‘‡å°¾ç‚¹ç«å®˜\")\n  - `tagline`: One-line positioning statement (e.g., \"ç¬é—´ç ´å†°çš„æ°”æ°›ç‚¹ç«æ‰‹\")\n  - `epicDescription`: Detailed paragraph describing the role's essence\n  - `styleQuote`: Unique style quote with quotation formatting\n  - `coreContributions`: Key contribution statement (e.g., \"ç ´å†°å¯åŠ¨ï¼Œåˆ›é€ æ¬¢ä¹æ°›å›´\")\n- **UI Enhancements:**\n  - Updated PersonalityTestResultPage Hero section to display nickname and tagline instead of simple description\n  - Added new \"è§’è‰²æ·±åº¦è§£è¯»\" (Role Details) card showing epicDescription, styleQuote, and coreContributions\n  - Updated SocialRoleCard component to display nickname and tagline for richer information display\n- **Design Improvements:** Implemented quote-style formatting for styleQuote with gradient backgrounds and icon, target icon for core contributions, and improved visual hierarchy\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend\n- **Frameworks:** React 18 with TypeScript, Vite, Wouter for routing.\n- **UI/Styling:** Radix UI primitives, shadcn/ui (New York style), Tailwind CSS. The design is mobile-first, supports dark mode, uses a purple-centric warm color palette, and is bilingual (Chinese/English).\n- **State Management:** TanStack Query for server state.\n- **Key UI Patterns:** Bottom navigation, event cards, two-part match scoring, personality radar charts, social role cards, progressive disclosure.\n- **Design Principles:** Emphasizes warmth, accessibility, and responsive design.\n\n### Backend\n- **Runtime:** Node.js with Express.js, TypeScript.\n- **API Design:** RESTful API.\n- **Payment System:** Integrated WeChat Pay structure.\n\n### Data Storage\n- **Database:** PostgreSQL (Neon serverless) with Drizzle ORM.\n- **Schema:** Users, Events, Matching Algorithm data, Feedback/Ratings, and Admin Portal entities (venues, eventTemplates, subscriptions, payments, coupons).\n- **Migrations:** Drizzle Kit.\n\n### Authentication & Authorization\n- **User Authentication:** Phone number + SMS verification.\n- **Session Management:** `express-session` with PostgreSQL storage.\n- **Admin Authorization:** `isAdmin` flag for portal access.\n\n### System Features & Design Decisions\n- **Two-Stage Event Pool Matching Model:** Admin creates event pools with hard constraints (time, location), and users register with soft preferences. AI matches users within pools using a 5-dimensional algorithm (personality, interest, background, conversation, intent) and a 12-Archetype Animal Social Vibe System for group chemistry. This system includes a real-time dynamic matching service that continuously scans pools with adaptive thresholds and a time decay algorithm to ensure successful matching.\n- **AI-Driven Matchmaking:** Utilizes AI for sophisticated event and people matching, considering personality, interests, and group dynamics, with a focus on explainability and a deep feedback system for continuous learning.\n- **Two-Tier Feedback Architecture:** Implements both basic and optional anonymous deep feedback mechanisms to refine the matching algorithms.\n- **Gamified Personality Assessment:** A 10-question test determines social role archetypes, visualized with a Personality Radar Chart, and requiring all users to retake for the new 12-archetype system.\n- **Streamlined Onboarding:** A multi-step registration process covers identity, interests, personality, and profile creation.\n- **Admin Portal:** A desktop-first interface for comprehensive management of users, subscriptions, events, finance, moderation, and insights. This includes an Admin Matching Lab for real-time algorithm tuning.\n- **Payment & Subscription System:** Full payment infrastructure including WeChat Pay integration, webhook handling, and subscription management.\n- **Intelligent Venue Matching & Booking:** Algorithm-based venue scoring and a transactional booking system with race condition protection.\n- **Real-Time Bidirectional Data Sync (WebSocket):** Production-ready WebSocket for instant data synchronization, crucial for event status updates and notifications.\n- **Data Insights Dashboard:** A comprehensive analytics dashboard provides key performance indicators, user segmentation, activity quality, retention, revenue conversion, and social role distribution.\n\n## External Dependencies\n\n### Core Frameworks\n- **React Ecosystem:** `react`, `react-dom`, `@tanstack/react-query`.\n- **Routing:** `wouter`.\n- **Build Tools:** `vite`.\n\n### UI Component Libraries\n- **Radix UI:** `@radix-ui/react-*`.\n- **Styling:** `tailwindcss`, `autoprefixer`, `postcss`, `class-variance-authority`, `clsx`, `tailwind-merge`, `lucide-react`.\n\n### Database & ORM\n- **Database:** `@neondatabase/serverless` (PostgreSQL).\n- **ORM:** `drizzle-orm`, `drizzle-kit`.\n- **Validation:** `drizzle-zod`, `zod`.\n\n### Authentication\n- `express-session`, `connect-pg-simple`.\n\n### Development Tools\n- `typescript`, `tsx`.\n\n### Form Handling\n- `@hookform/resolvers`.\n\n### Date/Time Utilities\n- `date-fns`.","size_bytes":6152},"server/storage.ts":{"content":"import { \n  type User, type UpsertUser, type UpdateProfile, type UpdateFullProfile, type UpdatePersonality,\n  type Event, type EventAttendance, type ChatMessage, type EventFeedback, type BlindBoxEvent,\n  type InsertEventAttendance, type InsertChatMessage, type InsertEventFeedback,\n  type RegisterUser, type InsertTestResponse, type InsertRoleResult, type RoleResult, type InterestsTopics,\n  type Notification, type InsertNotification, type NotificationCounts,\n  type DirectMessageThread, type DirectMessage, type InsertDirectMessageThread, type InsertDirectMessage,\n  type Content, type InsertContent,\n  type ChatReport, type InsertChatReport, type ChatLog, type InsertChatLog,\n  users, events, eventAttendance, chatMessages, eventFeedback, blindBoxEvents, testResponses, roleResults, notifications,\n  directMessageThreads, directMessages, payments, coupons, couponUsage, subscriptions, contents, chatReports, chatLogs\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, and, desc, sql, or, gte, lte } from \"drizzle-orm\";\n\nexport interface IStorage {\n  // User operations\n  getUser(id: string): Promise<User | undefined>;\n  getAllUsers(): Promise<User[]>;\n  getUserByPhone(phoneNumber: string): Promise<User[]>;\n  createUserWithPhone(data: { phoneNumber: string; email: string; firstName: string; lastName: string }): Promise<User>;\n  upsertUser(user: UpsertUser): Promise<User>;\n  updateProfile(id: string, profile: UpdateProfile): Promise<User>;\n  updateFullProfile(id: string, profile: UpdateFullProfile): Promise<User>;\n  updatePersonality(id: string, personality: UpdatePersonality): Promise<User>;\n  updateUser(id: string, updates: Partial<User>): Promise<User>;\n  markProfileSetupComplete(id: string): Promise<void>;\n  markVoiceQuizComplete(id: string): Promise<void>;\n  registerUser(id: string, data: RegisterUser): Promise<User>;\n  markRegistrationComplete(id: string): Promise<void>;\n  markPersonalityTestComplete(id: string): Promise<void>;\n  updateInterestsTopics(id: string, data: InterestsTopics): Promise<User>;\n  \n  // Personality test operations\n  saveTestResponses(userId: string, responses: Record<number, any>): Promise<void>;\n  saveRoleResult(userId: string, result: InsertRoleResult): Promise<RoleResult>;\n  getRoleResult(userId: string): Promise<RoleResult | undefined>;\n  getPersonalityDistribution(): Promise<Record<string, number>>;\n  \n  // Event operations\n  getUserJoinedEvents(userId: string): Promise<Array<Event & { attendanceStatus: string; attendeeCount: number; participants: Array<{ id: string; displayName: string | null; archetype: string | null }> }>>;\n  getEventParticipants(eventId: string): Promise<Array<User>>;\n  \n  // Chat operations\n  getEventMessages(eventId: string): Promise<Array<ChatMessage & { user: User }>>;\n  createChatMessage(userId: string, message: InsertChatMessage): Promise<ChatMessage>;\n  \n  // Feedback operations\n  getUserAllFeedbacks(userId: string): Promise<Array<EventFeedback>>;\n  getUserFeedback(userId: string, eventId: string): Promise<EventFeedback | undefined>;\n  getEventFeedbacks(eventId: string): Promise<Array<EventFeedback>>;\n  createEventFeedback(userId: string, feedback: InsertEventFeedback): Promise<EventFeedback>;\n  updateEventFeedbackDeep(userId: string, eventId: string, deepData: any): Promise<EventFeedback>;\n\n  // Direct message operations\n  findDirectMessageThread(userId1: string, userId2: string, eventId: string): Promise<DirectMessageThread | undefined>;\n  createDirectMessageThread(data: InsertDirectMessageThread): Promise<DirectMessageThread>;\n  getUserDirectMessageThreads(userId: string): Promise<Array<DirectMessageThread & { otherUser: User; lastMessage?: DirectMessage }>>;\n  getThreadMessages(threadId: string): Promise<Array<DirectMessage & { sender: User }>>;\n  sendDirectMessage(senderId: string, data: InsertDirectMessage): Promise<DirectMessage>;\n\n  // Blind Box Event operations\n  getAllBlindBoxEvents(): Promise<Array<BlindBoxEvent>>;\n  getUserBlindBoxEvents(userId: string): Promise<Array<BlindBoxEvent>>;\n  getBlindBoxEventById(eventId: string, userId: string): Promise<BlindBoxEvent | undefined>;\n  createBlindBoxEvent(userId: string, eventData: { \n    date: string; \n    time: string; \n    eventType: string; \n    city: string;\n    area: string; \n    budget: string[]; \n    acceptNearby?: boolean;\n    selectedLanguages?: string[];\n    selectedTasteIntensity?: string[];\n    selectedCuisines?: string[];\n    inviteFriends?: boolean;\n    friendsCount?: number;\n  }): Promise<BlindBoxEvent>;\n  updateBlindBoxEventPreferences(eventId: string, userId: string, preferences: {\n    budget?: string[];\n    acceptNearby?: boolean;\n    selectedLanguages?: string[];\n    selectedTasteIntensity?: string[];\n    selectedCuisines?: string[];\n  }): Promise<BlindBoxEvent>;\n  cancelBlindBoxEvent(eventId: string, userId: string): Promise<BlindBoxEvent>;\n  setBlindBoxEventMatchData(eventId: string, userId: string, matchData: {\n    matchedAttendees: any[];\n    matchExplanation?: string;\n  }): Promise<BlindBoxEvent>;\n  \n  // Notification operations\n  getNotificationCounts(userId: string): Promise<{ discover: number; activities: number; chat: number; total: number }>;\n  markNotificationsAsRead(userId: string, category: string): Promise<void>;\n  createNotification(data: {\n    userId: string;\n    category: string;\n    type: string;\n    title: string;\n    message?: string;\n    relatedResourceId?: string;\n  }): Promise<void>;\n\n  // Admin Notification operations\n  getAdminNotifications(adminId: string): Promise<Array<Notification & { recipientCount: number; readCount: number }>>;\n  createBroadcastNotification(data: {\n    sentBy: string;\n    category: string;\n    type: string;\n    title: string;\n    message?: string;\n    userIds: string[];\n  }): Promise<{ sent: number }>;\n  getNotificationStats(notificationId: string): Promise<{ recipientCount: number; readCount: number }>;\n\n  // Admin Subscription operations\n  getAllSubscriptions(): Promise<any[]>;\n  getActiveSubscriptions(): Promise<any[]>;\n  getUserSubscription(userId: string): Promise<any | undefined>;\n  createSubscription(data: any): Promise<any>;\n  updateSubscription(id: string, updates: any): Promise<any>;\n\n  // Admin Coupon operations\n  getAllCoupons(): Promise<any[]>;\n  getCoupon(id: string): Promise<any | undefined>;\n  createCoupon(data: any): Promise<any>;\n  updateCoupon(id: string, updates: any): Promise<any>;\n  getCouponUsageStats(couponId: string): Promise<any>;\n  recordCouponUsage(data: { couponId: string; userId: string; paymentId: string; discountApplied: number }): Promise<void>;\n\n  // Admin Payment operations\n  getAllPayments(): Promise<any[]>;\n  createPayment(data: any): Promise<any>;\n  updatePayment(id: string, updates: any): Promise<any>;\n\n  // Admin Venue operations\n  getAllVenues(): Promise<any[]>;\n  getVenue(id: string): Promise<any>;\n  updateVenue(id: string, updates: any): Promise<any>;\n  deleteVenue(id: string): Promise<void>;\n\n  // Venue Booking operations\n  checkVenueAvailability(venueId: string, bookingDate: Date, bookingTime: string): Promise<boolean>;\n  createVenueBooking(data: {\n    venueId: string;\n    eventId: string;\n    bookingDate: Date;\n    bookingTime: string;\n    participantCount: number;\n    estimatedRevenue?: number;\n  }): Promise<any>;\n  getVenueBookings(venueId: string): Promise<any[]>;\n  getEventVenueBooking(eventId: string): Promise<any | undefined>;\n  cancelVenueBooking(bookingId: string): Promise<any>;\n  updateVenueBookingRevenue(bookingId: string, actualRevenue: number): Promise<any>;\n\n  // Admin Event Template operations\n  getAllEventTemplates(): Promise<any[]>;\n  createEventTemplate(data: any): Promise<any>;\n  updateEventTemplate(id: string, updates: any): Promise<any>;\n\n  // Admin Finance operations\n  getFinanceStats(): Promise<any>;\n  getVenueCommissions(): Promise<any[]>;\n\n  // Admin Moderation operations\n  getModerationStats(): Promise<any>;\n  getAllReports(): Promise<any[]>;\n  getPendingReports(): Promise<any[]>;\n  updateReportStatus(id: string, status: string, adminNotes?: string): Promise<any>;\n  createModerationLog(data: any): Promise<any>;\n  getModerationLogs(): Promise<any[]>;\n\n  // Admin Insights operations\n  getInsightsData(): Promise<any>;\n\n  // Admin Feedback operations\n  getAllFeedbacks(filters?: {\n    eventId?: string;\n    minRating?: number;\n    maxRating?: number;\n    startDate?: Date;\n    endDate?: Date;\n    hasDeepFeedback?: boolean;\n  }): Promise<Array<EventFeedback & { user: { displayName: string | null; phoneNumber: string | null }; event: { title: string; dateTime: Date; status: string | null } }>>;\n  getFeedbackById(id: string): Promise<(EventFeedback & { user: User; event: Event }) | undefined>;\n  getFeedbackStats(): Promise<{\n    totalFeedbacks: number;\n    avgAtmosphereScore: number;\n    lowRatedCount: number;\n    deepFeedbackRate: number;\n    topImprovementAreas: Array<{ area: string; count: number }>;\n    connectionStatusBreakdown: Record<string, number>;\n  }>;\n\n  // Chat Report operations\n  createChatReport(data: InsertChatReport): Promise<ChatReport>;\n  getChatReports(status?: string): Promise<Array<ChatReport & { reporter: User; reportedUser: User; message: ChatMessage }>>;\n  getChatReport(id: string): Promise<(ChatReport & { reporter: User; reportedUser: User; message: ChatMessage }) | undefined>;\n  updateChatReport(id: string, updates: { status?: string; reviewedBy?: string; reviewNotes?: string; actionTaken?: string }): Promise<ChatReport>;\n  getChatReportContext(messageId: string, eventId?: string, threadId?: string): Promise<Array<ChatMessage & { user: User }>>;\n\n  // Chat Log operations\n  createChatLog(data: InsertChatLog): Promise<ChatLog>;\n  getChatLogs(filters?: { eventId?: string; userId?: string; severity?: string; startDate?: Date; endDate?: Date }): Promise<ChatLog[]>;\n  getChatLogStats(): Promise<{ total: number; errors: number; warnings: number; info: number }>;\n\n  // Admin Content Management operations\n  getAllContents(type?: string): Promise<any[]>;\n  getContent(id: string): Promise<any | undefined>;\n  createContent(data: any): Promise<any>;\n  updateContent(id: string, updates: any): Promise<any>;\n  deleteContent(id: string): Promise<void>;\n  getPublishedContents(type: string): Promise<any[]>;\n\n  // Matching Algorithm operations\n  getUserById(id: string): Promise<User | undefined>;\n  getActiveMatchingConfig(): Promise<any | undefined>;\n  updateMatchingConfig(config: any): Promise<any>;\n  saveMatchingResult(result: any): Promise<any>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // User operations\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return await db.select().from(users);\n  }\n\n  async getUserByPhone(phoneNumber: string): Promise<User[]> {\n    return await db.select().from(users).where(eq(users.phoneNumber, phoneNumber));\n  }\n\n  async createUserWithPhone(data: { phoneNumber: string; email: string; firstName: string; lastName: string }): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values({\n        phoneNumber: data.phoneNumber,\n        email: data.email,\n        firstName: data.firstName,\n        lastName: data.lastName,\n        // Removed DEMO MODE - Users must complete full registration flow\n        hasCompletedRegistration: false,\n        hasCompletedInterestsTopics: false,\n        hasCompletedPersonalityTest: false,\n        hasCompletedProfileSetup: false,\n        hasCompletedVoiceQuiz: false,\n      })\n      .returning();\n    return user;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    // First try to find existing user by id or email\n    const existingById = await db.select().from(users).where(eq(users.id, userData.id!));\n    const existingByEmail = userData.email \n      ? await db.select().from(users).where(eq(users.email, userData.email))\n      : [];\n\n    if (existingById.length > 0) {\n      // Update existing user by id\n      const [user] = await db\n        .update(users)\n        .set({\n          email: userData.email,\n          firstName: userData.firstName,\n          lastName: userData.lastName,\n          profileImageUrl: userData.profileImageUrl,\n          updatedAt: new Date(),\n        })\n        .where(eq(users.id, userData.id!))\n        .returning();\n      return user;\n    } else if (existingByEmail.length > 0) {\n      // Update existing user by email (email exists but different id)\n      const [user] = await db\n        .update(users)\n        .set({\n          id: userData.id,\n          firstName: userData.firstName,\n          lastName: userData.lastName,\n          profileImageUrl: userData.profileImageUrl,\n          updatedAt: new Date(),\n        })\n        .where(eq(users.email, userData.email!))\n        .returning();\n      return user;\n    } else {\n      // Insert new user\n      const [user] = await db\n        .insert(users)\n        .values(userData)\n        .returning();\n      return user;\n    }\n  }\n\n  async updateProfile(id: string, profile: UpdateProfile): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({\n        ...profile,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id))\n      .returning();\n    return user;\n  }\n\n  async updateFullProfile(id: string, profile: UpdateFullProfile): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({\n        ...profile,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id))\n      .returning();\n    return user;\n  }\n\n  async updatePersonality(id: string, personality: UpdatePersonality): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({\n        ...personality,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id))\n      .returning();\n    return user;\n  }\n\n  async updateUser(id: string, updates: Partial<User>): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({\n        ...updates,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id))\n      .returning();\n    return user;\n  }\n\n  async markProfileSetupComplete(id: string): Promise<void> {\n    await db\n      .update(users)\n      .set({\n        hasCompletedProfileSetup: true,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id));\n  }\n\n  async markVoiceQuizComplete(id: string): Promise<void> {\n    await db\n      .update(users)\n      .set({\n        hasCompletedVoiceQuiz: true,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id));\n  }\n\n  async registerUser(id: string, data: RegisterUser): Promise<User> {\n    console.log(\"[Storage] Updating user registration:\", { id, data });\n    \n    const [user] = await db\n      .update(users)\n      .set({\n        displayName: data.displayName,\n        birthdate: data.birthdate,\n        ageVisibility: data.ageVisibility,\n        gender: data.gender,\n        pronouns: data.pronouns,\n        relationshipStatus: data.relationshipStatus,\n        children: data.children,\n        educationLevel: data.educationLevel,\n        studyLocale: data.studyLocale,\n        overseasRegions: data.overseasRegions,\n        fieldOfStudy: data.fieldOfStudy,\n        educationVisibility: data.educationVisibility,\n        industry: data.industry,\n        roleTitleShort: data.roleTitleShort,\n        seniority: data.seniority,\n        workVisibility: data.workVisibility,\n        hometownCountry: data.hometownCountry,\n        hometownRegionCity: data.hometownRegionCity,\n        hometownAffinityOptin: data.hometownAffinityOptin,\n        languagesComfort: data.languagesComfort,\n        accessibilityNeeds: data.accessibilityNeeds,\n        safetyNoteHost: data.safetyNoteHost,\n        wechatId: data.wechatId,\n        hasCompletedRegistration: true,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id))\n      .returning();\n    \n    console.log(\"[Storage] User updated result:\", { id: user.id, displayName: user.displayName, gender: user.gender, birthdate: user.birthdate });\n    return user;\n  }\n\n  async updateInterestsTopics(id: string, data: InterestsTopics): Promise<User> {\n    const [user] = await db\n      .update(users)\n      .set({\n        interestsTop: data.interestsTop,\n        interestsRankedTop3: data.interestsRankedTop3,\n        topicsHappy: data.topicsHappy,\n        topicsAvoid: data.topicsAvoid,\n        hasCompletedInterestsTopics: true,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id))\n      .returning();\n    return user;\n  }\n\n  async markRegistrationComplete(id: string): Promise<void> {\n    await db\n      .update(users)\n      .set({\n        hasCompletedRegistration: true,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id));\n  }\n\n  async markPersonalityTestComplete(id: string): Promise<void> {\n    await db\n      .update(users)\n      .set({\n        hasCompletedPersonalityTest: true,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id));\n  }\n\n  async saveTestResponses(userId: string, responses: Record<number, any>): Promise<void> {\n    // Store test responses\n    // Note: For simplicity, we're not implementing full question tracking\n    // In production, you would map questionIds properly\n    // This is a simplified implementation\n  }\n\n  async saveRoleResult(userId: string, result: InsertRoleResult): Promise<RoleResult> {\n    // First update user table with role information\n    await db\n      .update(users)\n      .set({\n        primaryRole: result.primaryRole,\n        secondaryRole: result.secondaryRole,\n        roleSubtype: result.roleSubtype,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, userId));\n\n    // Then insert role result\n    const [roleResult] = await db\n      .insert(roleResults)\n      .values({\n        ...result,\n        userId,\n      })\n      .returning();\n    \n    return roleResult;\n  }\n\n  async getRoleResult(userId: string): Promise<RoleResult | undefined> {\n    const [result] = await db\n      .select()\n      .from(roleResults)\n      .where(eq(roleResults.userId, userId))\n      .orderBy(desc(roleResults.createdAt))\n      .limit(1);\n    \n    return result;\n  }\n\n  async getPersonalityDistribution(): Promise<Record<string, number>> {\n    const results = await db\n      .select({\n        primaryRole: users.primaryRole,\n        count: sql<number>`count(*)`,\n      })\n      .from(users)\n      .where(sql`${users.primaryRole} IS NOT NULL`)\n      .groupBy(users.primaryRole);\n\n    const distribution: Record<string, number> = {};\n    let total = 0;\n    \n    for (const row of results) {\n      if (row.primaryRole) {\n        distribution[row.primaryRole] = Number(row.count);\n        total += Number(row.count);\n      }\n    }\n\n    // Convert to percentages\n    const percentages: Record<string, number> = {};\n    for (const [role, count] of Object.entries(distribution)) {\n      percentages[role] = total > 0 ? Math.round((count / total) * 100) : 0;\n    }\n\n    return percentages;\n  }\n\n  // Event operations\n  async getUserJoinedEvents(userId: string): Promise<Array<Event & { attendanceStatus: string; attendeeCount: number; participants: Array<{ id: string; displayName: string | null; archetype: string | null }> }>> {\n    const result = await db\n      .select({\n        event: events,\n        attendanceStatus: eventAttendance.status,\n        attendeeCount: sql<number>`(SELECT COUNT(*) FROM ${eventAttendance} WHERE ${eventAttendance.eventId} = ${events.id} AND ${eventAttendance.status} = 'confirmed')`,\n      })\n      .from(eventAttendance)\n      .innerJoin(events, eq(eventAttendance.eventId, events.id))\n      .where(eq(eventAttendance.userId, userId))\n      .orderBy(desc(events.dateTime));\n\n    // Get participants for each event\n    const eventsWithParticipants = await Promise.all(\n      result.map(async (r) => {\n        const participants = await db\n          .select({\n            id: users.id,\n            displayName: users.displayName,\n            archetype: users.archetype,\n          })\n          .from(eventAttendance)\n          .innerJoin(users, eq(eventAttendance.userId, users.id))\n          .where(\n            and(\n              eq(eventAttendance.eventId, r.event.id),\n              eq(eventAttendance.status, 'confirmed')\n            )\n          )\n\n        return {\n          ...r.event,\n          attendanceStatus: r.attendanceStatus || 'confirmed',\n          attendeeCount: Number(r.attendeeCount) || 0,\n          participants: participants,\n        };\n      })\n    );\n\n    return eventsWithParticipants;\n  }\n\n  async getEventParticipants(eventId: string): Promise<Array<User>> {\n    const result = await db\n      .select({ user: users })\n      .from(eventAttendance)\n      .innerJoin(users, eq(eventAttendance.userId, users.id))\n      .where(\n        and(\n          eq(eventAttendance.eventId, eventId),\n          eq(eventAttendance.status, 'confirmed')\n        )\n      );\n\n    return result.map(r => r.user);\n  }\n\n  // Chat operations\n  async getEventMessages(eventId: string): Promise<Array<ChatMessage & { user: User }>> {\n    const result = await db\n      .select({\n        message: chatMessages,\n        user: users,\n      })\n      .from(chatMessages)\n      .innerJoin(users, eq(chatMessages.userId, users.id))\n      .where(eq(chatMessages.eventId, eventId))\n      .orderBy(chatMessages.createdAt);\n\n    return result.map(r => ({\n      ...r.message,\n      user: r.user,\n    }));\n  }\n\n  async createChatMessage(userId: string, message: InsertChatMessage): Promise<ChatMessage> {\n    const [newMessage] = await db\n      .insert(chatMessages)\n      .values({\n        ...message,\n        userId,\n      })\n      .returning();\n    return newMessage;\n  }\n\n  // Feedback operations\n  async getUserAllFeedbacks(userId: string): Promise<Array<EventFeedback>> {\n    const feedbacks = await db\n      .select()\n      .from(eventFeedback)\n      .where(eq(eventFeedback.userId, userId))\n      .orderBy(desc(eventFeedback.createdAt));\n    return feedbacks;\n  }\n\n  async getUserFeedback(userId: string, eventId: string): Promise<EventFeedback | undefined> {\n    const [feedback] = await db\n      .select()\n      .from(eventFeedback)\n      .where(\n        and(\n          eq(eventFeedback.userId, userId),\n          eq(eventFeedback.eventId, eventId)\n        )\n      );\n    return feedback;\n  }\n\n  async createEventFeedback(userId: string, feedback: InsertEventFeedback): Promise<EventFeedback> {\n    const [newFeedback] = await db\n      .insert(eventFeedback)\n      .values({\n        ...feedback,\n        userId,\n      })\n      .returning();\n    return newFeedback;\n  }\n\n  async getEventFeedbacks(eventId: string): Promise<Array<EventFeedback>> {\n    const feedbacks = await db\n      .select()\n      .from(eventFeedback)\n      .where(eq(eventFeedback.eventId, eventId));\n    return feedbacks;\n  }\n\n  async updateEventFeedbackDeep(userId: string, eventId: string, deepData: any): Promise<EventFeedback> {\n    const [updatedFeedback] = await db\n      .update(eventFeedback)\n      .set(deepData)\n      .where(\n        and(\n          eq(eventFeedback.userId, userId),\n          eq(eventFeedback.eventId, eventId)\n        )\n      )\n      .returning();\n    return updatedFeedback;\n  }\n\n  // Direct message operations\n  async findDirectMessageThread(userId1: string, userId2: string, eventId: string): Promise<DirectMessageThread | undefined> {\n    const [thread] = await db\n      .select()\n      .from(directMessageThreads)\n      .where(\n        and(\n          eq(directMessageThreads.eventId, eventId),\n          sql`(\n            (${directMessageThreads.user1Id} = ${userId1} AND ${directMessageThreads.user2Id} = ${userId2})\n            OR\n            (${directMessageThreads.user1Id} = ${userId2} AND ${directMessageThreads.user2Id} = ${userId1})\n          )`\n        )\n      );\n    return thread;\n  }\n\n  async createDirectMessageThread(data: InsertDirectMessageThread): Promise<DirectMessageThread> {\n    const [thread] = await db\n      .insert(directMessageThreads)\n      .values(data)\n      .returning();\n    return thread;\n  }\n\n  async getUserDirectMessageThreads(userId: string): Promise<Array<DirectMessageThread & { otherUser: User; lastMessage?: DirectMessage }>> {\n    const threads = await db\n      .select()\n      .from(directMessageThreads)\n      .where(\n        sql`${directMessageThreads.user1Id} = ${userId} OR ${directMessageThreads.user2Id} = ${userId}`\n      )\n      .orderBy(desc(directMessageThreads.lastMessageAt));\n\n    // Fetch other user data and last message for each thread\n    const threadsWithData = await Promise.all(\n      threads.map(async (thread) => {\n        const otherUserId = thread.user1Id === userId ? thread.user2Id : thread.user1Id;\n        const otherUser = await this.getUser(otherUserId);\n        \n        const [lastMessage] = await db\n          .select()\n          .from(directMessages)\n          .where(eq(directMessages.threadId, thread.id))\n          .orderBy(desc(directMessages.createdAt))\n          .limit(1);\n\n        return {\n          ...thread,\n          otherUser: otherUser!,\n          lastMessage,\n        };\n      })\n    );\n\n    return threadsWithData;\n  }\n\n  async getThreadMessages(threadId: string): Promise<Array<DirectMessage & { sender: User }>> {\n    const messages = await db\n      .select()\n      .from(directMessages)\n      .where(eq(directMessages.threadId, threadId))\n      .orderBy(directMessages.createdAt);\n\n    const messagesWithUser = await Promise.all(\n      messages.map(async (message) => {\n        const sender = await this.getUser(message.senderId);\n        return {\n          ...message,\n          sender: sender!,\n        };\n      })\n    );\n\n    return messagesWithUser;\n  }\n\n  async sendDirectMessage(senderId: string, data: InsertDirectMessage): Promise<DirectMessage> {\n    const [message] = await db\n      .insert(directMessages)\n      .values({\n        ...data,\n        senderId,\n      })\n      .returning();\n\n    // Update thread's lastMessageAt\n    await db\n      .update(directMessageThreads)\n      .set({ lastMessageAt: new Date() })\n      .where(eq(directMessageThreads.id, data.threadId));\n\n    return message;\n  }\n\n  // Blind Box Event operations\n  async getAllBlindBoxEvents(): Promise<Array<BlindBoxEvent>> {\n    return await db.select().from(blindBoxEvents);\n  }\n\n  async getUserBlindBoxEvents(userId: string): Promise<Array<BlindBoxEvent>> {\n    const events = await db\n      .select()\n      .from(blindBoxEvents)\n      .where(eq(blindBoxEvents.userId, userId))\n      .orderBy(desc(blindBoxEvents.dateTime));\n    return events;\n  }\n\n  async getBlindBoxEventById(eventId: string, userId: string): Promise<BlindBoxEvent | undefined> {\n    const [event] = await db\n      .select()\n      .from(blindBoxEvents)\n      .where(eq(blindBoxEvents.id, eventId));\n    \n    // Allow viewing matched events (for demo/preview), but only allow owner to view pending events\n    if (event && event.status !== 'matched' && event.userId !== userId) {\n      return undefined;\n    }\n    \n    return event;\n  }\n\n  async createBlindBoxEvent(userId: string, eventData: { \n    date: string; \n    time: string; \n    eventType: string; \n    city: string;\n    area: string; \n    budget: string[]; \n    acceptNearby?: boolean;\n    selectedLanguages?: string[];\n    selectedTasteIntensity?: string[];\n    selectedCuisines?: string[];\n    inviteFriends?: boolean;\n    friendsCount?: number;\n  }): Promise<BlindBoxEvent> {\n    // Parse area to get district (e.g., \"æ·±åœ³â€¢å—å±±åŒº\" -> \"å—å±±åŒº\")\n    const district = eventData.area.includes('â€¢') \n      ? eventData.area.split('â€¢')[1] \n      : eventData.area;\n    \n    // Parse date (e.g., \"å‘¨ä¸‰\") to get next occurrence of that weekday\n    const parseWeekday = (weekdayStr: string): number => {\n      const weekdayMap: { [key: string]: number } = {\n        'å‘¨æ—¥': 0, 'å‘¨ä¸€': 1, 'å‘¨äºŒ': 2, 'å‘¨ä¸‰': 3, \n        'å‘¨å››': 4, 'å‘¨äº”': 5, 'å‘¨å…­': 6\n      };\n      return weekdayMap[weekdayStr] ?? 0;\n    };\n    \n    const getNextWeekdayDate = (weekdayStr: string, timeStr: string): Date => {\n      const targetWeekday = parseWeekday(weekdayStr);\n      const now = new Date();\n      const currentWeekday = now.getDay();\n      \n      // Calculate days until target weekday\n      let daysUntil = targetWeekday - currentWeekday;\n      if (daysUntil <= 0) {\n        daysUntil += 7; // Next week if target day has passed\n      }\n      \n      // Parse time (e.g., \"19:00\")\n      const [hours, minutes] = timeStr.split(':').map(Number);\n      \n      // Create target date\n      const targetDate = new Date(now);\n      targetDate.setDate(now.getDate() + daysUntil);\n      targetDate.setHours(hours, minutes, 0, 0);\n      \n      return targetDate;\n    };\n    \n    const dateTime = getNextWeekdayDate(eventData.date, eventData.time);\n    \n    // Create title\n    const title = `${eventData.date} ${eventData.time} Â· ${eventData.eventType}`;\n    \n    // Join all budget tiers with \"/\"\n    const budgetTier = eventData.budget.join('/');\n    \n    // Calculate invited count\n    const invitedCount = eventData.inviteFriends ? (eventData.friendsCount || 1) : 0;\n    \n    const [newEvent] = await db\n      .insert(blindBoxEvents)\n      .values({\n        userId,\n        title,\n        eventType: eventData.eventType,\n        city: eventData.city,\n        district,\n        dateTime,\n        budgetTier,\n        selectedLanguages: eventData.selectedLanguages || null,\n        selectedTasteIntensity: eventData.selectedTasteIntensity || null,\n        selectedCuisines: eventData.selectedCuisines || null,\n        acceptNearby: eventData.acceptNearby || false,\n        invitedCount,\n        invitedJoined: 0,\n        status: 'pending_match',\n        progress: 0,\n        etaMinutes: 120, // Default 2 hours ETA\n      })\n      .returning();\n    \n    // Create corresponding event record for chat/attendance tracking\n    const [correspondingEvent] = await db\n      .insert(events)\n      .values({\n        title,\n        description: `${eventData.eventType} Â· ${budgetTier}`,\n        dateTime,\n        location: `${district}`,\n        area: district,\n        price: null,\n        maxAttendees: 6,\n        currentAttendees: 1,\n        hostId: userId,\n        status: 'upcoming',\n      })\n      .returning();\n    \n    // Create event attendance record for the creator\n    await db\n      .insert(eventAttendance)\n      .values({\n        eventId: correspondingEvent.id,\n        userId,\n        status: 'confirmed',\n      });\n    \n    return newEvent;\n  }\n\n  async updateBlindBoxEventPreferences(\n    eventId: string, \n    userId: string, \n    preferences: {\n      budget?: string[];\n      acceptNearby?: boolean;\n      selectedLanguages?: string[];\n      selectedTasteIntensity?: string[];\n      selectedCuisines?: string[];\n    }\n  ): Promise<BlindBoxEvent> {\n    const updateData: any = {\n      updatedAt: new Date(),\n    };\n\n    if (preferences.budget && preferences.budget.length > 0) {\n      updateData.budgetTier = preferences.budget.join('/');\n    }\n    \n    if (preferences.acceptNearby !== undefined) {\n      updateData.acceptNearby = preferences.acceptNearby;\n    }\n    \n    if (preferences.selectedLanguages !== undefined) {\n      updateData.selectedLanguages = preferences.selectedLanguages.length > 0 ? preferences.selectedLanguages : null;\n    }\n    \n    if (preferences.selectedTasteIntensity !== undefined) {\n      updateData.selectedTasteIntensity = preferences.selectedTasteIntensity.length > 0 ? preferences.selectedTasteIntensity : null;\n    }\n    \n    if (preferences.selectedCuisines !== undefined) {\n      updateData.selectedCuisines = preferences.selectedCuisines.length > 0 ? preferences.selectedCuisines : null;\n    }\n\n    const [event] = await db\n      .update(blindBoxEvents)\n      .set(updateData)\n      .where(\n        and(\n          eq(blindBoxEvents.id, eventId),\n          eq(blindBoxEvents.userId, userId),\n          eq(blindBoxEvents.status, 'pending_match') // Only can update pending events\n        )\n      )\n      .returning();\n    \n    if (!event) {\n      throw new Error('Event not found or cannot be updated');\n    }\n    \n    return event;\n  }\n\n  async cancelBlindBoxEvent(eventId: string, userId: string): Promise<BlindBoxEvent> {\n    const [event] = await db\n      .update(blindBoxEvents)\n      .set({\n        status: 'canceled',\n        updatedAt: new Date(),\n      })\n      .where(\n        and(\n          eq(blindBoxEvents.id, eventId),\n          eq(blindBoxEvents.userId, userId),\n          eq(blindBoxEvents.status, 'pending_match') // Only can cancel pending events\n        )\n      )\n      .returning();\n    \n    if (!event) {\n      throw new Error('Event not found or cannot be canceled');\n    }\n    \n    return event;\n  }\n\n  async setBlindBoxEventMatchData(\n    eventId: string,\n    userId: string,\n    matchData: {\n      matchedAttendees: any[];\n      matchExplanation?: string;\n    }\n  ): Promise<BlindBoxEvent> {\n    const [event] = await db\n      .update(blindBoxEvents)\n      .set({\n        status: 'matched',\n        matchedAttendees: matchData.matchedAttendees as any,\n        matchExplanation: matchData.matchExplanation,\n        updatedAt: new Date(),\n      })\n      .where(\n        and(\n          eq(blindBoxEvents.id, eventId),\n          eq(blindBoxEvents.userId, userId)\n        )\n      )\n      .returning();\n    \n    if (!event) {\n      throw new Error('Event not found');\n    }\n    \n    return event;\n  }\n\n  // Notification operations\n  async getNotificationCounts(userId: string): Promise<NotificationCounts> {\n    const result = await db\n      .select({\n        category: notifications.category,\n        count: sql<number>`count(*)::int`,\n      })\n      .from(notifications)\n      .where(\n        and(\n          eq(notifications.userId, userId),\n          eq(notifications.isRead, false)\n        )\n      )\n      .groupBy(notifications.category);\n\n    const counts: NotificationCounts = {\n      discover: 0,\n      activities: 0,\n      chat: 0,\n      total: 0,\n    };\n\n    result.forEach(row => {\n      const count = Number(row.count) || 0;\n      if (row.category === 'discover') counts.discover = count;\n      if (row.category === 'activities') counts.activities = count;\n      if (row.category === 'chat') counts.chat = count;\n      counts.total += count;\n    });\n\n    return counts;\n  }\n\n  async markNotificationsAsRead(userId: string, category: string): Promise<void> {\n    await db\n      .update(notifications)\n      .set({ isRead: true })\n      .where(\n        and(\n          eq(notifications.userId, userId),\n          eq(notifications.category, category),\n          eq(notifications.isRead, false)\n        )\n      );\n  }\n\n  async createNotification(data: {\n    userId: string;\n    category: string;\n    type: string;\n    title: string;\n    message?: string;\n    relatedResourceId?: string;\n  }): Promise<void> {\n    await db.insert(notifications).values({\n      userId: data.userId,\n      category: data.category,\n      type: data.type,\n      title: data.title,\n      message: data.message,\n      relatedResourceId: data.relatedResourceId,\n      isRead: false,\n    });\n  }\n\n  // Admin Notification operations\n  async getAdminNotifications(adminId: string): Promise<Array<Notification & { recipientCount: number; readCount: number }>> {\n    const result = await db.execute(sql`\n      WITH grouped_notifications AS (\n        SELECT \n          MIN(n.id) as id,\n          MIN(n.user_id) as user_id,\n          n.category,\n          n.type,\n          n.title,\n          n.message,\n          n.related_resource_id,\n          n.sent_by,\n          n.is_broadcast,\n          n.created_at,\n          COUNT(*) as recipient_count,\n          SUM(CASE WHEN n.is_read THEN 1 ELSE 0 END) as read_count\n        FROM notifications n\n        WHERE n.sent_by = ${adminId}\n        GROUP BY n.title, n.message, n.category, n.type, n.related_resource_id, n.sent_by, n.is_broadcast, n.created_at\n        ORDER BY n.created_at DESC\n      )\n      SELECT * FROM grouped_notifications\n    `);\n    \n    return result.rows.map((row: any) => ({\n      id: row.id,\n      userId: row.user_id,\n      category: row.category,\n      type: row.type,\n      title: row.title,\n      message: row.message,\n      relatedResourceId: row.related_resource_id,\n      isRead: false, // For grouped notifications, isRead doesn't make sense\n      sentBy: row.sent_by,\n      isBroadcast: row.is_broadcast,\n      createdAt: row.created_at,\n      recipientCount: Number(row.recipient_count) || 0,\n      readCount: Number(row.read_count) || 0,\n    }));\n  }\n\n  async createBroadcastNotification(data: {\n    sentBy: string;\n    category: string;\n    type: string;\n    title: string;\n    message?: string;\n    userIds: string[];\n  }): Promise<{ sent: number }> {\n    if (data.userIds.length === 0) {\n      return { sent: 0 };\n    }\n\n    const values = data.userIds.map(userId => ({\n      userId,\n      category: data.category,\n      type: data.type,\n      title: data.title,\n      message: data.message,\n      isRead: false,\n      sentBy: data.sentBy,\n      isBroadcast: true,\n    }));\n\n    await db.insert(notifications).values(values);\n    return { sent: data.userIds.length };\n  }\n\n  async getNotificationStats(notificationId: string): Promise<{ recipientCount: number; readCount: number }> {\n    const notification = await db\n      .select()\n      .from(notifications)\n      .where(eq(notifications.id, notificationId))\n      .limit(1);\n\n    if (notification.length === 0) {\n      return { recipientCount: 0, readCount: 0 };\n    }\n\n    const n = notification[0];\n\n    const result = await db.execute(sql`\n      SELECT \n        COUNT(*) as recipient_count,\n        SUM(CASE WHEN is_read THEN 1 ELSE 0 END) as read_count\n      FROM notifications\n      WHERE title = ${n.title}\n        AND message = ${n.message}\n        AND sent_by = ${n.sentBy}\n        AND created_at = ${n.createdAt}\n    `);\n\n    const row = result.rows[0] as any;\n    return {\n      recipientCount: Number(row.recipient_count) || 0,\n      readCount: Number(row.read_count) || 0,\n    };\n  }\n\n  // Admin Subscription operations\n  async getAllSubscriptions(): Promise<any[]> {\n    const result = await db.execute(sql`\n      SELECT s.*, u.first_name, u.last_name, u.email, u.phone_number\n      FROM subscriptions s\n      LEFT JOIN users u ON s.user_id = u.id\n      ORDER BY s.created_at DESC\n    `);\n    return result.rows;\n  }\n\n  async getActiveSubscriptions(): Promise<any[]> {\n    const result = await db.execute(sql`\n      SELECT s.*, u.first_name, u.last_name, u.email, u.phone_number\n      FROM subscriptions s\n      LEFT JOIN users u ON s.user_id = u.id\n      WHERE s.is_active = true AND s.end_date > NOW()\n      ORDER BY s.created_at DESC\n    `);\n    return result.rows;\n  }\n\n  async getUserSubscription(userId: string): Promise<any | undefined> {\n    const result = await db.execute(sql`\n      SELECT * FROM subscriptions\n      WHERE user_id = ${userId} AND is_active = true AND end_date > NOW()\n      ORDER BY created_at DESC\n      LIMIT 1\n    `);\n    return result.rows[0];\n  }\n\n  async createSubscription(data: any): Promise<any> {\n    const result = await db.execute(sql`\n      INSERT INTO subscriptions (user_id, plan_type, start_date, end_date, is_active, auto_renew, payment_id)\n      VALUES (${data.userId}, ${data.planType}, ${data.startDate}, ${data.endDate}, ${data.isActive || true}, ${data.autoRenew || false}, ${data.paymentId || null})\n      RETURNING *\n    `);\n    return result.rows[0];\n  }\n\n  async updateSubscription(id: string, updates: any): Promise<any> {\n    const setClauses = [];\n    const values: any[] = [];\n    \n    if (updates.isActive !== undefined) {\n      setClauses.push(`is_active = $${values.length + 1}`);\n      values.push(updates.isActive);\n    }\n    if (updates.autoRenew !== undefined) {\n      setClauses.push(`auto_renew = $${values.length + 1}`);\n      values.push(updates.autoRenew);\n    }\n    if (updates.endDate !== undefined) {\n      setClauses.push(`end_date = $${values.length + 1}`);\n      values.push(updates.endDate);\n    }\n\n    if (setClauses.length === 0) {\n      const result = await db.execute(sql`SELECT * FROM subscriptions WHERE id = ${id}`);\n      return result.rows[0];\n    }\n\n    values.push(id);\n    const query = sql.raw(`UPDATE subscriptions SET ${setClauses.join(', ')} WHERE id = $${values.length} RETURNING *`);\n    const result = await db.execute(query);\n    return result.rows[0];\n  }\n\n  // Admin Coupon operations\n  async getAllCoupons(): Promise<any[]> {\n    const result = await db.execute(sql`\n      SELECT c.*, \n        COUNT(cu.id) as usage_count\n      FROM coupons c\n      LEFT JOIN coupon_usage cu ON c.id = cu.coupon_id\n      GROUP BY c.id\n      ORDER BY c.created_at DESC\n    `);\n    return result.rows;\n  }\n\n  async getCoupon(id: string): Promise<any | undefined> {\n    const result = await db.execute(sql`\n      SELECT c.*, \n        COUNT(cu.id) as usage_count\n      FROM coupons c\n      LEFT JOIN coupon_usage cu ON c.id = cu.coupon_id\n      WHERE c.id = ${id}\n      GROUP BY c.id\n    `);\n    return result.rows[0];\n  }\n\n  async createCoupon(data: any): Promise<any> {\n    const result = await db.execute(sql`\n      INSERT INTO coupons (code, discount_type, discount_value, valid_from, valid_until, usage_limit, is_active)\n      VALUES (${data.code}, ${data.discountType}, ${data.discountValue}, ${data.validFrom}, ${data.validUntil}, ${data.maxUses || null}, true)\n      RETURNING *\n    `);\n    return result.rows[0];\n  }\n\n  async updateCoupon(id: string, updates: any): Promise<any> {\n    const setClauses = [];\n    const values: any[] = [];\n    \n    if (updates.code !== undefined) {\n      setClauses.push(`code = $${values.length + 1}`);\n      values.push(updates.code);\n    }\n    if (updates.discountType !== undefined) {\n      setClauses.push(`discount_type = $${values.length + 1}`);\n      values.push(updates.discountType);\n    }\n    if (updates.discountValue !== undefined) {\n      setClauses.push(`discount_value = $${values.length + 1}`);\n      values.push(updates.discountValue);\n    }\n    if (updates.validFrom !== undefined) {\n      setClauses.push(`valid_from = $${values.length + 1}`);\n      values.push(updates.validFrom);\n    }\n    if (updates.validUntil !== undefined) {\n      setClauses.push(`valid_until = $${values.length + 1}`);\n      values.push(updates.validUntil);\n    }\n    if (updates.maxUses !== undefined) {\n      setClauses.push(`usage_limit = $${values.length + 1}`);\n      values.push(updates.maxUses);\n    }\n    if (updates.isActive !== undefined) {\n      setClauses.push(`is_active = $${values.length + 1}`);\n      values.push(updates.isActive);\n    }\n\n    if (setClauses.length === 0) {\n      return this.getCoupon(id);\n    }\n\n    values.push(id);\n    const query = sql.raw(`UPDATE coupons SET ${setClauses.join(', ')} WHERE id = $${values.length} RETURNING *`);\n    const result = await db.execute(query);\n    return result.rows[0];\n  }\n\n  async getCouponUsageStats(couponId: string): Promise<any> {\n    const result = await db.execute(sql`\n      SELECT \n        cu.*, \n        u.first_name, \n        u.last_name, \n        u.email\n      FROM coupon_usage cu\n      LEFT JOIN users u ON cu.user_id = u.id\n      WHERE cu.coupon_id = ${couponId}\n      ORDER BY cu.created_at DESC\n    `);\n    return result.rows;\n  }\n\n  async recordCouponUsage(data: { couponId: string; userId: string; paymentId: string; discountApplied: number }): Promise<void> {\n    await db.execute(sql`\n      INSERT INTO coupon_usage (coupon_id, user_id, payment_id, discount_applied)\n      VALUES (${data.couponId}, ${data.userId}, ${data.paymentId}, ${data.discountApplied})\n    `);\n    \n    // Increment coupon usage count\n    await db.execute(sql`\n      UPDATE coupons SET current_uses = current_uses + 1 WHERE id = ${data.couponId}\n    `);\n  }\n\n  // ============ PAYMENTS ============\n  async createPayment(data: any): Promise<any> {\n    const result = await db.execute(sql`\n      INSERT INTO payments (user_id, payment_type, related_id, original_amount, discount_amount, final_amount, coupon_id, wechat_order_id, status)\n      VALUES (${data.userId}, ${data.paymentType}, ${data.relatedId || null}, ${data.originalAmount}, ${data.discountAmount || 0}, ${data.finalAmount}, ${data.couponId || null}, ${data.wechatOrderId}, ${data.status || 'pending'})\n      RETURNING *\n    `);\n    return result.rows[0];\n  }\n\n  async updatePayment(id: string, updates: any): Promise<any> {\n    const setClauses = [];\n    const values: any[] = [];\n    \n    if (updates.status !== undefined) {\n      setClauses.push(`status = $${values.length + 1}`);\n      values.push(updates.status);\n    }\n    if (updates.wechatTransactionId !== undefined) {\n      setClauses.push(`wechat_transaction_id = $${values.length + 1}`);\n      values.push(updates.wechatTransactionId);\n    }\n    if (updates.paidAt !== undefined) {\n      setClauses.push(`paid_at = $${values.length + 1}`);\n      values.push(updates.paidAt);\n    }\n\n    if (setClauses.length === 0) {\n      const result = await db.execute(sql`SELECT * FROM payments WHERE id = ${id}`);\n      return result.rows[0];\n    }\n\n    values.push(id);\n    const query = sql.raw(`UPDATE payments SET ${setClauses.join(', ')} WHERE id = $${values.length} RETURNING *`);\n    const result = await db.execute(query);\n    return result.rows[0];\n  }\n\n  // ============ VENUES ============\n  async getAllVenues(): Promise<any[]> {\n    const result = await db.execute(sql`\n      SELECT v.*,\n        COALESCE(COUNT(DISTINCT vb.id), 0)::text as booking_count,\n        COALESCE(SUM(vb.commission_amount), 0)::text as total_commission\n      FROM venues v\n      LEFT JOIN venue_bookings vb ON v.id = vb.venue_id AND vb.status = 'completed'\n      GROUP BY v.id\n      ORDER BY v.created_at DESC\n    `);\n    return result.rows;\n  }\n\n  async getVenue(id: string): Promise<any> {\n    const result = await db.execute(sql`SELECT * FROM venues WHERE id = ${id}`);\n    return result.rows[0];\n  }\n\n  async createVenue(data: any): Promise<any> {\n    const result = await db.execute(sql`\n      INSERT INTO venues (name, type, address, city, district, contact_name, contact_phone, commission_rate, tags, cuisines, price_range, max_concurrent_events, is_active, notes)\n      VALUES (${data.name}, ${data.type}, ${data.address}, ${data.city}, ${data.district}, ${data.contactName || null}, ${data.contactPhone || null}, ${data.commissionRate || 20}, ${data.tags || []}, ${data.cuisines || []}, ${data.priceRange || null}, ${data.maxConcurrentEvents || 1}, ${data.isActive !== false}, ${data.notes || null})\n      RETURNING *\n    `);\n    return result.rows[0];\n  }\n\n  async updateVenue(id: string, updates: any): Promise<any> {\n    const setClauses = [];\n    const values: any[] = [];\n    \n    if (updates.name !== undefined) {\n      setClauses.push(`name = $${values.length + 1}`);\n      values.push(updates.name);\n    }\n    if (updates.type !== undefined) {\n      setClauses.push(`type = $${values.length + 1}`);\n      values.push(updates.type);\n    }\n    if (updates.address !== undefined) {\n      setClauses.push(`address = $${values.length + 1}`);\n      values.push(updates.address);\n    }\n    if (updates.city !== undefined) {\n      setClauses.push(`city = $${values.length + 1}`);\n      values.push(updates.city);\n    }\n    if (updates.district !== undefined) {\n      setClauses.push(`district = $${values.length + 1}`);\n      values.push(updates.district);\n    }\n    if (updates.contactName !== undefined) {\n      setClauses.push(`contact_name = $${values.length + 1}`);\n      values.push(updates.contactName);\n    }\n    if (updates.contactPhone !== undefined) {\n      setClauses.push(`contact_phone = $${values.length + 1}`);\n      values.push(updates.contactPhone);\n    }\n    if (updates.commissionRate !== undefined) {\n      setClauses.push(`commission_rate = $${values.length + 1}`);\n      values.push(updates.commissionRate);\n    }\n    if (updates.tags !== undefined) {\n      setClauses.push(`tags = $${values.length + 1}`);\n      values.push(updates.tags);\n    }\n    if (updates.cuisines !== undefined) {\n      setClauses.push(`cuisines = $${values.length + 1}`);\n      values.push(updates.cuisines);\n    }\n    if (updates.priceRange !== undefined) {\n      setClauses.push(`price_range = $${values.length + 1}`);\n      values.push(updates.priceRange);\n    }\n    if (updates.maxConcurrentEvents !== undefined) {\n      setClauses.push(`max_concurrent_events = $${values.length + 1}`);\n      values.push(updates.maxConcurrentEvents);\n    }\n    if (updates.isActive !== undefined) {\n      setClauses.push(`is_active = $${values.length + 1}`);\n      values.push(updates.isActive);\n    }\n    if (updates.notes !== undefined) {\n      setClauses.push(`notes = $${values.length + 1}`);\n      values.push(updates.notes);\n    }\n\n    if (setClauses.length === 0) {\n      return this.getVenue(id);\n    }\n\n    values.push(id);\n    const query = sql.raw(`UPDATE venues SET ${setClauses.join(', ')} WHERE id = $${values.length} RETURNING *`);\n    const result = await db.execute(query);\n    return result.rows[0];\n  }\n\n  async deleteVenue(id: string): Promise<void> {\n    await db.execute(sql`DELETE FROM venues WHERE id = ${id}`);\n  }\n\n  // ============ VENUE BOOKINGS ============\n  async checkVenueAvailability(venueId: string, bookingDate: Date, bookingTime: string): Promise<boolean> {\n    const dateStr = bookingDate.toISOString().split('T')[0];\n    \n    const result = await db.execute(sql`\n      SELECT v.max_concurrent_events,\n        COALESCE(COUNT(vb.id), 0)::integer as current_bookings\n      FROM venues v\n      LEFT JOIN venue_bookings vb ON v.id = vb.venue_id\n        AND DATE(vb.booking_date) = ${dateStr}::date\n        AND vb.booking_time = ${bookingTime}\n        AND vb.status IN ('confirmed', 'completed')\n      WHERE v.id = ${venueId}\n      GROUP BY v.id, v.max_concurrent_events\n    `);\n\n    if (result.rows.length === 0) {\n      return false;\n    }\n\n    const venue = result.rows[0] as { max_concurrent_events: number; current_bookings: number };\n    return venue.current_bookings < venue.max_concurrent_events;\n  }\n\n  async createVenueBooking(data: {\n    venueId: string;\n    eventId: string;\n    bookingDate: Date;\n    bookingTime: string;\n    participantCount: number;\n    estimatedRevenue?: number;\n  }): Promise<any> {\n    const dateStr = data.bookingDate.toISOString().split('T')[0];\n    \n    const result = await db.execute(sql`\n      WITH venue_check AS (\n        SELECT v.id, v.max_concurrent_events,\n          COALESCE(COUNT(vb.id), 0)::integer as current_bookings\n        FROM venues v\n        LEFT JOIN venue_bookings vb ON v.id = vb.venue_id\n          AND DATE(vb.booking_date) = ${dateStr}::date\n          AND vb.booking_time = ${data.bookingTime}\n          AND vb.status IN ('confirmed', 'completed')\n        WHERE v.id = ${data.venueId}\n        GROUP BY v.id, v.max_concurrent_events\n        FOR UPDATE\n      )\n      INSERT INTO venue_bookings (\n        venue_id, event_id, booking_date, booking_time,\n        participant_count, estimated_revenue, status\n      )\n      SELECT \n        ${data.venueId}, ${data.eventId}, ${dateStr}::timestamp, ${data.bookingTime},\n        ${data.participantCount}, ${data.estimatedRevenue || null}, 'confirmed'\n      FROM venue_check\n      WHERE current_bookings < max_concurrent_events\n      RETURNING *\n    `);\n\n    if (result.rows.length === 0) {\n      throw new Error('Venue is not available at the requested time');\n    }\n\n    return result.rows[0];\n  }\n\n  async getVenueBookings(venueId: string): Promise<any[]> {\n    const result = await db.execute(sql`\n      SELECT vb.*, e.event_type, e.city, e.area\n      FROM venue_bookings vb\n      LEFT JOIN blind_box_events e ON vb.event_id = e.id\n      WHERE vb.venue_id = ${venueId}\n      ORDER BY vb.booking_date DESC, vb.booking_time DESC\n    `);\n    return result.rows;\n  }\n\n  async getEventVenueBooking(eventId: string): Promise<any | undefined> {\n    const result = await db.execute(sql`\n      SELECT vb.*, v.name as venue_name, v.address, v.city, v.district\n      FROM venue_bookings vb\n      LEFT JOIN venues v ON vb.venue_id = v.id\n      WHERE vb.event_id = ${eventId}\n      ORDER BY vb.created_at DESC\n      LIMIT 1\n    `);\n    return result.rows[0];\n  }\n\n  async cancelVenueBooking(bookingId: string): Promise<any> {\n    const result = await db.execute(sql`\n      UPDATE venue_bookings\n      SET status = 'cancelled', updated_at = NOW()\n      WHERE id = ${bookingId}\n      RETURNING *\n    `);\n    return result.rows[0];\n  }\n\n  async updateVenueBookingRevenue(bookingId: string, actualRevenue: number): Promise<any> {\n    const result = await db.execute(sql`\n      UPDATE venue_bookings vb\n      SET \n        actual_revenue = ${actualRevenue},\n        commission_amount = (\n          SELECT ROUND(${actualRevenue} * v.commission_rate / 100.0)\n          FROM venues v\n          WHERE v.id = vb.venue_id\n        ),\n        status = 'completed',\n        updated_at = NOW()\n      WHERE vb.id = ${bookingId}\n      RETURNING *\n    `);\n    return result.rows[0];\n  }\n\n  // ============ EVENT TEMPLATES ============\n  async getAllEventTemplates(): Promise<any[]> {\n    const result = await db.execute(sql`\n      SELECT * FROM event_templates\n      ORDER BY day_of_week, time_of_day\n    `);\n    return result.rows;\n  }\n\n  async getEventTemplate(id: string): Promise<any> {\n    const result = await db.execute(sql`SELECT * FROM event_templates WHERE id = ${id}`);\n    return result.rows[0];\n  }\n\n  async createEventTemplate(data: any): Promise<any> {\n    const result = await db.execute(sql`\n      INSERT INTO event_templates (name, event_type, day_of_week, time_of_day, theme, gender_restriction, min_age, max_age, min_participants, max_participants, custom_price, is_active)\n      VALUES (${data.name}, ${data.eventType}, ${data.dayOfWeek}, ${data.timeOfDay}, ${data.theme || null}, ${data.genderRestriction || null}, ${data.minAge || null}, ${data.maxAge || null}, ${data.minParticipants || 5}, ${data.maxParticipants || 10}, ${data.customPrice || null}, ${data.isActive !== false})\n      RETURNING *\n    `);\n    return result.rows[0];\n  }\n\n  async updateEventTemplate(id: string, updates: any): Promise<any> {\n    const setClauses = [];\n    const values: any[] = [];\n    \n    if (updates.name !== undefined) {\n      setClauses.push(`name = $${values.length + 1}`);\n      values.push(updates.name);\n    }\n    if (updates.eventType !== undefined) {\n      setClauses.push(`event_type = $${values.length + 1}`);\n      values.push(updates.eventType);\n    }\n    if (updates.dayOfWeek !== undefined) {\n      setClauses.push(`day_of_week = $${values.length + 1}`);\n      values.push(updates.dayOfWeek);\n    }\n    if (updates.timeOfDay !== undefined) {\n      setClauses.push(`time_of_day = $${values.length + 1}`);\n      values.push(updates.timeOfDay);\n    }\n    if (updates.theme !== undefined) {\n      setClauses.push(`theme = $${values.length + 1}`);\n      values.push(updates.theme);\n    }\n    if (updates.genderRestriction !== undefined) {\n      setClauses.push(`gender_restriction = $${values.length + 1}`);\n      values.push(updates.genderRestriction);\n    }\n    if (updates.minAge !== undefined) {\n      setClauses.push(`min_age = $${values.length + 1}`);\n      values.push(updates.minAge);\n    }\n    if (updates.maxAge !== undefined) {\n      setClauses.push(`max_age = $${values.length + 1}`);\n      values.push(updates.maxAge);\n    }\n    if (updates.minParticipants !== undefined) {\n      setClauses.push(`min_participants = $${values.length + 1}`);\n      values.push(updates.minParticipants);\n    }\n    if (updates.maxParticipants !== undefined) {\n      setClauses.push(`max_participants = $${values.length + 1}`);\n      values.push(updates.maxParticipants);\n    }\n    if (updates.customPrice !== undefined) {\n      setClauses.push(`custom_price = $${values.length + 1}`);\n      values.push(updates.customPrice);\n    }\n    if (updates.isActive !== undefined) {\n      setClauses.push(`is_active = $${values.length + 1}`);\n      values.push(updates.isActive);\n    }\n\n    if (setClauses.length === 0) {\n      return this.getEventTemplate(id);\n    }\n\n    values.push(id);\n    const query = sql.raw(`UPDATE event_templates SET ${setClauses.join(', ')} WHERE id = $${values.length} RETURNING *`);\n    const result = await db.execute(query);\n    return result.rows[0];\n  }\n\n  async deleteEventTemplate(id: string): Promise<void> {\n    await db.execute(sql`DELETE FROM event_templates WHERE id = ${id}`);\n  }\n\n  // ============ EVENT MANAGEMENT (Admin view of user events) ============\n  async getAllBlindBoxEventsAdmin(): Promise<any[]> {\n    const result = await db.execute(sql`\n      SELECT \n        e.*,\n        u.first_name as creator_first_name,\n        u.last_name as creator_last_name,\n        u.email as creator_email\n      FROM blind_box_events e\n      LEFT JOIN users u ON e.user_id = u.id\n      ORDER BY e.created_at DESC\n    `);\n    return result.rows;\n  }\n\n  async getBlindBoxEventAdmin(id: string): Promise<any> {\n    const result = await db.execute(sql`\n      SELECT \n        e.*,\n        u.first_name as creator_first_name,\n        u.last_name as creator_last_name,\n        u.email as creator_email,\n        u.phone_number as creator_phone\n      FROM blind_box_events e\n      LEFT JOIN users u ON e.user_id = u.id\n      WHERE e.id = ${id}\n    `);\n    return result.rows[0];\n  }\n\n  async updateBlindBoxEventAdmin(id: string, updates: any): Promise<any> {\n    const setClauses = [];\n    const values: any[] = [];\n    \n    if (updates.status !== undefined) {\n      setClauses.push(`status = $${values.length + 1}`);\n      values.push(updates.status);\n    }\n\n    if (setClauses.length === 0) {\n      return this.getBlindBoxEventAdmin(id);\n    }\n\n    values.push(id);\n    const query = sql.raw(`UPDATE blind_box_events SET ${setClauses.join(', ')} WHERE id = $${values.length} RETURNING *`);\n    const result = await db.execute(query);\n    return result.rows[0];\n  }\n\n  // ============ FINANCE MANAGEMENT ============\n  async getFinanceStats(): Promise<any> {\n    // Total revenue from all payments\n    const totalRevenue = await db.execute(sql`\n      SELECT COALESCE(SUM(amount), 0)::int as total FROM payments WHERE status = 'completed'\n    `);\n    \n    // Subscription revenue\n    const subscriptionRevenue = await db.execute(sql`\n      SELECT COALESCE(SUM(amount), 0)::int as total FROM payments \n      WHERE payment_type = 'subscription' AND status = 'completed'\n    `);\n    \n    // Event revenue\n    const eventRevenue = await db.execute(sql`\n      SELECT COALESCE(SUM(amount), 0)::int as total FROM payments \n      WHERE payment_type = 'event' AND status = 'completed'\n    `);\n    \n    // Total payments count\n    const totalPayments = await db.execute(sql`\n      SELECT COUNT(*)::int as count FROM payments\n    `);\n\n    return {\n      totalRevenue: totalRevenue.rows[0].total,\n      subscriptionRevenue: subscriptionRevenue.rows[0].total,\n      eventRevenue: eventRevenue.rows[0].total,\n      totalPayments: totalPayments.rows[0].count,\n    };\n  }\n\n  async getAllPayments(): Promise<any[]> {\n    const result = await db.execute(sql`\n      SELECT \n        p.*,\n        u.first_name as user_first_name,\n        u.last_name as user_last_name,\n        u.email as user_email\n      FROM payments p\n      LEFT JOIN users u ON p.user_id = u.id\n      ORDER BY p.created_at DESC\n    `);\n    return result.rows;\n  }\n\n  async getPaymentsByType(paymentType: string): Promise<any[]> {\n    const result = await db.execute(sql`\n      SELECT \n        p.*,\n        u.first_name as user_first_name,\n        u.last_name as user_last_name,\n        u.email as user_email\n      FROM payments p\n      LEFT JOIN users u ON p.user_id = u.id\n      WHERE p.payment_type = ${paymentType}\n      ORDER BY p.created_at DESC\n    `);\n    return result.rows;\n  }\n\n  async getVenueCommissions(): Promise<any[]> {\n    const result = await db.execute(sql`\n      SELECT \n        v.id,\n        v.name as venue_name,\n        v.commission_rate,\n        COUNT(vb.id)::int as booking_count,\n        COALESCE(SUM(vb.final_amount), 0)::int as total_revenue,\n        COALESCE(SUM(vb.commission_amount), 0)::int as total_commission\n      FROM venues v\n      LEFT JOIN venue_bookings vb ON v.id = vb.venue_id\n      GROUP BY v.id, v.name, v.commission_rate\n      ORDER BY total_commission DESC\n    `);\n    return result.rows;\n  }\n\n  // ============ MODERATION ============\n  async getModerationStats(): Promise<any> {\n    const totalReports = await db.execute(sql`\n      SELECT COUNT(*)::int as count FROM reports\n    `);\n    \n    const pendingReports = await db.execute(sql`\n      SELECT COUNT(*)::int as count FROM reports WHERE status = 'pending'\n    `);\n    \n    const resolvedReports = await db.execute(sql`\n      SELECT COUNT(*)::int as count FROM reports WHERE status = 'resolved'\n    `);\n    \n    const bannedUsers = await db.execute(sql`\n      SELECT COUNT(*)::int as count FROM users WHERE is_banned = true\n    `);\n\n    return {\n      totalReports: totalReports.rows[0].count,\n      pendingReports: pendingReports.rows[0].count,\n      resolvedReports: resolvedReports.rows[0].count,\n      bannedUsers: bannedUsers.rows[0].count,\n    };\n  }\n\n  async getAllReports(): Promise<any[]> {\n    const result = await db.execute(sql`\n      SELECT \n        r.*,\n        u1.first_name as reporter_first_name,\n        u1.last_name as reporter_last_name,\n        u1.email as reporter_email,\n        u2.first_name as reported_first_name,\n        u2.last_name as reported_last_name,\n        u2.email as reported_email\n      FROM reports r\n      LEFT JOIN users u1 ON r.reporter_id = u1.id\n      LEFT JOIN users u2 ON r.reported_user_id = u2.id\n      ORDER BY r.created_at DESC\n    `);\n    return result.rows;\n  }\n\n  async getPendingReports(): Promise<any[]> {\n    const result = await db.execute(sql`\n      SELECT \n        r.*,\n        u1.first_name as reporter_first_name,\n        u1.last_name as reporter_last_name,\n        u1.email as reporter_email,\n        u2.first_name as reported_first_name,\n        u2.last_name as reported_last_name,\n        u2.email as reported_email\n      FROM reports r\n      LEFT JOIN users u1 ON r.reporter_id = u1.id\n      LEFT JOIN users u2 ON r.reported_user_id = u2.id\n      WHERE r.status = 'pending'\n      ORDER BY r.created_at DESC\n    `);\n    return result.rows;\n  }\n\n  async updateReportStatus(id: string, status: string, adminNotes?: string): Promise<any> {\n    const result = await db.execute(sql`\n      UPDATE reports \n      SET status = ${status}, admin_notes = ${adminNotes || null}, resolved_at = ${status === 'resolved' ? new Date() : null}\n      WHERE id = ${id}\n      RETURNING *\n    `);\n    return result.rows[0];\n  }\n\n  async createModerationLog(data: any): Promise<any> {\n    const result = await db.execute(sql`\n      INSERT INTO moderation_logs (admin_id, action, target_user_id, reason, notes)\n      VALUES (${data.adminId}, ${data.action}, ${data.targetUserId}, ${data.reason || null}, ${data.notes || null})\n      RETURNING *\n    `);\n    return result.rows[0];\n  }\n\n  async getModerationLogs(): Promise<any[]> {\n    const result = await db.execute(sql`\n      SELECT \n        ml.*,\n        u1.first_name as admin_first_name,\n        u1.last_name as admin_last_name,\n        u2.first_name as target_first_name,\n        u2.last_name as target_last_name,\n        u2.email as target_email\n      FROM moderation_logs ml\n      LEFT JOIN users u1 ON ml.admin_id = u1.id\n      LEFT JOIN users u2 ON ml.target_user_id = u2.id\n      ORDER BY ml.created_at DESC\n      LIMIT 100\n    `);\n    return result.rows;\n  }\n\n  // ============ DATA INSIGHTS ============\n  async getInsightsData(): Promise<any> {\n    // Basic engagement metrics\n    const totalUsers = await db.execute(sql`SELECT COUNT(*)::int as count FROM users`);\n    const activeUsers = await db.execute(sql`\n      SELECT COUNT(DISTINCT user_id)::int as count FROM blind_box_events \n      WHERE created_at >= NOW() - INTERVAL '30 days'\n    `);\n    const totalEvents = await db.execute(sql`SELECT COUNT(*)::int as count FROM blind_box_events`);\n    \n    // New users last 7 days\n    const newUsers7Days = await db.execute(sql`\n      SELECT COUNT(*)::int as count FROM users \n      WHERE created_at >= NOW() - INTERVAL '7 days'\n    `);\n    \n    // New users previous 7 days (for growth calculation)\n    const newUsersPrevious7Days = await db.execute(sql`\n      SELECT COUNT(*)::int as count FROM users \n      WHERE created_at >= NOW() - INTERVAL '14 days' \n      AND created_at < NOW() - INTERVAL '7 days'\n    `);\n    \n    // User growth (last 30 days)\n    const userGrowth = await db.execute(sql`\n      SELECT DATE(created_at) as date, COUNT(*)::int as count \n      FROM users \n      WHERE created_at >= NOW() - INTERVAL '30 days'\n      GROUP BY DATE(created_at)\n      ORDER BY date DESC\n    `);\n\n    // Event trends (last 30 days)\n    const eventTrends = await db.execute(sql`\n      SELECT DATE(created_at) as date, COUNT(*)::int as count \n      FROM blind_box_events \n      WHERE created_at >= NOW() - INTERVAL '30 days'\n      GROUP BY DATE(created_at)\n      ORDER BY date DESC\n    `);\n\n    // Personality distribution\n    const personalityDistribution = await db.execute(sql`\n      SELECT archetype, COUNT(*)::int as count \n      FROM users \n      WHERE archetype IS NOT NULL\n      GROUP BY archetype\n      ORDER BY count DESC\n    `);\n\n    const avgEventsPerUser = (totalUsers.rows[0] as any).count > 0 \n      ? (totalEvents.rows[0] as any).count / (totalUsers.rows[0] as any).count \n      : 0;\n\n    // ============ 1. MATCHING EFFICIENCY ANALYSIS ============\n    const matchedEvents = await db.execute(sql`\n      SELECT COUNT(*)::int as count FROM blind_box_events \n      WHERE status IN ('matched', 'completed')\n    `);\n    \n    const matchingSuccessRate = (totalEvents.rows[0] as any).count > 0\n      ? ((matchedEvents.rows[0] as any).count / (totalEvents.rows[0] as any).count) * 100\n      : 0;\n    \n    // Average match time (in hours)\n    const avgMatchTimeResult = await db.execute(sql`\n      SELECT AVG(EXTRACT(EPOCH FROM (updated_at - created_at)) / 3600)::float as avg_hours\n      FROM blind_box_events\n      WHERE status IN ('matched', 'completed') AND updated_at IS NOT NULL\n    `);\n    const avgMatchTime = avgMatchTimeResult.rows[0]?.avg_hours || 0;\n    \n    // Attempts per user (total events / total users)\n    const attemptsPerUser = (totalUsers.rows[0] as any).count > 0\n      ? (totalEvents.rows[0] as any).count / (totalUsers.rows[0] as any).count\n      : 0;\n\n    // ============ 2. USER RETENTION ANALYSIS ============\n    \n    // Weekly retention (weeks 1-8)\n    const weeklyRetention = [];\n    for (let week = 1; week <= 8; week++) {\n      const retentionResult = await db.execute(sql`\n        WITH cohort AS (\n          SELECT DISTINCT user_id, DATE_TRUNC('week', created_at) as cohort_week\n          FROM users\n          WHERE created_at >= NOW() - INTERVAL '8 weeks'\n        ),\n        activity AS (\n          SELECT DISTINCT user_id, DATE_TRUNC('week', created_at) as activity_week\n          FROM blind_box_events\n        )\n        SELECT \n          COUNT(DISTINCT CASE WHEN a.activity_week = c.cohort_week + INTERVAL '${week} weeks' THEN c.user_id END)::float /\n          NULLIF(COUNT(DISTINCT c.user_id), 0) * 100 as retention_rate\n        FROM cohort c\n        LEFT JOIN activity a ON c.user_id = a.user_id\n        WHERE c.cohort_week <= NOW() - INTERVAL '${week} weeks'\n      `);\n      weeklyRetention.push({\n        week: week,\n        retentionRate: retentionResult.rows[0]?.retention_rate || 0\n      });\n    }\n    \n    // User segments\n    const newUsersSegment = await db.execute(sql`\n      SELECT COUNT(*)::int as count FROM users \n      WHERE created_at >= NOW() - INTERVAL '7 days'\n    `);\n    \n    const activeUsersSegment = await db.execute(sql`\n      SELECT COUNT(DISTINCT user_id)::int as count FROM blind_box_events \n      WHERE created_at >= NOW() - INTERVAL '30 days'\n    `);\n    \n    const dormantUsers = await db.execute(sql`\n      SELECT COUNT(DISTINCT user_id)::int as count FROM blind_box_events \n      WHERE created_at >= NOW() - INTERVAL '90 days'\n      AND created_at < NOW() - INTERVAL '30 days'\n      AND user_id NOT IN (\n        SELECT DISTINCT user_id FROM blind_box_events \n        WHERE created_at >= NOW() - INTERVAL '30 days'\n      )\n    `);\n    \n    const churnedUsers = await db.execute(sql`\n      SELECT COUNT(*)::int as count FROM users \n      WHERE id NOT IN (\n        SELECT DISTINCT user_id FROM blind_box_events \n        WHERE created_at >= NOW() - INTERVAL '90 days'\n      )\n      AND created_at < NOW() - INTERVAL '90 days'\n    `);\n    \n    // Super users (participated in 3+ events in last 30 days)\n    const superUsersResult = await db.execute(sql`\n      SELECT COUNT(DISTINCT user_id)::int as count FROM (\n        SELECT user_id, COUNT(*) as event_count\n        FROM blind_box_events\n        WHERE created_at >= NOW() - INTERVAL '30 days'\n        GROUP BY user_id\n        HAVING COUNT(*) >= 3\n      ) super_user_counts\n    `);\n    \n    const superUsersArchetypes = await db.execute(sql`\n      SELECT u.archetype, COUNT(*)::int as count\n      FROM (\n        SELECT user_id, COUNT(*) as event_count\n        FROM blind_box_events\n        WHERE created_at >= NOW() - INTERVAL '30 days'\n        GROUP BY user_id\n        HAVING COUNT(*) >= 3\n      ) su\n      JOIN users u ON su.user_id = u.id\n      WHERE u.archetype IS NOT NULL\n      GROUP BY u.archetype\n      ORDER BY count DESC\n      LIMIT 3\n    `);\n\n    // ============ 3. EVENT QUALITY INDICATORS ============\n    \n    const completedEvents = await db.execute(sql`\n      SELECT COUNT(*)::int as count FROM blind_box_events \n      WHERE status = 'completed'\n    `);\n    \n    const matchedOrCompletedEvents = await db.execute(sql`\n      SELECT COUNT(*)::int as count FROM blind_box_events \n      WHERE status IN ('matched', 'completed')\n    `);\n    \n    const completionRate = (matchedOrCompletedEvents.rows[0] as any).count > 0\n      ? ((completedEvents.rows[0] as any).count / (matchedOrCompletedEvents.rows[0] as any).count) * 100\n      : 0;\n    \n    // Average rating from feedback\n    const avgRatingResult = await db.execute(sql`\n      SELECT AVG(rating)::float as avg_rating \n      FROM event_feedback \n      WHERE rating IS NOT NULL\n    `);\n    const avgRating = avgRatingResult.rows[0]?.avg_rating || 0;\n    \n    // Complaint rate (events with reports)\n    const eventsWithReports = await db.execute(sql`\n      SELECT COUNT(DISTINCT event_id)::int as count FROM chat_reports \n      WHERE event_id IS NOT NULL\n    `);\n    \n    const complaintRate = (totalEvents.rows[0] as any).count > 0\n      ? ((eventsWithReports.rows[0] as any).count / (totalEvents.rows[0] as any).count) * 100\n      : 0;\n    \n    // Low-rated events (rating < 3.0)\n    const lowRatedEvents = await db.execute(sql`\n      SELECT \n        e.id as event_id,\n        e.title,\n        AVG(f.rating)::float as avg_rating,\n        e.date_time as date\n      FROM blind_box_events e\n      JOIN event_feedback f ON e.id = f.event_id\n      WHERE f.rating IS NOT NULL\n      GROUP BY e.id, e.title, e.date_time\n      HAVING AVG(f.rating) < 3.0\n      ORDER BY avg_rating ASC\n      LIMIT 10\n    `);\n\n    // ============ 4. MONETIZATION FUNNEL ============\n    \n    const paidUsers = await db.execute(sql`\n      SELECT COUNT(DISTINCT user_id)::int as count FROM payments \n      WHERE status = 'completed'\n    `);\n    \n    const conversionRate = (totalUsers.rows[0] as any).count > 0\n      ? ((paidUsers.rows[0] as any).count / (totalUsers.rows[0] as any).count) * 100\n      : 0;\n    \n    // Revenue breakdown\n    const subscriptionRevenue = await db.execute(sql`\n      SELECT COALESCE(SUM(final_amount), 0)::int as total \n      FROM payments \n      WHERE payment_type = 'subscription' AND status = 'completed'\n    `);\n    \n    const eventRevenue = await db.execute(sql`\n      SELECT COALESCE(SUM(final_amount), 0)::int as total \n      FROM payments \n      WHERE payment_type = 'event' AND status = 'completed'\n    `);\n    \n    const totalRevenue = (subscriptionRevenue.rows[0] as any).total + (eventRevenue.rows[0] as any).total;\n    \n    const arpu = (totalUsers.rows[0] as any).count > 0\n      ? totalRevenue / (totalUsers.rows[0] as any).count\n      : 0;\n    \n    // Conversion funnel\n    const browsedEvents = await db.execute(sql`\n      SELECT COUNT(DISTINCT user_id)::int as count FROM blind_box_events\n    `);\n    \n    const signedUpUsers = await db.execute(sql`\n      SELECT COUNT(DISTINCT user_id)::int as count FROM blind_box_events\n    `);\n    \n    // Monthly revenue (current month)\n    const monthlyRevenue = await db.execute(sql`\n      SELECT COALESCE(SUM(final_amount), 0)::int as total \n      FROM payments \n      WHERE status = 'completed' \n      AND EXTRACT(MONTH FROM created_at) = EXTRACT(MONTH FROM NOW())\n      AND EXTRACT(YEAR FROM created_at) = EXTRACT(YEAR FROM NOW())\n    `);\n\n    return {\n      engagementMetrics: {\n        totalUsers: totalUsers.rows[0].count,\n        activeUsers: activeUsers.rows[0].count,\n        totalEvents: totalEvents.rows[0].count,\n        avgEventsPerUser,\n        newUsers7Days: newUsers7Days.rows[0].count,\n        newUsersPrevious7Days: newUsersPrevious7Days.rows[0].count,\n      },\n      userGrowth: userGrowth.rows,\n      eventTrends: eventTrends.rows,\n      personalityDistribution: personalityDistribution.rows,\n      \n      // New analytics\n      matchingEfficiency: {\n        successRate: matchingSuccessRate,\n        avgMatchTime: avgMatchTime,\n        attemptsPerUser: attemptsPerUser,\n      },\n      \n      retention: {\n        weeklyRetention: weeklyRetention,\n        userSegments: {\n          new: newUsersSegment.rows[0].count,\n          active: activeUsersSegment.rows[0].count,\n          dormant: dormantUsers.rows[0].count,\n          churned: churnedUsers.rows[0].count,\n        },\n        superUsers: {\n          count: superUsersResult.rows[0].count,\n          topArchetypes: superUsersArchetypes.rows,\n        },\n      },\n      \n      eventQuality: {\n        completionRate: completionRate,\n        avgRating: avgRating,\n        complaintRate: complaintRate,\n        lowRatedEvents: lowRatedEvents.rows,\n      },\n      \n      monetization: {\n        conversionRate: conversionRate,\n        revenueBreakdown: {\n          subscription: subscriptionRevenue.rows[0].total,\n          singleEvent: eventRevenue.rows[0].total,\n        },\n        arpu: arpu,\n        conversionFunnel: {\n          registered: totalUsers.rows[0].count,\n          browsedEvents: browsedEvents.rows[0].count,\n          signedUp: signedUpUsers.rows[0].count,\n          paid: paidUsers.rows[0].count,\n        },\n        monthlyRevenue: monthlyRevenue.rows[0].total,\n      },\n    };\n  }\n\n  // ============ CONTENT MANAGEMENT OPERATIONS ============\n\n  async getAllContents(type?: string): Promise<any[]> {\n    if (type) {\n      return await db.select().from(contents).where(eq(contents.type, type)).orderBy(desc(contents.priority), desc(contents.createdAt));\n    }\n    return await db.select().from(contents).orderBy(desc(contents.createdAt));\n  }\n\n  async getContent(id: string): Promise<any | undefined> {\n    const [content] = await db.select().from(contents).where(eq(contents.id, id));\n    return content;\n  }\n\n  async createContent(data: InsertContent): Promise<Content> {\n    const [content] = await db.insert(contents).values(data).returning();\n    return content;\n  }\n\n  async updateContent(id: string, updates: Partial<Content>): Promise<Content> {\n    const [content] = await db\n      .update(contents)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(contents.id, id))\n      .returning();\n    return content;\n  }\n\n  async deleteContent(id: string): Promise<void> {\n    await db.delete(contents).where(eq(contents.id, id));\n  }\n\n  async getPublishedContents(type: string): Promise<any[]> {\n    return await db\n      .select()\n      .from(contents)\n      .where(and(\n        eq(contents.type, type),\n        eq(contents.status, 'published')\n      ))\n      .orderBy(desc(contents.priority), desc(contents.publishedAt));\n  }\n\n  // ============ MATCHING ALGORITHM OPERATIONS ============\n  \n  async getUserById(id: string): Promise<User | undefined> {\n    // Same as getUser, but explicit name for matching context\n    return this.getUser(id);\n  }\n\n  async getActiveMatchingConfig(): Promise<any | undefined> {\n    const result = await db.execute(sql`\n      SELECT * FROM matching_config \n      WHERE is_active = true \n      ORDER BY created_at DESC \n      LIMIT 1\n    `);\n    return result.rows[0] || undefined;\n  }\n\n  async updateMatchingConfig(config: any): Promise<any> {\n    // First, deactivate all existing configs\n    await db.execute(sql`\n      UPDATE matching_config SET is_active = false\n    `);\n\n    // Insert new config as active\n    const result = await db.execute(sql`\n      INSERT INTO matching_config (\n        config_name, \n        personality_weight, \n        interests_weight, \n        intent_weight, \n        background_weight, \n        culture_weight,\n        min_group_size,\n        max_group_size,\n        preferred_group_size,\n        max_same_archetype_ratio,\n        min_chemistry_score,\n        is_active,\n        notes,\n        created_by\n      ) VALUES (\n        ${config.configName || 'default'},\n        ${config.personalityWeight || 30},\n        ${config.interestsWeight || 25},\n        ${config.intentWeight || 20},\n        ${config.backgroundWeight || 15},\n        ${config.cultureWeight || 10},\n        ${config.minGroupSize || 5},\n        ${config.maxGroupSize || 10},\n        ${config.preferredGroupSize || 7},\n        ${config.maxSameArchetypeRatio || 40},\n        ${config.minChemistryScore || 60},\n        true,\n        ${config.notes || null},\n        ${config.createdBy || null}\n      )\n      RETURNING *\n    `);\n    return result.rows[0];\n  }\n\n  async saveMatchingResult(result: any): Promise<any> {\n    // Format userIds as properly escaped PostgreSQL array\n    const userIdsArray = result.userIds || [];\n    // Each UUID needs to be quoted and escaped\n    const userIdsLiteral = `ARRAY[${userIdsArray.map((id: string) => `'${id}'`).join(',')}]::text[]`;\n    \n    const insertResult = await db.execute(sql`\n      INSERT INTO matching_results (\n        event_id,\n        config_id,\n        user_ids,\n        user_count,\n        groups,\n        group_count,\n        avg_chemistry_score,\n        avg_diversity_score,\n        overall_match_quality,\n        execution_time_ms,\n        is_test_run,\n        notes\n      ) VALUES (\n        ${result.eventId || null},\n        ${result.configId || null},\n        ${sql.raw(userIdsLiteral)},\n        ${result.userCount || 0},\n        ${JSON.stringify(result.groups || [])}::jsonb,\n        ${result.groupCount || 0},\n        ${result.avgChemistryScore || 0},\n        ${result.avgDiversityScore || 0},\n        ${result.overallMatchQuality || 0},\n        ${result.executionTimeMs || 0},\n        ${result.isTestRun || false},\n        ${result.notes || null}\n      )\n      RETURNING *\n    `);\n    return insertResult.rows[0];\n  }\n\n  // ============ ADMIN FEEDBACK OPERATIONS ============\n  async getAllFeedbacks(filters?: {\n    eventId?: string;\n    minRating?: number;\n    maxRating?: number;\n    startDate?: Date;\n    endDate?: Date;\n    hasDeepFeedback?: boolean;\n  }): Promise<Array<EventFeedback & { user: { displayName: string | null; phoneNumber: string | null }; event: { title: string; dateTime: Date; status: string | null } }>> {\n    const conditions = [];\n    \n    if (filters?.eventId) {\n      conditions.push(eq(eventFeedback.eventId, filters.eventId));\n    }\n    \n    if (filters?.minRating !== undefined) {\n      conditions.push(gte(eventFeedback.atmosphereScore, filters.minRating));\n    }\n    \n    if (filters?.maxRating !== undefined) {\n      conditions.push(lte(eventFeedback.atmosphereScore, filters.maxRating));\n    }\n    \n    if (filters?.startDate) {\n      conditions.push(gte(eventFeedback.createdAt, filters.startDate));\n    }\n    \n    if (filters?.endDate) {\n      conditions.push(lte(eventFeedback.createdAt, filters.endDate));\n    }\n    \n    if (filters?.hasDeepFeedback !== undefined) {\n      conditions.push(eq(eventFeedback.hasDeepFeedback, filters.hasDeepFeedback));\n    }\n\n    const baseQuery = db\n      .select({\n        id: eventFeedback.id,\n        eventId: eventFeedback.eventId,\n        userId: eventFeedback.userId,\n        rating: eventFeedback.rating,\n        vibeMatch: eventFeedback.vibeMatch,\n        energyMatch: eventFeedback.energyMatch,\n        wouldAttendAgain: eventFeedback.wouldAttendAgain,\n        feedback: eventFeedback.feedback,\n        connections: eventFeedback.connections,\n        atmosphereScore: eventFeedback.atmosphereScore,\n        atmosphereNote: eventFeedback.atmosphereNote,\n        attendeeTraits: eventFeedback.attendeeTraits,\n        connectionRadar: eventFeedback.connectionRadar,\n        hasNewConnections: eventFeedback.hasNewConnections,\n        connectionStatus: eventFeedback.connectionStatus,\n        improvementAreas: eventFeedback.improvementAreas,\n        improvementOther: eventFeedback.improvementOther,\n        completedAt: eventFeedback.completedAt,\n        rewardsClaimed: eventFeedback.rewardsClaimed,\n        rewardPoints: eventFeedback.rewardPoints,\n        hasDeepFeedback: eventFeedback.hasDeepFeedback,\n        matchPointValidation: eventFeedback.matchPointValidation,\n        additionalMatchPoints: eventFeedback.additionalMatchPoints,\n        conversationBalance: eventFeedback.conversationBalance,\n        conversationComfort: eventFeedback.conversationComfort,\n        conversationNotes: eventFeedback.conversationNotes,\n        futurePreferences: eventFeedback.futurePreferences,\n        futurePreferencesOther: eventFeedback.futurePreferencesOther,\n        deepFeedbackCompletedAt: eventFeedback.deepFeedbackCompletedAt,\n        createdAt: eventFeedback.createdAt,\n        user: {\n          displayName: users.displayName,\n          phoneNumber: users.phoneNumber,\n        },\n        event: {\n          title: events.title,\n          dateTime: events.dateTime,\n          status: events.status,\n        },\n      })\n      .from(eventFeedback)\n      .leftJoin(users, eq(eventFeedback.userId, users.id))\n      .leftJoin(events, eq(eventFeedback.eventId, events.id));\n\n    const results = conditions.length > 0\n      ? await baseQuery.where(and(...conditions)).orderBy(desc(eventFeedback.createdAt))\n      : await baseQuery.orderBy(desc(eventFeedback.createdAt));\n\n    return results as any;\n  }\n\n  async getFeedbackById(id: string): Promise<(EventFeedback & { user: User; event: Event }) | undefined> {\n    const [result] = await db\n      .select({\n        id: eventFeedback.id,\n        eventId: eventFeedback.eventId,\n        userId: eventFeedback.userId,\n        rating: eventFeedback.rating,\n        vibeMatch: eventFeedback.vibeMatch,\n        energyMatch: eventFeedback.energyMatch,\n        wouldAttendAgain: eventFeedback.wouldAttendAgain,\n        feedback: eventFeedback.feedback,\n        connections: eventFeedback.connections,\n        atmosphereScore: eventFeedback.atmosphereScore,\n        atmosphereNote: eventFeedback.atmosphereNote,\n        attendeeTraits: eventFeedback.attendeeTraits,\n        connectionRadar: eventFeedback.connectionRadar,\n        hasNewConnections: eventFeedback.hasNewConnections,\n        connectionStatus: eventFeedback.connectionStatus,\n        improvementAreas: eventFeedback.improvementAreas,\n        improvementOther: eventFeedback.improvementOther,\n        completedAt: eventFeedback.completedAt,\n        rewardsClaimed: eventFeedback.rewardsClaimed,\n        rewardPoints: eventFeedback.rewardPoints,\n        hasDeepFeedback: eventFeedback.hasDeepFeedback,\n        matchPointValidation: eventFeedback.matchPointValidation,\n        additionalMatchPoints: eventFeedback.additionalMatchPoints,\n        conversationBalance: eventFeedback.conversationBalance,\n        conversationComfort: eventFeedback.conversationComfort,\n        conversationNotes: eventFeedback.conversationNotes,\n        futurePreferences: eventFeedback.futurePreferences,\n        futurePreferencesOther: eventFeedback.futurePreferencesOther,\n        deepFeedbackCompletedAt: eventFeedback.deepFeedbackCompletedAt,\n        createdAt: eventFeedback.createdAt,\n        user: users,\n        event: events,\n      })\n      .from(eventFeedback)\n      .leftJoin(users, eq(eventFeedback.userId, users.id))\n      .leftJoin(events, eq(eventFeedback.eventId, events.id))\n      .where(eq(eventFeedback.id, id));\n\n    return result as any;\n  }\n\n  async getFeedbackStats(): Promise<{\n    totalFeedbacks: number;\n    avgAtmosphereScore: number;\n    lowRatedCount: number;\n    deepFeedbackRate: number;\n    topImprovementAreas: Array<{ area: string; count: number }>;\n    connectionStatusBreakdown: Record<string, number>;\n  }> {\n    // Get total count and average atmosphere score\n    const statsResult = await db.execute(sql`\n      SELECT \n        COUNT(*)::int as total_feedbacks,\n        AVG(atmosphere_score)::float as avg_atmosphere_score,\n        COUNT(CASE WHEN atmosphere_score < 3 THEN 1 END)::int as low_rated_count,\n        COUNT(CASE WHEN has_deep_feedback = true THEN 1 END)::int as deep_feedback_count\n      FROM event_feedback\n    `);\n    \n    const stats = statsResult.rows[0] as any;\n    const totalFeedbacks = stats.total_feedbacks || 0;\n    const avgAtmosphereScore = stats.avg_atmosphere_score || 0;\n    const lowRatedCount = stats.low_rated_count || 0;\n    const deepFeedbackCount = stats.deep_feedback_count || 0;\n    const deepFeedbackRate = totalFeedbacks > 0 ? (deepFeedbackCount / totalFeedbacks) * 100 : 0;\n\n    // Get top improvement areas\n    const improvementAreasResult = await db.execute(sql`\n      SELECT area, COUNT(*)::int as count\n      FROM event_feedback, unnest(improvement_areas) as area\n      WHERE improvement_areas IS NOT NULL\n      GROUP BY area\n      ORDER BY count DESC\n      LIMIT 5\n    `);\n    \n    const topImprovementAreas = improvementAreasResult.rows.map((row: any) => ({\n      area: row.area,\n      count: row.count,\n    }));\n\n    // Get connection status breakdown\n    const connectionStatusResult = await db.execute(sql`\n      SELECT \n        connection_status,\n        COUNT(*)::int as count\n      FROM event_feedback\n      WHERE connection_status IS NOT NULL\n      GROUP BY connection_status\n    `);\n\n    const connectionStatusBreakdown: Record<string, number> = {};\n    connectionStatusResult.rows.forEach((row: any) => {\n      connectionStatusBreakdown[row.connection_status] = row.count;\n    });\n\n    return {\n      totalFeedbacks,\n      avgAtmosphereScore: Math.round(avgAtmosphereScore * 10) / 10,\n      lowRatedCount,\n      deepFeedbackRate: Math.round(deepFeedbackRate * 10) / 10,\n      topImprovementAreas,\n      connectionStatusBreakdown,\n    };\n  }\n\n  // ============ CHAT REPORT OPERATIONS ============\n\n  async createChatReport(data: InsertChatReport): Promise<ChatReport> {\n    const [report] = await db.insert(chatReports).values(data).returning();\n    return report;\n  }\n\n  async getChatReports(status?: string): Promise<Array<ChatReport & { reporter: User; reportedUser: User; message: ChatMessage }>> {\n    const query = db\n      .select({\n        report: chatReports,\n        reporter: users,\n        reportedUser: users,\n        message: chatMessages,\n      })\n      .from(chatReports)\n      .leftJoin(users, eq(chatReports.reportedBy, users.id))\n      .leftJoin(users as any, eq(chatReports.reportedUserId, (users as any).id))\n      .leftJoin(chatMessages, eq(chatReports.messageId, chatMessages.id))\n      .orderBy(desc(chatReports.createdAt));\n\n    const results: any = status\n      ? await query.where(eq(chatReports.status, status))\n      : await query;\n\n    return results.map((r: any) => ({\n      ...r.report,\n      reporter: r.reporter,\n      reportedUser: r.reportedUser,\n      message: r.message,\n    }));\n  }\n\n  async getChatReport(id: string): Promise<(ChatReport & { reporter: User; reportedUser: User; message: ChatMessage }) | undefined> {\n    const result: any = await db\n      .select({\n        report: chatReports,\n        reporter: users,\n        reportedUser: users,\n        message: chatMessages,\n      })\n      .from(chatReports)\n      .leftJoin(users, eq(chatReports.reportedBy, users.id))\n      .leftJoin(users as any, eq(chatReports.reportedUserId, (users as any).id))\n      .leftJoin(chatMessages, eq(chatReports.messageId, chatMessages.id))\n      .where(eq(chatReports.id, id))\n      .limit(1);\n\n    if (!result || result.length === 0) return undefined;\n\n    return {\n      ...result[0].report,\n      reporter: result[0].reporter,\n      reportedUser: result[0].reportedUser,\n      message: result[0].message,\n    };\n  }\n\n  async updateChatReport(id: string, updates: { status?: string; reviewedBy?: string; reviewNotes?: string; actionTaken?: string }): Promise<ChatReport> {\n    const [report] = await db\n      .update(chatReports)\n      .set({ ...updates, reviewedAt: new Date() })\n      .where(eq(chatReports.id, id))\n      .returning();\n    return report;\n  }\n\n  async getChatReportContext(messageId: string, eventId?: string, threadId?: string): Promise<Array<ChatMessage & { user: User }>> {\n    // Get the reported message's timestamp\n    const [reportedMessage] = await db\n      .select()\n      .from(chatMessages)\n      .where(eq(chatMessages.id, messageId))\n      .limit(1);\n\n    if (!reportedMessage) return [];\n\n    // Get 10 messages before and after (total 21 including the reported message)\n    const result: any = await db\n      .select({\n        message: chatMessages,\n        user: users,\n      })\n      .from(chatMessages)\n      .leftJoin(users, eq(chatMessages.userId, users.id))\n      .where(\n        and(\n          eventId ? eq(chatMessages.eventId, eventId) : undefined\n        )\n      )\n      .orderBy(chatMessages.createdAt)\n      .limit(21);\n\n    return result.map((r: any) => ({ ...r.message, user: r.user }));\n  }\n\n  // ============ CHAT LOG OPERATIONS ============\n\n  async createChatLog(data: InsertChatLog): Promise<ChatLog> {\n    const [log] = await db.insert(chatLogs).values(data).returning();\n    return log;\n  }\n\n  async getChatLogs(filters?: { eventId?: string; userId?: string; severity?: string; startDate?: Date; endDate?: Date }): Promise<ChatLog[]> {\n    const conditions = [];\n\n    if (filters?.eventId) {\n      conditions.push(eq(chatLogs.eventId, filters.eventId));\n    }\n    if (filters?.userId) {\n      conditions.push(eq(chatLogs.userId, filters.userId));\n    }\n    if (filters?.severity) {\n      conditions.push(eq(chatLogs.severity, filters.severity));\n    }\n    if (filters?.startDate) {\n      conditions.push(gte(chatLogs.createdAt, filters.startDate));\n    }\n    if (filters?.endDate) {\n      conditions.push(lte(chatLogs.createdAt, filters.endDate));\n    }\n\n    return await db\n      .select()\n      .from(chatLogs)\n      .where(conditions.length > 0 ? and(...conditions) : undefined)\n      .orderBy(desc(chatLogs.createdAt));\n  }\n\n  async getChatLogStats(): Promise<{ total: number; errors: number; warnings: number; info: number }> {\n    const result = await db.execute(sql`\n      SELECT \n        COUNT(*) as total,\n        SUM(CASE WHEN severity = 'error' THEN 1 ELSE 0 END) as errors,\n        SUM(CASE WHEN severity = 'warning' THEN 1 ELSE 0 END) as warnings,\n        SUM(CASE WHEN severity = 'info' THEN 1 ELSE 0 END) as info\n      FROM chat_logs\n    `);\n\n    const row: any = result.rows[0];\n    return {\n      total: parseInt(row.total) || 0,\n      errors: parseInt(row.errors) || 0,\n      warnings: parseInt(row.warnings) || 0,\n      info: parseInt(row.info) || 0,\n    };\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","size_bytes":91723},"client/src/components/examples/MatchScoreBadge.tsx":{"content":"import MatchScoreBadge from '../MatchScoreBadge';\n\nexport default function MatchScoreBadgeExample() {\n  return (\n    <div className=\"flex flex-col gap-3 p-4 bg-slate-800\">\n      <MatchScoreBadge myFit={92} groupSpark=\"High\" />\n      <MatchScoreBadge myFit={86} groupSpark=\"Medium\" />\n      <MatchScoreBadge myFit={78} compact />\n    </div>\n  );\n}\n","size_bytes":347},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"client/src/pages/OnboardingQuizPage.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { ArrowLeft } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\nimport { useState } from \"react\";\nimport VoiceQuiz from \"@/components/VoiceQuiz\";\nimport QuizIntro from \"@/components/QuizIntro\";\nimport PersonalityProfile from \"@/components/PersonalityProfile\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function OnboardingQuizPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [stage, setStage] = useState<\"intro\" | \"quiz\" | \"results\">(\"intro\");\n  const [coachGender, setCoachGender] = useState<\"female\" | \"male\">(\"female\");\n  const [results, setResults] = useState<any>(null);\n\n  const savePersonalityMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"POST\", \"/api/profile/personality\", {\n        personalityTraits: data.traits,\n        personalityChallenges: data.challenges,\n        idealMatch: data.idealMatch,\n        energyLevel: data.energyLevel || 75,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"æµ‹è¯„å®Œæˆ\",\n        description: \"ä½ çš„æ€§æ ¼ç‰¹è´¨å·²ä¿å­˜\",\n      });\n      setLocation(\"/\");\n    },\n    onError: (error) => {\n      toast({\n        title: \"ä¿å­˜å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const skipOnboardingMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"POST\", \"/api/profile/personality\", {\n        personalityTraits: [],\n        personalityChallenges: [],\n        idealMatch: \"\",\n        energyLevel: 75,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      setLocation(\"/\");\n    },\n    onError: (error) => {\n      toast({\n        title: \"è·³è¿‡å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleStartQuiz = (gender: \"female\" | \"male\") => {\n    setCoachGender(gender);\n    setStage(\"quiz\");\n  };\n\n  const handleQuizComplete = (quizResults: any) => {\n    setResults(quizResults);\n    setStage(\"results\");\n  };\n\n  const handleFinish = () => {\n    if (results) {\n      savePersonalityMutation.mutate(results);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"sticky top-0 z-40 bg-background/95 backdrop-blur-sm border-b\">\n        <div className=\"flex items-center h-14 px-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            onClick={() => stage === \"results\" ? handleFinish() : skipOnboardingMutation.mutate()}\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"ml-2 font-semibold\">\n            {stage === \"intro\" && \"æ€§æ ¼æµ‹è¯„\"}\n            {stage === \"quiz\" && \"è¯­éŸ³é—®ç­”\"}\n            {stage === \"results\" && \"æµ‹è¯„ç»“æœ\"}\n          </h1>\n        </div>\n      </div>\n\n      <div className=\"px-4 py-6\">\n        {stage === \"intro\" && (\n          <QuizIntro \n            onStart={handleStartQuiz}\n            onSkip={() => skipOnboardingMutation.mutate()}\n          />\n        )}\n\n        {stage === \"quiz\" && (\n          <VoiceQuiz \n            onComplete={handleQuizComplete}\n            onSkip={() => skipOnboardingMutation.mutate()}\n            coachGender={coachGender}\n          />\n        )}\n\n        {stage === \"results\" && results && (\n          <div className=\"space-y-4\">\n            <div className=\"text-center space-y-2 pb-4\">\n              <h2 className=\"text-2xl font-display font-bold\">æµ‹è¯„å®Œæˆï¼</h2>\n              <p className=\"text-sm text-muted-foreground\">\n                ä»¥ä¸‹æ˜¯ä½ çš„æ€§æ ¼åˆ†æç»“æœ\n              </p>\n            </div>\n\n            <PersonalityProfile\n              traits={results.traits}\n              challenges={results.challenges}\n              idealMatch={results.idealMatch}\n              energyLevel={results.energyLevel || 75}\n            />\n\n            <Button \n              className=\"w-full\" \n              size=\"lg\"\n              onClick={handleFinish}\n              disabled={savePersonalityMutation.isPending}\n              data-testid=\"button-finish-quiz\"\n            >\n              {savePersonalityMutation.isPending ? \"ä¿å­˜ä¸­...\" : \"å®Œæˆå¹¶ä¿å­˜\"}\n            </Button>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":4664},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1280},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/components/MatchScoreBadge.tsx":{"content":"import { Badge } from \"@/components/ui/badge\";\nimport { Sparkles, Zap } from \"lucide-react\";\n\ninterface MatchScoreBadgeProps {\n  myFit: number;\n  groupSpark?: \"High\" | \"Medium\" | \"Low\";\n  compact?: boolean;\n}\n\nconst sparkLabels = {\n  High: \"é«˜\",\n  Medium: \"ä¸­\",\n  Low: \"ä½\"\n};\n\nexport default function MatchScoreBadge({ myFit, groupSpark, compact = false }: MatchScoreBadgeProps) {\n  const sparkColors = {\n    High: \"text-emerald-500\",\n    Medium: \"text-amber-500\",\n    Low: \"text-slate-400\"\n  };\n\n  if (compact) {\n    return (\n      <Badge className=\"bg-background/90 backdrop-blur-sm text-foreground border-0 px-2 py-0.5\">\n        <Sparkles className=\"h-3 w-3 mr-1\" />\n        <span className=\"text-xs font-semibold\">{myFit}%</span>\n      </Badge>\n    );\n  }\n\n  return (\n    <Badge className=\"bg-background/90 backdrop-blur-sm text-foreground border-0 px-2.5 py-1 flex-col items-start gap-0.5\">\n      <div className=\"flex items-center gap-1\">\n        <Sparkles className=\"h-3 w-3\" />\n        <span className=\"text-xs font-semibold\">{myFit}% åŒ¹é…</span>\n      </div>\n      {groupSpark && (\n        <div className=\"flex items-center gap-1\">\n          <Zap className={`h-3 w-3 ${sparkColors[groupSpark]}`} />\n          <span className=\"text-[10px]\">æ°›å›´: {sparkLabels[groupSpark]}</span>\n        </div>\n      )}\n    </Badge>\n  );\n}\n","size_bytes":1338},"client/src/pages/LandingPage.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Sparkles, Users, Zap, Heart } from \"lucide-react\";\n\nexport default function LandingPage() {\n  const handleLogin = () => {\n    window.location.href = \"/api/login\";\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-primary/5 to-background\">\n      <div className=\"container mx-auto px-4 py-8 max-w-2xl\">\n        <div className=\"text-center space-y-6 py-12\">\n          <div className=\"flex justify-center\">\n            <div className=\"h-20 w-20 rounded-full bg-gradient-to-br from-primary to-primary/60 flex items-center justify-center\">\n              <Sparkles className=\"h-10 w-10 text-white\" />\n            </div>\n          </div>\n          \n          <div className=\"space-y-2\">\n            <h1 className=\"text-4xl font-display font-bold\">æ‚¦èšÂ·Joy</h1>\n            <p className=\"text-lg text-muted-foreground\">å°å±€Â·å¥½èƒ½é‡</p>\n          </div>\n\n          <p className=\"text-base text-muted-foreground max-w-md mx-auto\">\n            åœ¨é¦™æ¸¯å’Œæ·±åœ³ï¼Œå‘ç°ä½ çš„å°åœˆå­ã€‚5-10äººçš„å¾®å‹èšä¼šï¼ŒAIæ™ºèƒ½åŒ¹é…ï¼Œé€æ˜è¯„åˆ†ï¼Œæ‰¾åˆ°çœŸæ­£åˆæ‹çš„æœ‹å‹ã€‚\n          </p>\n\n          <Button \n            size=\"lg\" \n            className=\"mt-8\"\n            onClick={handleLogin}\n            data-testid=\"button-login\"\n          >\n            å¼€å§‹ä½¿ç”¨\n          </Button>\n        </div>\n\n        <div className=\"grid grid-cols-1 gap-4 mt-12\">\n          <Card className=\"border shadow-sm\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-start gap-4\">\n                <div className=\"h-12 w-12 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                  <Users className=\"h-6 w-6 text-primary\" />\n                </div>\n                <div className=\"flex-1 space-y-1\">\n                  <h3 className=\"font-semibold\">5-10äººå¾®å‹å±€</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    å°è€Œç¾çš„èšä¼šï¼Œè®©æ¯ä¸ªäººéƒ½èƒ½å‚ä¸å¯¹è¯ï¼Œå»ºç«‹çœŸå®è¿æ¥\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border shadow-sm\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-start gap-4\">\n                <div className=\"h-12 w-12 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                  <Zap className=\"h-6 w-6 text-primary\" />\n                </div>\n                <div className=\"flex-1 space-y-1\">\n                  <h3 className=\"font-semibold\">AIæ™ºèƒ½åŒ¹é…</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    è¯­éŸ³æ€§æ ¼æµ‹è¯„ï¼Œé€æ˜åŒ¹é…è¯„åˆ†ï¼Œæ‰¾åˆ°çœŸæ­£åˆæ‹çš„æœ‹å‹\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border shadow-sm\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-start gap-4\">\n                <div className=\"h-12 w-12 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                  <Heart className=\"h-6 w-6 text-primary\" />\n                </div>\n                <div className=\"flex-1 space-y-1\">\n                  <h3 className=\"font-semibold\">æ°›å›´æ ‡ç­¾å‘ç°</h3>\n                  <p className=\"text-sm text-muted-foreground\">\n                    8ç§æ°›å›´æ ‡ç­¾ï¼Œå¿«é€Ÿæ‰¾åˆ°é€‚åˆä½ å¿ƒæƒ…çš„æ´»åŠ¨\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"text-center mt-12 text-sm text-muted-foreground\">\n          <p>ä¸“æ³¨é¦™æ¸¯å’Œæ·±åœ³æœ¬åœ°ç¤¾äº¤</p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":3865},"client/src/components/PersonalityRadarChart.tsx":{"content":"interface PersonalityRadarChartProps {\n  affinityScore: number;\n  opennessScore: number;\n  conscientiousnessScore: number;\n  emotionalStabilityScore: number;\n  extraversionScore: number;\n  positivityScore: number;\n}\n\nexport default function PersonalityRadarChart({\n  affinityScore,\n  opennessScore,\n  conscientiousnessScore,\n  emotionalStabilityScore,\n  extraversionScore,\n  positivityScore,\n}: PersonalityRadarChartProps) {\n  const traits = [\n    { name: 'äº²å’ŒåŠ›', score: affinityScore, maxScore: 10 },\n    { name: 'å¼€æ”¾æ€§', score: opennessScore, maxScore: 10 },\n    { name: 'è´£ä»»å¿ƒ', score: conscientiousnessScore, maxScore: 10 },\n    { name: 'æƒ…ç»ªç¨³å®šæ€§', score: emotionalStabilityScore, maxScore: 10 },\n    { name: 'å¤–å‘æ€§', score: extraversionScore, maxScore: 10 },\n    { name: 'æ­£èƒ½é‡æ€§', score: positivityScore, maxScore: 10 },\n  ];\n\n  const centerX = 150;\n  const centerY = 150;\n  const maxRadius = 100;\n  \n  const points = traits.map((trait, index) => {\n    const angle = (Math.PI * 2 * index) / traits.length - Math.PI / 2;\n    const ratio = trait.score / trait.maxScore;\n    const x = centerX + Math.cos(angle) * maxRadius * ratio;\n    const y = centerY + Math.sin(angle) * maxRadius * ratio;\n    return { x, y, angle, ratio };\n  });\n\n  const polygonPoints = points.map(p => `${p.x},${p.y}`).join(' ');\n\n  const maxPolygonPoints = traits.map((_, index) => {\n    const angle = (Math.PI * 2 * index) / traits.length - Math.PI / 2;\n    const x = centerX + Math.cos(angle) * maxRadius;\n    const y = centerY + Math.sin(angle) * maxRadius;\n    return `${x},${y}`;\n  }).join(' ');\n\n  const labelPoints = traits.map((trait, index) => {\n    const angle = (Math.PI * 2 * index) / traits.length - Math.PI / 2;\n    const labelRadius = maxRadius + 35;\n    const x = centerX + Math.cos(angle) * labelRadius;\n    const y = centerY + Math.sin(angle) * labelRadius;\n    return { x, y, trait, angle };\n  });\n\n  return (\n    <div className=\"flex items-center justify-center w-full py-4 overflow-visible\">\n      <svg width=\"320\" height=\"320\" viewBox=\"0 0 300 300\" className=\"max-w-full overflow-visible\">\n        <defs>\n          <radialGradient id=\"radarGradient\" cx=\"50%\" cy=\"50%\" r=\"50%\">\n            <stop offset=\"0%\" stopColor=\"hsl(var(--primary))\" stopOpacity=\"0.3\" />\n            <stop offset=\"100%\" stopColor=\"hsl(var(--primary))\" stopOpacity=\"0.05\" />\n          </radialGradient>\n        </defs>\n\n        <polygon\n          points={maxPolygonPoints}\n          fill=\"none\"\n          stroke=\"hsl(var(--border))\"\n          strokeWidth=\"1\"\n          strokeDasharray=\"4,4\"\n        />\n\n        {[0.25, 0.5, 0.75].map((scale) => {\n          const scaledPoints = traits.map((_, index) => {\n            const angle = (Math.PI * 2 * index) / traits.length - Math.PI / 2;\n            const x = centerX + Math.cos(angle) * maxRadius * scale;\n            const y = centerY + Math.sin(angle) * maxRadius * scale;\n            return `${x},${y}`;\n          }).join(' ');\n          \n          return (\n            <polygon\n              key={scale}\n              points={scaledPoints}\n              fill=\"none\"\n              stroke=\"hsl(var(--border))\"\n              strokeWidth=\"0.5\"\n              opacity=\"0.3\"\n            />\n          );\n        })}\n\n        {traits.map((_, index) => {\n          const angle = (Math.PI * 2 * index) / traits.length - Math.PI / 2;\n          const x = centerX + Math.cos(angle) * maxRadius;\n          const y = centerY + Math.sin(angle) * maxRadius;\n          return (\n            <line\n              key={index}\n              x1={centerX}\n              y1={centerY}\n              x2={x}\n              y2={y}\n              stroke=\"hsl(var(--border))\"\n              strokeWidth=\"0.5\"\n              opacity=\"0.3\"\n            />\n          );\n        })}\n\n        <polygon\n          points={polygonPoints}\n          fill=\"url(#radarGradient)\"\n          stroke=\"hsl(var(--primary))\"\n          strokeWidth=\"2\"\n        />\n\n        {points.map((point, index) => (\n          <circle\n            key={index}\n            cx={point.x}\n            cy={point.y}\n            r=\"4\"\n            fill=\"hsl(var(--primary))\"\n          />\n        ))}\n\n        {labelPoints.map((label, index) => {\n          let textAnchor: \"start\" | \"middle\" | \"end\" = \"middle\";\n          let dy = \"0.35em\";\n          \n          const angle = label.angle;\n          \n          if (angle > -Math.PI/3 && angle < Math.PI/3) {\n            textAnchor = \"start\";\n          } else if (angle > Math.PI*2/3 || angle < -Math.PI*2/3) {\n            textAnchor = \"end\";\n          }\n          \n          if (angle < -Math.PI * 0.6 || angle > Math.PI * 0.6) {\n            dy = \"1em\";\n          } else if (angle > -Math.PI * 0.4 && angle < Math.PI * 0.4) {\n            dy = \"-0.3em\";\n          }\n\n          return (\n            <text\n              key={index}\n              x={label.x}\n              y={label.y}\n              textAnchor={textAnchor}\n              dy={dy}\n              className=\"text-[11px] font-medium fill-foreground\"\n              style={{ userSelect: 'none' }}\n            >\n              {label.trait.name}\n            </text>\n          );\n        })}\n      </svg>\n    </div>\n  );\n}\n","size_bytes":5193},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"client/src/components/examples/CompactEventCard.tsx":{"content":"import CompactEventCard from '../CompactEventCard';\n\nexport default function CompactEventCardExample() {\n  return (\n    <div className=\"max-w-md p-4\">\n      <CompactEventCard\n        title=\"Sunday Coffee & Conversations\"\n        date=\"Oct 15\"\n        time=\"10:00 AM\"\n        location=\"Bean & Brew Cafe, Downtown\"\n        attendees={[\n          { name: \"Sarah J\", initials: \"SJ\" },\n          { name: \"Mike C\", initials: \"MC\" },\n          { name: \"Emma D\", initials: \"ED\" }\n        ]}\n        spotsLeft={3}\n        matchScore={92}\n        imageGradient=\"from-amber-400 via-orange-500 to-pink-500\"\n      />\n    </div>\n  );\n}\n","size_bytes":622},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","size_bytes":1904},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1592},"client/src/components/Footer.tsx":{"content":"import { Sparkles } from \"lucide-react\";\n\nexport default function Footer() {\n  return (\n    <footer className=\"border-t bg-muted/30\">\n      <div className=\"container mx-auto px-4 py-12\">\n        <div className=\"grid md:grid-cols-4 gap-8\">\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-2\">\n              <Sparkles className=\"h-5 w-5 text-primary\" />\n              <span className=\"text-lg font-display font-bold\">Vibe</span>\n            </div>\n            <p className=\"text-sm text-muted-foreground\">\n              Connecting like-minded locals through curated micro-events.\n            </p>\n          </div>\n\n          <div>\n            <h4 className=\"font-semibold mb-3\">Product</h4>\n            <ul className=\"space-y-2 text-sm text-muted-foreground\">\n              <li><a href=\"#\" className=\"hover:text-foreground transition-colors\">Features</a></li>\n              <li><a href=\"#\" className=\"hover:text-foreground transition-colors\">How It Works</a></li>\n              <li><a href=\"#\" className=\"hover:text-foreground transition-colors\">Pricing</a></li>\n              <li><a href=\"#\" className=\"hover:text-foreground transition-colors\">FAQ</a></li>\n            </ul>\n          </div>\n\n          <div>\n            <h4 className=\"font-semibold mb-3\">Company</h4>\n            <ul className=\"space-y-2 text-sm text-muted-foreground\">\n              <li><a href=\"#\" className=\"hover:text-foreground transition-colors\">About</a></li>\n              <li><a href=\"#\" className=\"hover:text-foreground transition-colors\">Blog</a></li>\n              <li><a href=\"#\" className=\"hover:text-foreground transition-colors\">Careers</a></li>\n              <li><a href=\"#\" className=\"hover:text-foreground transition-colors\">Contact</a></li>\n            </ul>\n          </div>\n\n          <div>\n            <h4 className=\"font-semibold mb-3\">Legal</h4>\n            <ul className=\"space-y-2 text-sm text-muted-foreground\">\n              <li><a href=\"#\" className=\"hover:text-foreground transition-colors\">Privacy</a></li>\n              <li><a href=\"#\" className=\"hover:text-foreground transition-colors\">Terms</a></li>\n              <li><a href=\"#\" className=\"hover:text-foreground transition-colors\">Safety</a></li>\n              <li><a href=\"#\" className=\"hover:text-foreground transition-colors\">Community Guidelines</a></li>\n            </ul>\n          </div>\n        </div>\n\n        <div className=\"border-t mt-8 pt-8 text-center text-sm text-muted-foreground\">\n          <p>Â© 2025 Vibe. All rights reserved.</p>\n        </div>\n      </div>\n    </footer>\n  );\n}\n","size_bytes":2591},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/components/DiscountCouponCard.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Sparkles, Clock } from \"lucide-react\";\n\ninterface DiscountCouponCardProps {\n  discount: number;\n  reason: string;\n  expiresIn?: string;\n}\n\nexport default function DiscountCouponCard({ discount, reason, expiresIn }: DiscountCouponCardProps) {\n  return (\n    <Card className=\"border-0 bg-gradient-to-r from-primary/10 via-primary/5 to-transparent overflow-hidden\">\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-start justify-between gap-3\">\n          <div className=\"flex-1 space-y-2\">\n            <div className=\"flex items-center gap-2\">\n              <Sparkles className=\"h-4 w-4 text-primary\" />\n              <span className=\"font-semibold text-sm\">èƒ½é‡å¥–åŠ±</span>\n            </div>\n            <p className=\"text-xs text-muted-foreground\">{reason}</p>\n            {expiresIn && (\n              <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n                <Clock className=\"h-3 w-3\" />\n                <span>{expiresIn}å†…æœ‰æ•ˆ</span>\n              </div>\n            )}\n          </div>\n          <Badge className=\"bg-primary text-primary-foreground text-lg font-bold px-3 py-1\">\n            -{discount}%\n          </Badge>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":1355},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5741},"client/src/components/examples/AttendeeAvatars.tsx":{"content":"import AttendeeAvatars from '../AttendeeAvatars';\n\nexport default function AttendeeAvatarsExample() {\n  const attendees = [\n    { name: \"Sarah Johnson\", initials: \"SJ\" },\n    { name: \"Michael Chen\", initials: \"MC\" },\n    { name: \"Emma Davis\", initials: \"ED\" },\n    { name: \"Alex Rivera\", initials: \"AR\" },\n    { name: \"Jamie Lee\", initials: \"JL\" },\n    { name: \"Taylor Kim\", initials: \"TK\" }\n  ];\n\n  return <AttendeeAvatars attendees={attendees} maxDisplay={4} />;\n}\n","size_bytes":467},"client/src/components/EventFeed.tsx":{"content":"import EventCard from \"./EventCard\";\nimport { Coffee, Music, Gamepad2, Palette, BookOpen, Dumbbell } from \"lucide-react\";\n\n//todo: remove mock functionality\nconst mockEvents = [\n  {\n    title: \"Sunday Coffee & Conversations\",\n    date: \"Oct 15\",\n    time: \"10:00 AM\",\n    location: \"Bean & Brew Cafe, Downtown\",\n    vibes: [\n      { label: \"Chill Vibes\", icon: Coffee },\n      { label: \"Deep Talks\" },\n      { label: \"Introverts Welcome\" }\n    ],\n    attendees: [\n      { name: \"Sarah J\", initials: \"SJ\" },\n      { name: \"Mike C\", initials: \"MC\" },\n      { name: \"Emma D\", initials: \"ED\" },\n      { name: \"Alex R\", initials: \"AR\" }\n    ],\n    spotsLeft: 3,\n    matchScore: 92,\n    matchReason: \"Love coffee chats + introverted energy + weekend mornings\",\n    imageGradient: \"from-amber-400 via-orange-500 to-pink-500\"\n  },\n  {\n    title: \"Indie Music Night\",\n    date: \"Oct 18\",\n    time: \"7:30 PM\",\n    location: \"The Velvet Room\",\n    vibes: [\n      { label: \"Music Lovers\", icon: Music },\n      { label: \"Creative Vibes\" },\n      { label: \"Night Owls\" }\n    ],\n    attendees: [\n      { name: \"Jordan K\", initials: \"JK\" },\n      { name: \"Sam P\", initials: \"SP\" },\n      { name: \"Casey L\", initials: \"CL\" },\n      { name: \"Riley M\", initials: \"RM\" },\n      { name: \"Morgan F\", initials: \"MF\" }\n    ],\n    spotsLeft: 2,\n    matchScore: 88,\n    matchReason: \"Indie music fan + evening availability + creative energy\",\n    imageGradient: \"from-violet-500 via-purple-500 to-fuchsia-500\"\n  },\n  {\n    title: \"Board Game Brunch\",\n    date: \"Oct 20\",\n    time: \"11:00 AM\",\n    location: \"Game Haven Cafe\",\n    vibes: [\n      { label: \"Board Games\", icon: Gamepad2 },\n      { label: \"Casual Fun\" },\n      { label: \"Foodie Friendly\" }\n    ],\n    attendees: [\n      { name: \"Taylor W\", initials: \"TW\" },\n      { name: \"Jamie H\", initials: \"JH\" },\n      { name: \"Quinn R\", initials: \"QR\" }\n    ],\n    spotsLeft: 4,\n    matchScore: 85,\n    matchReason: \"Strategy games + brunch lover + balanced social energy\",\n    imageGradient: \"from-emerald-400 via-teal-500 to-cyan-500\"\n  },\n  {\n    title: \"Art Gallery Walking Tour\",\n    date: \"Oct 22\",\n    time: \"2:00 PM\",\n    location: \"Downtown Arts District\",\n    vibes: [\n      { label: \"Art & Culture\", icon: Palette },\n      { label: \"Thoughtful Minds\" },\n      { label: \"Afternoon Vibes\" }\n    ],\n    attendees: [\n      { name: \"Avery B\", initials: \"AB\" },\n      { name: \"Blake N\", initials: \"BN\" },\n      { name: \"Drew S\", initials: \"DS\" },\n      { name: \"Finley T\", initials: \"FT\" }\n    ],\n    spotsLeft: 3,\n    matchScore: 90,\n    matchReason: \"Art appreciation + curious mindset + weekend afternoons\",\n    imageGradient: \"from-rose-400 via-pink-500 to-purple-500\"\n  },\n  {\n    title: \"Book Club & Tea\",\n    date: \"Oct 24\",\n    time: \"4:00 PM\",\n    location: \"Cozy Corner Bookshop\",\n    vibes: [\n      { label: \"Book Lovers\", icon: BookOpen },\n      { label: \"Quiet Gathering\" },\n      { label: \"Tea Enthusiasts\" }\n    ],\n    attendees: [\n      { name: \"Harper L\", initials: \"HL\" },\n      { name: \"Sage M\", initials: \"SM\" },\n      { name: \"River P\", initials: \"RP\" }\n    ],\n    spotsLeft: 5,\n    matchScore: 87,\n    matchReason: \"Fiction reader + cozy settings + intellectual conversations\",\n    imageGradient: \"from-amber-300 via-yellow-400 to-orange-400\"\n  },\n  {\n    title: \"Morning Yoga & Smoothies\",\n    date: \"Oct 25\",\n    time: \"8:00 AM\",\n    location: \"Sunrise Wellness Studio\",\n    vibes: [\n      { label: \"Fitness\", icon: Dumbbell },\n      { label: \"Wellness\" },\n      { label: \"Early Birds\" }\n    ],\n    attendees: [\n      { name: \"Phoenix K\", initials: \"PK\" },\n      { name: \"Skylar J\", initials: \"SJ\" },\n      { name: \"Rowan D\", initials: \"RD\" },\n      { name: \"Kai W\", initials: \"KW\" }\n    ],\n    spotsLeft: 2,\n    matchScore: 83,\n    matchReason: \"Wellness focus + morning person + balanced lifestyle\",\n    imageGradient: \"from-lime-400 via-green-500 to-emerald-500\"\n  }\n];\n\nexport default function EventFeed() {\n  return (\n    <section className=\"py-16 bg-muted/30\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"max-w-6xl mx-auto\">\n          <div className=\"text-center mb-12\">\n            <h2 className=\"text-3xl md:text-4xl font-display font-bold mb-4\">\n              Events Picked Just for You\n            </h2>\n            <p className=\"text-lg text-muted-foreground max-w-2xl mx-auto\">\n              Our AI analyzed your vibe profile and found these perfect matches\n            </p>\n          </div>\n\n          <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {mockEvents.map((event, i) => (\n              <EventCard key={i} {...event} />\n            ))}\n          </div>\n        </div>\n      </div>\n    </section>\n  );\n}\n","size_bytes":4730},"client/src/components/AttendeeAvatars.tsx":{"content":"import { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\n\ninterface Attendee {\n  name: string;\n  initials: string;\n}\n\ninterface AttendeeAvatarsProps {\n  attendees: Attendee[];\n  maxDisplay?: number;\n}\n\nexport default function AttendeeAvatars({ attendees, maxDisplay = 4 }: AttendeeAvatarsProps) {\n  const displayedAttendees = attendees.slice(0, maxDisplay);\n  const remainingCount = attendees.length - maxDisplay;\n\n  return (\n    <div className=\"flex items-center\">\n      <div className=\"flex -space-x-2\">\n        {displayedAttendees.map((attendee, i) => (\n          <Avatar key={i} className=\"h-8 w-8 border-2 border-background\">\n            <AvatarFallback className=\"text-xs bg-primary/10 text-primary\">\n              {attendee.initials}\n            </AvatarFallback>\n          </Avatar>\n        ))}\n        {remainingCount > 0 && (\n          <Avatar className=\"h-8 w-8 border-2 border-background\">\n            <AvatarFallback className=\"text-xs bg-muted text-muted-foreground\">\n              +{remainingCount}\n            </AvatarFallback>\n          </Avatar>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":1114},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ \n  connectionString: process.env.DATABASE_URL,\n  connectionTimeoutMillis: 10000,\n  idleTimeoutMillis: 30000,\n});\nexport const db = drizzle({ client: pool, schema });\n\n// Warmup database connection on startup to prevent autosuspend issues\nexport async function warmupDatabase() {\n  try {\n    await pool.query('SELECT 1');\n    console.log('Database connection warmed up successfully');\n  } catch (error) {\n    console.error('Database warmup failed:', error);\n    // Try again after a short delay\n    setTimeout(async () => {\n      try {\n        await pool.query('SELECT 1');\n        console.log('Database connection warmed up successfully (retry)');\n      } catch (retryError) {\n        console.error('Database warmup retry failed:', retryError);\n      }\n    }, 2000);\n  }\n}\n","size_bytes":1156},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/components/HowItWorks.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { UserCircle, Sparkles, Calendar, MessageCircle } from \"lucide-react\";\n\nconst steps = [\n  {\n    icon: UserCircle,\n    title: \"Create Your Vibe Profile\",\n    description: \"Take a quick 3-5 minute quiz about your personality, interests, and social preferences.\"\n  },\n  {\n    icon: Sparkles,\n    title: \"Get AI-Matched\",\n    description: \"Our algorithm finds events and people that align with your energy and interests.\"\n  },\n  {\n    icon: Calendar,\n    title: \"Attend Small Events\",\n    description: \"Join curated gatherings with 5-10 like-minded people in safe, welcoming spaces.\"\n  },\n  {\n    icon: MessageCircle,\n    title: \"Build Connections\",\n    description: \"Make meaningful friendships and discover your local community.\"\n  }\n];\n\nexport default function HowItWorks() {\n  return (\n    <section className=\"py-16\" id=\"how-it-works\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"max-w-6xl mx-auto\">\n          <div className=\"text-center mb-12\">\n            <h2 className=\"text-3xl md:text-4xl font-display font-bold mb-4\">\n              How It Works\n            </h2>\n            <p className=\"text-lg text-muted-foreground max-w-2xl mx-auto\">\n              Four simple steps to finding your community\n            </p>\n          </div>\n\n          <div className=\"grid md:grid-cols-2 lg:grid-cols-4 gap-6\">\n            {steps.map((step, i) => (\n              <Card key={i} className=\"relative border-0 bg-card/50\">\n                <CardContent className=\"pt-6\">\n                  <div className=\"absolute -top-4 left-6 h-8 w-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-sm font-bold\">\n                    {i + 1}\n                  </div>\n                  <div className=\"h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center mb-4 mt-2\">\n                    <step.icon className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <h3 className=\"text-lg font-semibold mb-2\">{step.title}</h3>\n                  <p className=\"text-sm text-muted-foreground\">{step.description}</p>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </div>\n    </section>\n  );\n}\n","size_bytes":2280},"server/routes.ts":{"content":"import type { Express, Request } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { setupPhoneAuth, isPhoneAuthenticated } from \"./phoneAuth\";\nimport { paymentService } from \"./paymentService\";\nimport { subscriptionService } from \"./subscriptionService\";\nimport { venueMatchingService } from \"./venueMatchingService\";\nimport { calculateUserMatchScore, matchUsersToGroups, validateWeights, DEFAULT_WEIGHTS, type MatchingWeights } from \"./userMatchingService\";\nimport { broadcastEventStatusChanged, broadcastAdminAction } from \"./eventBroadcast\";\nimport { matchEventPool, saveMatchResults } from \"./poolMatchingService\";\nimport { roleTraits, roleInsights } from \"./archetypeConfig\";\nimport session from \"express-session\";\nimport connectPg from \"connect-pg-simple\";\nimport { updateProfileSchema, updateFullProfileSchema, updatePersonalitySchema, insertChatMessageSchema, insertDirectMessageSchema, insertEventFeedbackSchema, registerUserSchema, interestsTopicsSchema, insertChatReportSchema, insertChatLogSchema, events, eventAttendance, chatMessages, users, directMessageThreads, directMessages, eventPools, eventPoolRegistrations, eventPoolGroups, insertEventPoolSchema, insertEventPoolRegistrationSchema, invitations, invitationUses, matchingThresholds, poolMatchingLogs, type User } from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, or, and, desc, inArray, isNotNull } from \"drizzle-orm\";\n\n// 12ä¸ªç¤¾äº¤æ°›å›´åŸå‹é¢˜ç›®æ˜ å°„è¡¨ï¼ˆä¸å‰ç«¯personalityQuestions.tsä¿æŒä¸€è‡´ï¼‰\nconst roleMapping: Record<string, Record<string, string>> = {\n  \"1\": { \"A\": \"å¼€å¿ƒæŸ¯åŸº\", \"B\": \"æ·¡å®šæµ·è±š\", \"C\": \"éšèº«çŒ«\", \"D\": \"ç»‡ç½‘è››\" },\n  \"2\": { \"A\": \"æœºæ™ºç‹\", \"B\": \"å¤¸å¤¸è±š\", \"C\": \"æš–å¿ƒç†Š\", \"D\": \"æ²‰æ€çŒ«å¤´é¹°\" },\n  \"3\": { \"A\": \"æš–å¿ƒç†Š\", \"B\": \"å¤ªé˜³é¸¡\", \"C\": \"éšèº«çŒ«\", \"D\": \"æ·¡å®šæµ·è±š\" },\n  \"4\": { \"A\": \"çµæ„Ÿç« é±¼\", \"B\": \"æ²‰æ€çŒ«å¤´é¹°\", \"C\": \"ç»‡ç½‘è››\", \"D\": \"å®šå¿ƒå¤§è±¡\" },\n  \"5\": { \"A\": \"å¼€å¿ƒæŸ¯åŸº\", \"B\": \"æ·¡å®šæµ·è±š\", \"C\": \"ç¨³å¦‚é¾Ÿ\", \"D\": \"çµæ„Ÿç« é±¼\" },\n  \"6\": { \"A\": \"ç¨³å¦‚é¾Ÿ\", \"B\": \"å¤¸å¤¸è±š\", \"C\": \"æš–å¿ƒç†Š\", \"D\": \"å®šå¿ƒå¤§è±¡\" },\n  \"7\": { \"A\": \"å¼€å¿ƒæŸ¯åŸº\", \"B\": \"å¤ªé˜³é¸¡\", \"C\": \"æœºæ™ºç‹\", \"D\": \"éšèº«çŒ«\" },\n  \"8\": { \"A\": \"å¤¸å¤¸è±š\", \"B\": \"æ²‰æ€çŒ«å¤´é¹°\", \"C\": \"ç»‡ç½‘è››\", \"D\": \"ç¨³å¦‚é¾Ÿ\" },\n  \"9\": { \"A\": \"å¼€å¿ƒæŸ¯åŸº\", \"B\": \"å¤ªé˜³é¸¡\", \"C\": \"å®šå¿ƒå¤§è±¡\", \"D\": \"éšèº«çŒ«\" },\n  \"10\": { \"A\": \"å¤ªé˜³é¸¡\", \"B\": \"æœºæ™ºç‹\", \"C\": \"çµæ„Ÿç« é±¼\", \"D\": \"å®šå¿ƒå¤§è±¡\" },\n};\n\n// è¡¥æµ‹é¢˜æ˜ å°„è¡¨ï¼ˆID 101-120ï¼‰\nconst supplementaryRoleMapping: Record<string, Record<string, string>> = {\n  \"101\": { \"A\": \"å¼€å¿ƒæŸ¯åŸº\", \"B\": \"å¤ªé˜³é¸¡\" },\n  \"102\": { \"A\": \"å¼€å¿ƒæŸ¯åŸº\", \"B\": \"å¤ªé˜³é¸¡\" },\n  \"103\": { \"A\": \"æ·¡å®šæµ·è±š\", \"B\": \"ç»‡ç½‘è››\" },\n  \"104\": { \"A\": \"æ·¡å®šæµ·è±š\", \"B\": \"ç»‡ç½‘è››\" },\n  \"105\": { \"A\": \"æ²‰æ€çŒ«å¤´é¹°\", \"B\": \"ç¨³å¦‚é¾Ÿ\" },\n  \"106\": { \"A\": \"æ²‰æ€çŒ«å¤´é¹°\", \"B\": \"ç¨³å¦‚é¾Ÿ\" },\n  \"107\": { \"A\": \"æœºæ™ºç‹\", \"B\": \"çµæ„Ÿç« é±¼\" },\n  \"108\": { \"A\": \"æœºæ™ºç‹\", \"B\": \"çµæ„Ÿç« é±¼\" },\n  \"109\": { \"A\": \"æš–å¿ƒç†Š\", \"B\": \"å¤¸å¤¸è±š\" },\n  \"110\": { \"A\": \"æš–å¿ƒç†Š\", \"B\": \"å¤¸å¤¸è±š\" },\n  \"111\": { \"A\": \"å®šå¿ƒå¤§è±¡\", \"B\": \"æ·¡å®šæµ·è±š\" },\n  \"112\": { \"A\": \"å®šå¿ƒå¤§è±¡\", \"B\": \"æ·¡å®šæµ·è±š\" },\n  \"113\": { \"A\": \"éšèº«çŒ«\", \"B\": \"ç¨³å¦‚é¾Ÿ\" },\n  \"114\": { \"A\": \"éšèº«çŒ«\", \"B\": \"ç¨³å¦‚é¾Ÿ\" },\n  \"115\": { \"A\": \"å¼€å¿ƒæŸ¯åŸº\", \"B\": \"æœºæ™ºç‹\" },\n  \"116\": { \"A\": \"å¤ªé˜³é¸¡\", \"B\": \"æš–å¿ƒç†Š\" },\n  \"117\": { \"A\": \"ç»‡ç½‘è››\", \"B\": \"æœºæ™ºç‹\" },\n  \"118\": { \"A\": \"çµæ„Ÿç« é±¼\", \"B\": \"æ²‰æ€çŒ«å¤´é¹°\" },\n  \"119\": { \"A\": \"å®šå¿ƒå¤§è±¡\", \"B\": \"ç¨³å¦‚é¾Ÿ\" },\n  \"120\": { \"A\": \"å¤¸å¤¸è±š\", \"B\": \"å¤ªé˜³é¸¡\" },\n};\n\nfunction calculateRoleScores(responses: Record<number, any>): Record<string, number> {\n  const scores: Record<string, number> = {\n    \"å¼€å¿ƒæŸ¯åŸº\": 0,\n    \"å¤ªé˜³é¸¡\": 0,\n    \"å¤¸å¤¸è±š\": 0,\n    \"æœºæ™ºç‹\": 0,\n    \"æ·¡å®šæµ·è±š\": 0,\n    \"ç»‡ç½‘è››\": 0,\n    \"æš–å¿ƒç†Š\": 0,\n    \"çµæ„Ÿç« é±¼\": 0,\n    \"æ²‰æ€çŒ«å¤´é¹°\": 0,\n    \"å®šå¿ƒå¤§è±¡\": 0,\n    \"ç¨³å¦‚é¾Ÿ\": 0,\n    \"éšèº«çŒ«\": 0,\n  };\n\n  Object.entries(responses).forEach(([questionId, answer]) => {\n    // Determine which mapping to use based on question ID\n    const qId = parseInt(questionId);\n    const mapping = qId >= 101 ? supplementaryRoleMapping[questionId] : roleMapping[questionId];\n    \n    if (!mapping) return;\n\n    if (answer.type === \"single\") {\n      const role = mapping[answer.value];\n      if (role) {\n        scores[role] = (scores[role] || 0) + 2;\n      }\n    } else if (answer.type === \"dual\") {\n      const mostLikeRole = mapping[answer.mostLike];\n      const secondLikeRole = mapping[answer.secondLike];\n      if (mostLikeRole) {\n        scores[mostLikeRole] = (scores[mostLikeRole] || 0) + 2;\n      }\n      if (secondLikeRole) {\n        scores[secondLikeRole] = (scores[secondLikeRole] || 0) + 1;\n      }\n    }\n  });\n\n  return scores;\n}\n\nfunction determineSubtype(primaryRole: string, responses: Record<number, any>): string {\n  // 12ä¸ªåŸå‹çš„åŠŸèƒ½æ˜µç§°ï¼ˆç›´æ¥ä½¿ç”¨æ ¸å¿ƒå®šä½ï¼‰\n  const nicknames: Record<string, string> = {\n    \"å¼€å¿ƒæŸ¯åŸº\": \"æ‘‡å°¾ç‚¹ç«å®˜\",\n    \"å¤ªé˜³é¸¡\": \"å’¯å’¯å°å¤ªé˜³\",\n    \"å¤¸å¤¸è±š\": \"æŒå£°å‘åŠ¨æœº\",\n    \"æœºæ™ºç‹\": \"å··å£å¯†æ¢\",\n    \"æ·¡å®šæµ·è±š\": \"æ°”æ°›å†²æµªæ‰‹\",\n    \"ç»‡ç½‘è››\": \"å…³ç³»ç»‡ç½‘å¸ˆ\",\n    \"æš–å¿ƒç†Š\": \"æ€€æŠ±æ•…äº‹ç†Š\",\n    \"çµæ„Ÿç« é±¼\": \"è„‘æ´å–·å¢¨ç« \",\n    \"æ²‰æ€çŒ«å¤´é¹°\": \"æ¨é•œæ€è€ƒå®˜\",\n    \"å®šå¿ƒå¤§è±¡\": \"è±¡é¼»å®šå¿ƒé”š\",\n    \"ç¨³å¦‚é¾Ÿ\": \"æ…¢è¯­çœŸçŸ¥é¾Ÿ\",\n    \"éšèº«çŒ«\": \"å®‰é™ä¼´ä¼´çŒ«\",\n  };\n\n  return nicknames[primaryRole] || \"\";\n}\n\nfunction calculateTraitScores(primaryRole: string, secondaryRole: string | null): {\n  affinityScore: number;\n  opennessScore: number;\n  conscientiousnessScore: number;\n  emotionalStabilityScore: number;\n  extraversionScore: number;\n  positivityScore: number;\n} {\n  // Use imported roleTraits from archetypeConfig.ts\n  const primary = roleTraits[primaryRole] || roleTraits[\"æ·¡å®šæµ·è±š\"]; // Default to æ·¡å®šæµ·è±š\n  const secondary = secondaryRole ? roleTraits[secondaryRole] : null;\n\n  // Blend primary and secondary (70% primary, 30% secondary)\n  const blend = (p: number, s: number | null) => {\n    if (s === null) return p;\n    return Math.round(p * 0.7 + s * 0.3);\n  };\n\n  return {\n    affinityScore: blend(primary.affinity, secondary?.affinity || null),\n    opennessScore: blend(primary.openness, secondary?.openness || null),\n    conscientiousnessScore: blend(primary.conscientiousness, secondary?.conscientiousness || null),\n    emotionalStabilityScore: blend(primary.emotionalStability, secondary?.emotionalStability || null),\n    extraversionScore: blend(primary.extraversion, secondary?.extraversion || null),\n    positivityScore: blend(primary.positivity, secondary?.positivity || null),\n  };\n}\n\nfunction generateInsights(primaryRole: string, secondaryRole: string | null): {\n  strengths: string;\n  challenges: string;\n  idealFriendTypes: string[];\n} {\n  // Use imported roleInsights from archetypeConfig.ts\n  return roleInsights[primaryRole] || roleInsights[\"æ·¡å®šæµ·è±š\"]; // Default to æ·¡å®šæµ·è±š\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Session middleware\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: true,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  \n  app.use(session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: process.env.NODE_ENV === 'production',\n      maxAge: sessionTtl,\n      sameSite: 'lax',\n    },\n  }));\n\n  // Phone auth setup\n  setupPhoneAuth(app);\n\n  // Admin password login endpoint\n  app.post('/api/auth/admin-login', async (req: any, res) => {\n    try {\n      const { phoneNumber, password } = req.body;\n\n      if (!phoneNumber || !password) {\n        return res.status(400).json({ message: \"Phone number and password are required\" });\n      }\n\n      // Get user by phone number\n      const users = await storage.getUserByPhone(phoneNumber);\n      \n      if (users.length === 0) {\n        return res.status(401).json({ message: \"Invalid credentials\" });\n      }\n\n      const user = users[0];\n\n      // Check if user is admin\n      if (!user.isAdmin) {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n\n      // Check if user has password set\n      if (!user.password) {\n        return res.status(401).json({ message: \"Password not set for this account\" });\n      }\n\n      // Verify password\n      const bcrypt = await import('bcrypt');\n      const isValidPassword = await bcrypt.compare(password, user.password);\n\n      if (!isValidPassword) {\n        return res.status(401).json({ message: \"Invalid credentials\" });\n      }\n\n      // Set session\n      req.session.regenerate((err: any) => {\n        if (err) {\n          console.error(\"Session regeneration error:\", err);\n          return res.status(500).json({ message: \"Login failed\" });\n        }\n\n        req.session.userId = user.id;\n        req.session.save((err: any) => {\n          if (err) {\n            console.error(\"Session save error:\", err);\n            return res.status(500).json({ message: \"Login failed\" });\n          }\n\n          res.json({ \n            message: \"Login successful\",\n            userId: user.id\n          });\n        });\n      });\n    } catch (error) {\n      console.error(\"Error during admin login:\", error);\n      res.status(500).json({ message: \"Login failed\" });\n    }\n  });\n\n  // Auth routes\n  app.get('/api/auth/user', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const user = await storage.getUser(userId);\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n\n  app.post('/api/auth/logout', async (req: any, res) => {\n    try {\n      req.session.destroy((err: any) => {\n        if (err) {\n          console.error(\"Error destroying session:\", err);\n          return res.status(500).json({ message: \"Failed to logout\" });\n        }\n        res.clearCookie('connect.sid');\n        res.json({ message: \"Logged out successfully\" });\n      });\n    } catch (error) {\n      console.error(\"Error during logout:\", error);\n      res.status(500).json({ message: \"Failed to logout\" });\n    }\n  });\n\n  // Profile stats endpoint\n  app.get('/api/profile/stats', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      \n      // Calculate events completed: count completed events the user attended\n      const completedEventsResult = await db\n        .select({ count: eventAttendance.id })\n        .from(eventAttendance)\n        .innerJoin(events, eq(eventAttendance.eventId, events.id))\n        .where(\n          and(\n            eq(eventAttendance.userId, userId),\n            eq(events.status, 'completed')\n          )\n        );\n      \n      const eventsCompleted = completedEventsResult.length || 0;\n      \n      // Calculate connections made: count direct message threads where user is participant\n      const connectionsResult = await db\n        .select({ count: directMessageThreads.id })\n        .from(directMessageThreads)\n        .where(\n          or(\n            eq(directMessageThreads.user1Id, userId),\n            eq(directMessageThreads.user2Id, userId)\n          )\n        );\n      \n      const connectionsMade = connectionsResult.length || 0;\n      \n      res.json({\n        eventsCompleted,\n        connectionsMade,\n      });\n    } catch (error) {\n      console.error(\"Error fetching profile stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch profile stats\" });\n    }\n  });\n\n  // Registration routes\n  app.post('/api/user/register', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      console.log(\"[Backend] Received registration data:\", req.body);\n      const result = registerUserSchema.safeParse(req.body);\n      \n      if (!result.success) {\n        console.error(\"[Backend] Validation failed:\", result.error);\n        return res.status(400).json({ error: result.error });\n      }\n\n      console.log(\"[Backend] Validated data:\", result.data);\n      const user = await storage.registerUser(userId, result.data);\n      console.log(\"[Backend] User updated successfully:\", { id: user.id, displayName: user.displayName, gender: user.gender, birthdate: user.birthdate });\n      \n      res.json(user);\n    } catch (error: any) {\n      console.error(\"Error registering user:\", error);\n      // Return detailed error message for debugging\n      const errorMessage = error?.message || \"Failed to register user\";\n      res.status(500).json({ \n        message: errorMessage,\n        details: process.env.NODE_ENV === 'development' ? error?.stack : undefined \n      });\n    }\n  });\n\n  // Personality test routes\n  \n  // Preliminary scoring - check if supplementary questions are needed\n  app.post('/api/personality-test/preliminary-score', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const { responses } = req.body;\n\n      // Calculate role scores from base 10 questions\n      const roleScores = calculateRoleScores(responses);\n      \n      // Sort roles by score\n      const sortedRoles = Object.entries(roleScores)\n        .sort(([roleA, scoreA], [roleB, scoreB]) => {\n          if (scoreB !== scoreA) return scoreB - scoreA;\n          return roleA.localeCompare(roleB);\n        });\n      \n      const top1 = sortedRoles[0];\n      const top2 = sortedRoles[1];\n      const scoreDiff = top1[1] - top2[1];\n\n      // Threshold for supplementary testing: if top 2 are within 3 points\n      const SUPPLEMENTARY_THRESHOLD = 3;\n\n      if (scoreDiff < SUPPLEMENTARY_THRESHOLD) {\n        // Need supplementary questions\n        res.json({\n          needsSupplementary: true,\n          candidateArchetypes: [\n            { name: top1[0], score: top1[1] },\n            { name: top2[0], score: top2[1] }\n          ],\n          allScores: roleScores,\n        });\n      } else {\n        // Scores are clear enough, return final result\n        const primaryRole = top1[0];\n        const secondaryRole = top2[0];\n        const roleSubtype = determineSubtype(primaryRole, responses);\n        const traitScores = calculateTraitScores(primaryRole, secondaryRole);\n        const insights = generateInsights(primaryRole, secondaryRole);\n\n        res.json({\n          needsSupplementary: false,\n          result: {\n            primaryRole,\n            primaryRoleScore: top1[1],\n            secondaryRole,\n            secondaryRoleScore: top2[1],\n            roleSubtype,\n            ...traitScores,\n            ...insights,\n          },\n        });\n      }\n    } catch (error) {\n      console.error(\"Error in preliminary scoring:\", error);\n      res.status(500).json({ message: \"Failed to calculate preliminary score\" });\n    }\n  });\n\n  app.post('/api/personality-test/submit', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const { responses } = req.body;\n\n      // Calculate role scores\n      const roleScores = calculateRoleScores(responses);\n      \n      // Determine primary and secondary roles\n      // Sort by score DESC, then by role name ASC for stability when scores are equal\n      const sortedRoles = Object.entries(roleScores)\n        .sort(([roleA, scoreA], [roleB, scoreB]) => {\n          if (scoreB !== scoreA) return scoreB - scoreA;  // Higher score first\n          return roleA.localeCompare(roleB);  // Stable sort by name when scores equal\n        });\n      \n      const primaryRole = sortedRoles[0][0];\n      const primaryRoleScore = sortedRoles[0][1];\n      const secondaryRole = sortedRoles[1]?.[0] || null;\n      const secondaryRoleScore = sortedRoles[1]?.[1] || 0;\n\n      // Determine subtype (simplified - based on highest scoring items)\n      const roleSubtype = determineSubtype(primaryRole, responses);\n\n      // Calculate six-dimensional trait scores\n      const traitScores = calculateTraitScores(primaryRole, secondaryRole);\n\n      // Generate insights\n      const insights = generateInsights(primaryRole, secondaryRole);\n\n      // Save responses and result\n      await storage.saveTestResponses(userId, responses);\n      const roleResult = await storage.saveRoleResult(userId, {\n        userId,\n        primaryRole,\n        primaryRoleScore,\n        secondaryRole,\n        secondaryRoleScore,\n        roleSubtype,\n        roleScores,\n        ...traitScores,\n        ...insights,\n        testVersion: 1,\n      });\n\n      // Mark personality test as complete\n      await storage.markPersonalityTestComplete(userId);\n\n      res.json(roleResult);\n    } catch (error) {\n      console.error(\"Error submitting personality test:\", error);\n      res.status(500).json({ message: \"Failed to submit personality test\" });\n    }\n  });\n\n  app.get('/api/personality-test/results', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const result = await storage.getRoleResult(userId);\n      \n      if (!result) {\n        return res.status(404).json({ message: \"No test results found\" });\n      }\n\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching test results:\", error);\n      res.status(500).json({ message: \"Failed to fetch test results\" });\n    }\n  });\n\n  // Get personality type distribution stats\n  app.get('/api/personality-test/stats', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const stats = await storage.getPersonalityDistribution();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching personality stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch personality stats\" });\n    }\n  });\n\n  // Get archetype role distribution (percentage of users for each role)\n  app.get('/api/personality/role-distribution', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      // Get all users with personality results\n      const allUsers = await db.select({ primaryRole: users.primaryRole }).from(users).where(isNotNull(users.primaryRole));\n      \n      if (allUsers.length === 0) {\n        // Return default distribution if no users yet\n        const defaultDistribution: Record<string, number> = {\n          'å¼€å¿ƒæŸ¯åŸº': 8,\n          'å¤ªé˜³é¸¡': 9,\n          'å¤¸å¤¸è±š': 8,\n          'æœºæ™ºç‹': 9,\n          'æ·¡å®šæµ·è±š': 8,\n          'ç»‡ç½‘è››': 7,\n          'æš–å¿ƒç†Š': 9,\n          'çµæ„Ÿç« é±¼': 8,\n          'æ²‰æ€çŒ«å¤´é¹°': 7,\n          'å®šå¿ƒå¤§è±¡': 6,\n          'ç¨³å¦‚é¾Ÿ': 5,\n          'éšèº«çŒ«': 6,\n        };\n        return res.json(defaultDistribution);\n      }\n\n      // Count users by primary role\n      const distribution: Record<string, number> = {\n        'å¼€å¿ƒæŸ¯åŸº': 0,\n        'å¤ªé˜³é¸¡': 0,\n        'å¤¸å¤¸è±š': 0,\n        'æœºæ™ºç‹': 0,\n        'æ·¡å®šæµ·è±š': 0,\n        'ç»‡ç½‘è››': 0,\n        'æš–å¿ƒç†Š': 0,\n        'çµæ„Ÿç« é±¼': 0,\n        'æ²‰æ€çŒ«å¤´é¹°': 0,\n        'å®šå¿ƒå¤§è±¡': 0,\n        'ç¨³å¦‚é¾Ÿ': 0,\n        'éšèº«çŒ«': 0,\n      };\n\n      allUsers.forEach((user) => {\n        if (user.primaryRole && distribution.hasOwnProperty(user.primaryRole)) {\n          distribution[user.primaryRole] += 1;\n        }\n      });\n\n      // Convert to percentages\n      const total = allUsers.length;\n      const percentages: Record<string, number> = {};\n      Object.keys(distribution).forEach((role) => {\n        percentages[role] = Math.round((distribution[role] / total) * 100);\n      });\n\n      res.json(percentages);\n    } catch (error) {\n      console.error(\"Error fetching role distribution:\", error);\n      res.status(500).json({ message: \"Failed to fetch role distribution\" });\n    }\n  });\n\n  // Profile routes\n  app.post('/api/profile/setup', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const result = updateProfileSchema.safeParse(req.body);\n      \n      if (!result.success) {\n        return res.status(400).json({ error: result.error });\n      }\n\n      const user = await storage.updateProfile(userId, result.data);\n      await storage.markProfileSetupComplete(userId);\n      \n      res.json(user);\n    } catch (error) {\n      console.error(\"Error updating profile:\", error);\n      res.status(500).json({ message: \"Failed to update profile\" });\n    }\n  });\n\n  app.post('/api/user/interests-topics', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const result = interestsTopicsSchema.safeParse(req.body);\n      \n      if (!result.success) {\n        return res.status(400).json({ error: result.error });\n      }\n\n      const user = await storage.updateInterestsTopics(userId, result.data);\n      \n      res.json(user);\n    } catch (error) {\n      console.error(\"Error updating interests and topics:\", error);\n      res.status(500).json({ message: \"Failed to update interests and topics\" });\n    }\n  });\n\n  app.post('/api/profile/personality', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const result = updatePersonalitySchema.safeParse(req.body);\n      \n      if (!result.success) {\n        return res.status(400).json({ error: result.error });\n      }\n\n      const user = await storage.updatePersonality(userId, result.data);\n      \n      res.json(user);\n    } catch (error) {\n      console.error(\"Error updating personality:\", error);\n      res.status(500).json({ message: \"Failed to update personality\" });\n    }\n  });\n\n  // Update full profile (for editing in profile page)\n  app.patch('/api/profile', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const result = updateFullProfileSchema.safeParse(req.body);\n      \n      if (!result.success) {\n        return res.status(400).json({ error: result.error });\n      }\n\n      const user = await storage.updateFullProfile(userId, result.data);\n      \n      res.json(user);\n    } catch (error) {\n      console.error(\"Error updating full profile:\", error);\n      res.status(500).json({ message: \"Failed to update profile\" });\n    }\n  });\n\n  // Event routes\n  app.get('/api/events/joined', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const events = await storage.getUserJoinedEvents(userId);\n      res.json(events);\n    } catch (error) {\n      console.error(\"Error fetching joined events:\", error);\n      res.status(500).json({ message: \"Failed to fetch joined events\" });\n    }\n  });\n\n  app.get('/api/events/:eventId/participants', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const { eventId } = req.params;\n      const participants = await storage.getEventParticipants(eventId);\n      res.json(participants);\n    } catch (error) {\n      console.error(\"Error fetching event participants:\", error);\n      res.status(500).json({ message: \"Failed to fetch event participants\" });\n    }\n  });\n\n  // Chat routes (group chat opens 24 hours before event)\n  app.get('/api/events/:eventId/messages', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const { eventId } = req.params;\n      \n      // Try to get event from events table first (for demo/regular events)\n      const [event] = await db.select().from(events).where(eq(events.id, eventId));\n      \n      // If not found in events table, try blindBoxEvents table\n      let eventDateTime = event?.dateTime;\n      if (!event) {\n        const blindBoxEvent = await storage.getBlindBoxEventById(eventId, userId);\n        if (!blindBoxEvent) {\n          return res.status(404).json({ message: \"Event not found\" });\n        }\n        eventDateTime = blindBoxEvent.dateTime;\n      }\n\n      // Check if group chat is open (24 hours before event OR event has passed)\n      const now = new Date();\n      const eventTime = new Date(eventDateTime);\n      const hoursUntilEvent = (eventTime.getTime() - now.getTime()) / (1000 * 60 * 60);\n      // Chat unlocks 24 hours before event, and remains accessible after event completes\n      const chatUnlocked = hoursUntilEvent <= 24;\n\n      if (!chatUnlocked) {\n        return res.json({\n          chatUnlocked: false,\n          hoursUntilUnlock: Math.max(0, hoursUntilEvent - 24),\n          messages: [],\n        });\n      }\n\n      const messages = await storage.getEventMessages(eventId);\n      res.json({\n        chatUnlocked: true,\n        hoursUntilUnlock: 0,\n        messages,\n      });\n    } catch (error) {\n      console.error(\"Error fetching messages:\", error);\n      res.status(500).json({ message: \"Failed to fetch messages\" });\n    }\n  });\n\n  app.post('/api/events/:eventId/messages', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const { eventId } = req.params;\n      \n      // Try to get event from events table first (for demo/regular events)\n      const [event] = await db.select().from(events).where(eq(events.id, eventId));\n      \n      // If not found in events table, try blindBoxEvents table\n      let eventDateTime = event?.dateTime;\n      if (!event) {\n        const blindBoxEvent = await storage.getBlindBoxEventById(eventId, userId);\n        if (!blindBoxEvent) {\n          return res.status(404).json({ message: \"Event not found\" });\n        }\n        eventDateTime = blindBoxEvent.dateTime;\n      }\n\n      // Check if group chat is open (24 hours before event OR event has passed)\n      const now = new Date();\n      const eventTime = new Date(eventDateTime);\n      const hoursUntilEvent = (eventTime.getTime() - now.getTime()) / (1000 * 60 * 60);\n      // Chat unlocks 24 hours before event, and remains accessible after event completes\n      const chatUnlocked = hoursUntilEvent <= 24;\n\n      if (!chatUnlocked) {\n        return res.status(403).json({ \n          message: \"ç¾¤èŠå°†åœ¨æ´»åŠ¨å¼€å§‹å‰24å°æ—¶å¼€æ”¾\",\n          hoursUntilUnlock: Math.max(0, hoursUntilEvent - 24),\n        });\n      }\n\n      const result = insertChatMessageSchema.safeParse({\n        ...req.body,\n        eventId,\n      });\n      \n      if (!result.success) {\n        return res.status(400).json({ error: result.error });\n      }\n\n      const message = await storage.createChatMessage(userId, result.data);\n      res.json(message);\n    } catch (error) {\n      console.error(\"Error creating message:\", error);\n      res.status(500).json({ message: \"Failed to create message\" });\n    }\n  });\n\n  // Direct message routes (1-on-1 chats unlocked via mutual matching)\n  app.get('/api/direct-messages', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const threads = await storage.getUserDirectMessageThreads(userId);\n      res.json(threads);\n    } catch (error) {\n      console.error(\"Error fetching direct message threads:\", error);\n      res.status(500).json({ message: \"Failed to fetch direct message threads\" });\n    }\n  });\n\n  app.get('/api/direct-messages/:threadId', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const { threadId } = req.params;\n      const messages = await storage.getThreadMessages(threadId);\n      res.json(messages);\n    } catch (error) {\n      console.error(\"Error fetching thread messages:\", error);\n      res.status(500).json({ message: \"Failed to fetch thread messages\" });\n    }\n  });\n\n  app.post('/api/direct-messages/:threadId', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const { threadId } = req.params;\n      const result = insertDirectMessageSchema.safeParse({\n        ...req.body,\n        threadId,\n      });\n      \n      if (!result.success) {\n        return res.status(400).json({ error: result.error });\n      }\n\n      const message = await storage.sendDirectMessage(userId, result.data);\n      res.json(message);\n    } catch (error) {\n      console.error(\"Error sending direct message:\", error);\n      res.status(500).json({ message: \"Failed to send direct message\" });\n    }\n  });\n\n  // Feedback routes\n  app.get('/api/my-feedbacks', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const feedbacks = await storage.getUserAllFeedbacks(userId);\n      res.json(feedbacks);\n    } catch (error) {\n      console.error(\"Error fetching all feedbacks:\", error);\n      res.status(500).json({ message: \"Failed to fetch feedbacks\" });\n    }\n  });\n\n  app.get('/api/events/:eventId/feedback', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const { eventId } = req.params;\n      const feedback = await storage.getUserFeedback(userId, eventId);\n      res.json(feedback);\n    } catch (error) {\n      console.error(\"Error fetching feedback:\", error);\n      res.status(500).json({ message: \"Failed to fetch feedback\" });\n    }\n  });\n\n  app.post('/api/events/:eventId/feedback', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const { eventId } = req.params;\n      const result = insertEventFeedbackSchema.safeParse({\n        ...req.body,\n        eventId,\n      });\n      \n      if (!result.success) {\n        return res.status(400).json({ error: result.error });\n      }\n\n      // Award points for completing feedback\n      const feedback = await storage.createEventFeedback(userId, result.data);\n      \n      // Check for mutual matches if user has new connections\n      const mutualMatches: string[] = [];\n      if (feedback.hasNewConnections && feedback.connections && feedback.connections.length > 0) {\n        // Get all feedbacks for this event to check for mutual matches\n        const eventFeedbacks = await storage.getEventFeedbacks(eventId);\n        \n        for (const selectedUserId of feedback.connections) {\n          // Find the feedback from the selected user\n          const otherUserFeedback = eventFeedbacks.find(f => f.userId === selectedUserId);\n          \n          // Check if they also selected the current user\n          if (otherUserFeedback?.hasNewConnections && \n              otherUserFeedback.connections && \n              otherUserFeedback.connections.includes(userId)) {\n            mutualMatches.push(selectedUserId);\n            \n            // Create direct message thread if it doesn't exist\n            const existingThread = await storage.findDirectMessageThread(userId, selectedUserId, eventId);\n            if (!existingThread) {\n              await storage.createDirectMessageThread({\n                user1Id: userId,\n                user2Id: selectedUserId,\n                eventId: eventId,\n              });\n              \n              // Send mutual match notifications to both users\n              await storage.createNotification({\n                userId: userId,\n                category: 'chat',\n                type: 'mutual_match',\n                title: 'ğŸ‰ åŒå‘åŒ¹é…æˆåŠŸ',\n                message: `ä½ å’Œå¦ä¸€ä½å‚ä¸è€…äº’ç›¸é€‰æ‹©ï¼Œç°åœ¨å¯ä»¥å¼€å§‹ç§èŠäº†ï¼`,\n                relatedResourceId: eventId,\n              });\n              \n              await storage.createNotification({\n                userId: selectedUserId,\n                category: 'chat',\n                type: 'mutual_match',\n                title: 'ğŸ‰ åŒå‘åŒ¹é…æˆåŠŸ',\n                message: `ä½ å’Œå¦ä¸€ä½å‚ä¸è€…äº’ç›¸é€‰æ‹©ï¼Œç°åœ¨å¯ä»¥å¼€å§‹ç§èŠäº†ï¼`,\n                relatedResourceId: eventId,\n              });\n            }\n          }\n        }\n      }\n      \n      // Note: In a real app, you'd update user points here\n      // await storage.awardFeedbackPoints(userId, 50);\n      \n      res.json({ ...feedback, mutualMatches });\n    } catch (error) {\n      console.error(\"Error creating feedback:\", error);\n      res.status(500).json({ message: \"Failed to create feedback\" });\n    }\n  });\n\n  // Deep feedback route (optional extension)\n  app.post('/api/events/:eventId/feedback/deep', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const { eventId } = req.params;\n      \n      // Get existing feedback\n      const existingFeedback = await storage.getUserFeedback(userId, eventId);\n      \n      if (!existingFeedback) {\n        return res.status(404).json({ message: \"Basic feedback not found. Please complete basic feedback first.\" });\n      }\n\n      // Update with deep feedback data\n      const deepFeedbackData = {\n        hasDeepFeedback: true,\n        matchPointValidation: req.body.matchPointValidation,\n        additionalMatchPoints: req.body.additionalMatchPoints,\n        conversationBalance: req.body.conversationBalance,\n        conversationComfort: req.body.conversationComfort,\n        conversationNotes: req.body.conversationNotes,\n        futurePreferences: req.body.futurePreferences,\n        futurePreferencesOther: req.body.futurePreferencesOther,\n        deepFeedbackCompletedAt: new Date(),\n      };\n\n      const updatedFeedback = await storage.updateEventFeedbackDeep(userId, eventId, deepFeedbackData);\n      res.json(updatedFeedback);\n    } catch (error) {\n      console.error(\"Error updating deep feedback:\", error);\n      res.status(500).json({ message: \"Failed to update deep feedback\" });\n    }\n  });\n\n  // ğŸ¯ DEMO: Seed demonstration events\n  app.post('/api/demo/seed-events', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const { db } = await import(\"./db\");\n      const { blindBoxEvents } = await import(\"@shared/schema\");\n      const { eq } = await import(\"drizzle-orm\");\n      \n      // Check if user already has demo events\n      const existingEvents = await db.select().from(blindBoxEvents).where(eq(blindBoxEvents.userId, userId));\n      const hasMatchedDemo = existingEvents.some(e => e.status === 'matched' && e.restaurantName?.includes('Sushi'));\n      const hasCompletedDemo = existingEvents.some(e => e.status === 'completed' && e.restaurantName?.includes('Tap House'));\n      \n      if (hasMatchedDemo && hasCompletedDemo) {\n        console.log(\"âœ… Demo events already exist for user:\", userId);\n        return res.json({ message: \"Demo events already exist\" });\n      }\n      \n      // Create a matched event (tomorrow evening)\n      const tomorrow = new Date();\n      tomorrow.setDate(tomorrow.getDate() + 1);\n      tomorrow.setHours(19, 0, 0, 0);\n      \n      const matchedEvent = await db.insert(blindBoxEvents).values({\n        userId,\n        title: \"å‘¨å›› 19:00 Â· é¥­å±€\",\n        eventType: \"é¥­å±€\",\n        city: \"é¦™æ¸¯\",\n        district: \"ä¸­ç¯\",\n        dateTime: tomorrow,\n        budgetTier: \"150-250\",\n        selectedLanguages: [\"ç²¤è¯­\", \"æ™®é€šè¯\"],\n        selectedCuisines: [\"æ—¥æœ¬æ–™ç†\", \"ç²¤èœ\"],\n        acceptNearby: true,\n        status: \"matched\",\n        progress: 100,\n        currentParticipants: 5,\n        totalParticipants: 5,\n        maleCount: 2,\n        femaleCount: 3,\n        restaurantName: \"é®¨ä¸€ Sushi Ichi\",\n        restaurantAddress: \"ä¸­ç¯äº‘å’¸è¡—28å·\",\n        cuisineTags: [\"æ—¥æœ¬æ–™ç†\", \"å¯¿å¸\"],\n        matchedAttendees: [\n          { \n            userId: \"demo-1\", \n            displayName: \"å°ç¾\", \n            archetype: \"å¤¸å¤¸è±š\", \n            topInterests: [\"ç¾é£Ÿ\", \"æ—…è¡Œ\", \"è‰ºæœ¯\"], \n            age: 27, \n            birthdate: \"1998-05-15\", \n            industry: \"ç§‘æŠ€\", \n            gender: \"Woman\",\n            educationLevel: \"Master's\",\n            studyLocale: \"Overseas\",\n            seniority: \"Mid\",\n            relationshipStatus: \"Single\",\n            fieldOfStudy: \"è®¡ç®—æœºç§‘å­¦\",\n            hometownRegionCity: \"ä¸Šæµ·\",\n            languagesComfort: [\"æ™®é€šè¯ (Mandarin)\", \"English\", \"ç²¤è¯­ (Cantonese)\"],\n            ageVisible: true,\n            educationVisible: true,\n            industryVisible: true\n          },\n          { \n            userId: \"demo-2\", \n            displayName: \"é˜¿å¼º\", \n            archetype: \"æœºæ™ºç‹\", \n            topInterests: [\"ç¾é£Ÿ\", \"æ‘„å½±\", \"æ—…è¡Œ\"], \n            age: 30, \n            birthdate: \"1995-03-20\", \n            industry: \"è®¾è®¡\",\n            gender: \"Man\",\n            educationLevel: \"Bachelor's\",\n            studyLocale: \"Domestic\",\n            seniority: \"Senior\",\n            relationshipStatus: \"Single\",\n            fieldOfStudy: \"è®¾è®¡\",\n            hometownRegionCity: \"å¹¿å·\",\n            languagesComfort: [\"ç²¤è¯­ (Cantonese)\", \"æ™®é€šè¯ (Mandarin)\"],\n            ageVisible: true,\n            educationVisible: true,\n            industryVisible: true\n          },\n          { \n            userId: \"demo-3\", \n            displayName: \"Lisa\", \n            archetype: \"ç»‡ç½‘è››\", \n            topInterests: [\"ç¾é£Ÿ\", \"è‰ºæœ¯\", \"éŸ³ä¹\"], \n            age: 28, \n            birthdate: \"1997-07-10\", \n            industry: \"é‡‘è\",\n            gender: \"Woman\",\n            educationLevel: \"Master's\",\n            studyLocale: \"Both\",\n            seniority: \"Mid\",\n            relationshipStatus: \"Married/Partnered\",\n            fieldOfStudy: \"é‡‘èå­¦\",\n            hometownRegionCity: \"é¦™æ¸¯\",\n            languagesComfort: [\"English\", \"ç²¤è¯­ (Cantonese)\", \"æ™®é€šè¯ (Mandarin)\"],\n            ageVisible: true,\n            educationVisible: true,\n            industryVisible: true\n          },\n          { \n            userId: \"demo-4\", \n            displayName: \"David\", \n            archetype: \"çµæ„Ÿç« é±¼\", \n            topInterests: [\"ç¾é£Ÿ\", \"éŸ³ä¹\", \"ç”µå½±\"], \n            age: 32, \n            birthdate: \"1993-11-05\", \n            industry: \"åª’ä½“\",\n            gender: \"Man\",\n            educationLevel: \"Master's\",\n            studyLocale: \"Overseas\",\n            seniority: \"Senior\",\n            relationshipStatus: \"Single\",\n            fieldOfStudy: \"ä¼ åª’\",\n            hometownRegionCity: \"åŒ—äº¬\",\n            languagesComfort: [\"æ™®é€šè¯ (Mandarin)\", \"English\"],\n            ageVisible: true,\n            educationVisible: true,\n            industryVisible: true\n          }\n        ],\n        matchExplanation: \"è¿™æ¡Œæ˜¯æ—¥æ–™çˆ±å¥½è€…çš„èšä¼šï¼å¤§å®¶éƒ½å¯¹ç²¾è‡´æ–™ç†å’Œæ–‡åŒ–äº¤æµå……æ»¡çƒ­æƒ…ï¼Œå¹´é¾„ç›¸è¿‘ï¼Œè¯é¢˜å¥‘åˆåº¦é«˜ã€‚\"\n      }).returning();\n      \n      // Create a completed event (last week)\n      const lastWeek = new Date();\n      lastWeek.setDate(lastWeek.getDate() - 7);\n      lastWeek.setHours(20, 0, 0, 0);\n      \n      const completedEvent = await db.insert(blindBoxEvents).values({\n        userId,\n        title: \"å‘¨ä¸‰ 20:00 Â· é…’å±€\",\n        eventType: \"é…’å±€\",\n        city: \"æ·±åœ³\",\n        district: \"å—å±±åŒº\",\n        dateTime: lastWeek,\n        budgetTier: \"200-300\",\n        selectedLanguages: [\"æ™®é€šè¯\", \"è‹±è¯­\"],\n        selectedCuisines: [\"è¥¿é¤\", \"é…’å§\"],\n        acceptNearby: false,\n        status: \"completed\",\n        progress: 100,\n        currentParticipants: 6,\n        totalParticipants: 6,\n        maleCount: 3,\n        femaleCount: 3,\n        restaurantName: \"The Tap House ç²¾é…¿é…’å§\",\n        restaurantAddress: \"å—å±±åŒºæµ·å¾·ä¸‰é“1186å·\",\n        cuisineTags: [\"é…’å§\", \"è¥¿é¤\"],\n        matchedAttendees: [\n          { \n            userId: \"demo-5\", \n            displayName: \"Sarah\", \n            archetype: \"å¤ªé˜³é¸¡\", \n            topInterests: [\"éŸ³ä¹\", \"ç¤¾äº¤\", \"ç¾é£Ÿ\"], \n            age: 29, \n            birthdate: \"1996-04-12\", \n            industry: \"åˆ›ä¸š\",\n            gender: \"Woman\",\n            educationLevel: \"Bachelor's\",\n            studyLocale: \"Overseas\",\n            seniority: \"Founder\",\n            relationshipStatus: \"Single\",\n            fieldOfStudy: \"å¸‚åœºè¥é”€\",\n            hometownRegionCity: \"æ·±åœ³\",\n            languagesComfort: [\"æ™®é€šè¯ (Mandarin)\", \"English\"],\n            ageVisible: true,\n            educationVisible: true,\n            industryVisible: true\n          },\n          { \n            userId: \"demo-6\", \n            displayName: \"Alex\", \n            archetype: \"å¼€å¿ƒæŸ¯åŸº\", \n            topInterests: [\"åˆ›ä¸š\", \"ç§‘æŠ€\", \"é˜…è¯»\"], \n            age: 31, \n            birthdate: \"1994-09-08\", \n            industry: \"äº’è”ç½‘\",\n            gender: \"Man\",\n            educationLevel: \"Master's\",\n            studyLocale: \"Both\",\n            seniority: \"Senior\",\n            relationshipStatus: \"Single\",\n            fieldOfStudy: \"è½¯ä»¶å·¥ç¨‹\",\n            hometownRegionCity: \"æ­å·\",\n            languagesComfort: [\"æ™®é€šè¯ (Mandarin)\", \"English\"],\n            ageVisible: true,\n            educationVisible: true,\n            industryVisible: true\n          },\n          { \n            userId: \"demo-7\", \n            displayName: \"å°çº¢\", \n            archetype: \"æš–å¿ƒç†Š\", \n            topInterests: [\"æ—…è¡Œ\", \"æ‘„å½±\", \"ç¾é£Ÿ\"], \n            age: 28, \n            birthdate: \"1997-02-18\", \n            industry: \"å¸‚åœº\",\n            gender: \"Woman\",\n            educationLevel: \"Bachelor's\",\n            studyLocale: \"Domestic\",\n            seniority: \"Mid\",\n            relationshipStatus: \"Single\",\n            fieldOfStudy: \"å¸‚åœºè¥é”€\",\n            hometownRegionCity: \"æˆéƒ½\",\n            languagesComfort: [\"æ™®é€šè¯ (Mandarin)\"],\n            ageVisible: true,\n            educationVisible: true,\n            industryVisible: true\n          },\n          { \n            userId: \"demo-8\", \n            displayName: \"Tom\", \n            archetype: \"æœºæ™ºç‹\", \n            topInterests: [\"éŸ³ä¹\", \"ç”µå½±\", \"æ—…è¡Œ\"], \n            age: 30, \n            birthdate: \"1995-07-22\", \n            industry: \"è®¾è®¡\",\n            gender: \"Man\",\n            educationLevel: \"Bachelor's\",\n            studyLocale: \"Overseas\",\n            seniority: \"Mid\",\n            relationshipStatus: \"Married/Partnered\",\n            fieldOfStudy: \"è§†è§‰è®¾è®¡\",\n            hometownRegionCity: \"é¦™æ¸¯\",\n            languagesComfort: [\"English\", \"ç²¤è¯­ (Cantonese)\"],\n            ageVisible: true,\n            educationVisible: true,\n            industryVisible: true\n          },\n          { \n            userId: \"demo-9\", \n            displayName: \"Emma\", \n            archetype: \"ç»‡ç½‘è››\", \n            topInterests: [\"è‰ºæœ¯\", \"æ–‡åŒ–\", \"å’–å•¡\"], \n            age: 27, \n            birthdate: \"1998-01-30\", \n            industry: \"å’¨è¯¢\",\n            gender: \"Woman\",\n            educationLevel: \"Master's\",\n            studyLocale: \"Both\",\n            seniority: \"Junior\",\n            relationshipStatus: \"Single\",\n            fieldOfStudy: \"ç®¡ç†å’¨è¯¢\",\n            hometownRegionCity: \"ä¸Šæµ·\",\n            languagesComfort: [\"æ™®é€šè¯ (Mandarin)\", \"English\"],\n            ageVisible: true,\n            educationVisible: true,\n            industryVisible: true\n          }\n        ],\n        matchExplanation: \"è¿™æ˜¯ä¸€åœºåˆ›æ„äººçš„æ·±å¤œèšä¼šï¼ç²¾é…¿å•¤é…’é…ä¸Šæœ‰è¶£çš„çµé­‚ï¼Œå¤§å®¶éƒ½å–œæ¬¢åˆ†äº«æ•…äº‹å’Œåˆ›æ„æƒ³æ³•ã€‚\"\n      }).returning();\n      \n      console.log(\"âœ… Demo events created:\", { matched: matchedEvent[0].id, completed: completedEvent[0].id });\n      \n      res.json({ \n        message: \"Demo events created successfully\",\n        events: {\n          matched: matchedEvent[0],\n          completed: completedEvent[0]\n        }\n      });\n    } catch (error) {\n      console.error(\"Error seeding demo events:\", error);\n      res.status(500).json({ message: \"Failed to seed demo events\" });\n    }\n  });\n\n  // Blind Box Event routes\n  app.get('/api/my-events', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const events = await storage.getUserBlindBoxEvents(userId);\n      res.json(events);\n    } catch (error) {\n      console.error(\"Error fetching blind box events:\", error);\n      res.status(500).json({ message: \"Failed to fetch blind box events\" });\n    }\n  });\n\n  app.post('/api/blind-box-events', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const { date, time, eventType, city, area, budget, acceptNearby, selectedLanguages, selectedTasteIntensity, selectedCuisines, inviteFriends, friendsCount } = req.body;\n      \n      if (!date || !time || !eventType || !area || !budget || budget.length === 0) {\n        return res.status(400).json({ message: \"Missing required fields\" });\n      }\n      \n      const event = await storage.createBlindBoxEvent(userId, {\n        date,\n        time,\n        eventType,\n        city: city || \"æ·±åœ³\",\n        area,\n        budget,\n        acceptNearby,\n        selectedLanguages,\n        selectedTasteIntensity,\n        selectedCuisines,\n        inviteFriends,\n        friendsCount,\n      });\n      \n      res.json(event);\n    } catch (error) {\n      console.error(\"Error creating blind box event:\", error);\n      res.status(500).json({ message: \"Failed to create blind box event\" });\n    }\n  });\n\n  app.get('/api/blind-box-events/:eventId', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const { eventId } = req.params;\n      const event = await storage.getBlindBoxEventById(eventId, userId);\n      \n      if (!event) {\n        return res.status(404).json({ message: \"Event not found\" });\n      }\n      \n      res.json(event);\n    } catch (error) {\n      console.error(\"Error fetching blind box event:\", error);\n      res.status(500).json({ message: \"Failed to fetch blind box event\" });\n    }\n  });\n\n  app.patch('/api/blind-box-events/:eventId', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const { eventId } = req.params;\n      const { budget, acceptNearby, selectedLanguages, selectedTasteIntensity, selectedCuisines } = req.body;\n      \n      const event = await storage.updateBlindBoxEventPreferences(eventId, userId, {\n        budget,\n        acceptNearby,\n        selectedLanguages,\n        selectedTasteIntensity,\n        selectedCuisines,\n      });\n      \n      res.json(event);\n    } catch (error) {\n      console.error(\"Error updating blind box event:\", error);\n      res.status(500).json({ message: \"Failed to update blind box event\" });\n    }\n  });\n\n  app.post('/api/blind-box-events/:eventId/cancel', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const { eventId } = req.params;\n      const event = await storage.cancelBlindBoxEvent(eventId, userId);\n      res.json(event);\n    } catch (error) {\n      console.error(\"Error canceling blind box event:\", error);\n      res.status(500).json({ message: \"Failed to cancel blind box event\" });\n    }\n  });\n\n  // Demo endpoint to set match data for testing\n  app.post('/api/blind-box-events/:eventId/set-demo-match', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const { eventId } = req.params;\n      \n      // Demo matched attendees data with rich hidden attributes for interesting connections\n      const demoMatchedAttendees = [\n        {\n          userId: \"demo1\",\n          displayName: \"Alex\",\n          archetype: \"æœºæ™ºç‹\",\n          topInterests: [\"film_entertainment\", \"travel_exploration\", \"photography\"],\n          age: 29,\n          birthdate: \"1996-03-15\",\n          gender: \"Man\",\n          industry: \"ç§‘æŠ€\",\n          educationLevel: \"Master's\",\n          fieldOfStudy: \"è®¡ç®—æœºç§‘å­¦\",\n          hometownRegionCity: \"åŒ—äº¬\",\n          studyLocale: \"Overseas\",\n          seniority: \"Mid\",\n          relationshipStatus: \"Single\",\n          languagesComfort: [\"æ™®é€šè¯ (Mandarin)\", \"English\"],\n          ageVisible: true,\n          industryVisible: true,\n          educationVisible: true\n        },\n        {\n          userId: \"demo2\",\n          displayName: \"å°æ˜\",\n          archetype: \"æš–å¿ƒç†Š\",\n          topInterests: [\"food_dining\", \"music_concerts\", \"travel_exploration\"],\n          age: 27,\n          birthdate: \"1998-07-20\",\n          gender: \"Man\",\n          industry: \"è‰ºæœ¯\",\n          educationLevel: \"Bachelor's\",\n          fieldOfStudy: \"è§†è§‰è‰ºæœ¯\",\n          hometownRegionCity: \"ä¸Šæµ·\",\n          studyLocale: \"Domestic\",\n          seniority: \"Junior\",\n          relationshipStatus: \"Single\",\n          languagesComfort: [\"æ™®é€šè¯ (Mandarin)\"],\n          ageVisible: true,\n          industryVisible: true,\n          educationVisible: true\n        },\n        {\n          userId: \"demo3\",\n          displayName: \"Sarah\",\n          archetype: \"æ™ºè€…\",\n          topInterests: [\"reading_books\", \"film_entertainment\", \"coffee_tea\"],\n          age: 32,\n          birthdate: \"1993-05-10\",\n          gender: \"Woman\",\n          industry: \"é‡‘è\",\n          educationLevel: \"Master's\",\n          fieldOfStudy: \"é‡‘èå·¥ç¨‹\",\n          hometownRegionCity: \"é¦™æ¸¯\",\n          studyLocale: \"Overseas\",\n          seniority: \"Senior\",\n          relationshipStatus: \"Married/Partnered\",\n          languagesComfort: [\"English\", \"ç²¤è¯­ (Cantonese)\", \"æ™®é€šè¯ (Mandarin)\"],\n          ageVisible: true,\n          industryVisible: true,\n          educationVisible: true\n        },\n        {\n          userId: \"demo4\",\n          displayName: \"æå\",\n          archetype: \"å¤ªé˜³é¸¡\",\n          topInterests: [\"fitness_health\", \"travel_exploration\", \"outdoor_activities\"],\n          age: 28,\n          birthdate: \"1997-09-25\",\n          gender: \"Woman\",\n          industry: \"åŒ»ç–—\",\n          educationLevel: \"Doctorate\",\n          fieldOfStudy: \"ä¸´åºŠåŒ»å­¦\",\n          hometownRegionCity: \"æ·±åœ³\",\n          studyLocale: \"Both\",\n          seniority: \"Mid\",\n          relationshipStatus: \"Single\",\n          languagesComfort: [\"æ™®é€šè¯ (Mandarin)\", \"English\"],\n          ageVisible: true,\n          industryVisible: true,\n          educationVisible: true\n        }\n      ];\n      \n      const demoExplanation = \"è¿™æ¡Œèšé›†äº†å¯¹ç”µå½±ã€æ—…è¡Œå……æ»¡çƒ­æƒ…çš„æœ‹å‹ã€‚æˆ‘ä»¬å¹³è¡¡äº†æœºæ™ºç‹çš„æ¢ç´¢æ–°é²œä¸æš–å¿ƒç†Šçš„æ·±åº¦å€¾å¬ï¼Œç¡®ä¿å¯¹è¯æ—¢çƒ­çƒˆåˆæœ‰æ·±åº¦ã€‚\";\n      \n      const event = await storage.setBlindBoxEventMatchData(eventId, userId, {\n        matchedAttendees: demoMatchedAttendees,\n        matchExplanation: demoExplanation\n      });\n      \n      res.json(event);\n    } catch (error) {\n      console.error(\"Error setting demo match data:\", error);\n      res.status(500).json({ message: \"Failed to set demo match data\" });\n    }\n  });\n\n  // Icebreaker routes - Multi-layered questions for deeper connection\n  const icebreakerQuestions = {\n    // Layer 1: Simple & Lighthearted - Easy entry points\n    lighthearted: [\n      \"ä»Šå¤©ä»€ä¹ˆäº‹è®©ä½ å¾®ç¬‘äº†ï¼Ÿ\",\n      \"æœ¬å‘¨æœ€å¥½çš„æ¶ˆæ¯æ˜¯ä»€ä¹ˆï¼Ÿ\",\n      \"æœ€è¿‘åƒè¿‡æœ€å¥‡æ€ªçš„ä¸€é“èœæ˜¯ä»€ä¹ˆï¼Ÿ\",\n      \"å¦‚æœå¯ä»¥ä»æ—¥å¸¸ç”Ÿæ´»ä¸­å»æ‰ä¸€ä»¶äº‹ï¼Œä½ ä¼šé€‰ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ\",\n      \"å¦‚æœèƒ½ç«‹åˆ»å­¦ä¼šä¸€é¡¹æŠ€èƒ½ï¼Œä½ æƒ³å­¦ä»€ä¹ˆï¼Ÿ\",\n      \"å‘¨æœ«æœ€å–œæ¬¢åšçš„ä¸€ä»¶å°äº‹æ˜¯ä»€ä¹ˆï¼Ÿ\",\n      \"æœ€è¿‘ä»€ä¹ˆäº‹è®©ä½ è§‰å¾—å¾ˆæ²»æ„ˆï¼Ÿ\",\n      \"ä½ çš„ã€Œå¿«ä¹æŒ‰é’®ã€æ˜¯ä»€ä¹ˆï¼Ÿåšä»€ä¹ˆäº‹èƒ½è®©ä½ ç«‹åˆ»å¼€å¿ƒèµ·æ¥ï¼Ÿ\",\n    ],\n    \n    // Layer 2: Passions & Hobbies - Discovering interests\n    passions: [\n      \"ä½ å¯¹ä»€ä¹ˆå……æ»¡çƒ­æƒ…ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ\",\n      \"æœ‰ä»€ä¹ˆçˆ±å¥½æˆ–æ´»åŠ¨æ˜¯ä½ çœŸæ­£äº«å—çš„ï¼Ÿå®ƒå¸å¼•ä½ çš„åœ°æ–¹æ˜¯ä»€ä¹ˆï¼Ÿ\",\n      \"æœ€è¿‘æ²‰è¿·çš„ä¸€é¡¹è¿åŠ¨æˆ–çˆ±å¥½æ˜¯ä»€ä¹ˆï¼Ÿ\",\n      \"æœ‰ä»€ä¹ˆä¸€ç›´æƒ³å°è¯•ä½†è¿˜æ²¡å¼€å§‹çš„äº‹æƒ…ï¼Ÿ\",\n      \"å¦‚æœæœ‰ä¸€æ•´å¤©è‡ªç”±æ—¶é—´ï¼Œä½ ä¼šæ€ä¹ˆåº¦è¿‡ï¼Ÿ\",\n      \"ä½ ä¼šæ¨èåˆ«äººå°è¯•ä»€ä¹ˆçˆ±å¥½æˆ–ä½“éªŒï¼Ÿ\",\n      \"ä»€ä¹ˆäº‹æƒ…ä¼šè®©ä½ å®Œå…¨å¿˜è®°æ—¶é—´ï¼Ÿ\",\n    ],\n    \n    // Layer 3: Travel & Adventures - Shared experiences\n    travel: [\n      \"æœ€éš¾å¿˜çš„ä¸€æ¬¡æ—…è¡Œç»å†æ˜¯ä»€ä¹ˆï¼Ÿ\",\n      \"å¦‚æœå¯ä»¥ç«‹åˆ»å»ä»»ä½•åœ°æ–¹æ—…è¡Œï¼Œä½ ä¼šå»å“ªé‡Œï¼Ÿ\",\n      \"æ—…è¡Œä¸­é‡åˆ°è¿‡ä»€ä¹ˆæ„å¤–çš„æƒŠå–œï¼Ÿ\",\n      \"ä½ æ›´å–œæ¬¢è®¡åˆ’å¥½çš„è¡Œç¨‹ï¼Œè¿˜æ˜¯éšæ€§æ¢ç´¢ï¼Ÿ\",\n      \"æœ‰ä»€ä¹ˆåœ°æ–¹å»äº†ä¹‹åæ”¹å˜äº†ä½ çš„æƒ³æ³•ï¼Ÿ\",\n      \"æ¨èä¸€ä¸ªä½ è§‰å¾—è¢«ä½ä¼°çš„æ—…è¡Œç›®çš„åœ°\",\n      \"ä¸‹ä¸€ä¸ªæœ€æƒ³å»çš„åœ°æ–¹æ˜¯å“ªé‡Œï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ\",\n    ],\n    \n    // Layer 4: Art & Creativity - Cultural connections\n    creativity: [\n      \"æœ€è¿‘æœ‰ä»€ä¹ˆè‰ºæœ¯ä½œå“æˆ–è¡¨æ¼”è®©ä½ å°è±¡æ·±åˆ»ï¼Ÿ\",\n      \"ä½ ä¼šç”¨ä»€ä¹ˆæ–¹å¼è¡¨è¾¾åˆ›æ„ï¼Ÿï¼ˆéŸ³ä¹ã€ç»˜ç”»ã€å†™ä½œç­‰ï¼‰\",\n      \"æœ‰æ²¡æœ‰ç‰¹åˆ«å–œæ¬¢çš„è‰ºæœ¯å®¶æˆ–åˆ›ä½œè€…ï¼Ÿ\",\n      \"å¦‚æœå¯ä»¥æŒæ¡ä¸€é—¨è‰ºæœ¯ï¼Œä½ ä¼šé€‰ä»€ä¹ˆï¼Ÿ\",\n      \"æœ€è¿‘åœ¨è¯»ä»€ä¹ˆä¹¦æˆ–åœ¨çœ‹ä»€ä¹ˆå‰§ï¼Ÿ\",\n      \"æœ‰ä»€ä¹ˆç”µå½±æˆ–éŸ³ä¹æ”¹å˜äº†ä½ çš„çœ‹æ³•ï¼Ÿ\",\n      \"ä½ è§‰å¾—ä»€ä¹ˆæ ·çš„åˆ›ä½œæœ€èƒ½æ‰“åŠ¨äººå¿ƒï¼Ÿ\",\n    ],\n    \n    // Layer 5: Innovation & Technology - Future thinking\n    innovation: [\n      \"ä½ è§‰å¾—ä»€ä¹ˆæŠ€æœ¯ä¼šæ”¹å˜æˆ‘ä»¬çš„æœªæ¥ï¼Ÿ\",\n      \"æœ‰ä»€ä¹ˆæ–°ç§‘æŠ€äº§å“è®©ä½ è§‰å¾—å¾ˆé…·ï¼Ÿ\",\n      \"å¦‚æœèƒ½å‘æ˜ä¸€æ ·ä¸œè¥¿è§£å†³ç”Ÿæ´»ä¸­çš„é—®é¢˜ï¼Œä½ ä¼šå‘æ˜ä»€ä¹ˆï¼Ÿ\",\n      \"ä½ å¯¹AIæœ‰ä»€ä¹ˆçœ‹æ³•ï¼Ÿå®ƒä¼šå¦‚ä½•å½±å“æˆ‘ä»¬çš„ç”Ÿæ´»ï¼Ÿ\",\n      \"æœ€è®©ä½ æœŸå¾…çš„æœªæ¥è¶‹åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ\",\n      \"ç§‘æŠ€è®©ç”Ÿæ´»æ›´å¥½äº†ï¼Œè¿˜æ˜¯æ›´å¤æ‚äº†ï¼Ÿ\",\n    ],\n    \n    // Layer 6: Deeper Personal - Building trust\n    personal: [\n      \"ä»Šæ™šä½ å¯¹è¿™æ¬¡èšä¼šæœ‰ä»€ä¹ˆæœŸå¾…ï¼Ÿ\",\n      \"çŒœçŒœçœ‹ï¼Œå¤§å®¶éƒ½æ˜¯åšä»€ä¹ˆå·¥ä½œçš„ï¼Ÿ\",\n      \"å¦‚æœæ˜å¹´è¦å®ç°ä¸€ä¸ªé‡è¦ç›®æ ‡ï¼Œä¼šæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ\",\n      \"æœ‰ä»€ä¹ˆç»å†å¡‘é€ äº†ç°åœ¨çš„ä½ ï¼Ÿ\",\n      \"å¦‚æœè¦æ•™ä¸€é—¨è¯¾ï¼Œä½ ä¼šæ•™ä»€ä¹ˆï¼Ÿ\",\n      \"ä½ è§‰å¾—è‡ªå·±åœ¨å“ªæ–¹é¢æˆé•¿äº†å¾ˆå¤šï¼Ÿ\",\n      \"æœ€è¿‘å­¦åˆ°çš„æœ€é‡è¦çš„ä¸€è¯¾æ˜¯ä»€ä¹ˆï¼Ÿ\",\n      \"å¦‚æœå¯ä»¥ç»™5å¹´å‰çš„è‡ªå·±ä¸€ä¸ªå»ºè®®ï¼Œä¼šè¯´ä»€ä¹ˆï¼Ÿ\",\n    ],\n    \n    // Layer 7: Values & Beliefs - Deep connection\n    values: [\n      \"æœ‰ä»€ä¹ˆä¿¡å¿µæˆ–ä»·å€¼è§‚å¯¹ä½ å¾ˆé‡è¦ï¼Ÿå®ƒå¦‚ä½•å½±å“ä½ çš„é€‰æ‹©ï¼Ÿ\",\n      \"ä½ è§‰å¾—äººç±»çš„å‘å±•æ–¹å‘æ˜¯åœ¨è¿›æ­¥è¿˜æ˜¯å€’é€€ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ\",\n      \"ä»€ä¹ˆæ ·çš„äº‹æƒ…ä¼šè®©ä½ è§‰å¾—å¾ˆæœ‰æ„ä¹‰ï¼Ÿ\",\n      \"ä½ è§‰å¾—ä»€ä¹ˆå“è´¨åœ¨äººèº«ä¸Šæœ€å¯è´µï¼Ÿ\",\n      \"æœ‰ä»€ä¹ˆåŸåˆ™æ˜¯ä½ ä¸€ç›´åšæŒçš„ï¼Ÿ\",\n      \"ä½ å¸Œæœ›ä¸ºè¿™ä¸ªä¸–ç•Œç•™ä¸‹ä»€ä¹ˆï¼Ÿ\",\n      \"å¯¹ä½ æ¥è¯´ï¼ŒæˆåŠŸæ„å‘³ç€ä»€ä¹ˆï¼Ÿ\",\n    ],\n    \n    // Context-specific: Dining & Local\n    dining: [\n      \"ä»Šå¤©æœ€æƒ³ç‚¹çš„ä¸€é“èœæ˜¯ä»€ä¹ˆï¼Ÿ\",\n      \"æœ‰ä»€ä¹ˆç‰¹åˆ«çš„é¥®é£Ÿåå¥½æˆ–ç¦å¿Œå—ï¼Ÿ\",\n      \"åˆ†äº«ä¸€ä¸ªä½ éš¾å¿˜çš„ç”¨é¤ä½“éªŒ\",\n      \"æœ€è¿‘å‘ç°çš„å¥½åƒçš„åº—é“º\",\n      \"å¦‚æœåªèƒ½é€‰ä¸€ç§èœç³»åƒä¸€è¾ˆå­ï¼Œä¼šé€‰ä»€ä¹ˆï¼Ÿ\",\n    ],\n    \n    city_life: [\n      \"åœ¨è¿™åº§åŸå¸‚æœ€çˆ±çš„ä¸€ä¸ªå°åº—æ˜¯å“ªé‡Œï¼Ÿ\",\n      \"æ¨èä¸€ä¸ªä½ è§‰å¾—è¢«ä½ä¼°çš„åŸå¸‚è§’è½\",\n      \"ä½ æœ€å–œæ¬¢è¿™ä¸ªåŸå¸‚çš„å“ªä¸ªå­£èŠ‚ï¼Ÿ\",\n      \"å¦‚æœè¦å¸¦æœ‹å‹æ¸¸è§ˆï¼Œä¼šå¸¦å»å“ªé‡Œï¼Ÿ\",\n      \"è¿™ä¸ªåŸå¸‚è®©ä½ æœ€æƒŠå–œçš„å‘ç°æ˜¯ä»€ä¹ˆï¼Ÿ\",\n    ],\n  };\n\n  // Category labels for UI display\n  const categoryLabels: Record<string, { name: string, color: string }> = {\n    lighthearted: { name: \"è½»æ¾æ„‰å¿«\", color: \"green\" },\n    passions: { name: \"å…´è¶£çˆ±å¥½\", color: \"blue\" },\n    travel: { name: \"æ—…è¡Œæ¢é™©\", color: \"purple\" },\n    creativity: { name: \"è‰ºæœ¯åˆ›æ„\", color: \"pink\" },\n    innovation: { name: \"åˆ›æ–°ç§‘æŠ€\", color: \"cyan\" },\n    personal: { name: \"ä¸ªäººæˆé•¿\", color: \"orange\" },\n    values: { name: \"å…±åŒä»·å€¼è§‚\", color: \"red\" },\n    dining: { name: \"ç¾é£Ÿè¯é¢˜\", color: \"yellow\" },\n    city_life: { name: \"åŸå¸‚ç”Ÿæ´»\", color: \"teal\" },\n  };\n\n  app.get('/api/icebreakers/random', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const { topic } = req.query;\n      let selectedCategory: string;\n      let questions: string[];\n      \n      if (topic && topic in icebreakerQuestions) {\n        selectedCategory = topic;\n        questions = icebreakerQuestions[topic as keyof typeof icebreakerQuestions];\n      } else {\n        // General: randomly select a category\n        const categories = Object.keys(icebreakerQuestions);\n        selectedCategory = categories[Math.floor(Math.random() * categories.length)];\n        questions = icebreakerQuestions[selectedCategory as keyof typeof icebreakerQuestions];\n      }\n      \n      const randomQuestion = questions[Math.floor(Math.random() * questions.length)];\n      const categoryInfo = categoryLabels[selectedCategory] || { name: \"ç ´å†°é—®é¢˜\", color: \"gray\" };\n      \n      res.json({ \n        question: randomQuestion,\n        category: categoryInfo.name,\n        categoryColor: categoryInfo.color\n      });\n    } catch (error) {\n      console.error(\"Error fetching icebreaker:\", error);\n      res.status(500).json({ message: \"Failed to fetch icebreaker question\" });\n    }\n  });\n\n  // Notification endpoints\n  app.get('/api/notifications/counts', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ message: \"Not authenticated\" });\n      }\n\n      const counts = await storage.getNotificationCounts(userId);\n      res.json(counts);\n    } catch (error) {\n      console.error(\"Error fetching notification counts:\", error);\n      res.status(500).json({ message: \"Failed to fetch notification counts\" });\n    }\n  });\n\n  app.post('/api/notifications/mark-read', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ message: \"Not authenticated\" });\n      }\n\n      const { category } = req.body;\n      if (!category || !['discover', 'activities', 'chat'].includes(category)) {\n        return res.status(400).json({ message: \"Invalid category\" });\n      }\n\n      await storage.markNotificationsAsRead(userId, category);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error marking notifications as read:\", error);\n      res.status(500).json({ message: \"Failed to mark notifications as read\" });\n    }\n  });\n\n  // ============ INVITATION SYSTEM ROUTES ============\n\n  // Helper function to generate unique invitation code\n  function generateInviteCode(): string {\n    return Math.random().toString(36).substring(2, 9);\n  }\n\n  // POST /api/events/:id/create-invitation - Generate invitation link\n  app.post('/api/events/:id/create-invitation', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      const eventId = req.params.id;\n\n      // Verify user owns this event\n      const event = await storage.getBlindBoxEventByIdAndUser(eventId, userId);\n      if (!event) {\n        return res.status(404).json({ message: \"Event not found or access denied\" });\n      }\n\n      // Check if invitation already exists for this user and event\n      const existingInvite = await db.query.invitations.findFirst({\n        where: (invites, { and, eq }) => and(\n          eq(invites.inviterId, userId),\n          eq(invites.eventId, eventId)\n        )\n      });\n\n      if (existingInvite) {\n        return res.json({\n          code: existingInvite.code,\n          inviteLink: `${req.protocol}://${req.get('host')}/invite/${existingInvite.code}`\n        });\n      }\n\n      // Generate unique code\n      let code = generateInviteCode();\n      let attempts = 0;\n      while (attempts < 5) {\n        const existing = await db.query.invitations.findFirst({\n          where: (invites, { eq }) => eq(invites.code, code)\n        });\n        if (!existing) break;\n        code = generateInviteCode();\n        attempts++;\n      }\n\n      // Create invitation record\n      const [invitation] = await db.insert(invitations).values({\n        code,\n        inviterId: userId,\n        eventId,\n        invitationType: event.status === 'matched' ? 'post_match' : 'pre_match',\n        expiresAt: event.dateTime, // Expires when event starts\n      }).returning();\n\n      res.json({\n        code: invitation.code,\n        inviteLink: `${req.protocol}://${req.get('host')}/invite/${invitation.code}`\n      });\n    } catch (error: any) {\n      console.error(\"Error creating invitation:\", error);\n      res.status(500).json({ message: \"Failed to create invitation\" });\n    }\n  });\n\n  // GET /api/invitations/:code - Get invitation details (public, for landing page)\n  app.get('/api/invitations/:code', async (req, res) => {\n    try {\n      const { code } = req.params;\n\n      const [invitation] = await db\n        .select({\n          id: invitations.id,\n          code: invitations.code,\n          inviterId: invitations.inviterId,\n          eventId: invitations.eventId,\n          invitationType: invitations.invitationType,\n          totalClicks: invitations.totalClicks,\n          expiresAt: invitations.expiresAt,\n          createdAt: invitations.createdAt,\n        })\n        .from(invitations)\n        .where(eq(invitations.code, code))\n        .limit(1);\n\n      if (!invitation) {\n        return res.status(404).json({ message: \"Invitation not found or expired\" });\n      }\n\n      // Check if expired\n      if (invitation.expiresAt && new Date(invitation.expiresAt) < new Date()) {\n        return res.status(410).json({ message: \"Invitation has expired\" });\n      }\n\n      // Fetch inviter info\n      const [inviter] = await db\n        .select({\n          id: users.id,\n          displayName: users.displayName,\n          firstName: users.firstName,\n          lastName: users.lastName,\n        })\n        .from(users)\n        .where(eq(users.id, invitation.inviterId))\n        .limit(1);\n\n      // Fetch event info\n      const event = await storage.getBlindBoxEventById(invitation.eventId);\n\n      // Increment click count\n      await db.update(invitations)\n        .set({ totalClicks: invitation.totalClicks + 1 })\n        .where(eq(invitations.id, invitation.id));\n\n      res.json({\n        inviter,\n        event,\n        invitationType: invitation.invitationType,\n        code: invitation.code,\n      });\n    } catch (error: any) {\n      console.error(\"Error fetching invitation:\", error);\n      res.status(500).json({ message: \"Failed to fetch invitation\" });\n    }\n  });\n\n  // Create notification\n  app.post('/api/notifications', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ message: \"Not authenticated\" });\n      }\n\n      const { category, type, title, message, relatedResourceId } = req.body;\n      \n      if (!category || !type || !title) {\n        return res.status(400).json({ message: \"Missing required fields\" });\n      }\n\n      await storage.createNotification({\n        userId,\n        category,\n        type,\n        title,\n        message,\n        relatedResourceId,\n      });\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error creating notification:\", error);\n      res.status(500).json({ message: \"Failed to create notification\" });\n    }\n  });\n\n  // Demo: Create sample chat data\n  app.post('/api/chats/seed-demo', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ message: \"Not authenticated\" });\n      }\n\n      console.log(`[SEED-DEMO] Starting demo data creation for user: ${userId}`);\n\n      // Create demo users with different archetypes and complete profiles\n      const [demoUser1] = await db.insert(users).values({\n        displayName: 'å°æ˜',\n        archetype: 'å¼€å¿ƒæŸ¯åŸº',\n        hasCompletedProfileSetup: true,\n        hasCompletedPersonalityTest: true,\n        hasCompletedInterestsTopics: true,\n        gender: 'Man',\n        age: 28,\n        educationLevel: \"Master's\",\n        industry: 'ç§‘æŠ€',\n        relationshipStatus: 'Single',\n        interestsTop: ['ç§‘æŠ€', 'åˆ›ä¸š', 'å’–å•¡', 'äº§å“'],\n        interestsRankedTop3: ['ç§‘æŠ€', 'åˆ›ä¸š', 'å’–å•¡'],\n        topicsHappy: ['AIå‘å±•', 'äº§å“è®¾è®¡', 'åˆ›ä¸šæ•…äº‹'],\n        languagesComfort: ['ç²¤è¯­', 'æ™®é€šè¯', 'è‹±è¯­'],\n        eventsAttended: 5,\n        matchesMade: 8,\n      }).returning();\n\n      const [demoUser2] = await db.insert(users).values({\n        displayName: 'å°çº¢',\n        archetype: 'ç»‡ç½‘è››',\n        hasCompletedProfileSetup: true,\n        hasCompletedPersonalityTest: true,\n        hasCompletedInterestsTopics: true,\n        gender: 'Woman',\n        age: 26,\n        educationLevel: \"Bachelor's\",\n        industry: 'è®¾è®¡',\n        relationshipStatus: 'In a relationship',\n        interestsTop: ['è®¾è®¡', 'è‰ºæœ¯', 'æ—…è¡Œ', 'æ‘„å½±'],\n        interestsRankedTop3: ['è®¾è®¡', 'è‰ºæœ¯', 'æ—…è¡Œ'],\n        topicsHappy: ['UI/UXè®¾è®¡', 'æ‘„å½±', 'æ–‡åŒ–äº¤æµ'],\n        languagesComfort: ['ç²¤è¯­', 'æ™®é€šè¯'],\n        eventsAttended: 12,\n        matchesMade: 15,\n      }).returning();\n\n      const [demoUser3] = await db.insert(users).values({\n        displayName: 'é˜¿æ°',\n        archetype: 'æœºæ™ºç‹',\n        hasCompletedProfileSetup: true,\n        hasCompletedPersonalityTest: true,\n        hasCompletedInterestsTopics: true,\n        gender: 'Man',\n        age: 30,\n        educationLevel: \"Doctorate\",\n        industry: 'é‡‘è',\n        relationshipStatus: 'Single',\n        interestsTop: ['æŠ•èµ„', 'å¾’æ­¥', 'è¯»ä¹¦', 'å†å²'],\n        interestsRankedTop3: ['æŠ•èµ„', 'å¾’æ­¥', 'è¯»ä¹¦'],\n        topicsHappy: ['è‚¡å¸‚åˆ†æ', 'æˆ·å¤–è¿åŠ¨', 'å†å²'],\n        languagesComfort: ['ç²¤è¯­', 'æ™®é€šè¯', 'è‹±è¯­'],\n        eventsAttended: 8,\n        matchesMade: 10,\n      }).returning();\n\n      // Create demo events with different unlock states\n      const now = new Date();\n      \n      // Event 1: Unlocked (event is in 12 hours - within 24h window)\n      const in12Hours = new Date(now.getTime() + 12 * 60 * 60 * 1000);\n      \n      const [event1] = await db.insert(events).values({\n        title: 'ä»Šæ™šèšé¤ Â· æ¸¯å¼èŒ¶é¤å…',\n        description: 'é¥­å±€ Â· Â¥100-200',\n        dateTime: in12Hours,\n        location: 'ä¸­ç¯ç¿ åé¤å…',\n        area: 'ä¸­ç¯',\n        price: null,\n        maxAttendees: 6,\n        currentAttendees: 4,\n        hostId: userId,\n        status: 'upcoming',\n      }).returning();\n\n      // Add current user and demo users to event 1\n      await db.insert(eventAttendance).values([\n        {\n          eventId: event1.id,\n          userId,\n          status: 'confirmed',\n        },\n        {\n          eventId: event1.id,\n          userId: demoUser1.id,\n          status: 'confirmed',\n        },\n        {\n          eventId: event1.id,\n          userId: demoUser2.id,\n          status: 'confirmed',\n        },\n        {\n          eventId: event1.id,\n          userId: demoUser3.id,\n          status: 'confirmed',\n        },\n      ]);\n\n      // Create demo messages for event 1 with different users\n      const demoMessages = [\n        { message: 'å¤§å®¶å¥½ï¼å¾ˆæœŸå¾…æ˜å¤©çš„èšä¼š ğŸ‘‹', userId: demoUser1.id },\n        { message: 'æˆ‘ä¹Ÿæ˜¯ï¼æœ‰äººçŸ¥é“è¿™å®¶åº—çš„æ‹›ç‰Œèœæ˜¯ä»€ä¹ˆå—ï¼Ÿ', userId: demoUser2.id },\n        { message: 'å¬è¯´ä»–ä»¬çš„è èåŒ…å’Œå¥¶èŒ¶è¶…èµï¼', userId: demoUser3.id },\n      ];\n\n      for (const msg of demoMessages) {\n        await db.insert(chatMessages).values({\n          eventId: event1.id,\n          userId: msg.userId,\n          message: msg.message,\n        });\n      }\n\n      // Event 2: Locked (event is in 3 days)\n      const in3Days = new Date(now);\n      in3Days.setDate(in3Days.getDate() + 3);\n      in3Days.setHours(14, 0, 0, 0);\n      \n      const [event2] = await db.insert(events).values({\n        title: 'å‘¨æ—¥ä¸‹åˆèŒ¶ Â· å’–å•¡å…',\n        description: 'å’–å•¡ Â· Â¥â‰¤100',\n        dateTime: in3Days,\n        location: 'å°–æ²™å’€ % Arabica',\n        area: 'å°–æ²™å’€',\n        price: null,\n        maxAttendees: 5,\n        currentAttendees: 3,\n        hostId: userId,\n        status: 'upcoming',\n      }).returning();\n\n      await db.insert(eventAttendance).values({\n        eventId: event2.id,\n        userId,\n        status: 'confirmed',\n      });\n\n      // Event 3: Past event (2 hours ago)\n      const twoHoursAgo = new Date(now.getTime() - 2 * 60 * 60 * 1000);\n      \n      const [event3] = await db.insert(events).values({\n        title: 'åˆšç»“æŸçš„æ¡Œæ¸¸å±€',\n        description: 'ç©ä¹ Â· Â¥200-300',\n        dateTime: twoHoursAgo,\n        location: 'é“œé”£æ¹¾ Game On',\n        area: 'é“œé”£æ¹¾',\n        price: null,\n        maxAttendees: 6,\n        currentAttendees: 5,\n        hostId: userId,\n        status: 'completed',\n      }).returning();\n\n      await db.insert(eventAttendance).values({\n        eventId: event3.id,\n        userId,\n        status: 'confirmed',\n      });\n\n      // Create demo messages for past event with different users\n      const pastMessages = [\n        { message: 'ä»Šå¤©ç©å¾—å¤ªå¼€å¿ƒäº†ï¼', userId: demoUser2.id },\n        { message: 'ç‹¼äººæ€å¤ªåˆºæ¿€äº†å“ˆå“ˆ', userId: demoUser1.id },\n        { message: 'ä¸‹æ¬¡è¿˜è¦ä¸€èµ·ç©ï¼', userId: demoUser3.id },\n      ];\n\n      for (const msg of pastMessages) {\n        await db.insert(chatMessages).values({\n          eventId: event3.id,\n          userId: msg.userId,\n          message: msg.message,\n        });\n      }\n\n      // Also add demo users as event attendees\n      await db.insert(eventAttendance).values([\n        { eventId: event3.id, userId: demoUser1.id, status: 'confirmed' },\n        { eventId: event3.id, userId: demoUser2.id, status: 'confirmed' },\n        { eventId: event3.id, userId: demoUser3.id, status: 'confirmed' },\n      ]);\n\n      // Create direct message threads (private 1-1 chats)\n      console.log(`[SEED-DEMO] Creating direct message thread 1: ${userId} <-> ${demoUser1.id}`);\n      // Thread 1: Current user with demoUser1 (å°æ˜-å¼€å¿ƒæŸ¯åŸº)\n      const [thread1] = await db.insert(directMessageThreads).values({\n        user1Id: userId,\n        user2Id: demoUser1.id,\n        eventId: event3.id, // They matched at the past event\n        lastMessageAt: new Date(now.getTime() - 30 * 60 * 1000), // 30 mins ago\n      }).returning();\n      console.log(`[SEED-DEMO] Thread 1 created with ID: ${thread1.id}`);\n\n      // Messages in thread 1\n      const thread1Messages = [\n        { senderId: demoUser1.id, message: 'ä»Šå¤©ç©å¾—å¾ˆå¼€å¿ƒï¼æˆ‘ä»¬å¯ä»¥åŠ ä¸ªå¥½å‹å—ï¼Ÿ', createdAt: new Date(now.getTime() - 60 * 60 * 1000) },\n        { senderId: userId, message: 'å½“ç„¶å¯ä»¥ï¼æˆ‘ä¹Ÿè§‰å¾—ä»Šå¤©å¾ˆæœ‰è¶£', createdAt: new Date(now.getTime() - 55 * 60 * 1000) },\n        { senderId: demoUser1.id, message: 'ä¸‹æ¬¡æœ‰ç±»ä¼¼çš„æ´»åŠ¨è®°å¾—å«æˆ‘ï¼', createdAt: new Date(now.getTime() - 30 * 60 * 1000) },\n      ];\n\n      for (const msg of thread1Messages) {\n        await db.insert(directMessages).values({\n          threadId: thread1.id,\n          senderId: msg.senderId,\n          message: msg.message,\n          createdAt: msg.createdAt,\n        });\n      }\n\n      // Thread 2: Current user with demoUser2 (å°çº¢-ç»‡ç½‘è››)\n      console.log(`[SEED-DEMO] Creating direct message thread 2: ${userId} <-> ${demoUser2.id}`);\n      const [thread2] = await db.insert(directMessageThreads).values({\n        user1Id: userId,\n        user2Id: demoUser2.id,\n        eventId: event3.id,\n        lastMessageAt: new Date(now.getTime() - 10 * 60 * 1000), // 10 mins ago\n      }).returning();\n      console.log(`[SEED-DEMO] Thread 2 created with ID: ${thread2.id}`);\n\n      // Messages in thread 2\n      const thread2Messages = [\n        { senderId: demoUser2.id, message: 'å—¨ï¼åˆšæ‰çš„ç‹¼äººæ€ä½ ç©å¾—çœŸæ£’', createdAt: new Date(now.getTime() - 45 * 60 * 1000) },\n        { senderId: userId, message: 'è°¢è°¢ï¼ä½ ä¹Ÿå¾ˆå‰å®³å‘€', createdAt: new Date(now.getTime() - 40 * 60 * 1000) },\n        { senderId: demoUser2.id, message: 'æˆ‘ä»¬ä¸‹å‘¨è¿˜æœ‰ä¸ªå’–å•¡èšä¼šï¼Œè¦æ¥å—ï¼Ÿ', createdAt: new Date(now.getTime() - 35 * 60 * 1000) },\n        { senderId: userId, message: 'å¥½å•Šï¼å…·ä½“ä»€ä¹ˆæ—¶é—´ï¼Ÿ', createdAt: new Date(now.getTime() - 10 * 60 * 1000) },\n      ];\n\n      for (const msg of thread2Messages) {\n        await db.insert(directMessages).values({\n          threadId: thread2.id,\n          senderId: msg.senderId,\n          message: msg.message,\n          createdAt: msg.createdAt,\n        });\n      }\n\n      console.log(`[SEED-DEMO] Demo data creation completed successfully for user: ${userId}`);\n      res.json({ \n        success: true, \n        message: 'Demo chat data created (including 2 private chats)',\n        events: [\n          { title: event1.title, status: 'unlocked', dateTime: event1.dateTime },\n          { title: event2.title, status: 'locked', dateTime: event2.dateTime },\n          { title: event3.title, status: 'past', dateTime: event3.dateTime },\n        ],\n        privateChats: [\n          { with: 'å°æ˜ (å¼€å¿ƒæŸ¯åŸº)', messages: 3, threadId: thread1.id },\n          { with: 'å°çº¢ (ç»‡ç½‘è››)', messages: 4, threadId: thread2.id },\n        ]\n      });\n    } catch (error) {\n      console.error(\"[SEED-DEMO] Error creating demo chat data:\", error);\n      res.status(500).json({ message: \"Failed to create demo chat data\", error: error instanceof Error ? error.message : 'Unknown error' });\n    }\n  });\n\n  // Demo: Create sample notifications\n  app.post('/api/notifications/seed-demo', isPhoneAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ message: \"Not authenticated\" });\n      }\n\n      // Create discover notifications\n      await storage.createNotification({\n        userId,\n        category: 'discover',\n        type: 'new_activity',\n        title: 'æ–°æ´»åŠ¨æ¨è',\n        message: 'å‘ç°äº†ä¸€ä¸ªè¶…é€‚åˆä½ çš„å‘¨æœ«å’–å•¡èšä¼š',\n      });\n\n      // Create activities notifications\n      await storage.createNotification({\n        userId,\n        category: 'activities',\n        type: 'match_success',\n        title: 'åŒ¹é…æˆåŠŸ',\n        message: 'ä½ çš„å‘¨æœ«è½°è¶´æ´»åŠ¨å·²æˆåŠŸåŒ¹é…4ä½å°ä¼™ä¼´',\n      });\n\n      await storage.createNotification({\n        userId,\n        category: 'activities',\n        type: 'activity_reminder',\n        title: 'æ´»åŠ¨æé†’',\n        message: 'è·ç¦»ã€Œå‘¨æœ«è½°è¶´ã€å¼€å§‹è¿˜æœ‰2å°æ—¶',\n      });\n\n      await storage.createNotification({\n        userId,\n        category: 'activities',\n        type: 'feedback_reminder',\n        title: 'åé¦ˆæé†’',\n        message: 'ã€Œå‘¨æœ«è½°è¶´ã€å·²ç»“æŸï¼Œå¿«æ¥åˆ†äº«ä½ çš„æ„Ÿå—å§',\n      });\n\n      // Create chat notifications\n      await storage.createNotification({\n        userId,\n        category: 'chat',\n        type: 'new_message',\n        title: 'æ–°æ¶ˆæ¯',\n        message: 'Alex åœ¨ç¾¤èŠä¸­@äº†ä½ ',\n      });\n\n      await storage.createNotification({\n        userId,\n        category: 'chat',\n        type: 'new_message',\n        title: 'æ–°æ¶ˆæ¯',\n        message: 'å‘¨æœ«è½°è¶´ç¾¤èŠæœ‰6æ¡æ–°æ¶ˆæ¯',\n      });\n\n      res.json({ success: true, message: 'Demo notifications created' });\n    } catch (error) {\n      console.error(\"Error creating demo notifications:\", error);\n      res.status(500).json({ message: \"Failed to create demo notifications\" });\n    }\n  });\n\n  // ============ ADMIN MIDDLEWARE ============\n  \n  async function requireAuth(req: Request, res: any, next: any) {\n    const session = req.session as any;\n    if (!session?.userId) {\n      return res.status(401).json({ message: \"Unauthorized\" });\n    }\n    next();\n  }\n  \n  async function requireAdmin(req: Request, res: any, next: any) {\n    const session = req.session as any;\n    if (!session?.userId) {\n      return res.status(401).json({ message: \"Unauthorized\" });\n    }\n    \n    try {\n      const user = await storage.getUser(session.userId);\n      if (!user?.isAdmin) {\n        return res.status(403).json({ message: \"Forbidden - Admin access required\" });\n      }\n      \n      next();\n    } catch (error) {\n      console.error(\"Error checking admin status:\", error);\n      return res.status(500).json({ message: \"Internal server error\" });\n    }\n  }\n\n  // ============ ADMIN API ROUTES ============\n\n  // Dashboard Statistics\n  app.get(\"/api/admin/stats\", requireAdmin, async (req, res) => {\n    try {\n      const allUsers = await storage.getAllUsers();\n      \n      // Calculate stats\n      const totalUsers = allUsers.length;\n      const subscribedUsers = 0; // TODO: Count from subscriptions table\n      const newUsersThisWeek = 0; // TODO: Count users created in last 7 days\n      const userGrowth = 0; // TODO: Calculate growth percentage\n      \n      // Count events (for now using blindBoxEvents)\n      const allBlindBoxEvents = await storage.getAllBlindBoxEvents();\n      const thisMonth = new Date();\n      thisMonth.setDate(1);\n      const eventsThisMonth = allBlindBoxEvents.filter((event: any) => {\n        const eventDate = new Date(event.createdAt || '');\n        return eventDate >= thisMonth;\n      }).length;\n      \n      // Revenue stats (placeholder)\n      const monthlyRevenue = 0; // TODO: Calculate from payments table\n      \n      // Personality distribution\n      const personalityDistribution = allUsers.reduce((acc: Record<string, number>, user: any) => {\n        if (user.primaryRole) {\n          acc[user.primaryRole] = (acc[user.primaryRole] || 0) + 1;\n        }\n        return acc;\n      }, {});\n\n      res.json({\n        totalUsers,\n        subscribedUsers,\n        eventsThisMonth,\n        monthlyRevenue,\n        newUsersThisWeek,\n        userGrowth,\n        personalityDistribution,\n      });\n    } catch (error) {\n      console.error(\"Error fetching admin stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch stats\" });\n    }\n  });\n\n  // User Management - Get all users with filters and pagination\n  app.get(\"/api/admin/users\", requireAdmin, async (req, res) => {\n    try {\n      const { search, filter } = req.query;\n      const page = parseInt(req.query.page as string) || 1;\n      const limit = parseInt(req.query.limit as string) || 50;\n      const offset = (page - 1) * limit;\n      \n      let users = await storage.getAllUsers();\n\n      // Apply search filter\n      if (search && typeof search === \"string\") {\n        const searchLower = search.toLowerCase();\n        users = users.filter((user: any) => \n          user.firstName?.toLowerCase().includes(searchLower) ||\n          user.lastName?.toLowerCase().includes(searchLower) ||\n          user.email?.toLowerCase().includes(searchLower) ||\n          user.phoneNumber?.includes(search)\n        );\n      }\n\n      // Apply status filter\n      if (filter === \"banned\") {\n        users = users.filter((user: any) => user.isBanned);\n      } else if (filter === \"subscribed\") {\n        // TODO: Filter by subscription status when subscriptions table is implemented\n        users = [];\n      } else if (filter === \"non-subscribed\") {\n        // TODO: Filter by non-subscription status\n        users = users;\n      }\n\n      const totalUsers = users.length;\n      const paginatedUsers = users.slice(offset, offset + limit);\n\n      res.json({\n        users: paginatedUsers,\n        pagination: {\n          page,\n          limit,\n          total: totalUsers,\n          totalPages: Math.ceil(totalUsers / limit),\n        },\n      });\n    } catch (error) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ message: \"Failed to fetch users\" });\n    }\n  });\n\n  // User Management - Get user details\n  app.get(\"/api/admin/users/:id\", requireAdmin, async (req, res) => {\n    try {\n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Get user's events\n      const events = await storage.getUserBlindBoxEvents(req.params.id);\n      \n      res.json({\n        ...user,\n        events,\n        subscriptions: [], // TODO: Get from subscriptions table\n        payments: [], // TODO: Get from payments table\n      });\n    } catch (error) {\n      console.error(\"Error fetching user details:\", error);\n      res.status(500).json({ message: \"Failed to fetch user details\" });\n    }\n  });\n\n  // User Management - Ban user\n  app.patch(\"/api/admin/users/:id/ban\", requireAdmin, async (req, res) => {\n    try {\n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const updatedUser = await storage.updateUser(req.params.id, { isBanned: true });\n      \n      // TODO: Log moderation action\n      res.json(updatedUser);\n    } catch (error) {\n      console.error(\"Error banning user:\", error);\n      res.status(500).json({ message: \"Failed to ban user\" });\n    }\n  });\n\n  // User Management - Unban user\n  app.patch(\"/api/admin/users/:id/unban\", requireAdmin, async (req, res) => {\n    try {\n      const user = await storage.getUser(req.params.id);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      const updatedUser = await storage.updateUser(req.params.id, { isBanned: false });\n      \n      // TODO: Log moderation action\n      res.json(updatedUser);\n    } catch (error) {\n      console.error(\"Error unbanning user:\", error);\n      res.status(500).json({ message: \"Failed to unban user\" });\n    }\n  });\n\n  // Subscription Management - Get all subscriptions with pagination\n  app.get(\"/api/admin/subscriptions\", requireAdmin, async (req, res) => {\n    try {\n      const { filter } = req.query;\n      const page = parseInt(req.query.page as string) || 1;\n      const limit = parseInt(req.query.limit as string) || 50;\n      const offset = (page - 1) * limit;\n      \n      let subscriptions;\n      \n      if (filter === \"active\") {\n        subscriptions = await storage.getActiveSubscriptions();\n      } else {\n        subscriptions = await storage.getAllSubscriptions();\n      }\n\n      const total = subscriptions.length;\n      const paginatedData = subscriptions.slice(offset, offset + limit);\n\n      res.json({\n        subscriptions: paginatedData,\n        pagination: {\n          page,\n          limit,\n          total,\n          totalPages: Math.ceil(total / limit),\n        },\n      });\n    } catch (error) {\n      console.error(\"Error fetching subscriptions:\", error);\n      res.status(500).json({ message: \"Failed to fetch subscriptions\" });\n    }\n  });\n\n  // Subscription Management - Create subscription\n  app.post(\"/api/admin/subscriptions\", requireAdmin, async (req, res) => {\n    try {\n      const { userId, planType, durationMonths } = req.body;\n      \n      if (!userId || !planType || !durationMonths) {\n        return res.status(400).json({ message: \"Missing required fields\" });\n      }\n\n      const startDate = new Date();\n      const endDate = new Date();\n      endDate.setMonth(endDate.getMonth() + durationMonths);\n\n      const subscription = await storage.createSubscription({\n        userId,\n        planType,\n        startDate: startDate.toISOString(),\n        endDate: endDate.toISOString(),\n        isActive: true,\n        autoRenew: false,\n      });\n\n      res.json(subscription);\n    } catch (error) {\n      console.error(\"Error creating subscription:\", error);\n      res.status(500).json({ message: \"Failed to create subscription\" });\n    }\n  });\n\n  // Subscription Management - Update subscription\n  app.patch(\"/api/admin/subscriptions/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { isActive, autoRenew, endDate } = req.body;\n      \n      const subscription = await storage.updateSubscription(req.params.id, {\n        isActive,\n        autoRenew,\n        endDate,\n      });\n\n      res.json(subscription);\n    } catch (error) {\n      console.error(\"Error updating subscription:\", error);\n      res.status(500).json({ message: \"Failed to update subscription\" });\n    }\n  });\n\n  // Coupon Management - Get all coupons\n  app.get(\"/api/admin/coupons\", requireAdmin, async (req, res) => {\n    try {\n      const coupons = await storage.getAllCoupons();\n      res.json(coupons);\n    } catch (error) {\n      console.error(\"Error fetching coupons:\", error);\n      res.status(500).json({ message: \"Failed to fetch coupons\" });\n    }\n  });\n\n  // Coupon Management - Get coupon details\n  app.get(\"/api/admin/coupons/:id\", requireAdmin, async (req, res) => {\n    try {\n      const coupon = await storage.getCoupon(req.params.id);\n      if (!coupon) {\n        return res.status(404).json({ message: \"Coupon not found\" });\n      }\n      res.json(coupon);\n    } catch (error) {\n      console.error(\"Error fetching coupon:\", error);\n      res.status(500).json({ message: \"Failed to fetch coupon\" });\n    }\n  });\n\n  // Coupon Management - Get coupon usage stats\n  app.get(\"/api/admin/coupons/:id/usage\", requireAdmin, async (req, res) => {\n    try {\n      const usage = await storage.getCouponUsageStats(req.params.id);\n      res.json(usage);\n    } catch (error) {\n      console.error(\"Error fetching coupon usage:\", error);\n      res.status(500).json({ message: \"Failed to fetch coupon usage\" });\n    }\n  });\n\n  // Coupon Management - Create coupon\n  app.post(\"/api/admin/coupons\", requireAdmin, async (req, res) => {\n    try {\n      const { code, discountType, discountValue, validFrom, validUntil, maxUses } = req.body;\n      \n      if (!code || !discountType || !discountValue) {\n        return res.status(400).json({ message: \"Missing required fields\" });\n      }\n\n      const coupon = await storage.createCoupon({\n        code: code.toUpperCase(),\n        discountType,\n        discountValue,\n        validFrom: validFrom || new Date().toISOString(),\n        validUntil: validUntil || null,\n        maxUses: maxUses || null,\n        isActive: true,\n      });\n\n      res.json(coupon);\n    } catch (error) {\n      console.error(\"Error creating coupon:\", error);\n      res.status(500).json({ message: \"Failed to create coupon\" });\n    }\n  });\n\n  // Coupon Management - Update coupon\n  app.patch(\"/api/admin/coupons/:id\", requireAdmin, async (req, res) => {\n    try {\n      const coupon = await storage.updateCoupon(req.params.id, req.body);\n      res.json(coupon);\n    } catch (error) {\n      console.error(\"Error updating coupon:\", error);\n      res.status(500).json({ message: \"Failed to update coupon\" });\n    }\n  });\n\n  // Venue Management - Get all venues\n  app.get(\"/api/admin/venues\", requireAdmin, async (req, res) => {\n    try {\n      const venues = await storage.getAllVenues();\n      res.json(venues);\n    } catch (error) {\n      console.error(\"Error fetching venues:\", error);\n      res.status(500).json({ message: \"Failed to fetch venues\" });\n    }\n  });\n\n  // Venue Management - Get venue details\n  app.get(\"/api/admin/venues/:id\", requireAdmin, async (req, res) => {\n    try {\n      const venue = await storage.getVenue(req.params.id);\n      if (!venue) {\n        return res.status(404).json({ message: \"Venue not found\" });\n      }\n      res.json(venue);\n    } catch (error) {\n      console.error(\"Error fetching venue:\", error);\n      res.status(500).json({ message: \"Failed to fetch venue\" });\n    }\n  });\n\n  // Venue Management - Create venue\n  app.post(\"/api/admin/venues\", requireAdmin, async (req, res) => {\n    try {\n      const { name, type, address, city, district, contactName, contactPhone, commissionRate, tags, cuisines, priceRange, maxConcurrentEvents, notes } = req.body;\n      \n      if (!name || !type || !address || !city || !district) {\n        return res.status(400).json({ message: \"Missing required fields\" });\n      }\n\n      const venue = await storage.createVenue({\n        name,\n        type,\n        address,\n        city,\n        district,\n        contactName: contactName || null,\n        contactPhone: contactPhone || null,\n        commissionRate: commissionRate || 20,\n        tags: tags || [],\n        cuisines: cuisines || [],\n        priceRange: priceRange || null,\n        maxConcurrentEvents: maxConcurrentEvents || 1,\n        isActive: true,\n        notes: notes || null,\n      });\n\n      res.json(venue);\n    } catch (error) {\n      console.error(\"Error creating venue:\", error);\n      res.status(500).json({ message: \"Failed to create venue\" });\n    }\n  });\n\n  // Venue Management - Update venue\n  app.patch(\"/api/admin/venues/:id\", requireAdmin, async (req, res) => {\n    try {\n      const venue = await storage.updateVenue(req.params.id, req.body);\n      res.json(venue);\n    } catch (error) {\n      console.error(\"Error updating venue:\", error);\n      res.status(500).json({ message: \"Failed to update venue\" });\n    }\n  });\n\n  // Venue Management - Delete venue\n  app.delete(\"/api/admin/venues/:id\", requireAdmin, async (req, res) => {\n    try {\n      await storage.deleteVenue(req.params.id);\n      res.json({ message: \"Venue deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting venue:\", error);\n      res.status(500).json({ message: \"Failed to delete venue\" });\n    }\n  });\n\n  // Venue Booking - Check availability\n  app.post(\"/api/venues/check-availability\", requireAuth, async (req, res) => {\n    try {\n      const { venueId, bookingDate, bookingTime } = req.body;\n      \n      if (!venueId || !bookingDate || !bookingTime) {\n        return res.status(400).json({ message: \"Missing required fields\" });\n      }\n\n      const isAvailable = await storage.checkVenueAvailability(\n        venueId,\n        new Date(bookingDate),\n        bookingTime\n      );\n\n      res.json({ available: isAvailable });\n    } catch (error) {\n      console.error(\"Error checking venue availability:\", error);\n      res.status(500).json({ message: \"Failed to check venue availability\" });\n    }\n  });\n\n  // Venue Booking - Create booking\n  app.post(\"/api/venues/book\", requireAuth, async (req, res) => {\n    try {\n      const { venueId, eventId, bookingDate, bookingTime, participantCount, estimatedRevenue } = req.body;\n      \n      if (!venueId || !eventId || !bookingDate || !bookingTime || !participantCount) {\n        return res.status(400).json({ message: \"Missing required fields\" });\n      }\n\n      const booking = await storage.createVenueBooking({\n        venueId,\n        eventId,\n        bookingDate: new Date(bookingDate),\n        bookingTime,\n        participantCount,\n        estimatedRevenue,\n      });\n\n      res.json(booking);\n    } catch (error: any) {\n      console.error(\"Error creating venue booking:\", error);\n      if (error.message === 'Venue is not available at the requested time') {\n        res.status(409).json({ message: error.message });\n      } else {\n        res.status(500).json({ message: \"Failed to create venue booking\" });\n      }\n    }\n  });\n\n  // Venue Booking - Get bookings for a venue\n  app.get(\"/api/admin/venues/:venueId/bookings\", requireAdmin, async (req, res) => {\n    try {\n      const bookings = await storage.getVenueBookings(req.params.venueId);\n      res.json(bookings);\n    } catch (error) {\n      console.error(\"Error fetching venue bookings:\", error);\n      res.status(500).json({ message: \"Failed to fetch venue bookings\" });\n    }\n  });\n\n  // Venue Booking - Get booking for an event\n  app.get(\"/api/events/:eventId/venue-booking\", requireAuth, async (req, res) => {\n    try {\n      const booking = await storage.getEventVenueBooking(req.params.eventId);\n      res.json(booking || null);\n    } catch (error) {\n      console.error(\"Error fetching event venue booking:\", error);\n      res.status(500).json({ message: \"Failed to fetch event venue booking\" });\n    }\n  });\n\n  // Venue Booking - Cancel booking\n  app.post(\"/api/venues/bookings/:bookingId/cancel\", requireAuth, async (req, res) => {\n    try {\n      const booking = await storage.cancelVenueBooking(req.params.bookingId);\n      res.json(booking);\n    } catch (error) {\n      console.error(\"Error cancelling venue booking:\", error);\n      res.status(500).json({ message: \"Failed to cancel venue booking\" });\n    }\n  });\n\n  // Venue Booking - Update revenue (Admin only)\n  app.patch(\"/api/admin/venues/bookings/:bookingId/revenue\", requireAdmin, async (req, res) => {\n    try {\n      const { actualRevenue } = req.body;\n      \n      if (actualRevenue === undefined) {\n        return res.status(400).json({ message: \"Missing actualRevenue\" });\n      }\n\n      const booking = await storage.updateVenueBookingRevenue(req.params.bookingId, actualRevenue);\n      res.json(booking);\n    } catch (error) {\n      console.error(\"Error updating venue booking revenue:\", error);\n      res.status(500).json({ message: \"Failed to update venue booking revenue\" });\n    }\n  });\n\n  // Event Templates - Get all templates\n  app.get(\"/api/admin/event-templates\", requireAdmin, async (req, res) => {\n    try {\n      const templates = await storage.getAllEventTemplates();\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error fetching event templates:\", error);\n      res.status(500).json({ message: \"Failed to fetch event templates\" });\n    }\n  });\n\n  // Event Templates - Create template\n  app.post(\"/api/admin/event-templates\", requireAdmin, async (req, res) => {\n    try {\n      const { name, eventType, dayOfWeek, timeOfDay, theme, genderRestriction, minAge, maxAge, minParticipants, maxParticipants, customPrice } = req.body;\n      \n      if (!name || !eventType || dayOfWeek === undefined || !timeOfDay) {\n        return res.status(400).json({ message: \"Missing required fields\" });\n      }\n\n      const template = await storage.createEventTemplate({\n        name,\n        eventType,\n        dayOfWeek,\n        timeOfDay,\n        theme: theme || null,\n        genderRestriction: genderRestriction || null,\n        minAge: minAge || null,\n        maxAge: maxAge || null,\n        minParticipants: minParticipants || 5,\n        maxParticipants: maxParticipants || 10,\n        customPrice: customPrice || null,\n        isActive: true,\n      });\n\n      res.json(template);\n    } catch (error) {\n      console.error(\"Error creating event template:\", error);\n      res.status(500).json({ message: \"Failed to create event template\" });\n    }\n  });\n\n  // Event Templates - Update template\n  app.patch(\"/api/admin/event-templates/:id\", requireAdmin, async (req, res) => {\n    try {\n      const template = await storage.updateEventTemplate(req.params.id, req.body);\n      res.json(template);\n    } catch (error) {\n      console.error(\"Error updating event template:\", error);\n      res.status(500).json({ message: \"Failed to update event template\" });\n    }\n  });\n\n  // Event Templates - Delete template\n  app.delete(\"/api/admin/event-templates/:id\", requireAdmin, async (req, res) => {\n    try {\n      await storage.deleteEventTemplate(req.params.id);\n      res.json({ message: \"Event template deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting event template:\", error);\n      res.status(500).json({ message: \"Failed to delete event template\" });\n    }\n  });\n\n  // Event Management - Get all events (admin view)\n  app.get(\"/api/admin/events\", requireAdmin, async (req, res) => {\n    try {\n      const events = await storage.getAllBlindBoxEventsAdmin();\n      res.json(events);\n    } catch (error) {\n      console.error(\"Error fetching events:\", error);\n      res.status(500).json({ message: \"Failed to fetch events\" });\n    }\n  });\n\n  // Event Management - Get event details (admin view)\n  app.get(\"/api/admin/events/:id\", requireAdmin, async (req, res) => {\n    try {\n      const event = await storage.getBlindBoxEventAdmin(req.params.id);\n      if (!event) {\n        return res.status(404).json({ message: \"Event not found\" });\n      }\n      res.json(event);\n    } catch (error) {\n      console.error(\"Error fetching event:\", error);\n      res.status(500).json({ message: \"Failed to fetch event\" });\n    }\n  });\n\n  // Event Management - Update event status\n  app.patch(\"/api/admin/events/:id\", requireAdmin, async (req, res) => {\n    try {\n      const eventId = req.params.id;\n      const user = req.user as User;\n      \n      // Get old event state\n      const oldEvent = await storage.getBlindBoxEventAdmin(eventId);\n      if (!oldEvent) {\n        return res.status(404).json({ message: \"Event not found\" });\n      }\n      \n      // Update event\n      const updatedEvent = await storage.updateBlindBoxEventAdmin(eventId, req.body);\n      \n      // Broadcast status change if status was updated\n      if (req.body.status && req.body.status !== oldEvent.status) {\n        await broadcastEventStatusChanged(\n          eventId,\n          oldEvent.status,\n          req.body.status,\n          user.id,\n          req.body.reason\n        );\n      }\n      \n      // Broadcast admin action for other changes\n      if (Object.keys(req.body).length > 0 && !req.body.status) {\n        await broadcastAdminAction(\n          eventId,\n          'update_event',\n          user.id,\n          req.body\n        );\n      }\n      \n      res.json(updatedEvent);\n    } catch (error) {\n      console.error(\"Error updating event:\", error);\n      res.status(500).json({ message: \"Failed to update event\" });\n    }\n  });\n\n  // ============ EVENT POOLS (ä¸¤é˜¶æ®µåŒ¹é…æ¨¡å‹) ============\n  \n  // Event Pools - Get all event pools (admin view)\n  app.get(\"/api/admin/event-pools\", requireAdmin, async (req, res) => {\n    try {\n      const pools = await db.query.eventPools.findMany({\n        orderBy: (eventPools, { desc }) => [desc(eventPools.createdAt)],\n        with: {\n          creator: {\n            columns: {\n              id: true,\n              firstName: true,\n              lastName: true,\n              email: true,\n            }\n          }\n        }\n      });\n      \n      // Add registration counts\n      const poolsWithStats = await Promise.all(pools.map(async (pool: any) => {\n        const registrations = await db.query.eventPoolRegistrations.findMany({\n          where: (regs: any, { eq }: any) => eq(regs.poolId, pool.id)\n        });\n        \n        return {\n          ...pool,\n          registrationCount: registrations.length,\n          matchedCount: registrations.filter((r: any) => r.matchStatus === 'matched').length,\n          pendingCount: registrations.filter((r: any) => r.matchStatus === 'pending').length,\n        };\n      }));\n      \n      res.json(poolsWithStats);\n    } catch (error) {\n      console.error(\"Error fetching event pools:\", error);\n      res.status(500).json({ message: \"Failed to fetch event pools\" });\n    }\n  });\n\n  // Event Pools - Create new event pool\n  app.post(\"/api/admin/event-pools\", requireAdmin, async (req, res) => {\n    try {\n      const user = req.user as User;\n      \n      // Validate input\n      const validatedData = insertEventPoolSchema.parse({\n        ...req.body,\n        createdBy: user.id,\n        dateTime: new Date(req.body.dateTime),\n        registrationDeadline: new Date(req.body.registrationDeadline),\n      });\n      \n      const [pool] = await db.insert(eventPools).values(validatedData).returning();\n      \n      res.json(pool);\n    } catch (error: any) {\n      console.error(\"Error creating event pool:\", error);\n      res.status(400).json({ \n        message: \"Failed to create event pool\", \n        error: error.message \n      });\n    }\n  });\n\n  // Event Pools - Get single event pool with details\n  app.get(\"/api/admin/event-pools/:id\", requireAdmin, async (req, res) => {\n    try {\n      const pool = await db.query.eventPools.findFirst({\n        where: (pools, { eq }) => eq(pools.id, req.params.id),\n        with: {\n          creator: {\n            columns: {\n              id: true,\n              firstName: true,\n              lastName: true,\n              email: true,\n            }\n          }\n        }\n      });\n      \n      if (!pool) {\n        return res.status(404).json({ message: \"Event pool not found\" });\n      }\n      \n      res.json(pool);\n    } catch (error) {\n      console.error(\"Error fetching event pool:\", error);\n      res.status(500).json({ message: \"Failed to fetch event pool\" });\n    }\n  });\n\n  // Event Pools - Update event pool\n  app.patch(\"/api/admin/event-pools/:id\", requireAdmin, async (req, res) => {\n    try {\n      const updates: any = { ...req.body };\n      \n      // Convert date strings to Date objects\n      if (updates.dateTime) {\n        updates.dateTime = new Date(updates.dateTime);\n      }\n      if (updates.registrationDeadline) {\n        updates.registrationDeadline = new Date(updates.registrationDeadline);\n      }\n      \n      updates.updatedAt = new Date();\n      \n      const [pool] = await db\n        .update(eventPools)\n        .set(updates)\n        .where(eq(eventPools.id, req.params.id))\n        .returning();\n      \n      if (!pool) {\n        return res.status(404).json({ message: \"Event pool not found\" });\n      }\n      \n      res.json(pool);\n    } catch (error) {\n      console.error(\"Error updating event pool:\", error);\n      res.status(500).json({ message: \"Failed to update event pool\" });\n    }\n  });\n\n  // Event Pools - Get registrations for a pool\n  app.get(\"/api/admin/event-pools/:id/registrations\", requireAdmin, async (req, res) => {\n    try {\n      const registrations = await db\n        .select({\n          id: eventPoolRegistrations.id,\n          poolId: eventPoolRegistrations.poolId,\n          userId: eventPoolRegistrations.userId,\n          budgetRange: eventPoolRegistrations.budgetRange,\n          preferredLanguages: eventPoolRegistrations.preferredLanguages,\n          socialGoals: eventPoolRegistrations.socialGoals,\n          cuisinePreferences: eventPoolRegistrations.cuisinePreferences,\n          dietaryRestrictions: eventPoolRegistrations.dietaryRestrictions,\n          tasteIntensity: eventPoolRegistrations.tasteIntensity,\n          matchStatus: eventPoolRegistrations.matchStatus,\n          assignedGroupId: eventPoolRegistrations.assignedGroupId,\n          matchScore: eventPoolRegistrations.matchScore,\n          registeredAt: eventPoolRegistrations.registeredAt,\n          // User info\n          userName: users.displayName,\n          userFirstName: users.firstName,\n          userLastName: users.lastName,\n          userEmail: users.email,\n          userGender: users.gender,\n          userAge: users.age,\n          userIndustry: users.industry,\n          userSeniority: users.seniority,\n          userArchetype: users.archetype,\n        })\n        .from(eventPoolRegistrations)\n        .innerJoin(users, eq(eventPoolRegistrations.userId, users.id))\n        .where(eq(eventPoolRegistrations.poolId, req.params.id));\n      \n      res.json(registrations);\n    } catch (error) {\n      console.error(\"Error fetching registrations:\", error);\n      res.status(500).json({ message: \"Failed to fetch registrations\" });\n    }\n  });\n\n  // Event Pools - Get groups for a pool\n  app.get(\"/api/admin/event-pools/:id/groups\", requireAdmin, async (req, res) => {\n    try {\n      const groups = await db.query.eventPoolGroups.findMany({\n        where: (groups, { eq }) => eq(groups.poolId, req.params.id),\n        orderBy: (groups, { asc }) => [asc(groups.groupNumber)],\n      });\n      \n      // Get members for each group\n      const groupsWithMembers = await Promise.all(groups.map(async (group: any) => {\n        const members = await db\n          .select({\n            registrationId: eventPoolRegistrations.id,\n            userId: eventPoolRegistrations.userId,\n            userName: users.displayName,\n            userFirstName: users.firstName,\n            userLastName: users.lastName,\n            userGender: users.gender,\n            userArchetype: users.archetype,\n            userIndustry: users.industry,\n            matchScore: eventPoolRegistrations.matchScore,\n          })\n          .from(eventPoolRegistrations)\n          .innerJoin(users, eq(eventPoolRegistrations.userId, users.id))\n          .where(eq(eventPoolRegistrations.assignedGroupId, group.id));\n        \n        return {\n          ...group,\n          members,\n        };\n      }));\n      \n      res.json(groupsWithMembers);\n    } catch (error) {\n      console.error(\"Error fetching groups:\", error);\n      res.status(500).json({ message: \"Failed to fetch groups\" });\n    }\n  });\n\n  // Event Pools - Trigger matching algorithm\n  app.post(\"/api/admin/event-pools/:id/match\", requireAdmin, async (req, res) => {\n    try {\n      const poolId = req.params.id;\n      \n      // Check if pool exists and is in active status\n      const pool = await db.query.eventPools.findFirst({\n        where: (pools, { eq }) => eq(pools.id, poolId)\n      });\n      \n      if (!pool) {\n        return res.status(404).json({ message: \"Event pool not found\" });\n      }\n      \n      if (pool.status !== 'active') {\n        return res.status(400).json({ message: \"Pool is not in active status\" });\n      }\n      \n      // Run matching algorithm\n      const groups = await matchEventPool(poolId);\n      \n      // Save results\n      await saveMatchResults(poolId, groups);\n      \n      // Broadcast to admins and users\n      await broadcastAdminAction(\n        poolId,\n        'pool_matched',\n        (req.user as User).id,\n        { groupCount: groups.length, totalMatched: groups.reduce((sum, g) => sum + g.members.length, 0) }\n      );\n      \n      res.json({ \n        message: \"Matching completed successfully\",\n        groupCount: groups.length,\n        totalMatched: groups.reduce((sum, g) => sum + g.members.length, 0),\n        groups: groups.map(g => ({\n          memberCount: g.members.length,\n          avgChemistryScore: g.avgChemistryScore,\n          diversityScore: g.diversityScore,\n          overallScore: g.overallScore,\n        }))\n      });\n    } catch (error: any) {\n      console.error(\"Error matching event pool:\", error);\n      res.status(500).json({ \n        message: \"Failed to match event pool\",\n        error: error.message \n      });\n    }\n  });\n\n  // ============ USER EVENT POOLS (ç”¨æˆ·ç«¯æ´»åŠ¨æ± ) ============\n  \n  // Get all active event pools (for DiscoverPage)\n  app.get(\"/api/event-pools\", async (req, res) => {\n    try {\n      const { city } = req.query;\n      \n      let whereClause = (pools: any, { eq, and }: any) => {\n        const conditions = [eq(pools.status, 'active')];\n        if (city) {\n          conditions.push(eq(pools.city, city));\n        }\n        return and(...conditions);\n      };\n\n      const pools = await db.query.eventPools.findMany({\n        where: whereClause,\n        orderBy: (eventPools, { asc }) => [asc(eventPools.dateTime)],\n      });\n\n      // Add registration counts\n      const poolsWithStats = await Promise.all(pools.map(async (pool: any) => {\n        const registrations = await db.query.eventPoolRegistrations.findMany({\n          where: (regs: any, { eq }: any) => eq(regs.poolId, pool.id)\n        });\n\n        return {\n          ...pool,\n          registrationCount: registrations.length,\n          spotsLeft: (pool.minGroupSize * pool.targetGroups) - registrations.length,\n        };\n      }));\n\n      res.json(poolsWithStats);\n    } catch (error) {\n      console.error(\"Error fetching event pools:\", error);\n      res.status(500).json({ message: \"Failed to fetch event pools\" });\n    }\n  });\n\n  // Get single event pool details\n  app.get(\"/api/event-pools/:id\", async (req, res) => {\n    try {\n      const pool = await db.query.eventPools.findFirst({\n        where: (pools, { eq }) => eq(pools.id, req.params.id),\n      });\n\n      if (!pool) {\n        return res.status(404).json({ message: \"Event pool not found\" });\n      }\n\n      // Get registration count\n      const registrations = await db.query.eventPoolRegistrations.findMany({\n        where: (regs, { eq }) => eq(regs.poolId, req.params.id)\n      });\n\n      res.json({\n        ...pool,\n        registrationCount: registrations.length,\n        spotsLeft: ((pool.minGroupSize || 4) * (pool.targetGroups || 1)) - registrations.length,\n      });\n    } catch (error) {\n      console.error(\"Error fetching event pool:\", error);\n      res.status(500).json({ message: \"Failed to fetch event pool\" });\n    }\n  });\n\n  // User register for event pool with preferences\n  app.post(\"/api/event-pools/:id/register\", requireAuth, async (req, res) => {\n    try {\n      const poolId = req.params.id;\n      const userId = (req.user as User).id;\n      const invitationCode = req.body.invitationCode;\n\n      // Check if pool exists and is active\n      const pool = await db.query.eventPools.findFirst({\n        where: (pools, { eq }) => eq(pools.id, poolId)\n      });\n\n      if (!pool) {\n        return res.status(404).json({ message: \"Event pool not found\" });\n      }\n\n      if (pool.status !== 'active') {\n        return res.status(400).json({ message: \"This event pool is no longer accepting registrations\" });\n      }\n\n      // Check if user already registered\n      const existingReg = await db.query.eventPoolRegistrations.findFirst({\n        where: (regs, { eq, and }) => and(\n          eq(regs.poolId, poolId),\n          eq(regs.userId, userId)\n        )\n      });\n\n      if (existingReg) {\n        return res.status(400).json({ message: \"You have already registered for this event pool\" });\n      }\n\n      // Check if user has active subscription\n      const subscription = await storage.getUserSubscription(userId);\n      if (!subscription) {\n        return res.status(403).json({ \n          message: \"Subscription required\",\n          requiresSubscription: true,\n          code: \"NO_ACTIVE_SUBSCRIPTION\"\n        });\n      }\n\n      // Validate invitation if provided\n      let inviterId: string | undefined;\n      if (invitationCode) {\n        const [invitation] = await db\n          .select()\n          .from(invitations)\n          .where(eq(invitations.code, invitationCode))\n          .limit(1);\n\n        if (!invitation) {\n          return res.status(400).json({ message: \"Invalid invitation code\" });\n        }\n\n        // Check if invitation expired\n        if (invitation.expiresAt && new Date(invitation.expiresAt) < new Date()) {\n          return res.status(410).json({ message: \"Invitation has expired\" });\n        }\n\n        // Verify invitation is for a pool, not a specific event\n        if (invitation.invitationType !== 'pre_match') {\n          return res.status(400).json({ message: \"This invitation is not valid for pool registration\" });\n        }\n\n        inviterId = invitation.inviterId;\n      }\n\n      // Validate preferences\n      const validatedData = insertEventPoolRegistrationSchema.parse({\n        poolId,\n        userId,\n        budgetRange: req.body.budgetRange || [],\n        preferredLanguages: req.body.preferredLanguages || [],\n        socialGoals: req.body.socialGoals || [],\n        cuisinePreferences: req.body.cuisinePreferences || [],\n        dietaryRestrictions: req.body.dietaryRestrictions || [],\n        tasteIntensity: req.body.tasteIntensity || 'medium',\n        matchStatus: 'pending',\n      });\n\n      // Create registration\n      const [registration] = await db\n        .insert(eventPoolRegistrations)\n        .values(validatedData)\n        .returning();\n\n      // Record invitation use if invitation was provided\n      if (invitationCode && inviterId) {\n        await db.insert(invitationUses).values({\n          invitationId: invitationCode,\n          inviteeId: userId,\n          poolRegistrationId: registration.id,\n        });\n\n        // Increment acceptance count on invitation\n        await db.update(invitations)\n          .set({ totalAcceptances: db.raw('total_acceptances + 1') })\n          .where(eq(invitations.code, invitationCode));\n      }\n\n      // Trigger realtime matching scan after registration\n      // Import at top: import { scanPoolAndMatch } from \"./poolRealtimeMatchingService\";\n      const { scanPoolAndMatch } = await import(\"./poolRealtimeMatchingService\");\n      \n      // Async trigger (don't block response)\n      scanPoolAndMatch(poolId, \"realtime\", \"user_registration\").catch(err => {\n        console.error(`[Realtime Matching] Scan failed after registration:`, err);\n      });\n\n      res.json(registration);\n    } catch (error: any) {\n      console.error(\"Error registering for event pool:\", error);\n      res.status(500).json({ \n        message: \"Failed to register for event pool\",\n        error: error.message \n      });\n    }\n  });\n\n  // Get user's pool registrations\n  app.get(\"/api/my-pool-registrations\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req.user as User).id;\n\n      const registrations = await db\n        .select({\n          id: eventPoolRegistrations.id,\n          poolId: eventPoolRegistrations.poolId,\n          budgetRange: eventPoolRegistrations.budgetRange,\n          preferredLanguages: eventPoolRegistrations.preferredLanguages,\n          socialGoals: eventPoolRegistrations.socialGoals,\n          matchStatus: eventPoolRegistrations.matchStatus,\n          assignedGroupId: eventPoolRegistrations.assignedGroupId,\n          matchScore: eventPoolRegistrations.matchScore,\n          registeredAt: eventPoolRegistrations.registeredAt,\n          // Pool details\n          poolTitle: eventPools.title,\n          poolEventType: eventPools.eventType,\n          poolCity: eventPools.city,\n          poolDistrict: eventPools.district,\n          poolDateTime: eventPools.dateTime,\n          poolStatus: eventPools.status,\n        })\n        .from(eventPoolRegistrations)\n        .innerJoin(eventPools, eq(eventPoolRegistrations.poolId, eventPools.id))\n        .where(eq(eventPoolRegistrations.userId, userId))\n        .orderBy(desc(eventPoolRegistrations.registeredAt));\n\n      // Enrich with invitation relationship info\n      const enrichedRegistrations = await Promise.all(\n        registrations.map(async (reg) => {\n          // Check if user was invited (is invitee)\n          const [inviteUse] = await db\n            .select()\n            .from(invitationUses)\n            .where(eq(invitationUses.poolRegistrationId, reg.id))\n            .limit(1);\n          \n          let invitationRole: \"inviter\" | \"invitee\" | null = null;\n          let relatedUserName: string | null = null;\n          \n          if (inviteUse && inviteUse.invitationId) {\n            // User is invitee, get inviter info\n            const [invitation] = await db\n              .select()\n              .from(invitations)\n              .where(eq(invitations.code, inviteUse.invitationId))\n              .limit(1);\n            \n            if (invitation) {\n              const [inviter] = await db\n                .select({ firstName: users.firstName, lastName: users.lastName })\n                .from(users)\n                .where(eq(users.id, invitation.inviterId))\n                .limit(1);\n              \n              if (inviter) {\n                invitationRole = \"invitee\";\n                relatedUserName = `${inviter.firstName || ''} ${inviter.lastName || ''}`.trim() || \"å¥½å‹\";\n              }\n            }\n          } else {\n            // Check if user is inviter (someone used their invitation for this pool)\n            const userInvitations = await db\n              .select({ code: invitations.code })\n              .from(invitations)\n              .where(eq(invitations.inviterId, userId))\n              .limit(10);\n            \n            if (userInvitations.length > 0) {\n              const codes = userInvitations.map(inv => inv.code);\n              const [relatedInviteUse] = await db\n                .select({\n                  inviteeId: invitationUses.inviteeId\n                })\n                .from(invitationUses)\n                .innerJoin(\n                  eventPoolRegistrations,\n                  eq(invitationUses.poolRegistrationId, eventPoolRegistrations.id)\n                )\n                .where(\n                  and(\n                    inArray(invitationUses.invitationId, codes),\n                    eq(eventPoolRegistrations.poolId, reg.poolId)\n                  )\n                )\n                .limit(1);\n              \n              if (relatedInviteUse) {\n                const [invitee] = await db\n                  .select({ firstName: users.firstName, lastName: users.lastName })\n                  .from(users)\n                  .where(eq(users.id, relatedInviteUse.inviteeId))\n                  .limit(1);\n                \n                if (invitee) {\n                  invitationRole = \"inviter\";\n                  relatedUserName = `${invitee.firstName || ''} ${invitee.lastName || ''}`.trim() || \"å¥½å‹\";\n                }\n              }\n            }\n          }\n          \n          return {\n            ...reg,\n            invitationRole,\n            relatedUserName\n          };\n        })\n      );\n\n      res.json(enrichedRegistrations);\n    } catch (error) {\n      console.error(\"Error fetching user pool registrations:\", error);\n      res.status(500).json({ message: \"Failed to fetch registrations\" });\n    }\n  });\n\n  // Cancel pool registration (only pending registrations)\n  app.delete(\"/api/pool-registrations/:id\", requireAuth, async (req, res) => {\n    try {\n      const registrationId = req.params.id;\n      const userId = (req.user as User).id;\n\n      // Get registration to verify ownership and status\n      const registration = await db.query.eventPoolRegistrations.findFirst({\n        where: (regs, { eq }) => eq(regs.id, registrationId),\n      });\n\n      if (!registration) {\n        return res.status(404).json({ message: \"Registration not found\" });\n      }\n\n      // Verify user owns this registration\n      if (registration.userId !== userId) {\n        return res.status(403).json({ message: \"You can only cancel your own registrations\" });\n      }\n\n      // Only allow cancellation of pending registrations\n      if (registration.matchStatus !== \"pending\") {\n        return res.status(400).json({ \n          message: \"Cannot cancel registration after matching\",\n          code: \"ALREADY_MATCHED\"\n        });\n      }\n\n      // Delete the registration\n      await db\n        .delete(eventPoolRegistrations)\n        .where(eq(eventPoolRegistrations.id, registrationId));\n\n      res.json({ message: \"Registration cancelled successfully\" });\n    } catch (error) {\n      console.error(\"Error cancelling pool registration:\", error);\n      res.status(500).json({ message: \"Failed to cancel registration\" });\n    }\n  });\n\n  // Get pool group details (members + activity info)\n  app.get(\"/api/pool-groups/:groupId\", requireAuth, async (req, res) => {\n    try {\n      const groupId = req.params.groupId;\n      const userId = (req.user as User).id;\n\n      // Get group info\n      const group = await db.query.eventPoolGroups.findFirst({\n        where: (groups, { eq }) => eq(groups.id, groupId),\n      });\n\n      if (!group) {\n        return res.status(404).json({ message: \"Group not found\" });\n      }\n\n      // Get pool info\n      const pool = await db.query.eventPools.findFirst({\n        where: (pools, { eq }) => eq(pools.id, group.poolId),\n      });\n\n      if (!pool) {\n        return res.status(404).json({ message: \"Event pool not found\" });\n      }\n\n      // Check if user is in this group\n      const userRegistration = await db.query.eventPoolRegistrations.findFirst({\n        where: (regs, { eq, and }) => and(\n          eq(regs.assignedGroupId, groupId),\n          eq(regs.userId, userId)\n        ),\n      });\n\n      if (!userRegistration) {\n        return res.status(403).json({ message: \"You are not a member of this group\" });\n      }\n\n      // Get all group members with their profile info\n      const members = await db\n        .select({\n          userId: users.id,\n          displayName: users.displayName,\n          archetype: users.archetype,\n          topInterests: users.interestsRankedTop3,\n          age: users.birthdate,\n          industry: users.industry,\n          ageVisible: users.ageVisible,\n          industryVisible: users.industryVisible,\n          gender: users.gender,\n          educationLevel: users.educationLevel,\n          hometownCountry: users.hometownCountry,\n          hometownRegionCity: users.hometownRegionCity,\n          hometownAffinityOptin: users.hometownAffinityOptin,\n          educationVisible: users.educationVisible,\n          relationshipStatus: users.relationshipStatus,\n          children: users.children,\n          studyLocale: users.studyLocale,\n          overseasRegions: users.overseasRegions,\n          seniority: users.seniority,\n          fieldOfStudy: users.fieldOfStudy,\n          languagesComfort: users.languagesComfort,\n          // Event-specific preferences from registration\n          intent: eventPoolRegistrations.socialGoals,\n        })\n        .from(eventPoolRegistrations)\n        .innerJoin(users, eq(eventPoolRegistrations.userId, users.id))\n        .where(eq(eventPoolRegistrations.assignedGroupId, groupId));\n\n      res.json({\n        group: {\n          id: group.id,\n          groupNumber: group.groupNumber,\n          memberCount: group.memberCount,\n          matchScore: group.overallScore,\n          matchExplanation: group.matchExplanation,\n          venueName: group.venueName,\n          venueAddress: group.venueAddress,\n          finalDateTime: group.finalDateTime,\n          status: group.status,\n        },\n        pool: {\n          id: pool.id,\n          title: pool.title,\n          description: pool.description,\n          eventType: pool.eventType,\n          city: pool.city,\n          district: pool.district,\n          dateTime: pool.dateTime,\n        },\n        members,\n      });\n    } catch (error) {\n      console.error(\"Error fetching pool group details:\", error);\n      res.status(500).json({ message: \"Failed to fetch group details\" });\n    }\n  });\n\n  // Finance - Get statistics\n  app.get(\"/api/admin/finance/stats\", requireAdmin, async (req, res) => {\n    try {\n      const stats = await storage.getFinanceStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching finance stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch finance stats\" });\n    }\n  });\n\n  // Finance - Get all payments\n  app.get(\"/api/admin/finance/payments\", requireAdmin, async (req, res) => {\n    try {\n      const { type } = req.query;\n      const payments = type \n        ? await storage.getPaymentsByType(type as string)\n        : await storage.getAllPayments();\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error fetching payments:\", error);\n      res.status(500).json({ message: \"Failed to fetch payments\" });\n    }\n  });\n\n  // Finance - Get venue commissions\n  app.get(\"/api/admin/finance/commissions\", requireAdmin, async (req, res) => {\n    try {\n      const commissions = await storage.getVenueCommissions();\n      res.json(commissions);\n    } catch (error) {\n      console.error(\"Error fetching commissions:\", error);\n      res.status(500).json({ message: \"Failed to fetch commissions\" });\n    }\n  });\n\n  // Moderation - Get statistics\n  app.get(\"/api/admin/moderation/stats\", requireAdmin, async (req, res) => {\n    try {\n      const stats = await storage.getModerationStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching moderation stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch moderation stats\" });\n    }\n  });\n\n  // Moderation - Get all reports\n  app.get(\"/api/admin/moderation/reports\", requireAdmin, async (req, res) => {\n    try {\n      const { status } = req.query;\n      const reports = status === 'pending' \n        ? await storage.getPendingReports()\n        : await storage.getAllReports();\n      res.json(reports);\n    } catch (error) {\n      console.error(\"Error fetching reports:\", error);\n      res.status(500).json({ message: \"Failed to fetch reports\" });\n    }\n  });\n\n  // Moderation - Update report status\n  app.patch(\"/api/admin/moderation/reports/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { status, adminNotes } = req.body;\n      const report = await storage.updateReportStatus(req.params.id, status, adminNotes);\n      res.json(report);\n    } catch (error) {\n      console.error(\"Error updating report:\", error);\n      res.status(500).json({ message: \"Failed to update report\" });\n    }\n  });\n\n  // Moderation - Create moderation log\n  app.post(\"/api/admin/moderation/logs\", requireAdmin, async (req, res) => {\n    try {\n      const session = req.session as any;\n      const log = await storage.createModerationLog({\n        adminId: session.userId,\n        action: req.body.action,\n        targetUserId: req.body.targetUserId,\n        reason: req.body.reason,\n        notes: req.body.notes,\n      });\n      res.json(log);\n    } catch (error) {\n      console.error(\"Error creating moderation log:\", error);\n      res.status(500).json({ message: \"Failed to create moderation log\" });\n    }\n  });\n\n  // Moderation - Get moderation logs\n  app.get(\"/api/admin/moderation/logs\", requireAdmin, async (req, res) => {\n    try {\n      const logs = await storage.getModerationLogs();\n      res.json(logs);\n    } catch (error) {\n      console.error(\"Error fetching moderation logs:\", error);\n      res.status(500).json({ message: \"Failed to fetch moderation logs\" });\n    }\n  });\n\n  // Data Insights - Get analytics data\n  app.get(\"/api/admin/insights\", requireAdmin, async (req, res) => {\n    try {\n      const insights = await storage.getInsightsData();\n      res.json(insights);\n    } catch (error) {\n      console.error(\"Error fetching insights:\", error);\n      res.status(500).json({ message: \"Failed to fetch insights\" });\n    }\n  });\n\n  // ============ ADMIN FEEDBACK MANAGEMENT ============\n\n  // Get all feedbacks with filters\n  app.get(\"/api/admin/feedback\", requireAdmin, async (req, res) => {\n    try {\n      const { eventId, minRating, maxRating, startDate, endDate, hasDeepFeedback } = req.query;\n      \n      const filters: any = {};\n      if (eventId) filters.eventId = eventId as string;\n      if (minRating) filters.minRating = parseInt(minRating as string);\n      if (maxRating) filters.maxRating = parseInt(maxRating as string);\n      if (startDate) filters.startDate = new Date(startDate as string);\n      if (endDate) filters.endDate = new Date(endDate as string);\n      if (hasDeepFeedback !== undefined) filters.hasDeepFeedback = hasDeepFeedback === 'true';\n      \n      const feedbacks = await storage.getAllFeedbacks(filters);\n      res.json(feedbacks);\n    } catch (error) {\n      console.error(\"Error fetching feedbacks:\", error);\n      res.status(500).json({ message: \"Failed to fetch feedbacks\" });\n    }\n  });\n\n  // Get feedback stats\n  app.get(\"/api/admin/feedback/stats\", requireAdmin, async (req, res) => {\n    try {\n      const stats = await storage.getFeedbackStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching feedback stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch feedback stats\" });\n    }\n  });\n\n  // Get single feedback by ID\n  app.get(\"/api/admin/feedback/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const feedback = await storage.getFeedbackById(id);\n      \n      if (!feedback) {\n        return res.status(404).json({ message: \"Feedback not found\" });\n      }\n      \n      res.json(feedback);\n    } catch (error) {\n      console.error(\"Error fetching feedback:\", error);\n      res.status(500).json({ message: \"Failed to fetch feedback\" });\n    }\n  });\n\n  // ============ CONTENT MANAGEMENT ============\n\n  // Get all contents (with optional type filter)\n  app.get(\"/api/admin/contents\", requireAdmin, async (req, res) => {\n    try {\n      const { type } = req.query;\n      const contents = await storage.getAllContents(type as string | undefined);\n      res.json(contents);\n    } catch (error) {\n      console.error(\"Error fetching contents:\", error);\n      res.status(500).json({ message: \"Failed to fetch contents\" });\n    }\n  });\n\n  // Get single content\n  app.get(\"/api/admin/contents/:id\", requireAdmin, async (req, res) => {\n    try {\n      const content = await storage.getContent(req.params.id);\n      if (!content) {\n        return res.status(404).json({ message: \"Content not found\" });\n      }\n      res.json(content);\n    } catch (error) {\n      console.error(\"Error fetching content:\", error);\n      res.status(500).json({ message: \"Failed to fetch content\" });\n    }\n  });\n\n  // Create content\n  app.post(\"/api/admin/contents\", requireAdmin, async (req, res) => {\n    try {\n      const session = req.session as any;\n      const content = await storage.createContent({\n        ...req.body,\n        createdBy: session.userId,\n      });\n      res.json(content);\n    } catch (error) {\n      console.error(\"Error creating content:\", error);\n      res.status(500).json({ message: \"Failed to create content\" });\n    }\n  });\n\n  // Update content\n  app.patch(\"/api/admin/contents/:id\", requireAdmin, async (req, res) => {\n    try {\n      const content = await storage.updateContent(req.params.id, req.body);\n      res.json(content);\n    } catch (error) {\n      console.error(\"Error updating content:\", error);\n      res.status(500).json({ message: \"Failed to update content\" });\n    }\n  });\n\n  // Delete content\n  app.delete(\"/api/admin/contents/:id\", requireAdmin, async (req, res) => {\n    try {\n      await storage.deleteContent(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting content:\", error);\n      res.status(500).json({ message: \"Failed to delete content\" });\n    }\n  });\n\n  // Publish content (update status to published and set published_at)\n  app.post(\"/api/admin/contents/:id/publish\", requireAdmin, async (req, res) => {\n    try {\n      const session = req.session as any;\n      const adminId = session.userId;\n      const { sendNotification } = req.body;\n\n      const content = await storage.updateContent(req.params.id, {\n        status: 'published',\n        publishedAt: new Date(),\n      });\n\n      // If sendNotification is true and content type is announcement, send notification to all users\n      if (sendNotification && content.type === 'announcement') {\n        const users = await storage.getAllUsers();\n        const userIds = users.map(u => u.id);\n        \n        if (userIds.length > 0) {\n          await storage.createBroadcastNotification({\n            sentBy: adminId,\n            category: 'discover',\n            type: 'admin_announcement',\n            title: content.title,\n            message: content.content?.substring(0, 100), // Limit to 100 characters\n            userIds,\n          });\n        }\n      }\n\n      res.json(content);\n    } catch (error) {\n      console.error(\"Error publishing content:\", error);\n      res.status(500).json({ message: \"Failed to publish content\" });\n    }\n  });\n\n  // Get published contents (public endpoint for users)\n  app.get(\"/api/contents/:type\", async (req, res) => {\n    try {\n      const contents = await storage.getPublishedContents(req.params.type);\n      res.json(contents);\n    } catch (error) {\n      console.error(\"Error fetching published contents:\", error);\n      res.status(500).json({ message: \"Failed to fetch contents\" });\n    }\n  });\n\n  // ============ ADMIN NOTIFICATION MANAGEMENT ============\n\n  // Get admin notification history\n  app.get(\"/api/admin/notifications\", requireAdmin, async (req, res) => {\n    try {\n      const session = req.session as any;\n      const adminId = session.userId;\n      \n      const notifications = await storage.getAdminNotifications(adminId);\n      res.json({ notifications });\n    } catch (error) {\n      console.error(\"Error fetching admin notifications:\", error);\n      res.status(500).json({ message: \"Failed to fetch notifications\" });\n    }\n  });\n\n  // Broadcast notification to multiple users\n  app.post(\"/api/admin/notifications/broadcast\", requireAdmin, async (req, res) => {\n    try {\n      const session = req.session as any;\n      const adminId = session.userId;\n      \n      const { category, type, title, message, userIds } = req.body;\n      \n      if (!category || !type || !title || !userIds || !Array.isArray(userIds)) {\n        return res.status(400).json({ message: \"Missing required fields\" });\n      }\n      \n      const result = await storage.createBroadcastNotification({\n        sentBy: adminId,\n        category,\n        type,\n        title,\n        message,\n        userIds,\n      });\n      \n      res.json({ success: true, sent: result.sent });\n    } catch (error) {\n      console.error(\"Error broadcasting notification:\", error);\n      res.status(500).json({ message: \"Failed to broadcast notification\" });\n    }\n  });\n\n  // Send notification to a single user\n  app.post(\"/api/admin/notifications/send\", requireAdmin, async (req, res) => {\n    try {\n      const session = req.session as any;\n      const adminId = session.userId;\n      \n      const { userId, category, type, title, message } = req.body;\n      \n      if (!userId || !category || !type || !title) {\n        return res.status(400).json({ message: \"Missing required fields\" });\n      }\n      \n      const result = await storage.createBroadcastNotification({\n        sentBy: adminId,\n        category,\n        type,\n        title,\n        message,\n        userIds: [userId],\n      });\n      \n      res.json({ success: true, sent: result.sent });\n    } catch (error) {\n      console.error(\"Error sending notification:\", error);\n      res.status(500).json({ message: \"Failed to send notification\" });\n    }\n  });\n\n  // Get notification stats\n  app.get(\"/api/admin/notifications/:id/stats\", requireAdmin, async (req, res) => {\n    try {\n      const stats = await storage.getNotificationStats(req.params.id);\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching notification stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch stats\" });\n    }\n  });\n\n  // ============ SUBSCRIPTION MANAGEMENT ============\n  \n  // Get current user's subscription status\n  app.get(\"/api/subscription/status\", isPhoneAuthenticated, async (req, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const status = await subscriptionService.getUserSubscriptionStatus(userId);\n      res.json(status);\n    } catch (error) {\n      console.error(\"Error fetching subscription status:\", error);\n      res.status(500).json({ message: \"Failed to fetch subscription status\" });\n    }\n  });\n  \n  // Create subscription renewal (returns payment details)\n  app.post(\"/api/subscription/renew\", isPhoneAuthenticated, async (req, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const { planType, couponCode } = req.body;\n      \n      if (!planType || ![\"monthly\", \"quarterly\"].includes(planType)) {\n        return res.status(400).json({ message: \"Invalid plan type\" });\n      }\n      \n      // Create pending subscription\n      const renewalData = await subscriptionService.renewSubscription(userId, planType);\n      \n      // Create payment for the renewal\n      let couponId: string | undefined;\n      if (couponCode) {\n        const coupons = await storage.getAllCoupons();\n        const coupon = coupons.find(c => c.code === couponCode && c.isActive);\n        if (coupon) {\n          couponId = coupon.id;\n        }\n      }\n      \n      const paymentResult = await paymentService.createPayment({\n        userId,\n        paymentType: \"subscription\",\n        relatedId: renewalData.subscriptionId,\n        originalAmount: renewalData.amount,\n        couponId,\n      });\n      \n      res.json({\n        subscription: renewalData,\n        payment: paymentResult,\n      });\n    } catch (error) {\n      console.error(\"Error renewing subscription:\", error);\n      res.status(500).json({ message: \"Failed to renew subscription\" });\n    }\n  });\n  \n  // Cancel subscription\n  app.post(\"/api/subscription/cancel\", isPhoneAuthenticated, async (req, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const subscription = await storage.getUserSubscription(userId);\n      if (!subscription) {\n        return res.status(404).json({ message: \"No active subscription found\" });\n      }\n      \n      await subscriptionService.cancelSubscription(subscription.id, req.body.reason);\n      res.json({ message: \"Subscription cancelled\" });\n    } catch (error) {\n      console.error(\"Error cancelling subscription:\", error);\n      res.status(500).json({ message: \"Failed to cancel subscription\" });\n    }\n  });\n\n  // ============ PAYMENT & WEBHOOKS ============\n  \n  // Create payment order for subscription\n  app.post(\"/api/payments/create\", isPhoneAuthenticated, async (req, res) => {\n    try {\n      const userId = req.session.userId;\n      if (!userId) {\n        return res.status(401).json({ message: \"Unauthorized\" });\n      }\n      \n      const { paymentType, relatedId, originalAmount, couponCode } = req.body;\n      \n      // Validate coupon if provided\n      let couponId: string | undefined;\n      if (couponCode) {\n        const coupons = await storage.getAllCoupons();\n        const coupon = coupons.find(c => c.code === couponCode && c.isActive);\n        if (coupon) {\n          couponId = coupon.id;\n        }\n      }\n      \n      const paymentResult = await paymentService.createPayment({\n        userId,\n        paymentType,\n        relatedId,\n        originalAmount,\n        couponId,\n      });\n      \n      res.json(paymentResult);\n    } catch (error) {\n      console.error(\"Error creating payment:\", error);\n      res.status(500).json({ message: \"Failed to create payment\" });\n    }\n  });\n  \n  // WeChat Pay webhook - receives payment status updates\n  app.post(\"/api/webhooks/wechat-pay\", async (req, res) => {\n    try {\n      await paymentService.handleWebhook(req.body);\n      res.json({ code: \"SUCCESS\", message: \"OK\" });\n    } catch (error) {\n      console.error(\"Error processing WeChat Pay webhook:\", error);\n      res.status(500).json({ code: \"FAIL\", message: \"Internal server error\" });\n    }\n  });\n  \n  // Query payment status\n  app.get(\"/api/payments/:wechatOrderId/status\", isPhoneAuthenticated, async (req, res) => {\n    try {\n      const { wechatOrderId } = req.params;\n      const status = await paymentService.queryPaymentStatus(wechatOrderId);\n      res.json({ status });\n    } catch (error) {\n      console.error(\"Error querying payment status:\", error);\n      res.status(500).json({ message: \"Failed to query payment status\" });\n    }\n  });\n  \n  // Admin - Get all payments\n  app.get(\"/api/admin/payments\", requireAdmin, async (req, res) => {\n    try {\n      const payments = await storage.getAllPayments();\n      res.json(payments);\n    } catch (error) {\n      console.error(\"Error fetching payments:\", error);\n      res.status(500).json({ message: \"Failed to fetch payments\" });\n    }\n  });\n  \n  // Admin - Create refund\n  app.post(\"/api/admin/payments/:paymentId/refund\", requireAdmin, async (req, res) => {\n    try {\n      const { paymentId } = req.params;\n      const { reason } = req.body;\n      await paymentService.createRefund(paymentId, reason);\n      res.json({ message: \"Refund initiated\" });\n    } catch (error) {\n      console.error(\"Error creating refund:\", error);\n      res.status(500).json({ message: \"Failed to create refund\" });\n    }\n  });\n\n  // ============ VENUE MATCHING ============\n  \n  // Find matching venues for event criteria\n  app.post(\"/api/venues/match\", isPhoneAuthenticated, async (req, res) => {\n    try {\n      const { eventType, theme, participantCount, preferredDistrict, preferredCity, cuisinePreferences, priceRange } = req.body;\n      \n      if (!eventType || !participantCount) {\n        return res.status(400).json({ message: \"eventType and participantCount are required\" });\n      }\n      \n      const matches = await venueMatchingService.findMatchingVenues({\n        eventType,\n        theme,\n        participantCount,\n        preferredDistrict,\n        preferredCity,\n        cuisinePreferences,\n        priceRange,\n      });\n      \n      res.json({ venues: matches });\n    } catch (error) {\n      console.error(\"Error matching venues:\", error);\n      res.status(500).json({ message: \"Failed to match venues\" });\n    }\n  });\n  \n  // Get best venue for event\n  app.post(\"/api/venues/select-best\", isPhoneAuthenticated, async (req, res) => {\n    try {\n      const { eventType, theme, participantCount, preferredDistrict, preferredCity, cuisinePreferences, priceRange } = req.body;\n      \n      if (!eventType || !participantCount) {\n        return res.status(400).json({ message: \"eventType and participantCount are required\" });\n      }\n      \n      const bestMatch = await venueMatchingService.selectBestVenue({\n        eventType,\n        theme,\n        participantCount,\n        preferredDistrict,\n        preferredCity,\n        cuisinePreferences,\n        priceRange,\n      });\n      \n      if (!bestMatch) {\n        return res.status(404).json({ message: \"No suitable venue found\" });\n      }\n      \n      res.json(bestMatch);\n    } catch (error) {\n      console.error(\"Error selecting venue:\", error);\n      res.status(500).json({ message: \"Failed to select venue\" });\n    }\n  });\n\n  // ============ MATCHING ALGORITHM ENDPOINTS ============\n  \n  // Calculate match score between two users\n  app.post(\"/api/matching/calculate-pair\", requireAdmin, async (req, res) => {\n    try {\n      const { userId1, userId2, weights } = req.body;\n      \n      if (!userId1 || !userId2) {\n        return res.status(400).json({ message: \"userId1 and userId2 are required\" });\n      }\n      \n      const user1 = await storage.getUserById(userId1);\n      const user2 = await storage.getUserById(userId2);\n      \n      if (!user1 || !user2) {\n        return res.status(404).json({ message: \"One or both users not found\" });\n      }\n      \n      const matchWeights: MatchingWeights = weights || DEFAULT_WEIGHTS;\n      const score = calculateUserMatchScore(user1, user2, matchWeights);\n      \n      res.json(score);\n    } catch (error) {\n      console.error(\"Error calculating match score:\", error);\n      res.status(500).json({ message: \"Failed to calculate match score\" });\n    }\n  });\n  \n  // Match users to groups (ä¸»åŒ¹é…ç®—æ³•)\n  app.post(\"/api/matching/create-groups\", requireAdmin, async (req, res) => {\n    try {\n      const { userIds, config } = req.body;\n      \n      if (!userIds || !Array.isArray(userIds) || userIds.length === 0) {\n        return res.status(400).json({ message: \"userIds array is required\" });\n      }\n      \n      // è·å–æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯\n      const users = await Promise.all(\n        userIds.map(id => storage.getUserById(id))\n      );\n      \n      const validUsers = users.filter((u): u is User => u !== undefined);\n      \n      if (validUsers.length < (config?.minGroupSize || 5)) {\n        return res.status(400).json({ \n          message: `è‡³å°‘éœ€è¦${config?.minGroupSize || 5}ä¸ªæœ‰æ•ˆç”¨æˆ·` \n        });\n      }\n      \n      const startTime = Date.now();\n      const groups = matchUsersToGroups(validUsers, config);\n      const executionTime = Date.now() - startTime;\n      \n      res.json({\n        groups,\n        totalUsers: validUsers.length,\n        groupCount: groups.length,\n        executionTimeMs: executionTime,\n      });\n    } catch (error: any) {\n      console.error(\"Error creating groups:\", error);\n      res.status(500).json({ message: error.message || \"Failed to create groups\" });\n    }\n  });\n  \n  // Get current matching configuration\n  app.get(\"/api/matching/config\", requireAdmin, async (req, res) => {\n    try {\n      // ä»æ•°æ®åº“è·å–æ´»è·ƒé…ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›é»˜è®¤é…ç½®\n      const activeConfig = await storage.getActiveMatchingConfig();\n      \n      if (activeConfig) {\n        res.json(activeConfig);\n      } else {\n        res.json({\n          configName: \"default\",\n          personalityWeight: 30,\n          interestsWeight: 25,\n          intentWeight: 20,\n          backgroundWeight: 15,\n          cultureWeight: 10,\n          minGroupSize: 5,\n          maxGroupSize: 10,\n          preferredGroupSize: 7,\n          maxSameArchetypeRatio: 40,\n          minChemistryScore: 60,\n          isActive: true,\n        });\n      }\n    } catch (error) {\n      console.error(\"Error getting matching config:\", error);\n      res.status(500).json({ message: \"Failed to get matching config\" });\n    }\n  });\n  \n  // Update matching configuration (Admin only)\n  app.post(\"/api/matching/config\", requireAdmin, async (req, res) => {\n    try {\n      \n      const config = req.body;\n      \n      // éªŒè¯æƒé‡\n      const validation = validateWeights({\n        personalityWeight: config.personalityWeight,\n        interestsWeight: config.interestsWeight,\n        intentWeight: config.intentWeight,\n        backgroundWeight: config.backgroundWeight,\n        cultureWeight: config.cultureWeight,\n      });\n      \n      if (!validation.valid) {\n        return res.status(400).json({ message: validation.error });\n      }\n      \n      const updatedConfig = await storage.updateMatchingConfig(config);\n      res.json(updatedConfig);\n    } catch (error) {\n      console.error(\"Error updating matching config:\", error);\n      res.status(500).json({ message: \"Failed to update matching config\" });\n    }\n  });\n  \n  // Test matching scenario (Admin only - for algorithm tuning)\n  app.post(\"/api/matching/test-scenario\", requireAdmin, async (req, res) => {\n    try {\n      \n      const { userIds, config } = req.body;\n      \n      if (!userIds || !Array.isArray(userIds)) {\n        return res.status(400).json({ message: \"userIds array is required\" });\n      }\n      \n      const users = await Promise.all(\n        userIds.map(id => storage.getUserById(id))\n      );\n      \n      const validUsers = users.filter((u): u is User => u !== undefined);\n      \n      const startTime = Date.now();\n      const groups = matchUsersToGroups(validUsers, config);\n      const executionTime = Date.now() - startTime;\n      \n      // è®¡ç®—æ•´ä½“è¯„åˆ†æŒ‡æ ‡\n      const avgChemistryScore = Math.round(\n        groups.reduce((sum, g) => sum + g.avgChemistryScore, 0) / groups.length\n      );\n      const avgDiversityScore = Math.round(\n        groups.reduce((sum, g) => sum + g.diversityScore, 0) / groups.length\n      );\n      const overallMatchQuality = Math.round((avgChemistryScore + avgDiversityScore) / 2);\n      \n      // ä¿å­˜æµ‹è¯•ç»“æœåˆ°æ•°æ®åº“\n      const result = await storage.saveMatchingResult({\n        userIds,\n        userCount: validUsers.length,\n        groups: groups.map(g => ({\n          groupId: g.groupId,\n          userIds: g.userIds,\n          chemistryScore: g.avgChemistryScore,\n          diversityScore: g.diversityScore,\n          overallScore: g.overallScore,\n        })),\n        groupCount: groups.length,\n        avgChemistryScore,\n        avgDiversityScore,\n        overallMatchQuality,\n        executionTimeMs: executionTime,\n        isTestRun: true,\n        configId: config?.configId,\n        notes: config?.notes,\n      });\n      \n      res.json({\n        testId: result.id,\n        groups,\n        metrics: {\n          totalUsers: validUsers.length,\n          groupCount: groups.length,\n          avgChemistryScore,\n          avgDiversityScore,\n          overallMatchQuality,\n          executionTimeMs: executionTime,\n        },\n      });\n    } catch (error: any) {\n      console.error(\"Error testing matching scenario:\", error);\n      res.status(500).json({ message: error.message || \"Failed to test matching scenario\" });\n    }\n  });\n\n  // ============ CHAT REPORTS & MODERATION ROUTES ============\n  \n  // POST /api/chat-reports - User creates a report\n  app.post(\"/api/chat-reports\", isPhoneAuthenticated, async (req, res) => {\n    try {\n      const session = req.session as any;\n      const userId = session.userId;\n      \n      const validatedData = insertChatReportSchema.parse(req.body);\n      \n      const report = await storage.createChatReport(validatedData);\n      \n      res.json(report);\n    } catch (error: any) {\n      console.error(\"Error creating chat report:\", error);\n      res.status(400).json({ message: error.message || \"Failed to create report\" });\n    }\n  });\n\n  // GET /api/admin/chat-reports - Admin gets all reports with optional status filter\n  app.get(\"/api/admin/chat-reports\", requireAdmin, async (req, res) => {\n    try {\n      const { status } = req.query;\n      \n      const reports = await storage.getChatReports(status as string | undefined);\n      \n      res.json(reports);\n    } catch (error: any) {\n      console.error(\"Error fetching chat reports:\", error);\n      res.status(500).json({ message: \"Failed to fetch reports\" });\n    }\n  });\n\n  // GET /api/admin/chat-reports/:id - Admin gets single report with context\n  app.get(\"/api/admin/chat-reports/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const session = req.session as any;\n      const adminUserId = session.userId;\n      \n      const report = await storage.getChatReport(id);\n      \n      if (!report) {\n        return res.status(404).json({ message: \"Report not found\" });\n      }\n      \n      // Record moderation log for viewing the report\n      await storage.createModerationLog({\n        adminUserId,\n        action: \"view_report\",\n        targetType: \"chat_report\",\n        targetId: id,\n        details: { reportId: id, reportType: report.reportType },\n      });\n      \n      res.json(report);\n    } catch (error: any) {\n      console.error(\"Error fetching chat report:\", error);\n      res.status(500).json({ message: \"Failed to fetch report\" });\n    }\n  });\n\n  // PATCH /api/admin/chat-reports/:id - Admin reviews/processes a report\n  app.patch(\"/api/admin/chat-reports/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const session = req.session as any;\n      const adminUserId = session.userId;\n      \n      const { status, reviewNotes, actionTaken } = req.body;\n      \n      if (!status || ![\"reviewed\", \"dismissed\", \"action_taken\"].includes(status)) {\n        return res.status(400).json({ message: \"Invalid status\" });\n      }\n      \n      const report = await storage.updateChatReport(id, {\n        status,\n        reviewedBy: adminUserId,\n        reviewNotes,\n        actionTaken,\n      });\n      \n      // Record moderation log\n      await storage.createModerationLog({\n        adminUserId,\n        action: \"review_report\",\n        targetType: \"chat_report\",\n        targetId: id,\n        details: { \n          reportId: id, \n          status, \n          actionTaken,\n          reviewNotes: reviewNotes || null,\n        },\n      });\n      \n      res.json(report);\n    } catch (error: any) {\n      console.error(\"Error updating chat report:\", error);\n      res.status(400).json({ message: error.message || \"Failed to update report\" });\n    }\n  });\n\n  // ============ CHAT LOGS ROUTES ============\n  \n  // POST /api/chat-logs - Internal logging endpoint\n  app.post(\"/api/chat-logs\", async (req, res) => {\n    try {\n      const validatedData = insertChatLogSchema.parse(req.body);\n      \n      const log = await storage.createChatLog(validatedData);\n      \n      res.json(log);\n    } catch (error: any) {\n      console.error(\"Error creating chat log:\", error);\n      res.status(400).json({ message: error.message || \"Failed to create log\" });\n    }\n  });\n\n  // GET /api/admin/chat-logs - Admin queries logs with filters\n  app.get(\"/api/admin/chat-logs\", requireAdmin, async (req, res) => {\n    try {\n      const { eventId, userId, severity, startDate, endDate } = req.query;\n      \n      const filters: any = {};\n      if (eventId) filters.eventId = eventId as string;\n      if (userId) filters.userId = userId as string;\n      if (severity) filters.severity = severity as string;\n      if (startDate) filters.startDate = new Date(startDate as string);\n      if (endDate) filters.endDate = new Date(endDate as string);\n      \n      const logs = await storage.getChatLogs(filters);\n      \n      res.json(logs);\n    } catch (error: any) {\n      console.error(\"Error fetching chat logs:\", error);\n      res.status(500).json({ message: \"Failed to fetch logs\" });\n    }\n  });\n\n  // GET /api/admin/chat-logs/stats - Admin gets log statistics\n  app.get(\"/api/admin/chat-logs/stats\", requireAdmin, async (req, res) => {\n    try {\n      const stats = await storage.getChatLogStats();\n      \n      res.json(stats);\n    } catch (error: any) {\n      console.error(\"Error fetching chat log stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch stats\" });\n    }\n  });\n\n  // ============ REALTIME MATCHING CONFIGURATION ROUTES ============\n  \n  // GET /api/admin/matching-thresholds - Get current matching threshold config\n  app.get(\"/api/admin/matching-thresholds\", requireAdmin, async (req, res) => {\n    try {\n      const [activeConfig] = await db\n        .select()\n        .from(matchingThresholds)\n        .where(eq(matchingThresholds.isActive, true))\n        .limit(1);\n      \n      if (!activeConfig) {\n        // Return default config if none exists\n        return res.json({\n          highCompatibilityThreshold: 85,\n          mediumCompatibilityThreshold: 70,\n          lowCompatibilityThreshold: 55,\n          timeDecayEnabled: true,\n          timeDecayRate: 5,\n          minThresholdAfterDecay: 50,\n          minGroupSizeForMatch: 4,\n          optimalGroupSize: 6,\n          scanIntervalMinutes: 60,\n        });\n      }\n      \n      res.json(activeConfig);\n    } catch (error: any) {\n      console.error(\"Error fetching matching thresholds:\", error);\n      res.status(500).json({ message: \"Failed to fetch thresholds\" });\n    }\n  });\n  \n  // PUT /api/admin/matching-thresholds - Update matching threshold config\n  app.put(\"/api/admin/matching-thresholds\", requireAdmin, async (req, res) => {\n    try {\n      const userId = (req.user as User).id;\n      \n      // Deactivate current config\n      await db\n        .update(matchingThresholds)\n        .set({ isActive: false })\n        .where(eq(matchingThresholds.isActive, true));\n      \n      // Create new config\n      const [newConfig] = await db\n        .insert(matchingThresholds)\n        .values({\n          highCompatibilityThreshold: req.body.highCompatibilityThreshold || 85,\n          mediumCompatibilityThreshold: req.body.mediumCompatibilityThreshold || 70,\n          lowCompatibilityThreshold: req.body.lowCompatibilityThreshold || 55,\n          timeDecayEnabled: req.body.timeDecayEnabled ?? true,\n          timeDecayRate: req.body.timeDecayRate || 5,\n          minThresholdAfterDecay: req.body.minThresholdAfterDecay || 50,\n          minGroupSizeForMatch: req.body.minGroupSizeForMatch || 4,\n          optimalGroupSize: req.body.optimalGroupSize || 6,\n          scanIntervalMinutes: req.body.scanIntervalMinutes || 60,\n          isActive: true,\n          createdBy: userId,\n          notes: req.body.notes || null,\n        })\n        .returning();\n      \n      res.json(newConfig);\n    } catch (error: any) {\n      console.error(\"Error updating matching thresholds:\", error);\n      res.status(500).json({ message: \"Failed to update thresholds\" });\n    }\n  });\n  \n  // GET /api/admin/matching-logs - Get matching scan logs with filters\n  app.get(\"/api/admin/matching-logs\", requireAdmin, async (req, res) => {\n    try {\n      const { poolId, scanType, decision, limit = 50 } = req.query;\n      \n      let query = db.select().from(poolMatchingLogs);\n      \n      const conditions: any[] = [];\n      if (poolId) conditions.push(eq(poolMatchingLogs.poolId, poolId as string));\n      if (scanType) conditions.push(eq(poolMatchingLogs.scanType, scanType as string));\n      if (decision) conditions.push(eq(poolMatchingLogs.decision, decision as string));\n      \n      if (conditions.length > 0) {\n        query = query.where(and(...conditions)) as any;\n      }\n      \n      const logs = await query\n        .orderBy(desc(poolMatchingLogs.createdAt))\n        .limit(parseInt(limit as string));\n      \n      // Enrich with pool titles\n      const enrichedLogs = await Promise.all(\n        logs.map(async (log: any) => {\n          const [pool] = await db\n            .select({ title: eventPools.title })\n            .from(eventPools)\n            .where(eq(eventPools.id, log.poolId))\n            .limit(1);\n          \n          return {\n            ...log,\n            poolTitle: pool?.title || \"æœªçŸ¥æ´»åŠ¨æ± \",\n          };\n        })\n      );\n      \n      res.json(enrichedLogs);\n    } catch (error: any) {\n      console.error(\"Error fetching matching logs:\", error);\n      res.status(500).json({ message: \"Failed to fetch logs\" });\n    }\n  });\n  \n  // POST /api/admin/pools/:id/scan - Manually trigger pool scan\n  app.post(\"/api/admin/pools/:id/scan\", requireAdmin, async (req, res) => {\n    try {\n      const poolId = req.params.id;\n      const { scanPoolAndMatch } = await import(\"./poolRealtimeMatchingService\");\n      \n      const result = await scanPoolAndMatch(poolId, \"manual\", \"admin_manual\");\n      \n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Error triggering pool scan:\", error);\n      res.status(500).json({ message: \"Failed to trigger scan\", error: error.message });\n    }\n  });\n\n  const httpServer = createServer(app);\n\n  return httpServer;\n}\n","size_bytes":156963},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"client/src/components/EventIconBanner.tsx":{"content":"import { LucideIcon } from \"lucide-react\";\nimport { \n  Pizza, Coffee, Palette, Dumbbell, Music, Gamepad2, \n  Tent, Book, Wine, Trophy, Bike, Camera, Utensils,\n  Heart, Sparkles, PartyPopper, Mountain, Film\n} from \"lucide-react\";\n\ninterface EventIconBannerProps {\n  vibeGradient: string;\n  iconName?: string;\n}\n\nconst iconMap: Record<string, LucideIcon> = {\n  pizza: Pizza,\n  coffee: Coffee,\n  palette: Palette,\n  dumbbell: Dumbbell,\n  music: Music,\n  gamepad: Gamepad2,\n  tent: Tent,\n  book: Book,\n  wine: Wine,\n  trophy: Trophy,\n  bike: Bike,\n  camera: Camera,\n  utensils: Utensils,\n  heart: Heart,\n  sparkles: Sparkles,\n  party: PartyPopper,\n  mountain: Mountain,\n  film: Film\n};\n\nexport default function EventIconBanner({ vibeGradient, iconName = \"sparkles\" }: EventIconBannerProps) {\n  const Icon = iconMap[iconName] || Sparkles;\n  \n  return (\n    <div className={`relative h-24 bg-gradient-to-br ${vibeGradient} flex items-center justify-center overflow-hidden`}>\n      <Icon className=\"h-12 w-12 text-white/15 absolute\" strokeWidth={1.5} />\n    </div>\n  );\n}\n\nexport { iconMap };\n","size_bytes":1086},"client/src/components/examples/FeatureCard.tsx":{"content":"import FeatureCard from '../FeatureCard';\nimport { Sparkles, Users, Shield } from 'lucide-react';\n\nexport default function FeatureCardExample() {\n  return (\n    <div className=\"grid md:grid-cols-3 gap-6 max-w-5xl\">\n      <FeatureCard\n        icon={Sparkles}\n        title=\"AI-Powered Matching\"\n        description=\"Our algorithm analyzes your vibe profile to connect you with compatible people and events.\"\n      />\n      <FeatureCard\n        icon={Users}\n        title=\"Micro Events\"\n        description=\"Small groups of 5-10 people create intimate, meaningful connections.\"\n      />\n      <FeatureCard\n        icon={Shield}\n        title=\"Safe & Verified\"\n        description=\"All members are verified and events are hosted by trained facilitators.\"\n      />\n    </div>\n  );\n}\n","size_bytes":779},"client/src/components/examples/BottomNav.tsx":{"content":"import BottomNav from '../BottomNav';\n\nexport default function BottomNavExample() {\n  return <BottomNav />;\n}\n","size_bytes":110},"client/src/components/EventCard.tsx":{"content":"import { Card, CardContent, CardFooter, CardHeader } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Calendar, MapPin, Users, Sparkles } from \"lucide-react\";\nimport AttendeeAvatars from \"./AttendeeAvatars\";\n\ninterface EventCardProps {\n  title: string;\n  date: string;\n  time: string;\n  location: string;\n  attendees: Array<{ name: string; initials: string }>;\n  spotsLeft: number;\n  matchScore: number;\n  matchReason: string;\n  imageGradient?: string;\n}\n\nexport default function EventCard({\n  title,\n  date,\n  time,\n  location,\n  attendees,\n  spotsLeft,\n  matchScore,\n  matchReason,\n  imageGradient = \"from-purple-500 to-pink-500\"\n}: EventCardProps) {\n  return (\n    <Card className=\"overflow-hidden hover-elevate active-elevate-2 transition-all duration-200 cursor-pointer\" data-testid={`card-event-${title.toLowerCase().replace(/\\s+/g, '-')}`}>\n      <div className={`h-40 bg-gradient-to-br ${imageGradient} relative`}>\n        <div className=\"absolute top-3 right-3\">\n          <Badge className=\"bg-background/90 backdrop-blur-sm text-foreground border-0\">\n            <Sparkles className=\"h-3 w-3 mr-1\" />\n            {matchScore}% Match\n          </Badge>\n        </div>\n      </div>\n      \n      <CardHeader className=\"pb-3\">\n        <h3 className=\"font-semibold text-lg leading-tight\">{title}</h3>\n      </CardHeader>\n\n      <CardContent className=\"space-y-3 pb-3\">\n        <div className=\"flex items-center text-sm text-muted-foreground gap-2\">\n          <Calendar className=\"h-4 w-4\" />\n          <span>{date} at {time}</span>\n        </div>\n        <div className=\"flex items-center text-sm text-muted-foreground gap-2\">\n          <MapPin className=\"h-4 w-4\" />\n          <span>{location}</span>\n        </div>\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n            <AttendeeAvatars attendees={attendees} maxDisplay={3} />\n          </div>\n          <span className=\"text-xs text-muted-foreground\">{spotsLeft} spots left</span>\n        </div>\n        <div className=\"bg-muted/50 rounded-lg p-2.5 mt-2\">\n          <p className=\"text-xs text-muted-foreground\">\n            <span className=\"font-medium text-foreground\">Why this match:</span> {matchReason}\n          </p>\n        </div>\n      </CardContent>\n\n      <CardFooter className=\"pt-0\">\n        <Button className=\"w-full\" data-testid=\"button-rsvp\">RSVP Now</Button>\n      </CardFooter>\n    </Card>\n  );\n}\n","size_bytes":2589},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1723},"client/src/components/examples/EventCard.tsx":{"content":"import EventCard from '../EventCard';\nimport { Coffee, Music, Heart } from 'lucide-react';\n\nexport default function EventCardExample() {\n  return (\n    <div className=\"max-w-sm\">\n      <EventCard\n        title=\"Sunday Coffee & Conversations\"\n        date=\"Oct 15\"\n        time=\"10:00 AM\"\n        location=\"Bean & Brew Cafe, Downtown\"\n        vibes={[\n          { label: \"Chill Vibes\", icon: Coffee },\n          { label: \"Deep Talks\", icon: Heart },\n          { label: \"Creative Minds\", icon: Music }\n        ]}\n        attendees={[\n          { name: \"Sarah J\", initials: \"SJ\" },\n          { name: \"Mike C\", initials: \"MC\" },\n          { name: \"Emma D\", initials: \"ED\" },\n          { name: \"Alex R\", initials: \"AR\" }\n        ]}\n        spotsLeft={3}\n        matchScore={92}\n        matchReason=\"Love coffee chats + introverted energy + weekend mornings\"\n        imageGradient=\"from-amber-400 via-orange-500 to-pink-500\"\n      />\n    </div>\n  );\n}\n","size_bytes":946},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3848},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":21846},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/components/examples/Footer.tsx":{"content":"import Footer from '../Footer';\n\nexport default function FooterExample() {\n  return <Footer />;\n}\n","size_bytes":98},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":791},"client/src/components/examples/Header.tsx":{"content":"import Header from '../Header';\n\nexport default function HeaderExample() {\n  return <Header />;\n}\n","size_bytes":98},"client/src/App.tsx":{"content":"import { Switch, Route, useLocation } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useEffect } from \"react\";\nimport LoginPage from \"@/pages/LoginPage\";\nimport RegistrationPage from \"@/pages/RegistrationPage\";\nimport InterestsTopicsPage from \"@/pages/InterestsTopicsPage\";\nimport PersonalityTestPage from \"@/pages/PersonalityTestPage\";\nimport PersonalityTestResultPage from \"@/pages/PersonalityTestResultPage\";\nimport ProfileSetupPage from \"@/pages/ProfileSetupPage\";\nimport DiscoverPage from \"@/pages/DiscoverPage\";\nimport EventsPage from \"@/pages/EventsPage\";\nimport ChatsPage from \"@/pages/ChatsPage\";\nimport EventChatDetailPage from \"@/pages/EventChatDetailPage\";\nimport DirectChatPage from \"@/pages/DirectChatPage\";\nimport ProfilePage from \"@/pages/ProfilePage\";\nimport EditProfilePage from \"@/pages/EditProfilePage\";\nimport EditBasicInfoPage from \"@/pages/EditBasicInfoPage\";\nimport EditEducationPage from \"@/pages/EditEducationPage\";\nimport EditWorkPage from \"@/pages/EditWorkPage\";\nimport EditPersonalPage from \"@/pages/EditPersonalPage\";\nimport EditIntentPage from \"@/pages/EditIntentPage\";\nimport EditInterestsPage from \"@/pages/EditInterestsPage\";\nimport EventDetailPage from \"@/pages/EventDetailPage\";\nimport BlindBoxPaymentPage from \"@/pages/BlindBoxPaymentPage\";\nimport BlindBoxConfirmationPage from \"@/pages/BlindBoxConfirmationPage\";\nimport BlindBoxEventDetailPage from \"@/pages/BlindBoxEventDetailPage\";\nimport EventPoolRegistrationPage from \"@/pages/EventPoolRegistrationPage\";\nimport PoolGroupDetailPage from \"@/pages/PoolGroupDetailPage\";\nimport InvitationLandingPage from \"@/pages/InvitationLandingPage\";\nimport EventFeedbackFlow from \"@/pages/EventFeedbackFlow\";\nimport DeepFeedbackFlow from \"@/pages/DeepFeedbackFlow\";\nimport AdminLayout from \"@/pages/admin/AdminLayout\";\nimport AdminLoginPage from \"@/pages/admin/AdminLoginPage\";\nimport NotFound from \"@/pages/not-found\";\n\nfunction RedirectToRegistration() {\n  const [, setLocation] = useLocation();\n  useEffect(() => {\n    setLocation(\"/registration\");\n  }, [setLocation]);\n  return null;\n}\n\nfunction RedirectToInterestsTopics() {\n  const [, setLocation] = useLocation();\n  useEffect(() => {\n    setLocation(\"/interests-topics\");\n  }, [setLocation]);\n  return null;\n}\n\nfunction RedirectToPersonalityTest() {\n  const [, setLocation] = useLocation();\n  useEffect(() => {\n    setLocation(\"/personality-test\");\n  }, [setLocation]);\n  return null;\n}\n\nfunction RedirectToSetup() {\n  const [, setLocation] = useLocation();\n  useEffect(() => {\n    setLocation(\"/onboarding/setup\");\n  }, [setLocation]);\n  return null;\n}\n\nfunction AuthenticatedRouter() {\n  const { user, needsRegistration, needsInterestsTopics, needsPersonalityTest, needsProfileSetup } = useAuth();\n  const [location] = useLocation();\n\n  // Admin routes - separate from user flow\n  if (user?.isAdmin && location.startsWith(\"/admin\")) {\n    return <AdminLayout />;\n  }\n\n  if (needsRegistration) {\n    return (\n      <Switch>\n        <Route path=\"/registration\" component={RegistrationPage} />\n        <Route path=\"*\" component={RedirectToRegistration} />\n      </Switch>\n    );\n  }\n\n  if (needsInterestsTopics) {\n    return (\n      <Switch>\n        <Route path=\"/interests-topics\" component={InterestsTopicsPage} />\n        <Route path=\"*\" component={RedirectToInterestsTopics} />\n      </Switch>\n    );\n  }\n\n  if (needsPersonalityTest) {\n    return (\n      <Switch>\n        <Route path=\"/personality-test\" component={PersonalityTestPage} />\n        <Route path=\"/personality-test/results\" component={PersonalityTestResultPage} />\n        <Route path=\"*\" component={RedirectToPersonalityTest} />\n      </Switch>\n    );\n  }\n\n  if (needsProfileSetup) {\n    return (\n      <Switch>\n        <Route path=\"/onboarding/setup\" component={ProfileSetupPage} />\n        <Route path=\"*\" component={RedirectToSetup} />\n      </Switch>\n    );\n  }\n\n  return (\n    <Switch>\n      <Route path=\"/\" component={DiscoverPage} />\n      <Route path=\"/discover\" component={DiscoverPage} />\n      <Route path=\"/event-pool/:id/register\" component={EventPoolRegistrationPage} />\n      <Route path=\"/pool-groups/:groupId\" component={PoolGroupDetailPage} />\n      <Route path=\"/blindbox/payment\" component={BlindBoxPaymentPage} />\n      <Route path=\"/blindbox/confirmation\" component={BlindBoxConfirmationPage} />\n      <Route path=\"/blind-box-events/:eventId\" component={BlindBoxEventDetailPage} />\n      <Route path=\"/events/:eventId/feedback\" component={EventFeedbackFlow} />\n      <Route path=\"/events/:eventId/deep-feedback\" component={DeepFeedbackFlow} />\n      <Route path=\"/events\" component={EventsPage} />\n      <Route path=\"/chats\" component={ChatsPage} />\n      <Route path=\"/chats/:eventId\" component={EventChatDetailPage} />\n      <Route path=\"/direct-chat/:threadId\" component={DirectChatPage} />\n      <Route path=\"/profile\" component={ProfilePage} />\n      <Route path=\"/profile/edit\" component={EditProfilePage} />\n      <Route path=\"/profile/edit/basic\" component={EditBasicInfoPage} />\n      <Route path=\"/profile/edit/education\" component={EditEducationPage} />\n      <Route path=\"/profile/edit/work\" component={EditWorkPage} />\n      <Route path=\"/profile/edit/personal\" component={EditPersonalPage} />\n      <Route path=\"/profile/edit/intent\" component={EditIntentPage} />\n      <Route path=\"/profile/edit/interests\" component={EditInterestsPage} />\n      <Route path=\"/event/:id\" component={EventDetailPage} />\n      <Route path=\"/personality-test\" component={PersonalityTestPage} />\n      <Route path=\"/personality-test/results\" component={PersonalityTestResultPage} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction Router() {\n  const { isAuthenticated, isLoading } = useAuth();\n  const [location] = useLocation();\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"text-center space-y-4\">\n          <div className=\"h-8 w-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n          <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Invitation landing page is publicly accessible\n  if (location.startsWith(\"/invite/\")) {\n    return <Route path=\"/invite/:code\" component={InvitationLandingPage} />;\n  }\n\n  // Admin login is always accessible (even when not authenticated)\n  if (location.startsWith(\"/admin/login\") || location === \"/admin/login\") {\n    return <Route path=\"/admin/login\" component={AdminLoginPage} />;\n  }\n\n  // Admin routes require authentication\n  if (location.startsWith(\"/admin\")) {\n    if (!isAuthenticated) {\n      return <Route path=\"*\" component={AdminLoginPage} />;\n    }\n    return <AuthenticatedRouter />;\n  }\n\n  // Regular user routes\n  if (!isAuthenticated) {\n    return <Route path=\"*\" component={LoginPage} />;\n  }\n\n  return <AuthenticatedRouter />;\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <Toaster />\n        <Router />\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","size_bytes":7359},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"returnNull\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":1388},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":2359},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","size_bytes":157},"client/src/components/examples/HowItWorks.tsx":{"content":"import HowItWorks from '../HowItWorks';\n\nexport default function HowItWorksExample() {\n  return <HowItWorks />;\n}\n","size_bytes":114},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"client/src/components/ThemeToggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useEffect, useState } from \"react\";\n\nexport default function ThemeToggle() {\n  const [theme, setTheme] = useState<\"light\" | \"dark\">(\"light\");\n\n  useEffect(() => {\n    const stored = localStorage.getItem(\"theme\") as \"light\" | \"dark\" | null;\n    const prefersDark = window.matchMedia(\"(prefers-color-scheme: dark)\").matches;\n    const initialTheme = stored || (prefersDark ? \"dark\" : \"light\");\n    setTheme(initialTheme);\n    document.documentElement.classList.toggle(\"dark\", initialTheme === \"dark\");\n  }, []);\n\n  const toggleTheme = () => {\n    const newTheme = theme === \"light\" ? \"dark\" : \"light\";\n    setTheme(newTheme);\n    localStorage.setItem(\"theme\", newTheme);\n    document.documentElement.classList.toggle(\"dark\", newTheme === \"dark\");\n  };\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      onClick={toggleTheme}\n      data-testid=\"button-theme-toggle\"\n      aria-label=\"Toggle theme\"\n    >\n      {theme === \"light\" ? (\n        <Moon className=\"h-5 w-5\" />\n      ) : (\n        <Sun className=\"h-5 w-5\" />\n      )}\n    </Button>\n  );\n}\n","size_bytes":1164},"client/src/components/CTASection.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { ArrowRight } from \"lucide-react\";\n\nexport default function CTASection() {\n  return (\n    <section className=\"py-20 bg-gradient-to-br from-primary/10 via-primary/5 to-background\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"max-w-4xl mx-auto text-center space-y-6\">\n          <h2 className=\"text-3xl md:text-5xl font-display font-bold\">\n            Ready to Find Your Tribe?\n          </h2>\n          <p className=\"text-lg md:text-xl text-muted-foreground max-w-2xl mx-auto\">\n            Join thousands of people who've discovered meaningful connections through Vibe.\n          </p>\n          <div className=\"flex flex-col sm:flex-row gap-4 justify-center items-center pt-4\">\n            <Button size=\"lg\" className=\"text-base px-8\" data-testid=\"button-cta-start\">\n              Start Your Journey\n              <ArrowRight className=\"ml-2 h-5 w-5\" />\n            </Button>\n            <Button size=\"lg\" variant=\"outline\" className=\"text-base px-8\" data-testid=\"button-cta-learn\">\n              Learn More\n            </Button>\n          </div>\n          <p className=\"text-sm text-muted-foreground pt-4\">\n            Free to join â€¢ No credit card required â€¢ Cancel anytime\n          </p>\n        </div>\n      </div>\n    </section>\n  );\n}\n","size_bytes":1327},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n\n  /* Automatic computation of border around primary / danger buttons */\n  --opaque-button-border-intensity: -8; /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n\n  --background: 0 0% 99%;\n\n  --foreground: 220 15% 20%;\n\n  --border: 220 10% 88%;\n\n  --card: 0 0% 100%;\n\n  --card-foreground: 220 15% 20%;\n\n  --card-border: 220 10% 92%;\n\n  --sidebar: 0 0% 97%;\n\n  --sidebar-foreground: 220 15% 20%;\n\n  --sidebar-border: 220 10% 90%;\n\n  --sidebar-primary: 280 45% 55%;\n\n  --sidebar-primary-foreground: 0 0% 100%;\n\n  --sidebar-accent: 220 8% 94%;\n\n  --sidebar-accent-foreground: 220 15% 25%;\n\n  --sidebar-ring: 280 45% 55%;\n\n  --popover: 0 0% 98%;\n\n  --popover-foreground: 220 15% 20%;\n\n  --popover-border: 220 10% 90%;\n\n  --primary: 280 45% 55%;\n\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 220 8% 95%;\n\n  --secondary-foreground: 220 15% 25%;\n\n  --muted: 220 8% 96%;\n\n  --muted-foreground: 220 10% 45%;\n\n  --accent: 220 10% 94%;\n\n  --accent-foreground: 220 15% 25%;\n\n  --destructive: 0 65% 50%;\n\n  --destructive-foreground: 0 0% 100%;\n\n  --input: 220 12% 75%;\n  --ring: 280 45% 55%;\n  --chart-1: 280 45% 55%;\n  --chart-2: 160 45% 50%;\n  --chart-3: 45 75% 60%;\n  --chart-4: 200 50% 55%;\n  --chart-5: 145 60% 45%;\n\n  --font-sans: 'Inter', -apple-system, system-ui, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: .5rem; /* 8px */\n  --shadow-2xs: 0px 1px 2px 0px hsl(220 10% 10% / 0.05);\n  --shadow-xs: 0px 1px 3px 0px hsl(220 10% 10% / 0.08);\n  --shadow-sm: 0px 2px 4px -1px hsl(220 10% 10% / 0.06), 0px 1px 2px -1px hsl(220 10% 10% / 0.10);\n  --shadow: 0px 4px 6px -1px hsl(220 10% 10% / 0.08), 0px 2px 4px -1px hsl(220 10% 10% / 0.06);\n  --shadow-md: 0px 6px 8px -2px hsl(220 10% 10% / 0.10), 0px 4px 6px -2px hsl(220 10% 10% / 0.06);\n  --shadow-lg: 0px 10px 15px -3px hsl(220 10% 10% / 0.10), 0px 4px 6px -2px hsl(220 10% 10% / 0.05);\n  --shadow-xl: 0px 20px 25px -5px hsl(220 10% 10% / 0.10), 0px 10px 10px -5px hsl(220 10% 10% / 0.04);\n  --shadow-2xl: 0px 25px 50px -12px hsl(220 10% 10% / 0.25);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n  /* Automatically computed borders - intensity can be controlled by the user by the --opaque-button-border-intensity setting */\n\n  /* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n\n  --opaque-button-border-intensity: 9;  /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n\n  --background: 220 15% 10%;\n\n  --foreground: 0 0% 95%;\n\n  --border: 220 10% 22%;\n\n  --card: 220 12% 14%;\n\n  --card-foreground: 0 0% 95%;\n\n  --card-border: 220 10% 18%;\n\n  --sidebar: 220 12% 12%;\n\n  --sidebar-foreground: 0 0% 95%;\n\n  --sidebar-border: 220 10% 16%;\n\n  --sidebar-primary: 280 50% 65%;\n\n  --sidebar-primary-foreground: 0 0% 100%;\n\n  --sidebar-accent: 220 10% 16%;\n\n  --sidebar-accent-foreground: 0 0% 90%;\n\n  --sidebar-ring: 280 50% 65%;\n\n  --popover: 220 12% 16%;\n\n  --popover-foreground: 0 0% 95%;\n\n  --popover-border: 220 10% 20%;\n\n  --primary: 280 50% 60%;\n\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 220 8% 20%;\n\n  --secondary-foreground: 0 0% 90%;\n\n  --muted: 220 10% 18%;\n\n  --muted-foreground: 220 8% 65%;\n\n  --accent: 220 10% 19%;\n\n  --accent-foreground: 0 0% 90%;\n\n  --destructive: 0 60% 55%;\n\n  --destructive-foreground: 0 0% 100%;\n\n  --input: 220 10% 35%;\n  --ring: 280 50% 65%;\n  --chart-1: 280 50% 65%;\n  --chart-2: 160 45% 55%;\n  --chart-3: 45 75% 65%;\n  --chart-4: 200 50% 60%;\n  --chart-5: 145 55% 55%;\n\n  --shadow-2xs: 0px 1px 2px 0px hsl(220 15% 5% / 0.30);\n  --shadow-xs: 0px 1px 3px 0px hsl(220 15% 5% / 0.40);\n  --shadow-sm: 0px 2px 4px -1px hsl(220 15% 5% / 0.35), 0px 1px 2px -1px hsl(220 15% 5% / 0.45);\n  --shadow: 0px 4px 6px -1px hsl(220 15% 5% / 0.40), 0px 2px 4px -1px hsl(220 15% 5% / 0.35);\n  --shadow-md: 0px 6px 8px -2px hsl(220 15% 5% / 0.45), 0px 4px 6px -2px hsl(220 15% 5% / 0.40);\n  --shadow-lg: 0px 10px 15px -3px hsl(220 15% 5% / 0.50), 0px 4px 6px -2px hsl(220 15% 5% / 0.40);\n  --shadow-xl: 0px 20px 25px -5px hsl(220 15% 5% / 0.55), 0px 10px 10px -5px hsl(220 15% 5% / 0.35);\n  --shadow-2xl: 0px 25px 50px -12px hsl(220 15% 5% / 0.60);\n\n  /* Automatically computed borders - intensity can be controlled by the user by the --opaque-button-border-intensity setting */\n  \n  /* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n\n  /* Hide scrollbar for mobile carousel */\n  .scrollbar-hide::-webkit-scrollbar {\n    display: none;\n  }\n  \n  .scrollbar-hide {\n    -ms-overflow-style: none;\n    scrollbar-width: none;\n  }\n\n  /* Safe area for mobile bottom nav */\n  .safe-area-pb {\n    padding-bottom: env(safe-area-inset-bottom);\n  }\n\n  /* 3D Card Flip Animation */\n  .perspective-1000 {\n    perspective: 1000px;\n  }\n\n  .transform-style-3d {\n    transform-style: preserve-3d;\n  }\n\n  .backface-hidden {\n    backface-visibility: hidden;\n    -webkit-backface-visibility: hidden;\n  }\n\n  .rotate-y-180 {\n    transform: rotateY(180deg);\n  }\n\n  /* Stagger animation for cards */\n  @keyframes fadeInUp {\n    from {\n      opacity: 0;\n      transform: translateY(10px);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  }\n\n  .animate-fade-in-up {\n    animation: fadeInUp 0.4s ease-out forwards;\n  }\n\n  /* Progress bar fill animation */\n  @keyframes progressFill {\n    from {\n      width: 0%;\n    }\n  }\n\n  .animate-progress-fill {\n    animation: progressFill 0.6s ease-out forwards;\n  }\n}","size_bytes":12460},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"client/src/components/examples/GroupSparkMeter.tsx":{"content":"import GroupSparkMeter from '../GroupSparkMeter';\n\nexport default function GroupSparkMeterExample() {\n  return (\n    <div className=\"max-w-md p-4\">\n      <GroupSparkMeter energizers={3} connectors={2} reflectors={3} />\n    </div>\n  );\n}\n","size_bytes":237},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"client/src/components/MobileHeader.tsx":{"content":"import { Settings } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport JoyJoinLogo from \"./JoyJoinLogo\";\n\ninterface MobileHeaderProps {\n  title?: string;\n  showLogo?: boolean;\n  showSettings?: boolean;\n  action?: React.ReactNode;\n}\n\nexport default function MobileHeader({ \n  title,\n  showLogo = false,\n  showSettings = false,\n  action\n}: MobileHeaderProps) {\n  return (\n    <header className=\"sticky top-0 z-40 w-full bg-background/95 backdrop-blur-sm border-b\">\n      <div className=\"flex items-center justify-between h-14 px-4\">\n        {showLogo ? (\n          <JoyJoinLogo size=\"sm\" />\n        ) : (\n          <h1 className=\"text-lg font-semibold\">{title}</h1>\n        )}\n        <div className=\"flex items-center gap-2\">\n          {action}\n          {showSettings && (\n            <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-settings\">\n              <Settings className=\"h-5 w-5\" />\n            </Button>\n          )}\n        </div>\n      </div>\n    </header>\n  );\n}\n","size_bytes":1009},"client/src/components/examples/EventFeed.tsx":{"content":"import EventFeed from '../EventFeed';\n\nexport default function EventFeedExample() {\n  return <EventFeed />;\n}\n","size_bytes":110},"client/src/pages/DiscoverPage.tsx":{"content":"import MobileHeader from \"@/components/MobileHeader\";\nimport BottomNav from \"@/components/BottomNav\";\nimport BlindBoxEventCard from \"@/components/BlindBoxEventCard\";\nimport DiscountCouponCard from \"@/components/DiscountCouponCard\";\nimport HeroWelcome from \"@/components/HeroWelcome\";\nimport LocationPickerSheet from \"@/components/LocationPickerSheet\";\nimport { Sparkles } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useState, useEffect } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useMarkNotificationsAsRead } from \"@/hooks/useNotificationCounts\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { format, parseISO } from \"date-fns\";\nimport { zhCN } from \"date-fns/locale\";\n\ninterface EventPool {\n  id: string;\n  title: string;\n  description: string;\n  eventType: \"é¥­å±€\" | \"é…’å±€\" | \"å…¶ä»–\";\n  city: \"é¦™æ¸¯\" | \"æ·±åœ³\";\n  district: string;\n  dateTime: string;\n  registrationDeadline: string;\n  status: string;\n  registrationCount: number;\n  spotsLeft: number;\n  genderRestriction?: string;\n}\n\nexport default function DiscoverPage() {\n  const { user } = useAuth();\n  const [selectedCity, setSelectedCity] = useState<\"é¦™æ¸¯\" | \"æ·±åœ³\">(\"æ·±åœ³\");\n  const [selectedArea, setSelectedArea] = useState<string>(\"å—å±±åŒº\");\n  const [locationPickerOpen, setLocationPickerOpen] = useState(false);\n  const markAsRead = useMarkNotificationsAsRead();\n\n  // Fetch event pools from API\n  const { data: eventPools = [], isLoading } = useQuery<EventPool[]>({\n    queryKey: [\"/api/event-pools\", selectedCity],\n    enabled: true,\n  });\n\n  // Auto-clear discover notifications when entering the page\n  useEffect(() => {\n    markAsRead.mutate('discover');\n  }, []);\n\n  const handleLocationSave = (city: \"é¦™æ¸¯\" | \"æ·±åœ³\", area: string) => {\n    setSelectedCity(city);\n    setSelectedArea(area);\n  };\n\n  // Transform event pools to blind box event card props\n  const transformEventPool = (pool: EventPool) => {\n    try {\n      const dateTime = parseISO(pool.dateTime);\n      const dayOfWeek = format(dateTime, 'EEEE', { locale: zhCN });\n      const time = format(dateTime, 'HH:mm');\n      const area = `${pool.city}â€¢${pool.district}`;\n      \n      // Use pool title as mystery title, or generate one\n      const mysteryTitle = pool.title || `ç¥ç§˜${pool.eventType}ï½œç­‰ä½ æ­æ™“`;\n      \n      // Check if it's girls night based on gender restriction or title\n      const isGirlsNight = pool.genderRestriction === 'ä»…é™å¥³æ€§' || \n                          pool.title?.toLowerCase().includes('girls') ||\n                          pool.title?.includes('å¥³æ€§') ||\n                          pool.title?.includes('é—ºèœœ');\n\n      return {\n        id: pool.id,\n        date: dayOfWeek,\n        time,\n        eventType: (pool.eventType === \"å…¶ä»–\" ? \"é¥­å±€\" : pool.eventType) as \"é¥­å±€\" | \"é…’å±€\",\n        area,\n        city: pool.city,\n        mysteryTitle,\n        isAA: true, // Event pools default to AA\n        isGirlsNight,\n      };\n    } catch (error) {\n      console.error(\"Error transforming event pool:\", pool, error);\n      return null;\n    }\n  };\n\n  // Filter and transform event pools\n  const filteredBlindBoxEvents = eventPools\n    .filter(pool => {\n      if (pool.city !== selectedCity) return false;\n      if (selectedArea && !pool.district.includes(selectedArea)) return false;\n      return true;\n    })\n    .map(transformEventPool)\n    .filter((event): event is NonNullable<typeof event> => event !== null);\n\n  return (\n    <div className=\"min-h-screen bg-background pb-16\">\n      <MobileHeader showLogo={true} />\n      \n      <div className=\"space-y-4\">\n        {/* Hero æ¬¢è¿åŒº */}\n        <HeroWelcome \n          userName={user?.displayName || \"æœ‹å‹\"}\n          selectedCity={selectedCity}\n          selectedArea={selectedArea}\n          onLocationClick={() => setLocationPickerOpen(true)}\n        />\n\n        {/* åˆ†å‰²çº¿ */}\n        <div className=\"h-px bg-border/50 mx-4\" />\n\n        <div className=\"px-4 space-y-4\">\n          <DiscountCouponCard \n            discount={15}\n            reason=\"ä¸Šæ¬¡æ´»åŠ¨å¸¦åŠ¨å…¨åœºæ°›å›´ï¼Œè·å¾—èƒ½é‡å¥–åŠ±\"\n            expiresIn=\"7å¤©\"\n          />\n\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <Sparkles className=\"h-4 w-4 text-primary\" />\n            <span className=\"font-medium\">ç›²ç›’æ¨¡å¼</span>\n          </div>\n\n          <div className=\"space-y-5\">\n            {isLoading ? (\n              <div className=\"text-center py-8\">\n                <div className=\"h-8 w-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n                <p className=\"text-sm text-muted-foreground mt-4\">åŠ è½½ä¸­...</p>\n              </div>\n            ) : filteredBlindBoxEvents.length > 0 ? (\n              filteredBlindBoxEvents.map((event) => (\n                <BlindBoxEventCard key={event.id} {...event} />\n              ))\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <p>æš‚æ— {selectedCity}{selectedArea ? `Â·${selectedArea}` : ''}çš„ç›²ç›’æ´»åŠ¨</p>\n                <p className=\"text-sm mt-2\">Adminè¿˜æ²¡åˆ›å»ºæ´»åŠ¨æ± ï¼Œæˆ–å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰å¯ç”¨æ´»åŠ¨</p>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n\n      <BottomNav />\n      \n      {/* åœ°ç‚¹é€‰æ‹©å™¨ */}\n      <LocationPickerSheet\n        open={locationPickerOpen}\n        onOpenChange={setLocationPickerOpen}\n        selectedCity={selectedCity}\n        selectedArea={selectedArea}\n        onSave={handleLocationSave}\n      />\n    </div>\n  );\n}\n","size_bytes":5619},"client/src/components/examples/HeroSection.tsx":{"content":"import HeroSection from '../HeroSection';\n\nexport default function HeroSectionExample() {\n  return <HeroSection />;\n}\n","size_bytes":118},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","size_bytes":2263},"client/src/components/JoyJoinLogo.tsx":{"content":"import { Sparkles } from \"lucide-react\";\n\ninterface JoyJoinLogoProps {\n  size?: \"sm\" | \"md\" | \"lg\";\n  showEnglish?: boolean;\n}\n\nexport default function JoyJoinLogo({ size = \"md\", showEnglish = true }: JoyJoinLogoProps) {\n  const sizes = {\n    sm: \"text-lg\",\n    md: \"text-xl\",\n    lg: \"text-2xl\"\n  };\n\n  return (\n    <div className=\"flex items-center gap-2\">\n      <Sparkles className={`${size === 'sm' ? 'h-5 w-5' : size === 'md' ? 'h-6 w-6' : 'h-7 w-7'} text-primary`} />\n      <div className=\"flex items-center gap-1.5\">\n        <span className={`${sizes[size]} font-display font-bold`}>æ‚¦èš</span>\n        {showEnglish && (\n          <>\n            <span className=\"text-muted-foreground\">Â·</span>\n            <span className={`${sizes[size]} font-display font-semibold text-muted-foreground`}>Joy</span>\n          </>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":868},"client/src/components/examples/ThemeToggle.tsx":{"content":"import ThemeToggle from '../ThemeToggle';\n\nexport default function ThemeToggleExample() {\n  return <ThemeToggle />;\n}\n","size_bytes":118},"shared/schema.ts":{"content":"import { sql } from 'drizzle-orm';\nimport {\n  index,\n  jsonb,\n  pgTable,\n  timestamp,\n  varchar,\n  text,\n  integer,\n  boolean,\n  date,\n} from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Session storage table (required for Replit Auth)\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)],\n);\n\n// User storage table (required for Replit Auth)\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  \n  // Profile fields\n  displayName: varchar(\"display_name\"),\n  hasCompletedProfileSetup: boolean(\"has_completed_profile_setup\").default(false),\n  hasCompletedVoiceQuiz: boolean(\"has_completed_voice_quiz\").default(false),\n  \n  // Registration fields - Identity\n  birthdate: date(\"birthdate\"), // Used to calculate age\n  age: integer(\"age\"), // Deprecated - calculated from birthdate\n  ageVisibility: varchar(\"age_visibility\").default(\"hide_all\"), // hide_all, show_exact_age\n  gender: varchar(\"gender\"), // Woman, Man, Nonbinary, Self-describe, Prefer not to say\n  pronouns: varchar(\"pronouns\"), // She/Her, He/Him, They/Them, Self-describe, Prefer not to say\n  \n  // Registration fields - Background\n  relationshipStatus: varchar(\"relationship_status\"), // Single, In a relationship, Married/Partnered, It's complicated, Prefer not to say\n  children: varchar(\"children\"), // No kids, Expecting, 0-5, 6-12, 13-18, Adult, Prefer not to say\n  hasKids: boolean(\"has_kids\"), // Deprecated in favor of children\n  \n  // Registration fields - Education\n  educationLevel: varchar(\"education_level\"), // High school/below, Some college/Associate, Bachelor's, Master's, Doctorate, Trade/Vocational, Prefer not to say\n  studyLocale: varchar(\"study_locale\"), // Local, Overseas, Both, Prefer not to say\n  overseasRegions: text(\"overseas_regions\").array(), // NA, Europe, East Asia, SE Asia, etc.\n  fieldOfStudy: varchar(\"field_of_study\"), // Business, Engineering, CS, Arts/Design, etc.\n  educationVisibility: varchar(\"education_visibility\").default(\"hide_all\"), // hide_all, show_level_only, show_level_and_field\n  \n  // Registration fields - Work\n  industry: varchar(\"industry\"), // Coarse taxonomy\n  roleTitleShort: varchar(\"role_title_short\"), // Optional short text\n  seniority: varchar(\"seniority\"), // Intern, Junior, Mid, Senior, Founder, Executive\n  workVisibility: varchar(\"work_visibility\").default(\"show_industry_only\"), // hide_all, show_industry_only\n  \n  // Registration fields - Culture & Language\n  hometownCountry: varchar(\"hometown_country\"),\n  hometownRegionCity: varchar(\"hometown_region_city\"),\n  hometownAffinityOptin: boolean(\"hometown_affinity_optin\").default(true),\n  languagesComfort: text(\"languages_comfort\").array(), // English, Mandarin, Cantonese, etc.\n  \n  // Registration fields - Deprecated/Legacy\n  placeOfOrigin: varchar(\"place_of_origin\"), // Deprecated in favor of hometown fields\n  longTermBase: varchar(\"long_term_base\"), // Deprecated - use location preferences\n  wechatId: varchar(\"wechat_id\"), // WeChat ID\n  phoneNumber: varchar(\"phone_number\").unique(), // Phone number for authentication\n  password: varchar(\"password\"), // Hashed password for admin login\n  \n  // Registration fields - Access & Safety\n  accessibilityNeeds: text(\"accessibility_needs\"), // Optional text\n  safetyNoteHost: text(\"safety_note_host\"), // Private note to host\n  \n  // Default event intent (can be overridden per event) - multiple selections allowed\n  intent: text(\"intent\").array(), // Can include: networking, friends, discussion, fun, romance, flexible\n  \n  // Onboarding progress\n  hasCompletedRegistration: boolean(\"has_completed_registration\").default(false),\n  hasCompletedInterestsTopics: boolean(\"has_completed_interests_topics\").default(false),\n  hasCompletedPersonalityTest: boolean(\"has_completed_personality_test\").default(false),\n  \n  // Interests & Topics (Step 2)\n  interestsTop: text(\"interests_top\").array(), // 3-7 selected interests\n  interestsRankedTop3: text(\"interests_ranked_top3\").array(), // Top 3 ranked interests\n  topicsHappy: text(\"topics_happy\").array(), // Topics user enjoys discussing\n  topicsAvoid: text(\"topics_avoid\").array(), // Topics to avoid\n  \n  // Personality data (Step 3 - Vibe Vector)\n  vibeVector: jsonb(\"vibe_vector\"), // {energy, conversation_style, initiative, novelty, humor} scored 0-1\n  archetype: varchar(\"archetype\"), // 12ä¸ªç¤¾äº¤æ°›å›´åŸå‹: å¼€å¿ƒæŸ¯åŸº, å¤ªé˜³é¸¡, å¤¸å¤¸è±š, æœºæ™ºç‹, æ·¡å®šæµ·è±š, ç»‡ç½‘è››, æš–å¿ƒç†Š, çµæ„Ÿç« é±¼, æ²‰æ€çŒ«å¤´é¹°, å®šå¿ƒå¤§è±¡, ç¨³å¦‚é¾Ÿ, éšèº«çŒ«\n  debateComfort: integer(\"debate_comfort\"), // 1-7 scale\n  needsPersonalityRetake: boolean(\"needs_personality_retake\").default(false), // æ˜¯å¦éœ€è¦é‡æ–°æµ‹è¯„ï¼ˆç³»ç»Ÿå‡çº§åï¼‰\n  \n  // Legacy personality data (deprecated)\n  personalityTraits: jsonb(\"personality_traits\"),\n  personalityChallenges: text(\"personality_challenges\").array(),\n  idealMatch: text(\"ideal_match\"),\n  energyLevel: integer(\"energy_level\"),\n  \n  // Social role (from personality test - now mapped to archetype)\n  primaryRole: varchar(\"primary_role\"), // 12 archetypes (animal-based social vibe system)\n  secondaryRole: varchar(\"secondary_role\"), // Second highest archetype (used in algorithm, hidden from UI)\n  roleSubtype: varchar(\"role_subtype\"),\n  \n  // Gamification\n  eventsAttended: integer(\"events_attended\").default(0),\n  matchesMade: integer(\"matches_made\").default(0),\n  \n  // Admin & Moderation\n  isAdmin: boolean(\"is_admin\").default(false),\n  isBanned: boolean(\"is_banned\").default(false),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Events table\nexport const events = pgTable(\"events\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: varchar(\"title\").notNull(),\n  description: text(\"description\"),\n  dateTime: timestamp(\"date_time\").notNull(),\n  location: varchar(\"location\").notNull(),\n  area: varchar(\"area\"),\n  price: integer(\"price\"),\n  maxAttendees: integer(\"max_attendees\").default(10),\n  currentAttendees: integer(\"current_attendees\").default(0),\n  iconName: varchar(\"icon_name\"),\n  hostId: varchar(\"host_id\").references(() => users.id),\n  status: varchar(\"status\").default(\"upcoming\"), // upcoming, ongoing, completed, cancelled\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Event attendance table\nexport const eventAttendance = pgTable(\"event_attendance\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  eventId: varchar(\"event_id\").notNull().references(() => events.id),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  joinedAt: timestamp(\"joined_at\").defaultNow(),\n  status: varchar(\"status\").default(\"confirmed\"), // confirmed, cancelled, attended\n  intent: text(\"intent\").array(), // Event-specific intent: networking, friends, discussion, fun, romance, flexible\n});\n\n// ============ ä¸¤é˜¶æ®µåŒ¹é…æ¨¡å‹ - Event Pools ============\n\n// Event Pools table - Adminåˆ›å»ºçš„æ´»åŠ¨æ± ï¼ˆç¡¬çº¦æŸæ¡†æ¶ï¼‰\nexport const eventPools = pgTable(\"event_pools\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  \n  // åŸºæœ¬ä¿¡æ¯\n  title: varchar(\"title\").notNull(), // æ´»åŠ¨æ ‡é¢˜ï¼Œå¦‚ï¼š\"å‘¨äº”å¤œèŠé…’å±€\"\n  description: text(\"description\"), // æ´»åŠ¨æè¿°\n  eventType: varchar(\"event_type\").notNull(), // é¥­å±€/é…’å±€/å…¶ä»–\n  \n  // æ—¶é—´åœ°ç‚¹ï¼ˆç¡¬çº¦æŸï¼‰\n  city: varchar(\"city\").notNull(), // æ·±åœ³/é¦™æ¸¯\n  district: varchar(\"district\"), // å—å±±åŒº/æ¹¾ä»”ç­‰\n  dateTime: timestamp(\"date_time\").notNull(), // æ´»åŠ¨æ—¥æœŸæ—¶é—´\n  registrationDeadline: timestamp(\"registration_deadline\").notNull(), // æŠ¥åæˆªæ­¢æ—¶é—´\n  \n  // æ´»åŠ¨é™åˆ¶ï¼ˆç¡¬çº¦æŸ - å…³è”ç”¨æˆ·è¡¨å­—æ®µï¼‰\n  genderRestriction: varchar(\"gender_restriction\"), // null=ä¸é™ | Woman | Man | Nonbinary\n  industryRestrictions: text(\"industry_restrictions\").array(), // è¡Œä¸šé™åˆ¶åˆ—è¡¨ï¼ˆç©º=ä¸é™ï¼‰\n  seniorityRestrictions: text(\"seniority_restrictions\").array(), // èŒçº§é™åˆ¶\n  educationLevelRestrictions: text(\"education_level_restrictions\").array(), // å­¦å†é™åˆ¶\n  ageRangeMin: integer(\"age_range_min\"), // æœ€å°å¹´é¾„\n  ageRangeMax: integer(\"age_range_max\"), // æœ€å¤§å¹´é¾„\n  \n  // ç»„å±€é…ç½®\n  minGroupSize: integer(\"min_group_size\").default(4), // æœ€å°æˆå±€äººæ•°\n  maxGroupSize: integer(\"max_group_size\").default(6), // æœ€å¤§æˆå±€äººæ•°\n  targetGroups: integer(\"target_groups\").default(1), // ç›®æ ‡ç»„å±€æ•°é‡\n  \n  // çŠ¶æ€ç®¡ç†\n  status: varchar(\"status\").default(\"active\"), // active (æ‹›å‹Ÿä¸­) | matching | matched | completed | cancelled\n  totalRegistrations: integer(\"total_registrations\").default(0), // æ€»æŠ¥åäººæ•°\n  successfulMatches: integer(\"successful_matches\").default(0), // æˆåŠŸåŒ¹é…äººæ•°\n  \n  // å…ƒæ•°æ®\n  createdBy: varchar(\"created_by\").notNull().references(() => users.id), // Adminç”¨æˆ·ID\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  matchedAt: timestamp(\"matched_at\"), // åŒ¹é…å®Œæˆæ—¶é—´\n});\n\n// Event Pool Registrations table - ç”¨æˆ·æŠ¥åè®°å½• + ä¸ªæ€§åŒ–åå¥½ï¼ˆè½¯çº¦æŸï¼‰\nexport const eventPoolRegistrations = pgTable(\"event_pool_registrations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  \n  // å…³è”\n  poolId: varchar(\"pool_id\").notNull().references(() => eventPools.id),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  \n  // ç”¨æˆ·ä¸´æ—¶åå¥½ï¼ˆè½¯çº¦æŸ - ä»…ç”¨äºæœ¬æ¬¡æ´»åŠ¨ï¼‰\n  budgetRange: text(\"budget_range\").array(), // é¢„ç®—èŒƒå›´ï¼Œå¤šé€‰ï¼š[\"100å…ƒä»¥ä¸‹\", \"100-200\", \"200-300\", \"300-500\", \"500+\"]\n  preferredLanguages: text(\"preferred_languages\").array(), // é¦–é€‰è¯­è¨€ï¼š[\"æ™®é€šè¯\", \"ç²¤è¯­\", \"è‹±è¯­\"]\n  socialGoals: text(\"social_goals\").array(), // ç¤¾äº¤ç›®çš„ï¼š[\"äº¤æœ‹å‹\", \"æ‰©å±•äººè„‰\", \"æ”¾æ¾å¿ƒæƒ…\", \"è¡Œä¸šäº¤æµ\", \"flexible\"]\n  cuisinePreferences: text(\"cuisine_preferences\").array(), // é¥®é£Ÿåå¥½ï¼š[\"ä¸­é¤\", \"å·èœ\", \"ç²¤èœ\", \"æ—¥æ–™\", \"è¥¿é¤\"]\n  dietaryRestrictions: text(\"dietary_restrictions\").array(), // å¿Œå£ï¼š[\"ç´ é£Ÿ\", \"ä¸åƒè¾£\", \"æ¸…çœŸ\"]\n  tasteIntensity: text(\"taste_intensity\").array(), // å£å‘³å¼ºåº¦ï¼š[\"çˆ±åƒè¾£\", \"ä¸è¾£/æ¸…æ·¡ä¸ºä¸»\"]\n  \n  // åŒ¹é…ç»“æœ\n  matchStatus: varchar(\"match_status\").default(\"pending\"), // pending | matched | unmatched\n  assignedGroupId: varchar(\"assigned_group_id\"), // åˆ†é…åˆ°çš„ç»„IDï¼ˆå¦‚æœåŒ¹é…æˆåŠŸï¼‰\n  matchScore: integer(\"match_score\"), // åŒ¹é…åˆ†æ•°\n  \n  // å…ƒæ•°æ®\n  registeredAt: timestamp(\"registered_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Event Pool Groups table - åŒ¹é…æˆåŠŸçš„å°ç»„\nexport const eventPoolGroups = pgTable(\"event_pool_groups\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  \n  poolId: varchar(\"pool_id\").notNull().references(() => eventPools.id),\n  groupNumber: integer(\"group_number\").notNull(), // ç»„å·ï¼ˆåŒä¸€æ´»åŠ¨æ± å†…ï¼‰\n  \n  // ç»„ä¿¡æ¯\n  memberCount: integer(\"member_count\").default(0),\n  avgChemistryScore: integer(\"avg_chemistry_score\"), // å¹³å‡åŒ–å­¦ååº”åˆ†æ•°\n  diversityScore: integer(\"diversity_score\"), // å¤šæ ·æ€§åˆ†æ•°\n  energyBalance: integer(\"energy_balance\"), // èƒ½é‡å¹³è¡¡åˆ†æ•°\n  overallScore: integer(\"overall_score\"), // ç»¼åˆåˆ†æ•°\n  temperatureLevel: varchar(\"temperature_level\"), // åŒ–å­¦ååº”æ¸©åº¦ç­‰çº§: fire | warm | mild | cold\n  matchExplanation: text(\"match_explanation\"), // AIç”Ÿæˆçš„åŒ¹é…è§£é‡Š\n  \n  // æ´»åŠ¨è¯¦æƒ…ï¼ˆåŒ¹é…åç”Ÿæˆï¼‰\n  venueName: varchar(\"venue_name\"),\n  venueAddress: text(\"venue_address\"),\n  finalDateTime: timestamp(\"final_date_time\"),\n  \n  // çŠ¶æ€\n  status: varchar(\"status\").default(\"confirmed\"), // confirmed | completed | cancelled\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// ============ å®æ—¶åŒ¹é…ç³»ç»Ÿé…ç½® ============\n\n// Matching Thresholds table - åŠ¨æ€åŒ¹é…é˜ˆå€¼é…ç½®ï¼ˆç®¡ç†å‘˜å¯è°ƒæ•´ï¼‰\nexport const matchingThresholds = pgTable(\"matching_thresholds\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  \n  // é˜ˆå€¼é…ç½®\n  highCompatibilityThreshold: integer(\"high_compatibility_threshold\").default(85), // é«˜å…¼å®¹æ€§ç«‹å³åŒ¹é…é˜ˆå€¼\n  mediumCompatibilityThreshold: integer(\"medium_compatibility_threshold\").default(70), // ä¸­ç­‰å…¼å®¹æ€§ç­‰å¾…é˜ˆå€¼\n  lowCompatibilityThreshold: integer(\"low_compatibility_threshold\").default(55), // æœ€ä½å¯æ¥å—é˜ˆå€¼\n  \n  // æ—¶é—´è¡°å‡é…ç½®\n  timeDecayEnabled: boolean(\"time_decay_enabled\").default(true), // æ˜¯å¦å¯ç”¨æ—¶é—´è¡°å‡\n  timeDecayRate: integer(\"time_decay_rate\").default(5), // æ¯24å°æ—¶é™ä½çš„é˜ˆå€¼ç‚¹æ•°\n  minThresholdAfterDecay: integer(\"min_threshold_after_decay\").default(50), // è¡°å‡åçš„æœ€ä½é˜ˆå€¼\n  \n  // ç»„å±€é…ç½®\n  minGroupSizeForMatch: integer(\"min_group_size_for_match\").default(4), // æœ€å°æˆå±€äººæ•°\n  optimalGroupSize: integer(\"optimal_group_size\").default(6), // æœ€ä¼˜ç»„å±€äººæ•°\n  \n  // æ‰«æé¢‘ç‡\n  scanIntervalMinutes: integer(\"scan_interval_minutes\").default(60), // å®šæ—¶æ‰«æé—´éš”ï¼ˆåˆ†é’Ÿï¼‰\n  \n  // å…ƒæ•°æ®\n  isActive: boolean(\"is_active\").default(true), // æ˜¯å¦ä¸ºå½“å‰ä½¿ç”¨çš„é…ç½®\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  notes: text(\"notes\"), // ç®¡ç†å‘˜å¤‡æ³¨\n});\n\n// Pool Matching Logs table - è®°å½•æ¯æ¬¡æ‰«æå’ŒåŒ¹é…å†³ç­–\nexport const poolMatchingLogs = pgTable(\"pool_matching_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  \n  poolId: varchar(\"pool_id\").notNull().references(() => eventPools.id),\n  scanType: varchar(\"scan_type\").notNull(), // \"realtime\" | \"scheduled\" | \"manual\"\n  \n  // æ‰«æå¿«ç…§\n  pendingUsersCount: integer(\"pending_users_count\").default(0),\n  currentThreshold: integer(\"current_threshold\"), // æœ¬æ¬¡æ‰«æä½¿ç”¨çš„é˜ˆå€¼\n  timeUntilEvent: integer(\"time_until_event\"), // è·ç¦»æ´»åŠ¨å¼€å§‹çš„å°æ—¶æ•°\n  \n  // åŒ¹é…ç»“æœ\n  groupsFormed: integer(\"groups_formed\").default(0),\n  usersMatched: integer(\"users_matched\").default(0),\n  avgGroupScore: integer(\"avg_group_score\"),\n  \n  // å†³ç­–ä¿¡æ¯\n  decision: varchar(\"decision\").notNull(), // \"matched\" | \"waiting\" | \"insufficient\"\n  reason: text(\"reason\"), // å†³ç­–åŸå› è¯´æ˜\n  \n  // å…ƒæ•°æ®\n  triggeredBy: varchar(\"triggered_by\"), // \"user_registration\" | \"cron_job\" | \"admin_manual\"\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Match history table - tracks who has been matched together before (anti-repetition)\nexport const matchHistory = pgTable(\"match_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  user1Id: varchar(\"user1_id\").notNull().references(() => users.id),\n  user2Id: varchar(\"user2_id\").notNull().references(() => users.id),\n  eventId: varchar(\"event_id\").notNull().references(() => events.id),\n  matchedAt: timestamp(\"matched_at\").defaultNow(),\n  connectionQuality: integer(\"connection_quality\"), // Post-event feedback: 1-5 score\n  wouldMeetAgain: boolean(\"would_meet_again\"), // Whether they'd want to be matched again\n  connectionPointTypes: text(\"connection_point_types\").array(), // Types of connection points that led to this match (for feedback correlation)\n});\n\n// Chat messages table (for event group chats)\nexport const chatMessages = pgTable(\"chat_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  eventId: varchar(\"event_id\").notNull().references(() => events.id),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  message: text(\"message\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Direct message threads table (1-on-1 chats unlocked via mutual matching)\nexport const directMessageThreads = pgTable(\"direct_message_threads\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  user1Id: varchar(\"user1_id\").notNull().references(() => users.id),\n  user2Id: varchar(\"user2_id\").notNull().references(() => users.id),\n  eventId: varchar(\"event_id\").notNull().references(() => events.id), // Event where they matched\n  unlockedAt: timestamp(\"unlocked_at\").defaultNow(), // When mutual matching unlocked the thread\n  lastMessageAt: timestamp(\"last_message_at\"), // For sorting threads by activity\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Direct messages table (1-on-1 private messages)\nexport const directMessages = pgTable(\"direct_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  threadId: varchar(\"thread_id\").notNull().references(() => directMessageThreads.id),\n  senderId: varchar(\"sender_id\").notNull().references(() => users.id),\n  message: text(\"message\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Post-event feedback table\nexport const eventFeedback = pgTable(\"event_feedback\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  eventId: varchar(\"event_id\").notNull().references(() => events.id),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  \n  // Legacy fields (deprecated but kept for backward compatibility)\n  rating: integer(\"rating\"), // 1-5 stars\n  vibeMatch: integer(\"vibe_match\"), // How well did the vibe match expectations (1-5)\n  energyMatch: integer(\"energy_match\"), // How well did the energy match (1-5)\n  wouldAttendAgain: boolean(\"would_attend_again\"),\n  feedback: text(\"feedback\"),\n  connections: text(\"connections\").array(), // User IDs of people they connected with\n  \n  // New balanced feedback system fields\n  // Dimension 1: Overall Atmosphere - Thermometer\n  atmosphereScore: integer(\"atmosphere_score\"), // 1-5 (1=å°´å°¬, 2=å¹³æ·¡, 3=èˆ’é€‚, 4=çƒ­çƒˆ, 5=å®Œç¾)\n  atmosphereNote: text(\"atmosphere_note\"), // Optional supplementary note\n  \n  // Dimension 2: Attendee Impressions - Trait Tags\n  attendeeTraits: jsonb(\"attendee_traits\"), // {userId: {displayName, tags: string[], needsImprovement: boolean, improvementNote: string}}\n  \n  // Dimension 3: Connection Radar\n  connectionRadar: jsonb(\"connection_radar\"), // {topicResonance: 1-5, personalityMatch: 1-5, backgroundDiversity: 1-5, overallFit: 1-5}\n  hasNewConnections: boolean(\"has_new_connections\"), // Whether they want to keep in touch with anyone\n  connectionStatus: varchar(\"connection_status\"), // \"å·²äº¤æ¢è”ç³»æ–¹å¼\", \"æœ‰ä½†è¿˜æ²¡è”ç³»\", \"æ²¡æœ‰ä½†å¾ˆæ„‰å¿«\", \"æ²¡æœ‰ä¸å¤ªåˆé€‚\"\n  \n  // Dimension 4: Improvement Suggestions - Magic Recipe Cards\n  improvementAreas: text(\"improvement_areas\").array(), // Max 3 areas\n  improvementOther: text(\"improvement_other\"), // Custom improvement suggestion\n  \n  // Gamification & Rewards\n  completedAt: timestamp(\"completed_at\"),\n  rewardsClaimed: boolean(\"rewards_claimed\").default(false),\n  rewardPoints: integer(\"reward_points\").default(50), // Points earned for completing feedback\n  \n  // Deep Feedback (Optional) - User Co-creation Module\n  hasDeepFeedback: boolean(\"has_deep_feedback\").default(false),\n  \n  // Module 1: Match Point Validation\n  matchPointValidation: jsonb(\"match_point_validation\"), // {[matchPoint]: {discussed: 'deeply'|'briefly'|'not', notes: string}}\n  additionalMatchPoints: text(\"additional_match_points\"), // Other common points that facilitated conversation\n  \n  // Module 2: Conversation Dynamics\n  conversationBalance: integer(\"conversation_balance\"), // 0-100 (0=all them, 50=balanced, 100=all me)\n  conversationComfort: integer(\"conversation_comfort\"), // 0-100 comfort level\n  conversationNotes: text(\"conversation_notes\"), // Optional notes about dynamics\n  \n  // Module 3: Matching Preferences\n  futurePreferences: text(\"future_preferences\").array(), // Array of preference tags\n  futurePreferencesOther: text(\"future_preferences_other\"), // Custom preferences\n  \n  deepFeedbackCompletedAt: timestamp(\"deep_feedback_completed_at\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Schemas\nexport const upsertUserSchema = createInsertSchema(users).pick({\n  id: true,\n  email: true,\n  firstName: true,\n  lastName: true,\n  profileImageUrl: true,\n});\n\nexport const updateProfileSchema = createInsertSchema(users).pick({\n  displayName: true,\n}).extend({\n  displayName: z.string().min(1, \"è¯·è¾“å…¥æ˜µç§°\"),\n});\n\n// Comprehensive profile update schema for editing profile\nexport const updateFullProfileSchema = createInsertSchema(users).pick({\n  displayName: true,\n  birthdate: true,\n  gender: true,\n  relationshipStatus: true,\n  children: true,\n  educationLevel: true,\n  studyLocale: true,\n  overseasRegions: true,\n  fieldOfStudy: true,\n  industry: true,\n  roleTitleShort: true,\n  seniority: true,\n  hometownCountry: true,\n  hometownRegionCity: true,\n  languagesComfort: true,\n  intent: true,\n  interestsTop: true,\n  topicsHappy: true,\n  topicsAvoid: true,\n  workVisibility: true,\n}).partial();\n\nexport const updatePersonalitySchema = createInsertSchema(users).pick({\n  personalityTraits: true,\n  personalityChallenges: true,\n  idealMatch: true,\n  energyLevel: true,\n});\n\nexport const insertEventAttendanceSchema = createInsertSchema(eventAttendance).pick({\n  eventId: true,\n  userId: true,\n});\n\n// Event Pool Schemas\nexport const insertEventPoolSchema = createInsertSchema(eventPools).omit({\n  id: true,\n  totalRegistrations: true,\n  successfulMatches: true,\n  createdAt: true,\n  updatedAt: true,\n  matchedAt: true,\n}).extend({\n  title: z.string().min(1, \"æ´»åŠ¨æ ‡é¢˜ä¸èƒ½ä¸ºç©º\"),\n  eventType: z.enum([\"é¥­å±€\", \"é…’å±€\", \"å…¶ä»–\"]),\n  city: z.enum([\"æ·±åœ³\", \"é¦™æ¸¯\"]),\n  dateTime: z.date(),\n  registrationDeadline: z.date(),\n  minGroupSize: z.number().min(2).max(10).default(4),\n  maxGroupSize: z.number().min(2).max(10).default(6),\n  targetGroups: z.number().min(1).default(1),\n});\n\nexport const insertEventPoolRegistrationSchema = createInsertSchema(eventPoolRegistrations).omit({\n  id: true,\n  matchStatus: true,\n  assignedGroupId: true,\n  matchScore: true,\n  registeredAt: true,\n  updatedAt: true,\n}).extend({\n  poolId: z.string().min(1),\n  userId: z.string().min(1),\n  budgetRange: z.array(z.string()).optional(),\n  preferredLanguages: z.array(z.string()).optional(),\n  socialGoals: z.array(z.string()).optional(),\n  cuisinePreferences: z.array(z.string()).optional(),\n  dietaryRestrictions: z.array(z.string()).optional(),\n  tasteIntensity: z.array(z.string()).optional(),\n});\n\nexport const insertEventPoolGroupSchema = createInsertSchema(eventPoolGroups).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertChatMessageSchema = createInsertSchema(chatMessages).pick({\n  eventId: true,\n  message: true,\n}).extend({\n  message: z.string().min(1, \"æ¶ˆæ¯ä¸èƒ½ä¸ºç©º\"),\n});\n\nexport const insertDirectMessageThreadSchema = createInsertSchema(directMessageThreads).pick({\n  user1Id: true,\n  user2Id: true,\n  eventId: true,\n});\n\nexport const insertDirectMessageSchema = createInsertSchema(directMessages).pick({\n  threadId: true,\n  message: true,\n}).extend({\n  message: z.string().min(1, \"æ¶ˆæ¯ä¸èƒ½ä¸ºç©º\"),\n});\n\nexport const insertEventFeedbackSchema = createInsertSchema(eventFeedback).omit({\n  id: true,\n  createdAt: true,\n  userId: true, // Auto-populated from session\n}).extend({\n  // Legacy fields validation\n  rating: z.number().min(1).max(5).optional(),\n  vibeMatch: z.number().min(1).max(5).optional(),\n  energyMatch: z.number().min(1).max(5).optional(),\n  \n  // New balanced feedback system validation\n  atmosphereScore: z.number().min(1).max(5).optional(),\n  atmosphereNote: z.string().optional(),\n  attendeeTraits: z.any().optional(), // JSON object\n  connectionRadar: z.any().optional(), // JSON object  \n  hasNewConnections: z.boolean().optional(),\n  connectionStatus: z.enum([\"å·²äº¤æ¢è”ç³»æ–¹å¼\", \"æœ‰ä½†è¿˜æ²¡è”ç³»\", \"æ²¡æœ‰ä½†å¾ˆæ„‰å¿«\", \"æ²¡æœ‰ä¸å¤ªåˆé€‚\"]).optional(),\n  improvementAreas: z.array(z.string()).max(3).optional(),\n  improvementOther: z.string().optional(),\n});\n\n// Blind Box Events table\nexport const blindBoxEvents = pgTable(\"blind_box_events\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  \n  // Basic info\n  title: varchar(\"title\").notNull(), // e.g., \"å‘¨ä¸‰ 19:00 Â· é¥­å±€\"\n  eventType: varchar(\"event_type\").notNull(), // é¥­å±€/é…’å±€\n  city: varchar(\"city\").notNull(), // æ·±åœ³/é¦™æ¸¯\n  district: varchar(\"district\").notNull(), // å—å±±åŒº\n  dateTime: timestamp(\"date_time\").notNull(),\n  \n  // Budget and preferences\n  budgetTier: varchar(\"budget_tier\").notNull(), // \"100-200\"\n  selectedLanguages: text(\"selected_languages\").array(),\n  selectedTasteIntensity: text(\"selected_taste_intensity\").array(),\n  selectedCuisines: text(\"selected_cuisines\").array(),\n  acceptNearby: boolean(\"accept_nearby\").default(false),\n  \n  // Matching status\n  status: varchar(\"status\").notNull().default(\"pending_match\"), // pending_match, matched, completed, canceled\n  progress: integer(\"progress\").default(0), // 0-100\n  currentParticipants: integer(\"current_participants\").default(1), // Includes creator + joined invites\n  etaMinutes: integer(\"eta_minutes\"), // Estimated time to match\n  \n  // Matched event details (populated when status = matched)\n  restaurantName: varchar(\"restaurant_name\"),\n  restaurantAddress: varchar(\"restaurant_address\"),\n  restaurantLat: varchar(\"restaurant_lat\"),\n  restaurantLng: varchar(\"restaurant_lng\"),\n  cuisineTags: text(\"cuisine_tags\").array(),\n  \n  // Participant info (populated when status = matched)\n  totalParticipants: integer(\"total_participants\"),\n  maleCount: integer(\"male_count\"),\n  femaleCount: integer(\"female_count\"),\n  isGirlsNight: boolean(\"is_girls_night\").default(false),\n  \n  // Matched attendee data (populated when status = matched)\n  matchedAttendees: jsonb(\"matched_attendees\"), // Array of {userId, displayName, archetype, topInterests, age, industry, ageVisible, industryVisible}\n  matchExplanation: text(\"match_explanation\"), // \"Why This Table?\" auto-generated narrative\n  \n  // Invite info\n  invitedCount: integer(\"invited_count\").default(0),\n  invitedJoined: integer(\"invited_joined\").default(0),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Insert schema for blind box events\nexport const insertBlindBoxEventSchema = createInsertSchema(blindBoxEvents).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  title: z.string().min(1, \"æ´»åŠ¨æ ‡é¢˜ä¸èƒ½ä¸ºç©º\"),\n  eventType: z.string().min(1, \"æ´»åŠ¨ç±»å‹ä¸èƒ½ä¸ºç©º\"),\n  city: z.string().min(1, \"åŸå¸‚ä¸èƒ½ä¸ºç©º\"),\n  district: z.string().min(1, \"å•†åœˆä¸èƒ½ä¸ºç©º\"),\n  budgetTier: z.string().min(1, \"é¢„ç®—æ¡£ä½ä¸èƒ½ä¸ºç©º\"),\n});\n\n// Personality test questions table\nexport const personalityQuestions = pgTable(\"personality_questions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  questionNumber: integer(\"question_number\").notNull(),\n  category: varchar(\"category\").notNull(), // \"åŸºç¡€è¡Œä¸ºæ¨¡å¼\", \"ååº”åå¥½\", \"è‡ªæˆ‘è®¤çŸ¥\"\n  questionText: text(\"question_text\").notNull(),\n  questionType: varchar(\"question_type\").notNull(), // \"single\" or \"dual\"\n  options: jsonb(\"options\").notNull(), // Array of {value: string, text: string, roleMapping: string}\n  testVersion: integer(\"test_version\").default(1),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Test responses table (stores user answers)\nexport const testResponses = pgTable(\"test_responses\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  questionId: varchar(\"question_id\").notNull().references(() => personalityQuestions.id),\n  selectedOption: varchar(\"selected_option\"), // For single choice\n  mostLikeOption: varchar(\"most_like_option\"), // For dual choice (2 points)\n  secondLikeOption: varchar(\"second_like_option\"), // For dual choice (1 point)\n  testVersion: integer(\"test_version\").default(1),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Role results table (stores personality test results)\nexport const roleResults = pgTable(\"role_results\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  \n  // Role scores (12 archetypes)\n  primaryRole: varchar(\"primary_role\").notNull(), // Highest scoring archetype\n  primaryRoleScore: integer(\"primary_role_score\").notNull(),\n  secondaryRole: varchar(\"secondary_role\"), // Second highest archetype (used in algorithm, hidden from UI)\n  secondaryRoleScore: integer(\"secondary_role_score\"),\n  roleSubtype: varchar(\"role_subtype\"), // Subtype based on answer patterns\n  \n  // Role score breakdown\n  roleScores: jsonb(\"role_scores\").notNull(), // {å¼€å¿ƒæŸ¯åŸº: 18, å¤ªé˜³é¸¡: 15, æš–å¿ƒç†Š: 12, ...}\n  \n  // Six-dimensional trait scores (0-10 scale)\n  affinityScore: integer(\"affinity_score\").notNull(), // äº²å’ŒåŠ›\n  opennessScore: integer(\"openness_score\").notNull(), // å¼€æ”¾æ€§\n  conscientiousnessScore: integer(\"conscientiousness_score\").notNull(), // è´£ä»»å¿ƒ\n  emotionalStabilityScore: integer(\"emotional_stability_score\").notNull(), // æƒ…ç»ªç¨³å®šæ€§\n  extraversionScore: integer(\"extraversion_score\").notNull(), // å¤–å‘æ€§\n  positivityScore: integer(\"positivity_score\").notNull(), // æ­£èƒ½é‡æ€§\n  \n  // Insights (generated text)\n  strengths: text(\"strengths\"),\n  challenges: text(\"challenges\"),\n  idealFriendTypes: text(\"ideal_friend_types\").array(),\n  \n  testVersion: integer(\"test_version\").default(1),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Registration schema (Step 1: The Essentials)\nexport const registerUserSchema = z.object({\n  // Identity\n  displayName: z.string().min(1, \"è¯·è¾“å…¥æ˜µç§°\"),\n  birthdate: z.string().min(1, \"è¯·é€‰æ‹©ç”Ÿæ—¥\"), // ISO date string - now required\n  ageVisibility: z.enum([\"hide_all\", \"show_exact_age\"]).default(\"hide_all\"),\n  gender: z.enum([\"Woman\", \"Man\", \"Nonbinary\", \"Self-describe\", \"Prefer not to say\"], {\n    errorMap: () => ({ message: \"è¯·é€‰æ‹©æ€§åˆ«\" }),\n  }),\n  pronouns: z.enum([\"She/Her\", \"He/Him\", \"They/Them\", \"Self-describe\", \"Prefer not to say\"]).optional(),\n  \n  // Background\n  relationshipStatus: z.enum([\"Single\", \"In a relationship\", \"Married/Partnered\", \"It's complicated\", \"Prefer not to say\"], {\n    errorMap: () => ({ message: \"è¯·é€‰æ‹©å…³ç³»çŠ¶æ€\" }),\n  }),\n  children: z.enum([\"No kids\", \"Expecting\", \"0-5\", \"6-12\", \"13-18\", \"Adult\", \"Prefer not to say\"]).optional(),\n  \n  // Education\n  educationLevel: z.enum([\"High school/below\", \"Some college/Associate\", \"Bachelor's\", \"Master's\", \"Doctorate\", \"Trade/Vocational\", \"Prefer not to say\"]).optional(),\n  studyLocale: z.enum([\"Local\", \"Overseas\", \"Both\", \"Prefer not to say\"]).optional(),\n  overseasRegions: z.array(z.string()).optional(),\n  fieldOfStudy: z.string().optional(),\n  educationVisibility: z.enum([\"hide_all\", \"show_level_only\", \"show_level_and_field\"]).default(\"hide_all\"),\n  \n  // Work\n  industry: z.string().min(1, \"è¯·é€‰æ‹©è¡Œä¸š\"),\n  roleTitleShort: z.string().optional(),\n  seniority: z.enum([\"Intern\", \"Junior\", \"Mid\", \"Senior\", \"Founder\", \"Executive\"]).optional(),\n  workVisibility: z.enum([\"hide_all\", \"show_industry_only\"]).default(\"show_industry_only\"),\n  \n  // Event intent (default, can be overridden per event) - multiple selections allowed\n  intent: z.array(z.enum([\"networking\", \"friends\", \"discussion\", \"fun\", \"romance\", \"flexible\"])).min(1, \"è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ´»åŠ¨æ„å›¾\"),\n  \n  // Culture & Language\n  hometownCountry: z.string().optional(),\n  hometownRegionCity: z.string().optional(),\n  hometownAffinityOptin: z.boolean().default(false),\n  languagesComfort: z.array(z.string()).optional(),\n  \n  // Access & Safety\n  accessibilityNeeds: z.string().optional(),\n  safetyNoteHost: z.string().optional(),\n  \n  // Legacy/Optional\n  wechatId: z.string().optional(),\n});\n\n// Interests & Topics schema (Step 2)\nexport const interestsTopicsSchema = z.object({\n  interestsTop: z.array(z.string()).min(3, \"è¯·è‡³å°‘é€‰æ‹©3ä¸ªå…´è¶£\").max(7, \"æœ€å¤šé€‰æ‹©7ä¸ªå…´è¶£\"),\n  interestsRankedTop3: z.array(z.string()).length(3, \"è¯·å°†ä½ æœ€å–œæ¬¢çš„3ä¸ªå…´è¶£æ’åº\"),\n  topicsHappy: z.array(z.string()).min(1, \"è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªä½ å–œæ¬¢çš„è¯é¢˜\"),\n  topicsAvoid: z.array(z.string()).optional(),\n});\n\n// Test response schema\nexport const insertTestResponseSchema = createInsertSchema(testResponses).omit({\n  id: true,\n  createdAt: true,\n});\n\n// Role result schema\nexport const insertRoleResultSchema = createInsertSchema(roleResults).omit({\n  id: true,\n  createdAt: true,\n});\n\n// ============ ADMIN PORTAL TABLES ============\n\n// Venues table - Restaurant/Bar partners\nexport const venues = pgTable(\"venues\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\").notNull(),\n  type: varchar(\"type\").notNull(), // restaurant, bar\n  address: text(\"address\").notNull(),\n  city: varchar(\"city\").notNull(), // æ·±åœ³, é¦™æ¸¯\n  district: varchar(\"district\").notNull(), // å—å±±åŒº, ä¸­ç¯ etc.\n  contactName: varchar(\"contact_name\"),\n  contactPhone: varchar(\"contact_phone\"),\n  commissionRate: integer(\"commission_rate\").default(20), // percentage\n  \n  // Venue tags for matching\n  tags: text(\"tags\").array(), // atmosphere tags: cozy, lively, upscale, casual\n  cuisines: text(\"cuisines\").array(), // ç²¤èœ, å·èœ, æ—¥æ–™, è¥¿é¤ etc.\n  priceRange: varchar(\"price_range\"), // 100-200, 200-300, 300+ per person\n  \n  // Capacity management\n  maxConcurrentEvents: integer(\"max_concurrent_events\").default(1), // How many events can run at same time\n  \n  // Status\n  isActive: boolean(\"is_active\").default(true),\n  notes: text(\"notes\"), // Internal admin notes\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Event Templates table - Recurring time slots and themes\nexport const eventTemplates = pgTable(\"event_templates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: varchar(\"name\").notNull(), // e.g., \"å‘¨ä¸‰æ™šé¤å±€\", \"Girls Night\"\n  eventType: varchar(\"event_type\").notNull(), // é¥­å±€, é…’å±€\n  dayOfWeek: integer(\"day_of_week\").notNull(), // 0-6 (Sunday-Saturday)\n  timeOfDay: varchar(\"time_of_day\").notNull(), // e.g., \"19:00\", \"21:00\"\n  \n  // Theme and restrictions\n  theme: varchar(\"theme\"), // e.g., \"Girls Night\", \"å•†åŠ¡ç¤¾äº¤\"\n  genderRestriction: varchar(\"gender_restriction\"), // null, \"Woman\", \"Man\"\n  minAge: integer(\"min_age\"),\n  maxAge: integer(\"max_age\"),\n  \n  // Participant settings\n  minParticipants: integer(\"min_participants\").default(5),\n  maxParticipants: integer(\"max_participants\").default(10),\n  \n  // Pricing (for future premium events)\n  customPrice: integer(\"custom_price\"), // null = use default pricing (ä¼šå‘˜å…è´¹/éä¼šå‘˜Â¥68)\n  \n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Subscriptions table - User memberships\nexport const subscriptions = pgTable(\"subscriptions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  \n  // Subscription period\n  subscriptionType: varchar(\"subscription_type\").notNull(), // \"1_month\", \"3_months\"\n  startDate: timestamp(\"start_date\").notNull(),\n  endDate: timestamp(\"end_date\").notNull(),\n  \n  // Payment\n  amount: integer(\"amount\").notNull(), // Â¥98 or Â¥294\n  paymentId: varchar(\"payment_id\").references(() => payments.id), // References payments table\n  \n  // Status\n  status: varchar(\"status\").notNull().default(\"active\"), // active, expired, cancelled\n  autoRenew: boolean(\"auto_renew\").default(false),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Payments table - Unified payment records\nexport const payments = pgTable(\"payments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  \n  // Payment type\n  paymentType: varchar(\"payment_type\").notNull(), // \"subscription\", \"event\"\n  relatedId: varchar(\"related_id\"), // subscription ID or event ID\n  \n  // Amount\n  originalAmount: integer(\"original_amount\").notNull(), // Before discount\n  discountAmount: integer(\"discount_amount\").default(0),\n  finalAmount: integer(\"final_amount\").notNull(), // After discount\n  \n  // Coupon\n  couponId: varchar(\"coupon_id\"), // null if no coupon used\n  \n  // WeChat Pay details\n  wechatTransactionId: varchar(\"wechat_transaction_id\"), // WeChat Pay transaction ID\n  wechatOrderId: varchar(\"wechat_order_id\"), // Our order ID sent to WeChat\n  \n  // Status\n  status: varchar(\"status\").notNull().default(\"pending\"), // pending, completed, failed, refunded\n  paidAt: timestamp(\"paid_at\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Coupons table - Discount codes\nexport const coupons = pgTable(\"coupons\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  code: varchar(\"code\").notNull().unique(), // e.g., \"WELCOME50\"\n  \n  // Discount details\n  discountType: varchar(\"discount_type\").notNull(), // \"fixed_amount\", \"percentage\"\n  discountValue: integer(\"discount_value\").notNull(), // Â¥50 or 20 (for 20%)\n  \n  // Usage limits\n  maxUses: integer(\"max_uses\"), // null = unlimited\n  currentUses: integer(\"current_uses\").default(0),\n  maxUsesPerUser: integer(\"max_uses_per_user\").default(1),\n  \n  // Validity\n  validFrom: timestamp(\"valid_from\").defaultNow(),\n  validUntil: timestamp(\"valid_until\"),\n  \n  // Applicable to\n  applicableTo: varchar(\"applicable_to\").default(\"all\"), // \"all\", \"subscription_only\", \"event_only\"\n  \n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Coupon Usage table - Track coupon redemptions\nexport const couponUsage = pgTable(\"coupon_usage\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  couponId: varchar(\"coupon_id\").notNull().references(() => coupons.id),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  paymentId: varchar(\"payment_id\").notNull().references(() => payments.id),\n  \n  discountApplied: integer(\"discount_applied\").notNull(), // Actual discount amount\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// User Coupons table - Track coupons assigned to users (e.g., rewards, promotions)\nexport const userCoupons = pgTable(\"user_coupons\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  couponId: varchar(\"coupon_id\").notNull().references(() => coupons.id),\n  \n  // How user obtained this coupon\n  source: varchar(\"source\").notNull(), // \"invitation_reward\", \"promotion\", \"admin_grant\", etc.\n  sourceId: varchar(\"source_id\"), // e.g., invitation_id for invitation rewards\n  \n  isUsed: boolean(\"is_used\").default(false),\n  usedAt: timestamp(\"used_at\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Venue Bookings table - Track venue capacity per time slot\nexport const venueBookings = pgTable(\"venue_bookings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  venueId: varchar(\"venue_id\").notNull().references(() => venues.id),\n  eventId: varchar(\"event_id\").notNull().references(() => blindBoxEvents.id),\n  \n  bookingDate: timestamp(\"booking_date\").notNull(),\n  bookingTime: varchar(\"booking_time\").notNull(), // e.g., \"19:00\"\n  \n  participantCount: integer(\"participant_count\").notNull(),\n  \n  // Sales tracking for commission\n  estimatedRevenue: integer(\"estimated_revenue\"), // Per-person average Ã— participant count\n  actualRevenue: integer(\"actual_revenue\"), // Updated post-event\n  commissionAmount: integer(\"commission_amount\"), // actualRevenue Ã— commissionRate\n  \n  status: varchar(\"status\").default(\"confirmed\"), // confirmed, completed, cancelled\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Reports table - User reports\nexport const reports = pgTable(\"reports\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  reporterId: varchar(\"reporter_id\").notNull().references(() => users.id),\n  reportedUserId: varchar(\"reported_user_id\").references(() => users.id), // null if reporting content\n  \n  // Report details\n  category: varchar(\"category\").notNull(), // harassment, inappropriate_content, fake_profile, other\n  description: text(\"description\").notNull(),\n  relatedEventId: varchar(\"related_event_id\").references(() => events.id),\n  \n  // Moderation\n  status: varchar(\"status\").default(\"pending\"), // pending, reviewing, resolved, dismissed\n  reviewedBy: varchar(\"reviewed_by\").references(() => users.id), // Admin user ID\n  reviewedAt: timestamp(\"reviewed_at\"),\n  resolution: text(\"resolution\"), // Admin's resolution notes\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Moderation Logs table - Track admin actions\nexport const moderationLogs = pgTable(\"moderation_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  adminId: varchar(\"admin_id\").notNull().references(() => users.id),\n  \n  // Action details\n  action: varchar(\"action\").notNull(), // ban_user, unban_user, delete_content, resolve_report\n  targetUserId: varchar(\"target_user_id\").references(() => users.id),\n  relatedReportId: varchar(\"related_report_id\").references(() => reports.id),\n  \n  reason: text(\"reason\"),\n  notes: text(\"notes\"), // Internal admin notes\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Content Management table - Unified table for all platform content\nexport const contents = pgTable(\"contents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  \n  // Content type: announcement, help_article, faq, community_guideline\n  type: varchar(\"type\").notNull(),\n  \n  // Content details\n  title: varchar(\"title\").notNull(),\n  content: text(\"content\").notNull(), // Rich text / Markdown\n  category: varchar(\"category\"), // Optional categorization (e.g., \"å®‰å…¨\", \"æ”¯ä»˜\", \"æ´»åŠ¨\")\n  \n  // Publishing\n  status: varchar(\"status\").default(\"draft\"), // draft, published, archived\n  priority: integer(\"priority\").default(0), // Higher = shown first\n  publishedAt: timestamp(\"published_at\"),\n  \n  // Metadata\n  createdBy: varchar(\"created_by\").notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// ============ é‚€è¯·ç³»ç»Ÿ - Invitation System ============\n\n// Invitations table - é‚€è¯·é“¾æ¥è¿½è¸ª\nexport const invitations = pgTable(\"invitations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  \n  // é‚€è¯·ç ï¼ˆå”¯ä¸€çŸ­ç ï¼Œç”¨äºç”Ÿæˆé“¾æ¥ï¼‰\n  code: varchar(\"code\").notNull().unique(), // e.g., \"a3b9c5\"\n  \n  // é‚€è¯·äººä¿¡æ¯\n  inviterId: varchar(\"inviter_id\").notNull().references(() => users.id),\n  \n  // å…³è”æ´»åŠ¨\n  eventId: varchar(\"event_id\").notNull().references(() => blindBoxEvents.id),\n  \n  // é‚€è¯·ç±»å‹\n  invitationType: varchar(\"invitation_type\").default(\"pre_match\"), // pre_match (åŒ¹é…å‰å£®èƒ†é‚€è¯·) | post_match (åŒ¹é…åè¡¥ä½é‚€è¯·)\n  \n  // çŠ¶æ€ç»Ÿè®¡\n  totalClicks: integer(\"total_clicks\").default(0), // é“¾æ¥ç‚¹å‡»æ¬¡æ•°\n  totalRegistrations: integer(\"total_registrations\").default(0), // æˆåŠŸæ³¨å†Œäººæ•°\n  successfulMatches: integer(\"successful_matches\").default(0), // æˆåŠŸåŒ¹é…åˆ°åŒå±€çš„äººæ•°\n  \n  // å…ƒæ•°æ®\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  expiresAt: timestamp(\"expires_at\"), // é‚€è¯·é“¾æ¥è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤ä¸ºæ´»åŠ¨å¼€å§‹æ—¶é—´ï¼‰\n});\n\n// Invitation Uses table - é‚€è¯·ä½¿ç”¨è®°å½•\nexport const invitationUses = pgTable(\"invitation_uses\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  \n  // å…³è”é‚€è¯·\n  invitationId: varchar(\"invitation_id\").notNull().references(() => invitations.id),\n  \n  // è¢«é‚€è¯·äººä¿¡æ¯\n  inviteeId: varchar(\"invitee_id\").notNull().references(() => users.id),\n  \n  // å…³è”ç›²ç›’æ´»åŠ¨ï¼ˆè¢«é‚€è¯·äººæŠ¥åçš„æ´»åŠ¨ï¼‰- for old blind box events\n  inviteeEventId: varchar(\"invitee_event_id\").references(() => blindBoxEvents.id),\n  \n  // å…³è”æ´»åŠ¨æ± æŠ¥åï¼ˆè¢«é‚€è¯·äººçš„æ± æŠ¥åï¼‰- for new pool-based events\n  poolRegistrationId: varchar(\"pool_registration_id\").references(() => eventPoolRegistrations.id),\n  \n  // åŒ¹é…ç»“æœ\n  matchedTogether: boolean(\"matched_together\").default(false), // æ˜¯å¦æœ€ç»ˆåŒ¹é…åˆ°åŒä¸€å±€\n  rewardIssued: boolean(\"reward_issued\").default(false), // æ˜¯å¦å·²å‘æ”¾å¥–åŠ±\n  \n  // å…ƒæ•°æ®\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  matchedAt: timestamp(\"matched_at\"), // åŒ¹é…æˆåŠŸæ—¶é—´\n});\n\n// Insert schemas for admin tables\nexport const insertVenueSchema = createInsertSchema(venues).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertEventTemplateSchema = createInsertSchema(eventTemplates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertSubscriptionSchema = createInsertSchema(subscriptions).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertPaymentSchema = createInsertSchema(payments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertCouponSchema = createInsertSchema(coupons).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertUserCouponSchema = createInsertSchema(userCoupons).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertReportSchema = createInsertSchema(reports).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertModerationLogSchema = createInsertSchema(moderationLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertContentSchema = createInsertSchema(contents).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\n// Types\nexport type UpsertUser = z.infer<typeof upsertUserSchema>;\nexport type User = typeof users.$inferSelect;\nexport type UpdateProfile = z.infer<typeof updateProfileSchema>;\nexport type UpdateFullProfile = z.infer<typeof updateFullProfileSchema>;\nexport type UpdatePersonality = z.infer<typeof updatePersonalitySchema>;\nexport type RegisterUser = z.infer<typeof registerUserSchema>;\nexport type InterestsTopics = z.infer<typeof interestsTopicsSchema>;\n\nexport type Event = typeof events.$inferSelect;\nexport type EventAttendance = typeof eventAttendance.$inferSelect;\nexport type EventPool = typeof eventPools.$inferSelect;\nexport type EventPoolRegistration = typeof eventPoolRegistrations.$inferSelect;\nexport type EventPoolGroup = typeof eventPoolGroups.$inferSelect;\nexport type ChatMessage = typeof chatMessages.$inferSelect;\nexport type DirectMessageThread = typeof directMessageThreads.$inferSelect;\nexport type DirectMessage = typeof directMessages.$inferSelect;\nexport type EventFeedback = typeof eventFeedback.$inferSelect;\nexport type BlindBoxEvent = typeof blindBoxEvents.$inferSelect;\nexport type PersonalityQuestion = typeof personalityQuestions.$inferSelect;\nexport type TestResponse = typeof testResponses.$inferSelect;\nexport type RoleResult = typeof roleResults.$inferSelect;\n\nexport type InsertEventAttendance = z.infer<typeof insertEventAttendanceSchema>;\nexport type InsertEventPool = z.infer<typeof insertEventPoolSchema>;\nexport type InsertEventPoolRegistration = z.infer<typeof insertEventPoolRegistrationSchema>;\nexport type InsertEventPoolGroup = z.infer<typeof insertEventPoolGroupSchema>;\nexport type InsertChatMessage = z.infer<typeof insertChatMessageSchema>;\nexport type InsertDirectMessageThread = z.infer<typeof insertDirectMessageThreadSchema>;\nexport type InsertDirectMessage = z.infer<typeof insertDirectMessageSchema>;\nexport type InsertEventFeedback = z.infer<typeof insertEventFeedbackSchema>;\nexport type InsertBlindBoxEvent = z.infer<typeof insertBlindBoxEventSchema>;\nexport type InsertTestResponse = z.infer<typeof insertTestResponseSchema>;\nexport type InsertRoleResult = z.infer<typeof insertRoleResultSchema>;\n\n// Admin Portal Types\nexport type Venue = typeof venues.$inferSelect;\nexport type EventTemplate = typeof eventTemplates.$inferSelect;\nexport type Subscription = typeof subscriptions.$inferSelect;\nexport type Payment = typeof payments.$inferSelect;\nexport type Coupon = typeof coupons.$inferSelect;\nexport type CouponUsage = typeof couponUsage.$inferSelect;\nexport type UserCoupon = typeof userCoupons.$inferSelect;\nexport type VenueBooking = typeof venueBookings.$inferSelect;\nexport type Report = typeof reports.$inferSelect;\nexport type ModerationLog = typeof moderationLogs.$inferSelect;\nexport type Content = typeof contents.$inferSelect;\n\nexport type InsertVenue = z.infer<typeof insertVenueSchema>;\nexport type InsertEventTemplate = z.infer<typeof insertEventTemplateSchema>;\nexport type InsertSubscription = z.infer<typeof insertSubscriptionSchema>;\nexport type InsertPayment = z.infer<typeof insertPaymentSchema>;\nexport type InsertCoupon = z.infer<typeof insertCouponSchema>;\nexport type InsertUserCoupon = z.infer<typeof insertUserCouponSchema>;\nexport type InsertReport = z.infer<typeof insertReportSchema>;\nexport type InsertModerationLog = z.infer<typeof insertModerationLogSchema>;\nexport type InsertContent = z.infer<typeof insertContentSchema>;\n\n// ============ MATCHING ALGORITHM TABLES ============\n\n// Matching configuration table - stores algorithm weights\nexport const matchingConfig = pgTable(\"matching_config\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  configName: varchar(\"config_name\").notNull().default(\"default\"), // config version name\n  \n  // 5ä¸ªç»´åº¦çš„æƒé‡ (0-100, æ€»å’Œåº”ä¸º100)\n  personalityWeight: integer(\"personality_weight\").notNull().default(30), // æ€§æ ¼å…¼å®¹æ€§æƒé‡\n  interestsWeight: integer(\"interests_weight\").notNull().default(25),     // å…´è¶£åŒ¹é…æƒé‡\n  intentWeight: integer(\"intent_weight\").notNull().default(20),           // æ„å›¾åŒ¹é…æƒé‡\n  backgroundWeight: integer(\"background_weight\").notNull().default(15),   // èƒŒæ™¯å¤šæ ·æ€§æƒé‡\n  cultureWeight: integer(\"culture_weight\").notNull().default(10),         // æ–‡åŒ–è¯­è¨€æƒé‡\n  \n  // å…¶ä»–åŒ¹é…å‚æ•°\n  minGroupSize: integer(\"min_group_size\").default(5),\n  maxGroupSize: integer(\"max_group_size\").default(10),\n  preferredGroupSize: integer(\"preferred_group_size\").default(7),\n  \n  // çº¦æŸæ¡ä»¶\n  maxSameArchetypeRatio: integer(\"max_same_archetype_ratio\").default(40), // åŒä¸€åŸå‹æœ€å¤šå æ¯”ï¼ˆ%ï¼‰\n  minChemistryScore: integer(\"min_chemistry_score\").default(60),          // æœ€ä½åŒ–å­¦ååº”åˆ†æ•°\n  \n  // æ˜¯å¦ä¸ºæ´»è·ƒé…ç½®\n  isActive: boolean(\"is_active\").default(false),\n  \n  // å…ƒæ•°æ®\n  notes: text(\"notes\"), // é…ç½®è¯´æ˜\n  createdBy: varchar(\"created_by\"), // åˆ›å»ºè€…IDï¼ˆadminï¼‰\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertMatchingConfigSchema = createInsertSchema(matchingConfig).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  configName: z.string().min(1, \"é…ç½®åç§°ä¸èƒ½ä¸ºç©º\"),\n  personalityWeight: z.number().min(0).max(100),\n  interestsWeight: z.number().min(0).max(100),\n  intentWeight: z.number().min(0).max(100),\n  backgroundWeight: z.number().min(0).max(100),\n  cultureWeight: z.number().min(0).max(100),\n});\n\nexport type MatchingConfig = typeof matchingConfig.$inferSelect;\nexport type InsertMatchingConfig = z.infer<typeof insertMatchingConfigSchema>;\n\n// Matching results table - stores historical matching results for analysis\nexport const matchingResults = pgTable(\"matching_results\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  eventId: varchar(\"event_id\"), // å¯é€‰ï¼Œå…³è”åˆ°å…·ä½“æ´»åŠ¨\n  configId: varchar(\"config_id\").references(() => matchingConfig.id),\n  \n  // è¾“å…¥æ•°æ®\n  userIds: text(\"user_ids\").array(), // å‚ä¸åŒ¹é…çš„ç”¨æˆ·IDåˆ—è¡¨\n  userCount: integer(\"user_count\").notNull(),\n  \n  // åŒ¹é…ç»“æœ\n  groups: jsonb(\"groups\").notNull(), // [{groupId, userIds, chemistryScore, diversityScore, overallScore}]\n  groupCount: integer(\"group_count\").notNull(),\n  \n  // è¯„åˆ†æŒ‡æ ‡\n  avgChemistryScore: integer(\"avg_chemistry_score\"), // å¹³å‡åŒ–å­¦ååº”åˆ†æ•°\n  avgDiversityScore: integer(\"avg_diversity_score\"), // å¹³å‡å¤šæ ·æ€§åˆ†æ•°\n  overallMatchQuality: integer(\"overall_match_quality\"), // æ•´ä½“åŒ¹é…è´¨é‡ (0-100)\n  \n  // æ€§èƒ½æŒ‡æ ‡\n  executionTimeMs: integer(\"execution_time_ms\"), // åŒ¹é…ç®—æ³•æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰\n  \n  // å…ƒæ•°æ®\n  isTestRun: boolean(\"is_test_run\").default(false), // æ˜¯å¦ä¸ºæµ‹è¯•è¿è¡Œ\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertMatchingResultSchema = createInsertSchema(matchingResults).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type MatchingResult = typeof matchingResults.$inferSelect;\nexport type InsertMatchingResult = z.infer<typeof insertMatchingResultSchema>;\n\n// Notifications table\nexport const notifications = pgTable(\"notifications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  category: varchar(\"category\").notNull(), // discover, activities, chat\n  type: varchar(\"type\").notNull(), // new_activity, matching_progress, match_success, activity_reminder, feedback_reminder, new_message, admin_announcement\n  title: varchar(\"title\").notNull(),\n  message: text(\"message\"),\n  relatedResourceId: varchar(\"related_resource_id\"), // event ID, chat ID, etc.\n  isRead: boolean(\"is_read\").default(false),\n  sentBy: varchar(\"sent_by\").references(() => users.id), // Admin user ID if sent by admin\n  isBroadcast: boolean(\"is_broadcast\").default(false), // Whether this is a broadcast notification\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertNotificationSchema = createInsertSchema(notifications).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Notification = typeof notifications.$inferSelect;\nexport type InsertNotification = z.infer<typeof insertNotificationSchema>;\n\n// Notification count response type\nexport type NotificationCounts = {\n  discover: number;\n  activities: number;\n  chat: number;\n  total: number;\n};\n\n// ============ CHAT MODERATION & LOGGING TABLES ============\n\n// Chat reports table - user reports of inappropriate messages\nexport const chatReports = pgTable(\"chat_reports\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  messageId: varchar(\"message_id\").notNull().references(() => chatMessages.id),\n  eventId: varchar(\"event_id\").references(() => events.id),\n  threadId: varchar(\"thread_id\").references(() => directMessageThreads.id),\n  reportedBy: varchar(\"reported_by\").notNull().references(() => users.id),\n  reportedUserId: varchar(\"reported_user_id\").notNull().references(() => users.id),\n  \n  reportType: varchar(\"report_type\").notNull(), // harassment, spam, inappropriate, hate_speech, other\n  description: text(\"description\"),\n  \n  status: varchar(\"status\").notNull().default(\"pending\"), // pending, reviewed, dismissed, action_taken\n  reviewedBy: varchar(\"reviewed_by\").references(() => users.id), // Admin who reviewed\n  reviewNotes: text(\"review_notes\"),\n  actionTaken: varchar(\"action_taken\"), // none, warning, temporary_ban, permanent_ban, message_deleted\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  reviewedAt: timestamp(\"reviewed_at\"),\n});\n\n// Chat logs table - technical logs for debugging\nexport const chatLogs = pgTable(\"chat_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  eventType: varchar(\"event_type\").notNull(), // message_sent, message_failed, connection_error, ws_connected, ws_disconnected\n  eventId: varchar(\"event_id\").references(() => events.id),\n  threadId: varchar(\"thread_id\").references(() => directMessageThreads.id),\n  userId: varchar(\"user_id\").references(() => users.id),\n  \n  severity: varchar(\"severity\").notNull().default(\"info\"), // info, warning, error\n  message: text(\"message\").notNull(),\n  metadata: jsonb(\"metadata\"), // Additional context (error details, message ID, etc.)\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"chat_logs_event_id_idx\").on(table.eventId),\n  index(\"chat_logs_user_id_idx\").on(table.userId),\n  index(\"chat_logs_severity_idx\").on(table.severity),\n  index(\"chat_logs_created_at_idx\").on(table.createdAt),\n]);\n\nexport const insertChatReportSchema = createInsertSchema(chatReports).omit({\n  id: true,\n  createdAt: true,\n  reviewedAt: true,\n}).extend({\n  reportType: z.enum([\"harassment\", \"spam\", \"inappropriate\", \"hate_speech\", \"other\"]),\n  description: z.string().optional(),\n});\n\nexport const insertChatLogSchema = createInsertSchema(chatLogs).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  eventType: z.string().min(1),\n  severity: z.enum([\"info\", \"warning\", \"error\"]),\n  message: z.string().min(1),\n});\n\nexport type ChatReport = typeof chatReports.$inferSelect;\nexport type ChatLog = typeof chatLogs.$inferSelect;\nexport type InsertChatReport = z.infer<typeof insertChatReportSchema>;\nexport type InsertChatLog = z.infer<typeof insertChatLogSchema>;\n\n// ============ Invitation System Schemas ============\n\nexport const insertInvitationSchema = createInsertSchema(invitations).omit({\n  id: true,\n  createdAt: true,\n  totalClicks: true,\n  totalRegistrations: true,\n  successfulMatches: true,\n});\n\nexport const insertInvitationUseSchema = createInsertSchema(invitationUses).omit({\n  id: true,\n  createdAt: true,\n  matchedAt: true,\n  matchedTogether: true,\n  rewardIssued: true,\n});\n\nexport type Invitation = typeof invitations.$inferSelect;\nexport type InvitationUse = typeof invitationUses.$inferSelect;\nexport type InsertInvitation = z.infer<typeof insertInvitationSchema>;\nexport type InsertInvitationUse = z.infer<typeof insertInvitationUseSchema>;\n","size_bytes":58222},"client/src/lib/authUtils.ts":{"content":"export function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n","size_bytes":116},"server/replitAuth.ts":{"content":"import * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\n\nif (!process.env.REPLIT_DOMAINS) {\n  throw new Error(\"Environment variable REPLIT_DOMAINS not provided\");\n}\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: true,\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(\n  claims: any,\n) {\n  await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  for (const domain of process.env\n    .REPLIT_DOMAINS!.split(\",\")) {\n    const strategy = new Strategy(\n      {\n        name: `replitauth:${domain}`,\n        config,\n        scope: \"openid email profile offline_access\",\n        callbackURL: `https://${domain}/api/callback`,\n      },\n      verify,\n    );\n    passport.use(strategy);\n  }\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n","size_bytes":4221},"client/src/pages/ProfileSetupPage.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useLocation } from \"wouter\";\n\nexport default function ProfileSetupPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [displayName, setDisplayName] = useState(\"\");\n\n  const setupMutation = useMutation({\n    mutationFn: async (data: { displayName: string }) => {\n      return await apiRequest(\"POST\", \"/api/profile/setup\", data);\n    },\n    onSuccess: async () => {\n      // Refetch auth user to update onboarding state\n      await queryClient.refetchQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"èµ„æ–™å·²ä¿å­˜\",\n        description: \"æ¬¢è¿æ¥åˆ°æ‚¦èšï¼\",\n      });\n      setLocation(\"/\");\n    },\n    onError: (error) => {\n      toast({\n        title: \"ä¿å­˜å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = () => {\n    if (!displayName.trim()) {\n      toast({\n        title: \"è¯·è¾“å…¥æ˜µç§°\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setupMutation.mutate({\n      displayName: displayName.trim(),\n    });\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"container mx-auto px-4 py-8 max-w-2xl\">\n        <div className=\"space-y-6\">\n          <div className=\"text-center space-y-2\">\n            <h1 className=\"text-2xl font-display font-bold\">å®Œå–„èµ„æ–™</h1>\n            <p className=\"text-sm text-muted-foreground\">\n              è®©å¤§å®¶æ›´å¥½åœ°è®¤è¯†ä½ \n            </p>\n          </div>\n\n          <Card className=\"border shadow-sm\">\n            <CardContent className=\"p-6 space-y-6\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"displayName\">æ˜µç§°</Label>\n                <Input\n                  id=\"displayName\"\n                  placeholder=\"è¾“å…¥ä½ çš„æ˜µç§°\"\n                  value={displayName}\n                  onChange={(e) => setDisplayName(e.target.value)}\n                  data-testid=\"input-display-name\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  è¿™æ˜¯å…¶ä»–äººçœ‹åˆ°çš„åå­—\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Button\n            size=\"lg\"\n            className=\"w-full\"\n            onClick={handleSubmit}\n            disabled={setupMutation.isPending}\n            data-testid=\"button-save-profile\"\n          >\n            {setupMutation.isPending ? \"ä¿å­˜ä¸­...\" : \"ç»§ç»­\"}\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":2976},"client/src/hooks/useAuth.ts":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport type { User } from \"@shared/schema\";\n\nexport function useAuth() {\n  const { data: user, isLoading, isError } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n    retry: false,\n    staleTime: Infinity,\n  });\n\n  // If there's an error or no user, treat as not authenticated (don't stay in loading state)\n  const isAuthenticated = !!user && !isError;\n  const actualIsLoading = isLoading && !isError;\n\n  return {\n    user: isError ? undefined : user,\n    isLoading: actualIsLoading,\n    isAuthenticated,\n    needsRegistration: user && !user.hasCompletedRegistration,\n    needsInterestsTopics: user && user.hasCompletedRegistration && !user.hasCompletedInterestsTopics,\n    needsPersonalityTest: user && user.hasCompletedRegistration && user.hasCompletedInterestsTopics && !user.hasCompletedPersonalityTest,\n    needsProfileSetup: user && user.hasCompletedPersonalityTest && !user.hasCompletedProfileSetup,\n  };\n}\n","size_bytes":970},"client/src/pages/ChatsPage.tsx":{"content":"import MobileHeader from \"@/components/MobileHeader\";\nimport BottomNav from \"@/components/BottomNav\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Calendar, MapPin, MessageSquare, Users, User, Lock, Clock } from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { useEffect, useState } from \"react\";\nimport { useMarkNotificationsAsRead } from \"@/hooks/useNotificationCounts\";\nimport ParticipantAvatars from \"@/components/ParticipantAvatars\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { archetypeConfig } from \"@/lib/archetypes\";\nimport { \n  getGenderDisplay, \n  formatAge, \n  getEducationDisplay\n} from \"@/lib/userFieldMappings\";\nimport type { Event, DirectMessageThread, User as UserType } from \"@shared/schema\";\n\ntype EventWithParticipants = Event & { \n  attendanceStatus: string; \n  attendeeCount: number;\n  participants: Array<{ id: string; displayName: string | null; vibes: string[] | null }>;\n};\n\ntype DirectThreadWithUser = DirectMessageThread & {\n  otherUser: UserType;\n  lastMessage: {\n    content: string;\n    createdAt: Date;\n  } | null;\n};\n\nexport default function ChatsPage() {\n  const [, setLocation] = useLocation();\n  const markAsRead = useMarkNotificationsAsRead();\n  const { toast } = useToast();\n  const [isCreatingDemo, setIsCreatingDemo] = useState(false);\n  const [expandedThreadId, setExpandedThreadId] = useState<string | null>(null);\n\n  const { data: joinedEvents, isLoading: isLoadingEvents, refetch: refetchEvents } = useQuery<Array<EventWithParticipants>>({\n    queryKey: [\"/api/events/joined\"],\n  });\n\n  const { data: directThreads, isLoading: isLoadingThreads, refetch: refetchThreads } = useQuery<Array<DirectThreadWithUser>>({\n    queryKey: [\"/api/direct-messages\"],\n  });\n\n  const createNotificationMutation = useMutation({\n    mutationFn: async (data: {\n      category: string;\n      type: string;\n      title: string;\n      message: string;\n      relatedResourceId?: string;\n    }) => {\n      return await apiRequest(\"POST\", \"/api/notifications\", data);\n    },\n  });\n\n  const createDemoChats = async () => {\n    try {\n      setIsCreatingDemo(true);\n      const response: any = await apiRequest(\"POST\", \"/api/chats/seed-demo\", {});\n      \n      toast({\n        title: \"æ¼”ç¤ºæ•°æ®åˆ›å»ºæˆåŠŸ\",\n        description: \"å·²åˆ›å»º3ä¸ªæ¼”ç¤ºèŠå¤©çª—å£\",\n      });\n      \n      await refetchEvents();\n      await refetchThreads();\n    } catch (error) {\n      console.error(\"Error creating demo chats:\", error);\n      toast({\n        title: \"åˆ›å»ºå¤±è´¥\",\n        description: \"è¯·ç¨åé‡è¯•\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsCreatingDemo(false);\n    }\n  };\n\n  const isChatUnlocked = (eventDateTime: Date | null) => {\n    if (!eventDateTime) return false;\n    const now = new Date();\n    const eventDate = new Date(eventDateTime);\n    const hoursUntilEvent = (eventDate.getTime() - now.getTime()) / (1000 * 60 * 60);\n    return hoursUntilEvent <= 24 || now > eventDate;\n  };\n\n  const getUnlockCountdown = (eventDateTime: Date | null) => {\n    if (!eventDateTime) return \"\";\n    const now = new Date();\n    const eventDate = new Date(eventDateTime);\n    const unlockTime = new Date(eventDate.getTime() - 24 * 60 * 60 * 1000);\n    \n    if (now >= unlockTime) return \"\";\n    \n    const msUntilUnlock = unlockTime.getTime() - now.getTime();\n    const days = Math.floor(msUntilUnlock / (1000 * 60 * 60 * 24));\n    const hours = Math.floor((msUntilUnlock % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n    const minutes = Math.floor((msUntilUnlock % (1000 * 60 * 60)) / (1000 * 60));\n    \n    if (days > 0) {\n      return `${days}å¤©${hours}å°æ—¶åå¼€æ”¾`;\n    } else if (hours > 0) {\n      return `${hours}å°æ—¶${minutes}åˆ†é’Ÿåå¼€æ”¾`;\n    } else {\n      return `${minutes}åˆ†é’Ÿåå¼€æ”¾`;\n    }\n  };\n\n  useEffect(() => {\n    markAsRead.mutate('chat');\n  }, []);\n\n  useEffect(() => {\n    if (!joinedEvents || joinedEvents.length === 0) return;\n\n    const notifiedChats = JSON.parse(localStorage.getItem('chat_unlock_notified') || '[]');\n    \n    joinedEvents.forEach((event) => {\n      const isUnlocked = isChatUnlocked(event.dateTime);\n      const alreadyNotified = notifiedChats.includes(event.id);\n      \n      if (isUnlocked && !alreadyNotified) {\n        createNotificationMutation.mutate({\n          category: 'chat',\n          type: 'chat_unlocked',\n          title: 'ç¾¤èŠå·²å¼€æ”¾',\n          message: `ã€Œ${event.title}ã€çš„ç¾¤èŠå·²å¼€æ”¾ï¼Œå¿«æ¥è®¤è¯†æ–°æœ‹å‹å§ï¼`,\n          relatedResourceId: event.id,\n        });\n        \n        const updated = [...notifiedChats, event.id];\n        localStorage.setItem('chat_unlock_notified', JSON.stringify(updated));\n      }\n    });\n  }, [joinedEvents]);\n\n  const formatDate = (dateTime: Date | null) => {\n    if (!dateTime) return \"\";\n    const date = new Date(dateTime);\n    const month = date.getMonth() + 1;\n    const day = date.getDate();\n    const hours = date.getHours().toString().padStart(2, '0');\n    const minutes = date.getMinutes().toString().padStart(2, '0');\n    return `${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;\n  };\n\n  const formatMessageTime = (date: Date | null) => {\n    if (!date) return \"\";\n    const messageDate = new Date(date);\n    const now = new Date();\n    const diffMs = now.getTime() - messageDate.getTime();\n    const diffMins = Math.floor(diffMs / (1000 * 60));\n    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));\n    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));\n\n    if (diffMins < 1) return \"åˆšåˆš\";\n    if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;\n    if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;\n    if (diffDays < 7) return `${diffDays}å¤©å‰`;\n    \n    const month = messageDate.getMonth() + 1;\n    const day = messageDate.getDate();\n    return `${month}æœˆ${day}æ—¥`;\n  };\n\n  const isEventPast = (dateTime: Date | null) => {\n    if (!dateTime) return false;\n    return new Date(dateTime) < new Date();\n  };\n\n  const getInitials = (name: string | null) => {\n    if (!name) return \"?\";\n    const chars = name.trim().split('');\n    return chars.length > 0 ? chars[0].toUpperCase() : \"?\";\n  };\n\n  const isLoading = isLoadingEvents || isLoadingThreads;\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background pb-16\">\n        <MobileHeader title=\"èŠå¤©\" />\n        <div className=\"flex items-center justify-center py-12\">\n          <div className=\"text-center space-y-4\">\n            <div className=\"h-8 w-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n            <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n          </div>\n        </div>\n        <BottomNav />\n      </div>\n    );\n  }\n\n  const hasGroupChats = joinedEvents && joinedEvents.length > 0;\n  const hasDirectChats = directThreads && directThreads.length > 0;\n  const groupCount = joinedEvents?.length || 0;\n  const directCount = directThreads?.length || 0;\n\n  return (\n    <div className=\"min-h-screen bg-background pb-16\">\n      <MobileHeader title=\"èŠå¤©\" />\n      \n      {!hasGroupChats && !hasDirectChats ? (\n        <div className=\"px-4 py-4\">\n          <Card className=\"border shadow-sm\">\n            <CardContent className=\"p-8 text-center\">\n              <MessageSquare className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n              <h3 className=\"font-semibold mb-2\">æš‚æ— èŠå¤©</h3>\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                å‚åŠ æ´»åŠ¨å¹¶ä¸å…¶ä»–å‚ä¸è€…åŒ¹é…åï¼Œå°±å¯ä»¥åœ¨è¿™é‡ŒèŠå¤©äº†\n              </p>\n              <Button \n                onClick={createDemoChats}\n                disabled={isCreatingDemo}\n                variant=\"outline\"\n                size=\"sm\"\n                data-testid=\"button-create-demo\"\n              >\n                {isCreatingDemo ? \"åˆ›å»ºä¸­...\" : \"åˆ›å»ºæ¼”ç¤ºèŠå¤©ï¼ˆæµ‹è¯•ç”¨ï¼‰\"}\n              </Button>\n            </CardContent>\n          </Card>\n        </div>\n      ) : (\n        <Tabs defaultValue=\"group\" className=\"w-full\">\n          <div className=\"sticky top-14 z-30 bg-background border-b\">\n            <TabsList className=\"w-full justify-start rounded-none h-12 px-4 bg-transparent\">\n              <TabsTrigger \n                value=\"group\" \n                className=\"flex items-center gap-2 data-[state=active]:bg-muted\"\n                data-testid=\"tab-group-chats\"\n              >\n                <Users className=\"h-4 w-4\" />\n                <span>ç¾¤èŠ</span>\n                {groupCount > 0 && (\n                  <Badge variant=\"secondary\" className=\"ml-1 h-5 min-w-5 px-1.5 text-[10px]\">\n                    {groupCount}\n                  </Badge>\n                )}\n              </TabsTrigger>\n              <TabsTrigger \n                value=\"direct\" \n                className=\"flex items-center gap-2 data-[state=active]:bg-muted\"\n                data-testid=\"tab-direct-chats\"\n              >\n                <User className=\"h-4 w-4\" />\n                <span>ç§èŠ</span>\n                {directCount > 0 && (\n                  <Badge variant=\"secondary\" className=\"ml-1 h-5 min-w-5 px-1.5 text-[10px]\">\n                    {directCount}\n                  </Badge>\n                )}\n              </TabsTrigger>\n            </TabsList>\n          </div>\n\n          <TabsContent value=\"group\" className=\"m-0 mt-4\">\n            {hasGroupChats ? (\n              <div className=\"px-4 pb-4 space-y-3\">\n                {joinedEvents.map((event) => {\n                  const isPast = isEventPast(event.dateTime);\n                  const chatUnlocked = isChatUnlocked(event.dateTime);\n                  const countdown = getUnlockCountdown(event.dateTime);\n                  const isLocked = !chatUnlocked && !isPast;\n                  \n                  return (\n                    <Card \n                      key={event.id} \n                      className={`hover-elevate active-elevate-2 transition-all cursor-pointer overflow-hidden ${\n                        isLocked ? 'bg-muted/30 border-muted' : ''\n                      }`}\n                      onClick={() => setLocation(`/chats/${event.id}`)}\n                      data-testid={`card-event-${event.id}`}\n                    >\n                      {/* çŠ¶æ€æ ï¼šé”å®šçŠ¶æ€ï¼ˆç°è‰²ï¼‰æˆ–è§£é”çŠ¶æ€ï¼ˆç´«è‰²ï¼‰ */}\n                      {isLocked ? (\n                        <div className=\"bg-muted text-muted-foreground px-4 py-2.5 flex items-center gap-2\">\n                          <Lock className=\"h-4 w-4 flex-shrink-0\" />\n                          <span className=\"text-base font-bold\">\n                            èŠå¤© {countdown} å¼€æ”¾\n                          </span>\n                        </div>\n                      ) : (\n                        <div className=\"bg-primary text-primary-foreground px-4 py-2 flex items-center gap-2\">\n                          <MessageSquare className=\"h-4 w-4 flex-shrink-0\" />\n                          <span className=\"font-semibold text-sm\">èŠå¤©å·²å¼€æ”¾</span>\n                          {isPast && (\n                            <Badge variant=\"secondary\" className=\"ml-auto text-[10px] h-5 bg-primary-foreground/20 border-0\">\n                              å·²ç»“æŸ\n                            </Badge>\n                          )}\n                        </div>\n                      )}\n\n                      <CardContent className=\"p-4\">\n                        <div className=\"space-y-3\">\n                          <div className=\"flex items-start justify-between gap-3\">\n                            <div className=\"flex-1\">\n                              <h3 className={`font-semibold ${isLocked ? 'text-[#8E8E93]' : ''}`}>\n                                {event.title}\n                              </h3>\n                            </div>\n                          </div>\n                          \n                          <div className={`space-y-2 text-xs ${isLocked ? 'text-[#8E8E93]' : 'text-muted-foreground'}`}>\n                            <div className=\"flex items-center gap-1.5\">\n                              <Calendar className=\"h-3.5 w-3.5\" />\n                              <span>{formatDate(event.dateTime)}</span>\n                            </div>\n                            \n                            <div className=\"flex items-center gap-1.5\">\n                              <MapPin className=\"h-3.5 w-3.5\" />\n                              <span>{event.location}</span>\n                            </div>\n                            \n                            {!isLocked && (\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-xs text-muted-foreground\">å‚ä¸è€…</span>\n                                <ParticipantAvatars \n                                  participants={event.participants || []} \n                                  maxDisplay={8}\n                                  size=\"sm\"\n                                />\n                                {event.attendeeCount > 8 && (\n                                  <span className=\"text-xs text-muted-foreground ml-1\">\n                                    å…±{event.attendeeCount}äºº\n                                  </span>\n                                )}\n                              </div>\n                            )}\n                            \n                            {isLocked && (\n                              <div className=\"flex items-center gap-2 pt-1\">\n                                <Users className=\"h-3.5 w-3.5 opacity-50\" />\n                                <span className=\"text-xs opacity-50\">å¼€æ”¾åå¯è§å‚ä¸è€…</span>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  );\n                })}\n              </div>\n            ) : (\n              <div className=\"px-4 py-8\">\n                <Card className=\"border shadow-sm\">\n                  <CardContent className=\"p-8 text-center\">\n                    <Users className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                    <h3 className=\"font-semibold mb-2\">æš‚æ— ç¾¤èŠ</h3>\n                    <p className=\"text-sm text-muted-foreground\">\n                      å‚åŠ æ´»åŠ¨åï¼Œç¾¤èŠå°†åœ¨æ´»åŠ¨å¼€å§‹å‰24å°æ—¶å¼€æ”¾\n                    </p>\n                  </CardContent>\n                </Card>\n              </div>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"direct\" className=\"m-0 mt-4\">\n            {hasDirectChats ? (\n              <div className=\"px-4 pb-4 space-y-3\">\n                {directThreads.map((thread) => {\n                  const otherUser = thread.otherUser;\n                  const lastMessage = thread.lastMessage;\n                  const isExpanded = expandedThreadId === thread.id;\n                  const archetypeData = otherUser.archetype && archetypeConfig[otherUser.archetype]\n                    ? archetypeConfig[otherUser.archetype]\n                    : null;\n                  \n                  return (\n                    <Card \n                      key={thread.id} \n                      className=\"hover-elevate active-elevate-2 transition-all cursor-pointer overflow-hidden\"\n                      onClick={() => setLocation(`/direct-chat/${thread.id}`)}\n                      data-testid={`card-direct-${thread.id}`}\n                    >\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-start gap-3\">\n                          {/* Avatar - clickable to expand */}\n                          <div\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              setExpandedThreadId(isExpanded ? null : thread.id);\n                            }}\n                            className=\"cursor-pointer\"\n                            data-testid={`avatar-expand-${thread.id}`}\n                          >\n                            {archetypeData ? (\n                              <div className={`h-12 w-12 flex-shrink-0 rounded-full ${archetypeData.bgColor} flex items-center justify-center text-2xl`}>\n                                {archetypeData.icon}\n                              </div>\n                            ) : (\n                              <Avatar className=\"h-12 w-12 flex-shrink-0\">\n                                <AvatarFallback className=\"bg-primary/10 text-primary font-semibold\">\n                                  {getInitials(otherUser.displayName)}\n                                </AvatarFallback>\n                              </Avatar>\n                            )}\n                          </div>\n                          \n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center justify-between gap-2 mb-1\">\n                              <h3 className=\"font-semibold truncate\">\n                                {otherUser.displayName || \"åŒ¿åç”¨æˆ·\"}\n                              </h3>\n                              {lastMessage && (\n                                <span className=\"text-xs text-muted-foreground flex-shrink-0\">\n                                  {formatMessageTime(lastMessage.createdAt)}\n                                </span>\n                              )}\n                            </div>\n                            \n                            {otherUser.archetype && (\n                              <Badge variant=\"secondary\" className=\"text-[10px] h-5 mb-2\">\n                                {otherUser.archetype}\n                              </Badge>\n                            )}\n                            \n                            {lastMessage ? (\n                              <p className=\"text-sm text-muted-foreground line-clamp-2\">\n                                {lastMessage.content}\n                              </p>\n                            ) : (\n                              <p className=\"text-sm text-muted-foreground italic\">\n                                æš‚æ— æ¶ˆæ¯\n                              </p>\n                            )}\n                            \n                            {/* Expandable User Info */}\n                            <AnimatePresence>\n                              {isExpanded && (\n                                <motion.div\n                                  initial={{ height: 0, opacity: 0 }}\n                                  animate={{ height: \"auto\", opacity: 1 }}\n                                  exit={{ height: 0, opacity: 0 }}\n                                  transition={{ duration: 0.2 }}\n                                  className=\"overflow-hidden\"\n                                  onClick={(e) => e.stopPropagation()}\n                                >\n                                  <div className=\"pt-3 mt-3 border-t space-y-2\">\n                                    {/* Archetype Description */}\n                                    {archetypeData && (\n                                      <div className=\"bg-muted/30 rounded-lg p-2.5\">\n                                        <p className=\"text-xs text-muted-foreground leading-relaxed\">\n                                          {archetypeData.description}\n                                        </p>\n                                      </div>\n                                    )}\n                                    \n                                    {/* Info Chips */}\n                                    <div className=\"flex flex-wrap gap-1.5\">\n                                      {otherUser.gender && otherUser.age && (\n                                        <span className=\"text-xs bg-muted/50 px-2.5 py-1 rounded-full\">\n                                          {getGenderDisplay(otherUser.gender)} Â· {formatAge(otherUser.age)}\n                                        </span>\n                                      )}\n                                      {otherUser.educationLevel && (\n                                        <span className=\"text-xs bg-muted/50 px-2.5 py-1 rounded-full\">\n                                          {getEducationDisplay(otherUser.educationLevel)}\n                                        </span>\n                                      )}\n                                      {otherUser.industry && (\n                                        <span className=\"text-xs bg-muted/50 px-2.5 py-1 rounded-full\">\n                                          {otherUser.industry}\n                                        </span>\n                                      )}\n                                    </div>\n                                    \n                                    {/* Languages */}\n                                    {otherUser.languagesComfort && otherUser.languagesComfort.length > 0 && (\n                                      <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\n                                        <span>ğŸ—£</span>\n                                        <span>{otherUser.languagesComfort.join(' Â· ')}</span>\n                                      </div>\n                                    )}\n                                  </div>\n                                </motion.div>\n                              )}\n                            </AnimatePresence>\n                          </div>\n                          \n                          <MessageSquare className=\"h-5 w-5 text-primary flex-shrink-0\" />\n                        </div>\n                      </CardContent>\n                    </Card>\n                  );\n                })}\n              </div>\n            ) : (\n              <div className=\"px-4 py-8\">\n                <Card className=\"border shadow-sm\">\n                  <CardContent className=\"p-8 text-center\">\n                    <User className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                    <h3 className=\"font-semibold mb-2\">æš‚æ— ç§èŠ</h3>\n                    <p className=\"text-sm text-muted-foreground\">\n                      åœ¨æ´»åŠ¨ä¸­ä¸å…¶ä»–å‚ä¸è€…å»ºç«‹è¿æ¥åï¼Œå¯ä»¥å¼€å§‹ç§èŠ\n                    </p>\n                  </CardContent>\n                </Card>\n              </div>\n            )}\n          </TabsContent>\n        </Tabs>\n      )}\n\n      <BottomNav />\n    </div>\n  );\n}\n","size_bytes":22937},"client/src/pages/EventChatDetailPage.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useParams, useLocation } from \"wouter\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from \"@/components/ui/dialog\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from \"@/components/ui/dropdown-menu\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { ArrowLeft, Send, Clock, ArrowDown, CheckCheck, MoreVertical, Flag } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { User, ChatMessage } from \"@shared/schema\";\nimport { \n  getGenderDisplay, \n  formatAge, \n  getEducationDisplay\n} from \"@/lib/userFieldMappings\";\n\n// Archetype configuration with full descriptions\nconst archetypeConfig: Record<string, { \n  icon: string; \n  color: string;\n  bgColor: string;\n  description: string;\n}> = {\n  \"ç«èŠ±å¡\": { \n    icon: \"ğŸ™Œ\", \n    color: \"text-orange-600 dark:text-orange-400\",\n    bgColor: \"bg-orange-100 dark:bg-orange-900/20\",\n    description: \"ç‚¹ç‡ƒè¯é¢˜çš„å¼€åœºé«˜æ‰‹ï¼Œèƒ½æ‰“ç ´æ²‰é»˜ï¼Œå¸¦åŠ¨æ°”æ°›\"\n  },\n  \"æ¢ç´¢è€…\": { \n    icon: \"ğŸ§­\", \n    color: \"text-purple-600 dark:text-purple-400\",\n    bgColor: \"bg-purple-100 dark:bg-purple-900/20\",\n    description: \"å¥½å¥‡å¿ƒé©±åŠ¨ï¼Œå–œæ¬¢å‘ç°æ–°äº‹ç‰©å’Œæ·±å…¥è®¨è®º\"\n  },\n  \"æ•…äº‹å®¶\": { \n    icon: \"ğŸ“–\", \n    color: \"text-green-600 dark:text-green-400\",\n    bgColor: \"bg-green-100 dark:bg-green-900/20\",\n    description: \"å–„äºåˆ†äº«ç»å†ï¼Œç”¨æ•…äº‹è¿æ¥äººå¿ƒ\"\n  },\n  \"æŒ‘æˆ˜è€…\": { \n    icon: \"âš¡\", \n    color: \"text-red-600 dark:text-red-400\",\n    bgColor: \"bg-red-100 dark:bg-red-900/20\",\n    description: \"æ€ç»´æ•é”ï¼Œå–œæ¬¢è¾©è®ºå’ŒæŒ‘æˆ˜ä¼ ç»Ÿè§‚ç‚¹\"\n  },\n  \"è¿æ¥è€…\": { \n    icon: \"ğŸ¤\", \n    color: \"text-cyan-600 dark:text-cyan-400\",\n    bgColor: \"bg-cyan-100 dark:bg-cyan-900/20\",\n    description: \"å¤©ç”Ÿçš„ç¤¾äº¤æ¡¥æ¢ï¼Œå¸®åŠ©ä»–äººå»ºç«‹è”ç³»\"\n  },\n  \"åè°ƒè€…\": { \n    icon: \"ğŸ¯\", \n    color: \"text-indigo-600 dark:text-indigo-400\",\n    bgColor: \"bg-indigo-100 dark:bg-indigo-900/20\",\n    description: \"å¹³è¡¡å„æ–¹æ„è§ï¼Œç¡®ä¿æ¯ä¸ªäººéƒ½è¢«å¬åˆ°\"\n  },\n  \"æ°›å›´ç»„\": { \n    icon: \"ğŸ­\", \n    color: \"text-pink-600 dark:text-pink-400\",\n    bgColor: \"bg-pink-100 dark:bg-pink-900/20\",\n    description: \"æ´»è·ƒæ°”æ°›ï¼Œç”¨å¹½é»˜å’Œæ´»åŠ›æ„ŸæŸ“ä»–äºº\"\n  },\n  \"è‚¯å®šè€…\": { \n    icon: \"ğŸŒŸ\", \n    color: \"text-yellow-600 dark:text-yellow-400\",\n    bgColor: \"bg-yellow-100 dark:bg-yellow-900/20\",\n    description: \"ç»™äºˆé¼“åŠ±å’Œæ”¯æŒï¼Œè®©ä»–äººæ„Ÿåˆ°è¢«è®¤å¯\"\n  },\n};\n\n// Helper function to group messages by date\nfunction groupMessagesByDate(messages: Array<ChatMessage & { user: User }>) {\n  const groups: Array<{ date: string; label: string; messages: Array<ChatMessage & { user: User }> }> = [];\n  \n  messages.forEach(msg => {\n    const msgDate = new Date(msg.createdAt!);\n    const today = new Date();\n    const yesterday = new Date(today);\n    yesterday.setDate(yesterday.getDate() - 1);\n    \n    let label: string;\n    const dateKey = msgDate.toDateString();\n    \n    if (msgDate.toDateString() === today.toDateString()) {\n      label = \"ä»Šå¤©\";\n    } else if (msgDate.toDateString() === yesterday.toDateString()) {\n      label = \"æ˜¨å¤©\";\n    } else {\n      label = msgDate.toLocaleDateString(\"zh-CN\", { month: \"long\", day: \"numeric\" });\n    }\n    \n    const existingGroup = groups.find(g => g.date === dateKey);\n    if (existingGroup) {\n      existingGroup.messages.push(msg);\n    } else {\n      groups.push({ date: dateKey, label, messages: [msg] });\n    }\n  });\n  \n  return groups;\n}\n\nexport default function EventChatDetailPage() {\n  const { eventId } = useParams();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const [message, setMessage] = useState(\"\");\n  const [showScrollButton, setShowScrollButton] = useState(false);\n  const [isTyping, setIsTyping] = useState(false);\n  const [selectedParticipant, setSelectedParticipant] = useState<User | null>(null);\n  const [reportDialogOpen, setReportDialogOpen] = useState(false);\n  const [reportingMessage, setReportingMessage] = useState<ChatMessage & { user: User } | null>(null);\n  const [reportType, setReportType] = useState<string>(\"harassment\");\n  const [reportDescription, setReportDescription] = useState(\"\");\n  \n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const messagesContainerRef = useRef<HTMLDivElement>(null);\n\n  // Get current user info\n  const { data: currentUser } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n  });\n\n  const { data: joinedEvents } = useQuery<Array<any>>({\n    queryKey: [\"/api/events/joined\"],\n  });\n\n  const event = joinedEvents?.find((e: any) => e.id === eventId);\n\n  const { data: messagesData, isLoading: messagesLoading } = useQuery<{\n    chatUnlocked: boolean;\n    hoursUntilUnlock: number;\n    messages: Array<ChatMessage & { user: User }>;\n  }>({\n    queryKey: [\"/api/events\", eventId, \"/messages\"],\n    refetchInterval: 5000,\n  });\n\n  const messages = messagesData?.messages || [];\n  const chatUnlocked = messagesData?.chatUnlocked ?? false;\n  const hoursUntilUnlock = messagesData?.hoursUntilUnlock ?? 0;\n\n  const { data: participants } = useQuery<Array<User>>({\n    queryKey: [\"/api/events\", eventId, \"/participants\"],\n  });\n\n  const sendMessageMutation = useMutation({\n    mutationFn: async (msg: string) => {\n      return await apiRequest(\"POST\", `/api/events/${eventId}/messages`, { message: msg });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/events\", eventId, \"/messages\"] });\n      setMessage(\"\");\n    },\n    onError: async (error) => {\n      toast({\n        title: \"å‘é€å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n      \n      // Log message send failure\n      try {\n        await apiRequest(\"POST\", \"/api/chat-logs\", {\n          eventType: \"message_failed\",\n          eventId: eventId,\n          userId: currentUser?.id,\n          severity: \"error\",\n          message: \"Message send failed\",\n          metadata: { error: error.message, attemptedMessage: message },\n        });\n      } catch (logError) {\n        console.error(\"Failed to log message error:\", logError);\n      }\n    },\n  });\n\n  const reportMessageMutation = useMutation({\n    mutationFn: async () => {\n      if (!reportingMessage) throw new Error(\"No message selected\");\n      \n      return await apiRequest(\"POST\", \"/api/chat-reports\", {\n        messageId: reportingMessage.id,\n        eventId: eventId,\n        reportedUserId: reportingMessage.userId,\n        reportType,\n        description: reportDescription || undefined,\n      });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"ä¸¾æŠ¥å·²æäº¤\",\n        description: \"æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†\",\n      });\n      setReportDialogOpen(false);\n      setReportingMessage(null);\n      setReportType(\"harassment\");\n      setReportDescription(\"\");\n    },\n    onError: (error) => {\n      toast({\n        title: \"ä¸¾æŠ¥å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleReportMessage = (msg: ChatMessage & { user: User }) => {\n    setReportingMessage(msg);\n    setReportDialogOpen(true);\n  };\n\n  const handleSubmitReport = () => {\n    if (!reportType) {\n      toast({\n        title: \"è¯·é€‰æ‹©ä¸¾æŠ¥ç±»å‹\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    reportMessageMutation.mutate();\n  };\n\n  // Auto-scroll to bottom with animation\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  // Handle scroll button visibility\n  useEffect(() => {\n    const container = messagesContainerRef.current;\n    if (!container) return;\n\n    const handleScroll = () => {\n      const { scrollTop, scrollHeight, clientHeight } = container;\n      const isNearBottom = scrollHeight - scrollTop - clientHeight < 100;\n      setShowScrollButton(!isNearBottom);\n    };\n\n    container.addEventListener(\"scroll\", handleScroll);\n    return () => container.removeEventListener(\"scroll\", handleScroll);\n  }, []);\n\n  // Simulate typing indicator (would be real-time in production)\n  useEffect(() => {\n    let timeout: NodeJS.Timeout;\n    if (message.length > 0) {\n      setIsTyping(true);\n      timeout = setTimeout(() => setIsTyping(false), 1000);\n    } else {\n      setIsTyping(false);\n    }\n    return () => clearTimeout(timeout);\n  }, [message]);\n\n  const handleSendMessage = () => {\n    if (message.trim()) {\n      sendMessageMutation.mutate(message.trim());\n    }\n  };\n\n  const scrollToBottom = () => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  };\n\n  const messageGroups = groupMessagesByDate(messages);\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      {/* Header */}\n      <div className=\"sticky top-0 z-40 bg-background/95 backdrop-blur-sm border-b\">\n        <div className=\"flex items-center h-14 px-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            onClick={() => setLocation(\"/chats\")}\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <div className=\"ml-2 flex-1\">\n            <h1 className=\"font-semibold truncate\">{event?.title || \"æ´»åŠ¨èŠå¤©\"}</h1>\n          </div>\n        </div>\n        \n        {/* Participant Badges Row */}\n        {participants && participants.length > 0 && (\n          <TooltipProvider>\n            <div className=\"px-4 py-2 border-t flex items-center gap-2 overflow-x-auto\">\n              <span className=\"text-xs text-muted-foreground flex-shrink-0\">å‚ä¸è€…:</span>\n              <div className=\"flex gap-2\">\n                {participants.map((participant) => {\n                  const archetypeData = participant.archetype && archetypeConfig[participant.archetype]\n                    ? archetypeConfig[participant.archetype]\n                    : { icon: \"âœ¨\", color: \"text-muted-foreground\", bgColor: \"bg-muted\", description: \"ç‹¬ç‰¹ä¸ªæ€§\" };\n                  \n                  return (\n                    <Tooltip key={participant.id}>\n                      <TooltipTrigger asChild>\n                        <button\n                          onClick={() => setSelectedParticipant(participant)}\n                          className={`h-8 w-8 rounded-full ${archetypeData.bgColor} flex items-center justify-center text-lg hover-elevate active-elevate-2 transition-all cursor-pointer`}\n                          data-testid={`badge-participant-${participant.id}`}\n                        >\n                          {archetypeData.icon}\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p className=\"font-semibold\">{participant.displayName || participant.firstName || \"ç”¨æˆ·\"}</p>\n                        <p className=\"text-xs text-muted-foreground\">{participant.archetype}</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  );\n                })}\n              </div>\n            </div>\n          </TooltipProvider>\n        )}\n      </div>\n\n      {/* Chat Content */}\n      <div className=\"flex-1 flex flex-col relative\">\n          {!chatUnlocked ? (\n            <div className=\"flex-1 flex items-center justify-center p-8\">\n              <Card className=\"max-w-sm w-full\">\n                <CardContent className=\"p-8 text-center space-y-4\">\n                  <Clock className=\"h-16 w-16 text-muted-foreground mx-auto\" />\n                  <div className=\"space-y-2\">\n                    <h3 className=\"font-semibold text-lg\">ç¾¤èŠå³å°†å¼€æ”¾</h3>\n                    <p className=\"text-sm text-muted-foreground\">\n                      ç¾¤èŠå°†åœ¨æ´»åŠ¨å¼€å§‹å‰24å°æ—¶å¼€æ”¾\n                    </p>\n                  </div>\n                  <div className=\"pt-2\">\n                    <div className=\"inline-flex items-center gap-2 px-4 py-2 bg-primary/10 text-primary rounded-full\">\n                      <Clock className=\"h-4 w-4\" />\n                      <span className=\"font-medium\">\n                        {Math.floor(hoursUntilUnlock)}å°æ—¶{Math.round((hoursUntilUnlock % 1) * 60)}åˆ†é’Ÿåå¼€æ”¾\n                      </span>\n                    </div>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground pt-4\">\n                    å±Šæ—¶ä½ å¯ä»¥å’Œå…¶ä»–å‚ä¸è€…æå‰è®¤è¯†ï¼ŒèŠèŠæœŸå¾…ï½\n                  </p>\n                </CardContent>\n              </Card>\n            </div>\n          ) : (\n            <>\n              <div \n                ref={messagesContainerRef}\n                className=\"flex-1 overflow-y-auto p-4 space-y-6\"\n              >\n                {messagesLoading ? (\n                  <div className=\"text-center py-8\">\n                    <div className=\"h-6 w-6 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n                  </div>\n                ) : messages && messages.length > 0 ? (\n                  <TooltipProvider>\n                    {messageGroups.map((group, groupIdx) => (\n                      <div key={group.date} className=\"space-y-4\">\n                        {/* Date divider */}\n                        <div className=\"flex items-center gap-3 py-2\">\n                          <div className=\"flex-1 h-px bg-border\" />\n                          <span className=\"text-xs text-muted-foreground font-medium px-3 py-1 bg-muted rounded-full\">\n                            {group.label}\n                          </span>\n                          <div className=\"flex-1 h-px bg-border\" />\n                        </div>\n\n                        {/* Messages */}\n                        {group.messages.map((msg, idx) => {\n                          const isOwnMessage = currentUser?.id === msg.userId;\n                          const archetypeData = msg.user.archetype && archetypeConfig[msg.user.archetype]\n                            ? archetypeConfig[msg.user.archetype]\n                            : { icon: \"âœ¨\", color: \"text-muted-foreground\", bgColor: \"bg-muted\", description: \"ç‹¬ç‰¹ä¸ªæ€§\" };\n                          \n                          return (\n                            <div\n                              key={msg.id}\n                              className={`flex gap-3 animate-in fade-in slide-in-from-bottom-2 duration-300 ${\n                                isOwnMessage ? \"flex-row-reverse\" : \"\"\n                              }`}\n                              style={{ animationDelay: `${idx * 50}ms` }}\n                            >\n                              {/* Avatar (only for others) */}\n                              {!isOwnMessage && (\n                                <Tooltip>\n                                  <TooltipTrigger asChild>\n                                    <Avatar className=\"h-10 w-10 flex-shrink-0 cursor-pointer ring-2 ring-transparent hover:ring-primary/20 transition-all\">\n                                      {msg.user.profileImageUrl ? (\n                                        <AvatarImage src={msg.user.profileImageUrl} />\n                                      ) : (\n                                        <AvatarFallback className={`${archetypeData.bgColor} text-2xl`}>\n                                          {archetypeData.icon}\n                                        </AvatarFallback>\n                                      )}\n                                    </Avatar>\n                                  </TooltipTrigger>\n                                  <TooltipContent side=\"right\" className=\"max-w-xs\">\n                                    <div className=\"space-y-2\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <span className=\"text-2xl\">{archetypeData.icon}</span>\n                                        <div>\n                                          <p className=\"font-semibold\">{msg.user.archetype}</p>\n                                          <p className=\"text-xs text-muted-foreground\">\n                                            {msg.user.displayName || \"ç”¨æˆ·\"}\n                                          </p>\n                                        </div>\n                                      </div>\n                                      <p className=\"text-sm\">{archetypeData.description}</p>\n                                    </div>\n                                  </TooltipContent>\n                                </Tooltip>\n                              )}\n\n                              {/* Message bubble */}\n                              <div className={`flex-1 min-w-0 max-w-[75%] ${isOwnMessage ? \"flex flex-col items-end\" : \"\"}`}>\n                                {/* Header */}\n                                {!isOwnMessage && (\n                                  <div className=\"flex items-center gap-2 mb-1 px-1\">\n                                    <span className=\"text-sm font-medium\">\n                                      {msg.user.displayName || msg.user.firstName || \"ç”¨æˆ·\"}\n                                    </span>\n                                    <Badge \n                                      variant=\"secondary\" \n                                      className={`text-[10px] h-5 px-1.5 ${archetypeData.color}`}\n                                    >\n                                      {msg.user.archetype}\n                                    </Badge>\n                                  </div>\n                                )}\n\n                                {/* Message content */}\n                                <div className=\"relative\">\n                                  <div \n                                    className={`\n                                      group relative px-4 py-2.5 rounded-[18px] shadow-sm\n                                      transition-all duration-200 hover:shadow-md hover:scale-[1.02]\n                                      ${isOwnMessage \n                                        ? \"bg-primary text-primary-foreground rounded-br-[4px]\" \n                                        : \"bg-muted text-foreground rounded-bl-[4px]\"\n                                      }\n                                    `}\n                                  >\n                                    {isOwnMessage && (\n                                      <div className=\"text-xs opacity-90 mb-1\">æˆ‘</div>\n                                    )}\n                                    <p className=\"text-sm break-words leading-relaxed\">{msg.message}</p>\n                                    \n                                    {/* Time */}\n                                    <div className={`text-[10px] mt-1 flex items-center gap-1 ${\n                                      isOwnMessage ? \"text-primary-foreground/70\" : \"text-muted-foreground\"\n                                    }`}>\n                                      <span>\n                                        {new Date(msg.createdAt!).toLocaleTimeString(\"zh-CN\", { \n                                          hour: \"2-digit\", \n                                          minute: \"2-digit\" \n                                        })}\n                                      </span>\n                                      {isOwnMessage && (\n                                        <CheckCheck className=\"h-3 w-3\" />\n                                      )}\n                                    </div>\n                                    \n                                    {/* Report button - only for messages from others */}\n                                    {!isOwnMessage && (\n                                      <DropdownMenu>\n                                        <DropdownMenuTrigger asChild>\n                                          <Button\n                                            variant=\"ghost\"\n                                            size=\"icon\"\n                                            className=\"absolute -top-2 -right-2 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity\"\n                                            data-testid={`button-report-menu-${msg.id}`}\n                                          >\n                                            <MoreVertical className=\"h-3 w-3\" />\n                                          </Button>\n                                        </DropdownMenuTrigger>\n                                        <DropdownMenuContent align=\"end\">\n                                          <DropdownMenuItem\n                                            onClick={() => handleReportMessage(msg)}\n                                            className=\"text-destructive focus:text-destructive\"\n                                            data-testid={`menu-item-report-${msg.id}`}\n                                          >\n                                            <Flag className=\"h-4 w-4 mr-2\" />\n                                            ä¸¾æŠ¥æ­¤æ¶ˆæ¯\n                                          </DropdownMenuItem>\n                                        </DropdownMenuContent>\n                                      </DropdownMenu>\n                                    )}\n                                  </div>\n                                </div>\n\n                                {/* Message status (only for own messages) */}\n                                {isOwnMessage && (\n                                  <div className=\"text-xs text-muted-foreground px-1 mt-0.5\">\n                                    å·²é€è¾¾\n                                  </div>\n                                )}\n                              </div>\n                            </div>\n                          );\n                        })}\n                      </div>\n                    ))}\n\n                    {/* Typing indicator */}\n                    {isTyping && (\n                      <div className=\"flex gap-3 animate-in fade-in slide-in-from-bottom-2\">\n                        <div className=\"h-10 w-10\" />\n                        <div className=\"bg-muted px-4 py-3 rounded-[18px] rounded-bl-[4px]\">\n                          <div className=\"flex gap-1\">\n                            <div className=\"h-2 w-2 bg-muted-foreground/40 rounded-full animate-bounce\" style={{ animationDelay: \"0ms\" }} />\n                            <div className=\"h-2 w-2 bg-muted-foreground/40 rounded-full animate-bounce\" style={{ animationDelay: \"150ms\" }} />\n                            <div className=\"h-2 w-2 bg-muted-foreground/40 rounded-full animate-bounce\" style={{ animationDelay: \"300ms\" }} />\n                          </div>\n                        </div>\n                      </div>\n                    )}\n                  </TooltipProvider>\n                ) : (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <p className=\"text-sm\">è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œå¼€å§‹èŠå¤©å§ï¼</p>\n                  </div>\n                )}\n                <div ref={messagesEndRef} />\n              </div>\n\n              {/* Scroll to bottom button */}\n              {showScrollButton && (\n                <Button\n                  size=\"icon\"\n                  variant=\"secondary\"\n                  className=\"absolute bottom-20 right-6 z-10 rounded-full shadow-lg animate-in fade-in slide-in-from-bottom-4\"\n                  onClick={scrollToBottom}\n                  data-testid=\"button-scroll-to-bottom\"\n                >\n                  <ArrowDown className=\"h-4 w-4\" />\n                </Button>\n              )}\n\n              {/* Input area */}\n              <div className=\"border-t p-4 bg-background\">\n                <div className=\"flex gap-2\">\n                  <Input\n                    placeholder=\"è¾“å…¥æ¶ˆæ¯...\"\n                    value={message}\n                    onChange={(e) => setMessage(e.target.value)}\n                    onKeyPress={(e) => e.key === \"Enter\" && handleSendMessage()}\n                    data-testid=\"input-message\"\n                    className=\"flex-1\"\n                  />\n                  <Button \n                    size=\"icon\" \n                    onClick={handleSendMessage}\n                    disabled={!message.trim() || sendMessageMutation.isPending}\n                    data-testid=\"button-send\"\n                    className=\"flex-shrink-0\"\n                  >\n                    <Send className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              </div>\n            </>\n          )}\n      </div>\n\n      {/* Participant Details Dialog */}\n      {selectedParticipant && (\n        <Dialog open={true} onOpenChange={(open) => !open && setSelectedParticipant(null)}>\n          <DialogContent className=\"max-w-sm\">\n            <DialogHeader>\n              <DialogTitle>å‚ä¸è€…ä¿¡æ¯</DialogTitle>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div className=\"flex items-start gap-4\">\n                <div className={`h-16 w-16 flex-shrink-0 rounded-full ${\n                  selectedParticipant.archetype && archetypeConfig[selectedParticipant.archetype]\n                    ? archetypeConfig[selectedParticipant.archetype].bgColor\n                    : \"bg-muted\"\n                } flex items-center justify-center text-4xl`}>\n                  {selectedParticipant.archetype && archetypeConfig[selectedParticipant.archetype]\n                    ? archetypeConfig[selectedParticipant.archetype].icon\n                    : \"âœ¨\"}\n                </div>\n                <div className=\"flex-1\">\n                  <h3 className=\"font-semibold text-lg\">\n                    {selectedParticipant.displayName || selectedParticipant.firstName || \"ç”¨æˆ·\"}\n                  </h3>\n                  {selectedParticipant.archetype && (\n                    <Badge variant=\"secondary\" className=\"text-xs mt-1\">\n                      {selectedParticipant.archetype}\n                    </Badge>\n                  )}\n                </div>\n              </div>\n              \n              {selectedParticipant.archetype && archetypeConfig[selectedParticipant.archetype] && (\n                <div className=\"bg-muted/50 rounded-lg p-3\">\n                  <p className=\"text-sm text-muted-foreground\">\n                    {archetypeConfig[selectedParticipant.archetype].description}\n                  </p>\n                </div>\n              )}\n              \n              {/* Basic Info Chips */}\n              <div className=\"flex flex-wrap gap-2\">\n                {selectedParticipant.gender && selectedParticipant.age && (\n                  <span className=\"text-xs bg-muted/50 px-3 py-1.5 rounded-full\">\n                    {getGenderDisplay(selectedParticipant.gender)} Â· {formatAge(selectedParticipant.age)}\n                  </span>\n                )}\n                {selectedParticipant.educationLevel && (\n                  <span className=\"text-xs bg-muted/50 px-3 py-1.5 rounded-full\">\n                    {getEducationDisplay(selectedParticipant.educationLevel)}\n                  </span>\n                )}\n                {selectedParticipant.industry && (\n                  <span className=\"text-xs bg-muted/50 px-3 py-1.5 rounded-full\">\n                    {selectedParticipant.industry}\n                  </span>\n                )}\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      )}\n\n      {/* Report Message Dialog */}\n      <Dialog open={reportDialogOpen} onOpenChange={setReportDialogOpen}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle>ä¸¾æŠ¥æ­¤æ¶ˆæ¯</DialogTitle>\n            <DialogDescription>\n              è¯·é€‰æ‹©ä¸¾æŠ¥ç±»å‹å¹¶æä¾›è¯¦ç»†è¯´æ˜ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4\">\n            {/* Message preview */}\n            {reportingMessage && (\n              <div className=\"bg-muted/50 rounded-lg p-3\">\n                <p className=\"text-xs text-muted-foreground mb-1\">ä¸¾æŠ¥æ¶ˆæ¯ï¼š</p>\n                <p className=\"text-sm\">{reportingMessage.message}</p>\n              </div>\n            )}\n            \n            {/* Report type selection */}\n            <div className=\"space-y-2\">\n              <Label>ä¸¾æŠ¥ç±»å‹</Label>\n              <RadioGroup value={reportType} onValueChange={setReportType}>\n                <div className=\"flex items-center space-x-2\">\n                  <RadioGroupItem value=\"harassment\" id=\"harassment\" data-testid=\"radio-report-type-harassment\" />\n                  <Label htmlFor=\"harassment\" className=\"cursor-pointer\">éªšæ‰°æˆ–å¨èƒ</Label>\n                </div>\n                <div className=\"flex items-center space-x-2\">\n                  <RadioGroupItem value=\"spam\" id=\"spam\" data-testid=\"radio-report-type-spam\" />\n                  <Label htmlFor=\"spam\" className=\"cursor-pointer\">åƒåœ¾ä¿¡æ¯</Label>\n                </div>\n                <div className=\"flex items-center space-x-2\">\n                  <RadioGroupItem value=\"inappropriate\" id=\"inappropriate\" data-testid=\"radio-report-type-inappropriate\" />\n                  <Label htmlFor=\"inappropriate\" className=\"cursor-pointer\">ä¸å½“å†…å®¹</Label>\n                </div>\n                <div className=\"flex items-center space-x-2\">\n                  <RadioGroupItem value=\"hate_speech\" id=\"hate_speech\" data-testid=\"radio-report-type-hate-speech\" />\n                  <Label htmlFor=\"hate_speech\" className=\"cursor-pointer\">ä»‡æ¨è¨€è®º</Label>\n                </div>\n                <div className=\"flex items-center space-x-2\">\n                  <RadioGroupItem value=\"other\" id=\"other\" data-testid=\"radio-report-type-other\" />\n                  <Label htmlFor=\"other\" className=\"cursor-pointer\">å…¶ä»–</Label>\n                </div>\n              </RadioGroup>\n            </div>\n            \n            {/* Optional description */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"report-description\">è¯¦ç»†è¯´æ˜ï¼ˆå¯é€‰ï¼‰</Label>\n              <Textarea\n                id=\"report-description\"\n                placeholder=\"è¯·æä¾›æ›´å¤šä¿¡æ¯...\"\n                value={reportDescription}\n                onChange={(e) => setReportDescription(e.target.value)}\n                data-testid=\"textarea-report-description\"\n                rows={3}\n              />\n            </div>\n          </div>\n          \n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setReportDialogOpen(false);\n                setReportingMessage(null);\n                setReportType(\"harassment\");\n                setReportDescription(\"\");\n              }}\n              data-testid=\"button-report-cancel\"\n            >\n              å–æ¶ˆ\n            </Button>\n            <Button\n              onClick={handleSubmitReport}\n              disabled={reportMessageMutation.isPending}\n              data-testid=\"button-report-submit\"\n            >\n              {reportMessageMutation.isPending ? \"æäº¤ä¸­...\" : \"æäº¤ä¸¾æŠ¥\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":31989},"client/src/components/ParticipantAvatars.tsx":{"content":"import { User } from \"lucide-react\";\n\ninterface Participant {\n  id: string;\n  displayName: string | null;\n  archetype?: string | null;\n}\n\ninterface ParticipantAvatarsProps {\n  participants: Participant[];\n  maxDisplay?: number;\n  size?: \"sm\" | \"md\" | \"lg\";\n}\n\nconst ARCHETYPE_EMOJIS: Record<string, string> = {\n  'å¼€å¿ƒæŸ¯åŸº': 'ğŸ•',\n  'å¤ªé˜³é¸¡': 'ğŸ“',\n  'å¤¸å¤¸è±š': 'ğŸ¬',\n  'æœºæ™ºç‹': 'ğŸ¦Š',\n  'æ·¡å®šæµ·è±š': 'ğŸ¬',\n  'ç»‡ç½‘è››': 'ğŸ•·ï¸',\n  'æš–å¿ƒç†Š': 'ğŸ»',\n  'çµæ„Ÿç« é±¼': 'ğŸ™',\n  'æ²‰æ€çŒ«å¤´é¹°': 'ğŸ¦‰',\n  'å®šå¿ƒå¤§è±¡': 'ğŸ˜',\n  'ç¨³å¦‚é¾Ÿ': 'ğŸ¢',\n  'éšèº«çŒ«': 'ğŸ±',\n};\n\nconst GRADIENT_COLORS = [\n  \"from-purple-400 to-indigo-400\",\n  \"from-blue-400 to-cyan-400\",\n  \"from-emerald-400 to-teal-400\",\n  \"from-amber-400 to-orange-400\",\n  \"from-pink-400 to-rose-400\",\n  \"from-violet-400 to-purple-400\",\n];\n\nconst SIZE_CLASSES = {\n  sm: \"h-8 w-8\",\n  md: \"h-10 w-10\",\n  lg: \"h-12 w-12\",\n};\n\nconst ICON_SIZE_CLASSES = {\n  sm: \"h-3.5 w-3.5\",\n  md: \"h-4 w-4\",\n  lg: \"h-5 w-5\",\n};\n\nexport default function ParticipantAvatars({ \n  participants, \n  maxDisplay = 8,\n  size = \"md\" \n}: ParticipantAvatarsProps) {\n  const displayedParticipants = participants.slice(0, maxDisplay);\n  const remainingCount = participants.length - maxDisplay;\n\n  const getGradientColor = (index: number) => {\n    return GRADIENT_COLORS[index % GRADIENT_COLORS.length];\n  };\n\n  return (\n    <div className=\"flex items-center -space-x-2\">\n      {displayedParticipants.map((participant, index) => {\n        const gradientColor = getGradientColor(index);\n        const emoji = participant.archetype ? ARCHETYPE_EMOJIS[participant.archetype] : null;\n        \n        return (\n          <div\n            key={participant.id}\n            className={`${SIZE_CLASSES[size]} rounded-full bg-gradient-to-br ${gradientColor} flex items-center justify-center text-white border-2 border-background shadow-sm transition-transform hover:scale-110 hover:z-10`}\n            style={{ zIndex: displayedParticipants.length - index }}\n            title={`${participant.displayName || \"ç”¨æˆ·\"}${participant.archetype ? ` Â· ${participant.archetype}` : ''}`}\n          >\n            {emoji ? (\n              <span className=\"text-sm\">{emoji}</span>\n            ) : (\n              <User className={ICON_SIZE_CLASSES[size]} />\n            )}\n          </div>\n        );\n      })}\n      \n      {remainingCount > 0 && (\n        <div\n          className={`${SIZE_CLASSES[size]} rounded-full bg-muted flex items-center justify-center font-semibold text-muted-foreground border-2 border-background text-xs`}\n          title={`è¿˜æœ‰ ${remainingCount} ä½å‚ä¸è€…`}\n        >\n          +{remainingCount}\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":2720},"client/src/components/HeroWelcome.tsx":{"content":"import { MapPin } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface HeroWelcomeProps {\n  userName?: string;\n  selectedCity: \"é¦™æ¸¯\" | \"æ·±åœ³\";\n  selectedArea?: string;\n  onLocationClick: () => void;\n}\n\nconst areaDisplay = {\n  \"é¦™æ¸¯\": \"ä¸­è¥¿åŒº\",\n  \"æ·±åœ³\": \"å—å±±åŒº\"\n};\n\nexport default function HeroWelcome({ \n  userName = \"æœ‹å‹\", \n  selectedCity,\n  selectedArea,\n  onLocationClick \n}: HeroWelcomeProps) {\n  const displayArea = selectedArea || areaDisplay[selectedCity];\n  const displayLocation = `${selectedCity}â€¢${displayArea}`;\n  \n  return (\n    <div className=\"px-4 py-6 space-y-3\">\n      {/* é—®å€™è¯­ */}\n      <h1 className=\"text-3xl font-bold\" data-testid=\"text-hero-greeting\">\n        Hi {userName} ğŸ‘‹\n      </h1>\n      \n      {/* Slogan with åœ°ç‚¹ Chip */}\n      <div className=\"flex items-center flex-wrap gap-2 text-xl font-semibold\">\n        <span>åœ¨</span>\n        <button\n          onClick={onLocationClick}\n          className=\"inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-primary/10 hover:bg-primary/20 transition-all hover-elevate active-elevate-2 border border-primary/20\"\n          data-testid=\"button-location-chip\"\n        >\n          <MapPin className=\"h-4 w-4 text-primary\" />\n          <span className=\"text-primary font-semibold\">{displayLocation}</span>\n          <svg \n            className=\"h-3.5 w-3.5 text-primary/70\" \n            fill=\"none\" \n            viewBox=\"0 0 24 24\" \n            stroke=\"currentColor\"\n          >\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n          </svg>\n        </button>\n        <span>è®¤è¯†æ–°æœ‹å‹</span>\n      </div>\n      \n      {/* å‰¯æ ‡é¢˜ */}\n      <p className=\"text-sm text-muted-foreground leading-relaxed\" data-testid=\"text-hero-subtitle\">\n        AI ä¸ºä½ åŒ¹é… 4â€“6 äººå°èšï¼Œè½»æ¾å¥½èŠï¼Œå¼€å¿ƒä¸Šæ¡Œ\n      </p>\n    </div>\n  );\n}\n","size_bytes":1932},"client/src/components/JoinBlindBoxSheet.tsx":{"content":"import React, { useState } from \"react\";\nimport { Drawer } from \"vaul\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { \n  Calendar, \n  MapPin, \n  Users, \n  Copy, \n  ChevronRight,\n  Info,\n  CheckCircle2,\n  Clock,\n  DollarSign\n} from \"lucide-react\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLocation } from \"wouter\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { getCurrencySymbol } from \"@/lib/currency\";\n\ninterface JoinBlindBoxSheetProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  eventData: {\n    date: string;\n    time: string;\n    eventType: \"é¥­å±€\" | \"é…’å±€\";\n    area: string;\n    priceTier?: string;\n    isAA?: boolean;\n    isGirlsNight?: boolean;\n    city?: \"é¦™æ¸¯\" | \"æ·±åœ³\";\n  };\n}\n\nexport default function JoinBlindBoxSheet({ \n  open, \n  onOpenChange, \n  eventData \n}: JoinBlindBoxSheetProps) {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [inviteFriends, setInviteFriends] = useState(false);\n  const [friendsCount, setFriendsCount] = useState<1 | 2>(1);\n  const [mustMatchTogether, setMustMatchTogether] = useState(true);\n  \n  // é¢„ç®—åå¥½ - å¯å¤šé€‰\n  const [budgetPreference, setBudgetPreference] = useState<string[]>([]);\n  \n  // ç¡®è®¤å¼¹çª—çŠ¶æ€\n  const [showConfirmDialog, setShowConfirmDialog] = useState(false);\n  \n  // æˆ‘çš„åå¥½é€‰é¡¹\n  const [acceptNearby, setAcceptNearby] = useState(false);\n\n  // ç”¨æˆ·åå¥½ - è¯­è¨€å’Œå£å‘³\n  const [preferencesOpen, setPreferencesOpen] = useState(false);\n  const [selectedLanguages, setSelectedLanguages] = useState<string[]>([]);\n  const [selectedTasteIntensity, setSelectedTasteIntensity] = useState<string[]>([]);\n  const [selectedCuisines, setSelectedCuisines] = useState<string[]>([]);\n  \n  // å‚ä¸æ„å›¾ - Event-specific intent (multi-select)\n  const [selectedIntent, setSelectedIntent] = useState<string[]>([]);\n\n  const budgetOptions = [\n    { value: \"100ä»¥ä¸‹\", label: \"â‰¤100\" },\n    { value: \"100-200\", label: \"100-200\" },\n    { value: \"200-300\", label: \"200-300\" },\n    { value: \"300-500\", label: \"300-500\" },\n    { value: \"500+\", label: \"500+\" },\n  ];\n\n  const languageOptions = [\n    { value: \"ä¸­æ–‡ï¼ˆå›½è¯­ï¼‰\", label: \"ä¸­æ–‡ï¼ˆå›½è¯­ï¼‰\" },\n    { value: \"ä¸­æ–‡ï¼ˆç²¤è¯­ï¼‰\", label: \"ä¸­æ–‡ï¼ˆç²¤è¯­ï¼‰\" },\n    { value: \"è‹±è¯­\", label: \"è‹±è¯­\" },\n  ];\n\n  const tasteIntensityOptions = [\n    { value: \"çˆ±åƒè¾£\", label: \"çˆ±åƒè¾£\" },\n    { value: \"ä¸è¾£/æ¸…æ·¡ä¸ºä¸»\", label: \"ä¸è¾£/æ¸…æ·¡ä¸ºä¸»\" },\n  ];\n\n  const cuisineOptions = [\n    { value: \"ä¸­é¤\", label: \"ä¸­é¤\" },\n    { value: \"å·èœ\", label: \"å·èœ\" },\n    { value: \"ç²¤èœ\", label: \"ç²¤èœ\" },\n    { value: \"ç«é”…\", label: \"ç«é”…\" },\n    { value: \"çƒ§çƒ¤\", label: \"çƒ§çƒ¤\" },\n    { value: \"è¥¿é¤\", label: \"è¥¿é¤\" },\n    { value: \"æ—¥æ–™\", label: \"æ—¥æ–™\" },\n  ];\n\n  const toggleBudget = (value: string) => {\n    setBudgetPreference(prev => \n      prev.includes(value) \n        ? prev.filter(v => v !== value)\n        : [...prev, value]\n    );\n  };\n\n  const toggleLanguage = (value: string) => {\n    setSelectedLanguages(prev => \n      prev.includes(value) \n        ? prev.filter(v => v !== value)\n        : [...prev, value]\n    );\n  };\n\n  const toggleTasteIntensity = (value: string) => {\n    setSelectedTasteIntensity(prev => \n      prev.includes(value) \n        ? prev.filter(v => v !== value)\n        : [...prev, value]\n    );\n  };\n\n  // Toggle intent with flexible exclusivity logic\n  const toggleIntent = (intentValue: string) => {\n    if (intentValue === \"flexible\") {\n      // If selecting \"flexible\", clear all other intents\n      if (selectedIntent.includes(\"flexible\")) {\n        setSelectedIntent([]);\n      } else {\n        setSelectedIntent([\"flexible\"]);\n      }\n    } else {\n      // If selecting a specific intent\n      if (selectedIntent.includes(intentValue)) {\n        // Deselect this intent\n        setSelectedIntent(selectedIntent.filter(i => i !== intentValue));\n      } else {\n        // Select this intent and remove \"flexible\" if present\n        const newIntents = selectedIntent.filter(i => i !== \"flexible\");\n        setSelectedIntent([...newIntents, intentValue]);\n      }\n    }\n  };\n\n  const toggleCuisine = (value: string) => {\n    setSelectedCuisines(prev => \n      prev.includes(value) \n        ? prev.filter(v => v !== value)\n        : [...prev, value]\n    );\n  };\n\n  const clearAllPreferences = () => {\n    setSelectedLanguages([]);\n    setSelectedTasteIntensity([]);\n    setSelectedCuisines([]);\n  };\n\n  const saveBudgetMutation = useMutation({\n    mutationFn: async (budgetPreference: string[]) => {\n      return await apiRequest(\"POST\", \"/api/profile/budget\", {\n        budgetPreference,\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"ä¿å­˜å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleCopyInviteLink = () => {\n    const link = `https://joyjoin.app/invite/${Math.random().toString(36).substr(2, 9)}`;\n    navigator.clipboard.writeText(link);\n    toast({\n      description: \"å·²å¤åˆ¶é‚€è¯·é“¾æ¥\",\n      duration: 2000,\n    });\n  };\n\n  const handleConfirm = () => {\n    if (budgetPreference.length === 0) {\n      toast({\n        title: \"è¯·é€‰æ‹©é¢„ç®—èŒƒå›´\",\n        description: \"è‡³å°‘é€‰æ‹©ä¸€ä¸ªé¢„ç®—æ¡£ä½\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // æ‰“å¼€ç¡®è®¤å¼¹çª—\n    setShowConfirmDialog(true);\n  };\n\n  const handleFinalConfirm = async () => {\n    // ä¿å­˜é¢„ç®—åå¥½åˆ°ç”¨æˆ·profile\n    try {\n      await saveBudgetMutation.mutateAsync(budgetPreference);\n      \n      // ä¿å­˜åŸå¸‚ä¿¡æ¯å’Œç”¨æˆ·åå¥½åˆ°localStorageç”¨äºåç»­é¡µé¢\n      localStorage.setItem(\"blindbox_city\", eventData.city || \"æ·±åœ³\");\n      localStorage.setItem(\"blindbox_preferences\", JSON.stringify({\n        languages: selectedLanguages,\n        tasteIntensity: selectedTasteIntensity,\n        cuisines: selectedCuisines,\n      }));\n      \n      // ä¿å­˜ç›²ç›’äº‹ä»¶æ•°æ®åˆ°localStorageï¼Œç”¨äºæ”¯ä»˜ååˆ›å»ºäº‹ä»¶\n      localStorage.setItem(\"blindbox_event_data\", JSON.stringify({\n        date: eventData.date,\n        time: eventData.time,\n        eventType: eventData.eventType,\n        city: eventData.city || \"æ·±åœ³\",\n        area: eventData.area,\n        budget: budgetPreference,\n        acceptNearby,\n        selectedLanguages,\n        selectedTasteIntensity,\n        selectedCuisines,\n        inviteFriends,\n        friendsCount,\n        intent: selectedIntent, // Store user's event intent\n      }));\n      \n      setShowConfirmDialog(false);\n      onOpenChange(false);\n      // å¯¼èˆªåˆ°ä»˜è´¹é¡µé¢\n      setTimeout(() => {\n        setLocation(\"/blindbox/payment\");\n      }, 300);\n    } catch (error) {\n      // Error already handled by mutation's onError\n    }\n  };\n\n  const getConfirmButtonText = () => {\n    if (inviteFriends) {\n      return \"ç¡®è®¤å‚ä¸ï¼ˆæˆ‘å’Œæœ‹å‹ï¼‰\";\n    }\n    return \"ç¡®è®¤å‚ä¸\";\n  };\n\n  return (\n    <>\n    <Drawer.Root open={open} onOpenChange={onOpenChange}>\n      <Drawer.Portal>\n        <Drawer.Overlay className=\"fixed inset-0 bg-black/40 z-50\" />\n        <Drawer.Content \n          className=\"bg-background flex flex-col rounded-t-[10px] h-[80vh] mt-24 fixed bottom-0 left-0 right-0 z-50 outline-none\"\n          data-testid=\"drawer-join-blindbox\"\n        >\n          {/* æ‹–æ‹½æŒ‡ç¤ºå™¨ */}\n          <div className=\"mx-auto w-12 h-1.5 flex-shrink-0 rounded-full bg-muted mt-4 mb-4\" />\n          \n          {/* å¯æ»šåŠ¨å†…å®¹ */}\n          <div className=\"overflow-y-auto flex-1 px-4 pb-6\">\n            {/* æ ‡é¢˜ */}\n            <Drawer.Title className=\"text-xl font-bold mb-4\" data-testid=\"text-join-title\">\n              ç¡®è®¤å‚ä¸ä¿¡æ¯\n            </Drawer.Title>\n\n            {/* A. æŠ¥åæ‘˜è¦ */}\n            <div className=\"mb-6 p-4 bg-muted/50 rounded-lg space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2 text-sm\">\n                  <Calendar className=\"h-4 w-4 text-primary\" />\n                  <span className=\"font-medium\">{eventData.date} {eventData.time}</span>\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    {eventData.eventType}\n                  </Badge>\n                  {eventData.isGirlsNight && (\n                    <Badge className=\"text-xs bg-pink-500 hover:bg-pink-600\">\n                      ğŸ‘­ Girls Night\n                    </Badge>\n                  )}\n                </div>\n                <Button \n                  variant=\"ghost\" \n                  size=\"sm\" \n                  className=\"h-6 px-2 text-xs text-primary\"\n                  data-testid=\"button-modify-time\"\n                >\n                  ä¿®æ”¹\n                </Button>\n              </div>\n              \n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <MapPin className=\"h-4 w-4\" />\n                <span>{eventData.area}</span>\n              </div>\n\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <Users className=\"h-4 w-4\" />\n                <span>æœ€å°‘4äººï¼Œæœ€å¤š6äºº</span>\n              </div>\n\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <DollarSign className=\"h-4 w-4\" />\n                <span>å½“å¤©ç°åœºAA</span>\n              </div>\n            </div>\n\n            {/* === USER PREFERENCES SECTION === */}\n            <div className=\"mb-6 space-y-6\">\n              {/* é¢„ç®—é€‰æ‹© */}\n              <div>\n                <div className=\"mb-3\">\n                  <h3 className=\"text-base font-semibold mb-1\">ä½ çš„é¢„ç®—èŒƒå›´ï¼Ÿ</h3>\n                  <p className=\"text-xs text-muted-foreground\">(å¿…å¡«)</p>\n                </div>\n                <div className=\"space-y-3\">\n                  {budgetOptions.map((option) => (\n                    <button\n                      key={option.value}\n                      onClick={() => toggleBudget(option.value)}\n                      className=\"w-full flex items-center justify-between p-4 rounded-xl border-2 border-border bg-background transition-all hover-elevate\"\n                      data-testid={`button-budget-${option.value}`}\n                    >\n                      <span className=\"font-medium text-base\">{getCurrencySymbol(eventData.city || \"æ·±åœ³\")}{option.label}</span>\n                      <div className={`h-6 w-6 rounded-full border-2 flex items-center justify-center transition-all ${\n                        budgetPreference.includes(option.value)\n                          ? 'bg-foreground border-foreground'\n                          : 'border-foreground/30'\n                      }`}>\n                        {budgetPreference.includes(option.value) && (\n                          <CheckCircle2 className=\"h-4 w-4 text-background\" />\n                        )}\n                      </div>\n                    </button>\n                  ))}\n                </div>\n              </div>\n\n              {/* B. å‚ä¸æ„å›¾ (Event-specific intent) - å¯é€‰ */}\n              <div>\n                <div className=\"mb-3\">\n                  <h3 className=\"text-base font-semibold mb-1\">å‚ä¸è¿™åœºæ´»åŠ¨çš„ä¸»è¦ç›®çš„ï¼Ÿ</h3>\n                  <p className=\"text-xs text-muted-foreground\">é€‰å¡« Â· å¸®åŠ©AIåŒ¹é…ï¼Œä¹Ÿå¯ä»¥ä¿æŒå¼€æ”¾å¿ƒæ€ä¸é€‰ Â· å¯å¤šé€‰</p>\n                </div>\n                <div className=\"grid grid-cols-2 gap-2\">\n                  {[\n                    { value: \"flexible\", label: \"çµæ´»å¼€æ”¾Â·éƒ½å¯ä»¥\", icon: \"âœ¨\" },\n                    { value: \"networking\", label: \"æ‹“å±•äººè„‰\", icon: \"ğŸ’¼\" },\n                    { value: \"friends\", label: \"äº¤æœ‹å‹\", icon: \"ğŸ‘‹\" },\n                    { value: \"discussion\", label: \"æ·±åº¦è®¨è®º\", icon: \"ğŸ’¬\" },\n                    { value: \"fun\", label: \"å¨±ä¹æ”¾æ¾\", icon: \"ğŸ‰\" },\n                    { value: \"romance\", label: \"æµªæ¼«ç¤¾äº¤\", icon: \"ğŸ’•\" },\n                  ].map((option) => {\n                    const isSelected = selectedIntent.includes(option.value);\n                    const isFlexible = option.value === \"flexible\";\n                    const hasFlexible = selectedIntent.includes(\"flexible\");\n                    const isDisabled = !isFlexible && hasFlexible;\n\n                    return (\n                      <button\n                        key={option.value}\n                        onClick={() => toggleIntent(option.value)}\n                        disabled={isDisabled}\n                        className={`px-3 py-3 rounded-lg border-2 text-sm transition-all hover-elevate ${\n                          isSelected\n                            ? 'border-primary bg-primary/5 font-medium'\n                            : isDisabled\n                            ? 'border-muted bg-muted/50 text-muted-foreground cursor-not-allowed'\n                            : 'border-muted bg-muted/30'\n                        }`}\n                        data-testid={`button-intent-${option.value}`}\n                      >\n                        <span className=\"mr-1\">{option.icon}</span>\n                        {option.label}\n                      </button>\n                    );\n                  })}\n                </div>\n                {selectedIntent.length > 0 && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => setSelectedIntent([])}\n                    className=\"mt-2 w-full text-xs text-muted-foreground\"\n                    data-testid=\"button-clear-intent\"\n                  >\n                    æ¸…ç©ºé€‰æ‹©\n                  </Button>\n                )}\n              </div>\n\n              {/* C. æˆ‘çš„åå¥½ */}\n              <div>\n                <div className=\"mb-3\">\n                  <h3 className=\"text-base font-semibold mb-1\">æˆ‘çš„åå¥½ï¼ˆå¯å¤šé€‰ï¼‰</h3>\n                  <p className=\"text-xs text-muted-foreground\">å¸®åŠ©AIæ›´ç²¾å‡†åŒ¹é…é¤å…å’ŒåŒä¼´</p>\n                </div>\n                \n                <div className=\"space-y-4\">\n                  {/* è¯­è¨€åå¥½ */}\n                  <div>\n                    <h4 className=\"text-sm font-medium mb-2\">è¯­è¨€</h4>\n                    <div className=\"grid grid-cols-3 gap-2\">\n                      {languageOptions.map((option) => (\n                        <button\n                          key={option.value}\n                          onClick={() => toggleLanguage(option.value)}\n                          className={`px-3 py-2 rounded-lg border-2 text-sm transition-all hover-elevate ${\n                            selectedLanguages.includes(option.value)\n                              ? 'border-primary bg-primary/5 font-medium'\n                              : 'border-muted bg-muted/30'\n                          }`}\n                          data-testid={`button-language-${option.value}`}\n                        >\n                          {option.label}\n                        </button>\n                      ))}\n                    </div>\n                  </div>\n\n                  {/* å£å‘³åå¥½ */}\n                  <div>\n                    <h4 className=\"text-sm font-medium mb-2\">å£å‘³åå¥½ï¼ˆç”¨äºåŒ¹é…é¤å…ï¼‰</h4>\n                    \n                    {/* å£å‘³å¼ºåº¦ */}\n                    <div className=\"mb-3\">\n                      <p className=\"text-xs text-muted-foreground mb-2\">å£å‘³å¼ºåº¦</p>\n                      <div className=\"grid grid-cols-2 gap-2\">\n                        {tasteIntensityOptions.map((option) => (\n                          <button\n                            key={option.value}\n                            onClick={() => toggleTasteIntensity(option.value)}\n                            className={`px-3 py-2 rounded-lg border-2 text-sm transition-all hover-elevate ${\n                              selectedTasteIntensity.includes(option.value)\n                                ? 'border-primary bg-primary/5 font-medium'\n                                : 'border-muted bg-muted/30'\n                            }`}\n                            data-testid={`button-taste-${option.value}`}\n                          >\n                            {option.label}\n                          </button>\n                        ))}\n                      </div>\n                    </div>\n\n                    {/* ä¸»æµèœç³» */}\n                    <div>\n                      <p className=\"text-xs text-muted-foreground mb-2\">ä¸»æµèœç³»</p>\n                      <div className=\"grid grid-cols-3 gap-2\">\n                        {cuisineOptions.map((option) => (\n                          <button\n                            key={option.value}\n                            onClick={() => toggleCuisine(option.value)}\n                            className={`px-3 py-2 rounded-lg border-2 text-sm transition-all hover-elevate ${\n                              selectedCuisines.includes(option.value)\n                                ? 'border-primary bg-primary/5 font-medium'\n                                : 'border-muted bg-muted/30'\n                            }`}\n                            data-testid={`button-cuisine-${option.value}`}\n                          >\n                            {option.label}\n                          </button>\n                        ))}\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* ä¸€é”®æ¸…ç©º - æ”¾åœ¨æœ€åï¼Œæ ·å¼å¼±åŒ– */}\n                  {(selectedLanguages.length > 0 || selectedTasteIntensity.length > 0 || selectedCuisines.length > 0) && (\n                    <Button \n                      variant=\"ghost\" \n                      size=\"sm\" \n                      onClick={clearAllPreferences}\n                      className=\"w-full text-destructive hover:text-destructive hover:bg-destructive/10\"\n                      data-testid=\"button-clear-preferences\"\n                    >\n                      ä¸€é”®æ¸…ç©ºæ‰€æœ‰åå¥½\n                    </Button>\n                  )}\n                </div>\n              </div>\n\n            {/* D. æå‡æˆåŠŸç‡ */}\n            <div className=\"mb-6\">\n              <div className=\"mb-3\">\n                <h3 className=\"text-base font-semibold mb-1\">æå‡æˆåŠŸç‡</h3>\n                <p className=\"text-xs text-muted-foreground\">æ‰©å±•åˆ°é™„è¿‘å•†åœˆï¼Œé€šå¸¸æ›´å¿«æˆå±€</p>\n              </div>\n              <button\n                onClick={() => setAcceptNearby(!acceptNearby)}\n                className=\"w-full flex items-center justify-between p-4 rounded-xl border-2 border-border bg-background transition-all hover-elevate\"\n                data-testid=\"button-accept-nearby\"\n              >\n                <div className=\"text-left\">\n                  <span className=\"font-medium text-sm block\">ç›¸é‚»å•†åœˆ</span>\n                  <span className=\"text-xs text-muted-foreground\">ä¾‹å¦‚åœ¨ç¦ç”°çš„è¯ï¼Œåä¾¨åŸå’Œå—å±±ä¹Ÿå¯ä»¥</span>\n                </div>\n                <div className={`h-6 w-6 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0 ml-2 ${\n                  acceptNearby\n                    ? 'bg-foreground border-foreground'\n                    : 'border-foreground/30'\n                }`}>\n                  {acceptNearby && (\n                    <CheckCircle2 className=\"h-4 w-4 text-background\" />\n                  )}\n                </div>\n              </button>\n            </div>\n            </div>\n\n            {/* E. è§„åˆ™ä¸ä¿éšœ */}\n            <div className=\"mb-6 p-3 bg-blue-50 dark:bg-blue-950/20 rounded-lg\">\n              <div className=\"flex items-start gap-2 mb-2\">\n                <CheckCircle2 className=\"h-4 w-4 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0\" />\n                <div className=\"text-xs text-blue-600 dark:text-blue-400\">\n                  <p className=\"font-medium mb-1\">è§„åˆ™ä¸ä¿éšœ</p>\n                  <ul className=\"space-y-1 list-disc list-inside\">\n                    <li>AIæ™ºèƒ½åŒ¹é… Â· æ»¡4äººæˆå±€ Â· æœ€å¤š6äºº</li>\n                    <li>æˆå±€å‰å¯é€€ï¼›æˆå±€åè‡³å¼€å±€å‰24å°æ—¶å†…ä¸å¯é€€</li>\n                    <li>æŠ¥åæ”¶å–å¹³å°æœåŠ¡è´¹ï¼›å½“å¤©ç°åœºç‚¹å•AA</li>\n                  </ul>\n                </div>\n              </div>\n            </div>\n\n            {/* F. é‚€è¯·æœ‹å‹ï¼ˆæ”¾åˆ°æœ€åï¼Œå¼±åŒ–å±•ç¤ºï¼‰ */}\n            <Collapsible open={inviteFriends} onOpenChange={setInviteFriends} className=\"mb-6\">\n              <div className=\"flex items-center justify-between mb-3\">\n                <div className=\"flex items-center gap-2\">\n                  <Label htmlFor=\"invite-friends\" className=\"text-base font-semibold cursor-pointer\">\n                    é‚€è¯·æœ‹å‹\n                  </Label>\n                  <Info className=\"h-4 w-4 text-muted-foreground\" />\n                </div>\n                <Switch \n                  id=\"invite-friends\" \n                  checked={inviteFriends} \n                  onCheckedChange={setInviteFriends}\n                  data-testid=\"switch-invite-friends\"\n                />\n              </div>\n              \n              <CollapsibleContent className=\"space-y-3\">\n                <p className=\"text-xs text-muted-foreground mb-3\">\n                  ä¸æœ‹å‹ä¸€èµ·æŠ¥åæ›´æœ‰å®‰å…¨æ„Ÿä¸è¯é¢˜æ„Ÿï¼ŒåŒç»„å°†ä¼˜å…ˆåŒå±€åŒ¹é…\n                </p>\n\n                <div className=\"space-y-3\">\n                  <div>\n                    <Label className=\"text-sm mb-2 block\">é€‰æ‹©äººæ•°</Label>\n                    <div className=\"inline-flex rounded-lg p-1 bg-muted\">\n                      <button\n                        onClick={() => setFriendsCount(1)}\n                        className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${\n                          friendsCount === 1\n                            ? \"bg-background text-foreground shadow-sm\"\n                            : \"text-muted-foreground\"\n                        }`}\n                        data-testid=\"button-friends-1\"\n                      >\n                        1ä½æœ‹å‹\n                      </button>\n                      <button\n                        onClick={() => setFriendsCount(2)}\n                        className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${\n                          friendsCount === 2\n                            ? \"bg-background text-foreground shadow-sm\"\n                            : \"text-muted-foreground\"\n                        }`}\n                        data-testid=\"button-friends-2\"\n                      >\n                        2ä½æœ‹å‹\n                      </button>\n                    </div>\n                  </div>\n\n                  {friendsCount === 2 && (\n                    <div className=\"p-2 bg-blue-50 dark:bg-blue-950/20 rounded-md\">\n                      <p className=\"text-xs text-blue-600 dark:text-blue-400\">\n                        æœ¬å±€ä¸Šé™6äººï¼Œç³»ç»Ÿå°†ä¼˜å…ˆåŒ¹é…3â€“4ä½é™Œç”ŸåŒä¼´\n                      </p>\n                    </div>\n                  )}\n\n                  <div>\n                    <Label className=\"text-sm mb-2 block\">é‚€è¯·æ–¹å¼</Label>\n                    <div className=\"flex gap-2\">\n                      <Input \n                        placeholder=\"è¾“å…¥æ‰‹æœºå·æˆ–ç”¨æˆ·å\" \n                        className=\"flex-1\"\n                        data-testid=\"input-friend-contact\"\n                      />\n                      <Button \n                        variant=\"outline\" \n                        size=\"icon\"\n                        onClick={handleCopyInviteLink}\n                        data-testid=\"button-copy-invite-link\"\n                      >\n                        <Copy className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </div>\n\n                  <div className=\"flex items-center space-x-2\">\n                    <Switch \n                      id=\"match-together\" \n                      checked={mustMatchTogether}\n                      onCheckedChange={setMustMatchTogether}\n                      data-testid=\"switch-match-together\"\n                    />\n                    <Label htmlFor=\"match-together\" className=\"text-sm cursor-pointer\">\n                      åŒç»„å¿…åŒå±€åŒ¹é…\n                      <span className=\"text-xs text-muted-foreground ml-1\">ï¼ˆå¯èƒ½å»¶é•¿åŒ¹é…æ—¶é•¿ï¼‰</span>\n                    </Label>\n                  </div>\n                </div>\n              </CollapsibleContent>\n            </Collapsible>\n          </div>\n\n          {/* F. åº•éƒ¨æ“ä½œåŒº */}\n          <div className=\"border-t p-4 space-y-2 flex-shrink-0 bg-background\">\n            <Button \n              className=\"w-full\" \n              size=\"lg\"\n              onClick={handleConfirm}\n              disabled={budgetPreference.length === 0}\n              data-testid=\"button-confirm-join\"\n            >\n              {getConfirmButtonText()}\n            </Button>\n            {budgetPreference.length === 0 && (\n              <p className=\"text-xs text-center text-muted-foreground\">\n                è¯·å…ˆé€‰æ‹©é¢„ç®—èŒƒå›´\n              </p>\n            )}\n            <Button \n              variant=\"ghost\" \n              className=\"w-full\" \n              size=\"sm\"\n              data-testid=\"button-save-only\"\n            >\n              ä»…ä¿å­˜è®¾ç½®ï¼ˆä¸æŠ¥åï¼‰\n            </Button>\n          </div>\n        </Drawer.Content>\n      </Drawer.Portal>\n    </Drawer.Root>\n\n    {/* ç¡®è®¤å¼¹çª— */}\n    <Dialog open={showConfirmDialog} onOpenChange={setShowConfirmDialog}>\n      <DialogContent className=\"max-w-md max-h-[85vh] overflow-y-auto\" data-testid=\"dialog-confirm-join\">\n        <DialogHeader>\n          <DialogTitle>ç¡®è®¤å‚ä¸ä¿¡æ¯</DialogTitle>\n          <DialogDescription>\n            è¯·ç¡®è®¤ä½ çš„é¢„ç®—èŒƒå›´å’Œåå¥½é€‰é¡¹\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-5 py-4\">\n          {/* 1. æ‘˜è¦ */}\n          <div className=\"space-y-2 pb-4 border-b\">\n            <h3 className=\"text-sm font-semibold text-muted-foreground\">æ‘˜è¦</h3>\n            <div className=\"text-sm space-y-1\">\n              <p><strong>{eventData.date} {eventData.time}</strong> Â· {eventData.eventType} Â· {eventData.area}</p>\n              <p className=\"text-muted-foreground\">æˆå‘˜äººæ•°ï¼š4-6äºº</p>\n            </div>\n          </div>\n\n          {/* 2. é¢„ç®— */}\n          <div className=\"space-y-3\">\n            <h3 className=\"text-sm font-semibold\">é¢„ç®—</h3>\n            <div className=\"grid grid-cols-2 gap-2\">\n              {budgetOptions.map((option) => {\n                const isSelected = budgetPreference.includes(option.value);\n                const isRecommended = option.value === \"100-200\"; // ç¤ºä¾‹ï¼š100-200ä¸ºæœ¬åŒºæ¨è\n                return (\n                  <div\n                    key={option.value}\n                    className={`relative flex items-center gap-2 px-3 py-2.5 rounded-lg border-2 transition-all ${\n                      isSelected\n                        ? \"border-primary bg-primary/5\"\n                        : \"border-muted bg-muted/30\"\n                    }`}\n                    data-testid={`dialog-budget-${option.value}`}\n                  >\n                    <div className={`h-4 w-4 rounded-full border-2 flex items-center justify-center flex-shrink-0 ${\n                      isSelected ? \"border-primary bg-primary\" : \"border-muted-foreground\"\n                    }`}>\n                      {isSelected && (\n                        <CheckCircle2 className=\"h-4 w-4 text-background\" />\n                      )}\n                    </div>\n                    <span className={`text-sm ${isSelected ? \"font-medium\" : \"\"}`}>\n                      {getCurrencySymbol(eventData.city || \"æ·±åœ³\")}{option.label}\n                    </span>\n                    {isRecommended && (\n                      <Badge variant=\"secondary\" className=\"absolute -top-2 -right-2 text-[10px] h-4 px-1\">\n                        æœ¬åŒºæ¨è\n                      </Badge>\n                    )}\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n\n          {/* 3. æˆ‘çš„åå¥½ */}\n          {(selectedLanguages.length > 0 || selectedTasteIntensity.length > 0 || selectedCuisines.length > 0) && (\n            <div className=\"space-y-3 pb-4 border-b\">\n              <h3 className=\"text-sm font-semibold\">æˆ‘çš„åå¥½</h3>\n              <div className=\"space-y-2 text-sm\">\n                {selectedLanguages.length > 0 && (\n                  <div>\n                    <span className=\"text-muted-foreground\">è¯­è¨€ï¼š</span>\n                    <span className=\"font-medium ml-2\">{selectedLanguages.join(' Â· ')}</span>\n                  </div>\n                )}\n                {selectedTasteIntensity.length > 0 && (\n                  <div>\n                    <span className=\"text-muted-foreground\">å£å‘³å¼ºåº¦ï¼š</span>\n                    <span className=\"font-medium ml-2\">{selectedTasteIntensity.join(' Â· ')}</span>\n                  </div>\n                )}\n                {selectedCuisines.length > 0 && (\n                  <div>\n                    <span className=\"text-muted-foreground\">èœç³»ï¼š</span>\n                    <span className=\"font-medium ml-2\">{selectedCuisines.join(' Â· ')}</span>\n                  </div>\n                )}\n              </div>\n            </div>\n          )}\n\n          {/* 4. æå‡æˆåŠŸç‡ */}\n          <div className=\"space-y-3\">\n            <div>\n              <h3 className=\"text-sm font-semibold\">æå‡æˆåŠŸç‡</h3>\n              <p className=\"text-xs text-muted-foreground mt-1\">æ‰©å±•åˆ°é™„è¿‘å•†åœˆï¼Œé€šå¸¸æ›´å¿«æˆå±€</p>\n            </div>\n            <div className=\"flex items-center justify-between p-3 rounded-lg border-2 border-muted bg-muted/30\">\n              <span className=\"text-sm\">ç›¸é‚»å•†åœˆ</span>\n              <Badge variant={acceptNearby ? \"default\" : \"outline\"} className=\"text-xs\">\n                {acceptNearby ? \"å·²å¼€å¯\" : \"æœªå¼€å¯\"}\n              </Badge>\n            </div>\n          </div>\n\n          {/* 5. è´¹ç”¨è¯´æ˜ */}\n          <div className=\"p-3 bg-muted/50 rounded-lg\">\n            <h3 className=\"text-sm font-semibold mb-2\">è´¹ç”¨è¯´æ˜</h3>\n            <p className=\"text-xs text-muted-foreground\">\n              å¹³å°æœåŠ¡è´¹ + å½“å¤©AAï¼Œæ— äºŒæ¬¡åŠ ä»·\n            </p>\n          </div>\n\n          {/* 6. è§„åˆ™æ‘˜è¦ */}\n          <div className=\"p-3 bg-blue-50 dark:bg-blue-950/20 rounded-lg\">\n            <h3 className=\"text-sm font-semibold mb-2 text-blue-600 dark:text-blue-400\">è§„åˆ™æ‘˜è¦</h3>\n            <ul className=\"text-xs text-blue-600 dark:text-blue-400 space-y-1\">\n              <li>â€¢ æˆå±€æ¡ä»¶ï¼šæ»¡4äººæˆå±€ï¼Œæœ€å¤š6äºº</li>\n              <li>â€¢ é€€æ”¹è§„åˆ™ï¼šæˆå±€å‰å¯é€€ï¼›æˆå±€åè‡³å¼€å±€å‰24å°æ—¶å†…ä¸å¯é€€</li>\n            </ul>\n          </div>\n\n          {/* 6. é‚€è¯·æœ‹å‹ï¼ˆå¯é€‰ï¼Œå¼±åŒ–å±•ç¤ºï¼‰ */}\n          {inviteFriends && (\n            <div className=\"p-3 border rounded-lg\">\n              <h3 className=\"text-sm font-semibold mb-2\">é‚€è¯·æœ‹å‹</h3>\n              <p className=\"text-xs text-muted-foreground mb-2\">\n                å·²é‚€è¯· {friendsCount} ä½æœ‹å‹\n              </p>\n              <Button \n                variant=\"outline\" \n                size=\"sm\"\n                onClick={handleCopyInviteLink}\n                className=\"w-full\"\n              >\n                <Copy className=\"h-3 w-3 mr-1\" />\n                å¤åˆ¶é‚€è¯·é“¾æ¥\n              </Button>\n            </div>\n          )}\n        </div>\n\n        <DialogFooter className=\"flex gap-2\">\n          <Button\n            variant=\"outline\"\n            onClick={() => setShowConfirmDialog(false)}\n            data-testid=\"button-dialog-cancel\"\n          >\n            è¿”å›ä¿®æ”¹\n          </Button>\n          <Button\n            onClick={handleFinalConfirm}\n            disabled={saveBudgetMutation.isPending}\n            data-testid=\"button-dialog-confirm\"\n          >\n            {saveBudgetMutation.isPending ? \"å¤„ç†ä¸­...\" : \"ç¡®è®¤å¹¶æ”¯ä»˜\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  </>\n  );\n}\n","size_bytes":32805},"client/src/components/LocationSelector.tsx":{"content":"import { ChevronDown } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface LocationSelectorProps {\n  selectedCity: \"é¦™æ¸¯\" | \"æ·±åœ³\";\n  onCityChange: (city: \"é¦™æ¸¯\" | \"æ·±åœ³\") => void;\n}\n\nconst cityConfig = {\n  \"æ·±åœ³\": {\n    flag: \"ğŸ™ï¸\",\n    label: \"æ·±åœ³ è¯•ç‚¹åŸå¸‚\"\n  },\n  \"é¦™æ¸¯\": {\n    flag: \"ğŸ‡­ğŸ‡°\",\n    label: \"é¦™æ¸¯ ç‰¹åˆ«è¡Œæ”¿åŒº\"\n  }\n};\n\nexport default function LocationSelector({ selectedCity, onCityChange }: LocationSelectorProps) {\n  const config = cityConfig[selectedCity];\n  \n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button \n          variant=\"outline\" \n          className=\"gap-1.5 px-3 h-8 hover-elevate active-elevate-2\"\n          data-testid=\"button-location-selector\"\n        >\n          <span className=\"text-base\">{config.flag}</span>\n          <span className=\"text-sm font-medium text-primary\">{selectedCity}</span>\n          <ChevronDown className=\"h-3.5 w-3.5 opacity-50\" />\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"start\" className=\"min-w-[180px]\" data-testid=\"menu-location-options\">\n        <DropdownMenuItem \n          onClick={() => onCityChange(\"æ·±åœ³\")}\n          className=\"gap-2 cursor-pointer hover-elevate\"\n          data-testid=\"menu-item-shenzhen\"\n        >\n          <span className=\"text-base\">ğŸ™ï¸</span>\n          <span className=\"flex-1 text-sm\">{cityConfig[\"æ·±åœ³\"].label}</span>\n          {selectedCity === \"æ·±åœ³\" && (\n            <Badge variant=\"default\" className=\"bg-blue-500 hover:bg-blue-600 text-white text-xs\">\n              å½“å‰\n            </Badge>\n          )}\n        </DropdownMenuItem>\n        <DropdownMenuItem \n          onClick={() => onCityChange(\"é¦™æ¸¯\")}\n          className=\"gap-2 cursor-pointer hover-elevate\"\n          data-testid=\"menu-item-hongkong\"\n        >\n          <span className=\"text-base\">ğŸ‡­ğŸ‡°</span>\n          <span className=\"flex-1 text-sm\">{cityConfig[\"é¦™æ¸¯\"].label}</span>\n          {selectedCity === \"é¦™æ¸¯\" && (\n            <Badge variant=\"default\" className=\"bg-blue-500 hover:bg-blue-600 text-white text-xs\">\n              å½“å‰\n            </Badge>\n          )}\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}\n","size_bytes":2453},"client/src/components/LocationPickerSheet.tsx":{"content":"import { Drawer } from \"vaul\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Search, MapPin, Navigation, Clock, X } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\n\ninterface LocationPickerSheetProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  selectedCity: \"é¦™æ¸¯\" | \"æ·±åœ³\";\n  selectedArea?: string;\n  onSave: (city: \"é¦™æ¸¯\" | \"æ·±åœ³\", area: string) => void;\n}\n\nconst cities = [\n  { name: \"æ·±åœ³\", label: \"è¯•ç‚¹åŸå¸‚\" },\n  { name: \"é¦™æ¸¯\", label: \"ç‰¹åˆ«è¡Œæ”¿åŒº\" }\n];\n\nconst areas = {\n  \"æ·±åœ³\": [\n    { name: \"å—å±±åŒº\", hot: true },\n    { name: \"ç¦ç”°åŒº\", hot: true },\n    { name: \"ç½—æ¹–åŒº\", hot: false },\n    { name: \"å®å®‰åŒº\", hot: false },\n    { name: \"é¾™å²—åŒº\", hot: false }\n  ],\n  \"é¦™æ¸¯\": [\n    { name: \"ä¸­è¥¿åŒº\", hot: true },\n    { name: \"æ¹¾ä»”åŒº\", hot: true },\n    { name: \"ä¸œåŒº\", hot: false },\n    { name: \"å—åŒº\", hot: false },\n    { name: \"æ²¹å°–æ—ºåŒº\", hot: true }\n  ]\n};\n\nexport default function LocationPickerSheet({ \n  open, \n  onOpenChange, \n  selectedCity,\n  selectedArea,\n  onSave \n}: LocationPickerSheetProps) {\n  const [tempCity, setTempCity] = useState<\"é¦™æ¸¯\" | \"æ·±åœ³\">(selectedCity);\n  const [tempArea, setTempArea] = useState(selectedArea || \"\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [recentLocations] = useState([\n    { city: \"æ·±åœ³\", area: \"å—å±±åŒº\" },\n    { city: \"æ·±åœ³\", area: \"ç¦ç”°åŒº\" },\n    { city: \"é¦™æ¸¯\", area: \"ä¸­è¥¿åŒº\" }\n  ]);\n\n  const handleSave = () => {\n    onSave(tempCity, tempArea);\n    onOpenChange(false);\n  };\n\n  const filteredAreas = areas[tempCity].filter(area =>\n    area.name.toLowerCase().includes(searchQuery.toLowerCase())\n  );\n\n  return (\n    <Drawer.Root open={open} onOpenChange={onOpenChange}>\n      <Drawer.Portal>\n        <Drawer.Overlay className=\"fixed inset-0 bg-black/40 z-50\" />\n        <Drawer.Content \n          className=\"bg-background flex flex-col rounded-t-[20px] h-[85vh] mt-24 fixed bottom-0 left-0 right-0 z-50 outline-none\"\n          data-testid=\"drawer-location-picker\"\n        >\n          {/* æ‹–æ‹½æŒ‡ç¤ºå™¨ */}\n          <div className=\"mx-auto w-12 h-1.5 flex-shrink-0 rounded-full bg-muted mt-4\" />\n          \n          {/* æ ‡é¢˜æ  */}\n          <div className=\"flex items-center justify-between px-4 py-4 border-b\">\n            <Drawer.Title className=\"text-xl font-bold\" data-testid=\"text-picker-title\">\n              é€‰æ‹©åŸå¸‚\n            </Drawer.Title>\n            <button\n              onClick={() => onOpenChange(false)}\n              className=\"p-2 hover:bg-muted rounded-full transition-colors\"\n              data-testid=\"button-close-picker\"\n            >\n              <X className=\"h-5 w-5\" />\n            </button>\n          </div>\n\n          {/* å¯æ»šåŠ¨å†…å®¹ */}\n          <div className=\"overflow-y-auto flex-1 px-4 py-4 space-y-6\">\n            \n            {/* å½“å‰ä½ç½® */}\n            <div className=\"flex items-center justify-between p-3 bg-muted/50 rounded-lg\">\n              <div className=\"flex items-center gap-2\">\n                <MapPin className=\"h-5 w-5 text-primary\" />\n                <div>\n                  <div className=\"text-sm font-medium\">å½“å‰ä½ç½®</div>\n                  <div className=\"text-xs text-muted-foreground\">\n                    {tempCity} Â· {tempArea || areas[tempCity][0].name}\n                  </div>\n                </div>\n              </div>\n              <Button \n                variant=\"outline\" \n                size=\"sm\"\n                className=\"gap-1\"\n                data-testid=\"button-use-current-location\"\n              >\n                <Navigation className=\"h-4 w-4\" />\n                å®šä½\n              </Button>\n            </div>\n\n            {/* æœç´¢æ¡† */}\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"æœç´¢å•†åœˆ...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"input-search-area\"\n              />\n            </div>\n\n            {/* æ ‡ç­¾é¡µ */}\n            <Tabs value={tempCity} onValueChange={(v) => setTempCity(v as \"é¦™æ¸¯\" | \"æ·±åœ³\")}>\n              <TabsList className=\"w-full grid grid-cols-2\">\n                <TabsTrigger value=\"æ·±åœ³\" data-testid=\"tab-shenzhen\">\n                  æ·±åœ³\n                </TabsTrigger>\n                <TabsTrigger value=\"é¦™æ¸¯\" data-testid=\"tab-hongkong\">\n                  é¦™æ¸¯\n                </TabsTrigger>\n              </TabsList>\n\n              <TabsContent value={tempCity} className=\"mt-4 space-y-4\">\n                {/* æœ€è¿‘ä½¿ç”¨ */}\n                {recentLocations.length > 0 && (\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2 text-sm font-medium text-muted-foreground\">\n                      <Clock className=\"h-4 w-4\" />\n                      <span>æœ€è¿‘ä½¿ç”¨</span>\n                    </div>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {recentLocations\n                        .filter(loc => loc.city === tempCity)\n                        .slice(0, 3)\n                        .map((loc, idx) => (\n                          <button\n                            key={idx}\n                            onClick={() => setTempArea(loc.area)}\n                            className={`px-3 py-1.5 rounded-full text-sm border transition-all hover-elevate ${\n                              tempArea === loc.area\n                                ? 'bg-primary text-primary-foreground border-primary'\n                                : 'bg-background hover:bg-muted border-border'\n                            }`}\n                            data-testid={`chip-recent-${idx}`}\n                          >\n                            {loc.area}\n                          </button>\n                        ))}\n                    </div>\n                  </div>\n                )}\n\n                {/* æ¨èå•†åœˆ */}\n                <div className=\"space-y-2\">\n                  <div className=\"text-sm font-medium text-muted-foreground\">\n                    æ¨èå•†åœˆ\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-2\">\n                    {filteredAreas.map((area) => (\n                      <button\n                        key={area.name}\n                        onClick={() => setTempArea(area.name)}\n                        className={`p-3 rounded-lg text-left border transition-all hover-elevate ${\n                          tempArea === area.name\n                            ? 'bg-primary/10 border-primary'\n                            : 'bg-background hover:bg-muted border-border'\n                        }`}\n                        data-testid={`area-${area.name}`}\n                      >\n                        <div className=\"flex items-center justify-between mb-1\">\n                          <span className=\"font-medium\">{area.name}</span>\n                          {area.hot && (\n                            <Badge variant=\"secondary\" className=\"text-xs bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300\">\n                              çƒ­é—¨\n                            </Badge>\n                          )}\n                        </div>\n                        {tempArea === area.name && (\n                          <div className=\"text-xs text-primary\">âœ“ å·²é€‰æ‹©</div>\n                        )}\n                      </button>\n                    ))}\n                  </div>\n                </div>\n\n                {filteredAreas.length === 0 && (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    æœªæ‰¾åˆ°åŒ¹é…çš„å•†åœˆ\n                  </div>\n                )}\n              </TabsContent>\n            </Tabs>\n\n            {/* æç¤º */}\n            <div className=\"text-xs text-center text-muted-foreground py-2\">\n              ğŸ’¡ æ¢ä¸ªå•†åœˆçœ‹çœ‹ï¼Œæˆå±€æ›´å¿«\n            </div>\n          </div>\n\n          {/* åº•éƒ¨æ“ä½œåŒº */}\n          <div className=\"border-t p-4 flex gap-2 flex-shrink-0 bg-background\">\n            <Button \n              variant=\"outline\" \n              className=\"flex-1\"\n              onClick={() => {\n                setTempArea(\"\");\n              }}\n              data-testid=\"button-reset\"\n            >\n              é‡ç½®ä¸ºå…¨åŸ\n            </Button>\n            <Button \n              className=\"flex-1\" \n              onClick={handleSave}\n              disabled={!tempArea}\n              data-testid=\"button-save-location\"\n            >\n              ä¿å­˜å¹¶åˆ·æ–°\n            </Button>\n          </div>\n        </Drawer.Content>\n      </Drawer.Portal>\n    </Drawer.Root>\n  );\n}\n","size_bytes":9040},"client/src/components/BlindBoxInfoSheet.tsx":{"content":"import { Drawer } from \"vaul\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Calendar, MapPin, Sparkles, ChevronDown, Users, HelpCircle, DollarSign } from \"lucide-react\";\nimport { useState } from \"react\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { getCurrencySymbol } from \"@/lib/currency\";\n\ninterface BlindBoxInfoSheetProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  eventData: {\n    date: string;\n    time: string;\n    eventType: \"é¥­å±€\" | \"é…’å±€\";\n    area: string;\n    priceTier?: string;\n    isAA?: boolean;\n    city?: \"é¦™æ¸¯\" | \"æ·±åœ³\";\n  };\n}\n\nexport default function BlindBoxInfoSheet({ \n  open, \n  onOpenChange, \n  eventData \n}: BlindBoxInfoSheetProps) {\n  const [faqOpen, setFaqOpen] = useState<{ [key: string]: boolean }>({});\n\n  const toggleFaq = (index: string) => {\n    setFaqOpen(prev => ({ ...prev, [index]: !prev[index] }));\n  };\n\n  const faqs = [\n    {\n      q: \"æˆ‘èƒ½å¸¦æœ‹å‹å—ï¼Ÿ\",\n      a: \"å¯åœ¨æŠ¥ååæ·»åŠ  1â€“2 ä½åŒè¡Œï¼Œç»Ÿä¸€åŒ¹é…ã€‚\"\n    },\n    {\n      q: \"ä¸´æ—¶æœ‰äº‹ï¼Ÿ\",\n      a: \"æˆå±€åæŒ‰æ´»åŠ¨é€€æ”¹è§„åˆ™å¤„ç†ã€‚\"\n    },\n    {\n      q: \"åŒ¹é…å¤šä¹…ï¼Ÿ\",\n      a: \"é€šå¸¸ 2â€“6 å°æ—¶ï¼Œç¹å¿™æ—¶æ®µæ›´å¿«ã€‚\"\n    }\n  ];\n\n  return (\n    <Drawer.Root open={open} onOpenChange={onOpenChange}>\n      <Drawer.Portal>\n        <Drawer.Overlay className=\"fixed inset-0 bg-black/40 z-50\" />\n        <Drawer.Content \n          className=\"bg-background flex flex-col rounded-t-[10px] h-[70vh] mt-24 fixed bottom-0 left-0 right-0 z-50 outline-none\"\n          data-testid=\"drawer-blindbox-info\"\n        >\n          {/* æ‹–æ‹½æŒ‡ç¤ºå™¨ */}\n          <div className=\"mx-auto w-12 h-1.5 flex-shrink-0 rounded-full bg-muted mt-4 mb-4\" />\n          \n          {/* å¯æ»šåŠ¨å†…å®¹ */}\n          <div className=\"overflow-y-auto flex-1 px-4 pb-6\">\n            {/* æ ‡é¢˜ */}\n            <div className=\"mb-6\">\n              <Drawer.Title className=\"text-xl font-bold mb-2\" data-testid=\"text-sheet-title\">\n                ä»€ä¹ˆæ˜¯ç›²ç›’æ¨¡å¼ï¼Ÿ\n              </Drawer.Title>\n              <p className=\"text-sm text-muted-foreground\">\n                è¯¦æƒ…åœ¨æˆå±€åè§£é”\n              </p>\n            </div>\n\n            {/* 1. é¡¶éƒ¨æ‘˜è¦æ¡ */}\n            <div className=\"mb-6 p-4 bg-muted/50 rounded-lg space-y-2\">\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Calendar className=\"h-4 w-4 text-primary\" />\n                <span className=\"font-medium\">{eventData.date} {eventData.time}</span>\n                <Badge variant=\"secondary\" className=\"text-xs\">\n                  {eventData.eventType}\n                </Badge>\n              </div>\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <MapPin className=\"h-4 w-4\" />\n                <span>{eventData.area}</span>\n              </div>\n              {(eventData.priceTier || eventData.isAA) && (\n                <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                  <DollarSign className=\"h-4 w-4\" />\n                  <span>\n                    {eventData.priceTier && `${getCurrencySymbol(eventData.city || \"æ·±åœ³\")}${eventData.priceTier}`}\n                    {eventData.isAA && ` Â· AAåˆ¶`}\n                  </span>\n                </div>\n              )}\n            </div>\n\n            {/* 2. ç›²ç›’æ€ä¹ˆç© */}\n            <div className=\"mb-6\">\n              <h3 className=\"text-base font-semibold mb-3 flex items-center gap-2\">\n                <Sparkles className=\"h-5 w-5 text-primary\" />\n                ç›²ç›’æ€ä¹ˆç©\n              </h3>\n              <div className=\"space-y-3\">\n                <div className=\"flex gap-3\">\n                  <div className=\"flex-shrink-0 w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center text-primary text-xs font-bold\">\n                    1\n                  </div>\n                  <div>\n                    <p className=\"text-sm font-medium\">å…ˆæŠ¥åï¼Œå†æ­æ™“</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      é€‰æ‹©æ—¶é—´ä¸ç±»å‹ï¼Œæäº¤åè¿›å…¥åŒ¹é…\n                    </p>\n                  </div>\n                </div>\n                <div className=\"flex gap-3\">\n                  <div className=\"flex-shrink-0 w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center text-primary text-xs font-bold\">\n                    2\n                  </div>\n                  <div>\n                    <p className=\"text-sm font-medium\">æ™ºèƒ½é…å¯¹</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      æŒ‰å…´è¶£ã€è·ç¦»ä¸äººæ•°è‡ªåŠ¨æˆå±€\n                    </p>\n                  </div>\n                </div>\n                <div className=\"flex gap-3\">\n                  <div className=\"flex-shrink-0 w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center text-primary text-xs font-bold\">\n                    3\n                  </div>\n                  <div>\n                    <p className=\"text-sm font-medium\">æˆå±€å³é€šçŸ¥</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      è§£é”æ´»åŠ¨åç§°ã€å…·ä½“åœ°ç‚¹ä¸ç¾¤èŠ\n                    </p>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* 3. æˆå±€ä¸é€€æ¬¾ */}\n            <div className=\"mb-6\">\n              <h3 className=\"text-base font-semibold mb-3 flex items-center gap-2\">\n                <Users className=\"h-5 w-5 text-primary\" />\n                æˆå±€ä¸é€€æ¬¾\n              </h3>\n              <div className=\"space-y-2 text-sm\">\n                <div className=\"flex items-start gap-2\">\n                  <div className=\"w-1.5 h-1.5 rounded-full bg-primary mt-1.5 flex-shrink-0\" />\n                  <p><span className=\"font-medium\">æˆå±€æ¡ä»¶ï¼š</span>æ»¡è¶³æœ€ä½4äººå³æˆå±€ï¼Œ6äººå°é¡¶</p>\n                </div>\n                <div className=\"flex items-start gap-2\">\n                  <div className=\"w-1.5 h-1.5 rounded-full bg-primary mt-1.5 flex-shrink-0\" />\n                  <p><span className=\"font-medium\">æœªæˆå±€ï¼š</span>è‡ªåŠ¨å–æ¶ˆå¹¶åŸè·¯é€€æ¬¾</p>\n                </div>\n                <div className=\"flex items-start gap-2\">\n                  <div className=\"w-1.5 h-1.5 rounded-full bg-primary mt-1.5 flex-shrink-0\" />\n                  <p><span className=\"font-medium\">è¶…æ—¶ä¿æŠ¤ï¼š</span>æ´»åŠ¨å‰48å°æ—¶æœªæˆå±€ï¼Œç³»ç»Ÿè‡ªåŠ¨é€€æ¬¾</p>\n                </div>\n              </div>\n            </div>\n\n            {/* 4. å¸¸è§é—®é¢˜ */}\n            <div className=\"mb-6\">\n              <h3 className=\"text-base font-semibold mb-3 flex items-center gap-2\">\n                <HelpCircle className=\"h-5 w-5 text-primary\" />\n                å¸¸è§é—®é¢˜\n              </h3>\n              <div className=\"space-y-2\">\n                {faqs.map((faq, index) => (\n                  <Collapsible\n                    key={index}\n                    open={faqOpen[index.toString()]}\n                    onOpenChange={() => toggleFaq(index.toString())}\n                  >\n                    <CollapsibleTrigger \n                      className=\"flex items-center justify-between w-full text-left p-3 rounded-md hover-elevate active-elevate-2 border\"\n                      data-testid={`button-faq-${index}`}\n                    >\n                      <span className=\"text-sm font-medium\">{faq.q}</span>\n                      <ChevronDown \n                        className={`h-4 w-4 transition-transform ${\n                          faqOpen[index.toString()] ? 'transform rotate-180' : ''\n                        }`}\n                      />\n                    </CollapsibleTrigger>\n                    <CollapsibleContent className=\"px-3 pt-2 pb-3\">\n                      <p className=\"text-sm text-muted-foreground\">{faq.a}</p>\n                    </CollapsibleContent>\n                  </Collapsible>\n                ))}\n              </div>\n            </div>\n          </div>\n        </Drawer.Content>\n      </Drawer.Portal>\n    </Drawer.Root>\n  );\n}\n","size_bytes":8188},"client/src/pages/BlindBoxPaymentPage.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { X, ChevronDown, Sparkles, Zap, Gift } from \"lucide-react\";\nimport { motion } from \"framer-motion\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { getCurrencySymbol } from \"@/lib/currency\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function BlindBoxPaymentPage() {\n  const [, setLocation] = useLocation();\n  const [promoOpen, setPromoOpen] = useState(false);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const city = (localStorage.getItem(\"blindbox_city\") || \"æ·±åœ³\") as \"é¦™æ¸¯\" | \"æ·±åœ³\";\n  const currencySymbol = getCurrencySymbol(city);\n\n  const createEventMutation = useMutation({\n    mutationFn: async (eventData: any) => {\n      return await apiRequest(\"POST\", \"/api/blind-box-events\", eventData);\n    },\n    onSuccess: () => {\n      // ç«‹å³åˆ·æ–°Event Tabæ•°æ®\n      queryClient.invalidateQueries({ queryKey: [\"/api/my-events\"] });\n      // åˆ·æ–°èŠå¤©é¡µé¢æ•°æ®ï¼ˆç¾¤èŠåˆ—è¡¨ï¼‰\n      queryClient.invalidateQueries({ queryKey: [\"/api/events/joined\"] });\n      // æ¸…é™¤ä¸´æ—¶æ•°æ®\n      localStorage.removeItem(\"blindbox_event_data\");\n      // è·³è½¬åˆ°æ´»åŠ¨é¡µé¢\n      setLocation(\"/events\");\n    },\n    onError: (error) => {\n      toast({\n        title: \"åˆ›å»ºæ´»åŠ¨å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handlePayment = async () => {\n    // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ\n    try {\n      // ä»localStorageè·å–ç›²ç›’äº‹ä»¶æ•°æ®\n      const eventDataStr = localStorage.getItem(\"blindbox_event_data\");\n      if (!eventDataStr) {\n        toast({\n          title: \"æ•°æ®é”™è¯¯\",\n          description: \"æœªæ‰¾åˆ°æ´»åŠ¨æ•°æ®ï¼Œè¯·é‡æ–°æŠ¥å\",\n          variant: \"destructive\",\n        });\n        setLocation(\"/discover\");\n        return;\n      }\n      \n      const eventData = JSON.parse(eventDataStr);\n      \n      // åˆ›å»ºç›²ç›’äº‹ä»¶\n      await createEventMutation.mutateAsync(eventData);\n    } catch (error) {\n      console.error(\"Payment error:\", error);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen relative overflow-hidden bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400\">\n      {/* èƒŒæ™¯è£…é¥°åŠ¨ç”» */}\n      <div className=\"absolute inset-0 overflow-hidden\">\n        <motion.div\n          className=\"absolute -top-20 -left-20 w-72 h-72 bg-white/10 rounded-full blur-3xl\"\n          animate={{\n            scale: [1, 1.2, 1],\n            opacity: [0.3, 0.5, 0.3],\n          }}\n          transition={{\n            duration: 4,\n            repeat: Infinity,\n            ease: \"easeInOut\",\n          }}\n        />\n        <motion.div\n          className=\"absolute -bottom-20 -right-20 w-96 h-96 bg-yellow-300/10 rounded-full blur-3xl\"\n          animate={{\n            scale: [1.2, 1, 1.2],\n            opacity: [0.2, 0.4, 0.2],\n          }}\n          transition={{\n            duration: 5,\n            repeat: Infinity,\n            ease: \"easeInOut\",\n          }}\n        />\n      </div>\n\n      {/* å…³é—­æŒ‰é’® */}\n      <button\n        onClick={() => setLocation(\"/discover\")}\n        className=\"absolute top-4 right-4 z-50 bg-black/20 hover:bg-black/40 rounded-full p-2 backdrop-blur-sm transition-colors\"\n        data-testid=\"button-close-payment\"\n      >\n        <X className=\"h-6 w-6 text-white\" />\n      </button>\n\n      <div className=\"relative z-10 flex flex-col min-h-screen\">\n        {/* é¡¶éƒ¨åŠ¨ç”»æ ‡é¢˜ */}\n        <div className=\"flex-1 flex items-center justify-center px-6 pt-16 pb-8\">\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.6 }}\n            className=\"text-center\"\n          >\n            <motion.div\n              animate={{\n                rotate: [0, 10, -10, 10, 0],\n              }}\n              transition={{\n                duration: 2,\n                repeat: Infinity,\n                ease: \"easeInOut\",\n              }}\n              className=\"inline-block mb-4\"\n            >\n              <Sparkles className=\"h-16 w-16 text-yellow-300\" />\n            </motion.div>\n            <h1 className=\"text-4xl font-bold text-white mb-3 drop-shadow-lg\">\n              è§£é”ç¥ç§˜ç›²ç›’\n            </h1>\n            <p className=\"text-white/90 text-lg drop-shadow-md\">\n              AIåŒ¹é… Â· æƒŠå–œä½“éªŒ Â· æ–°æœ‹å‹\n            </p>\n          </motion.div>\n        </div>\n\n        {/* ä»˜è´¹å¡ç‰‡ */}\n        <motion.div\n          initial={{ opacity: 0, y: 50 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5, delay: 0.2 }}\n          className=\"bg-background rounded-t-[32px] shadow-2xl p-6 space-y-6\"\n        >\n          {/* æ´»åŠ¨ä¿¡æ¯æ‘˜è¦ */}\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center justify-between\">\n              <h2 className=\"text-xl font-bold\">å‘¨ä¸‰ 19:00 Â· é¥­å±€</h2>\n              <Badge variant=\"default\" className=\"bg-purple-500 hover:bg-purple-600\">\n                ç›²ç›’æ¨¡å¼\n              </Badge>\n            </div>\n            <div className=\"text-sm text-muted-foreground space-y-1\">\n              <p>ğŸ“ æ·±åœ³Â·å—å±±åŒº</p>\n              <p>ğŸ‘¥ 4-6äºº Â· AIæ™ºèƒ½åŒ¹é…</p>\n            </div>\n          </div>\n\n          {/* ä»·æ ¼é€‰é¡¹ - Gamified */}\n          <div className=\"space-y-4\">\n            <h3 className=\"font-semibold flex items-center gap-2\">\n              <Zap className=\"h-5 w-5 text-yellow-500\" />\n              é€‰æ‹©å‚ä¸æ–¹å¼\n            </h3>\n            \n            <div className=\"grid gap-3\">\n              {/* å•æ¬¡ç¥¨ - æ¨è */}\n              <motion.div\n                whileHover={{ scale: 1.02 }}\n                whileTap={{ scale: 0.98 }}\n              >\n                <Card className=\"p-4 border-2 border-primary bg-primary/5 hover-elevate cursor-pointer relative overflow-hidden\" data-testid=\"card-single-ticket\">\n                  <div className=\"absolute top-2 right-2\">\n                    <Badge className=\"bg-gradient-to-r from-yellow-400 to-orange-500 text-black border-0\">\n                      <Gift className=\"h-3 w-3 mr-1\" />\n                      æ¨è\n                    </Badge>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <h4 className=\"font-bold text-lg\">å•æ¬¡ç›²ç›’ç¥¨</h4>\n                      <p className=\"text-xs text-muted-foreground\">æœ¬æ¬¡æ´»åŠ¨ä¸“äº«</p>\n                    </div>\n                    <div className=\"text-right\">\n                      <div className=\"text-2xl font-bold text-primary\">{currencySymbol}88</div>\n                      <div className=\"text-xs text-muted-foreground\">æœåŠ¡è´¹</div>\n                    </div>\n                  </div>\n                </Card>\n              </motion.div>\n\n              {/* æœˆåº¦è®¢é˜… */}\n              <motion.div\n                whileHover={{ scale: 1.02 }}\n                whileTap={{ scale: 0.98 }}\n              >\n                <Card className=\"p-4 border hover-elevate cursor-pointer\" data-testid=\"card-monthly-sub\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <h4 className=\"font-bold\">æœˆåº¦ç•…ç©å¡</h4>\n                      <p className=\"text-xs text-muted-foreground\">æ— é™å‚ä¸æ‰€æœ‰æ´»åŠ¨</p>\n                    </div>\n                    <div className=\"text-right\">\n                      <div className=\"flex items-baseline gap-1\">\n                        <span className=\"text-lg line-through text-muted-foreground\">{currencySymbol}299</span>\n                        <span className=\"text-2xl font-bold\">{currencySymbol}199</span>\n                      </div>\n                      <div className=\"text-xs text-green-600 font-medium\">çœ33%</div>\n                    </div>\n                  </div>\n                </Card>\n              </motion.div>\n            </div>\n          </div>\n\n          {/* Promo Code */}\n          <Collapsible open={promoOpen} onOpenChange={setPromoOpen}>\n            <CollapsibleTrigger className=\"w-full\" data-testid=\"button-promo-toggle\">\n              <div className=\"flex items-center justify-between p-3 rounded-lg hover:bg-muted/50 transition-colors\">\n                <span className=\"font-medium\">ä¼˜æƒ ç </span>\n                <ChevronDown className={`h-5 w-5 transition-transform ${promoOpen ? 'rotate-180' : ''}`} />\n              </div>\n            </CollapsibleTrigger>\n            <CollapsibleContent>\n              <div className=\"p-3 pt-0\">\n                <input\n                  type=\"text\"\n                  placeholder=\"è¾“å…¥ä¼˜æƒ ç \"\n                  className=\"w-full px-4 py-2 rounded-lg border bg-background\"\n                  data-testid=\"input-promo-code\"\n                />\n              </div>\n            </CollapsibleContent>\n          </Collapsible>\n\n          {/* Total */}\n          <div className=\"pt-4 border-t space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-lg font-bold\">æ€»è®¡</span>\n              <span className=\"text-3xl font-bold text-primary\">{currencySymbol}88</span>\n            </div>\n\n            {/* æ”¯ä»˜æŒ‰é’® - è¶…çº§Gamified */}\n            <motion.div\n              whileHover={{ scale: 1.02 }}\n              whileTap={{ scale: 0.98 }}\n            >\n              <Button\n                size=\"lg\"\n                className=\"w-full text-lg font-bold bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 shadow-lg\"\n                onClick={handlePayment}\n                data-testid=\"button-pay\"\n              >\n                <Sparkles className=\"h-5 w-5 mr-2\" />\n                ç«‹å³æ”¯ä»˜è§£é”ç›²ç›’\n                <Sparkles className=\"h-5 w-5 ml-2\" />\n              </Button>\n            </motion.div>\n\n            {/* è¯´æ˜æ–‡å­— */}\n            <div className=\"text-xs text-center text-muted-foreground space-y-1\">\n              <p>âœ¨ æ”¯ä»˜åç«‹å³è¿›å…¥åŒ¹é…é˜Ÿåˆ—</p>\n              <p>ğŸ æˆå±€å‰å¯é€€æ¬¾ï¼Œæˆå±€å24å°æ—¶å‰ä¸å¯é€€</p>\n              <p>ğŸ”’ èµ„é‡‘å®‰å…¨ç”±å¹³å°ä¿éšœ</p>\n            </div>\n          </div>\n        </motion.div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":10639},"client/src/components/BlindBoxEventCard.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Calendar, MapPin, Sparkles, Users } from \"lucide-react\";\nimport BlindBoxInfoSheet from \"./BlindBoxInfoSheet\";\nimport JoinBlindBoxSheet from \"./JoinBlindBoxSheet\";\n\ntype PriceTier = \"100å…ƒä»¥ä¸‹\" | \"100-200\" | \"200-300\" | \"300-500\" | \"500+\";\n\ninterface BlindBoxEventCardProps {\n  id: string;\n  date: string;\n  time: string;\n  eventType: \"é¥­å±€\" | \"é…’å±€\";\n  area: string;\n  mysteryTitle: string;\n  priceTier?: PriceTier;\n  isAA?: boolean;\n  city?: \"é¦™æ¸¯\" | \"æ·±åœ³\";\n  isGirlsNight?: boolean;\n}\n\nexport default function BlindBoxEventCard({\n  id,\n  date,\n  time,\n  eventType,\n  area,\n  mysteryTitle,\n  priceTier,\n  isAA,\n  city,\n  isGirlsNight\n}: BlindBoxEventCardProps) {\n  const [, navigate] = useLocation();\n  const [infoSheetOpen, setInfoSheetOpen] = useState(false);\n  const [joinSheetOpen, setJoinSheetOpen] = useState(false);\n\n  const handleJoinClick = () => {\n    // Navigate to event pool registration page\n    navigate(`/event-pool/${id}/register`);\n  };\n\n  return (\n    <>\n      <Card className=\"hover-elevate active-elevate-2 transition-all border shadow-sm\" data-testid={`card-blindbox-${id}`}>\n        <div className=\"p-4 space-y-3\">\n          <div className=\"flex items-start justify-between gap-3\">\n            <div className=\"flex-1\">\n              <h3 className=\"font-display font-bold text-lg text-muted-foreground/60 mb-2\">\n                {mysteryTitle}\n              </h3>\n              \n              <div className=\"flex items-center gap-2 flex-wrap\">\n                <div className=\"flex items-center gap-1.5 text-sm font-medium\">\n                  <Calendar className=\"h-4 w-4 text-primary\" />\n                  <span>{date} {time}</span>\n                </div>\n                <Badge \n                  variant=\"secondary\" \n                  className=\"text-xs px-2 py-0.5 rounded-md\"\n                  data-testid={`badge-event-type-${eventType}`}\n                >\n                  {eventType}\n                </Badge>\n                {isGirlsNight && (\n                  <Badge \n                    variant=\"default\" \n                    className=\"text-xs px-2 py-0.5 rounded-md bg-pink-500 hover:bg-pink-600\"\n                    data-testid=\"badge-girls-night\"\n                  >\n                    ğŸ‘­ Girls Night\n                  </Badge>\n                )}\n              </div>\n            </div>\n            \n            <Sparkles className=\"h-5 w-5 text-primary\" />\n          </div>\n\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <MapPin className=\"h-4 w-4\" />\n            <span>{area}</span>\n          </div>\n\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <Users className=\"h-4 w-4\" />\n            <span>4-6äºº</span>\n            <span className=\"text-xs\">\n              â€¢ {isGirlsNight ? \"ä»…é™å¥³ç”Ÿ\" : \"å°½é‡ä¿æŒç”·å¥³æ¯”ä¾‹å¹³è¡¡\"}\n            </span>\n          </div>\n\n          <div className=\"flex gap-2 pt-1\">\n            <Button \n              className=\"flex-1\" \n              size=\"default\"\n              onClick={handleJoinClick}\n              data-testid={`button-join-${id}`}\n            >\n              <Sparkles className=\"h-4 w-4 mr-1.5\" />\n              ç«‹å³å‚ä¸\n            </Button>\n            <Button \n              variant=\"outline\" \n              size=\"default\"\n              onClick={() => setInfoSheetOpen(true)}\n              data-testid={`button-learn-more-${id}`}\n            >\n              äº†è§£æ›´å¤š\n            </Button>\n          </div>\n        </div>\n      </Card>\n\n      <BlindBoxInfoSheet\n        open={infoSheetOpen}\n        onOpenChange={setInfoSheetOpen}\n        eventData={{\n          date,\n          time,\n          eventType,\n          area,\n          priceTier,\n          isAA,\n          city\n        }}\n      />\n\n      <JoinBlindBoxSheet\n        open={joinSheetOpen}\n        onOpenChange={setJoinSheetOpen}\n        eventData={{\n          date,\n          time,\n          eventType,\n          area,\n          priceTier,\n          isAA,\n          isGirlsNight,\n          city\n        }}\n      />\n    </>\n  );\n}\n","size_bytes":4329},"client/src/pages/BlindBoxConfirmationPage.tsx":{"content":"import { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { CheckCircle2, MapPin, Users, DollarSign, Calendar, Clock, ArrowRight, Settings } from \"lucide-react\";\nimport { motion } from \"framer-motion\";\nimport { getCurrencySymbol } from \"@/lib/currency\";\n\nexport default function BlindBoxConfirmationPage() {\n  const [, setLocation] = useLocation();\n  const city = (localStorage.getItem(\"blindbox_city\") || \"æ·±åœ³\") as \"é¦™æ¸¯\" | \"æ·±åœ³\";\n  const currencySymbol = getCurrencySymbol(city);\n\n  // ä»localStorageè¯»å–ç”¨æˆ·åå¥½\n  const userPreferences = JSON.parse(localStorage.getItem(\"blindbox_preferences\") || \"{}\");\n\n  // æ¨¡æ‹Ÿæ•°æ®ï¼ˆå®é™…åº”ä»çŠ¶æ€ç®¡ç†æˆ–è·¯ç”±å‚æ•°è·å–ï¼‰\n  const confirmationData = {\n    date: \"å‘¨ä¸‰\",\n    time: \"19:00\",\n    eventType: \"é¥­å±€\",\n    area: city === \"é¦™æ¸¯\" ? \"é¦™æ¸¯Â·ä¸­è¥¿åŒº\" : \"æ·±åœ³Â·å—å±±åŒº\",\n    budget: [\"100-200\", \"200-300\"],\n    preferences: {\n      acceptNearby: true,\n      flexibleTime: true,\n      typeSubstitute: false,\n      noStrictRestrictions: true,\n    },\n    inviteFriends: false,\n    serviceFee: `${currencySymbol}88`,\n    userPreferences: {\n      languages: userPreferences.languages || [],\n      tasteIntensity: userPreferences.tasteIntensity || [],\n      cuisines: userPreferences.cuisines || [],\n    },\n  };\n\n  const handleViewProgress = () => {\n    setLocation(\"/discover\");\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-green-50 via-blue-50 to-purple-50 dark:from-green-950/20 dark:via-blue-950/20 dark:to-purple-950/20\">\n      <div className=\"max-w-2xl mx-auto px-4 py-8 space-y-6\">\n        {/* æˆåŠŸçŠ¶æ€å¡ */}\n        <motion.div\n          initial={{ opacity: 0, scale: 0.9 }}\n          animate={{ opacity: 1, scale: 1 }}\n          transition={{ duration: 0.5 }}\n        >\n          <Card className=\"p-6 bg-gradient-to-br from-green-500 to-emerald-600 text-white border-0\" data-testid=\"card-success-status\">\n            <div className=\"flex flex-col items-center text-center space-y-4\">\n              <motion.div\n                initial={{ scale: 0 }}\n                animate={{ scale: 1 }}\n                transition={{ delay: 0.2, type: \"spring\", stiffness: 200 }}\n              >\n                <div className=\"bg-white/20 rounded-full p-4\">\n                  <CheckCircle2 className=\"h-16 w-16\" />\n                </div>\n              </motion.div>\n              <div>\n                <h1 className=\"text-2xl font-bold mb-2\">æŠ¥åæˆåŠŸï¼</h1>\n                <p className=\"text-white/90 text-sm\">\n                  ä½ çš„ä¿¡æ¯å·²æäº¤ï¼ŒAIæ­£åœ¨ä¸ºä½ å¯»æ‰¾æœ€ä½³åŒ¹é…\n                </p>\n              </div>\n            </div>\n          </Card>\n        </motion.div>\n\n        {/* å·²ç¡®è®¤ä¿¡æ¯ - åªè¯»å±•ç¤º */}\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.3 }}\n        >\n          <Card className=\"p-6\" data-testid=\"card-confirmed-info\">\n            <h2 className=\"text-lg font-bold mb-4\">å·²ç¡®è®¤ä¿¡æ¯</h2>\n            \n            <div className=\"space-y-4\">\n              {/* æ´»åŠ¨æ‘˜è¦ */}\n              <div className=\"pb-4 border-b\">\n                <div className=\"flex items-center justify-between mb-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <Calendar className=\"h-4 w-4 text-primary\" />\n                    <span className=\"font-medium\">{confirmationData.date} {confirmationData.time}</span>\n                  </div>\n                  <Badge variant=\"secondary\">{confirmationData.eventType}</Badge>\n                </div>\n                <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                  <MapPin className=\"h-4 w-4\" />\n                  <span>{confirmationData.area}</span>\n                </div>\n              </div>\n\n              {/* æˆ‘çš„åå¥½ */}\n              {(confirmationData.userPreferences.languages.length > 0 || \n                confirmationData.userPreferences.tasteIntensity.length > 0 || \n                confirmationData.userPreferences.cuisines.length > 0) && (\n                <div className=\"pb-4 border-b\">\n                  <h3 className=\"text-sm font-semibold mb-2\">æˆ‘çš„åå¥½</h3>\n                  <div className=\"space-y-2 text-sm\">\n                    {confirmationData.userPreferences.languages.length > 0 && (\n                      <div className=\"flex items-start justify-between gap-2\">\n                        <span className=\"text-muted-foreground\">è¯­è¨€ï¼š</span>\n                        <span className=\"font-medium text-right\">{confirmationData.userPreferences.languages.join(' Â· ')}</span>\n                      </div>\n                    )}\n                    {confirmationData.userPreferences.tasteIntensity.length > 0 && (\n                      <div className=\"flex items-start justify-between gap-2\">\n                        <span className=\"text-muted-foreground\">å£å‘³å¼ºåº¦ï¼š</span>\n                        <span className=\"font-medium text-right\">{confirmationData.userPreferences.tasteIntensity.join(' Â· ')}</span>\n                      </div>\n                    )}\n                    {confirmationData.userPreferences.cuisines.length > 0 && (\n                      <div className=\"flex items-start justify-between gap-2\">\n                        <span className=\"text-muted-foreground\">èœç³»ï¼š</span>\n                        <span className=\"font-medium text-right\">{confirmationData.userPreferences.cuisines.join(' Â· ')}</span>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              )}\n\n              {/* é¢„ç®—èŒƒå›´ */}\n              <div className=\"pb-4 border-b\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n                  <h3 className=\"text-sm font-semibold\">é¢„ç®—èŒƒå›´</h3>\n                </div>\n                <div className=\"flex gap-2\">\n                  {confirmationData.budget.map((range) => (\n                    <Badge key={range} variant=\"outline\" className=\"text-xs\">\n                      {currencySymbol}{range}\n                    </Badge>\n                  ))}\n                </div>\n              </div>\n\n              {/* æå‡æˆåŠŸç‡ */}\n              <div className=\"pb-4 border-b\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Settings className=\"h-4 w-4 text-muted-foreground\" />\n                  <h3 className=\"text-sm font-semibold\">æå‡æˆåŠŸç‡</h3>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-muted-foreground text-sm\">ç›¸é‚»å•†åœˆ</span>\n                  <Badge variant={confirmationData.preferences.acceptNearby ? \"default\" : \"outline\"} className=\"text-xs\">\n                    {confirmationData.preferences.acceptNearby ? \"å·²å¼€å¯\" : \"æœªå¼€å¯\"}\n                  </Badge>\n                </div>\n              </div>\n\n              {/* è´¹ç”¨ä¿¡æ¯ */}\n              <div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">å·²æ”¯ä»˜æœåŠ¡è´¹</span>\n                  <span className=\"text-lg font-bold text-primary\">{confirmationData.serviceFee}</span>\n                </div>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  æ´»åŠ¨ç°åœºè´¹ç”¨AA Â· æˆå±€å‰å¯é€€æ¬¾\n                </p>\n              </div>\n            </div>\n          </Card>\n        </motion.div>\n\n        {/* è¿›åº¦ä¸ä¸‹ä¸€æ­¥ */}\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.4 }}\n        >\n          <Card className=\"p-6\" data-testid=\"card-next-steps\">\n            <h2 className=\"text-lg font-bold mb-4\">ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ</h2>\n            \n            <div className=\"space-y-4\">\n              {/* åŒ¹é…è¿›åº¦ */}\n              <div className=\"flex items-start gap-3\">\n                <div className=\"bg-primary/10 rounded-full p-2 mt-0.5\">\n                  <Users className=\"h-4 w-4 text-primary\" />\n                </div>\n                <div className=\"flex-1\">\n                  <h3 className=\"font-semibold text-sm mb-1\">AIæ­£åœ¨åŒ¹é…ä¸­</h3>\n                  <p className=\"text-xs text-muted-foreground\">\n                    ç³»ç»Ÿå°†æ ¹æ®ä½ çš„åå¥½æ™ºèƒ½åŒ¹é…4-6ä½åŒä¼´ï¼Œæ»¡4äººå³å¯æˆå±€\n                  </p>\n                </div>\n              </div>\n\n              {/* é€šçŸ¥æé†’ */}\n              <div className=\"flex items-start gap-3\">\n                <div className=\"bg-blue-500/10 rounded-full p-2 mt-0.5\">\n                  <Clock className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n                </div>\n                <div className=\"flex-1\">\n                  <h3 className=\"font-semibold text-sm mb-1\">ç­‰å¾…æˆå±€é€šçŸ¥</h3>\n                  <p className=\"text-xs text-muted-foreground\">\n                    æˆå±€åå°†é€šè¿‡å¾®ä¿¡é€šçŸ¥ï¼Œè¯·ä¿æŒæ‰‹æœºç•…é€š\n                  </p>\n                </div>\n              </div>\n\n              {/* æ´»åŠ¨è¯¦æƒ… */}\n              <div className=\"flex items-start gap-3\">\n                <div className=\"bg-purple-500/10 rounded-full p-2 mt-0.5\">\n                  <MapPin className=\"h-4 w-4 text-purple-600 dark:text-purple-400\" />\n                </div>\n                <div className=\"flex-1\">\n                  <h3 className=\"font-semibold text-sm mb-1\">æ´»åŠ¨å‰48å°æ—¶</h3>\n                  <p className=\"text-xs text-muted-foreground\">\n                    ç³»ç»Ÿå°†æ¨é€æ´»åŠ¨è¯¦æƒ…ï¼ˆåœ°ç‚¹ã€æˆå‘˜ä¿¡æ¯ã€èŠå¤©ç¾¤ï¼‰\n                  </p>\n                </div>\n              </div>\n            </div>\n          </Card>\n        </motion.div>\n\n        {/* æ“ä½œæŒ‰é’® */}\n        <div className=\"space-y-3\">\n          <Button\n            size=\"lg\"\n            className=\"w-full\"\n            onClick={handleViewProgress}\n            data-testid=\"button-view-progress\"\n          >\n            æŸ¥çœ‹åŒ¹é…è¿›åº¦\n            <ArrowRight className=\"h-4 w-4 ml-2\" />\n          </Button>\n          <Button\n            variant=\"outline\"\n            className=\"w-full\"\n            onClick={() => setLocation(\"/discover\")}\n            data-testid=\"button-back-discover\"\n          >\n            è¿”å›æ¢ç´¢é¡µ\n          </Button>\n        </div>\n\n        {/* åº•éƒ¨æç¤º */}\n        <div className=\"text-center text-xs text-muted-foreground space-y-1\">\n          <p>ğŸ’¡ ä½ å¯ä»¥åœ¨ã€Œæˆ‘çš„ã€é¡µé¢æŸ¥çœ‹æ‰€æœ‰æŠ¥åæ´»åŠ¨</p>\n          <p>ğŸ“± å»ºè®®å¼€å¯å¾®ä¿¡é€šçŸ¥ï¼Œç¬¬ä¸€æ—¶é—´æ¥æ”¶åŒ¹é…æ¶ˆæ¯</p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":10893},"client/src/lib/currency.ts":{"content":"export function getCurrencySymbol(city: \"é¦™æ¸¯\" | \"æ·±åœ³\" | string): string {\n  return city === \"é¦™æ¸¯\" ? \"HK$\" : \"Â¥\";\n}\n\nexport function formatPrice(price: string, city: \"é¦™æ¸¯\" | \"æ·±åœ³\" | string): string {\n  const symbol = getCurrencySymbol(city);\n  return `${symbol}${price}`;\n}\n","size_bytes":289},"client/src/components/IcebreakerTool.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Sparkles, RefreshCw } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\n\ninterface IcebreakerResponse {\n  question: string;\n  category: string;\n  categoryColor: string;\n}\n\nexport default function IcebreakerTool() {\n  const [refreshKey, setRefreshKey] = useState(0);\n\n  const { data, isLoading } = useQuery<IcebreakerResponse>({\n    queryKey: [\"/api/icebreakers/random\", refreshKey],\n    queryFn: async () => {\n      const res = await fetch(\"/api/icebreakers/random\", {\n        credentials: \"include\",\n      });\n      if (!res.ok) {\n        throw new Error(`${res.status}: ${res.statusText}`);\n      }\n      return await res.json();\n    },\n  });\n\n  const handleRefresh = () => {\n    setRefreshKey(prev => prev + 1);\n  };\n\n  const getCategoryVariant = (color: string): \"default\" | \"secondary\" | \"destructive\" | \"outline\" => {\n    // Map color to badge variants for visual distinction\n    if (color === \"red\" || color === \"orange\") return \"destructive\";\n    if (color === \"green\" || color === \"blue\" || color === \"purple\") return \"default\";\n    return \"secondary\";\n  };\n\n  return (\n    <Card className=\"border bg-gradient-to-br from-primary/5 to-transparent\">\n      <CardContent className=\"p-4 space-y-3\">\n        <div className=\"flex items-center justify-between gap-2\">\n          <div className=\"flex items-center gap-2\">\n            <Sparkles className=\"h-5 w-5 text-primary\" />\n            <h3 className=\"font-semibold\">ä»Šå¤©å¼€åœºèŠç‚¹å•¥ï¼Ÿ</h3>\n          </div>\n          {data?.category && (\n            <Badge \n              variant={getCategoryVariant(data.categoryColor)}\n              className=\"text-xs\"\n              data-testid=\"badge-question-category\"\n            >\n              {data.category}\n            </Badge>\n          )}\n        </div>\n\n        <div className=\"bg-background rounded-lg p-4 min-h-[60px] flex items-center justify-center\">\n          {isLoading ? (\n            <div className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</div>\n          ) : (\n            <p className=\"text-sm text-center\">{data?.question || \"ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–ç ´å†°é—®é¢˜\"}</p>\n          )}\n        </div>\n\n        <div className=\"flex gap-2\">\n          <Button \n            size=\"sm\" \n            className=\"flex-1\"\n            onClick={handleRefresh}\n            disabled={isLoading}\n            data-testid=\"button-draw-question\"\n          >\n            <Sparkles className=\"h-4 w-4 mr-1\" />\n            æŠ½ä¸€ä¸ªé—®é¢˜\n          </Button>\n          <Button \n            size=\"sm\" \n            variant=\"outline\"\n            onClick={handleRefresh}\n            disabled={isLoading}\n            data-testid=\"button-refresh-question\"\n          >\n            <RefreshCw className=\"h-4 w-4\" />\n          </Button>\n        </div>\n\n        <p className=\"text-xs text-muted-foreground text-center\">\n          è½»æ¾ç ´å†°ï¼Œè®©åˆæ¬¡è§é¢ä¸å†å°´å°¬\n        </p>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":3132},"client/src/pages/PersonalityTestResultPage.tsx":{"content":"import { useQuery } from '@tanstack/react-query';\nimport { useLocation } from 'wouter';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport PersonalityRadarChart from '@/components/PersonalityRadarChart';\nimport { Sparkles, Users, TrendingUp, AlertTriangle, Heart, Share2, Quote, Target } from 'lucide-react';\nimport type { RoleResult } from '@shared/schema';\nimport { queryClient } from '@/lib/queryClient';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { archetypeGradients, archetypeAvatars, archetypeEmojis } from '@/lib/archetypeAvatars';\nimport { archetypeConfig } from '@/lib/archetypes';\nimport { getTopCompatibleArchetypes, getCompatibilityCategory } from '@/lib/archetypeCompatibility';\nimport { useState, useEffect } from 'react';\n\nexport default function PersonalityTestResultPage() {\n  const [, setLocation] = useLocation();\n  const [showCountdown, setShowCountdown] = useState(true);\n  const [countdown, setCountdown] = useState(3);\n\n  const { data: result, isLoading } = useQuery<RoleResult>({\n    queryKey: ['/api/personality-test/results'],\n  });\n\n  const { data: stats } = useQuery<Record<string, number>>({\n    queryKey: ['/api/personality-test/stats'],\n  });\n\n  const { data: roleDistribution } = useQuery<Record<string, number>>({\n    queryKey: ['/api/personality/role-distribution'],\n  });\n\n  // Countdown timer effect\n  useEffect(() => {\n    if (!result || !showCountdown) return;\n\n    if (countdown > 0) {\n      const timer = setTimeout(() => {\n        setCountdown(countdown - 1);\n      }, 1000);\n      return () => clearTimeout(timer);\n    } else {\n      const timer = setTimeout(() => {\n        setShowCountdown(false);\n      }, 800);\n      return () => clearTimeout(timer);\n    }\n  }, [countdown, result, showCountdown]);\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <div className=\"text-center\">\n          <div className=\"text-lg text-muted-foreground\">æ­£åœ¨åŠ è½½æ‚¨çš„ç»“æœ...</div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!result) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <div className=\"text-center\">\n          <div className=\"text-lg text-muted-foreground\">æœªæ‰¾åˆ°æµ‹è¯•ç»“æœ</div>\n          <Button\n            data-testid=\"button-back-to-test\"\n            className=\"mt-4\"\n            onClick={() => setLocation('/personality-test')}\n          >\n            è¿”å›æµ‹è¯•\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  // Chemistry/matching compatibility data\n  const chemistryMap: Record<string, Array<{ role: string; percentage: number }>> = {\n    'ç«èŠ±å¡': [\n      { role: 'æ¢ç´¢è€…', percentage: 92 },\n      { role: 'æ•…äº‹å®¶', percentage: 88 },\n      { role: 'åè°ƒè€…', percentage: 85 },\n    ],\n    'æ¢ç´¢è€…': [\n      { role: 'ç«èŠ±å¡', percentage: 92 },\n      { role: 'æŒ‘æˆ˜è€…', percentage: 90 },\n      { role: 'è¿æ¥è€…', percentage: 86 },\n    ],\n    'æ•…äº‹å®¶': [\n      { role: 'è¿æ¥è€…', percentage: 94 },\n      { role: 'ç«èŠ±å¡', percentage: 88 },\n      { role: 'è‚¯å®šè€…', percentage: 87 },\n    ],\n    'æŒ‘æˆ˜è€…': [\n      { role: 'æ¢ç´¢è€…', percentage: 90 },\n      { role: 'åè°ƒè€…', percentage: 88 },\n      { role: 'æ°›å›´ç»„', percentage: 82 },\n    ],\n    'è¿æ¥è€…': [\n      { role: 'æ•…äº‹å®¶', percentage: 94 },\n      { role: 'æ¢ç´¢è€…', percentage: 86 },\n      { role: 'è‚¯å®šè€…', percentage: 89 },\n    ],\n    'åè°ƒè€…': [\n      { role: 'ç«èŠ±å¡', percentage: 85 },\n      { role: 'æŒ‘æˆ˜è€…', percentage: 88 },\n      { role: 'è¿æ¥è€…', percentage: 84 },\n    ],\n    'æ°›å›´ç»„': [\n      { role: 'è‚¯å®šè€…', percentage: 91 },\n      { role: 'æ•…äº‹å®¶', percentage: 87 },\n      { role: 'æŒ‘æˆ˜è€…', percentage: 82 },\n    ],\n    'è‚¯å®šè€…': [\n      { role: 'æ°›å›´ç»„', percentage: 91 },\n      { role: 'è¿æ¥è€…', percentage: 89 },\n      { role: 'æ•…äº‹å®¶', percentage: 87 },\n    ],\n  };\n\n  const myChemistry = chemistryMap[result.primaryRole] || [];\n  const myPercentage = stats?.[result.primaryRole] || 0;\n  const gradient = archetypeGradients[result.primaryRole] || 'from-purple-500 to-pink-500';\n  const secondaryGradient = result.secondaryRole ? archetypeGradients[result.secondaryRole] || 'from-blue-500 to-purple-500' : '';\n  const emoji = archetypeEmojis[result.primaryRole] || 'ğŸŒŸ';\n  const secondaryEmoji = result.secondaryRole ? archetypeEmojis[result.secondaryRole] || 'âœ¨' : '';\n  const primaryRoleConfig = archetypeConfig[result.primaryRole];\n  const nickname = primaryRoleConfig?.nickname || '';\n  const tagline = primaryRoleConfig?.tagline || '';\n  const epicDescription = primaryRoleConfig?.epicDescription || '';\n  const styleQuote = primaryRoleConfig?.styleQuote || '';\n  const coreContributions = primaryRoleConfig?.coreContributions || '';\n\n  const handleShare = async () => {\n    const shareData = {\n      title: `æˆ‘çš„ç¤¾äº¤è§’è‰²æ˜¯${result.primaryRole}ï¼`,\n      text: `åˆšå®Œæˆäº†JoyJoinæ€§æ ¼æµ‹è¯„ï¼Œå‘ç°æˆ‘æ˜¯${result.primaryRole}ï¼å¿«æ¥æµ‹æµ‹ä½ çš„ç¤¾äº¤ç‰¹è´¨å§~ âœ¨`,\n      url: window.location.origin + '/personality-test',\n    };\n\n    if (navigator.share) {\n      try {\n        await navigator.share(shareData);\n      } catch (err) {\n        console.log('Share cancelled or failed');\n      }\n    } else {\n      navigator.clipboard.writeText(`${shareData.text} ${shareData.url}`);\n      alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');\n    }\n  };\n\n  // Countdown Reveal Animation\n  const CountdownReveal = () => (\n    <motion.div\n      initial={{ opacity: 0 }}\n      animate={{ opacity: 1 }}\n      exit={{ opacity: 0 }}\n      className=\"fixed inset-0 bg-background z-50 flex items-center justify-center\"\n    >\n      <div className=\"text-center space-y-8\">\n        <AnimatePresence mode=\"wait\">\n          {countdown > 0 ? (\n            <motion.div\n              key={countdown}\n              initial={{ scale: 0.5, opacity: 0 }}\n              animate={{ scale: [0.5, 1.2, 1], opacity: 1 }}\n              exit={{ scale: 1.5, opacity: 0 }}\n              transition={{ duration: 0.8 }}\n              className=\"text-9xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent\"\n            >\n              {countdown}\n            </motion.div>\n          ) : (\n            <motion.div\n              key=\"reveal\"\n              initial={{ scale: 0, rotate: -180 }}\n              animate={{ scale: 1, rotate: 0 }}\n              className=\"space-y-6\"\n            >\n              <motion.div\n                animate={{\n                  scale: [1, 1.1, 1],\n                  rotate: [0, 5, -5, 0],\n                }}\n                transition={{\n                  duration: 0.6,\n                  ease: \"easeInOut\"\n                }}\n                className=\"text-9xl\"\n              >\n                {emoji}\n              </motion.div>\n              \n              {/* Particle explosion effect */}\n              <div className=\"relative\">\n                {[...Array(20)].map((_, i) => (\n                  <motion.div\n                    key={i}\n                    initial={{ \n                      x: 0, \n                      y: 0, \n                      scale: 1,\n                      opacity: 1 \n                    }}\n                    animate={{\n                      x: Math.cos((i * 360 / 20) * Math.PI / 180) * 150,\n                      y: Math.sin((i * 360 / 20) * Math.PI / 180) * 150,\n                      scale: 0,\n                      opacity: 0\n                    }}\n                    transition={{\n                      duration: 0.8,\n                      ease: \"easeOut\"\n                    }}\n                    className=\"absolute left-1/2 top-1/2 w-2 h-2 rounded-full bg-gradient-to-r from-purple-500 to-pink-500\"\n                    style={{\n                      transformOrigin: 'center'\n                    }}\n                  />\n                ))}\n              </div>\n              \n              <motion.h2\n                initial={{ y: 20, opacity: 0 }}\n                animate={{ y: 0, opacity: 1 }}\n                transition={{ delay: 0.3 }}\n                className={`text-4xl font-bold bg-gradient-to-r ${gradient} bg-clip-text text-transparent`}\n              >\n                {result.primaryRole}\n              </motion.h2>\n              \n              <motion.p\n                initial={{ y: 20, opacity: 0 }}\n                animate={{ y: 0, opacity: 1 }}\n                transition={{ delay: 0.5 }}\n                className=\"text-lg text-muted-foreground\"\n              >\n                {result.roleSubtype}\n              </motion.p>\n            </motion.div>\n          )}\n        </AnimatePresence>\n        \n        <motion.p\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          transition={{ delay: 0.5 }}\n          className=\"text-sm text-muted-foreground\"\n        >\n          {countdown > 0 ? 'å³å°†æ­æ™“ä½ çš„ç¤¾äº¤è§’è‰²...' : 'âœ¨ ä½ çš„ç‹¬ç‰¹ç¤¾äº¤DNAå·²è§£é”ï¼'}\n        </motion.p>\n      </div>\n    </motion.div>\n  );\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Countdown Animation */}\n      <AnimatePresence>\n        {showCountdown && result && <CountdownReveal />}\n      </AnimatePresence>\n      {/* Compact Hero Section - Mobile Optimized */}\n      <motion.div\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        transition={{ duration: 0.6 }}\n        className=\"relative min-h-[70vh] md:min-h-screen flex flex-col items-center justify-center px-4 py-6 md:p-6 overflow-hidden\"\n      >\n        {/* Gradient Background */}\n        <div className={`absolute inset-0 bg-gradient-to-br ${gradient} opacity-10`} />\n        \n        {/* Content */}\n        <div className=\"relative z-10 text-center space-y-4 md:space-y-8 max-w-2xl mx-auto\">\n          {/* Avatar/Emoji - Responsive Size */}\n          <motion.div\n            initial={{ scale: 0.5, opacity: 0 }}\n            animate={{ scale: 1, opacity: 1 }}\n            transition={{ delay: 0.2, type: \"spring\", stiffness: 200 }}\n            className=\"flex justify-center\"\n          >\n            <div className={`w-32 h-32 md:w-48 md:h-48 rounded-full bg-gradient-to-br ${gradient} flex items-center justify-center shadow-2xl`}>\n              <span className=\"text-6xl md:text-9xl\" data-testid=\"text-role-avatar\">{emoji}</span>\n            </div>\n          </motion.div>\n\n          {/* Role Name and Description */}\n          <motion.div\n            initial={{ y: 20, opacity: 0 }}\n            animate={{ y: 0, opacity: 1 }}\n            transition={{ delay: 0.4 }}\n            className=\"space-y-3 md:space-y-4 text-center\"\n          >\n            <div className=\"space-y-2 md:space-y-3\">\n              <h1 className=\"text-4xl md:text-5xl font-bold text-center\" data-testid=\"text-primary-role\">\n                {result.primaryRole}\n              </h1>\n              {nickname && (\n                <p className=\"text-xl md:text-2xl font-medium text-primary text-center\" data-testid=\"text-nickname\">\n                  {nickname}\n                </p>\n              )}\n              {tagline && (\n                <p className=\"text-base md:text-lg text-muted-foreground text-center italic\" data-testid=\"text-tagline\">\n                  {tagline}\n                </p>\n              )}\n            </div>\n          </motion.div>\n        </div>\n      </motion.div>\n\n      {/* Scrollable Content Section */}\n      <div className=\"max-w-2xl mx-auto p-4 pb-8 space-y-4\">\n        {/* Role Details Card - Epic Description & Style Quote */}\n        {(epicDescription || styleQuote || coreContributions) && (\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            whileInView={{ opacity: 1, y: 0 }}\n            viewport={{ once: true }}\n            transition={{ duration: 0.5 }}\n          >\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Sparkles className=\"w-5 h-5 text-primary\" />\n                  è§’è‰²æ·±åº¦è§£è¯»\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {/* Epic Description */}\n                {epicDescription && (\n                  <div className=\"space-y-2\">\n                    <p className=\"text-sm leading-relaxed text-foreground/90\" data-testid=\"text-epic-description\">\n                      {epicDescription}\n                    </p>\n                  </div>\n                )}\n\n                {/* Style Quote */}\n                {styleQuote && (\n                  <div className={`relative bg-gradient-to-br ${gradient} bg-opacity-10 rounded-lg p-4 border-l-4 border-primary/50`}>\n                    <Quote className=\"w-6 h-6 text-primary/40 absolute top-2 left-2\" />\n                    <p className=\"text-sm font-medium italic text-foreground pl-8\" data-testid=\"text-style-quote\">\n                      {styleQuote}\n                    </p>\n                  </div>\n                )}\n\n                {/* Core Contributions */}\n                {coreContributions && (\n                  <div className=\"flex items-start gap-3 bg-muted/30 rounded-lg p-3\">\n                    <Target className=\"w-5 h-5 text-primary mt-0.5 flex-shrink-0\" />\n                    <div className=\"space-y-1\">\n                      <p className=\"text-xs font-semibold text-muted-foreground\">æ ¸å¿ƒè´¡çŒ®</p>\n                      <p className=\"text-sm font-medium text-foreground\" data-testid=\"text-core-contributions\">\n                        {coreContributions}\n                      </p>\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </motion.div>\n        )}\n\n        {/* Radar Chart Card */}\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          whileInView={{ opacity: 1, y: 0 }}\n          viewport={{ once: true }}\n          transition={{ duration: 0.5 }}\n        >\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Sparkles className=\"w-5 h-5 text-primary\" />\n                å…­ç»´ç¤¾äº¤ç‰¹è´¨\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"bg-muted/30 rounded-lg p-4\">\n                <PersonalityRadarChart\n                  affinityScore={result.affinityScore}\n                  opennessScore={result.opennessScore}\n                  conscientiousnessScore={result.conscientiousnessScore}\n                  emotionalStabilityScore={result.emotionalStabilityScore}\n                  extraversionScore={result.extraversionScore}\n                  positivityScore={result.positivityScore}\n                />\n              </div>\n\n              {/* Strengths */}\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-2 text-sm font-semibold\">\n                  <TrendingUp className=\"w-4 h-4 text-primary\" />\n                  <span>ä½ çš„ä¼˜åŠ¿</span>\n                </div>\n                <p className=\"text-sm text-muted-foreground leading-relaxed\" data-testid=\"text-strengths\">\n                  {result.strengths}\n                </p>\n              </div>\n\n              {/* Challenges */}\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-2 text-sm font-semibold\">\n                  <AlertTriangle className=\"w-4 h-4 text-orange-500\" />\n                  <span>å¯èƒ½çš„æŒ‘æˆ˜</span>\n                </div>\n                <p className=\"text-sm text-muted-foreground leading-relaxed\" data-testid=\"text-challenges\">\n                  {result.challenges}\n                </p>\n              </div>\n\n              {/* Ideal Friend Types */}\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-2 text-sm font-semibold\">\n                  <Users className=\"w-4 h-4 text-primary\" />\n                  <span>ç†æƒ³æœ‹å‹ç±»å‹</span>\n                </div>\n                <div className=\"flex flex-wrap gap-2\">\n                  {result.idealFriendTypes?.map((type: string) => (\n                    <Badge key={type} variant=\"outline\" data-testid={`badge-ideal-friend-${type}`}>\n                      {archetypeEmojis[type] || 'ğŸ‘¥'} {type}\n                    </Badge>\n                  ))}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </motion.div>\n\n        {/* Social Comparison Card */}\n        {stats && myPercentage > 0 && (\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            whileInView={{ opacity: 1, y: 0 }}\n            viewport={{ once: true }}\n            transition={{ duration: 0.5, delay: 0.1 }}\n          >\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2 text-lg\">\n                  <Users className=\"w-5 h-5 text-primary\" />\n                  ä½ åœ¨äººç¾¤ä¸­çš„ä½ç½®\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                <div className=\"text-center py-4\">\n                  <div className=\"text-4xl font-bold text-primary mb-2\">\n                    {myPercentage}%\n                  </div>\n                  <p className=\"text-sm text-muted-foreground\">\n                    åœ¨æ¸¯æ·±ä½¿ç”¨JoyJoinçš„ç”¨æˆ·ä¸­ï¼Œ<span className=\"font-semibold text-foreground\">{myPercentage}%</span> çš„äººä¹Ÿæ˜¯<span className=\"font-semibold text-foreground\">{result.primaryRole}</span>\n                  </p>\n                </div>\n                <div className=\"space-y-2 pt-2 border-t\">\n                  <p className=\"text-xs text-muted-foreground text-center\">\n                    ç¤¾ç¾¤åˆ†å¸ƒæ¦‚è§ˆ\n                  </p>\n                  <div className=\"grid grid-cols-4 gap-2\">\n                    {Object.entries(stats)\n                      .sort((a, b) => b[1] - a[1])\n                      .slice(0, 4)\n                      .map(([role, percentage]) => (\n                        <div key={role} className=\"text-center p-2 rounded-lg bg-muted/30\">\n                          <div className=\"text-lg mb-1\">{archetypeEmojis[role]}</div>\n                          <div className=\"text-xs font-semibold\">{percentage}%</div>\n                          <div className=\"text-[10px] text-muted-foreground truncate\">{role}</div>\n                        </div>\n                      ))}\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </motion.div>\n        )}\n\n        {/* Chemistry/Matching Prediction Card */}\n        {myChemistry.length > 0 && (\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            whileInView={{ opacity: 1, y: 0 }}\n            viewport={{ once: true }}\n            transition={{ duration: 0.5, delay: 0.2 }}\n          >\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2 text-lg\">\n                  <Heart className=\"w-5 h-5 text-red-500\" />\n                  æ´»åŠ¨åŒ¹é…é¢„æµ‹\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <p className=\"text-sm text-muted-foreground\">\n                  ä½œä¸º<span className=\"font-semibold text-foreground\">{result.primaryRole}</span>ï¼Œä½ åœ¨æ´»åŠ¨ä¸­ä¸è¿™äº›è§’è‰²æœ€æœ‰åŒ–å­¦ååº”ï¼š\n                </p>\n                <div className=\"space-y-3\">\n                  {myChemistry.map((match, index) => (\n                    <motion.div\n                      key={match.role}\n                      initial={{ opacity: 0, x: -20 }}\n                      whileInView={{ opacity: 1, x: 0 }}\n                      viewport={{ once: true }}\n                      transition={{ delay: index * 0.1 }}\n                      className=\"flex items-center gap-3 p-3 rounded-lg bg-muted/30\"\n                    >\n                      <div className=\"text-2xl\">{archetypeEmojis[match.role]}</div>\n                      <div className=\"flex-1\">\n                        <div className=\"font-semibold text-sm\">{match.role}</div>\n                        <div className=\"w-full bg-muted rounded-full h-2 mt-1\">\n                          <motion.div\n                            initial={{ width: 0 }}\n                            whileInView={{ width: `${match.percentage}%` }}\n                            viewport={{ once: true }}\n                            transition={{ duration: 1, delay: index * 0.1 }}\n                            className=\"bg-primary h-2 rounded-full\"\n                          />\n                        </div>\n                      </div>\n                      <div className=\"text-lg font-bold text-primary\">\n                        {match.percentage}%\n                      </div>\n                    </motion.div>\n                  ))}\n                </div>\n                <div className=\"pt-3 border-t\">\n                  <p className=\"text-xs text-muted-foreground text-center\">\n                    ğŸ’¡ æˆ‘ä»¬çš„AIç®—æ³•ä¼šä¼˜å…ˆä¸ºä½ åŒ¹é…è¿™äº›åŒ–å­¦ååº”é«˜çš„è§’è‰²ï¼Œè®©æ¯æ¬¡èšä¼šéƒ½èƒ½æ“¦å‡ºç«èŠ±ï¼\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          </motion.div>\n        )}\n\n        {/* Info Card */}\n        <motion.div\n          initial={{ opacity: 0 }}\n          whileInView={{ opacity: 1 }}\n          viewport={{ once: true }}\n          transition={{ duration: 0.5, delay: 0.3 }}\n        >\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-start gap-3\">\n                <Sparkles className=\"w-5 h-5 text-primary mt-0.5\" />\n                <div className=\"flex-1 space-y-2\">\n                  <p className=\"text-sm font-medium\">æ¥ä¸‹æ¥åšä»€ä¹ˆï¼Ÿ</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    ä½ çš„è§’è‰²ä¿¡æ¯å°†å¸®åŠ©æˆ‘ä»¬ä¸ºä½ åŒ¹é…æ›´åˆé€‚çš„èšä¼šå’Œæœ‹å‹ã€‚ç°åœ¨å¯ä»¥ç»§ç»­å®Œå–„ä½ çš„ä¸ªäººèµ„æ–™ï¼Œæˆ–è€…ç›´æ¥å¼€å§‹æ¢ç´¢æ´»åŠ¨ï¼\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </motion.div>\n\n        {/* Action Buttons */}\n        <div className=\"space-y-3 pt-2\">\n          <div className=\"flex gap-3\">\n            <Button\n              data-testid=\"button-share\"\n              variant=\"outline\"\n              className=\"flex-1\"\n              onClick={handleShare}\n            >\n              <Share2 className=\"w-4 h-4 mr-2\" />\n              åˆ†äº«ç»“æœ\n            </Button>\n            <Button\n              data-testid=\"button-continue\"\n              className=\"flex-1\"\n              onClick={async () => {\n                await queryClient.invalidateQueries({ queryKey: ['/api/auth/user'] });\n                setLocation('/');\n              }}\n            >\n              å¼€å§‹æ¢ç´¢æ´»åŠ¨\n            </Button>\n          </div>\n          <Button\n            data-testid=\"button-retake-test\"\n            variant=\"outline\"\n            className=\"w-full\"\n            onClick={() => setLocation('/personality-test')}\n          >\n            <Sparkles className=\"w-4 h-4 mr-2\" />\n            é‡æ–°æµ‹è¯•\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":23469},"client/src/pages/BlindBoxEventDetailPage.tsx":{"content":"import { useParams, useLocation } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ArrowLeft, Clock, MapPin, DollarSign, Users, Phone, Navigation, AlertCircle } from \"lucide-react\";\nimport type { BlindBoxEvent } from \"@shared/schema\";\nimport { getCurrencySymbol } from \"@/lib/currency\";\nimport { calculateAge } from \"@shared/utils\";\nimport IcebreakerTool from \"@/components/IcebreakerTool\";\nimport PostMatchEventCard from \"@/components/PostMatchEventCard\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useWebSocket } from \"@/hooks/useWebSocket\";\nimport { invalidateCacheForEvent } from \"@/lib/cacheInvalidation\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function BlindBoxEventDetailPage() {\n  const { eventId } = useParams();\n  const [, setLocation] = useLocation();\n  const { user } = useAuth();\n  const { subscribe } = useWebSocket();\n  const { toast } = useToast();\n\n  const { data: event, isLoading } = useQuery<BlindBoxEvent>({\n    queryKey: [\"/api/blind-box-events\", eventId],\n  });\n\n  // WebSocketå®æ—¶æ›´æ–°è®¢é˜…ï¼ˆä»…è®¢é˜…å½“å‰æ´»åŠ¨ï¼‰\n  useEffect(() => {\n    if (!eventId) return;\n\n    const unsubscribeMatched = subscribe('EVENT_MATCHED', async (message) => {\n      if (message.eventId !== eventId) return;\n      \n      console.log('[Detail] Event matched:', message);\n      await invalidateCacheForEvent(message);\n      \n      const matchData = message.data as any;\n      toast({\n        title: \"åŒ¹é…æˆåŠŸï¼\",\n        description: `æ´»åŠ¨å·²æˆåŠŸåŒ¹é…ï¼Œåœ°ç‚¹ï¼š${matchData.restaurantName || 'æœªçŸ¥'}`,\n      });\n    });\n\n    const unsubscribeStatus = subscribe('EVENT_STATUS_CHANGED', async (message) => {\n      if (message.eventId !== eventId) return;\n      \n      console.log('[Detail] Event status changed:', message);\n      await invalidateCacheForEvent(message);\n      \n      const statusData = message.data as any;\n      if (statusData.newStatus === 'completed') {\n        toast({\n          title: \"æ´»åŠ¨å·²å®Œæˆ\",\n          description: \"æœŸå¾…ä½ çš„åé¦ˆï¼\",\n        });\n      } else if (statusData.newStatus === 'canceled') {\n        toast({\n          title: \"æ´»åŠ¨å·²å–æ¶ˆ\",\n          description: statusData.reason || \"æ´»åŠ¨å·²è¢«å–æ¶ˆ\",\n          variant: \"destructive\",\n        });\n      }\n    });\n\n    const unsubscribeUserJoined = subscribe('USER_JOINED', async (message) => {\n      if (message.eventId !== eventId) return;\n      \n      console.log('[Detail] User joined:', message);\n      await invalidateCacheForEvent(message);\n    });\n\n    return () => {\n      unsubscribeMatched();\n      unsubscribeStatus();\n      unsubscribeUserJoined();\n    };\n  }, [eventId, subscribe, toast]);\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <div className=\"flex items-center justify-center py-12\">\n          <div className=\"text-center space-y-4\">\n            <div className=\"h-8 w-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n            <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!event) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <div className=\"text-center py-12\">\n          <p className=\"text-muted-foreground\">æ´»åŠ¨ä¸å­˜åœ¨</p>\n        </div>\n      </div>\n    );\n  }\n\n  const currencySymbol = getCurrencySymbol(event.city as \"é¦™æ¸¯\" | \"æ·±åœ³\");\n\n  const formatDateTime = (dateTime: Date) => {\n    const date = new Date(dateTime);\n    const month = date.getMonth() + 1;\n    const day = date.getDate();\n    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];\n    const weekday = weekdays[date.getDay()];\n    const hours = date.getHours().toString().padStart(2, '0');\n    const minutes = date.getMinutes().toString().padStart(2, '0');\n    return `${month}æœˆ${day}æ—¥ ${weekday} ${hours}:${minutes}`;\n  };\n\n  const getCountdown = (dateTime: Date) => {\n    const now = new Date();\n    const eventDate = new Date(dateTime);\n    const diff = eventDate.getTime() - now.getTime();\n    \n    if (diff <= 0) return \"æ´»åŠ¨è¿›è¡Œä¸­\";\n    \n    const days = Math.floor(diff / (1000 * 60 * 60 * 24));\n    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n    \n    if (days > 0) {\n      return `è¿˜å‰© ${days}å¤© ${hours}å°æ—¶`;\n    } else {\n      return `è¿˜å‰© ${hours}å°æ—¶`;\n    }\n  };\n\n  const getParticipantInfo = () => {\n    if (event.isGirlsNight) {\n      return `${event.totalParticipants}äºº Girls Night`;\n    }\n    if (event.maleCount && event.femaleCount) {\n      return `${event.totalParticipants}äººï¼ˆ${event.maleCount}ç”·${event.femaleCount}å¥³ï¼‰`;\n    }\n    return `${event.totalParticipants}äºº`;\n  };\n\n  const handleNavigation = () => {\n    if (event.restaurantLat && event.restaurantLng) {\n      const restaurantName = encodeURIComponent(event.restaurantName || 'ç›®çš„åœ°');\n      \n      // æ·±åœ³ä½¿ç”¨é«˜å¾·åœ°å›¾ï¼Œé¦™æ¸¯ä½¿ç”¨Google Maps\n      if (event.city === 'æ·±åœ³') {\n        window.open(`https://uri.amap.com/navigation?to=${event.restaurantLng},${event.restaurantLat},${restaurantName}&mode=car&coordinate=gaode`, '_blank');\n      } else {\n        window.open(`https://www.google.com/maps/dir/?api=1&destination=${event.restaurantLat},${event.restaurantLng}`, '_blank');\n      }\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <div className=\"sticky top-0 z-40 bg-background/95 backdrop-blur-sm border-b\">\n        <div className=\"flex items-center h-14 px-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            onClick={() => setLocation(\"/events\")}\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"ml-2 font-semibold\">æ´»åŠ¨è¯¦æƒ…</h1>\n        </div>\n      </div>\n\n      <div className=\"px-4 py-4 space-y-4\">\n        {/* é¡¶éƒ¨æ‘˜è¦ */}\n        <Card>\n          <CardContent className=\"p-4 space-y-3\">\n            <div className=\"space-y-1\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <h2 className=\"text-xl font-bold flex-1\">{event.eventType}</h2>\n                {event.isGirlsNight && (\n                  <Badge className=\"bg-pink-500 hover:bg-pink-600\">\n                    ğŸ‘­ Girls Night\n                  </Badge>\n                )}\n              </div>\n              <p className=\"text-sm text-muted-foreground\">{formatDateTime(event.dateTime)}</p>\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Clock className=\"h-4 w-4 text-primary\" />\n                <span className=\"font-medium text-primary\">{getCountdown(event.dateTime)}</span>\n              </div>\n            </div>\n\n            {(event.status === \"matched\" || event.status === \"completed\") && event.totalParticipants && (\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Users className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"font-medium\">{getParticipantInfo()}</span>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* åœ°ç‚¹ä¿¡æ¯ (ä»…å·²åŒ¹é…æˆ–å·²å®Œæˆæ˜¾ç¤º) */}\n        {(event.status === \"matched\" || event.status === \"completed\") && event.restaurantName ? (\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base\">åœ°ç‚¹ä¿¡æ¯</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-2\">\n                  <MapPin className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium\">{event.restaurantName}</p>\n                    <p className=\"text-sm text-muted-foreground\">{event.restaurantAddress}</p>\n                    <p className=\"text-xs text-muted-foreground\">{event.city}â€¢{event.district}</p>\n                  </div>\n                </div>\n              </div>\n\n              <Button \n                variant=\"outline\" \n                className=\"w-full\"\n                onClick={handleNavigation}\n                data-testid=\"button-navigate\"\n              >\n                <Navigation className=\"h-4 w-4 mr-2\" />\n                åˆ°è¿™å»\n              </Button>\n            </CardContent>\n          </Card>\n        ) : null}\n\n        {/* é¢„ç®—ä¸èœå¼ */}\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-base\">é¢„ç®—ä¸èœå¼</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"flex items-center gap-2 text-sm\">\n              <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"font-medium\">{currencySymbol}{event.budgetTier}ï¼ˆäººå‡AAï¼‰</span>\n            </div>\n\n            {event.cuisineTags && event.cuisineTags.length > 0 && (\n              <div>\n                <p className=\"text-sm text-muted-foreground mb-2\">èœå¼/é…’ç±»</p>\n                <div className=\"flex flex-wrap gap-1.5\">\n                  {event.cuisineTags.map((tag, index) => (\n                    <Badge key={index} variant=\"secondary\" className=\"text-xs\">\n                      {tag}\n                    </Badge>\n                  ))}\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Post-Match Event Card: Attendee Insights & Match Explanation */}\n        {(event.status === \"matched\" || event.status === \"completed\") && event.matchedAttendees && Array.isArray(event.matchedAttendees) && (\n          <PostMatchEventCard \n            matchedAttendees={event.matchedAttendees as Array<{\n              userId: string;\n              displayName: string;\n              archetype?: string;\n              topInterests?: string[];\n              industry?: string;\n              ageVisible?: boolean;\n              industryVisible?: boolean;\n            }>}\n            matchExplanation={event.matchExplanation || undefined}\n            userInterests={(user?.interestsRankedTop3 as string[] | undefined) || [\"film_entertainment\", \"travel_exploration\"]}\n            userEducationLevel={user?.educationLevel || \"Master's\"}\n            userIndustry={user?.industry || \"ç§‘æŠ€\"}\n            userAge={user?.birthdate ? calculateAge(user.birthdate) : undefined}\n            userGender={user?.gender || undefined}\n            userRelationshipStatus={user?.relationshipStatus || \"Single\"}\n            userChildren={user?.children || undefined}\n            userStudyLocale={user?.studyLocale || \"Overseas\"}\n            userOverseasRegions={user?.overseasRegions as string[] | undefined}\n            userSeniority={user?.seniority || \"Mid\"}\n            userFieldOfStudy={user?.fieldOfStudy || undefined}\n            userLanguages={user?.languagesComfort as string[] | undefined}\n            userHometownCountry={user?.hometownCountry || undefined}\n            userHometownRegionCity={user?.hometownRegionCity || undefined}\n            userHometownAffinityOptin={user?.hometownAffinityOptin ?? undefined}\n          />\n        )}\n\n        {/* ç ´å†°å·¥å…· (ä»…å·²åŒ¹é…æˆ–å·²å®Œæˆæ˜¾ç¤º) */}\n        {(event.status === \"matched\" || event.status === \"completed\") && (\n          <IcebreakerTool />\n        )}\n\n        {/* è§„åˆ™ä¸åˆ°åœºæŒ‡å— */}\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-base\">è§„åˆ™ä¸åˆ°åœºæŒ‡å—</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-2 text-sm\">\n            <div className=\"flex items-start gap-2\">\n              <AlertCircle className=\"h-4 w-4 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0\" />\n              <p>è¯·æå‰10åˆ†é’Ÿåˆ°åœº</p>\n            </div>\n            <div className=\"flex items-start gap-2\">\n              <AlertCircle className=\"h-4 w-4 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0\" />\n              <p>å¼€å±€å‰24å°æ—¶å†…ä¸å¯é€€</p>\n            </div>\n            <div className=\"flex items-start gap-2\">\n              <AlertCircle className=\"h-4 w-4 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0\" />\n              <p>è¿Ÿåˆ°/ç¼ºå¸­å°†å½±å“ä¿¡ç”¨åˆ†</p>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* å¸®åŠ©ä¸æ”¯æŒ */}\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-base\">å¸®åŠ©ä¸æ”¯æŒ</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-contact-support\">\n              <Phone className=\"h-4 w-4 mr-2\" />\n              è”ç³»æ”¯æŒ\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":13131},"client/src/components/SocialRoleCard.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Sparkles } from \"lucide-react\";\nimport { archetypeConfig } from \"@/lib/archetypes\";\n\ninterface SocialRoleCardProps {\n  primaryRole: string;\n  secondaryRole?: string;\n  primaryRoleScore: number;\n  secondaryRoleScore?: number;\n}\n\nconst roleConfig: Record<string, { emoji: string; color: string; bgGradient: string }> = {\n  'å¼€å¿ƒæŸ¯åŸº': {\n    emoji: 'ğŸ•',\n    color: 'from-yellow-400 to-orange-500',\n    bgGradient: 'bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-yellow-950/30 dark:to-orange-950/30'\n  },\n  'å¤ªé˜³é¸¡': {\n    emoji: 'ğŸ“',\n    color: 'from-amber-400 to-yellow-500',\n    bgGradient: 'bg-gradient-to-br from-amber-50 to-yellow-50 dark:from-amber-950/30 dark:to-yellow-950/30'\n  },\n  'å¤¸å¤¸è±š': {\n    emoji: 'ğŸ¬',\n    color: 'from-cyan-400 to-blue-500',\n    bgGradient: 'bg-gradient-to-br from-cyan-50 to-blue-50 dark:from-cyan-950/30 dark:to-blue-950/30'\n  },\n  'æœºæ™ºç‹': {\n    emoji: 'ğŸ¦Š',\n    color: 'from-orange-400 to-red-500',\n    bgGradient: 'bg-gradient-to-br from-orange-50 to-red-50 dark:from-orange-950/30 dark:to-red-950/30'\n  },\n  'æ·¡å®šæµ·è±š': {\n    emoji: 'ğŸ¬',\n    color: 'from-blue-400 to-indigo-500',\n    bgGradient: 'bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/30 dark:to-indigo-950/30'\n  },\n  'ç»‡ç½‘è››': {\n    emoji: 'ğŸ•·ï¸',\n    color: 'from-purple-400 to-pink-500',\n    bgGradient: 'bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-950/30 dark:to-pink-950/30'\n  },\n  'æš–å¿ƒç†Š': {\n    emoji: 'ğŸ»',\n    color: 'from-rose-400 to-pink-500',\n    bgGradient: 'bg-gradient-to-br from-rose-50 to-pink-50 dark:from-rose-950/30 dark:to-pink-950/30'\n  },\n  'çµæ„Ÿç« é±¼': {\n    emoji: 'ğŸ™',\n    color: 'from-violet-400 to-purple-500',\n    bgGradient: 'bg-gradient-to-br from-violet-50 to-purple-50 dark:from-violet-950/30 dark:to-purple-950/30'\n  },\n  'æ²‰æ€çŒ«å¤´é¹°': {\n    emoji: 'ğŸ¦‰',\n    color: 'from-slate-400 to-gray-500',\n    bgGradient: 'bg-gradient-to-br from-slate-50 to-gray-50 dark:from-slate-950/30 dark:to-gray-950/30'\n  },\n  'å®šå¿ƒå¤§è±¡': {\n    emoji: 'ğŸ˜',\n    color: 'from-gray-400 to-slate-500',\n    bgGradient: 'bg-gradient-to-br from-gray-50 to-slate-50 dark:from-gray-950/30 dark:to-slate-950/30'\n  },\n  'ç¨³å¦‚é¾Ÿ': {\n    emoji: 'ğŸ¢',\n    color: 'from-green-400 to-emerald-500',\n    bgGradient: 'bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-950/30 dark:to-emerald-950/30'\n  },\n  'éšèº«çŒ«': {\n    emoji: 'ğŸ±',\n    color: 'from-indigo-400 to-purple-500',\n    bgGradient: 'bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-950/30 dark:to-purple-950/30'\n  },\n};\n\nexport default function SocialRoleCard({ \n  primaryRole, \n  secondaryRole,\n  primaryRoleScore,\n  secondaryRoleScore\n}: SocialRoleCardProps) {\n  const primaryConfig = roleConfig[primaryRole] || roleConfig['æš–å¿ƒç†Š'];\n  const secondaryConfig = secondaryRole ? roleConfig[secondaryRole] : null;\n  const primaryArchetype = archetypeConfig[primaryRole];\n  const nickname = primaryArchetype?.nickname || '';\n  const tagline = primaryArchetype?.tagline || '';\n\n  return (\n    <Card className={`border-2 shadow-lg overflow-hidden ${primaryConfig.bgGradient}`}>\n      <CardContent className=\"p-6\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <div className=\"flex items-center gap-2\">\n            <Sparkles className=\"h-4 w-4 text-primary\" />\n            <h3 className=\"font-semibold text-sm\">æˆ‘çš„ç¤¾äº¤è§’è‰²</h3>\n          </div>\n          <Badge variant=\"secondary\" className=\"text-xs\">\n            AI åŒ¹é…\n          </Badge>\n        </div>\n\n        {/* Primary Role Avatar & Info */}\n        <div className=\"flex items-start gap-4 mb-4\">\n          {/* Avatar */}\n          <div className=\"relative flex-shrink-0\">\n            <div className={`w-24 h-24 rounded-2xl bg-gradient-to-br ${primaryConfig.color} flex items-center justify-center shadow-lg transform hover:scale-105 transition-transform duration-300`}>\n              <span className=\"text-5xl\" data-testid=\"text-primary-role-emoji\">\n                {primaryConfig.emoji}\n              </span>\n            </div>\n            {/* Score Badge */}\n            <div className=\"absolute -bottom-2 -right-2 bg-background border-2 border-primary rounded-full px-2 py-0.5 shadow-md\">\n              <span className=\"text-xs font-bold text-primary\">{primaryRoleScore}åˆ†</span>\n            </div>\n          </div>\n\n          {/* Role Info */}\n          <div className=\"flex-1 space-y-1.5\">\n            <div>\n              <h2 className=\"text-2xl font-bold mb-1\" data-testid=\"text-primary-role-name\">\n                {primaryRole}\n              </h2>\n              {nickname && (\n                <p className=\"text-base font-medium text-primary mb-1\" data-testid=\"text-nickname\">\n                  {nickname}\n                </p>\n              )}\n              {tagline && (\n                <p className=\"text-sm text-muted-foreground leading-relaxed italic\" data-testid=\"text-tagline\">\n                  {tagline}\n                </p>\n              )}\n            </div>\n          </div>\n        </div>\n\n        {/* Fun Fact */}\n        <div className={`mt-4 p-3 rounded-lg bg-gradient-to-r ${primaryConfig.color} bg-opacity-10`}>\n          <p className=\"text-xs text-center font-medium\">\n            ğŸ’« {primaryRole}ä»¬æœ€æ“…é•¿åœ¨å°èšä¸­å¸¦æ¥ç‹¬ç‰¹çš„ç¤¾äº¤ä»·å€¼ï¼\n          </p>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":5555},"client/src/pages/RegistrationPage.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { registerUserSchema, type RegisterUser } from \"@shared/schema\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ChevronLeft, ChevronRight, Info } from \"lucide-react\";\nimport { intentOptions } from \"@/lib/userFieldMappings\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { DatePicker } from \"@/components/ui/date-picker\";\n\nexport default function RegistrationPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [step, setStep] = useState(1);\n  const totalSteps = 6;\n\n  const form = useForm<RegisterUser>({\n    resolver: zodResolver(registerUserSchema),\n    defaultValues: {\n      displayName: \"\",\n      birthdate: \"\",\n      ageVisibility: \"hide_all\",\n      gender: undefined,\n      pronouns: undefined,\n      relationshipStatus: undefined,\n      children: undefined,\n      educationLevel: undefined,\n      studyLocale: undefined,\n      overseasRegions: [],\n      fieldOfStudy: \"\",\n      educationVisibility: \"hide_all\",\n      industry: \"\",\n      roleTitleShort: \"\",\n      seniority: undefined,\n      workVisibility: \"show_industry_only\",\n      intent: [],\n      hometownCountry: \"\",\n      hometownRegionCity: \"\",\n      hometownAffinityOptin: false,\n      languagesComfort: [],\n      accessibilityNeeds: \"\",\n      safetyNoteHost: \"\",\n      wechatId: \"\",\n    },\n  });\n\n  const registerMutation = useMutation({\n    mutationFn: async (data: RegisterUser) => {\n      console.log(\"[Frontend] Sending registration data:\", data);\n      return await apiRequest(\"POST\", \"/api/user/register\", data);\n    },\n    onSuccess: async () => {\n      await queryClient.invalidateQueries({ queryKey: ['/api/auth/user'] });\n      \n      toast({\n        title: \"æ³¨å†ŒæˆåŠŸï¼\",\n        description: \"ç°åœ¨è®©æˆ‘ä»¬äº†è§£ä½ çš„å…´è¶£å’Œè¯é¢˜åå¥½\",\n      });\n      \n      setLocation(\"/interests-topics\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"æ³¨å†Œå¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleNext = async () => {\n    const fieldsToValidate = getFieldsForStep(step);\n    const isValid = await form.trigger(fieldsToValidate as any);\n    \n    if (isValid) {\n      if (step < totalSteps) {\n        setStep(step + 1);\n      } else {\n        form.handleSubmit((data) => registerMutation.mutate(data))();\n      }\n    }\n  };\n\n  const handleBack = () => {\n    if (step > 1) {\n      setStep(step - 1);\n    }\n  };\n\n  const getFieldsForStep = (currentStep: number) => {\n    switch (currentStep) {\n      case 1: // Identity\n        return [\"displayName\", \"birthdate\", \"gender\"];\n      case 2: // Background & Education\n        return [\"relationshipStatus\", \"educationLevel\"];\n      case 3: // Work\n        return [\"industry\", \"seniority\", \"workVisibility\"];\n      case 4: // Intent\n        return [\"intent\"];\n      case 5: // Culture & Language\n        return [\"languagesComfort\"];\n      case 6: // Access & Safety (all optional)\n        return [];\n      default:\n        return [];\n    }\n  };\n\n  const progress = (step / totalSteps) * 100;\n\n  // Language options\n  const languageOptions = [\n    \"æ™®é€šè¯\",\n    \"ç²¤è¯­\",\n    \"è‹±è¯­\",\n    \"æ—¥è¯­\",\n    \"éŸ©è¯­\",\n    \"æ³•è¯­\",\n    \"å¾·è¯­\",\n    \"è¥¿ç­ç‰™è¯­\",\n  ];\n\n  // Overseas regions - Popular study destinations\n  const overseasRegionOptions = [\n    \"ç¾å›½\",\n    \"è‹±å›½\",\n    \"åŠ æ‹¿å¤§\",\n    \"æ¾³å¤§åˆ©äºš\",\n    \"æ–°è¥¿å…°\",\n    \"æ–°åŠ å¡\",\n    \"é¦™æ¸¯\",\n    \"æ—¥æœ¬\",\n    \"éŸ©å›½\",\n    \"å¾·å›½\",\n    \"æ³•å›½\",\n    \"å…¶ä»–\",\n  ];\n\n  const industryOptions = [\n    \"å¤§å‚\",\n    \"é‡‘è\",\n    \"ç§‘æŠ€åˆåˆ›\",\n    \"AI/ML\",\n    \"è·¨å¢ƒç”µå•†\",\n    \"æŠ•èµ„\",\n    \"å’¨è¯¢\",\n    \"æ¶ˆè´¹å“\",\n    \"è‰ºæœ¯/è®¾è®¡\",\n    \"æ•™è‚²\",\n    \"åŒ»ç–—\",\n    \"æ”¿åºœ/å…¬å…±\",\n    \"å…¶ä»–\",\n  ];\n\n  const toggleLanguage = (lang: string) => {\n    const current = form.watch(\"languagesComfort\") || [];\n    if (current.includes(lang)) {\n      form.setValue(\"languagesComfort\", current.filter(l => l !== lang));\n    } else {\n      form.setValue(\"languagesComfort\", [...current, lang]);\n    }\n  };\n\n  const toggleOverseasRegion = (region: string) => {\n    const current = form.watch(\"overseasRegions\") || [];\n    if (current.includes(region)) {\n      form.setValue(\"overseasRegions\", current.filter(r => r !== region));\n    } else {\n      form.setValue(\"overseasRegions\", [...current, region]);\n    }\n  };\n\n  // è·³è¿‡æ³¨å†ŒåŠŸèƒ½ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰\n  const handleSkipRegistration = () => {\n    // è®¡ç®—ä¸€ä¸ªåˆç†çš„å‡ºç”Ÿæ—¥æœŸï¼ˆ28å²ï¼‰\n    const birthdate = new Date();\n    birthdate.setFullYear(birthdate.getFullYear() - 28);\n    const birthdateStr = birthdate.toISOString().split('T')[0];\n\n    // å¡«å……æ‰€æœ‰å¿…å¡«å­—æ®µ\n    form.setValue(\"displayName\", \"æµ‹è¯•ç”¨æˆ·\");\n    form.setValue(\"birthdate\", birthdateStr);\n    form.setValue(\"gender\", \"Woman\");\n    form.setValue(\"relationshipStatus\", \"Single\");\n    form.setValue(\"educationLevel\", \"Master's\");\n    form.setValue(\"studyLocale\", \"Overseas\");\n    form.setValue(\"overseasRegions\", [\"ç¾å›½\"]);\n    form.setValue(\"industry\", \"ç§‘æŠ€åˆåˆ›\");\n    form.setValue(\"seniority\", \"Mid\");\n    form.setValue(\"workVisibility\", \"show_industry_only\");\n    form.setValue(\"intent\", [\"friends\"]);\n    form.setValue(\"languagesComfort\", [\"æ™®é€šè¯\", \"è‹±è¯­\"]);\n    \n    // æäº¤è¡¨å•\n    registerMutation.mutate(form.getValues());\n  };\n\n  // Toggle intent selection with flexible exclusivity logic\n  const toggleIntent = (intentValue: \"networking\" | \"friends\" | \"discussion\" | \"fun\" | \"romance\" | \"flexible\") => {\n    const current = form.watch(\"intent\") || [];\n    \n    if (intentValue === \"flexible\") {\n      // If selecting \"flexible\", clear all other intents\n      if (current.includes(\"flexible\")) {\n        form.setValue(\"intent\", []);\n      } else {\n        form.setValue(\"intent\", [\"flexible\"]);\n      }\n    } else {\n      // If selecting a specific intent\n      if (current.includes(intentValue)) {\n        // Deselect this intent\n        form.setValue(\"intent\", current.filter(i => i !== intentValue) as typeof current);\n      } else {\n        // Select this intent and remove \"flexible\" if present\n        const newIntents = current.filter(i => i !== \"flexible\");\n        form.setValue(\"intent\", [...newIntents, intentValue] as typeof current);\n      }\n    }\n  };\n\n  const isDevelopment = import.meta.env.DEV;\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      {/* Header with progress */}\n      <div className=\"p-4 border-b bg-background sticky top-0 z-10\">\n        <div className=\"flex items-center justify-between mb-2\">\n          <h1 className=\"text-lg font-bold\">å®Œæˆæ³¨å†Œ</h1>\n          <span className=\"text-sm text-muted-foreground\">\n            {step}/{totalSteps}\n          </span>\n        </div>\n        <Progress value={progress} className=\"h-2\" data-testid=\"progress-bar\" />\n      </div>\n\n      {/* Form content */}\n      <div className=\"flex-1 p-4 overflow-y-auto\">\n        <form className=\"max-w-md mx-auto space-y-6 pb-20\">\n          {/* Step 1: Identity */}\n          {step === 1 && (\n            <div className=\"space-y-6 animate-in fade-in-50 duration-300\">\n              <div>\n                <h2 className=\"text-xl font-bold mb-2\">åŸºæœ¬èº«ä»½</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  è®©æˆ‘ä»¬å…ˆä»æœ€åŸºç¡€çš„ä¿¡æ¯å¼€å§‹\n                </p>\n              </div>\n\n              <div className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"displayName\">æ˜µç§° *</Label>\n                  <Input\n                    id=\"displayName\"\n                    {...form.register(\"displayName\")}\n                    placeholder=\"åœ¨æ´»åŠ¨ä¸­æ˜¾ç¤ºçš„åå­—\"\n                    data-testid=\"input-display-name\"\n                  />\n                  {form.formState.errors.displayName && (\n                    <p className=\"text-sm text-destructive mt-1\">\n                      {form.formState.errors.displayName.message}\n                    </p>\n                  )}\n                </div>\n\n                <div>\n                  <Label>å‡ºç”Ÿæ—¥æœŸ *</Label>\n                  <DatePicker\n                    value={form.watch(\"birthdate\") ? new Date(form.watch(\"birthdate\")) : undefined}\n                    onChange={(date) => {\n                      if (date) {\n                        form.setValue(\"birthdate\", date.toISOString().split('T')[0]);\n                      } else {\n                        form.setValue(\"birthdate\", \"\");\n                      }\n                    }}\n                    maxDate={new Date()}\n                    placeholder=\"é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ\"\n                    data-testid=\"input-birthdate\"\n                  />\n                  {form.formState.errors.birthdate && (\n                    <p className=\"text-sm text-destructive mt-1\">\n                      {form.formState.errors.birthdate.message}\n                    </p>\n                  )}\n                </div>\n\n                <div>\n                  <Label>å¹´é¾„æ˜¾ç¤ºè®¾ç½®</Label>\n                  <Select\n                    value={form.watch(\"ageVisibility\")}\n                    onValueChange={(value: any) => form.setValue(\"ageVisibility\", value)}\n                  >\n                    <SelectTrigger data-testid=\"select-age-visibility\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"hide_all\">å®Œå…¨éšè—</SelectItem>\n                      <SelectItem value=\"show_exact_age\">æ˜¾ç¤ºç²¾ç¡®å¹´é¾„</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    æ§åˆ¶å…¶ä»–äººèƒ½çœ‹åˆ°ä½ çš„å¹´é¾„ä¿¡æ¯\n                  </p>\n                </div>\n\n                <div>\n                  <Label>æ€§åˆ« *</Label>\n                  <div className=\"space-y-3 mt-2\">\n                    {[\n                      { value: \"Woman\", label: \"å¥³æ€§\" },\n                      { value: \"Man\", label: \"ç”·æ€§\" },\n                    ].map((option) => (\n                      <button\n                        key={option.value}\n                        type=\"button\"\n                        onClick={() => form.setValue(\"gender\", option.value as any)}\n                        className={`\n                          w-full px-5 py-4 text-left rounded-lg border transition-all text-base\n                          ${form.watch(\"gender\") === option.value\n                            ? 'border-primary bg-primary/5 text-primary' \n                            : 'border-border hover-elevate active-elevate-2'\n                          }\n                        `}\n                        data-testid={`button-gender-${option.value}`}\n                      >\n                        {option.label}\n                      </button>\n                    ))}\n                  </div>\n                  {form.formState.errors.gender && (\n                    <p className=\"text-sm text-destructive mt-1\">\n                      {form.formState.errors.gender.message}\n                    </p>\n                  )}\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Step 2: Background & Education */}\n          {step === 2 && (\n            <div className=\"space-y-6 animate-in fade-in-50 duration-300\">\n              <div>\n                <h2 className=\"text-xl font-bold mb-2\">ä¸ªäººèƒŒæ™¯ & æ•™è‚²</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°äº†è§£ä½ \n                </p>\n              </div>\n\n              <div className=\"space-y-4\">\n                <div>\n                  <Label>å…³ç³»çŠ¶æ€ *</Label>\n                  <div className=\"space-y-3 mt-2\">\n                    {[\n                      { value: \"Single\", label: \"å•èº«\" },\n                      { value: \"In a relationship\", label: \"æ‹çˆ±ä¸­\" },\n                      { value: \"Married/Partnered\", label: \"å·²å©š/å·²ç»“ä¼´\" },\n                      { value: \"It's complicated\", label: \"å¤æ‚\" },\n                    ].map((option) => (\n                      <button\n                        key={option.value}\n                        type=\"button\"\n                        onClick={() => form.setValue(\"relationshipStatus\", option.value as any)}\n                        className={`\n                          w-full px-5 py-4 text-left rounded-lg border transition-all text-base\n                          ${form.watch(\"relationshipStatus\") === option.value\n                            ? 'border-primary bg-primary/5 text-primary' \n                            : 'border-border hover-elevate active-elevate-2'\n                          }\n                        `}\n                        data-testid={`button-relationship-${option.value}`}\n                      >\n                        {option.label}\n                      </button>\n                    ))}\n                  </div>\n                  {form.formState.errors.relationshipStatus && (\n                    <p className=\"text-sm text-destructive mt-1\">\n                      {form.formState.errors.relationshipStatus.message}\n                    </p>\n                  )}\n                </div>\n\n                <div>\n                  <Label>å­©å­çŠ¶å†µï¼ˆå¯é€‰ï¼‰</Label>\n                  <div className=\"space-y-3 mt-2\">\n                    {[\n                      { value: \"No kids\", label: \"æ— å­©å­\" },\n                      { value: \"Expecting\", label: \"æœŸå¾…ä¸­\" },\n                      { value: \"0-5\", label: \"0-5å²\" },\n                      { value: \"6-12\", label: \"6-12å²\" },\n                      { value: \"13-18\", label: \"13-18å²\" },\n                      { value: \"Adult\", label: \"æˆå¹´\" },\n                    ].map((option) => (\n                      <button\n                        key={option.value}\n                        type=\"button\"\n                        onClick={() => form.setValue(\"children\", option.value as any)}\n                        className={`\n                          w-full px-5 py-4 text-left rounded-lg border transition-all text-base\n                          ${form.watch(\"children\") === option.value\n                            ? 'border-primary bg-primary/5 text-primary' \n                            : 'border-border hover-elevate active-elevate-2'\n                          }\n                        `}\n                        data-testid={`button-children-${option.value}`}\n                      >\n                        {option.label}\n                      </button>\n                    ))}\n                  </div>\n                </div>\n\n                <Separator className=\"my-6\" />\n\n                <div>\n                  <Label>æ•™è‚²æ°´å¹³ï¼ˆå¯é€‰ï¼‰</Label>\n                  <div className=\"space-y-3 mt-2\">\n                    {[\n                      { value: \"High school/below\", label: \"é«˜ä¸­åŠä»¥ä¸‹\" },\n                      { value: \"Some college/Associate\", label: \"å¤§ä¸“/å‰¯å­¦å£«\" },\n                      { value: \"Bachelor's\", label: \"æœ¬ç§‘\" },\n                      { value: \"Master's\", label: \"ç¡•å£«\" },\n                      { value: \"Doctorate\", label: \"åšå£«\" },\n                      { value: \"Trade/Vocational\", label: \"èŒä¸šåŸ¹è®­\" },\n                    ].map((option) => (\n                      <button\n                        key={option.value}\n                        type=\"button\"\n                        onClick={() => form.setValue(\"educationLevel\", option.value as any)}\n                        className={`\n                          w-full px-5 py-4 text-left rounded-lg border transition-all text-base\n                          ${form.watch(\"educationLevel\") === option.value\n                            ? 'border-primary bg-primary/5 text-primary' \n                            : 'border-border hover-elevate active-elevate-2'\n                          }\n                        `}\n                        data-testid={`button-education-${option.value}`}\n                      >\n                        {option.label}\n                      </button>\n                    ))}\n                  </div>\n                </div>\n\n                <div>\n                  <Label>å­¦ä¹ åœ°ç‚¹ï¼ˆå¯é€‰ï¼‰</Label>\n                  <div className=\"space-y-3 mt-2\">\n                    {[\n                      { value: \"Local\", label: \"æœ¬åœ°\" },\n                      { value: \"Overseas\", label: \"æµ·å¤–\" },\n                      { value: \"Both\", label: \"éƒ½æœ‰\" },\n                    ].map((option) => (\n                      <button\n                        key={option.value}\n                        type=\"button\"\n                        onClick={() => form.setValue(\"studyLocale\", option.value as any)}\n                        className={`\n                          w-full px-5 py-4 text-left rounded-lg border transition-all text-base\n                          ${form.watch(\"studyLocale\") === option.value\n                            ? 'border-primary bg-primary/5 text-primary' \n                            : 'border-border hover-elevate active-elevate-2'\n                          }\n                        `}\n                        data-testid={`button-study-locale-${option.value}`}\n                      >\n                        {option.label}\n                      </button>\n                    ))}\n                  </div>\n                </div>\n\n                {(form.watch(\"studyLocale\") === \"Overseas\" || form.watch(\"studyLocale\") === \"Both\") && (\n                  <div>\n                    <Label>æµ·å¤–åœ°åŒºï¼ˆå¯é€‰ï¼‰</Label>\n                    <p className=\"text-xs text-muted-foreground mb-2\">\n                      é€‰æ‹©ä½ åœ¨æµ·å¤–å­¦ä¹ çš„åœ°åŒº\n                    </p>\n                    <div className=\"grid grid-cols-2 gap-2\">\n                      {overseasRegionOptions.map((region) => {\n                        const isSelected = (form.watch(\"overseasRegions\") || []).includes(region);\n                        return (\n                          <button\n                            key={region}\n                            type=\"button\"\n                            onClick={() => toggleOverseasRegion(region)}\n                            data-testid={`button-region-${region}`}\n                            className={`\n                              px-5 py-4 rounded-lg border transition-all text-left text-base\n                              ${isSelected \n                                ? 'border-primary bg-primary/5 text-primary' \n                                : 'border-border hover-elevate active-elevate-2'\n                              }\n                            `}\n                          >\n                            {region}\n                          </button>\n                        );\n                      })}\n                    </div>\n                  </div>\n                )}\n\n                <div>\n                  <Label htmlFor=\"fieldOfStudy\">ä¸“ä¸šé¢†åŸŸï¼ˆå¯é€‰ï¼‰</Label>\n                  <Input\n                    id=\"fieldOfStudy\"\n                    {...form.register(\"fieldOfStudy\")}\n                    placeholder=\"ä¾‹å¦‚ï¼šè®¡ç®—æœºç§‘å­¦ã€å•†ä¸šç®¡ç†\"\n                    data-testid=\"input-field-of-study\"\n                  />\n                </div>\n\n                <div>\n                  <Label>æ•™è‚²ä¿¡æ¯å¯è§æ€§</Label>\n                  <Select\n                    value={form.watch(\"educationVisibility\")}\n                    onValueChange={(value: any) => form.setValue(\"educationVisibility\", value)}\n                  >\n                    <SelectTrigger data-testid=\"select-education-visibility\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"hide_all\">å®Œå…¨éšè—</SelectItem>\n                      <SelectItem value=\"show_level_only\">ä»…æ˜¾ç¤ºå­¦å†</SelectItem>\n                      <SelectItem value=\"show_level_and_field\">æ˜¾ç¤ºå­¦å†å’Œä¸“ä¸š</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    æ§åˆ¶å…¶ä»–äººèƒ½çœ‹åˆ°ä½ çš„å¤šå°‘æ•™è‚²ä¿¡æ¯\n                  </p>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Step 3: Work */}\n          {step === 3 && (\n            <div className=\"space-y-6 animate-in fade-in-50 duration-300\">\n              <div>\n                <h2 className=\"text-xl font-bold mb-2\">å·¥ä½œä¿¡æ¯</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  äº†è§£ä½ çš„èŒä¸šèƒŒæ™¯\n                </p>\n              </div>\n\n              <div className=\"space-y-4\">\n                <div>\n                  <Label>è¡Œä¸š *</Label>\n                  <div className=\"space-y-3 mt-2\">\n                    {industryOptions.map((option) => (\n                      <button\n                        key={option}\n                        type=\"button\"\n                        onClick={() => form.setValue(\"industry\", option)}\n                        className={`\n                          w-full px-5 py-4 text-left rounded-lg border transition-all text-base\n                          ${form.watch(\"industry\") === option\n                            ? 'border-primary bg-primary/5 text-primary' \n                            : 'border-border hover-elevate active-elevate-2'\n                          }\n                        `}\n                        data-testid={`button-industry-${option}`}\n                      >\n                        {option}\n                      </button>\n                    ))}\n                  </div>\n                  {form.formState.errors.industry && (\n                    <p className=\"text-sm text-destructive mt-1\">\n                      {form.formState.errors.industry.message}\n                    </p>\n                  )}\n                </div>\n\n                <div>\n                  <Label htmlFor=\"roleTitleShort\">èŒä½ç®€ç§°ï¼ˆå¯é€‰ï¼‰</Label>\n                  <Input\n                    id=\"roleTitleShort\"\n                    {...form.register(\"roleTitleShort\")}\n                    placeholder=\"ä¾‹å¦‚ï¼šäº§å“ç»ç†ã€å·¥ç¨‹å¸ˆ\"\n                    data-testid=\"input-role-title\"\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    ç®€çŸ­çš„èŒä½æè¿°ï¼Œä¸è¶…è¿‡20ä¸ªå­—\n                  </p>\n                </div>\n\n                <div>\n                  <Label>èŒçº§ï¼ˆå¯é€‰ï¼‰</Label>\n                  <div className=\"space-y-3 mt-2\">\n                    {[\n                      { value: \"Intern\", label: \"å®ä¹ ç”Ÿ\" },\n                      { value: \"Junior\", label: \"åˆçº§\" },\n                      { value: \"Mid\", label: \"ä¸­çº§\" },\n                      { value: \"Senior\", label: \"é«˜çº§\" },\n                      { value: \"Founder\", label: \"åˆ›å§‹äºº\" },\n                      { value: \"Executive\", label: \"é«˜ç®¡\" },\n                    ].map((option) => (\n                      <button\n                        key={option.value}\n                        type=\"button\"\n                        onClick={() => form.setValue(\"seniority\", option.value as any)}\n                        className={`\n                          w-full px-5 py-4 text-left rounded-lg border transition-all text-base\n                          ${form.watch(\"seniority\") === option.value\n                            ? 'border-primary bg-primary/5 text-primary' \n                            : 'border-border hover-elevate active-elevate-2'\n                          }\n                        `}\n                        data-testid={`button-seniority-${option.value}`}\n                      >\n                        {option.label}\n                      </button>\n                    ))}\n                  </div>\n                </div>\n\n                <div>\n                  <Label>å·¥ä½œä¿¡æ¯å¯è§æ€§</Label>\n                  <p className=\"text-xs text-muted-foreground mb-2\">\n                    æ§åˆ¶å…¶ä»–äººèƒ½çœ‹åˆ°ä½ çš„å¤šå°‘å·¥ä½œä¿¡æ¯\n                  </p>\n                  <div className=\"space-y-3\">\n                    {[\n                      { value: \"hide_all\", label: \"å®Œå…¨éšè—\" },\n                      { value: \"show_industry_only\", label: \"ä»…æ˜¾ç¤ºè¡Œä¸š\" },\n                    ].map((option) => (\n                      <button\n                        key={option.value}\n                        type=\"button\"\n                        onClick={() => form.setValue(\"workVisibility\", option.value as any)}\n                        className={`\n                          w-full px-5 py-4 text-left rounded-lg border transition-all text-base\n                          ${form.watch(\"workVisibility\") === option.value\n                            ? 'border-primary bg-primary/5 text-primary' \n                            : 'border-border hover-elevate active-elevate-2'\n                          }\n                        `}\n                        data-testid={`button-work-visibility-${option.value}`}\n                      >\n                        {option.label}\n                      </button>\n                    ))}\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Step 4: Intent */}\n          {step === 4 && (\n            <div className=\"space-y-6 animate-in fade-in-50 duration-300\">\n              <div>\n                <h2 className=\"text-xl font-bold mb-2\">æ´»åŠ¨æ„å›¾</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  ä½ å‚åŠ æ´»åŠ¨çš„ä¸»è¦ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿå¯ä»¥å¤šé€‰\n                </p>\n              </div>\n\n              <div className=\"space-y-4\">\n                <div>\n                  <Label>é»˜è®¤æ´»åŠ¨æ„å›¾ *</Label>\n                  <p className=\"text-xs text-muted-foreground mb-2\">\n                    è¿™æ˜¯ä½ çš„é»˜è®¤åå¥½ï¼ŒåŠ å…¥æ´»åŠ¨æ—¶å¯ä»¥è°ƒæ•´\n                  </p>\n                  <div className=\"space-y-3 mt-2\">\n                    {intentOptions.map((option) => {\n                      const currentIntents = form.watch(\"intent\") || [];\n                      const isSelected = currentIntents.includes(option.value);\n                      const isFlexible = option.value === \"flexible\";\n                      const hasFlexible = currentIntents.includes(\"flexible\");\n                      const isDisabled = !isFlexible && hasFlexible;\n\n                      return (\n                        <button\n                          key={option.value}\n                          type=\"button\"\n                          onClick={() => toggleIntent(option.value)}\n                          disabled={isDisabled}\n                          className={`\n                            w-full px-5 py-4 text-left rounded-lg border transition-all\n                            ${isSelected\n                              ? 'border-primary bg-primary/5 text-primary' \n                              : isDisabled\n                              ? 'border-border bg-muted/30 text-muted-foreground cursor-not-allowed'\n                              : 'border-border hover-elevate active-elevate-2'\n                            }\n                          `}\n                          data-testid={`button-intent-${option.value}`}\n                        >\n                          <div className=\"flex items-start gap-3\">\n                            <div className={`\n                              mt-0.5 flex-shrink-0 w-5 h-5 rounded border-2 flex items-center justify-center\n                              ${isSelected \n                                ? 'bg-primary border-primary' \n                                : 'border-border'\n                              }\n                            `}>\n                              {isSelected && (\n                                <svg className=\"w-3 h-3 text-primary-foreground\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={3} d=\"M5 13l4 4L19 7\" />\n                                </svg>\n                              )}\n                            </div>\n                            <div className=\"flex-1\">\n                              <div className=\"font-medium text-base\">{option.label}</div>\n                              <div className=\"text-xs text-muted-foreground mt-1\">{option.description}</div>\n                            </div>\n                          </div>\n                        </button>\n                      );\n                    })}\n                  </div>\n                  {form.formState.errors.intent && (\n                    <p className=\"text-sm text-destructive mt-1\">\n                      {form.formState.errors.intent.message}\n                    </p>\n                  )}\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Step 5: Culture & Language */}\n          {step === 5 && (\n            <div className=\"space-y-6 animate-in fade-in-50 duration-300\">\n              <div>\n                <h2 className=\"text-xl font-bold mb-2\">æ–‡åŒ– & è¯­è¨€</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  è®©æˆ‘ä»¬äº†è§£ä½ çš„æ–‡åŒ–èƒŒæ™¯å’Œè¯­è¨€åå¥½\n                </p>\n              </div>\n\n              <div className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"hometownCountry\">å®¶ä¹¡å›½å®¶/åœ°åŒºï¼ˆå¯é€‰ï¼‰</Label>\n                  <Input\n                    id=\"hometownCountry\"\n                    {...form.register(\"hometownCountry\")}\n                    placeholder=\"ä¾‹å¦‚ï¼šä¸­å›½ã€ç¾å›½ã€æ—¥æœ¬\"\n                    data-testid=\"input-hometown-country\"\n                  />\n                </div>\n\n                <div>\n                  <Label htmlFor=\"hometownRegionCity\">å®¶ä¹¡åŸå¸‚ï¼ˆå¯é€‰ï¼‰</Label>\n                  <Input\n                    id=\"hometownRegionCity\"\n                    {...form.register(\"hometownRegionCity\")}\n                    placeholder=\"ä¾‹å¦‚ï¼šæ·±åœ³ã€åŒ—äº¬ã€ä¸Šæµ·\"\n                    data-testid=\"input-hometown-city\"\n                  />\n                </div>\n\n                <div className=\"flex items-start space-x-2 py-2\">\n                  <Checkbox\n                    id=\"hometownAffinityOptin\"\n                    checked={form.watch(\"hometownAffinityOptin\")}\n                    onCheckedChange={(checked) => form.setValue(\"hometownAffinityOptin\", checked as boolean)}\n                    data-testid=\"checkbox-hometown-affinity\"\n                  />\n                  <div className=\"space-y-1\">\n                    <Label htmlFor=\"hometownAffinityOptin\" className=\"cursor-pointer font-normal\">\n                      ä¼˜å…ˆåŒ¹é…è€ä¹¡\n                    </Label>\n                    <p className=\"text-xs text-muted-foreground\">\n                      åœ¨æ´»åŠ¨åŒ¹é…æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘æ¥è‡ªç›¸åŒå®¶ä¹¡çš„äºº\n                    </p>\n                  </div>\n                </div>\n\n                <Separator className=\"my-4\" />\n\n                <div>\n                  <Label>è¯­è¨€èˆ’é€‚åº¦ *</Label>\n                  <p className=\"text-xs text-muted-foreground mb-2\">\n                    é€‰æ‹©ä½ å¯ä»¥èˆ’é€‚äº¤æµçš„è¯­è¨€\n                  </p>\n                  <div className=\"grid grid-cols-2 gap-2\">\n                    {languageOptions.map((lang) => {\n                      const isSelected = (form.watch(\"languagesComfort\") || []).includes(lang);\n                      return (\n                        <button\n                          key={lang}\n                          type=\"button\"\n                          onClick={() => toggleLanguage(lang)}\n                          data-testid={`button-lang-${lang}`}\n                          className={`\n                            px-5 py-4 rounded-lg border transition-all text-left text-base\n                            ${isSelected \n                              ? 'border-primary bg-primary/5 text-primary' \n                              : 'border-border hover-elevate active-elevate-2'\n                            }\n                          `}\n                        >\n                          {lang}\n                        </button>\n                      );\n                    })}\n                  </div>\n                  {form.formState.errors.languagesComfort && (\n                    <p className=\"text-sm text-destructive mt-2\">\n                      è¯·è‡³å°‘é€‰æ‹©ä¸€ç§è¯­è¨€\n                    </p>\n                  )}\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Step 6: Access & Safety */}\n          {step === 6 && (\n            <div className=\"space-y-6 animate-in fade-in-50 duration-300\">\n              <div>\n                <h2 className=\"text-xl font-bold mb-2\">æ— éšœç¢ & å®‰å…¨</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  æœ€åä¸€æ­¥ï¼è¿™äº›ä¿¡æ¯éƒ½æ˜¯å¯é€‰çš„\n                </p>\n              </div>\n\n              <div className=\"space-y-4\">\n                <div className=\"flex items-start space-x-2 bg-muted/30 p-3 rounded-md\">\n                  <Info className=\"h-4 w-4 text-muted-foreground mt-0.5 flex-shrink-0\" />\n                  <p className=\"text-xs text-muted-foreground\">\n                    ä»¥ä¸‹ä¿¡æ¯å°†å¸®åŠ©æ´»åŠ¨ä¸»åŠæ–¹æ›´å¥½åœ°ç…§é¡¾æ¯ä½å‚ä¸è€…ï¼Œæ‰€æœ‰å†…å®¹éƒ½æ˜¯å¯é€‰çš„ä¸”ä¿å¯†\n                  </p>\n                </div>\n\n                <div>\n                  <Label htmlFor=\"accessibilityNeeds\">æ— éšœç¢éœ€æ±‚ï¼ˆå¯é€‰ï¼‰</Label>\n                  <Textarea\n                    id=\"accessibilityNeeds\"\n                    {...form.register(\"accessibilityNeeds\")}\n                    placeholder=\"ä¾‹å¦‚ï¼šè½®æ¤…é€šé“ã€åŠ©å¬è®¾å¤‡ã€é¥®é£Ÿé™åˆ¶ç­‰\"\n                    rows={3}\n                    data-testid=\"textarea-accessibility\"\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    è¿™äº›ä¿¡æ¯ä¼šç§å¯†åœ°åˆ†äº«ç»™æ´»åŠ¨ä¸»åŠæ–¹\n                  </p>\n                </div>\n\n                <div>\n                  <Label htmlFor=\"safetyNoteHost\">å®‰å…¨å¤‡æ³¨ç»™ä¸»åŠæ–¹ï¼ˆå¯é€‰ï¼‰</Label>\n                  <Textarea\n                    id=\"safetyNoteHost\"\n                    {...form.register(\"safetyNoteHost\")}\n                    placeholder=\"ä¾‹å¦‚ï¼šè¯ç‰©è¿‡æ•ã€ç´§æ€¥è”ç³»äººä¿¡æ¯ç­‰\"\n                    rows={3}\n                    data-testid=\"textarea-safety-note\"\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    è¿™äº›ä¿¡æ¯ä»…åœ¨ç´§æ€¥æƒ…å†µä¸‹å¯è§\n                  </p>\n                </div>\n\n                <Separator className=\"my-4\" />\n\n                <div>\n                  <Label htmlFor=\"wechatId\">å¾®ä¿¡å·ï¼ˆå¯é€‰ï¼‰</Label>\n                  <Input\n                    id=\"wechatId\"\n                    {...form.register(\"wechatId\")}\n                    placeholder=\"ä½ çš„å¾®ä¿¡å·\"\n                    data-testid=\"input-wechat-id\"\n                  />\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    ç”¨äºæ´»åŠ¨é€šçŸ¥å’Œç¤¾äº¤è¿æ¥\n                  </p>\n                </div>\n              </div>\n            </div>\n          )}\n        </form>\n      </div>\n\n      {/* Navigation buttons */}\n      <div className=\"border-t p-4 bg-background sticky bottom-0\">\n        <div className=\"max-w-md mx-auto space-y-3\">\n          <div className=\"flex gap-3\">\n            {step > 1 && (\n              <Button\n                variant=\"outline\"\n                onClick={handleBack}\n                className=\"flex-1\"\n                data-testid=\"button-back\"\n              >\n                <ChevronLeft className=\"h-4 w-4 mr-2\" />\n                ä¸Šä¸€æ­¥\n              </Button>\n            )}\n            <Button\n              onClick={handleNext}\n              className=\"flex-1\"\n              disabled={registerMutation.isPending}\n              data-testid=\"button-next\"\n            >\n              {step === totalSteps ? (\n                registerMutation.isPending ? \"æäº¤ä¸­...\" : \"å®Œæˆæ³¨å†Œ\"\n              ) : (\n                <>\n                  ä¸‹ä¸€æ­¥\n                  <ChevronRight className=\"h-4 w-4 ml-2\" />\n                </>\n              )}\n            </Button>\n          </div>\n          \n          {/* å¼€å‘ç¯å¢ƒè·³è¿‡æ³¨å†ŒæŒ‰é’® */}\n          {isDevelopment && (\n            <Button\n              variant=\"ghost\"\n              onClick={handleSkipRegistration}\n              className=\"w-full text-xs\"\n              disabled={registerMutation.isPending}\n              data-testid=\"button-skip-registration\"\n            >\n              è·³è¿‡æ³¨å†Œï¼ˆæµ‹è¯•ï¼‰\n            </Button>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":37685},"client/src/components/EditPreferencesDialog.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport type { BlindBoxEvent } from \"@shared/schema\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { getCurrencySymbol } from \"@/lib/currency\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport { ChevronDown } from \"lucide-react\";\n\ninterface EditPreferencesDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  event: BlindBoxEvent;\n}\n\nexport default function EditPreferencesDialog({ open, onOpenChange, event }: EditPreferencesDialogProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const currencySymbol = getCurrencySymbol(event.city as \"é¦™æ¸¯\" | \"æ·±åœ³\");\n\n  // Parse budget tiers from budgetTier string\n  const initialBudget = event.budgetTier.split('/');\n  \n  const [budgetPreference, setBudgetPreference] = useState<string[]>(initialBudget);\n  const [acceptNearby, setAcceptNearby] = useState(event.acceptNearby || false);\n  const [selectedLanguages, setSelectedLanguages] = useState<string[]>(event.selectedLanguages || []);\n  const [selectedTasteIntensity, setSelectedTasteIntensity] = useState<string[]>(event.selectedTasteIntensity || []);\n  const [selectedCuisines, setSelectedCuisines] = useState<string[]>(event.selectedCuisines || []);\n  const [preferencesOpen, setPreferencesOpen] = useState(false);\n\n  // Reset when dialog opens\n  useEffect(() => {\n    if (open) {\n      setBudgetPreference(initialBudget);\n      setAcceptNearby(event.acceptNearby || false);\n      setSelectedLanguages(event.selectedLanguages || []);\n      setSelectedTasteIntensity(event.selectedTasteIntensity || []);\n      setSelectedCuisines(event.selectedCuisines || []);\n    }\n  }, [open]);\n\n  const budgetOptions = [\n    { value: \"100ä»¥ä¸‹\", label: \"â‰¤100\" },\n    { value: \"100-200\", label: \"100-200\" },\n    { value: \"200-300\", label: \"200-300\" },\n    { value: \"300-500\", label: \"300-500\" },\n    { value: \"500+\", label: \"500+\" },\n  ];\n\n  const languageOptions = [\n    { value: \"ä¸­æ–‡ï¼ˆå›½è¯­ï¼‰\", label: \"ä¸­æ–‡ï¼ˆå›½è¯­ï¼‰\" },\n    { value: \"ä¸­æ–‡ï¼ˆç²¤è¯­ï¼‰\", label: \"ä¸­æ–‡ï¼ˆç²¤è¯­ï¼‰\" },\n    { value: \"è‹±è¯­\", label: \"è‹±è¯­\" },\n  ];\n\n  const tasteIntensityOptions = [\n    { value: \"çˆ±åƒè¾£\", label: \"çˆ±åƒè¾£\" },\n    { value: \"ä¸è¾£/æ¸…æ·¡ä¸ºä¸»\", label: \"ä¸è¾£/æ¸…æ·¡ä¸ºä¸»\" },\n  ];\n\n  const cuisineOptions = [\n    { value: \"ä¸­é¤\", label: \"ä¸­é¤\" },\n    { value: \"å·èœ\", label: \"å·èœ\" },\n    { value: \"ç²¤èœ\", label: \"ç²¤èœ\" },\n    { value: \"ç«é”…\", label: \"ç«é”…\" },\n    { value: \"çƒ§çƒ¤\", label: \"çƒ§çƒ¤\" },\n    { value: \"è¥¿é¤\", label: \"è¥¿é¤\" },\n    { value: \"æ—¥æ–™\", label: \"æ—¥æ–™\" },\n  ];\n\n  const toggleBudget = (value: string) => {\n    setBudgetPreference(prev => \n      prev.includes(value) \n        ? prev.filter(v => v !== value)\n        : [...prev, value]\n    );\n  };\n\n  const toggleLanguage = (value: string) => {\n    setSelectedLanguages(prev => \n      prev.includes(value) \n        ? prev.filter(v => v !== value)\n        : [...prev, value]\n    );\n  };\n\n  const toggleTasteIntensity = (value: string) => {\n    setSelectedTasteIntensity(prev => \n      prev.includes(value) \n        ? prev.filter(v => v !== value)\n        : [...prev, value]\n    );\n  };\n\n  const toggleCuisine = (value: string) => {\n    setSelectedCuisines(prev => \n      prev.includes(value) \n        ? prev.filter(v => v !== value)\n        : [...prev, value]\n    );\n  };\n\n  const updateEventMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"PATCH\", `/api/blind-box-events/${event.id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/my-events\"] });\n      toast({\n        title: \"ä¿®æ”¹æˆåŠŸ\",\n        description: \"åå¥½å·²æ›´æ–°\",\n      });\n      onOpenChange(false);\n    },\n    onError: (error) => {\n      toast({\n        title: \"ä¿®æ”¹å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSave = () => {\n    if (budgetPreference.length === 0) {\n      toast({\n        title: \"è¯·é€‰æ‹©é¢„ç®—èŒƒå›´\",\n        description: \"è‡³å°‘é€‰æ‹©ä¸€ä¸ªé¢„ç®—æ¡£ä½\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    updateEventMutation.mutate({\n      budget: budgetPreference,\n      acceptNearby,\n      selectedLanguages,\n      selectedTasteIntensity,\n      selectedCuisines,\n    });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-md max-h-[85vh] overflow-y-auto\" data-testid=\"dialog-edit-preferences\">\n        <DialogHeader>\n          <DialogTitle>ä¿®æ”¹åå¥½è®¾ç½®</DialogTitle>\n        </DialogHeader>\n\n        <div className=\"space-y-6 py-4\">\n          {/* é¢„ç®—é€‰æ‹© */}\n          <div>\n            <Label className=\"text-base font-semibold mb-3 block\">é¢„ç®—èŒƒå›´ï¼ˆå¯å¤šé€‰ï¼‰</Label>\n            <div className=\"flex flex-wrap gap-2\">\n              {budgetOptions.map((option) => (\n                <Badge\n                  key={option.value}\n                  variant={budgetPreference.includes(option.value) ? \"default\" : \"outline\"}\n                  className=\"cursor-pointer px-3 py-1.5 text-sm\"\n                  onClick={() => toggleBudget(option.value)}\n                  data-testid={`badge-budget-${option.value}`}\n                >\n                  {currencySymbol}{option.label}\n                </Badge>\n              ))}\n            </div>\n          </div>\n\n          {/* æå‡æˆåŠŸç‡ */}\n          <div>\n            <Label className=\"text-base font-semibold mb-3 block\">æå‡æˆåŠŸç‡</Label>\n            <div className=\"bg-muted/50 rounded-lg p-3\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex-1\">\n                  <div className=\"font-medium\">ç›¸é‚»å•†åœˆ</div>\n                  <div className=\"text-xs text-muted-foreground mt-0.5\">\n                    ä¾‹å¦‚åœ¨ç¦ç”°çš„è¯ï¼Œåä¾¨åŸå’Œå—å±±ä¹Ÿå¯ä»¥\n                  </div>\n                </div>\n                <Switch \n                  checked={acceptNearby} \n                  onCheckedChange={setAcceptNearby}\n                  data-testid=\"switch-accept-nearby\"\n                />\n              </div>\n            </div>\n          </div>\n\n          {/* æˆ‘çš„åå¥½ */}\n          <Collapsible open={preferencesOpen} onOpenChange={setPreferencesOpen}>\n            <div className=\"space-y-3\">\n              <CollapsibleTrigger asChild>\n                <Button \n                  variant=\"ghost\" \n                  className=\"w-full justify-between p-0 h-auto hover:bg-transparent\"\n                  data-testid=\"button-toggle-edit-preferences\"\n                >\n                  <Label className=\"text-base font-semibold cursor-pointer\">æˆ‘çš„åå¥½ï¼ˆå¯é€‰ï¼‰</Label>\n                  <ChevronDown className={`h-4 w-4 transition-transform ${preferencesOpen ? 'rotate-180' : ''}`} />\n                </Button>\n              </CollapsibleTrigger>\n              \n              <CollapsibleContent className=\"space-y-4\">\n                {/* è¯­è¨€åå¥½ */}\n                <div>\n                  <Label className=\"text-sm text-muted-foreground mb-2 block\">è¯­è¨€</Label>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {languageOptions.map((option) => (\n                      <Badge\n                        key={option.value}\n                        variant={selectedLanguages.includes(option.value) ? \"default\" : \"outline\"}\n                        className=\"cursor-pointer px-3 py-1.5 text-sm\"\n                        onClick={() => toggleLanguage(option.value)}\n                        data-testid={`badge-language-${option.value}`}\n                      >\n                        {option.label}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n\n                {/* å£å‘³åå¥½ */}\n                <div>\n                  <Label className=\"text-sm text-muted-foreground mb-2 block\">å£å‘³</Label>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {tasteIntensityOptions.map((option) => (\n                      <Badge\n                        key={option.value}\n                        variant={selectedTasteIntensity.includes(option.value) ? \"default\" : \"outline\"}\n                        className=\"cursor-pointer px-3 py-1.5 text-sm\"\n                        onClick={() => toggleTasteIntensity(option.value)}\n                        data-testid={`badge-taste-${option.value}`}\n                      >\n                        {option.label}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n\n                {/* èœç³»åå¥½ */}\n                <div>\n                  <Label className=\"text-sm text-muted-foreground mb-2 block\">èœç³»</Label>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {cuisineOptions.map((option) => (\n                      <Badge\n                        key={option.value}\n                        variant={selectedCuisines.includes(option.value) ? \"default\" : \"outline\"}\n                        className=\"cursor-pointer px-3 py-1.5 text-sm\"\n                        onClick={() => toggleCuisine(option.value)}\n                        data-testid={`badge-cuisine-${option.value}`}\n                      >\n                        {option.label}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              </CollapsibleContent>\n            </div>\n          </Collapsible>\n        </div>\n\n        <DialogFooter>\n          <Button \n            variant=\"outline\" \n            onClick={() => onOpenChange(false)}\n            data-testid=\"button-cancel-edit\"\n          >\n            å–æ¶ˆ\n          </Button>\n          <Button \n            onClick={handleSave}\n            disabled={updateEventMutation.isPending}\n            data-testid=\"button-save-edit\"\n          >\n            {updateEventMutation.isPending ? \"ä¿å­˜ä¸­...\" : \"ä¿å­˜ä¿®æ”¹\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":10566},"client/src/pages/PersonalityTestPage.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ChevronLeft, ChevronRight, Sparkles } from \"lucide-react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport MiniRadarChart from \"@/components/MiniRadarChart\";\nimport { personalityQuestions as baseQuestions, getSupplementaryQuestions } from \"@/data/personalityQuestions\";\n\ninterface QuestionOption {\n  value: string;\n  text: string;\n  roleMapping: string;\n}\n\ninterface Question {\n  id: number;\n  category: string;\n  questionText: string;\n  scenarioText?: string;\n  questionType: \"single\" | \"dual\";\n  options: QuestionOption[];\n}\n\nexport default function PersonalityTestPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [currentQuestion, setCurrentQuestion] = useState(0);\n  const [answers, setAnswers] = useState<Record<number, any>>({});\n  const [showMilestone, setShowMilestone] = useState(false);\n  const [showBlindBox, setShowBlindBox] = useState(false);\n  \n  // Supplementary test states\n  const [isSupplementaryMode, setIsSupplementaryMode] = useState(false);\n  const [supplementaryQuestions, setSupplementaryQuestions] = useState<Question[]>([]);\n  const [candidateArchetypes, setCandidateArchetypes] = useState<Array<{ name: string; score: number }>>([]);\n  const [showSupplementaryTransition, setShowSupplementaryTransition] = useState(false);\n  \n  // Combined questions: base + supplementary (if any)\n  const questions = isSupplementaryMode \n    ? [...baseQuestions, ...supplementaryQuestions]\n    : baseQuestions;\n\n  // Removed redirect logic - users can now retake the test anytime\n\n  // Preliminary scoring mutation (after base 10 questions)\n  const preliminaryScoreMutation = useMutation({\n    mutationFn: async (responses: Record<number, any>) => {\n      return await apiRequest(\"POST\", \"/api/personality-test/preliminary-score\", {\n        responses,\n      });\n    },\n    onSuccess: (data: any) => {\n      if (data.needsSupplementary) {\n        // Need supplementary questions\n        setCandidateArchetypes(data.candidateArchetypes);\n        \n        // Get supplementary questions for these two archetypes\n        const suppQuestions = getSupplementaryQuestions(\n          data.candidateArchetypes[0].name,\n          data.candidateArchetypes[1].name,\n          3\n        );\n        \n        setSupplementaryQuestions(suppQuestions);\n        \n        // Show transition animation\n        setShowSupplementaryTransition(true);\n        setTimeout(() => {\n          setShowSupplementaryTransition(false);\n          setIsSupplementaryMode(true);\n          setCurrentQuestion(10); // Move to first supplementary question\n        }, 3000);\n      } else {\n        // Direct result - no supplementary needed\n        setShowBlindBox(true);\n        submitTestMutation.mutate(answers);\n      }\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"è¯„åˆ†å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const submitTestMutation = useMutation({\n    mutationFn: async (responses: Record<number, any>) => {\n      return await apiRequest(\"POST\", \"/api/personality-test/submit\", {\n        responses,\n      });\n    },\n    onSuccess: (data) => {\n      // Show blind box animation for 3 seconds\n      setTimeout(() => {\n        setLocation(`/personality-test/results`);\n      }, 3000);\n    },\n    onError: (error: Error) => {\n      setShowBlindBox(false);\n      toast({\n        title: \"æäº¤å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const currentQ = questions[currentQuestion];\n  const progress = ((currentQuestion + 1) / questions.length) * 100;\n  \n  // Gamified progress milestones\n  const getProgressLabel = () => {\n    if (isSupplementaryMode) {\n      const suppProgress = currentQuestion - 9;\n      return `ç²¾å‡†å®šä½ ${Math.round((suppProgress / supplementaryQuestions.length) * 100)}%`;\n    }\n    \n    const baseProgress = currentQuestion + 1;\n    if (baseProgress <= 3) return \"æ¢ç´¢ç¤¾äº¤DNA ğŸ§¬\";\n    if (baseProgress <= 5) return \"è§£ææ€§æ ¼å¯†ç  ğŸ”\";\n    if (baseProgress <= 7) return \"ç»˜åˆ¶äººæ ¼å›¾è°± ğŸ—ºï¸\";\n    if (baseProgress <= 9) return \"æ­ç¤ºç¤¾äº¤æ½œèƒ½ âœ¨\";\n    return \"å³å°†å®Œæˆåˆ†æ ğŸ¯\";\n  };\n  const isLastQuestion = currentQuestion === questions.length - 1;\n\n  const handleSingleChoice = (value: string) => {\n    setAnswers({ ...answers, [currentQ.id]: { type: \"single\", value } });\n  };\n\n  const handleDualChoice = (type: \"most\" | \"second\", value: string) => {\n    const current = answers[currentQ.id] || {};\n    const updated = {\n      type: \"dual\",\n      mostLike: type === \"most\" ? value : current.mostLike,\n      secondLike: type === \"second\" ? value : current.secondLike,\n    };\n    setAnswers({ ...answers, [currentQ.id]: updated });\n  };\n\n  const canProceed = () => {\n    const answer = answers[currentQ.id];\n    if (!answer) return false;\n    \n    if (currentQ.questionType === \"single\") {\n      return !!answer.value;\n    } else {\n      return !!answer.mostLike && !!answer.secondLike && answer.mostLike !== answer.secondLike;\n    }\n  };\n\n  const handleNext = () => {\n    if (!canProceed()) return;\n\n    if (isLastQuestion) {\n      // If we're on the last question\n      if (!isSupplementaryMode && currentQuestion === 9) {\n        // Just finished base 10 questions - call preliminary score\n        preliminaryScoreMutation.mutate(answers);\n      } else {\n        // Finished all questions (including supplementary if any)\n        setShowBlindBox(true);\n        submitTestMutation.mutate(answers);\n      }\n    } else {\n      // Show milestone after question 5 (index 4)\n      if (currentQuestion === 4 && !showMilestone && !isSupplementaryMode) {\n        setShowMilestone(true);\n        setTimeout(() => {\n          setShowMilestone(false);\n          setCurrentQuestion(currentQuestion + 1);\n        }, 2500);\n      } else {\n        setCurrentQuestion(currentQuestion + 1);\n      }\n    }\n  };\n\n  const handleBack = () => {\n    if (currentQuestion > 0) {\n      setCurrentQuestion(currentQuestion - 1);\n    }\n  };\n\n  // Blind Box Animation Component\n  const BlindBoxReveal = () => (\n    <motion.div\n      initial={{ opacity: 0 }}\n      animate={{ opacity: 1 }}\n      className=\"fixed inset-0 bg-background/95 backdrop-blur-sm z-50 flex items-center justify-center\"\n    >\n      <div className=\"text-center space-y-6\">\n        <motion.div\n          initial={{ scale: 0.5, rotateY: 0 }}\n          animate={{ \n            scale: [0.5, 1.1, 1],\n            rotateY: [0, 180, 360],\n          }}\n          transition={{ \n            duration: 2,\n            times: [0, 0.5, 1],\n            ease: \"easeInOut\"\n          }}\n          className=\"text-8xl\"\n        >\n          ğŸ\n        </motion.div>\n        \n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 1.5 }}\n          className=\"space-y-2\"\n        >\n          <h2 className=\"text-2xl font-bold\">æ­£åœ¨æ­æ™“ä½ çš„ç¤¾äº¤è§’è‰²...</h2>\n          <p className=\"text-muted-foreground\">âœ¨ å³å°†å‘ç°çœŸå®çš„ä½ </p>\n        </motion.div>\n        \n        <motion.div\n          initial={{ scale: 0 }}\n          animate={{ scale: [0, 1.2, 1] }}\n          transition={{ delay: 2, duration: 0.5 }}\n          className=\"flex justify-center gap-2\"\n        >\n          {[0, 1, 2].map((i) => (\n            <motion.div\n              key={i}\n              animate={{ \n                y: [0, -10, 0],\n                opacity: [0.5, 1, 0.5]\n              }}\n              transition={{\n                duration: 1,\n                repeat: Infinity,\n                delay: i * 0.2\n              }}\n              className=\"w-2 h-2 rounded-full bg-primary\"\n            />\n          ))}\n        </motion.div>\n      </div>\n    </motion.div>\n  );\n\n  // Supplementary Test Transition Animation\n  const SupplementaryTransition = () => (\n    <motion.div\n      initial={{ opacity: 0 }}\n      animate={{ opacity: 1 }}\n      className=\"fixed inset-0 bg-gradient-to-br from-purple-500/10 via-background to-amber-500/10 backdrop-blur-sm z-50 flex items-center justify-center p-4\"\n    >\n      <div className=\"text-center space-y-6 max-w-md\">\n        <motion.div\n          animate={{ \n            rotate: [0, 360],\n            scale: [1, 1.1, 1]\n          }}\n          transition={{\n            duration: 2,\n            repeat: Infinity,\n            ease: \"linear\"\n          }}\n          className=\"text-6xl mx-auto w-20 h-20 flex items-center justify-center\"\n        >\n          ğŸ¯\n        </motion.div>\n        \n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.3 }}\n          className=\"space-y-3\"\n        >\n          <h2 className=\"text-2xl font-bold bg-gradient-to-r from-purple-600 to-amber-600 bg-clip-text text-transparent\">\n            æ£€æµ‹åˆ°åŒé‡äººæ ¼ç‰¹è´¨ï¼\n          </h2>\n          <p className=\"text-muted-foreground\">æ­£åœ¨åˆ†æä½ çš„ç¤¾äº¤æ°›å›´...</p>\n        </motion.div>\n        \n        {candidateArchetypes.length > 0 && (\n          <motion.div\n            initial={{ opacity: 0, scale: 0.8 }}\n            animate={{ opacity: 1, scale: 1 }}\n            transition={{ delay: 0.6 }}\n            className=\"bg-card/50 border border-primary/20 rounded-lg p-4 space-y-3\"\n          >\n            <div className=\"text-sm font-medium text-muted-foreground\">å€™é€‰åŸå‹</div>\n            <div className=\"flex justify-center gap-4\">\n              {candidateArchetypes.map((archetype, index) => (\n                <motion.div\n                  key={archetype.name}\n                  initial={{ x: index === 0 ? -50 : 50, opacity: 0 }}\n                  animate={{ x: 0, opacity: 1 }}\n                  transition={{ delay: 1 + index * 0.2 }}\n                  className=\"text-center\"\n                >\n                  <div className=\"text-3xl mb-1\">\n                    {index === 0 ? \"ğŸ†\" : \"ğŸ¥ˆ\"}\n                  </div>\n                  <div className=\"font-bold text-lg\">{archetype.name}</div>\n                  <div className=\"text-sm text-muted-foreground\">{archetype.score}åˆ†</div>\n                </motion.div>\n              ))}\n            </div>\n          </motion.div>\n        )}\n        \n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          transition={{ delay: 2 }}\n          className=\"text-sm text-muted-foreground\"\n        >\n          è¿›å…¥ç²¾å‡†æ¨¡å¼ï¼Œæ·±å…¥æ¢ç´¢ä½ çš„ç¤¾äº¤DNA...\n        </motion.div>\n      </div>\n    </motion.div>\n  );\n\n  // Milestone Card Component\n  const MilestoneCard = () => (\n    <motion.div\n      initial={{ opacity: 0, scale: 0.8 }}\n      animate={{ opacity: 1, scale: 1 }}\n      exit={{ opacity: 0, scale: 0.8 }}\n      className=\"fixed inset-0 bg-background/80 backdrop-blur-sm z-40 flex items-center justify-center p-4\"\n    >\n      <Card className=\"max-w-md w-full\">\n        <CardContent className=\"pt-6 pb-6 text-center space-y-4\">\n          <motion.div\n            animate={{ \n              rotate: [0, 10, -10, 10, 0],\n              scale: [1, 1.1, 1]\n            }}\n            transition={{ duration: 0.6 }}\n            className=\"text-6xl\"\n          >\n            âœ¨\n          </motion.div>\n          <div className=\"space-y-2\">\n            <h3 className=\"text-xl font-bold\">æœ‰æ„æ€ï¼</h3>\n            <p className=\"text-muted-foreground\">\n              æˆ‘ä»¬å·²ç»å‘ç°äº†ä½ çš„ä¸€ä¸ªéšè—ç‰¹è´¨...\n            </p>\n            <p className=\"text-sm text-primary font-medium\">\n              ç»§ç»­ç­”é¢˜æ­æ™“å®Œæ•´çš„ç¤¾äº¤ç”»åƒ ğŸ\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n    </motion.div>\n  );\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      {/* Blind Box Reveal Overlay */}\n      <AnimatePresence>\n        {showBlindBox && <BlindBoxReveal />}\n      </AnimatePresence>\n\n      {/* Supplementary Test Transition */}\n      <AnimatePresence>\n        {showSupplementaryTransition && <SupplementaryTransition />}\n      </AnimatePresence>\n\n      {/* Milestone Overlay */}\n      <AnimatePresence>\n        {showMilestone && <MilestoneCard />}\n      </AnimatePresence>\n\n      {/* Header */}\n      <div className={`p-4 border-b ${isSupplementaryMode ? 'bg-gradient-to-r from-purple-500/10 to-amber-500/10' : ''}`}>\n        <div className=\"flex items-center justify-between mb-2\">\n          <div className=\"flex items-center gap-3\">\n            <h1 className=\"text-lg font-bold\">\n              {isSupplementaryMode ? (\n                <span className=\"flex items-center gap-2\">\n                  <span className=\"bg-gradient-to-r from-purple-600 to-amber-600 bg-clip-text text-transparent\">\n                    ç²¾å‡†æ¨¡å¼\n                  </span>\n                  <span className=\"text-xl\">ğŸ¯</span>\n                </span>\n              ) : (\n                \"æ€§æ ¼æµ‹è¯„\"\n              )}\n            </h1>\n            {Object.keys(answers).length > 0 && !isSupplementaryMode && (\n              <MiniRadarChart \n                progress={progress}\n                answeredQuestions={Object.keys(answers).length}\n                totalQuestions={questions.length}\n              />\n            )}\n          </div>\n          <span className=\"text-sm text-muted-foreground\">\n            {isSupplementaryMode ? (\n              <span className=\"font-medium bg-gradient-to-r from-purple-600 to-amber-600 bg-clip-text text-transparent\">\n                æ·±å…¥æ¢ç´¢ {currentQuestion - 9}/{supplementaryQuestions.length}\n              </span>\n            ) : (\n              `${currentQuestion + 1}/${questions.length}`\n            )}\n          </span>\n        </div>\n        <div className=\"space-y-1\">\n          <Progress value={progress} className=\"h-2\" />\n          <div className=\"flex items-center justify-between text-xs\">\n            <span className={`font-medium ${isSupplementaryMode ? 'text-purple-600 dark:text-purple-400' : 'text-muted-foreground'}`}>\n              {getProgressLabel()}\n            </span>\n            <span className=\"text-muted-foreground\">\n              {Math.round(progress)}%\n            </span>\n          </div>\n        </div>\n        {isSupplementaryMode && (\n          <motion.div\n            initial={{ opacity: 0, y: -10 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"mt-2 text-xs text-center text-muted-foreground\"\n          >\n            æ­£åœ¨ç²¾å‡†åŒºåˆ†ï¼š{candidateArchetypes[0]?.name} vs {candidateArchetypes[1]?.name}\n          </motion.div>\n        )}\n      </div>\n\n      {/* Question content */}\n      <div className=\"flex-1 p-6 overflow-y-auto\">\n        <div className=\"max-w-2xl mx-auto space-y-6\">\n          <motion.div\n            key={currentQuestion}\n            initial={{ opacity: 0, x: 20 }}\n            animate={{ opacity: 1, x: 0 }}\n            transition={{ duration: 0.3 }}\n          >\n            <div className=\"text-sm text-muted-foreground mb-2\">{currentQ.category}</div>\n            {currentQ.scenarioText && (\n              <p className=\"text-sm text-muted-foreground mb-3 italic leading-relaxed\">\n                {currentQ.scenarioText}\n              </p>\n            )}\n            <h2 className=\"text-xl font-bold mb-6\">{currentQ.questionText}</h2>\n          </motion.div>\n\n          {currentQ.questionType === \"single\" ? (\n            <div className=\"space-y-3\">\n              {currentQ.options.map((option) => {\n                const isSelected = answers[currentQ.id]?.value === option.value;\n                return (\n                  <button\n                    key={option.value}\n                    type=\"button\"\n                    onClick={() => handleSingleChoice(option.value)}\n                    className={`\n                      w-full px-4 py-4 text-left rounded-lg border-2 transition-all text-base flex items-center gap-3\n                      ${isSelected\n                        ? 'border-primary bg-primary/5 text-foreground' \n                        : 'border-border hover-elevate active-elevate-2'\n                      }\n                    `}\n                    data-testid={`button-q${currentQ.id}-${option.value}`}\n                  >\n                    <span className=\"font-semibold\">{option.value}.</span>\n                    <span className=\"flex-1\">{option.text}</span>\n                    {isSelected && (\n                      <span className=\"text-primary font-bold\">âœ“</span>\n                    )}\n                  </button>\n                );\n              })}\n            </div>\n          ) : (\n            <div className=\"space-y-6\">\n              <div>\n                <div className=\"text-sm font-medium mb-3\">æœ€åƒæˆ‘çš„ï¼ˆ2åˆ†ï¼‰</div>\n                <div className=\"space-y-3\">\n                  {currentQ.options.map((option) => {\n                    const isSelected = answers[currentQ.id]?.mostLike === option.value;\n                    const isDisabled = answers[currentQ.id]?.secondLike === option.value;\n                    return (\n                      <button\n                        key={option.value}\n                        type=\"button\"\n                        onClick={() => !isDisabled && handleDualChoice(\"most\", option.value)}\n                        disabled={isDisabled}\n                        className={`\n                          w-full px-4 py-4 text-left rounded-lg border-2 transition-all text-base flex items-center gap-3\n                          ${isDisabled \n                            ? 'opacity-50 cursor-not-allowed border-border' \n                            : isSelected\n                              ? 'border-primary bg-primary/5 text-foreground' \n                              : 'border-border hover-elevate active-elevate-2'\n                          }\n                        `}\n                        data-testid={`button-q${currentQ.id}-most-${option.value}`}\n                      >\n                        <span className=\"font-semibold\">{option.value}.</span>\n                        <span className=\"flex-1\">{option.text}</span>\n                        {isSelected && (\n                          <span className=\"text-primary font-bold\">âœ“</span>\n                        )}\n                      </button>\n                    );\n                  })}\n                </div>\n              </div>\n\n              <div>\n                <div className=\"text-sm font-medium mb-3\">å…¶æ¬¡åƒæˆ‘çš„ï¼ˆ1åˆ†ï¼‰</div>\n                <div className=\"space-y-3\">\n                  {currentQ.options.map((option) => {\n                    const isSelected = answers[currentQ.id]?.secondLike === option.value;\n                    const isDisabled = answers[currentQ.id]?.mostLike === option.value;\n                    return (\n                      <button\n                        key={option.value}\n                        type=\"button\"\n                        onClick={() => !isDisabled && handleDualChoice(\"second\", option.value)}\n                        disabled={isDisabled}\n                        className={`\n                          w-full px-4 py-4 text-left rounded-lg border-2 transition-all text-base flex items-center gap-3\n                          ${isDisabled \n                            ? 'opacity-50 cursor-not-allowed border-border' \n                            : isSelected\n                              ? 'border-primary bg-primary/5 text-foreground' \n                              : 'border-border hover-elevate active-elevate-2'\n                          }\n                        `}\n                        data-testid={`button-q${currentQ.id}-second-${option.value}`}\n                      >\n                        <span className=\"font-semibold\">{option.value}.</span>\n                        <span className=\"flex-1\">{option.text}</span>\n                        {isSelected && (\n                          <span className=\"text-primary font-bold\">âœ“</span>\n                        )}\n                      </button>\n                    );\n                  })}\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Navigation buttons */}\n      <div className=\"border-t p-4 bg-background\">\n        <div className=\"max-w-2xl mx-auto flex gap-3\">\n          <Button\n            variant=\"outline\"\n            onClick={handleBack}\n            disabled={currentQuestion === 0}\n            className=\"flex-1\"\n            data-testid=\"button-back\"\n          >\n            <ChevronLeft className=\"h-4 w-4 mr-2\" />\n            ä¸Šä¸€é¢˜\n          </Button>\n          <Button\n            onClick={handleNext}\n            disabled={!canProceed() || submitTestMutation.isPending}\n            className=\"flex-1\"\n            data-testid=\"button-next\"\n          >\n            {isLastQuestion ? (\n              submitTestMutation.isPending ? \"æäº¤ä¸­...\" : \"å®Œæˆæµ‹è¯•\"\n            ) : (\n              <>\n                ä¸‹ä¸€é¢˜\n                <ChevronRight className=\"h-4 w-4 ml-2\" />\n              </>\n            )}\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":21615},"client/src/components/PendingMatchCard.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { MapPin, Users, DollarSign, X, Edit, Languages, Utensils, Flame } from \"lucide-react\";\nimport { Progress } from \"@/components/ui/progress\";\nimport type { BlindBoxEvent } from \"@shared/schema\";\nimport { getCurrencySymbol } from \"@/lib/currency\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport EditPreferencesDialog from \"@/components/EditPreferencesDialog\";\n\ninterface PendingMatchCardProps {\n  event: BlindBoxEvent;\n  onCancel: (eventId: string) => void;\n}\n\nexport default function PendingMatchCard({ event, onCancel }: PendingMatchCardProps) {\n  const currencySymbol = getCurrencySymbol(event.city as \"é¦™æ¸¯\" | \"æ·±åœ³\");\n  \n  // Progress based on minimum 4 people needed to start\n  const currentParticipants = event.currentParticipants || 1;\n  const minParticipants = 4;\n  const progress = Math.min((currentParticipants / minParticipants) * 100, 100);\n  \n  const etaText = event.etaMinutes \n    ? `é¢„è®¡${Math.floor(event.etaMinutes / 60)}-${Math.floor(event.etaMinutes / 60) + 1}å°æ—¶`\n    : \"é¢„è®¡1-3å°æ—¶\";\n\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [detailsOpen, setDetailsOpen] = useState(false);\n\n  const hasPreferences = (event.selectedLanguages && event.selectedLanguages.length > 0) ||\n    (event.selectedTasteIntensity && event.selectedTasteIntensity.length > 0) ||\n    (event.selectedCuisines && event.selectedCuisines.length > 0);\n\n  return (\n    <>\n      <Card className=\"border shadow-sm\" data-testid={`card-pending-${event.id}`}>\n        <CardContent className=\"p-4 space-y-3\">\n          {/* æ ‡é¢˜ */}\n          <div className=\"flex items-start justify-between gap-3\">\n            <div className=\"flex-1\">\n              <h3 className=\"text-base font-semibold\" data-testid=\"text-event-title\">{event.title}</h3>\n            </div>\n            <Badge variant=\"secondary\" className=\"text-xs bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-300\">\n              åŒ¹é…ä¸­\n            </Badge>\n          </div>\n\n          {/* åœ°åŒº/å•†åœˆ */}\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <MapPin className=\"h-4 w-4\" />\n            <span>{event.city}â€¢{event.district}</span>\n            {event.acceptNearby && (\n              <Badge variant=\"outline\" className=\"text-xs\">å«ç›¸é‚»å•†åœˆ</Badge>\n            )}\n          </div>\n\n          {/* é¢„ç®—æ¡£ */}\n          <div className=\"flex items-center gap-2 text-sm\">\n            <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"font-medium\" data-testid=\"text-budget\">{currencySymbol}{event.budgetTier}</span>\n          </div>\n\n          {/* ç›®æ ‡äººæ•° */}\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n            <Users className=\"h-4 w-4\" />\n            <span>4-6äºº</span>\n          </div>\n\n          {/* å·²é‚€è¯· */}\n          {(event.invitedCount || 0) > 0 && (\n            <div className=\"flex items-center gap-2 text-sm\" data-testid=\"text-invited\">\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"text-foreground\">\n                å·²é‚€è¯·{event.invitedCount}äºº\n                {(event.invitedJoined || 0) > 0 ? (\n                  <span className=\"text-primary\"> Â· {event.invitedJoined}äººå·²åŠ å…¥</span>\n                ) : (\n                  <span className=\"text-muted-foreground\"> Â· å°šæœªåŠ å…¥</span>\n                )}\n              </span>\n            </div>\n          )}\n\n          {/* æˆ‘çš„åå¥½ - å¯æŠ˜å  */}\n          {hasPreferences && (\n            <Collapsible open={detailsOpen} onOpenChange={setDetailsOpen}>\n              <CollapsibleTrigger asChild>\n                <Button \n                  variant=\"ghost\" \n                  size=\"sm\" \n                  className=\"w-full justify-between p-2 h-auto text-muted-foreground hover:text-foreground\"\n                  data-testid=\"button-toggle-preferences\"\n                >\n                  <span className=\"text-sm\">æˆ‘çš„åå¥½</span>\n                  <span className=\"text-xs\">{detailsOpen ? 'æ”¶èµ·' : 'å±•å¼€'}</span>\n                </Button>\n              </CollapsibleTrigger>\n              <CollapsibleContent className=\"space-y-2 mt-2\">\n                {/* è¯­è¨€åå¥½ */}\n                {event.selectedLanguages && event.selectedLanguages.length > 0 && (\n                  <div className=\"flex items-start gap-2 text-sm\">\n                    <Languages className=\"h-4 w-4 text-muted-foreground mt-0.5\" />\n                    <div className=\"flex-1\">\n                      <div className=\"text-muted-foreground mb-1\">è¯­è¨€</div>\n                      <div className=\"flex flex-wrap gap-1\">\n                        {event.selectedLanguages.map((lang) => (\n                          <Badge key={lang} variant=\"outline\" className=\"text-xs\">{lang}</Badge>\n                        ))}\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                {/* å£å‘³åå¥½ */}\n                {event.selectedTasteIntensity && event.selectedTasteIntensity.length > 0 && (\n                  <div className=\"flex items-start gap-2 text-sm\">\n                    <Flame className=\"h-4 w-4 text-muted-foreground mt-0.5\" />\n                    <div className=\"flex-1\">\n                      <div className=\"text-muted-foreground mb-1\">å£å‘³</div>\n                      <div className=\"flex flex-wrap gap-1\">\n                        {event.selectedTasteIntensity.map((taste) => (\n                          <Badge key={taste} variant=\"outline\" className=\"text-xs\">{taste}</Badge>\n                        ))}\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                {/* èœç³»åå¥½ */}\n                {event.selectedCuisines && event.selectedCuisines.length > 0 && (\n                  <div className=\"flex items-start gap-2 text-sm\">\n                    <Utensils className=\"h-4 w-4 text-muted-foreground mt-0.5\" />\n                    <div className=\"flex-1\">\n                      <div className=\"text-muted-foreground mb-1\">èœç³»</div>\n                      <div className=\"flex flex-wrap gap-1\">\n                        {event.selectedCuisines.map((cuisine) => (\n                          <Badge key={cuisine} variant=\"outline\" className=\"text-xs\">{cuisine}</Badge>\n                        ))}\n                      </div>\n                    </div>\n                  </div>\n                )}\n              </CollapsibleContent>\n            </Collapsible>\n          )}\n\n          {/* åŒ¹é…è¿›åº¦ */}\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between text-sm\">\n              <span className=\"text-muted-foreground\">æ­£åœ¨ä¸ºä½ åŒ¹é…åŒé¢‘ä¼™ä¼´â€¦</span>\n              <span className=\"text-xs font-medium\">{currentParticipants}/{minParticipants}äºº</span>\n            </div>\n            <Progress value={progress} className=\"h-2\" />\n            <div className=\"text-xs text-muted-foreground text-right\">{etaText}</div>\n          </div>\n\n          {/* æ“ä½œæŒ‰é’® */}\n          <div className=\"flex gap-2 pt-2\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              className=\"flex-1\"\n              onClick={() => setShowEditDialog(true)}\n              data-testid={`button-edit-${event.id}`}\n            >\n              <Edit className=\"h-4 w-4 mr-1\" />\n              ä¿®æ”¹åå¥½\n            </Button>\n            <AlertDialog>\n              <AlertDialogTrigger asChild>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  className=\"flex-1 text-destructive hover:text-destructive\"\n                  data-testid={`button-cancel-${event.id}`}\n                >\n                  <X className=\"h-4 w-4 mr-1\" />\n                  å–æ¶ˆæŠ¥å\n                </Button>\n              </AlertDialogTrigger>\n              <AlertDialogContent>\n                <AlertDialogHeader>\n                  <AlertDialogTitle>ç¡®è®¤å–æ¶ˆæŠ¥åï¼Ÿ</AlertDialogTitle>\n                  <AlertDialogDescription>\n                    å–æ¶ˆåå°†é€€è¿˜å…¨é¢è´¹ç”¨ã€‚ç¡®å®šè¦å–æ¶ˆå—ï¼Ÿ\n                  </AlertDialogDescription>\n                </AlertDialogHeader>\n                <AlertDialogFooter>\n                  <AlertDialogCancel>å†æƒ³æƒ³</AlertDialogCancel>\n                  <AlertDialogAction \n                    onClick={() => onCancel(event.id)}\n                    className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                  >\n                    ç¡®è®¤å–æ¶ˆ\n                  </AlertDialogAction>\n                </AlertDialogFooter>\n              </AlertDialogContent>\n            </AlertDialog>\n          </div>\n        </CardContent>\n      </Card>\n\n      <EditPreferencesDialog\n        open={showEditDialog}\n        onOpenChange={setShowEditDialog}\n        event={event}\n      />\n    </>\n  );\n}\n","size_bytes":9456},"client/src/pages/InterestsTopicsPage.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { interestsTopicsSchema, type InterestsTopics } from \"@shared/schema\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Check, ChevronUp, ChevronDown, Info } from \"lucide-react\";\nimport { Separator } from \"@/components/ui/separator\";\n\n// Interest categories with emojis\nconst INTERESTS_OPTIONS = [\n  { id: \"outdoor_adventure\", label: \"æˆ·å¤–å†’é™©\", emoji: \"ğŸ”ï¸\" },\n  { id: \"sports_fitness\", label: \"è¿åŠ¨å¥èº«\", emoji: \"âš½\" },\n  { id: \"food_dining\", label: \"ç¾é£Ÿæ¢åº—\", emoji: \"ğŸœ\" },\n  { id: \"arts_culture\", label: \"è‰ºæœ¯æ–‡åŒ–\", emoji: \"ğŸ¨\" },\n  { id: \"music_concerts\", label: \"éŸ³ä¹ç°åœº\", emoji: \"ğŸµ\" },\n  { id: \"reading_books\", label: \"é˜…è¯»ä¹¦ç±\", emoji: \"ğŸ“š\" },\n  { id: \"tech_gadgets\", label: \"ç§‘æŠ€æ•°ç \", emoji: \"ğŸ’»\" },\n  { id: \"games_board\", label: \"æ¡Œæ¸¸å¡ç‰Œ\", emoji: \"ğŸ²\" },\n  { id: \"games_video\", label: \"ç”µå­æ¸¸æˆ\", emoji: \"ğŸ®\" },\n  { id: \"photography\", label: \"æ‘„å½±æ‹ç…§\", emoji: \"ğŸ“·\" },\n  { id: \"travel\", label: \"æ—…è¡Œæ¢ç´¢\", emoji: \"âœˆï¸\" },\n  { id: \"diy_crafts\", label: \"æ‰‹å·¥DIY\", emoji: \"âœ‚ï¸\" },\n  { id: \"pets_animals\", label: \"å® ç‰©åŠ¨ç‰©\", emoji: \"ğŸ¶\" },\n  { id: \"volunteering\", label: \"å¿—æ„¿å…¬ç›Š\", emoji: \"ğŸ¤\" },\n  { id: \"entrepreneurship\", label: \"åˆ›ä¸šå•†ä¸š\", emoji: \"ğŸ’¡\" },\n  { id: \"investing\", label: \"æŠ•èµ„ç†è´¢\", emoji: \"ğŸ’°\" },\n  { id: \"meditation\", label: \"å†¥æƒ³æ­£å¿µ\", emoji: \"ğŸ§˜\" },\n  { id: \"languages\", label: \"è¯­è¨€å­¦ä¹ \", emoji: \"ğŸ—£ï¸\" },\n];\n\n// Conversation topics\nconst TOPICS_OPTIONS = [\n  { id: \"career_growth\", label: \"èŒä¸šå‘å±•\", category: \"work\" },\n  { id: \"startup_ideas\", label: \"åˆ›ä¸šæƒ³æ³•\", category: \"work\" },\n  { id: \"tech_trends\", label: \"ç§‘æŠ€è¶‹åŠ¿\", category: \"tech\" },\n  { id: \"ai_future\", label: \"AIä¸æœªæ¥\", category: \"tech\" },\n  { id: \"relationships\", label: \"äººé™…å…³ç³»\", category: \"personal\" },\n  { id: \"dating_love\", label: \"æ‹çˆ±æƒ…æ„Ÿ\", category: \"personal\" },\n  { id: \"mental_health\", label: \"å¿ƒç†å¥åº·\", category: \"personal\" },\n  { id: \"life_philosophy\", label: \"äººç”Ÿå“²å­¦\", category: \"personal\" },\n  { id: \"movies_shows\", label: \"å½±è§†å‰§é›†\", category: \"entertainment\" },\n  { id: \"music_taste\", label: \"éŸ³ä¹å“å‘³\", category: \"entertainment\" },\n  { id: \"travel_stories\", label: \"æ—…è¡Œæ•…äº‹\", category: \"lifestyle\" },\n  { id: \"food_culture\", label: \"ç¾é£Ÿæ–‡åŒ–\", category: \"lifestyle\" },\n  { id: \"fashion_style\", label: \"æ—¶å°šç©¿æ­\", category: \"lifestyle\" },\n  { id: \"current_events\", label: \"æ—¶äº‹æ–°é—»\", category: \"society\" },\n  { id: \"politics\", label: \"æ”¿æ²»è¯é¢˜\", category: \"society\" },\n  { id: \"social_issues\", label: \"ç¤¾ä¼šè®®é¢˜\", category: \"society\" },\n  { id: \"parenting\", label: \"è‚²å„¿ç»éªŒ\", category: \"family\" },\n  { id: \"hobbies_deep\", label: \"å°ä¼—çˆ±å¥½\", category: \"other\" },\n];\n\nexport default function InterestsTopicsPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [step, setStep] = useState(1);\n  const totalSteps = 2;\n\n  const [selectedInterests, setSelectedInterests] = useState<string[]>([]);\n  const [rankedTop3, setRankedTop3] = useState<string[]>([]);\n  const [selectedTopicsHappy, setSelectedTopicsHappy] = useState<string[]>([]);\n  const [selectedTopicsAvoid, setSelectedTopicsAvoid] = useState<string[]>([]);\n\n  const form = useForm<InterestsTopics>({\n    resolver: zodResolver(interestsTopicsSchema),\n    defaultValues: {\n      interestsTop: [],\n      interestsRankedTop3: [],\n      topicsHappy: [],\n      topicsAvoid: [],\n    },\n  });\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: InterestsTopics) => {\n      return await apiRequest(\"POST\", \"/api/user/interests-topics\", data);\n    },\n    onSuccess: async () => {\n      await queryClient.invalidateQueries({ queryKey: ['/api/auth/user'] });\n      \n      toast({\n        title: \"ä¿å­˜æˆåŠŸï¼\",\n        description: \"ç°åœ¨è®©æˆ‘ä»¬äº†è§£ä½ çš„ç¤¾äº¤é£æ ¼\",\n      });\n      \n      setLocation(\"/personality-test\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"ä¿å­˜å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const toggleInterest = (interestId: string) => {\n    setSelectedInterests(prev => {\n      if (prev.includes(interestId)) {\n        // Remove from selected\n        const newSelected = prev.filter(id => id !== interestId);\n        // Also remove from ranked if it was there\n        setRankedTop3(ranked => ranked.filter(id => id !== interestId));\n        return newSelected;\n      } else {\n        // Add to selected (max 7)\n        if (prev.length >= 7) {\n          toast({\n            title: \"æœ€å¤šé€‰æ‹©7ä¸ªå…´è¶£\",\n            variant: \"destructive\",\n          });\n          return prev;\n        }\n        return [...prev, interestId];\n      }\n    });\n  };\n\n  const toggleTopicHappy = (topicId: string) => {\n    setSelectedTopicsHappy(prev => {\n      if (prev.includes(topicId)) {\n        return prev.filter(id => id !== topicId);\n      } else {\n        // Remove from avoid list if it was there\n        setSelectedTopicsAvoid(avoid => avoid.filter(id => id !== topicId));\n        return [...prev, topicId];\n      }\n    });\n  };\n\n  const toggleTopicAvoid = (topicId: string) => {\n    setSelectedTopicsAvoid(prev => {\n      if (prev.includes(topicId)) {\n        return prev.filter(id => id !== topicId);\n      } else {\n        // Remove from happy list if it was there\n        setSelectedTopicsHappy(happy => happy.filter(id => id !== topicId));\n        return [...prev, topicId];\n      }\n    });\n  };\n\n  const addToRanking = (interestId: string) => {\n    if (rankedTop3.length >= 3) {\n      toast({\n        title: \"æœ€å¤šæ’åº3ä¸ªå…´è¶£\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    if (!rankedTop3.includes(interestId)) {\n      setRankedTop3([...rankedTop3, interestId]);\n    }\n  };\n\n  const removeFromRanking = (interestId: string) => {\n    setRankedTop3(rankedTop3.filter(id => id !== interestId));\n  };\n\n  const moveUpInRanking = (index: number) => {\n    if (index === 0) return;\n    const newRanked = [...rankedTop3];\n    [newRanked[index - 1], newRanked[index]] = [newRanked[index], newRanked[index - 1]];\n    setRankedTop3(newRanked);\n  };\n\n  const moveDownInRanking = (index: number) => {\n    if (index === rankedTop3.length - 1) return;\n    const newRanked = [...rankedTop3];\n    [newRanked[index], newRanked[index + 1]] = [newRanked[index + 1], newRanked[index]];\n    setRankedTop3(newRanked);\n  };\n\n  const handleNext = () => {\n    if (step === 1) {\n      // Validate interests step\n      if (selectedInterests.length < 3) {\n        toast({\n          title: \"è¯·è‡³å°‘é€‰æ‹©3ä¸ªå…´è¶£\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      if (rankedTop3.length < 3) {\n        toast({\n          title: \"è¯·ä»ä½ é€‰æ‹©çš„å…´è¶£ä¸­æ’åºå‡ºæœ€å–œæ¬¢çš„3ä¸ª\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      setStep(2);\n    } else {\n      // Validate topics step\n      if (selectedTopicsHappy.length < 1) {\n        toast({\n          title: \"è¯·è‡³å°‘é€‰æ‹©1ä¸ªä½ å–œæ¬¢è®¨è®ºçš„è¯é¢˜\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      \n      // Submit the form\n      saveMutation.mutate({\n        interestsTop: selectedInterests,\n        interestsRankedTop3: rankedTop3,\n        topicsHappy: selectedTopicsHappy,\n        topicsAvoid: selectedTopicsAvoid,\n      });\n    }\n  };\n\n  const handleBack = () => {\n    if (step > 1) {\n      setStep(step - 1);\n    }\n  };\n\n  const progress = (step / totalSteps) * 100;\n\n  const getInterestLabel = (id: string) => {\n    const interest = INTERESTS_OPTIONS.find(i => i.id === id);\n    return interest ? `${interest.emoji} ${interest.label}` : id;\n  };\n\n  const getTopicLabel = (id: string) => {\n    const topic = TOPICS_OPTIONS.find(t => t.id === id);\n    return topic ? topic.label : id;\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      {/* Header with progress */}\n      <div className=\"p-4 border-b bg-background sticky top-0 z-10\">\n        <div className=\"flex items-center justify-between mb-2\">\n          <h1 className=\"text-lg font-bold\">å…´è¶£ & è¯é¢˜</h1>\n          <span className=\"text-sm text-muted-foreground\">\n            {step}/{totalSteps}\n          </span>\n        </div>\n        <Progress value={progress} className=\"h-2\" data-testid=\"progress-bar\" />\n      </div>\n\n      {/* Form content */}\n      <div className=\"flex-1 p-4 overflow-y-auto\">\n        <div className=\"max-w-2xl mx-auto space-y-6 pb-20\">\n          {/* Step 1: Interests Selection & Ranking */}\n          {step === 1 && (\n            <div className=\"space-y-6 animate-in fade-in-50 duration-300\">\n              <div>\n                <h2 className=\"text-xl font-bold mb-2\">ä½ çš„å…´è¶£</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  é€‰æ‹©3-7ä¸ªä½ æ„Ÿå…´è¶£çš„æ´»åŠ¨ç±»å‹ï¼Œç„¶åæ’åºå‡ºæœ€å–œæ¬¢çš„3ä¸ª\n                </p>\n              </div>\n\n              {/* Interest Selection */}\n              <div>\n                <Label>é€‰æ‹©å…´è¶£ï¼ˆ3-7ä¸ªï¼‰</Label>\n                <p className=\"text-xs text-muted-foreground mb-3\">\n                  å·²é€‰æ‹© {selectedInterests.length} ä¸ª\n                </p>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  {INTERESTS_OPTIONS.map((interest) => {\n                    const isSelected = selectedInterests.includes(interest.id);\n                    return (\n                      <button\n                        key={interest.id}\n                        type=\"button\"\n                        onClick={() => toggleInterest(interest.id)}\n                        data-testid={`button-interest-${interest.id}`}\n                        className={`\n                          px-4 py-2.5 rounded-lg border-2 transition-all text-left\n                          ${isSelected \n                            ? 'border-primary bg-primary/5' \n                            : 'border-border hover-elevate active-elevate-2'\n                          }\n                        `}\n                      >\n                        <div className=\"flex items-center justify-between\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-xl\">{interest.emoji}</span>\n                            <span className=\"text-base font-medium\">{interest.label}</span>\n                          </div>\n                          {isSelected && (\n                            <Check className=\"h-4 w-4 text-primary flex-shrink-0\" />\n                          )}\n                        </div>\n                      </button>\n                    );\n                  })}\n                </div>\n              </div>\n\n              {/* Ranking Section */}\n              {selectedInterests.length >= 3 && (\n                <>\n                  <Separator />\n                  <div>\n                    <Label>æ’åºæœ€å–œæ¬¢çš„3ä¸ª</Label>\n                    <p className=\"text-xs text-muted-foreground mb-3\">\n                      ä»ä¸Šé¢é€‰æ‹©çš„å…´è¶£ä¸­ï¼Œç‚¹å‡»æ·»åŠ å¹¶æ’åºä½ æœ€å–œæ¬¢çš„3ä¸ª\n                    </p>\n\n                    {/* Ranked list */}\n                    {rankedTop3.length > 0 && (\n                      <Card className=\"mb-3\">\n                        <CardContent className=\"p-3 space-y-2\">\n                          {rankedTop3.map((interestId, index) => (\n                            <div\n                              key={interestId}\n                              className=\"flex items-center gap-2 p-2 bg-muted/50 rounded-md\"\n                              data-testid={`ranked-interest-${index}`}\n                            >\n                              <Badge variant=\"outline\" className=\"w-6 h-6 flex items-center justify-center p-0\">\n                                {index + 1}\n                              </Badge>\n                              <span className=\"flex-1 text-sm\">\n                                {getInterestLabel(interestId)}\n                              </span>\n                              <div className=\"flex gap-1\">\n                                <Button\n                                  type=\"button\"\n                                  size=\"icon\"\n                                  variant=\"ghost\"\n                                  onClick={() => moveUpInRanking(index)}\n                                  disabled={index === 0}\n                                  className=\"h-7 w-7\"\n                                  data-testid={`button-move-up-${index}`}\n                                >\n                                  <ChevronUp className=\"h-3 w-3\" />\n                                </Button>\n                                <Button\n                                  type=\"button\"\n                                  size=\"icon\"\n                                  variant=\"ghost\"\n                                  onClick={() => moveDownInRanking(index)}\n                                  disabled={index === rankedTop3.length - 1}\n                                  className=\"h-7 w-7\"\n                                  data-testid={`button-move-down-${index}`}\n                                >\n                                  <ChevronDown className=\"h-3 w-3\" />\n                                </Button>\n                                <Button\n                                  type=\"button\"\n                                  size=\"sm\"\n                                  variant=\"ghost\"\n                                  onClick={() => removeFromRanking(interestId)}\n                                  className=\"h-7 px-2 text-xs\"\n                                  data-testid={`button-remove-${index}`}\n                                >\n                                  ç§»é™¤\n                                </Button>\n                              </div>\n                            </div>\n                          ))}\n                        </CardContent>\n                      </Card>\n                    )}\n\n                    {/* Available to rank */}\n                    {rankedTop3.length < 3 && (\n                      <div className=\"grid grid-cols-2 gap-3\">\n                        {selectedInterests\n                          .filter(id => !rankedTop3.includes(id))\n                          .map((interestId) => (\n                            <button\n                              key={interestId}\n                              type=\"button\"\n                              onClick={() => addToRanking(interestId)}\n                              data-testid={`button-add-to-rank-${interestId}`}\n                              className=\"px-4 py-2.5 text-base rounded-md border border-border hover-elevate active-elevate-2 text-left\"\n                            >\n                              {getInterestLabel(interestId)}\n                            </button>\n                          ))}\n                      </div>\n                    )}\n                  </div>\n                </>\n              )}\n            </div>\n          )}\n\n          {/* Step 2: Topics Preferences */}\n          {step === 2 && (\n            <div className=\"space-y-6 animate-in fade-in-50 duration-300\">\n              <div>\n                <h2 className=\"text-xl font-bold mb-2\">å¯¹è¯è¯é¢˜</h2>\n                <p className=\"text-sm text-muted-foreground\">\n                  å‘Šè¯‰æˆ‘ä»¬ä½ å–œæ¬¢å’Œå›é¿çš„è¯é¢˜ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°åŒ¹é…æ´»åŠ¨\n                </p>\n              </div>\n\n              <div className=\"flex items-start space-x-2 bg-primary/5 p-3 rounded-md border border-primary/20\">\n                <Info className=\"h-4 w-4 text-primary mt-0.5 flex-shrink-0\" />\n                <p className=\"text-xs text-muted-foreground\">\n                  é€‰æ‹©è¯é¢˜æ—¶ï¼Œç»¿è‰²æŒ‰é’®è¡¨ç¤ºå–œæ¬¢è®¨è®ºï¼Œçº¢è‰²è¡¨ç¤ºæƒ³è¦å›é¿ã€‚åŒä¸€ä¸ªè¯é¢˜ä¸èƒ½åŒæ—¶é€‰æ‹©ä¸¤ç§çŠ¶æ€ã€‚\n                </p>\n              </div>\n\n              {/* Topics Happy */}\n              <div>\n                <Label>å–œæ¬¢è®¨è®ºçš„è¯é¢˜ *</Label>\n                <p className=\"text-xs text-muted-foreground mb-3\">\n                  å·²é€‰æ‹© {selectedTopicsHappy.length} ä¸ªï¼ˆè‡³å°‘é€‰1ä¸ªï¼‰\n                </p>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  {TOPICS_OPTIONS.map((topic) => {\n                    const isHappy = selectedTopicsHappy.includes(topic.id);\n                    const isAvoid = selectedTopicsAvoid.includes(topic.id);\n                    return (\n                      <button\n                        key={topic.id}\n                        type=\"button\"\n                        onClick={() => toggleTopicHappy(topic.id)}\n                        data-testid={`button-topic-happy-${topic.id}`}\n                        className={`\n                          px-4 py-2.5 text-base rounded-md border-2 transition-all text-left\n                          ${isHappy \n                            ? 'border-green-500 bg-green-500/10 text-green-700 dark:text-green-400' \n                            : isAvoid\n                            ? 'border-border/50 opacity-50'\n                            : 'border-border hover-elevate active-elevate-2'\n                          }\n                        `}\n                      >\n                        {topic.label}\n                      </button>\n                    );\n                  })}\n                </div>\n              </div>\n\n              <Separator />\n\n              {/* Topics Avoid */}\n              <div>\n                <Label>æƒ³è¦å›é¿çš„è¯é¢˜ï¼ˆå¯é€‰ï¼‰</Label>\n                <p className=\"text-xs text-muted-foreground mb-3\">\n                  å·²é€‰æ‹© {selectedTopicsAvoid.length} ä¸ª\n                </p>\n                <div className=\"grid grid-cols-2 gap-3\">\n                  {TOPICS_OPTIONS.map((topic) => {\n                    const isHappy = selectedTopicsHappy.includes(topic.id);\n                    const isAvoid = selectedTopicsAvoid.includes(topic.id);\n                    return (\n                      <button\n                        key={topic.id}\n                        type=\"button\"\n                        onClick={() => toggleTopicAvoid(topic.id)}\n                        data-testid={`button-topic-avoid-${topic.id}`}\n                        className={`\n                          px-4 py-2.5 text-base rounded-md border-2 transition-all text-left\n                          ${isAvoid \n                            ? 'border-red-500 bg-red-500/10 text-red-700 dark:text-red-400' \n                            : isHappy\n                            ? 'border-border/50 opacity-50'\n                            : 'border-border hover-elevate active-elevate-2'\n                          }\n                        `}\n                      >\n                        {topic.label}\n                      </button>\n                    );\n                  })}\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Navigation buttons */}\n      <div className=\"border-t p-4 bg-background sticky bottom-0\">\n        <div className=\"max-w-2xl mx-auto flex gap-3\">\n          {step > 1 && (\n            <Button\n              variant=\"outline\"\n              onClick={handleBack}\n              className=\"flex-1\"\n              data-testid=\"button-back\"\n            >\n              ä¸Šä¸€æ­¥\n            </Button>\n          )}\n          <Button\n            onClick={handleNext}\n            className=\"flex-1\"\n            disabled={saveMutation.isPending}\n            data-testid=\"button-next\"\n          >\n            {step === totalSteps ? (\n              saveMutation.isPending ? \"ä¿å­˜ä¸­...\" : \"å®Œæˆ\"\n            ) : (\n              \"ä¸‹ä¸€æ­¥\"\n            )}\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":20366},"client/src/components/MatchedEventCard.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { MapPin, Clock, DollarSign, Users, Navigation, Share2 } from \"lucide-react\";\nimport type { BlindBoxEvent } from \"@shared/schema\";\nimport { getCurrencySymbol } from \"@/lib/currency\";\nimport { useLocation } from \"wouter\";\n\ninterface MatchedEventCardProps {\n  event: BlindBoxEvent;\n}\n\nexport default function MatchedEventCard({ event }: MatchedEventCardProps) {\n  const [, setLocation] = useLocation();\n  const currencySymbol = getCurrencySymbol(event.city as \"é¦™æ¸¯\" | \"æ·±åœ³\");\n\n  const formatDate = (dateTime: Date) => {\n    const date = new Date(dateTime);\n    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];\n    const weekday = weekdays[date.getDay()];\n    const hours = date.getHours().toString().padStart(2, '0');\n    const minutes = date.getMinutes().toString().padStart(2, '0');\n    return `${weekday} ${hours}:${minutes}`;\n  };\n\n  const getCountdown = (dateTime: Date) => {\n    const now = new Date();\n    const eventDate = new Date(dateTime);\n    const diff = eventDate.getTime() - now.getTime();\n    \n    if (diff <= 0) return \"æ´»åŠ¨è¿›è¡Œä¸­\";\n    \n    const days = Math.floor(diff / (1000 * 60 * 60 * 24));\n    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n    \n    if (days > 0) {\n      return `è¿˜å‰© ${days}å¤© ${hours}å°æ—¶`;\n    } else {\n      return `è¿˜å‰© ${hours}å°æ—¶`;\n    }\n  };\n\n  const getParticipantInfo = () => {\n    if (event.isGirlsNight) {\n      return `${event.totalParticipants}äºº Girls Night`;\n    }\n    if (event.maleCount && event.femaleCount) {\n      return `${event.totalParticipants}äººï¼ˆ${event.maleCount}ç”·${event.femaleCount}å¥³ï¼‰`;\n    }\n    return `${event.totalParticipants}äºº`;\n  };\n\n  const handleNavigation = () => {\n    if (event.restaurantLat && event.restaurantLng) {\n      const restaurantName = encodeURIComponent(event.restaurantName || 'ç›®çš„åœ°');\n      \n      // æ·±åœ³ä½¿ç”¨é«˜å¾·åœ°å›¾ï¼Œé¦™æ¸¯ä½¿ç”¨Google Maps\n      if (event.city === 'æ·±åœ³') {\n        window.open(`https://uri.amap.com/navigation?to=${event.restaurantLng},${event.restaurantLat},${restaurantName}&mode=car&coordinate=gaode`, '_blank');\n      } else {\n        window.open(`https://www.google.com/maps/dir/?api=1&destination=${event.restaurantLat},${event.restaurantLng}`, '_blank');\n      }\n    }\n  };\n\n  return (\n    <Card \n      className=\"border shadow-sm hover-elevate active-elevate-2 cursor-pointer\" \n      onClick={() => setLocation(`/blind-box-events/${event.id}`)}\n      data-testid={`card-matched-${event.id}`}\n    >\n      <CardContent className=\"p-4 space-y-3\">\n        {/* æ ‡é¢˜å’Œå€’è®¡æ—¶ */}\n        <div className=\"space-y-1\">\n          <div className=\"flex items-start justify-between gap-3\">\n            <h3 className=\"text-base font-semibold flex-1\">{formatDate(event.dateTime)} Â· {event.eventType}</h3>\n            {event.isGirlsNight && (\n              <Badge className=\"text-xs bg-pink-500 hover:bg-pink-600\">\n                ğŸ‘­ Girls Night\n              </Badge>\n            )}\n          </div>\n          <div className=\"flex items-center gap-2 text-sm\">\n            <Clock className=\"h-4 w-4 text-primary\" />\n            <span className=\"font-medium text-primary\">{getCountdown(event.dateTime)}</span>\n          </div>\n        </div>\n\n        {/* äººæ•°ä¸æ€§åˆ« */}\n        <div className=\"flex items-center gap-2 text-sm\">\n          <Users className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"font-medium\">{getParticipantInfo()}</span>\n        </div>\n\n        {/* åœ°ç‚¹ */}\n        <div className=\"space-y-1\">\n          <div className=\"flex items-center gap-2 text-sm\">\n            <MapPin className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"font-medium\">{event.restaurantName}</span>\n          </div>\n          <div className=\"text-xs text-muted-foreground pl-6\">\n            {event.city}â€¢{event.district}\n          </div>\n        </div>\n\n        {/* é¢„ç®—æ¡£ */}\n        <div className=\"flex items-center gap-2 text-sm\">\n          <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n          <span>{currencySymbol}{event.budgetTier}</span>\n        </div>\n\n        {/* èœå¼æ ‡ç­¾ */}\n        {event.cuisineTags && event.cuisineTags.length > 0 && (\n          <div className=\"flex flex-wrap gap-1.5\">\n            {event.cuisineTags.map((tag, index) => (\n              <Badge key={index} variant=\"secondary\" className=\"text-xs\">\n                {tag}\n              </Badge>\n            ))}\n          </div>\n        )}\n\n        {/* æ“ä½œæŒ‰é’® */}\n        <div className=\"flex gap-2 pt-2\">\n          <Button \n            size=\"sm\" \n            className=\"flex-1\"\n            onClick={(e) => {\n              e.stopPropagation();\n              setLocation(`/blind-box-events/${event.id}`);\n            }}\n            data-testid={`button-view-details-${event.id}`}\n          >\n            æŸ¥çœ‹è¯¦æƒ…\n          </Button>\n          <Button \n            size=\"sm\" \n            variant=\"outline\"\n            onClick={(e) => {\n              e.stopPropagation();\n              handleNavigation();\n            }}\n            data-testid={`button-navigation-${event.id}`}\n          >\n            <Navigation className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":5453},"client/src/components/AttendeePreviewCard.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { User, Briefcase, RotateCw, GraduationCap, MapPin } from \"lucide-react\";\nimport {\n  calculateCommonInterestsWithUser,\n  archetypeDescriptions,\n  generateSparkPredictions,\n  normalizeInterestName,\n  type AttendeeData,\n} from \"@/lib/attendeeAnalytics\";\n\n// 8ä¸ªæ ¸å¿ƒç¤¾äº¤è§’è‰²ç³»ç»Ÿ\nconst archetypeIcons: Record<string, string> = {\n  \"ç«èŠ±å¡\": \"ğŸ™Œ\",\n  \"æ¢ç´¢è€…\": \"ğŸ§­\",\n  \"æ•…äº‹å®¶\": \"ğŸ—£ï¸\",\n  \"æŒ‘æˆ˜è€…\": \"ğŸ’ª\",\n  \"è¿æ¥è€…\": \"ğŸ¤—\",\n  \"åè°ƒè€…\": \"ğŸ§˜\",\n  \"æ°›å›´ç»„\": \"ğŸ•º\",\n  \"è‚¯å®šè€…\": \"ğŸ™\",\n};\n\nconst interestIcons: Record<string, string> = {\n  \"Film\": \"ğŸ¬\",\n  \"Travel\": \"âœˆï¸\",\n  \"Food\": \"ğŸœ\",\n  \"Music\": \"ğŸµ\",\n  \"Art\": \"ğŸ¨\",\n  \"Sports\": \"âš½\",\n  \"Reading\": \"ğŸ“š\",\n  \"Gaming\": \"ğŸ®\",\n  \"Photography\": \"ğŸ“·\",\n  \"Fitness\": \"ğŸ’ª\",\n  \"ç”µå½±\": \"ğŸ¬\",\n  \"æ—…è¡Œ\": \"âœˆï¸\",\n  \"ç¾é£Ÿ\": \"ğŸœ\",\n  \"éŸ³ä¹\": \"ğŸµ\",\n  \"è‰ºæœ¯\": \"ğŸ¨\",\n  \"è¿åŠ¨\": \"âš½\",\n  \"é˜…è¯»\": \"ğŸ“š\",\n  \"æ¸¸æˆ\": \"ğŸ®\",\n  \"æ‘„å½±\": \"ğŸ“·\",\n  \"å¥èº«\": \"ğŸ’ª\",\n  \"ç§‘æŠ€\": \"ğŸ’»\",\n};\n\ninterface AttendeePreviewCardProps {\n  attendee: AttendeeData;\n  userInterests?: string[];\n  userTopicsHappy?: string[];\n  userTopicsAvoid?: string[];\n  userDebateComfort?: number;\n  userEducationLevel?: string;\n  userIndustry?: string;\n  userAge?: number;\n  userGender?: string;\n  userRelationshipStatus?: string;\n  userChildren?: string;\n  userStudyLocale?: string;\n  userOverseasRegions?: string[];\n  userSeniority?: string;\n  userFieldOfStudy?: string;\n  userHometownCountry?: string;\n  userHometownRegionCity?: string;\n  userHometownAffinityOptin?: boolean;\n  userArchetype?: string;\n  userLanguages?: string[];\n}\n\nexport default function AttendeePreviewCard({\n  attendee,\n  userInterests = [],\n  userTopicsHappy,\n  userTopicsAvoid,\n  userDebateComfort,\n  userEducationLevel,\n  userIndustry,\n  userAge,\n  userGender,\n  userRelationshipStatus,\n  userChildren,\n  userStudyLocale,\n  userOverseasRegions,\n  userSeniority,\n  userFieldOfStudy,\n  userHometownCountry,\n  userHometownRegionCity,\n  userHometownAffinityOptin,\n  userArchetype,\n  userLanguages,\n}: AttendeePreviewCardProps) {\n  const [isFlipped, setIsFlipped] = useState(false);\n  const archetypeIcon = attendee.archetype\n    ? archetypeIcons[attendee.archetype] || \"âœ¨\"\n    : \"âœ¨\";\n\n  const topInterests = (attendee.topInterests || []).slice(0, 3);\n  const archetypeDescription = attendee.archetype \n    ? archetypeDescriptions[attendee.archetype] || \"\"\n    : \"\";\n\n  const sparkPredictions = generateSparkPredictions(\n    {\n      userInterests,\n      userTopicsHappy,\n      userTopicsAvoid,\n      userDebateComfort,\n      userEducationLevel,\n      userIndustry,\n      userAge,\n      userGender,\n      userRelationshipStatus,\n      userChildren,\n      userStudyLocale,\n      userOverseasRegions,\n      userSeniority,\n      userFieldOfStudy,\n      userHometownCountry,\n      userHometownRegionCity,\n      userHometownAffinityOptin,\n      userArchetype,\n      userLanguages,\n    },\n    attendee\n  );\n\n  const connectionPointsCount = sparkPredictions.length;\n\n  const genderDisplay = attendee.gender === \"Woman\" ? \"å¥³\" : \n                       attendee.gender === \"Man\" ? \"ç”·\" : \n                       attendee.gender || \"\";\n  \n  const educationDisplay = attendee.educationLevel === \"Bachelor's\" ? \"æœ¬ç§‘\" :\n                          attendee.educationLevel === \"Master's\" ? \"ç¡•å£«\" :\n                          attendee.educationLevel === \"Doctorate\" ? \"åšå£«\" :\n                          attendee.educationLevel || \"\";\n\n  const handleFlip = () => {\n    setIsFlipped(!isFlipped);\n  };\n\n  return (\n    <div\n      className=\"min-w-[180px] w-[180px] h-[320px] flex-shrink-0\"\n      style={{ perspective: \"1000px\" }}\n      data-testid={`card-attendee-${attendee.userId}`}\n    >\n      <div\n        className=\"relative w-full h-[320px]\"\n        style={{\n          transformStyle: \"preserve-3d\",\n          transition: \"transform 0.5s\",\n          transform: isFlipped ? \"rotateY(180deg)\" : \"rotateY(0deg)\",\n        }}\n      >\n        <Card\n          className=\"w-full cursor-pointer hover-elevate transition-all backface-hidden bg-gradient-to-br from-background via-background to-primary/5\"\n          onClick={handleFlip}\n          style={{\n            position: \"absolute\",\n            backfaceVisibility: \"hidden\",\n            WebkitBackfaceVisibility: \"hidden\",\n          }}\n        >\n          <CardContent className=\"p-3 space-y-2 h-[320px] flex flex-col items-center justify-center text-center\">\n            <div className=\"absolute top-2 right-2\">\n              <RotateCw className=\"h-4 w-4 text-muted-foreground\" />\n            </div>\n\n            {attendee.archetype && (\n              <div className=\"text-6xl mb-1\">{archetypeIcon}</div>\n            )}\n\n            <div className=\"space-y-1.5\">\n              <div\n                className=\"font-semibold text-xl\"\n                data-testid={`text-attendee-name-${attendee.userId}`}\n              >\n                {attendee.displayName}\n              </div>\n              \n              {attendee.archetype && (\n                <div className=\"space-y-1\">\n                  <div\n                    className=\"text-base font-medium text-primary\"\n                    data-testid={`text-attendee-archetype-${attendee.userId}`}\n                  >\n                    {attendee.archetype}\n                  </div>\n                  {archetypeDescription && (\n                    <div className=\"text-sm text-muted-foreground px-1\">\n                      {archetypeDescription}\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n\n            {connectionPointsCount > 0 && (\n              <div\n                className=\"flex items-center gap-1 text-sm text-muted-foreground mt-auto\"\n                data-testid={`text-common-interests-${attendee.userId}`}\n              >\n                <span>ä¸ä½ æœ‰{connectionPointsCount}ä¸ªå¥‘åˆç‚¹</span>\n                <div className=\"flex gap-0.5 ml-1\">\n                  {[...Array(3)].map((_, idx) => (\n                    <div\n                      key={idx}\n                      className={`w-1.5 h-1.5 rounded-full ${\n                        idx < connectionPointsCount\n                          ? \"bg-primary\"\n                          : \"bg-muted-foreground/30\"\n                      }`}\n                    />\n                  ))}\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card\n          className=\"absolute inset-0 w-full cursor-pointer hover-elevate transition-all backface-hidden bg-gradient-to-br from-background via-accent/10 to-accent/20\"\n          onClick={handleFlip}\n          style={{\n            position: \"absolute\",\n            backfaceVisibility: \"hidden\",\n            WebkitBackfaceVisibility: \"hidden\",\n            transform: \"rotateY(180deg)\",\n          }}\n        >\n          <CardContent className=\"p-3 space-y-3 h-[320px] flex flex-col\">\n            <div className=\"flex items-start justify-between\">\n              <div className=\"font-semibold text-lg\">\n                {attendee.displayName}\n              </div>\n              <RotateCw className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n            </div>\n\n            <div className=\"space-y-2.5 text-sm flex-shrink-0\">\n              {(genderDisplay || attendee.age) && (\n                <div className=\"flex items-center gap-2 text-foreground\">\n                  {genderDisplay && (\n                    <div className=\"flex items-center gap-1\">\n                      <User className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                      <span>{genderDisplay}</span>\n                    </div>\n                  )}\n                  {attendee.age && (\n                    <span className=\"text-muted-foreground\">{attendee.age}å²</span>\n                  )}\n                </div>\n              )}\n\n              {(educationDisplay || attendee.fieldOfStudy) && (\n                <div className=\"flex items-start gap-1.5 text-foreground\">\n                  <GraduationCap className=\"h-3.5 w-3.5 text-muted-foreground mt-0.5 flex-shrink-0\" />\n                  <div className=\"flex flex-col gap-0.5\">\n                    {educationDisplay && <span>{educationDisplay}</span>}\n                    {attendee.fieldOfStudy && (\n                      <span className=\"text-xs text-muted-foreground\">{attendee.fieldOfStudy}</span>\n                    )}\n                  </div>\n                </div>\n              )}\n\n              {(attendee.industry || attendee.seniority) && (\n                <div className=\"flex items-start gap-1.5 text-foreground\">\n                  <Briefcase className=\"h-3.5 w-3.5 text-muted-foreground mt-0.5 flex-shrink-0\" />\n                  <div className=\"flex flex-col gap-0.5\">\n                    {attendee.industry && <span>{attendee.industry}</span>}\n                    {attendee.seniority && (\n                      <span className=\"text-xs text-muted-foreground\">\n                        {attendee.seniority === \"Junior\" ? \"åˆçº§\" : \n                         attendee.seniority === \"Mid\" ? \"ä¸­çº§\" : \n                         attendee.seniority === \"Senior\" ? \"é«˜çº§\" :\n                         attendee.seniority === \"Founder\" ? \"åˆ›å§‹äºº\" : attendee.seniority}\n                      </span>\n                    )}\n                  </div>\n                </div>\n              )}\n\n              {attendee.hometownRegionCity && (\n                <div className=\"flex items-center gap-1.5 text-foreground\">\n                  <MapPin className=\"h-3.5 w-3.5 text-muted-foreground flex-shrink-0\" />\n                  <span>{attendee.hometownRegionCity}</span>\n                </div>\n              )}\n\n              {attendee.languagesComfort && attendee.languagesComfort.length > 0 && (\n                <div className=\"flex items-start gap-1.5\">\n                  <span className=\"text-muted-foreground\">ğŸŒ</span>\n                  <span className=\"text-xs text-muted-foreground leading-relaxed\">\n                    {attendee.languagesComfort.join(\" Â· \")}\n                  </span>\n                </div>\n              )}\n            </div>\n\n            {topInterests.length > 0 && (\n              <div className=\"space-y-1.5\">\n                <div className=\"text-xs font-medium text-muted-foreground\">\n                  ä¸ªäººå…´è¶£\n                </div>\n                <div className=\"flex flex-wrap gap-1.5\">\n                  {topInterests.map((interest, idx) => {\n                    const normalizedInterest = normalizeInterestName(interest);\n                    return (\n                      <Badge\n                        key={idx}\n                        variant=\"secondary\"\n                        className=\"text-xs gap-1 no-default-active-elevate bg-accent/30\"\n                        data-testid={`badge-interest-${attendee.userId}-${idx}`}\n                      >\n                        <span>{interestIcons[normalizedInterest] || interestIcons[interest] || \"Â·\"}</span>\n                        <span>{normalizedInterest}</span>\n                      </Badge>\n                    );\n                  })}\n                </div>\n              </div>\n            )}\n\n            {sparkPredictions.length > 0 && (\n              <div className=\"space-y-1.5 mt-auto\">\n                <div className=\"text-xs font-medium text-muted-foreground\">\n                  æˆ‘ä»¬ä¹‹é—´çš„å¥‘åˆç‚¹\n                </div>\n                <div className=\"flex flex-wrap gap-1.5\">\n                  {sparkPredictions.map((prediction, idx) => (\n                    <Badge\n                      key={idx}\n                      variant=\"secondary\"\n                      className=\"text-xs no-default-active-elevate bg-primary/10 text-primary border-primary/30\"\n                      data-testid={`badge-spark-back-${attendee.userId}-${idx}`}\n                    >\n                      âœ¨ {prediction.text}\n                    </Badge>\n                  ))}\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":12251},"client/src/components/MeetYourTable.tsx":{"content":"import { useRef } from \"react\";\nimport GroupSummaryCard from \"./GroupSummaryCard\";\nimport UserConnectionCard from \"./UserConnectionCard\";\nimport { generateSparkPredictions, normalizeInterestName, type AttendeeData } from \"@/lib/attendeeAnalytics\";\n\ninterface MeetYourTableProps {\n  attendees: AttendeeData[];\n  userInterests?: string[];\n  userTopicsHappy?: string[];\n  userTopicsAvoid?: string[];\n  userDebateComfort?: number;\n  userEducationLevel?: string;\n  userIndustry?: string;\n  userAge?: number;\n  userGender?: string;\n  userRelationshipStatus?: string;\n  userChildren?: string;\n  userStudyLocale?: string;\n  userOverseasRegions?: string[];\n  userSeniority?: string;\n  userFieldOfStudy?: string;\n  userLanguages?: string[];\n  userHometownCountry?: string;\n  userHometownRegionCity?: string;\n  userHometownAffinityOptin?: boolean;\n  userArchetype?: string;\n}\n\nexport default function MeetYourTable({\n  attendees,\n  userInterests = [],\n  userTopicsHappy,\n  userTopicsAvoid,\n  userDebateComfort,\n  userEducationLevel,\n  userIndustry,\n  userAge,\n  userGender,\n  userRelationshipStatus,\n  userChildren,\n  userStudyLocale,\n  userOverseasRegions,\n  userSeniority,\n  userFieldOfStudy,\n  userLanguages,\n  userHometownCountry,\n  userHometownRegionCity,\n  userHometownAffinityOptin,\n  userArchetype,\n}: MeetYourTableProps) {\n  const scrollContainerRef = useRef<HTMLDivElement>(null);\n\n  if (!attendees || attendees.length === 0) {\n    return null;\n  }\n\n  const userContext = {\n    userInterests,\n    userTopicsHappy,\n    userTopicsAvoid,\n    userDebateComfort,\n    userEducationLevel,\n    userIndustry,\n    userAge,\n    userGender,\n    userRelationshipStatus,\n    userChildren,\n    userStudyLocale,\n    userOverseasRegions,\n    userSeniority,\n    userFieldOfStudy,\n    userLanguages,\n    userHometownCountry,\n    userHometownRegionCity,\n    userHometownAffinityOptin,\n    userArchetype,\n  };\n\n  const interestIcons: Record<string, string> = {\n    \"ç”µå½±å¨±ä¹\": \"ğŸ¬\",\n    \"æ—…è¡Œæ¢ç´¢\": \"âœˆï¸\",\n    \"ç¾é£Ÿé¤é¥®\": \"ğŸœ\",\n    \"éŸ³ä¹æ¼”å‡º\": \"ğŸµ\",\n    \"é˜…è¯»ä¹¦ç±\": \"ğŸ“š\",\n    \"è‰ºæœ¯æ–‡åŒ–\": \"ğŸ¨\",\n    \"è¿åŠ¨å¥èº«\": \"âš½\",\n    \"å¥èº«å¥åº·\": \"ğŸ’ª\",\n    \"æ‘„å½±\": \"ğŸ“·\",\n    \"æ¸¸æˆ\": \"ğŸ®\",\n    \"ç§‘æŠ€\": \"ğŸ’»\",\n  };\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"section-meet-your-table\">\n      <div className=\"space-y-2\">\n        <h3 className=\"text-lg font-semibold\">è®¤è¯†ä½ çš„æ¡Œå‹</h3>\n        <p className=\"text-sm text-muted-foreground\">\n          æå‰äº†è§£ä¸€èµ·èšä¼šçš„æœ‹å‹ï¼Œå‡å°‘å†·åœºå°´å°¬\n        </p>\n      </div>\n\n      <GroupSummaryCard attendees={attendees} />\n\n      {/* Title for attendee cards */}\n      <div className=\"mt-6 mb-4\">\n        <h2 className=\"text-xl font-medium\">ğŸ‘¥ å³å°†è§é¢çš„æ–°æœ‹å‹</h2>\n      </div>\n\n      <div className=\"relative\">\n        <div \n          ref={scrollContainerRef}\n          className=\"flex gap-3 overflow-x-auto pb-2 scrollbar-hide\"\n          style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}\n        >\n          {attendees.map((attendee) => {\n            const sparkPredictions = generateSparkPredictions(userContext, attendee);\n            \n            const connectionTags = sparkPredictions.map((prediction) => {\n              let icon = \"âœ¨\";\n              let type: \"interest\" | \"background\" | \"experience\" = \"experience\";\n              const predictionText = prediction.text;\n              \n              // Determine icon based on prediction type\n              if (predictionText.includes(\"å…±åŒå½±è¿·\") || predictionText.includes(\"Movie\") || predictionText.includes(\"ç”µå½±\")) {\n                icon = \"ğŸ¬\";\n                type = \"interest\";\n              } else if (predictionText.includes(\"æ—…è¡Œ\") || predictionText.includes(\"Travel\")) {\n                icon = \"âœˆï¸\";\n                type = \"interest\";\n              } else if (predictionText.includes(\"ç¾é£Ÿ\") || predictionText.includes(\"Food\") || predictionText.includes(\"Foodie\")) {\n                icon = \"ğŸœ\";\n                type = \"interest\";\n              } else if (predictionText.includes(\"éŸ³ä¹\") || predictionText.includes(\"Music\")) {\n                icon = \"ğŸµ\";\n                type = \"interest\";\n              } else if (predictionText.includes(\"ä¹¦å‹\") || predictionText.includes(\"é˜…è¯»\") || predictionText.includes(\"Book\")) {\n                icon = \"ğŸ“š\";\n                type = \"interest\";\n              } else if (predictionText.includes(\"æ‘„å½±\") || predictionText.includes(\"Photo\")) {\n                icon = \"ğŸ“·\";\n                type = \"interest\";\n              } else if (predictionText.includes(\"å¥èº«\") || predictionText.includes(\"è¿åŠ¨\") || predictionText.includes(\"Fitness\") || predictionText.includes(\"Gym\")) {\n                icon = \"ğŸ’ª\";\n                type = \"interest\";\n              } else if (predictionText.includes(\"æˆ·å¤–\") || predictionText.includes(\"Outdoor\")) {\n                icon = \"ğŸ•ï¸\";\n                type = \"interest\";\n              } else if (predictionText.includes(\"å’–å•¡\") || predictionText.includes(\"Coffee\") || predictionText.includes(\"èŒ¶\")) {\n                icon = \"â˜•\";\n                type = \"interest\";\n              } else if (predictionText.includes(\"æµ·å¤–\") || predictionText.includes(\"ç•™å­¦\") || predictionText.includes(\"å›½é™…åŒ–\")) {\n                icon = \"ğŸŒ\";\n                type = \"background\";\n              } else if (predictionText.includes(\"å­¦å†\") || predictionText.includes(\"åšå£«\") || predictionText.includes(\"ç¡•å£«\")) {\n                icon = \"ğŸ“\";\n                type = \"background\";\n              } else if (predictionText.includes(\"åˆ›ä¸š\") || predictionText.includes(\"Founder\")) {\n                icon = \"ğŸš€\";\n                type = \"experience\";\n              } else if (predictionText.includes(\"èŒåœº\") || predictionText.includes(\"Senior\") || predictionText.includes(\"èµ„æ·±\")) {\n                icon = \"ğŸ’¼\";\n                type = \"experience\";\n              } else if (predictionText.includes(\"å•èº«\") || predictionText.includes(\"Single\") || predictionText.includes(\"æœ‰ä¼´\")) {\n                icon = \"ğŸ’‘\";\n                type = \"background\";\n              } else if (predictionText.includes(\"å¹´é¾„æ®µ\") || predictionText.includes(\"åŒé¾„\")) {\n                icon = \"ğŸ‚\";\n                type = \"background\";\n              } else if (predictionText.includes(\"é¦™æ¸¯\") || predictionText.includes(\"æ·±åœ³\") || predictionText.includes(\"åŒ—äº¬\") || predictionText.includes(\"ä¸Šæµ·\") || predictionText.includes(\"è€ä¹¡\") || predictionText.includes(\"åŒä¹¡\")) {\n                icon = \"ğŸ“\";\n                type = \"background\";\n              } else if (predictionText.includes(\"æ¢ç´¢\") || predictionText.includes(\"å‘å…‰\") || predictionText.includes(\"æ™ºè€…\") || predictionText.includes(\"è®²æ•…äº‹\") || predictionText.includes(\"ç¨³å®š\")) {\n                icon = \"ğŸ­\";\n                type = \"experience\";\n              } else if (predictionText.includes(\"åˆ†äº«\") || predictionText.includes(\"å€¾å¬\")) {\n                icon = \"ğŸ’¬\";\n                type = \"experience\";\n              } else if (predictionText.includes(\"æ·±åº¦å¯¹è¯\")) {\n                icon = \"ğŸ§ \";\n                type = \"experience\";\n              } else if (predictionText.includes(\"æ´»åŠ›\")) {\n                icon = \"âš¡\";\n                type = \"experience\";\n              } else if (predictionText.includes(\"å¯é \")) {\n                icon = \"ğŸ¤\";\n                type = \"experience\";\n              } else if (predictionText.includes(\"ç§‘æŠ€åœˆ\") || predictionText.includes(\"é‡‘èåœˆ\") || predictionText.includes(\"è‰ºæœ¯é¢†åŸŸ\") || predictionText.includes(\"åŒ»ç–—è¡Œä¸š\") || predictionText.includes(\"æ•™è‚²è¡Œä¸š\")) {\n                icon = \"ğŸ¢\";\n                type = \"experience\";\n              } else if (predictionText.includes(\"ç¡•å£«æµ·å½’\") || predictionText.includes(\"åšå£«æµ·å½’\")) {\n                icon = \"ğŸ’\";\n                type = \"background\";\n              } else {\n                icon = \"âœ¨\";\n                type = \"experience\";\n              }\n              \n              return { icon, label: predictionText, type, rarity: prediction.rarity };\n            });\n\n            return (\n              <UserConnectionCard\n                key={attendee.userId}\n                attendee={attendee}\n                connectionTags={connectionTags}\n              />\n            );\n          })}\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":8456},"client/src/components/WhyThisTable.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Sparkles } from \"lucide-react\";\n\ninterface WhyThisTableProps {\n  explanation: string;\n}\n\nexport default function WhyThisTable({ explanation }: WhyThisTableProps) {\n  if (!explanation) {\n    return null;\n  }\n  \n  return (\n    <div className=\"space-y-3\" data-testid=\"section-why-this-table\">\n      <h3 className=\"text-lg font-semibold flex items-center gap-2\">\n        <Sparkles className=\"h-5 w-5 text-primary\" />\n        ä¸ºä»€ä¹ˆæ˜¯è¿™æ¡Œï¼Ÿ\n      </h3>\n      \n      <Card className=\"border-primary/20 bg-primary/5\">\n        <CardContent className=\"p-4\">\n          <p className=\"text-sm leading-relaxed\" data-testid=\"text-match-explanation\">\n            {explanation}\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":806},"client/src/components/PostMatchEventCard.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport MeetYourTable from \"./MeetYourTable\";\nimport WhyThisTable from \"./WhyThisTable\";\nimport { Users } from \"lucide-react\";\nimport type { AttendeeData } from \"@/lib/attendeeAnalytics\";\n\ninterface PostMatchEventCardProps {\n  matchedAttendees?: AttendeeData[];\n  matchExplanation?: string;\n  userInterests?: string[];\n  userEducationLevel?: string;\n  userIndustry?: string;\n  userAge?: number;\n  userGender?: string;\n  userRelationshipStatus?: string;\n  userChildren?: string;\n  userStudyLocale?: string;\n  userOverseasRegions?: string[];\n  userSeniority?: string;\n  userFieldOfStudy?: string;\n  userLanguages?: string[];\n  userHometownCountry?: string;\n  userHometownRegionCity?: string;\n  userHometownAffinityOptin?: boolean;\n}\n\nexport default function PostMatchEventCard({ \n  matchedAttendees, \n  matchExplanation,\n  userInterests = [],\n  userEducationLevel,\n  userIndustry,\n  userAge,\n  userGender,\n  userRelationshipStatus,\n  userChildren,\n  userStudyLocale,\n  userOverseasRegions,\n  userSeniority,\n  userFieldOfStudy,\n  userLanguages,\n  userHometownCountry,\n  userHometownRegionCity,\n  userHometownAffinityOptin,\n}: PostMatchEventCardProps) {\n  if (!matchedAttendees || matchedAttendees.length === 0) {\n    return null;\n  }\n  \n  return (\n    <Card className=\"border shadow-sm\" data-testid=\"card-post-match-preview\">\n      <CardHeader className=\"pb-4\">\n        <CardTitle className=\"flex items-center gap-2 text-base\">\n          <Users className=\"h-5 w-5\" />\n          æ´»åŠ¨é¢„è§ˆ\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-6\">\n        <MeetYourTable \n          attendees={matchedAttendees} \n          userInterests={userInterests}\n          userEducationLevel={userEducationLevel}\n          userIndustry={userIndustry}\n          userAge={userAge}\n          userGender={userGender}\n          userRelationshipStatus={userRelationshipStatus}\n          userChildren={userChildren}\n          userStudyLocale={userStudyLocale}\n          userOverseasRegions={userOverseasRegions}\n          userSeniority={userSeniority}\n          userFieldOfStudy={userFieldOfStudy}\n          userLanguages={userLanguages}\n          userHometownCountry={userHometownCountry}\n          userHometownRegionCity={userHometownRegionCity}\n          userHometownAffinityOptin={userHometownAffinityOptin}\n        />\n        {matchExplanation && <WhyThisTable explanation={matchExplanation} />}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":2526},"client/src/components/GroupSummaryCard.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Sparkles } from \"lucide-react\";\nimport {\n  calculateArchetypeDistribution,\n  calculateGroupInsights,\n  archetypeDescriptions,\n  type AttendeeData,\n} from \"@/lib/attendeeAnalytics\";\nimport InteractiveArchetypeChart from \"./InteractiveArchetypeChart\";\n\ninterface GroupSummaryCardProps {\n  attendees: AttendeeData[];\n}\n\nexport default function GroupSummaryCard({ attendees }: GroupSummaryCardProps) {\n  const archetypeDistribution = calculateArchetypeDistribution(attendees);\n  const groupInsights = calculateGroupInsights(attendees);\n\n  if (attendees.length === 0) {\n    return null;\n  }\n\n  const archetypeChartData = archetypeDistribution.map(item => {\n    // 12ä¸ªç¤¾äº¤åŠ¨ç‰©åŸå‹çš„é¢œè‰²é…ç½®\n    const archetypeColors: Record<string, string> = {\n      \"å¼€å¿ƒæŸ¯åŸº\": \"#f97316\",      // orange-600\n      \"å¤ªé˜³é¸¡\": \"#f59e0b\",        // amber-600\n      \"å¤¸å¤¸è±š\": \"#06b6d4\",        // cyan-600\n      \"æœºæ™ºç‹\": \"#ea580c\",        // orange-700\n      \"æ·¡å®šæµ·è±š\": \"#4f46e5\",      // indigo-600\n      \"ç»‡ç½‘è››\": \"#a855f7\",        // purple-600\n      \"æš–å¿ƒç†Š\": \"#ec4899\",        // pink-600\n      \"çµæ„Ÿç« é±¼\": \"#8b5cf6\",      // violet-600\n      \"æ²‰æ€çŒ«å¤´é¹°\": \"#64748b\",    // slate-600\n      \"å®šå¿ƒå¤§è±¡\": \"#6b7280\",      // gray-600\n      \"ç¨³å¦‚é¾Ÿ\": \"#10b981\",        // emerald-600\n      \"éšèº«çŒ«\": \"#6366f1\",        // indigo-500\n    };\n\n    const archetypeEmojis: Record<string, string> = {\n      \"å¼€å¿ƒæŸ¯åŸº\": \"ğŸ•\",\n      \"å¤ªé˜³é¸¡\": \"ğŸ“\",\n      \"å¤¸å¤¸è±š\": \"ğŸ¬\",\n      \"æœºæ™ºç‹\": \"ğŸ¦Š\",\n      \"æ·¡å®šæµ·è±š\": \"ğŸ¬\",\n      \"ç»‡ç½‘è››\": \"ğŸ•·ï¸\",\n      \"æš–å¿ƒç†Š\": \"ğŸ»\",\n      \"çµæ„Ÿç« é±¼\": \"ğŸ™\",\n      \"æ²‰æ€çŒ«å¤´é¹°\": \"ğŸ¦‰\",\n      \"å®šå¿ƒå¤§è±¡\": \"ğŸ˜\",\n      \"ç¨³å¦‚é¾Ÿ\": \"ğŸ¢\",\n      \"éšèº«çŒ«\": \"ğŸ±\",\n    };\n\n    return {\n      name: item.archetype,\n      percentage: item.percentage,\n      color: archetypeColors[item.archetype] || \"hsl(var(--primary))\",\n      emoji: archetypeEmojis[item.archetype] || \"âœ¨\",\n      description: archetypeDescriptions[item.archetype] || \"ç‹¬ç‰¹çš„ä¸ªæ€§é­…åŠ›\",\n    };\n  });\n\n  return (\n    <Card className=\"mb-4 overflow-hidden\" data-testid=\"card-group-summary\">\n      <CardContent className=\"p-4 space-y-6\">\n        {groupInsights.length > 0 && (\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-2 text-sm font-medium\">\n              <Sparkles className=\"h-4 w-4 text-primary\" />\n              <span>æ½œåœ¨å¥‘åˆç‚¹</span>\n            </div>\n            <div className=\"flex flex-wrap gap-2\">\n              {groupInsights.map((insight, idx) => (\n                <Badge\n                  key={idx}\n                  variant=\"secondary\"\n                  className=\"text-sm gap-1.5 no-default-active-elevate\"\n                  data-testid={`badge-group-insight-${idx}`}\n                >\n                  <span>{insight.icon}</span>\n                  <span>{insight.label}</span>\n                </Badge>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {archetypeChartData.length > 0 && (\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-2 text-sm font-medium\">\n              <span className=\"text-lg\">ğŸ‘¥</span>\n              <span>äººç¾¤æ„æˆ</span>\n            </div>\n            <InteractiveArchetypeChart data={archetypeChartData} />\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":3531},"client/src/lib/attendeeAnalytics.ts":{"content":"export interface AttendeeData {\n  userId: string;\n  displayName: string;\n  archetype?: string;\n  topInterests?: string[];\n  topicsHappy?: string[];\n  topicsAvoid?: string[];\n  debateComfort?: number;\n  age?: number;\n  birthdate?: string;\n  industry?: string;\n  ageVisible?: boolean;\n  industryVisible?: boolean;\n  gender?: string;\n  pronouns?: string;\n  educationLevel?: string;\n  hometownCountry?: string;\n  hometownRegionCity?: string;\n  hometownAffinityOptin?: boolean;\n  educationVisible?: boolean;\n  relationshipStatus?: string;\n  children?: string;\n  studyLocale?: string;\n  overseasRegions?: string[];\n  seniority?: string;\n  fieldOfStudy?: string;\n  languagesComfort?: string[];\n  intent?: string; // Event-specific intent\n}\n\nexport interface CommonInterest {\n  interest: string;\n  count: number;\n}\n\nexport interface ArchetypeDistribution {\n  archetype: string;\n  count: number;\n  percentage: number;\n}\n\nexport interface GroupInsight {\n  type: 'industry' | 'interest' | 'experience' | 'personality' | 'balance';\n  label: string;\n  icon: string;\n}\n\nconst interestNameMap: Record<string, string> = {\n  \"film_entertainment\": \"ç”µå½±å¨±ä¹\",\n  \"travel_exploration\": \"æ—…è¡Œæ¢ç´¢\",\n  \"food_dining\": \"ç¾é£Ÿé¤é¥®\",\n  \"music_concerts\": \"éŸ³ä¹æ¼”å‡º\",\n  \"reading_books\": \"é˜…è¯»ä¹¦ç±\",\n  \"art_culture\": \"è‰ºæœ¯æ–‡åŒ–\",\n  \"sports_fitness\": \"è¿åŠ¨å¥èº«\",\n  \"fitness_health\": \"å¥èº«å¥åº·\",\n  \"photography\": \"æ‘„å½±\",\n  \"gaming\": \"æ¸¸æˆ\",\n  \"technology\": \"ç§‘æŠ€\",\n  \"entrepreneurship\": \"åˆ›ä¸š\",\n  \"networking\": \"ç¤¾äº¤æ‹“å±•\",\n  \"outdoor_activities\": \"æˆ·å¤–æ´»åŠ¨\",\n  \"yoga_meditation\": \"ç‘œä¼½å†¥æƒ³\",\n  \"wine_spirits\": \"å“é…’\",\n  \"coffee_tea\": \"å’–å•¡èŒ¶è‰º\",\n  \"cooking_baking\": \"çƒ¹é¥ªçƒ˜ç„™\",\n};\n\nexport function normalizeInterestName(interest: string): string {\n  return interestNameMap[interest] || interest;\n}\n\nexport function calculateCommonInterests(\n  attendees: AttendeeData[]\n): CommonInterest[] {\n  const interestMap = new Map<string, number>();\n  \n  attendees.forEach((attendee) => {\n    if (attendee.topInterests) {\n      attendee.topInterests.forEach((interest) => {\n        const normalizedInterest = normalizeInterestName(interest);\n        interestMap.set(normalizedInterest, (interestMap.get(normalizedInterest) || 0) + 1);\n      });\n    }\n  });\n  \n  const commonInterests = Array.from(interestMap.entries())\n    .map(([interest, count]) => ({ interest, count }))\n    .sort((a, b) => b.count - a.count)\n    .slice(0, 3);\n  \n  return commonInterests;\n}\n\nexport function calculateArchetypeDistribution(\n  attendees: AttendeeData[]\n): ArchetypeDistribution[] {\n  const archetypeMap = new Map<string, number>();\n  const total = attendees.length;\n  \n  attendees.forEach((attendee) => {\n    if (attendee.archetype) {\n      archetypeMap.set(\n        attendee.archetype,\n        (archetypeMap.get(attendee.archetype) || 0) + 1\n      );\n    }\n  });\n  \n  const distribution = Array.from(archetypeMap.entries())\n    .map(([archetype, count]) => ({\n      archetype,\n      count,\n      percentage: Math.round((count / total) * 100),\n    }))\n    .sort((a, b) => b.count - a.count);\n  \n  return distribution;\n}\n\nexport function calculateCommonInterestsWithUser(\n  userInterests: string[],\n  attendeeInterests: string[]\n): number {\n  if (!userInterests || !attendeeInterests) return 0;\n  \n  const userSet = new Set(userInterests);\n  const commonCount = attendeeInterests.filter((interest) =>\n    userSet.has(interest)\n  ).length;\n  \n  return commonCount;\n}\n\nexport const archetypeDescriptions: Record<string, string> = {\n  // 8ä¸ªæ ¸å¿ƒç¤¾äº¤è§’è‰²\n  \"ç«èŠ±å¡\": \"ç‚¹ç‡ƒè¯é¢˜ï¼Œæ¿€å‘è®¨è®ºçš„æ´»åŠ›å¼•æ“\",\n  \"æ¢ç´¢è€…\": \"å¥½å¥‡å¿ƒé©±åŠ¨ï¼Œçƒ­è¡·äºå°è¯•æ–°äº‹ç‰©å’Œæ–°ä½“éªŒ\",\n  \"æ•…äº‹å®¶\": \"å–„äºè¡¨è¾¾ï¼Œå–œæ¬¢åˆ†äº«ç»å†å’Œå€¾å¬ä»–äºº\",\n  \"æŒ‘æˆ˜è€…\": \"å‹‡äºè´¨ç–‘ï¼Œæ¨åŠ¨æ·±åº¦æ€è€ƒå’Œæˆé•¿\",\n  \"è¿æ¥è€…\": \"æ“…é•¿å»ºç«‹è”ç³»ï¼Œä¸²è”ä¸åŒçš„äººå’Œè¯é¢˜\",\n  \"åè°ƒè€…\": \"å¹³è¡¡æ°›å›´ï¼Œå–„äºåè°ƒå’ŒåŒ–è§£åˆ†æ­§\",\n  \"æ°›å›´ç»„\": \"æ´»è·ƒæ°”æ°›ï¼Œè®©èšä¼šå……æ»¡æ¬¢å£°ç¬‘è¯­\",\n  \"è‚¯å®šè€…\": \"ç»™äºˆæ”¯æŒå’Œè®¤å¯ï¼Œæä¾›æƒ…æ„Ÿä»·å€¼\",\n  \n  // æ¼”ç¤ºæ•°æ®ä½¿ç”¨çš„è§’è‰²\n  \"ç¤¾äº¤è¾¾äºº\": \"å¤–å‘çƒ­æƒ…ï¼Œæ“…é•¿ç¤¾äº¤å’Œå»ºç«‹äººè„‰\",\n  \"åˆ›æ„å®¶\": \"å……æ»¡æƒ³è±¡åŠ›ï¼Œå¸¦æ¥æ–°å¥‡ç‹¬ç‰¹çš„è§†è§’\",\n  \n  // æ—§ç‰ˆè§’è‰²ï¼ˆå…¼å®¹æ€§ä¿ç•™ï¼‰\n  \"è®²æ•…äº‹çš„äºº\": \"ç”ŸåŠ¨æœ‰è¶£ï¼Œç”¨æ•…äº‹è¿æ¥å½¼æ­¤çš„æƒ…æ„Ÿ\",\n  \"æ™ºè€…\": \"æ·±æ€ç†Ÿè™‘ï¼Œäº«å—æ·±åº¦å¯¹è¯å’ŒçŸ¥è¯†äº¤æµ\",\n  \"å‘å…‰ä½“\": \"æ´»åŠ›å››å°„ï¼Œèƒ½ç‚¹ç‡ƒå›¢é˜Ÿæ°›å›´çš„æ­£èƒ½é‡æ‹…å½“\",\n  \"ç¨³å®šå™¨\": \"å¯é ç¨³é‡ï¼Œä¸ºæœ‹å‹æä¾›æƒ…æ„Ÿæ”¯æŒå’Œå®‰å…¨æ„Ÿ\",\n};\n\nexport function generatePersonalizedDescription(\n  attendee: AttendeeData\n): string {\n  if (!attendee.topInterests || attendee.topInterests.length === 0) {\n    return \"æœŸå¾…ä¸ä½ åˆ†äº«ç²¾å½©æ—¶åˆ»\";\n  }\n  \n  const interests = attendee.topInterests.slice(0, 2).join(\"ã€\");\n  const templates = [\n    `æœ€è¿‘è¿·ä¸Šäº†${interests}`,\n    `çƒ­çˆ±${interests}çš„ç”Ÿæ´»`,\n    `å–œæ¬¢æ¢ç´¢${interests}çš„ä¸–ç•Œ`,\n    `${interests}æ˜¯æˆ‘çš„å¿«ä¹æºæ³‰`,\n  ];\n  \n  const hash = attendee.userId.split(\"\").reduce((acc, char) => acc + char.charCodeAt(0), 0);\n  return templates[hash % templates.length];\n}\n\nconst sparkPredictions: Record<string, string> = {\n  \"ç”µå½±\": \"å…±åŒå½±è¿·\",\n  \"æ—…è¡Œ\": \"æ—…è¡Œæ­å­\",\n  \"ç¾é£Ÿ\": \"ç¾é£Ÿæ¢åº—æ­æ¡£\",\n  \"éŸ³ä¹\": \"éŸ³ä¹çŸ¥éŸ³\",\n  \"é˜…è¯»\": \"ä¹¦å‹\",\n  \"è‰ºæœ¯\": \"è‰ºæœ¯é‰´èµä¼™ä¼´\",\n  \"è¿åŠ¨\": \"è¿åŠ¨ä¼™ä¼´\",\n  \"å¥èº«\": \"å¥èº«æ­å­\",\n  \"æ‘„å½±\": \"æ‘„å½±åŒå¥½\",\n  \"æ¸¸æˆ\": \"æ¸¸æˆæˆ˜å‹\",\n  \"ç§‘æŠ€\": \"ç§‘æŠ€å‘çƒ§å‹\",\n  \"Film\": \"Movie Buddies\",\n  \"Travel\": \"Travel Companions\",\n  \"Food\": \"Foodie Friends\",\n  \"Music\": \"Music Lovers\",\n  \"Reading\": \"Book Club\",\n  \"Art\": \"Art Enthusiasts\",\n  \"Sports\": \"Sports Partners\",\n  \"Fitness\": \"Gym Buddies\",\n  \"Photography\": \"Photo Pals\",\n  \"Gaming\": \"Gaming Partners\",\n  // English interest keys\n  \"film_entertainment\": \"å…±åŒå½±è¿·\",\n  \"travel_exploration\": \"æ—…è¡Œæ­å­\",\n  \"food_dining\": \"ç¾é£Ÿæ¢åº—æ­æ¡£\",\n  \"music_concerts\": \"éŸ³ä¹çŸ¥éŸ³\",\n  \"reading_books\": \"ä¹¦å‹\",\n  \"art_culture\": \"è‰ºæœ¯é‰´èµä¼™ä¼´\",\n  \"sports_fitness\": \"è¿åŠ¨ä¼™ä¼´\",\n  \"fitness_health\": \"å¥èº«æ­å­\",\n  \"photography\": \"æ‘„å½±åŒå¥½\",\n  \"gaming\": \"æ¸¸æˆæˆ˜å‹\",\n  \"technology\": \"ç§‘æŠ€å‘çƒ§å‹\",\n  \"entrepreneurship\": \"åˆ›ä¸šæ­æ¡£\",\n  \"networking\": \"ç¤¾äº¤è¾¾äºº\",\n  \"outdoor_activities\": \"æˆ·å¤–æ¢é™©ä¼™ä¼´\",\n  \"yoga_meditation\": \"èº«å¿ƒä¿®ç‚¼ä¼™ä¼´\",\n  \"wine_spirits\": \"å“é…’æ­å­\",\n  \"coffee_tea\": \"å’–å•¡/èŒ¶å‹\",\n  \"cooking_baking\": \"ä¸‹å¨æ­æ¡£\",\n};\n\nexport interface SparkPredictionContext {\n  userInterests?: string[];\n  userTopicsHappy?: string[];\n  userTopicsAvoid?: string[];\n  userDebateComfort?: number;\n  userEducationLevel?: string;\n  userIndustry?: string;\n  userAge?: number;\n  userGender?: string;\n  userRelationshipStatus?: string;\n  userChildren?: string;\n  userStudyLocale?: string;\n  userOverseasRegions?: string[];\n  userSeniority?: string;\n  userFieldOfStudy?: string;\n  userLanguages?: string[];\n  userHometownCountry?: string;\n  userHometownRegionCity?: string;\n  userHometownAffinityOptin?: boolean;\n  userArchetype?: string;\n  userIntent?: string; // Event-specific intent\n  userMatchedBefore?: string[]; // Array of user IDs previously matched with\n}\n\nexport type RarityLevel = 'common' | 'rare' | 'epic';\n\nexport interface SparkPrediction {\n  text: string;\n  rarity: RarityLevel;\n}\n\nexport type QualityTier = 'common' | 'rare' | 'epic';\n\nexport interface MatchQuality {\n  rawScore: number;\n  percentage: number;\n  qualityTier: QualityTier;\n  visualBoost: number;\n}\n\n// å¥‘åˆç‚¹è´¨é‡è¯„åˆ†ç³»ç»Ÿ\nexport function calculateMatchQuality(connectionPoints: SparkPrediction[]): MatchQuality {\n  const weights = {\n    common: 1,    // åŸºç¡€åˆ†\n    rare: 3,      // 3å€æƒé‡\n    epic: 6       // 6å€æƒé‡\n  };\n  \n  let totalScore = 0;\n  \n  connectionPoints.forEach(point => {\n    totalScore += weights[point.rarity];\n  });\n  \n  // èƒ½é‡ç¯å¡«å……åŸºäºå¥‘åˆç‚¹æ•°é‡ï¼ˆæ›´å®½æ¾ï¼Œæ›´æ¿€åŠ±ç”¨æˆ·ï¼‰\n  // å‡è®¾6ä¸ªå¥‘åˆç‚¹ä¸ºæ»¡åˆ†ï¼ˆ100%ï¼‰\n  const maxConnectionPoints = 6;\n  const basePercentage = Math.min((connectionPoints.length / maxConnectionPoints) * 100, 100);\n  \n  // è´¨é‡å±‚çº§åŸºäºæœ€ç¨€æœ‰çš„å¥‘åˆç‚¹ï¼ˆç”¨äºå†³å®šé¢œè‰²å’ŒåŠ¨æ•ˆï¼‰\n  let qualityTier: QualityTier;\n  let visualBoost: number;\n  \n  const hasEpic = connectionPoints.some(point => point.rarity === 'epic');\n  const hasRare = connectionPoints.some(point => point.rarity === 'rare');\n  \n  if (hasEpic) {\n    qualityTier = 'epic';      // æœ‰Epicå¥‘åˆç‚¹ - é‡‘è‰²èƒ½é‡ç¯\n    visualBoost = 15;           // 15%è§†è§‰åŠ æˆ\n  } else if (hasRare) {\n    qualityTier = 'rare';      // æœ‰Rareå¥‘åˆç‚¹ - ç´«è‰²èƒ½é‡ç¯  \n    visualBoost = 10;           // 10%è§†è§‰åŠ æˆ\n  } else {\n    qualityTier = 'common';    // åªæœ‰Commonå¥‘åˆç‚¹ - ç°è‰²èƒ½é‡ç¯\n    visualBoost = 5;            // 5%è§†è§‰åŠ æˆ\n  }\n  \n  return {\n    rawScore: totalScore,\n    percentage: basePercentage,\n    qualityTier,\n    visualBoost\n  };\n}\n\nexport function generateSparkPredictions(\n  userContext: SparkPredictionContext,\n  attendee: AttendeeData\n): SparkPrediction[] {\n  const predictions: SparkPrediction[] = [];\n  \n  // Priority 1: Interest-based predictions (most interesting and hidden)\n  if (userContext.userInterests && attendee.topInterests) {\n    const userSet = new Set(userContext.userInterests);\n    const commonInterests = attendee.topInterests.filter((interest) =>\n      userSet.has(interest)\n    );\n    \n    // Interests are COMMON - many people share common interests\n    const interestPredictions = commonInterests\n      .map((interest) => sparkPredictions[interest])\n      .filter((prediction): prediction is string => !!prediction)\n      .slice(0, 3)\n      .map(text => ({ text, rarity: 'common' as RarityLevel }));\n    \n    predictions.push(...interestPredictions);\n  }\n  \n  // Priority 2: Study locale - Overseas experience (RARE - hidden info)\n  if (userContext.userStudyLocale === \"Overseas\" && attendee.studyLocale === \"Overseas\") {\n    predictions.push({ text: \"éƒ½æœ‰æµ·å¤–ç•™å­¦ç»å†\", rarity: 'rare' });\n  } else if (userContext.userStudyLocale === \"Both\" && attendee.studyLocale === \"Both\") {\n    predictions.push({ text: \"éƒ½æœ‰æµ·å¤–+å›½å†…å­¦ä¹ ç»å†\", rarity: 'epic' }); // Very rare combination\n  } else if (userContext.userStudyLocale && attendee.studyLocale && \n             userContext.userStudyLocale !== attendee.studyLocale) {\n    // Different study backgrounds can also be interesting\n    if ((userContext.userStudyLocale === \"Overseas\" && attendee.studyLocale === \"Both\") ||\n        (userContext.userStudyLocale === \"Both\" && attendee.studyLocale === \"Overseas\")) {\n      predictions.push({ text: \"éƒ½æœ‰å›½é™…åŒ–è§†é‡\", rarity: 'rare' });\n    }\n  }\n  \n  // Priority 3: Seniority-based predictions (RARE - career stage not obvious)\n  if (userContext.userSeniority && attendee.seniority) {\n    if (userContext.userSeniority === \"Founder\" && attendee.seniority === \"Founder\") {\n      predictions.push({ text: \"åŒä¸ºåˆ›ä¸šè€…\", rarity: 'epic' }); // Founders are rare\n    } else if (\n      (userContext.userSeniority === \"Senior\" || userContext.userSeniority === \"Executive\") &&\n      (attendee.seniority === \"Senior\" || attendee.seniority === \"Executive\")\n    ) {\n      predictions.push({ text: \"éƒ½æ˜¯èŒåœºè€å¸æœº\", rarity: 'rare' });\n    } else if (\n      userContext.userSeniority === \"Junior\" && attendee.seniority === \"Junior\"\n    ) {\n      predictions.push({ text: \"éƒ½æ˜¯èŒåœºæ–°äºº\", rarity: 'common' });\n    } else if (\n      userContext.userSeniority === \"Mid\" && attendee.seniority === \"Mid\"\n    ) {\n      predictions.push({ text: \"èŒåœºä¸­åšåŠ›é‡\", rarity: 'common' });\n    }\n  }\n  \n  // Priority 4: Relationship status (COMMON - hidden but common)\n  if (userContext.userRelationshipStatus && attendee.relationshipStatus) {\n    if (userContext.userRelationshipStatus === \"Married/Partnered\" && \n        attendee.relationshipStatus === \"Married/Partnered\") {\n      predictions.push({ text: \"åŒä¸ºæœ‰ä¼´ä¸€æ—\", rarity: 'common' });\n    } else if (userContext.userRelationshipStatus === \"Single\" && \n               attendee.relationshipStatus === \"Single\") {\n      predictions.push({ text: \"åŒä¸ºå•èº«è´µæ—\", rarity: 'common' });\n    }\n  }\n  \n  // Priority 5: Education level (RARE/EPIC - advanced degrees)\n  if (userContext.userEducationLevel && attendee.educationLevel) {\n    if (userContext.userEducationLevel === attendee.educationLevel) {\n      if (userContext.userEducationLevel === \"Doctorate\") {\n        predictions.push({ text: \"åŒä¸ºåšå£«å­¦å†\", rarity: 'epic' }); // PhDs are rare\n      } else if (userContext.userEducationLevel === \"Master's\") {\n        predictions.push({ text: \"åŒä¸ºç¡•å£«å­¦å†\", rarity: 'rare' });\n      }\n    }\n  }\n  \n  // Priority 6: Age similarity (COMMON - life stage alignment)\n  if (userContext.userAge && attendee.age) {\n    const ageDiff = Math.abs(userContext.userAge - attendee.age);\n    if (ageDiff <= 3) {\n      predictions.push({ text: \"å¹´é¾„ç›¸è¿‘\", rarity: 'common' });\n    }\n  }\n  \n  // Priority 6.5: Gender matching (COMMON - identity connection)\n  if (userContext.userGender && attendee.gender && \n      userContext.userGender === attendee.gender &&\n      userContext.userGender !== \"Prefer not to say\") {\n    const genderLabels: Record<string, string> = {\n      \"Woman\": \"åŒä¸ºå¥³æ€§\",\n      \"Man\": \"åŒä¸ºç”·æ€§\",\n      \"Nonbinary\": \"åŒä¸ºéäºŒå…ƒæ€§åˆ«\"\n    };\n    \n    if (genderLabels[userContext.userGender]) {\n      predictions.push({ \n        text: genderLabels[userContext.userGender], \n        rarity: 'common' \n      });\n    }\n  }\n  \n  // Priority 6.6: Children/Family status matching (RARE/EPIC - life stage connection)\n  if (userContext.userChildren && attendee.children && \n      userContext.userChildren !== \"Prefer not to say\" &&\n      attendee.children !== \"Prefer not to say\") {\n    \n    if (userContext.userChildren === \"Expecting\" && attendee.children === \"Expecting\") {\n      predictions.push({ text: \"éƒ½åœ¨æœŸå¾…æ–°ç”Ÿå‘½\", rarity: 'epic' }); // Very specific life stage\n    } else if (userContext.userChildren === attendee.children && userContext.userChildren !== \"No kids\") {\n      const childrenLabels: Record<string, { text: string; rarity: RarityLevel }> = {\n        \"0-5\": { text: \"éƒ½æœ‰å­¦é¾„å‰å­©å­\", rarity: 'rare' },\n        \"6-12\": { text: \"éƒ½æœ‰å°å­¦é˜¶æ®µçš„å­©å­\", rarity: 'rare' },\n        \"13-18\": { text: \"éƒ½æœ‰é’å°‘å¹´å­©å­\", rarity: 'rare' },\n        \"Adult\": { text: \"éƒ½æœ‰æˆå¹´å­å¥³\", rarity: 'rare' }\n      };\n      \n      if (childrenLabels[userContext.userChildren]) {\n        predictions.push(childrenLabels[userContext.userChildren]);\n      }\n    } else if (userContext.userChildren === \"No kids\" && attendee.children === \"No kids\") {\n      predictions.push({ text: \"éƒ½æ˜¯ä¸å…‹ä¸€æ—\", rarity: 'common' });\n    }\n  }\n  \n  // Priority 6.7: Specific overseas regions matching (RARE - deeper connection than just \"Overseas\")\n  if (userContext.userOverseasRegions && userContext.userOverseasRegions.length > 0 &&\n      attendee.overseasRegions && attendee.overseasRegions.length > 0) {\n    \n    const commonRegions = userContext.userOverseasRegions.filter(region => \n      attendee.overseasRegions!.includes(region)\n    );\n    \n    if (commonRegions.length > 0) {\n      const regionLabels: Record<string, string> = {\n        \"North America\": \"åŒ—ç¾\",\n        \"Europe\": \"æ¬§æ´²\",\n        \"East Asia (excl. China)\": \"ä¸œäºš\",\n        \"Southeast Asia\": \"ä¸œå—äºš\",\n        \"Oceania\": \"å¤§æ´‹æ´²\",\n        \"South America\": \"å—ç¾\",\n        \"Africa\": \"éæ´²\",\n        \"Middle East\": \"ä¸­ä¸œ\"\n      };\n      \n      const firstRegion = commonRegions[0];\n      const regionName = regionLabels[firstRegion] || firstRegion;\n      \n      predictions.push({ \n        text: `éƒ½åœ¨${regionName}ç•™è¿‡å­¦`, \n        rarity: 'rare' \n      });\n    }\n  }\n  \n  // Priority 7: Hometown matching (RARE/EPIC - è€ä¹¡ connection, default enabled)\n  // Only match if both users have opted in (default is true, so most will match)\n  const userOptedIn = userContext.userHometownAffinityOptin !== false; // default true\n  const attendeeOptedIn = attendee.hometownAffinityOptin !== false; // default true\n  \n  if (userOptedIn && attendeeOptedIn) {\n    // Same city/region - EPIC (very specific)\n    if (userContext.userHometownRegionCity && attendee.hometownRegionCity &&\n        userContext.userHometownRegionCity === attendee.hometownRegionCity) {\n      predictions.push({ \n        text: `è€ä¹¡ï¼éƒ½æ¥è‡ª${userContext.userHometownRegionCity}`, \n        rarity: 'epic' \n      });\n    }\n    // Same country but different cities - RARE\n    else if (userContext.userHometownCountry && attendee.hometownCountry &&\n             userContext.userHometownCountry === attendee.hometownCountry &&\n             userContext.userHometownCountry !== \"ä¸­å›½\") { // China is too broad to be rare\n      const countryLabels: Record<string, string> = {\n        \"ç¾å›½\": \"ç¾å›½\",\n        \"è‹±å›½\": \"è‹±å›½\",\n        \"åŠ æ‹¿å¤§\": \"åŠ æ‹¿å¤§\",\n        \"æ¾³å¤§åˆ©äºš\": \"æ¾³å¤§åˆ©äºš\",\n        \"æ–°åŠ å¡\": \"æ–°åŠ å¡\",\n        \"æ—¥æœ¬\": \"æ—¥æœ¬\",\n        \"éŸ©å›½\": \"éŸ©å›½\"\n      };\n      \n      const countryName = countryLabels[userContext.userHometownCountry] || userContext.userHometownCountry;\n      predictions.push({ \n        text: `éƒ½æ¥è‡ª${countryName}`, \n        rarity: 'rare' \n      });\n    }\n  }\n  \n  // Priority 8: Archetype matching (COMMON - personality alignment)\n  if (attendee.archetype) {\n    const archetypeMatches: Record<string, { compatible: string[]; text: string; rarity: RarityLevel }> = {\n      \"æ¢ç´¢è€…\": { \n        compatible: [\"æ¢ç´¢è€…\", \"å‘å…‰ä½“\"], \n        text: \"éƒ½å–œæ¬¢æ¢ç´¢æ–°é²œäº‹ç‰©\",\n        rarity: 'common'\n      },\n      \"è®²æ•…äº‹çš„äºº\": { \n        compatible: [\"è®²æ•…äº‹çš„äºº\", \"æ™ºè€…\"], \n        text: \"éƒ½æ“…é•¿åˆ†äº«ä¸å€¾å¬\",\n        rarity: 'common'\n      },\n      \"æ™ºè€…\": { \n        compatible: [\"æ™ºè€…\", \"è®²æ•…äº‹çš„äºº\"], \n        text: \"éƒ½äº«å—æ·±åº¦å¯¹è¯\",\n        rarity: 'common'\n      },\n      \"å‘å…‰ä½“\": { \n        compatible: [\"å‘å…‰ä½“\", \"æ¢ç´¢è€…\"], \n        text: \"éƒ½æ˜¯æ´»åŠ›æ»¡æ»¡çš„äºº\",\n        rarity: 'common'\n      },\n      \"ç¨³å®šå™¨\": { \n        compatible: [\"ç¨³å®šå™¨\", \"æ™ºè€…\"], \n        text: \"éƒ½æ˜¯å¯é çš„ä¼™ä¼´\",\n        rarity: 'common'\n      },\n    };\n    \n    // Check if archetypes are compatible\n    const userArchetype = Object.keys(archetypeMatches).find(key => \n      archetypeMatches[key].compatible.includes(attendee.archetype!)\n    );\n    \n    if (userArchetype && archetypeMatches[userArchetype]) {\n      predictions.push({ \n        text: archetypeMatches[userArchetype].text,\n        rarity: archetypeMatches[userArchetype].rarity\n      });\n    }\n  }\n  \n  // Priority 9: Industry matching (RARE - professional connection, but only if different from obvious info)\n  if (userContext.userIndustry && attendee.industry && \n      userContext.userIndustry === attendee.industry &&\n      !attendee.industryVisible) { // Only if industry not visible on card front\n    \n    const industryNames: Record<string, { text: string; rarity: RarityLevel }> = {\n      \"ç§‘æŠ€\": { text: \"éƒ½åœ¨ç§‘æŠ€åœˆ\", rarity: 'rare' },\n      \"é‡‘è\": { text: \"éƒ½åœ¨é‡‘èåœˆ\", rarity: 'rare' },\n      \"è‰ºæœ¯\": { text: \"éƒ½åœ¨è‰ºæœ¯é¢†åŸŸ\", rarity: 'rare' },\n      \"åŒ»ç–—\": { text: \"éƒ½åœ¨åŒ»ç–—è¡Œä¸š\", rarity: 'rare' },\n      \"æ•™è‚²\": { text: \"éƒ½åœ¨æ•™è‚²è¡Œä¸š\", rarity: 'rare' },\n    };\n    \n    if (industryNames[userContext.userIndustry]) {\n      predictions.push({ \n        text: industryNames[userContext.userIndustry].text,\n        rarity: industryNames[userContext.userIndustry].rarity\n      });\n    }\n  }\n  \n  // Priority 10: Epic-level compound matches (multi-dimensional alignment)\n  // These require 3+ factors to align - extremely rare\n  \n  // Triple match: Industry + Education + Study Locale (EPIC)\n  if (userContext.userIndustry && attendee.industry &&\n      userContext.userEducationLevel && attendee.educationLevel &&\n      userContext.userStudyLocale && attendee.studyLocale &&\n      userContext.userIndustry === attendee.industry &&\n      userContext.userEducationLevel === \"Master's\" && attendee.educationLevel === \"Master's\" &&\n      userContext.userStudyLocale === \"Overseas\" && attendee.studyLocale === \"Overseas\") {\n    predictions.push({ \n      text: `åŒä¸º${userContext.userIndustry}åœˆçš„ç¡•å£«æµ·å½’`,\n      rarity: 'epic'\n    });\n  }\n  \n  // ğŸŒŸ NEW Epic-level predictions - Ultra-rare combinations\n  \n  // Creative interdisciplinary background (EPIC)\n  if (userContext.userFieldOfStudy && attendee.fieldOfStudy) {\n    const creativeFields = [\"Arts/Design\", \"Music\", \"Film\"];\n    const techFields = [\"CS\", \"Engineering\"];\n    const businessFields = [\"Business\", \"Economics\"];\n    \n    const userIsCreative = creativeFields.includes(userContext.userFieldOfStudy);\n    const userIsTech = techFields.includes(userContext.userFieldOfStudy);\n    const userIsBusiness = businessFields.includes(userContext.userFieldOfStudy);\n    \n    const attendeeIsCreative = creativeFields.includes(attendee.fieldOfStudy);\n    const attendeeIsTech = techFields.includes(attendee.fieldOfStudy);\n    const attendeeIsBusiness = businessFields.includes(attendee.fieldOfStudy);\n    \n    // Creative + Tech crossover\n    if ((userIsCreative && attendeeIsTech) || (userIsTech && attendeeIsCreative)) {\n      predictions.push({ \n        text: \"è·¨ç•Œåˆ›æ„Ã—æŠ€æœ¯çš„ç¢°æ’\",\n        rarity: 'epic'\n      });\n    }\n    \n    // Creative + Business crossover\n    if ((userIsCreative && attendeeIsBusiness) || (userIsBusiness && attendeeIsCreative)) {\n      predictions.push({ \n        text: \"è‰ºæœ¯ä¸å•†ä¸šçš„èåˆ\",\n        rarity: 'epic'\n      });\n    }\n  }\n  \n  // Digital nomad lifestyle (EPIC)\n  if (userContext.userInterests && attendee.topInterests) {\n    const userHasRemoteWork = userContext.userInterests.some(i => \n      i.includes(\"è¿œç¨‹å·¥ä½œ\") || i.includes(\"æ•°å­—æ¸¸æ°‘\") || i.includes(\"è‡ªç”±èŒä¸š\")\n    );\n    const attendeeHasRemoteWork = attendee.topInterests.some(i => \n      i.includes(\"è¿œç¨‹å·¥ä½œ\") || i.includes(\"æ•°å­—æ¸¸æ°‘\") || i.includes(\"è‡ªç”±èŒä¸š\")\n    );\n    \n    if (userHasRemoteWork && attendeeHasRemoteWork) {\n      predictions.push({ \n        text: \"åŒä¸ºæ•°å­—æ¸¸æ°‘ä¸€æ—\",\n        rarity: 'epic'\n      });\n    }\n  }\n  \n  // Social impact orientation (EPIC)\n  if (userContext.userInterests && attendee.topInterests) {\n    const userHasSocialImpact = userContext.userInterests.some(i => \n      i.includes(\"å…¬ç›Š\") || i.includes(\"ç¤¾ä¼šåˆ›æ–°\") || i.includes(\"å¯æŒç»­\") || i.includes(\"ç¯ä¿\")\n    );\n    const attendeeHasSocialImpact = attendee.topInterests.some(i => \n      i.includes(\"å…¬ç›Š\") || i.includes(\"ç¤¾ä¼šåˆ›æ–°\") || i.includes(\"å¯æŒç»­\") || i.includes(\"ç¯ä¿\")\n    );\n    \n    if (userHasSocialImpact && attendeeHasSocialImpact) {\n      predictions.push({ \n        text: \"éƒ½åœ¨åšæœ‰æ„ä¹‰çš„äº‹\",\n        rarity: 'epic'\n      });\n    }\n  }\n  \n  // Artistic creation experience (EPIC)\n  if (userContext.userInterests && attendee.topInterests) {\n    const artisticInterests = [\"ç»˜ç”»\", \"æ‘„å½±\", \"å†™ä½œ\", \"éŸ³ä¹åˆ›ä½œ\", \"è®¾è®¡\"];\n    \n    const userArtisticCount = userContext.userInterests.filter(i => \n      artisticInterests.some(art => i.includes(art))\n    ).length;\n    \n    const attendeeArtisticCount = attendee.topInterests.filter(i => \n      artisticInterests.some(art => i.includes(art))\n    ).length;\n    \n    if (userArtisticCount >= 2 && attendeeArtisticCount >= 2) {\n      predictions.push({ \n        text: \"åŒä¸ºåˆ›ä½œå‹çµé­‚\",\n        rarity: 'epic'\n      });\n    }\n  }\n  \n  // Career transition journey (EPIC)\n  if (userContext.userSeniority === \"Founder\" && attendee.seniority === \"Founder\" &&\n      userContext.userIndustry && attendee.industry &&\n      userContext.userIndustry !== attendee.industry) {\n    predictions.push({ \n      text: \"éƒ½åœ¨è·¨ç•Œåˆ›ä¸š\",\n      rarity: 'epic'\n    });\n  }\n  \n  // Multi-city living experience (EPIC - based on language diversity)\n  if (userContext.userLanguages && attendee.languagesComfort) {\n    const userLangCount = userContext.userLanguages.length;\n    const attendeeLangCount = attendee.languagesComfort.length;\n    \n    if (userLangCount >= 3 && attendeeLangCount >= 3) {\n      predictions.push({ \n        text: \"éƒ½æ˜¯å¤šå…ƒæ–‡åŒ–çš„æ¢ç´¢è€…\",\n        rarity: 'epic'\n      });\n    }\n  }\n  \n  // ğŸ¯ NEW PRIORITY FEATURES - Using collected but previously unused data\n  \n  // Priority 1.5: Topics matching - RARE/EPIC (more specific than interests)\n  if (userContext.userTopicsHappy && userContext.userTopicsHappy.length > 0 &&\n      attendee.topicsHappy && attendee.topicsHappy.length > 0) {\n    \n    const commonTopics = userContext.userTopicsHappy.filter(topic => \n      attendee.topicsHappy!.includes(topic)\n    );\n    \n    if (commonTopics.length >= 3) {\n      predictions.push({ \n        text: `æœ‰${commonTopics.length}ä¸ªå…±åŒæƒ³èŠçš„è¯é¢˜`, \n        rarity: 'epic' \n      });\n    } else if (commonTopics.length === 2) {\n      predictions.push({ \n        text: \"æœ‰å¤šä¸ªå…±åŒè¯é¢˜\", \n        rarity: 'rare' \n      });\n    }\n  }\n  \n  // Priority 0: Topics anti-matching - CRITICAL (prevent disasters early)\n  // Check if someone's happy topic is another's avoid topic\n  if (userContext.userTopicsHappy && attendee.topicsAvoid) {\n    const hasConflict = userContext.userTopicsHappy.some(topic => \n      attendee.topicsAvoid!.includes(topic)\n    );\n    if (hasConflict) {\n      // This is a red flag - reduce match quality by adding a negative indicator\n      // We don't add this as a connection point, but it affects overall compatibility\n    }\n  }\n  if (userContext.userTopicsAvoid && attendee.topicsHappy) {\n    const hasConflict = userContext.userTopicsAvoid.some(topic => \n      attendee.topicsHappy!.includes(topic)\n    );\n    if (hasConflict) {\n      // Another red flag\n    }\n  }\n  \n  // Priority 6.8: Debate comfort alignment - COMMON/RARE (conversation style match)\n  if (userContext.userDebateComfort !== undefined && attendee.debateComfort !== undefined) {\n    const diff = Math.abs(userContext.userDebateComfort - attendee.debateComfort);\n    \n    if (diff === 0) {\n      predictions.push({ \n        text: \"è®¨è®ºé£æ ¼å®Œå…¨ä¸€è‡´\", \n        rarity: 'rare' \n      });\n    } else if (diff === 1) {\n      predictions.push({ \n        text: \"è®¨è®ºé£æ ¼ç›¸è¿‘\", \n        rarity: 'rare' \n      });\n    } else if (diff === 2) {\n      predictions.push({ \n        text: \"è®¨è®ºèŠ‚å¥ç›¸ä»¿\", \n        rarity: 'common' \n      });\n    }\n    // diff > 2 means different debate styles - might create tension\n  }\n  \n  // Priority 6.9: Life stage/transition detection - RARE/EPIC\n  // Auto-detect from existing age, children, seniority data\n  const detectLifeStage = (age?: number, children?: string, seniority?: string, relationshipStatus?: string): string | null => {\n    if (children === \"Expecting\") return \"expecting_parent\";\n    if (children === \"0-5\") return \"new_parent\";\n    if (children === \"6-12\") return \"school_age_parent\";\n    if (children === \"13-18\") return \"teen_parent\";\n    if (children === \"Adult\") return \"empty_nester\";\n    \n    if (seniority === \"Founder\") return \"entrepreneur\";\n    if (age && age >= 25 && age <= 30 && seniority === \"Junior\") return \"early_career\";\n    if (age && age >= 30 && age <= 35 && (seniority === \"Mid\" || seniority === \"Senior\")) return \"career_prime\";\n    if (age && age >= 35 && age <= 45 && seniority === \"Senior\") return \"established_professional\";\n    \n    if (relationshipStatus === \"Single\" && age && age >= 30) return \"single_professional\";\n    \n    return null;\n  };\n  \n  const userStage = detectLifeStage(\n    userContext.userAge, \n    userContext.userChildren, \n    userContext.userSeniority,\n    userContext.userRelationshipStatus\n  );\n  const attendeeStage = detectLifeStage(\n    attendee.age, \n    attendee.children, \n    attendee.seniority,\n    attendee.relationshipStatus\n  );\n  \n  if (userStage && attendeeStage && userStage === attendeeStage) {\n    const stageLabels: Record<string, { text: string; rarity: RarityLevel }> = {\n      \"expecting_parent\": { text: \"éƒ½åœ¨æœŸå¾…æ–°ç”Ÿå‘½åˆ°æ¥\", rarity: 'epic' },\n      \"new_parent\": { text: \"éƒ½åœ¨ç»å†æ–°æ‰‹çˆ¶æ¯é˜¶æ®µ\", rarity: 'rare' },\n      \"school_age_parent\": { text: \"éƒ½æœ‰å­¦é¾„å„¿ç«¥\", rarity: 'rare' },\n      \"teen_parent\": { text: \"éƒ½åœ¨åº”å¯¹é’æ˜¥æœŸæŒ‘æˆ˜\", rarity: 'rare' },\n      \"empty_nester\": { text: \"å­©å­éƒ½å·²ç‹¬ç«‹\", rarity: 'rare' },\n      \"entrepreneur\": { text: \"éƒ½åœ¨åˆ›ä¸šè·¯ä¸Š\", rarity: 'epic' },\n      \"early_career\": { text: \"éƒ½åœ¨èŒåœºèµ·æ­¥æœŸ\", rarity: 'common' },\n      \"career_prime\": { text: \"éƒ½å¤„äºäº‹ä¸šé»„é‡‘æœŸ\", rarity: 'rare' },\n      \"established_professional\": { text: \"éƒ½æ˜¯èµ„æ·±èŒåœºäºº\", rarity: 'rare' },\n      \"single_professional\": { text: \"éƒ½æ˜¯ç‹¬ç«‹èŒåœºäºº\", rarity: 'common' }\n    };\n    \n    if (stageLabels[userStage]) {\n      predictions.push(stageLabels[userStage]);\n    }\n  }\n  \n  // Priority 6.10: Enhanced language matching beyond Chinese/English - RARE\n  if (userContext.userLanguages && userContext.userLanguages.length > 0 &&\n      attendee.languagesComfort && attendee.languagesComfort.length > 0) {\n    \n    const commonLanguages = userContext.userLanguages.filter(lang => \n      attendee.languagesComfort!.includes(lang)\n    );\n    \n    // Filter out common languages (Chinese, Mandarin, Cantonese, English)\n    const specialLanguages = commonLanguages.filter(lang => \n      ![\"ä¸­æ–‡\", \"æ™®é€šè¯\", \"ç²¤è¯­\", \"Mandarin\", \"Cantonese\", \"English\", \"è‹±è¯­\"].includes(lang)\n    );\n    \n    if (specialLanguages.length >= 2) {\n      predictions.push({ \n        text: `éƒ½ä¼šå¤šç§è¯­è¨€`, \n        rarity: 'rare' \n      });\n    } else if (specialLanguages.length === 1) {\n      predictions.push({ \n        text: `éƒ½ä¼š${specialLanguages[0]}`, \n        rarity: 'rare' \n      });\n    }\n  }\n  \n  // Priority 6.11: Communication style matching - COMMON/RARE\n  // Derived from archetype + debate comfort + personality traits\n  const detectCommunicationStyle = (archetype?: string, debateComfort?: number): string | null => {\n    if (!archetype) return null;\n    \n    // Storytellers: è®²æ•…äº‹çš„äºº, æ™ºè€… (prefer narrative, sharing experiences)\n    if ([\"è®²æ•…äº‹çš„äºº\", \"æ™ºè€…\"].includes(archetype)) {\n      return debateComfort && debateComfort >= 5 ? \"passionate_storyteller\" : \"gentle_storyteller\";\n    }\n    \n    // Listeners: ç¨³å®šå™¨, åè°ƒè€… (prefer listening, asking questions)\n    if ([\"ç¨³å®šå™¨\", \"åè°ƒè€…\", \"è‚¯å®šè€…\"].includes(archetype)) {\n      return \"empathetic_listener\";\n    }\n    \n    // Energizers: å‘å…‰ä½“, ç«èŠ±å¡, æ°›å›´ç»„ (high energy, expressive)\n    if ([\"å‘å…‰ä½“\", \"ç«èŠ±å¡\", \"æ°›å›´ç»„\"].includes(archetype)) {\n      return \"energetic_expressive\";\n    }\n    \n    // Questioners: æ¢ç´¢è€…, æŒ‘æˆ˜è€… (curious, probing)\n    if ([\"æ¢ç´¢è€…\", \"æŒ‘æˆ˜è€…\"].includes(archetype)) {\n      return debateComfort && debateComfort >= 6 ? \"challenger\" : \"curious_questioner\";\n    }\n    \n    // Connectors: è¿æ¥è€…\n    if (archetype === \"è¿æ¥è€…\") {\n      return \"facilitator\";\n    }\n    \n    return null;\n  };\n  \n  const userCommStyle = detectCommunicationStyle(userContext.userArchetype, userContext.userDebateComfort);\n  const attendeeCommStyle = detectCommunicationStyle(attendee.archetype, attendee.debateComfort);\n  \n  if (userCommStyle && attendeeCommStyle) {\n    // Same style = easy rapport\n    if (userCommStyle === attendeeCommStyle) {\n      const styleLabels: Record<string, string> = {\n        \"passionate_storyteller\": \"éƒ½æ˜¯çƒ­æƒ…çš„åˆ†äº«è€…\",\n        \"gentle_storyteller\": \"éƒ½å–„äºå¨“å¨“é“æ¥\",\n        \"empathetic_listener\": \"éƒ½æ˜¯å–„è§£äººæ„çš„å€¾å¬è€…\",\n        \"energetic_expressive\": \"éƒ½æ˜¯æ´»åŠ›å››å°„çš„è¡¨è¾¾è€…\",\n        \"challenger\": \"éƒ½å–œæ¬¢æ€è¾¨è®¨è®º\",\n        \"curious_questioner\": \"éƒ½æ˜¯å¥½å¥‡çš„æé—®è€…\",\n        \"facilitator\": \"éƒ½å–„äºè¿æ¥ä»–äºº\"\n      };\n      \n      if (styleLabels[userCommStyle]) {\n        predictions.push({ \n          text: styleLabels[userCommStyle], \n          rarity: 'common' \n        });\n      }\n    }\n    // Complementary styles = balanced conversation\n    else if (\n      (userCommStyle.includes(\"storyteller\") && attendeeCommStyle === \"empathetic_listener\") ||\n      (attendeeCommStyle.includes(\"storyteller\") && userCommStyle === \"empathetic_listener\")\n    ) {\n      predictions.push({ \n        text: \"åˆ†äº«è€…ä¸å€¾å¬è€…çš„å¹³è¡¡\", \n        rarity: 'rare' \n      });\n    }\n  }\n  \n  // ğŸ¯ Intent-based matching - flexible and specific intents\n  // Logic: \n  // - Both \"flexible\" â†’ common (both open-minded, good chemistry)\n  // - \"flexible\" + specific â†’ neutral (no bonus, flexible people adapt)\n  // - Same specific intent â†’ rare/epic (strong alignment)\n  // - Different specific intents â†’ neutral (no forced mismatch)\n  if (userContext.userIntent && attendee.intent) {\n    const intentLabels: Record<string, { text: string; rarity: RarityLevel }> = {\n      \"flexible\": { text: \"éƒ½ä¿æŒå¼€æ”¾å¿ƒæ€\", rarity: 'common' },\n      \"networking\": { text: \"éƒ½ä¸ºèŒä¸šç¤¾äº¤è€Œæ¥\", rarity: 'rare' },\n      \"friends\": { text: \"éƒ½æƒ³è®¤è¯†æ–°æœ‹å‹\", rarity: 'rare' },\n      \"discussion\": { text: \"éƒ½æœŸå¾…æ·±åº¦å¯¹è¯\", rarity: 'rare' },\n      \"fun\": { text: \"éƒ½æƒ³è½»æ¾ç©ä¹\", rarity: 'common' },\n      \"romance\": { text: \"éƒ½åœ¨å¯»æ‰¾å¦ä¸€åŠ\", rarity: 'epic' }\n    };\n    \n    // Only add connection point if intents match\n    if (userContext.userIntent === attendee.intent && intentLabels[userContext.userIntent]) {\n      predictions.push(intentLabels[userContext.userIntent]);\n    }\n    // Note: flexible + specific intent = neutral (no bonus, no penalty)\n    // Different specific intents = neutral (no forced match)\n  }\n  \n  // ğŸ¯ Anti-repetition scoring - penalize if matched before\n  if (userContext.userMatchedBefore && userContext.userMatchedBefore.includes(attendee.userId)) {\n    // This person has been matched with the user before\n    // We don't add a negative connection point, but the backend matching algorithm\n    // should use this information to lower their overall match score\n    // and prioritize fresh connections instead\n  }\n  \n  // Return top 6 predictions - perfect for 3x2 grid layout\n  return predictions.slice(0, 6);\n}\n\nexport function calculateGroupInsights(attendees: AttendeeData[]): GroupInsight[] {\n  const insights: GroupInsight[] = [];\n  \n  // Industry diversity\n  const industries = new Set<string>();\n  attendees.forEach(attendee => {\n    if (attendee.industry) {\n      industries.add(attendee.industry);\n    }\n  });\n  \n  if (industries.size >= 3) {\n    const industryList = Array.from(industries).slice(0, 3).join(\"ã€\");\n    insights.push({\n      type: 'industry',\n      label: `æ¥è‡ª${industryList}ç­‰${industries.size}ä¸ªè¡Œä¸š`,\n      icon: 'ğŸ’¼'\n    });\n  } else if (industries.size === 2) {\n    const industryList = Array.from(industries).join(\"ã€\");\n    insights.push({\n      type: 'industry',\n      label: `è·¨${industryList}è¡Œä¸š`,\n      icon: 'ğŸ’¼'\n    });\n  }\n  \n  // Common interests\n  const interestMap = new Map<string, number>();\n  attendees.forEach(attendee => {\n    if (attendee.topInterests) {\n      attendee.topInterests.forEach(interest => {\n        const normalizedInterest = normalizeInterestName(interest);\n        interestMap.set(normalizedInterest, (interestMap.get(normalizedInterest) || 0) + 1);\n      });\n    }\n  });\n  \n  const popularInterests = Array.from(interestMap.entries())\n    .filter(([_, count]) => count >= 2)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 3);\n  \n  if (popularInterests.length > 0) {\n    const interestList = popularInterests.map(([interest]) => interest).join(\"ã€\");\n    insights.push({\n      type: 'interest',\n      label: `éƒ½å–œæ¬¢${interestList}`,\n      icon: 'âœ¨'\n    });\n  }\n  \n  // Overseas experience\n  const overseasCount = attendees.filter(\n    a => a.studyLocale === \"Overseas\" || a.studyLocale === \"Both\"\n  ).length;\n  \n  if (overseasCount >= 2) {\n    if (overseasCount === attendees.length) {\n      insights.push({\n        type: 'experience',\n        label: 'å‡æœ‰æµ·å¤–ç»å†',\n        icon: 'ğŸŒ'\n      });\n    } else {\n      insights.push({\n        type: 'experience',\n        label: `${overseasCount}äººæœ‰æµ·å¤–ç»å†`,\n        icon: 'ğŸŒ'\n      });\n    }\n  }\n  \n  // Career stage\n  const seniorityCount = {\n    'Founder': 0,\n    'Executive': 0,\n    'Senior': 0,\n    'Mid': 0,\n    'Junior': 0\n  };\n  \n  attendees.forEach(attendee => {\n    if (attendee.seniority && attendee.seniority in seniorityCount) {\n      seniorityCount[attendee.seniority as keyof typeof seniorityCount]++;\n    }\n  });\n  \n  if (seniorityCount.Founder >= 2) {\n    insights.push({\n      type: 'experience',\n      label: `${seniorityCount.Founder}ä½åˆ›ä¸šè€…`,\n      icon: 'ğŸš€'\n    });\n  } else if (seniorityCount.Senior + seniorityCount.Executive >= 2) {\n    insights.push({\n      type: 'experience',\n      label: 'èŒåœºèµ„æ·±äººå£«èšé›†',\n      icon: 'ğŸ’¡'\n    });\n  } else if (seniorityCount.Mid + seniorityCount.Junior >= 3) {\n    insights.push({\n      type: 'experience',\n      label: 'èŒåœºåŒé¾„äººä¸ºä¸»',\n      icon: 'ğŸ¤'\n    });\n  }\n  \n  // Relationship status\n  const singleCount = attendees.filter(\n    a => a.relationshipStatus === \"Single\"\n  ).length;\n  const marriedCount = attendees.filter(\n    a => a.relationshipStatus === \"Married/Partnered\"\n  ).length;\n  \n  if (singleCount >= 3) {\n    insights.push({\n      type: 'experience',\n      label: 'å•èº«å‹å¥½å±€',\n      icon: 'ğŸ’«'\n    });\n  } else if (marriedCount >= 3) {\n    insights.push({\n      type: 'experience',\n      label: 'å·²å©š/æœ‰ä¼´ä¾£äººå£«',\n      icon: 'ğŸ’‘'\n    });\n  }\n  \n  // Education level\n  const highEducation = attendees.filter(\n    a => a.educationLevel === \"Master's\" || a.educationLevel === \"Doctorate\"\n  ).length;\n  \n  if (highEducation >= 3) {\n    insights.push({\n      type: 'experience',\n      label: 'é«˜å­¦å†äººç¾¤',\n      icon: 'ğŸ“'\n    });\n  }\n  \n  // ğŸ¯ NEW: Group role composition (balanced conversation dynamics)\n  const roleCategories = {\n    storytellers: 0, // è®²æ•…äº‹çš„äºº, æ™ºè€…\n    listeners: 0,    // ç¨³å®šå™¨, åè°ƒè€…, è‚¯å®šè€…\n    energizers: 0,   // å‘å…‰ä½“, ç«èŠ±å¡, æ°›å›´ç»„\n    questioners: 0,  // æ¢ç´¢è€…, æŒ‘æˆ˜è€…\n    connectors: 0    // è¿æ¥è€…\n  };\n  \n  attendees.forEach(attendee => {\n    if (!attendee.archetype) return;\n    \n    if ([\"è®²æ•…äº‹çš„äºº\", \"æ™ºè€…\"].includes(attendee.archetype)) {\n      roleCategories.storytellers++;\n    } else if ([\"ç¨³å®šå™¨\", \"åè°ƒè€…\", \"è‚¯å®šè€…\"].includes(attendee.archetype)) {\n      roleCategories.listeners++;\n    } else if ([\"å‘å…‰ä½“\", \"ç«èŠ±å¡\", \"æ°›å›´ç»„\"].includes(attendee.archetype)) {\n      roleCategories.energizers++;\n    } else if ([\"æ¢ç´¢è€…\", \"æŒ‘æˆ˜è€…\"].includes(attendee.archetype)) {\n      roleCategories.questioners++;\n    } else if (attendee.archetype === \"è¿æ¥è€…\") {\n      roleCategories.connectors++;\n    }\n  });\n  \n  // Ideal composition: balanced roles (no single role > 50%)\n  const totalWithRoles = Object.values(roleCategories).reduce((a, b) => a + b, 0);\n  const maxRoleCount = Math.max(...Object.values(roleCategories));\n  const roleBalance = totalWithRoles > 0 ? maxRoleCount / totalWithRoles : 0;\n  \n  if (roleBalance <= 0.5 && totalWithRoles >= 4) {\n    insights.push({\n      type: 'personality',\n      label: 'è§’è‰²å¹³è¡¡ï¼Œå¯¹è¯æµç•…',\n      icon: 'ğŸ­'\n    });\n  } else if (roleCategories.energizers >= 2 && roleCategories.storytellers >= 1) {\n    insights.push({\n      type: 'personality',\n      label: 'æ´»åŠ›æ»¡æ»¡çš„åˆ†äº«å±€',\n      icon: 'âœ¨'\n    });\n  } else if (roleCategories.listeners >= 2 && roleCategories.storytellers >= 2) {\n    insights.push({\n      type: 'personality',\n      label: 'å€¾å¬ä¸åˆ†äº«å…¼å¤‡',\n      icon: 'ğŸ’¬'\n    });\n  }\n  \n  // ğŸ¯ NEW: Diversity balance scoring (60% similarity, 40% difference)\n  // Calculate similarity across multiple dimensions\n  const calculateDiversityScore = (): number => {\n    if (attendees.length < 2) return 0;\n    \n    let totalDimensions = 0;\n    let similarityScore = 0;\n    \n    // Industry similarity\n    if (industries.size > 0) {\n      totalDimensions++;\n      const industryDiversity = industries.size / attendees.length;\n      similarityScore += (1 - industryDiversity); // Higher when fewer industries (more similar)\n    }\n    \n    // Age similarity (within 5 years = similar)\n    const ages = attendees.filter(a => a.age).map(a => a.age!);\n    if (ages.length >= 2) {\n      totalDimensions++;\n      const avgAge = ages.reduce((a, b) => a + b, 0) / ages.length;\n      const ageVariance = ages.reduce((sum, age) => sum + Math.abs(age - avgAge), 0) / ages.length;\n      const ageSimilarity = Math.max(0, 1 - (ageVariance / 10)); // Normalize to 0-1\n      similarityScore += ageSimilarity;\n    }\n    \n    // Relationship status similarity\n    const relationshipStatuses = new Set(attendees.filter(a => a.relationshipStatus).map(a => a.relationshipStatus!));\n    if (relationshipStatuses.size > 0) {\n      totalDimensions++;\n      const relationshipDiversity = relationshipStatuses.size / attendees.length;\n      similarityScore += (1 - relationshipDiversity);\n    }\n    \n    // Education level similarity\n    const educationLevels = new Set(attendees.filter(a => a.educationLevel).map(a => a.educationLevel!));\n    if (educationLevels.size > 0) {\n      totalDimensions++;\n      const educationDiversity = educationLevels.size / attendees.length;\n      similarityScore += (1 - educationDiversity);\n    }\n    \n    return totalDimensions > 0 ? (similarityScore / totalDimensions) * 100 : 0;\n  };\n  \n  const diversityScore = calculateDiversityScore();\n  \n  // Ideal range: 50-70% similarity (60% target)\n  if (diversityScore >= 50 && diversityScore <= 70) {\n    insights.push({\n      type: 'balance',\n      label: 'ç›¸ä¼¼ä¸å·®å¼‚çš„å®Œç¾å¹³è¡¡',\n      icon: 'âš–ï¸'\n    });\n  } else if (diversityScore >= 70) {\n    insights.push({\n      type: 'balance',\n      label: 'èƒŒæ™¯ç›¸ä¼¼ï¼Œæ˜“äº§ç”Ÿå…±é¸£',\n      icon: 'ğŸ¤'\n    });\n  } else if (diversityScore <= 40 && industries.size >= 3) {\n    insights.push({\n      type: 'balance',\n      label: 'å¤šå…ƒè§†è§’ç¢°æ’',\n      icon: 'ğŸŒˆ'\n    });\n  }\n  \n  return insights.slice(0, 4);\n}\n\n/**\n * Extract connection point types from predictions for feedback correlation\n * This enables tracking which types of connections lead to successful matches\n */\nexport function extractConnectionPointTypes(predictions: SparkPrediction[]): string[] {\n  const types = new Set<string>();\n  \n  predictions.forEach(prediction => {\n    const text = prediction.text.toLowerCase();\n    \n    // Categorize based on prediction text patterns\n    if (text.includes('å…´è¶£') || text.includes('interest') || text.includes('çˆ±å¥½')) {\n      types.add('shared_interests');\n    }\n    if (text.includes('è¯é¢˜') || text.includes('topic')) {\n      types.add('shared_topics');\n    }\n    if (text.includes('è¾©è®º') || text.includes('å¯¹è¯é£æ ¼') || text.includes('debate')) {\n      types.add('debate_comfort');\n    }\n    if (text.includes('è¡Œä¸š') || text.includes('industry') || text.includes('èŒä¸š')) {\n      types.add('industry');\n    }\n    if (text.includes('å­¦å†') || text.includes('education')) {\n      types.add('education');\n    }\n    if (text.includes('äººç”Ÿé˜¶æ®µ') || text.includes('life_stage') || text.includes('expecting') || text.includes('parent')) {\n      types.add('life_stage');\n    }\n    if (text.includes('è¯­è¨€') || text.includes('language')) {\n      types.add('language');\n    }\n    if (text.includes('æ€§åˆ«') || text.includes('gender')) {\n      types.add('gender');\n    }\n    if (text.includes('è€ä¹¡') || text.includes('hometown')) {\n      types.add('hometown');\n    }\n    if (text.includes('æµ·å¤–') || text.includes('overseas')) {\n      types.add('overseas_experience');\n    }\n    if (text.includes('ç¤¾äº¤') || text.includes('äº¤å‹') || text.includes('å¯¹è¯') || text.includes('ç©ä¹') || text.includes('å¦ä¸€åŠ')) {\n      types.add('intent_alignment');\n    }\n    if (text.includes('æ€§æ ¼') || text.includes('archetype') || text.includes('è§’è‰²')) {\n      types.add('personality_archetype');\n    }\n    if (text.includes('æ²Ÿé€šé£æ ¼') || text.includes('communication')) {\n      types.add('communication_style');\n    }\n    if (text.includes('å®¶åº­') || text.includes('family')) {\n      types.add('family_status');\n    }\n  });\n  \n  return Array.from(types);\n}\n\n/**\n * Calculate weighted match score with feedback-based adjustments\n * This is where anti-repetition and feedback loop correlation would be applied\n */\nexport function calculateWeightedMatchScore(\n  predictions: SparkPrediction[],\n  attendeeId: string,\n  userContext: SparkPredictionContext,\n  feedbackWeights?: Record<string, number> // Future: from feedback correlation analysis\n): number {\n  let score = 0;\n  const connectionTypes = extractConnectionPointTypes(predictions);\n  \n  // Base scoring by rarity\n  predictions.forEach(prediction => {\n    switch (prediction.rarity) {\n      case 'epic':\n        score += 10;\n        break;\n      case 'rare':\n        score += 5;\n        break;\n      case 'common':\n        score += 2;\n        break;\n    }\n  });\n  \n  // Apply feedback-based weights (future enhancement)\n  if (feedbackWeights) {\n    connectionTypes.forEach(type => {\n      if (feedbackWeights[type]) {\n        score *= feedbackWeights[type];\n      }\n    });\n  }\n  \n  // Anti-repetition penalty\n  if (userContext.userMatchedBefore && userContext.userMatchedBefore.includes(attendeeId)) {\n    score *= 0.5; // Reduce score by 50% for repeat matches\n  }\n  \n  return score;\n}\n","size_bytes":45704},"client/src/lib/matchExplanation.ts":{"content":"interface AttendeeData {\n  userId: string;\n  displayName: string;\n  archetype?: string;\n  topInterests?: string[];\n  ageBand?: string;\n  industry?: string;\n}\n\nconst explanationTemplates = {\n  sharedInterests: [\n    \"è¿™æ¡Œèšé›†äº†å¯¹{interests}å……æ»¡çƒ­æƒ…çš„æœ‹å‹ã€‚æˆ‘ä»¬å¹³è¡¡äº†{archetype1}çš„{quality1}ä¸{archetype2}çš„{quality2}ï¼Œç¡®ä¿å¯¹è¯æ—¢çƒ­çƒˆåˆæœ‰æ·±åº¦ã€‚\",\n    \"åŸºäºä½ ä»¬å¯¹{interests}çš„å…±åŒå…´è¶£ï¼Œæˆ‘ä»¬ä¸ºä½ ä»¬æ­å»ºäº†è¿™ä¸ªåœˆå­ã€‚{archetype1}å’Œ{archetype2}çš„ç»„åˆä¼šè®©èšä¼šæ—¢æ´»è·ƒåˆæœ‰æ„ä¹‰ã€‚\",\n    \"è¿™æ¡Œæ±‡èšäº†{interests}çˆ±å¥½è€…ã€‚{archetype1}å¸¦æ¥{quality1}ï¼Œ{archetype2}æä¾›{quality2}ï¼Œè¿™ä¸ªç»„åˆå°†åˆ›é€ éš¾å¿˜çš„äº¤æµä½“éªŒã€‚\"\n  ],\n  complementaryVibes: [\n    \"æˆ‘ä»¬ä¸ºå“²å­¦æ¢è®¨å’Œä¸ªäººæ•…äº‹åˆ›é€ äº†ä¸€ä¸ªç©ºé—´ï¼Œé€šè¿‡æ··åˆ{archetype1}å’Œ{archetype2}ã€‚ä½ å¯¹æ·±åº¦å¯¹è¯çš„èˆ’é€‚åº¦ä¸å…¶ä»–åŒæ ·äº«å—è¶…è¶Šè¡¨é¢èŠå¤©çš„æœ‹å‹å®Œç¾åŒ¹é…ã€‚\",\n    \"è¿™æ¡Œå¹³è¡¡äº†{archetype1}çš„{quality1}å’Œ{archetype2}çš„{quality2}ã€‚è¿™æ ·çš„ç»„åˆèƒ½æ¿€å‘æ—¢æœ‰æ·±åº¦åˆè½»æ¾çš„å¯¹è¯æ°›å›´ã€‚\",\n    \"æˆ‘ä»¬å°†{archetype1}å’Œ{archetype2}é…å¯¹ï¼Œåˆ›é€ ä¸€ä¸ªæ€ç»´ç¢°æ’çš„ç©ºé—´ã€‚ä½ ä¼šå‘ç°è¿™æ¡Œçš„åŒ–å­¦ååº”ç‰¹åˆ«å¥½ã€‚\"\n  ],\n  diverseBackgrounds: [\n    \"è¿™ä¸ªå°ç»„èåˆäº†{industries}é¢†åŸŸçš„æœ‹å‹ï¼Œéƒ½å¯¹{interests}å……æ»¡å…´è¶£ã€‚ä¸åŒèƒŒæ™¯çš„ç»„åˆå°†å¸¦æ¥ç‹¬ç‰¹çš„è§†è§’äº¤æµã€‚\",\n    \"æˆ‘ä»¬æ··åˆäº†æ¥è‡ª{industries}çš„æœ‹å‹ï¼Œç»Ÿä¸€äºå¯¹{interests}çš„çƒ­çˆ±ã€‚è¿™æ ·çš„å¤šå…ƒèƒŒæ™¯ç»„åˆä¼šåˆ›é€ ç‰¹åˆ«çš„å¯¹è¯ç«èŠ±ã€‚\",\n    \"è·¨ç•Œç»„åˆï¼š{industries}æ±‡èšä¸€å ‚ï¼Œé€šè¿‡{interests}è¿™ä¸ªå…±åŒè¯­è¨€ç›¸è¿ã€‚æœŸå¾…æ„æƒ³ä¸åˆ°çš„æ€ç»´ç¢°æ’ã€‚\"\n  ]\n};\n\nconst archetypeQualities: Record<string, { zh: string, en: string }> = {\n  // 12-Archetype Animal Social Vibe System\n  \"å¼€å¿ƒæŸ¯åŸº\": { zh: \"æ´»åŠ›ç ´å†°\", en: \"energetic icebreaking\" },\n  \"å¤ªé˜³é¸¡\": { zh: \"æ¸©æš–æ­£èƒ½é‡\", en: \"warm positivity\" },\n  \"å¤¸å¤¸è±š\": { zh: \"ç§¯æé¼“åŠ±\", en: \"uplifting encouragement\" },\n  \"æœºæ™ºç‹\": { zh: \"æ¢ç´¢æ–°é²œ\", en: \"curious exploration\" },\n  \"æ·¡å®šæµ·è±š\": { zh: \"å¹³è¡¡æ°›å›´\", en: \"balanced vibes\" },\n  \"ç»‡ç½‘è››\": { zh: \"ç¤¾äº¤è¿æ¥\", en: \"social networking\" },\n  \"æš–å¿ƒç†Š\": { zh: \"æ·±åº¦å€¾å¬\", en: \"empathetic listening\" },\n  \"çµæ„Ÿç« é±¼\": { zh: \"åˆ›æ„å‘æ•£\", en: \"creative inspiration\" },\n  \"æ²‰æ€çŒ«å¤´é¹°\": { zh: \"æ·±åˆ»æ´å¯Ÿ\", en: \"thoughtful insight\" },\n  \"å®šå¿ƒå¤§è±¡\": { zh: \"ç¨³å®šæ”¯æŒ\", en: \"grounding presence\" },\n  \"ç¨³å¦‚é¾Ÿ\": { zh: \"æ·±åº¦è§‚å¯Ÿ\", en: \"keen observation\" },\n  \"éšèº«çŒ«\": { zh: \"å®‰é™é™ªä¼´\", en: \"gentle presence\" },\n};\n\nfunction getRandomTemplate(templates: string[]): string {\n  return templates[Math.floor(Math.random() * templates.length)];\n}\n\nfunction findCommonInterests(attendees: AttendeeData[]): string[] {\n  const interestCounts = new Map<string, number>();\n  \n  attendees.forEach(attendee => {\n    (attendee.topInterests || []).forEach(interest => {\n      interestCounts.set(interest, (interestCounts.get(interest) || 0) + 1);\n    });\n  });\n  \n  return Array.from(interestCounts.entries())\n    .filter(([_, count]) => count >= 2)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 2)\n    .map(([interest, _]) => interest);\n}\n\nfunction findTopArchetypes(attendees: AttendeeData[]): string[] {\n  const archetypeCounts = new Map<string, number>();\n  \n  attendees.forEach(attendee => {\n    if (attendee.archetype) {\n      archetypeCounts.set(attendee.archetype, (archetypeCounts.get(attendee.archetype) || 0) + 1);\n    }\n  });\n  \n  return Array.from(archetypeCounts.entries())\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 2)\n    .map(([archetype, _]) => archetype);\n}\n\nfunction findIndustries(attendees: AttendeeData[]): string[] {\n  const industries = attendees\n    .map(a => a.industry)\n    .filter((industry): industry is string => !!industry && industry !== \"\");\n  \n  const uniqueIndustries = Array.from(new Set(industries));\n  return uniqueIndustries.slice(0, 3);\n}\n\nexport function generateMatchExplanation(attendees: AttendeeData[]): string {\n  if (!attendees || attendees.length === 0) {\n    return \"æˆ‘ä»¬ä¸ºä½ ç²¾å¿ƒåŒ¹é…äº†ä¸€æ¡Œå¿—åŒé“åˆçš„æœ‹å‹ï¼ŒæœŸå¾…ä½ ä»¬çš„ç²¾å½©èšä¼šï¼\";\n  }\n  \n  const commonInterests = findCommonInterests(attendees);\n  const topArchetypes = findTopArchetypes(attendees);\n  const industries = findIndustries(attendees);\n  \n  // Decide which template category to use\n  let template: string;\n  let explanation: string;\n  \n  if (commonInterests.length >= 2) {\n    // Use shared interests template\n    template = getRandomTemplate(explanationTemplates.sharedInterests);\n    const interestsStr = commonInterests.join(\"ã€\");\n    const archetype1 = topArchetypes[0] || \"æš–å¿ƒç†Š\";\n    const archetype2 = topArchetypes[1] || \"å¼€å¿ƒæŸ¯åŸº\";\n    const quality1 = archetypeQualities[archetype1]?.zh || \"ç‹¬ç‰¹è§†è§’\";\n    const quality2 = archetypeQualities[archetype2]?.zh || \"æ´»åŠ›æ°›å›´\";\n    \n    explanation = template\n      .replace(\"{interests}\", interestsStr)\n      .replace(\"{archetype1}\", archetype1)\n      .replace(\"{archetype2}\", archetype2)\n      .replace(\"{quality1}\", quality1)\n      .replace(\"{quality2}\", quality2);\n      \n  } else if (topArchetypes.length >= 2) {\n    // Use complementary vibes template\n    template = getRandomTemplate(explanationTemplates.complementaryVibes);\n    const archetype1 = topArchetypes[0];\n    const archetype2 = topArchetypes[1];\n    const quality1 = archetypeQualities[archetype1]?.zh || \"ç‹¬ç‰¹è§†è§’\";\n    const quality2 = archetypeQualities[archetype2]?.zh || \"ç”ŸåŠ¨è¡¨è¾¾\";\n    \n    explanation = template\n      .replace(\"{archetype1}\", archetype1)\n      .replace(\"{archetype2}\", archetype2)\n      .replace(\"{quality1}\", quality1)\n      .replace(\"{quality2}\", quality2);\n      \n  } else if (industries.length >= 2) {\n    // Use diverse backgrounds template\n    template = getRandomTemplate(explanationTemplates.diverseBackgrounds);\n    const industriesStr = industries.join(\"ã€\");\n    const interestsStr = commonInterests.length > 0 \n      ? commonInterests.join(\"ã€\")\n      : (attendees[0]?.topInterests?.[0] || \"å…±åŒè¯é¢˜\");\n    \n    explanation = template\n      .replace(\"{industries}\", industriesStr)\n      .replace(\"{interests}\", interestsStr);\n      \n  } else {\n    // Default template\n    explanation = \"æˆ‘ä»¬ä¸ºä½ ç²¾å¿ƒåŒ¹é…äº†ä¸€æ¡Œæœ‰è¶£çš„æœ‹å‹ï¼Œæ¯ä¸ªäººéƒ½æœ‰ç‹¬ç‰¹çš„æ•…äº‹å’Œè§†è§’ã€‚è¿™å°†æ˜¯ä¸€åœºå……æ»¡æƒŠå–œçš„èšä¼šï¼\";\n  }\n  \n  return explanation;\n}\n","size_bytes":6441},"client/src/components/EnergyRing.tsx":{"content":"import { motion } from \"framer-motion\";\n\ninterface EnergyRingProps {\n  percentage: number;\n  qualityTier: 'common' | 'rare' | 'epic';\n  visualBoost?: number;\n  size?: number;\n  strokeWidth?: number;\n  children?: React.ReactNode;\n}\n\nexport default function EnergyRing({\n  percentage,\n  qualityTier,\n  visualBoost = 0,\n  size = 120,\n  strokeWidth = 8,\n  children,\n}: EnergyRingProps) {\n  const radius = (size - strokeWidth) / 2;\n  const circumference = radius * 2 * Math.PI;\n  \n  // Apply visual boost to percentage\n  const displayPercentage = Math.min(percentage + visualBoost, 100);\n  \n  // Quality tier configurations\n  const tierConfigs = {\n    common: {\n      gradientId: 'commonGradient',\n      colors: {\n        start: '#6B7280',\n        mid: '#9CA3AF',\n        end: '#6B7280'\n      },\n      glowColor: 'rgba(107, 114, 128, 0.3)',\n      glowIntensity: [6, 8, 6],\n      breathDuration: 3,\n      particleCount: 0\n    },\n    rare: {\n      gradientId: 'rareGradient',\n      colors: {\n        start: '#8B5CF6',\n        mid: '#A78BFA',\n        end: '#C4B5FD'\n      },\n      glowColor: 'rgba(139, 92, 246, 0.5)',\n      glowIntensity: [8, 12, 8],\n      breathDuration: 2.5,\n      particleCount: 0\n    },\n    epic: {\n      gradientId: 'epicGradient',\n      colors: {\n        start: '#F59E0B',\n        mid: '#FBBF24',\n        end: '#FCD34D'\n      },\n      glowColor: 'rgba(245, 158, 11, 0.6)',\n      glowIntensity: [10, 16, 10],\n      breathDuration: 2,\n      particleCount: 6\n    }\n  };\n\n  const config = tierConfigs[qualityTier];\n  \n  // Calculate segments\n  const segments = 8;\n  const segmentLength = circumference / segments;\n  const gapLength = segmentLength * 0.15;\n  const activeSegmentLength = segmentLength - gapLength;\n  \n  const activeSegments = Math.ceil((displayPercentage / 100) * segments);\n\n  return (\n    <div className=\"relative\" style={{ width: size, height: size }}>\n      <svg\n        width={size}\n        height={size}\n        viewBox={`0 0 ${size} ${size}`}\n        className=\"transform -rotate-90\"\n      >\n        <defs>\n          {/* Quality-based gradient */}\n          <linearGradient id={config.gradientId} x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"100%\">\n            <stop offset=\"0%\" stopColor={config.colors.start} stopOpacity=\"1\" />\n            <stop offset=\"50%\" stopColor={config.colors.mid} stopOpacity=\"0.95\" />\n            <stop offset=\"100%\" stopColor={config.colors.end} stopOpacity=\"1\" />\n          </linearGradient>\n          \n          {/* Quality-based glow effect */}\n          <filter id={`${qualityTier}Glow`}>\n            <feGaussianBlur stdDeviation=\"3.5\" result=\"coloredBlur\"/>\n            <feMerge>\n              <feMergeNode in=\"coloredBlur\"/>\n              <feMergeNode in=\"coloredBlur\"/>\n              <feMergeNode in=\"SourceGraphic\"/>\n            </feMerge>\n          </filter>\n        </defs>\n\n        {/* Ring segments */}\n        {Array.from({ length: segments }).map((_, index) => {\n          const isActive = index < activeSegments;\n          const offset = index * segmentLength;\n          \n          return (\n            <motion.circle\n              key={index}\n              cx={size / 2}\n              cy={size / 2}\n              r={radius}\n              fill=\"none\"\n              stroke={isActive ? `url(#${config.gradientId})` : \"hsl(var(--muted))\"}\n              strokeWidth={strokeWidth}\n              strokeDasharray={`${activeSegmentLength} ${circumference - activeSegmentLength}`}\n              strokeDashoffset={-offset}\n              strokeLinecap=\"round\"\n              opacity={isActive ? 1 : 0.15}\n              filter={isActive ? `url(#${qualityTier}Glow)` : \"none\"}\n              initial={{ opacity: 0 }}\n              animate={{\n                opacity: isActive ? [0.75, 1, 0.75] : 0.15,\n                filter: isActive \n                  ? [\n                      `url(#${qualityTier}Glow) drop-shadow(0 0 ${config.glowIntensity[0]}px ${config.glowColor})`,\n                      `url(#${qualityTier}Glow) drop-shadow(0 0 ${config.glowIntensity[1]}px ${config.glowColor})`,\n                      `url(#${qualityTier}Glow) drop-shadow(0 0 ${config.glowIntensity[2]}px ${config.glowColor})`\n                    ]\n                  : \"none\"\n              }}\n              transition={{\n                duration: config.breathDuration,\n                repeat: Infinity,\n                ease: \"easeInOut\",\n                delay: index * 0.1,\n              }}\n              data-testid={`energy-segment-${index}`}\n            />\n          );\n        })}\n\n        {/* Epic tier: flowing light effect */}\n        {qualityTier === 'epic' && (\n          <motion.circle\n            cx={size / 2}\n            cy={size / 2}\n            r={radius}\n            fill=\"none\"\n            stroke=\"url(#epicGradient)\"\n            strokeWidth={strokeWidth * 0.5}\n            strokeDasharray={`${activeSegmentLength * 0.3} ${circumference}`}\n            strokeLinecap=\"round\"\n            opacity={0.6}\n            animate={{\n              strokeDashoffset: [0, -circumference],\n              opacity: [0.4, 0.7, 0.4]\n            }}\n            transition={{\n              strokeDashoffset: {\n                duration: 3,\n                repeat: Infinity,\n                ease: \"linear\"\n              },\n              opacity: {\n                duration: 2,\n                repeat: Infinity,\n                ease: \"easeInOut\"\n              }\n            }}\n          />\n        )}\n      </svg>\n\n      {/* Center content */}\n      <div className=\"absolute inset-0 flex items-center justify-center\">\n        {children}\n      </div>\n\n      {/* Epic tier: particle orbit effect */}\n      {qualityTier === 'epic' && config.particleCount > 0 && (\n        <>\n          {Array.from({ length: config.particleCount }).map((_, i) => {\n            const angle = (i * 360) / config.particleCount;\n            return (\n              <motion.div\n                key={i}\n                className=\"absolute w-1 h-1 rounded-full bg-amber-400\"\n                style={{\n                  left: '50%',\n                  top: '50%',\n                }}\n                animate={{\n                  x: [\n                    Math.cos((angle * Math.PI) / 180) * (radius + strokeWidth / 2),\n                    Math.cos(((angle + 360) * Math.PI) / 180) * (radius + strokeWidth / 2)\n                  ],\n                  y: [\n                    Math.sin((angle * Math.PI) / 180) * (radius + strokeWidth / 2),\n                    Math.sin(((angle + 360) * Math.PI) / 180) * (radius + strokeWidth / 2)\n                  ],\n                  opacity: [0.6, 1, 0.6],\n                  scale: [0.8, 1.2, 0.8]\n                }}\n                transition={{\n                  duration: 4,\n                  repeat: Infinity,\n                  ease: \"linear\",\n                  delay: i * 0.15\n                }}\n              />\n            );\n          })}\n        </>\n      )}\n    </div>\n  );\n}\n","size_bytes":6908},"client/src/components/MysteryBadge.tsx":{"content":"import { useState } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Sparkles, HelpCircle, Zap, Crown } from \"lucide-react\";\n\ninterface MysteryBadgeProps {\n  icon: string;\n  label: string;\n  type: \"interest\" | \"background\" | \"experience\";\n  rarity: \"common\" | \"rare\" | \"epic\";\n  isRevealed: boolean;\n  onReveal: () => void;\n  delay?: number;\n}\n\nconst rarityStyles = {\n  common: {\n    // Common (å¸¸è§) - ç°è‰²ç³»\n    unrevealedBg: \"bg-gray-100\",\n    unrevealedBorder: \"border-gray-300\",\n    unrevealedBorderWidth: \"border\",\n    revealedBg: \"bg-[#F3F4F6]\",\n    revealedBorder: \"border-[#D1D5DB]\",\n    revealedBorderWidth: \"border\",\n    revealedText: \"text-[#6B7280]\",\n    revealedShadow: \"shadow-none\",\n    glow: \"rgba(209, 213, 219, 0)\",\n    iconColor: \"text-gray-400\",\n  },\n  rare: {\n    // Rare (ç¨€æœ‰) - ç´«è‰²ç³»\n    unrevealedBg: \"bg-purple-50\",\n    unrevealedBorder: \"border-purple-300\",\n    unrevealedBorderWidth: \"border-2\",\n    revealedBg: \"bg-gradient-to-br from-[#EDE9FE] to-[#F5F3FF]\",\n    revealedBorder: \"border-[#8B5CF6]\",\n    revealedBorderWidth: \"border-2\",\n    revealedText: \"text-[#8B5CF6]\",\n    revealedShadow: \"shadow-[0_0_12px_rgba(139,92,246,0.4)]\",\n    glow: \"rgba(139, 92, 246, 0.5)\",\n    iconColor: \"text-purple-500\",\n  },\n  epic: {\n    // Epic (çè´µ) - é‡‘è‰²ç³»\n    unrevealedBg: \"bg-amber-50\",\n    unrevealedBorder: \"border-amber-300\",\n    unrevealedBorderWidth: \"border-2\",\n    revealedBg: \"bg-gradient-to-br from-[#FEF3C7] to-[#FDE68A]\",\n    revealedBorder: \"border-[#F59E0B]\",\n    revealedBorderWidth: \"border-[3px]\",\n    revealedText: \"text-[#F59E0B]\",\n    revealedShadow: \"shadow-[0_0_20px_rgba(245,158,11,0.6)]\",\n    glow: \"rgba(245, 158, 11, 0.7)\",\n    iconColor: \"text-amber-500\",\n  },\n};\n\nconst rarityIcons = {\n  common: null,\n  rare: Zap,\n  epic: Crown,\n};\n\nexport default function MysteryBadge({\n  icon,\n  label,\n  type,\n  rarity,\n  isRevealed,\n  onReveal,\n  delay = 0,\n}: MysteryBadgeProps) {\n  const [isHovered, setIsHovered] = useState(false);\n  const styles = rarityStyles[rarity];\n  const RarityIcon = rarityIcons[rarity];\n\n  return (\n    <motion.div\n      className=\"relative w-full aspect-[4/5] cursor-pointer\"\n      style={{ perspective: \"1000px\", willChange: \"transform\" }}\n      initial={{ scale: 0, y: 20, opacity: 0 }}\n      animate={{\n        scale: 1,\n        y: 0,\n        opacity: 1,\n        rotateY: isHovered && !isRevealed ? 5 : 0,\n      }}\n      transition={{\n        delay,\n        type: \"spring\",\n        stiffness: 260,\n        damping: 20,\n      }}\n      onClick={!isRevealed ? onReveal : undefined}\n      onMouseEnter={() => setIsHovered(true)}\n      onMouseLeave={() => setIsHovered(false)}\n      whileHover={!isRevealed ? { y: -2 } : {}}\n      data-testid={`mystery-badge-${label}`}\n    >\n      <motion.div\n        className=\"relative w-full h-full\"\n        style={{ \n          transformStyle: \"preserve-3d\",\n          willChange: \"transform\"\n        }}\n        animate={{ rotateY: isRevealed ? 180 : 0 }}\n        transition={{ \n          duration: 0.5,\n          ease: [0.4, 0.0, 0.2, 1]\n        }}\n      >\n        {/* Front - Mystery Box */}\n        <div\n          className=\"absolute inset-0 backface-hidden\"\n          style={{\n            backfaceVisibility: \"hidden\",\n            WebkitBackfaceVisibility: \"hidden\",\n          }}\n        >\n          <motion.div\n            className={`w-full h-full rounded-lg ${styles.unrevealedBorderWidth} ${styles.unrevealedBorder} ${styles.unrevealedBg} flex flex-col items-center justify-center gap-2 ${\n              !isRevealed ? \"hover-elevate\" : \"\"\n            }`}\n            animate={\n              !isRevealed && isHovered\n                ? {\n                    scale: [1, 1.05, 1],\n                    boxShadow: [\n                      `0 0 0 ${styles.glow}`,\n                      `0 0 20px ${styles.glow}`,\n                      `0 0 0 ${styles.glow}`,\n                    ],\n                  }\n                : {}\n            }\n            transition={{\n              duration: rarity === \"epic\" ? 0.8 : 1,\n              repeat: Infinity,\n              ease: \"easeInOut\",\n            }}\n          >\n            <motion.div\n              animate={{\n                rotate: [0, rarity === \"epic\" ? 10 : 5, rarity === \"epic\" ? -10 : -5, 0],\n              }}\n              transition={{\n                duration: rarity === \"epic\" ? 1.5 : 2,\n                repeat: Infinity,\n                ease: \"easeInOut\",\n              }}\n            >\n              <HelpCircle className={`w-6 h-6 ${styles.iconColor}`} />\n            </motion.div>\n            <div className={`text-[10px] font-medium ${styles.iconColor}`}>\n              ç‚¹å‡»æ­æ™“\n            </div>\n          </motion.div>\n        </div>\n\n        {/* Back - Revealed Badge */}\n        <div\n          className=\"absolute inset-0 backface-hidden\"\n          style={{\n            backfaceVisibility: \"hidden\",\n            WebkitBackfaceVisibility: \"hidden\",\n            transform: \"rotateY(180deg)\",\n          }}\n        >\n          <motion.div\n            className={`w-full h-full rounded-lg ${styles.revealedBorderWidth} ${styles.revealedBorder} ${styles.revealedBg} ${styles.revealedShadow} flex flex-col items-center justify-center gap-1 p-2 relative overflow-hidden`}\n            initial={{ scale: 1 }}\n            animate={\n              isRevealed\n                ? rarity === \"epic\"\n                  ? {\n                      // Epic: Pre-vibration effect\n                      scale: [1, 0.95, 1.08, 1],\n                      rotate: [0, -2, 2, 0],\n                    }\n                  : {\n                      // Rare: Smooth appearance\n                      scale: [1, 1.05, 1],\n                    }\n                : {}\n            }\n            transition={{\n              delay: 0.6,\n              duration: rarity === \"epic\" ? 0.8 : 0.5,\n              type: \"spring\",\n              stiffness: rarity === \"epic\" ? 400 : 300,\n            }}\n          >\n            {/* Rare: Purple glow pulse */}\n            {rarity === \"rare\" && isRevealed && (\n              <motion.div\n                className=\"absolute inset-0 bg-gradient-to-br from-purple-200/40 via-purple-300/20 to-transparent rounded-lg\"\n                initial={{ opacity: 0 }}\n                animate={{ opacity: [0.3, 0.5, 0.3] }}\n                transition={{ duration: 2, repeat: Infinity, ease: \"easeInOut\" }}\n              />\n            )}\n\n            {/* Epic: Continuous gold glow */}\n            {rarity === \"epic\" && isRevealed && (\n              <motion.div\n                className=\"absolute inset-0 bg-gradient-to-br from-amber-300/30 via-amber-400/20 to-transparent rounded-lg\"\n                initial={{ opacity: 0 }}\n                animate={{ opacity: [0.4, 0.7, 0.4] }}\n                transition={{ duration: 2, repeat: Infinity, ease: \"easeInOut\" }}\n              />\n            )}\n\n            <div className=\"text-xl relative z-10\">{icon}</div>\n            <div className={`text-[10px] font-semibold text-center ${styles.revealedText} leading-tight px-1 relative z-10`}>\n              {label}\n            </div>\n\n            {/* Rarity indicator icon */}\n            {RarityIcon && (\n              <div className=\"absolute top-1 right-1\">\n                <RarityIcon className={`w-3 h-3 ${styles.iconColor}`} />\n              </div>\n            )}\n          </motion.div>\n        </div>\n      </motion.div>\n\n      {/* Sparkle effect when revealed */}\n      <AnimatePresence>\n        {isRevealed && (\n          <>\n            {/* Only show sparkle for rare and epic */}\n            {rarity !== \"common\" && (\n              <motion.div\n                className=\"absolute -top-2 -right-2\"\n                initial={{ scale: 0, rotate: -45 }}\n                animate={{ scale: 1, rotate: 0 }}\n                exit={{ scale: 0, opacity: 0 }}\n                transition={{ delay: 0.5, type: \"spring\" }}\n              >\n                <Sparkles className={`w-4 h-4 ${styles.iconColor}`} />\n              </motion.div>\n            )}\n\n            {/* Epic: Gold burst with particle orbit */}\n            {rarity === \"epic\" && (\n              <>\n                {[...Array(6)].map((_, i) => (\n                  <motion.div\n                    key={i}\n                    className=\"absolute\"\n                    style={{\n                      left: \"50%\",\n                      top: \"50%\",\n                    }}\n                    initial={{ scale: 0, x: \"-50%\", y: \"-50%\" }}\n                    animate={{\n                      scale: [0, 1, 0],\n                      x: [\"-50%\", `${Math.cos((i * Math.PI) / 3) * 50}px`],\n                      y: [\"-50%\", `${Math.sin((i * Math.PI) / 3) * 50}px`],\n                      opacity: [1, 0.8, 0],\n                    }}\n                    transition={{\n                      duration: 1.5,\n                      delay: 0.6 + i * 0.08,\n                      ease: \"easeOut\",\n                    }}\n                  >\n                    <Sparkles className=\"w-3 h-3 text-[#F59E0B]\" />\n                  </motion.div>\n                ))}\n              </>\n            )}\n          </>\n        )}\n      </AnimatePresence>\n    </motion.div>\n  );\n}\n","size_bytes":9208},"client/src/components/StackedAttendeeCards.tsx":{"content":"import { useState } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { X } from \"lucide-react\";\n\ninterface Attendee {\n  userId: string;\n  displayName: string;\n  archetype?: string;\n  topInterests?: string[];\n  industry?: string;\n  ageVisible?: boolean;\n  industryVisible?: boolean;\n}\n\ninterface ConnectionPoint {\n  label: string;\n  type: string;\n}\n\ninterface StackedAttendeeCardsProps {\n  attendees: Attendee[];\n  connectionPoints: Record<string, ConnectionPoint[]>;\n}\n\nexport default function StackedAttendeeCards({ attendees, connectionPoints }: StackedAttendeeCardsProps) {\n  const [selectedAttendee, setSelectedAttendee] = useState<Attendee | null>(null);\n  const [currentIndex, setCurrentIndex] = useState(0);\n\n  const handleNext = () => {\n    setCurrentIndex((prev) => (prev + 1) % attendees.length);\n  };\n\n  const handlePrev = () => {\n    setCurrentIndex((prev) => (prev - 1 + attendees.length) % attendees.length);\n  };\n\n  const getArchetypeEmoji = (archetype?: string) => {\n    const emojiMap: Record<string, string> = {\n      \"æ¢ç´¢è€…\": \"ğŸ§­\",\n      \"è®²æ•…äº‹çš„äºº\": \"ğŸ“–\",\n      \"æ™ºè€…\": \"ğŸ¦‰\",\n      \"å‘å…‰ä½“\": \"â­\",\n    };\n    return emojiMap[archetype || \"\"] || \"ğŸ‘¤\";\n  };\n\n  return (\n    <>\n      <div className=\"relative h-[360px]\">\n        <div className=\"relative w-full h-full flex items-center justify-center\">\n          {attendees.map((attendee, index) => {\n            const offset = index - currentIndex;\n            const absOffset = Math.abs(offset);\n            const isVisible = absOffset <= 2;\n            \n            return (\n              <motion.div\n                key={attendee.userId}\n                className=\"absolute w-[280px]\"\n                initial={false}\n                animate={{\n                  x: offset * 40,\n                  y: absOffset * 8,\n                  scale: 1 - absOffset * 0.08,\n                  opacity: isVisible ? 1 - absOffset * 0.3 : 0,\n                  zIndex: 10 - absOffset,\n                }}\n                transition={{ type: \"spring\", stiffness: 300, damping: 30 }}\n                style={{ pointerEvents: offset === 0 ? \"auto\" : \"none\" }}\n              >\n                <Card\n                  className=\"hover-elevate active-elevate-2 cursor-pointer shadow-lg\"\n                  onClick={() => offset === 0 && setSelectedAttendee(attendee)}\n                  data-testid={`attendee-card-${index}`}\n                >\n                  <CardContent className=\"p-6\">\n                    <div className=\"text-center space-y-3\">\n                      <div className=\"text-5xl\">{getArchetypeEmoji(attendee.archetype)}</div>\n                      <h3 className=\"text-xl font-bold\">{attendee.displayName}</h3>\n                      {attendee.archetype && (\n                        <Badge variant=\"secondary\" className=\"bg-primary/10 text-primary\">\n                          {attendee.archetype}\n                        </Badge>\n                      )}\n                      <p className=\"text-sm text-muted-foreground line-clamp-2\">\n                        {attendee.topInterests?.slice(0, 2).join(\" Â· \")}\n                      </p>\n                      {connectionPoints[attendee.userId] && connectionPoints[attendee.userId].length > 0 && (\n                        <div className=\"flex items-center justify-center gap-1 text-xs text-primary\">\n                          <span>ä¸ä½ æœ‰</span>\n                          <span className=\"font-bold\">{connectionPoints[attendee.userId].length}</span>\n                          <span>ä¸ªå…±åŒç‚¹</span>\n                          <span className=\"ml-1\">â€¢â€¢â€¢</span>\n                        </div>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              </motion.div>\n            );\n          })}\n        </div>\n\n        {attendees.length > 1 && (\n          <div className=\"absolute bottom-0 left-0 right-0 flex items-center justify-center gap-4\">\n            <button\n              onClick={handlePrev}\n              className=\"w-10 h-10 rounded-full bg-card border hover-elevate active-elevate-2 flex items-center justify-center\"\n              data-testid=\"button-prev-attendee\"\n            >\n              â†\n            </button>\n            <div className=\"flex gap-1.5\">\n              {attendees.map((_, index) => (\n                <div\n                  key={index}\n                  className=\"w-2 h-2 rounded-full transition-all\"\n                  style={{\n                    backgroundColor: index === currentIndex ? \"hsl(var(--primary))\" : \"hsl(var(--muted))\",\n                    transform: index === currentIndex ? \"scale(1.2)\" : \"scale(1)\",\n                  }}\n                />\n              ))}\n            </div>\n            <button\n              onClick={handleNext}\n              className=\"w-10 h-10 rounded-full bg-card border hover-elevate active-elevate-2 flex items-center justify-center\"\n              data-testid=\"button-next-attendee\"\n            >\n              â†’\n            </button>\n          </div>\n        )}\n      </div>\n\n      <AnimatePresence>\n        {selectedAttendee && (\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            className=\"fixed inset-0 z-50 flex items-center justify-center p-4\"\n            onClick={() => setSelectedAttendee(null)}\n          >\n            <motion.div\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              exit={{ opacity: 0 }}\n              className=\"absolute inset-0 bg-background/80 backdrop-blur-md\"\n            />\n\n            <motion.div\n              initial={{ scale: 0.9, opacity: 0, y: 20 }}\n              animate={{ scale: 1, opacity: 1, y: 0 }}\n              exit={{ scale: 0.9, opacity: 0, y: 20 }}\n              transition={{ type: \"spring\", stiffness: 300, damping: 25 }}\n              onClick={(e) => e.stopPropagation()}\n              className=\"relative z-10 w-full max-w-md\"\n              data-testid=\"expanded-attendee-card\"\n            >\n              <Card className=\"shadow-2xl\">\n                <CardContent className=\"p-6 space-y-6\">\n                  <button\n                    onClick={() => setSelectedAttendee(null)}\n                    className=\"absolute top-4 right-4 w-8 h-8 rounded-full bg-muted hover-elevate active-elevate-2 flex items-center justify-center\"\n                    data-testid=\"button-close-expanded\"\n                  >\n                    <X className=\"w-4 h-4\" />\n                  </button>\n\n                  <motion.div\n                    initial={{ opacity: 0, y: 10 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    transition={{ delay: 0.1 }}\n                    className=\"text-center space-y-3\"\n                  >\n                    <div className=\"text-6xl\">{getArchetypeEmoji(selectedAttendee.archetype)}</div>\n                    <h2 className=\"text-2xl font-bold\">{selectedAttendee.displayName}</h2>\n                    {selectedAttendee.archetype && (\n                      <Badge variant=\"secondary\" className=\"bg-primary/10 text-primary\">\n                        {selectedAttendee.archetype}\n                      </Badge>\n                    )}\n                  </motion.div>\n\n                  {selectedAttendee.topInterests && selectedAttendee.topInterests.length > 0 && (\n                    <motion.div\n                      initial={{ opacity: 0, y: 10 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      transition={{ delay: 0.2 }}\n                      className=\"space-y-2\"\n                    >\n                      <h3 className=\"text-sm font-medium text-muted-foreground\">ä¸ªäººå…´è¶£</h3>\n                      <div className=\"flex flex-wrap gap-2\">\n                        {selectedAttendee.topInterests.map((interest, index) => (\n                          <Badge key={index} variant=\"outline\" className=\"bg-accent/30\">\n                            {interest}\n                          </Badge>\n                        ))}\n                      </div>\n                    </motion.div>\n                  )}\n\n                  {connectionPoints[selectedAttendee.userId] && connectionPoints[selectedAttendee.userId].length > 0 && (\n                    <motion.div\n                      initial={{ opacity: 0, y: 10 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      transition={{ delay: 0.3 }}\n                      className=\"space-y-2\"\n                    >\n                      <h3 className=\"text-sm font-medium text-primary\">ä¸ä½ çš„å…±åŒç‚¹</h3>\n                      <div className=\"flex flex-wrap gap-2\">\n                        {connectionPoints[selectedAttendee.userId].map((point, index) => (\n                          <motion.div\n                            key={index}\n                            initial={{ opacity: 0, scale: 0.8 }}\n                            animate={{ opacity: 1, scale: 1 }}\n                            transition={{ delay: 0.4 + index * 0.05 }}\n                          >\n                            <Badge className=\"bg-primary/10 text-primary border-primary/30\">\n                              {point.label}\n                            </Badge>\n                          </motion.div>\n                        ))}\n                      </div>\n                    </motion.div>\n                  )}\n\n                  {selectedAttendee.industryVisible && selectedAttendee.industry && (\n                    <motion.div\n                      initial={{ opacity: 0, y: 10 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      transition={{ delay: 0.4 }}\n                      className=\"pt-4 border-t space-y-2 text-sm\"\n                    >\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-muted-foreground\">è¡Œä¸š</span>\n                        <span className=\"font-medium\">{selectedAttendee.industry}</span>\n                      </div>\n                    </motion.div>\n                  )}\n                </CardContent>\n              </Card>\n            </motion.div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </>\n  );\n}\n","size_bytes":10372},"client/src/components/UserConnectionCard.tsx":{"content":"import { useState } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { User, GraduationCap, Briefcase, MapPin, RotateCw } from \"lucide-react\";\nimport EnergyRing from \"./EnergyRing\";\nimport MysteryBadge from \"./MysteryBadge\";\nimport type { AttendeeData } from \"@/lib/attendeeAnalytics\";\nimport { calculateMatchQuality } from \"@/lib/attendeeAnalytics\";\n\ninterface ConnectionTag {\n  icon: string;\n  label: string;\n  type: \"interest\" | \"background\" | \"experience\";\n  rarity: \"common\" | \"rare\" | \"epic\";\n}\n\ninterface UserConnectionCardProps {\n  attendee: AttendeeData;\n  connectionTags: ConnectionTag[];\n}\n\n// 8ä¸ªæ ¸å¿ƒç¤¾äº¤è§’è‰²ç³»ç»Ÿ - å›¾æ ‡å’Œé¢œè‰²é…ç½®\nconst archetypeConfig: Record<string, { icon: string; color: string; bgColor: string }> = {\n  \"ç«èŠ±å¡\": {\n    icon: \"ğŸ™Œ\",\n    color: \"text-orange-600 dark:text-orange-400\",\n    bgColor: \"bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-yellow-950/40 dark:to-orange-950/40\"\n  },\n  \"æ¢ç´¢è€…\": {\n    icon: \"ğŸ§­\",\n    color: \"text-cyan-600 dark:text-cyan-400\",\n    bgColor: \"bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-950/40 dark:to-cyan-950/40\"\n  },\n  \"æ•…äº‹å®¶\": {\n    icon: \"ğŸ—£ï¸\",\n    color: \"text-purple-600 dark:text-purple-400\",\n    bgColor: \"bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-950/40 dark:to-pink-950/40\"\n  },\n  \"æŒ‘æˆ˜è€…\": {\n    icon: \"ğŸ’ª\",\n    color: \"text-red-600 dark:text-red-400\",\n    bgColor: \"bg-gradient-to-br from-red-50 to-rose-50 dark:from-red-950/40 dark:to-rose-950/40\"\n  },\n  \"è¿æ¥è€…\": {\n    icon: \"ğŸ¤—\",\n    color: \"text-emerald-600 dark:text-emerald-400\",\n    bgColor: \"bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-950/40 dark:to-emerald-950/40\"\n  },\n  \"åè°ƒè€…\": {\n    icon: \"ğŸ§˜\",\n    color: \"text-indigo-600 dark:text-indigo-400\",\n    bgColor: \"bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-indigo-950/40 dark:to-blue-950/40\"\n  },\n  \"æ°›å›´ç»„\": {\n    icon: \"ğŸ•º\",\n    color: \"text-fuchsia-600 dark:text-fuchsia-400\",\n    bgColor: \"bg-gradient-to-br from-pink-50 to-fuchsia-50 dark:from-pink-950/40 dark:to-fuchsia-950/40\"\n  },\n  \"è‚¯å®šè€…\": {\n    icon: \"ğŸ™\",\n    color: \"text-teal-600 dark:text-teal-400\",\n    bgColor: \"bg-gradient-to-br from-teal-50 to-green-50 dark:from-teal-950/40 dark:to-green-950/40\"\n  },\n};\n\nexport default function UserConnectionCard({\n  attendee,\n  connectionTags,\n}: UserConnectionCardProps) {\n  const [isFlipped, setIsFlipped] = useState(false);\n  const [revealedBadges, setRevealedBadges] = useState<Set<number>>(new Set());\n\n  const archetypeData = attendee.archetype && archetypeConfig[attendee.archetype]\n    ? archetypeConfig[attendee.archetype]\n    : { icon: \"âœ¨\", color: \"text-muted-foreground\", bgColor: \"bg-muted/20\" };\n\n  // Calculate match quality based on rarity\n  const sparkPredictions = connectionTags.map(tag => ({\n    text: tag.label,\n    rarity: tag.rarity\n  }));\n  \n  const matchQuality = calculateMatchQuality(sparkPredictions);\n\n  const handleBadgeReveal = (index: number) => {\n    setRevealedBadges((prev) => new Set(prev).add(index));\n  };\n\n  const allRevealed = revealedBadges.size === connectionTags.length;\n\n  // Format display values\n  const genderDisplay = attendee.gender === \"Woman\" ? \"å¥³\" : \n                       attendee.gender === \"Man\" ? \"ç”·\" : \n                       attendee.gender || \"\";\n  \n  const educationDisplay = attendee.educationLevel === \"Bachelor's\" ? \"æœ¬ç§‘\" :\n                          attendee.educationLevel === \"Master's\" ? \"ç¡•å£«\" :\n                          attendee.educationLevel === \"Doctorate\" ? \"åšå£«\" :\n                          attendee.educationLevel || \"\";\n  \n  // Match number color to energy ring tier\n  const numberColorClass = {\n    epic: 'text-[#F59E0B]',    // Gold for epic\n    rare: 'text-[#8B5CF6]',    // Purple for rare\n    common: 'text-[#6B7280]'   // Gray for common\n  }[matchQuality.qualityTier];\n\n  return (\n    <div\n      className=\"min-w-[240px] w-[240px] flex-shrink-0\"\n      data-testid={`connection-card-${attendee.userId}`}\n    >\n      <div \n        className=\"relative h-[468px]\"\n        style={{ perspective: \"1200px\", willChange: \"transform\" }}\n      >\n        <motion.div\n          className=\"relative w-full h-full\"\n          style={{ \n            transformStyle: \"preserve-3d\",\n            willChange: \"transform\"\n          }}\n          animate={{ \n            rotateY: isFlipped ? 180 : 0,\n          }}\n          transition={{ \n            duration: 0.5,\n            ease: [0.4, 0.0, 0.2, 1],\n          }}\n        >\n          {/* Front Side - User Info */}\n          <div\n            className=\"absolute inset-0 w-full h-full\"\n            style={{\n              backfaceVisibility: \"hidden\",\n              WebkitBackfaceVisibility: \"hidden\",\n              transform: \"rotateY(0deg)\",\n            }}\n          >\n            <Card className=\"h-full overflow-hidden border-2 hover-elevate transition-all\">\n              <CardContent className=\"p-4 space-y-4 h-full flex flex-col\">\n                {/* Upper Zone: User Identity */}\n                <div className=\"flex gap-3 items-start\">\n                  {/* Left: Archetype Icon */}\n                  <div className=\"flex-shrink-0 flex flex-col items-center gap-1\">\n                    <div className={`w-14 h-14 rounded-xl ${archetypeData.bgColor} flex items-center justify-center text-2xl`}>\n                      {archetypeData.icon}\n                    </div>\n                    <div className={`text-xs font-semibold text-center ${archetypeData.color}`}>\n                      {attendee.archetype}\n                    </div>\n                  </div>\n\n                  {/* Right: Personal Info */}\n                  <div className=\"flex-1 space-y-2 pt-1\">\n                    <div className=\"font-bold text-base\" data-testid={`text-name-${attendee.userId}`}>\n                      {attendee.displayName}\n                    </div>\n\n                    <div className=\"space-y-1.5 text-xs\">\n                      {/* Gender Â· Age */}\n                      {(genderDisplay || attendee.age) && (\n                        <div className=\"flex items-center gap-1.5 text-foreground\">\n                          <User className=\"h-3 w-3 text-muted-foreground\" />\n                          <span>\n                            {genderDisplay && <span>{genderDisplay}</span>}\n                            {genderDisplay && attendee.age && <span> Â· </span>}\n                            {attendee.age && <span>{attendee.age}å²</span>}\n                          </span>\n                        </div>\n                      )}\n\n                      {/* Education Â· Field of Study */}\n                      {(educationDisplay || attendee.fieldOfStudy) && (\n                        <div className=\"flex items-center gap-1.5 text-foreground\">\n                          <GraduationCap className=\"h-3 w-3 text-muted-foreground\" />\n                          <span>\n                            {educationDisplay && <span>{educationDisplay}</span>}\n                            {educationDisplay && attendee.fieldOfStudy && <span className=\"text-muted-foreground\"> Â· </span>}\n                            {attendee.fieldOfStudy && <span className=\"text-muted-foreground\">{attendee.fieldOfStudy}</span>}\n                          </span>\n                        </div>\n                      )}\n\n                      {/* Industry Â· Seniority */}\n                      {(attendee.industry || attendee.seniority) && (\n                        <div className=\"flex items-center gap-1.5 text-foreground\">\n                          <Briefcase className=\"h-3 w-3 text-muted-foreground\" />\n                          <span>\n                            {attendee.industry && <span>{attendee.industry}</span>}\n                            {attendee.industry && attendee.seniority && <span className=\"text-muted-foreground\"> Â· </span>}\n                            {attendee.seniority && (\n                              <span className=\"text-muted-foreground\">\n                                {attendee.seniority === \"Junior\" ? \"åˆçº§\" : \n                                 attendee.seniority === \"Mid\" ? \"ä¸­çº§\" : \n                                 attendee.seniority === \"Senior\" ? \"é«˜çº§\" :\n                                 attendee.seniority === \"Founder\" ? \"åˆ›å§‹äºº\" : attendee.seniority}\n                              </span>\n                            )}\n                          </span>\n                        </div>\n                      )}\n\n                      {/* Hometown */}\n                      {attendee.hometownRegionCity && (\n                        <div className=\"flex items-center gap-1.5 text-foreground\">\n                          <MapPin className=\"h-3 w-3 text-muted-foreground\" />\n                          <span>{attendee.hometownRegionCity}</span>\n                        </div>\n                      )}\n\n                      {/* Languages */}\n                      {attendee.languagesComfort && attendee.languagesComfort.length > 0 && (\n                        <div className=\"text-muted-foreground leading-relaxed\">\n                          ğŸŒ {attendee.languagesComfort.join(\" Â· \")}\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </div>\n\n                {/* Lower Zone: Energy Ring surrounding Connection Count */}\n                <div className=\"flex-1 flex flex-col justify-center items-center gap-4 border-t pt-6\">\n                  {/* Energy Ring with Connection Count */}\n                  <EnergyRing \n                    percentage={matchQuality.percentage}\n                    qualityTier={matchQuality.qualityTier}\n                    visualBoost={matchQuality.visualBoost}\n                    size={140}\n                    strokeWidth={8}\n                  >\n                    <div className=\"flex flex-col items-center justify-center\">\n                      <div className={`text-5xl font-bold ${numberColorClass}`}>\n                        {connectionTags.length}\n                      </div>\n                      <div className=\"text-xs font-medium text-muted-foreground mt-1 text-center px-2\">\n                        ä¸ªæ½œåœ¨å¥‘åˆç‚¹\n                      </div>\n                    </div>\n                  </EnergyRing>\n\n                  <motion.button\n                    onClick={() => setIsFlipped(true)}\n                    className=\"flex items-center gap-2 px-4 py-2 rounded-lg bg-primary/10 text-primary hover-elevate active-elevate-2 text-sm font-medium\"\n                    whileHover={{ scale: 1.02 }}\n                    whileTap={{ scale: 0.98 }}\n                    data-testid={`button-flip-${attendee.userId}`}\n                  >\n                    <RotateCw className=\"h-4 w-4\" />\n                    ç‚¹å‡»ç¿»è½¬æ¢ç´¢\n                  </motion.button>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Back Side - Mystery Badges Only */}\n          <div\n            className=\"absolute inset-0 w-full h-full\"\n            style={{\n              backfaceVisibility: \"hidden\",\n              WebkitBackfaceVisibility: \"hidden\",\n              transform: \"rotateY(180deg)\",\n            }}\n          >\n            <Card className=\"h-full overflow-hidden border-2 hover-elevate transition-all\">\n              <CardContent className=\"p-4 h-full flex flex-col\">\n                {/* Header with title and flip back button */}\n                <div className=\"flex items-center justify-between mb-4\">\n                  <div className=\"text-sm font-medium text-muted-foreground\">\n                    âœ¨ æˆ‘ä»¬çš„æ½œåœ¨å¥‘åˆç‚¹\n                  </div>\n                  <motion.button\n                    onClick={() => setIsFlipped(false)}\n                    className=\"p-1.5 rounded-md hover-elevate active-elevate-2 text-muted-foreground\"\n                    whileHover={{ scale: 1.1 }}\n                    whileTap={{ scale: 0.9 }}\n                    data-testid={`button-flip-back-${attendee.userId}`}\n                  >\n                    <RotateCw className=\"h-4 w-4\" />\n                  </motion.button>\n                </div>\n\n                {/* Mystery Badges Grid */}\n                <div className=\"flex-1 overflow-y-auto\" style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    {connectionTags.map((badge, idx) => (\n                      <MysteryBadge\n                        key={idx}\n                        icon={badge.icon}\n                        label={badge.label}\n                        type={badge.type}\n                        rarity={badge.rarity}\n                        isRevealed={revealedBadges.has(idx)}\n                        onReveal={() => handleBadgeReveal(idx)}\n                        delay={idx * 0.1}\n                      />\n                    ))}\n                  </div>\n                </div>\n\n                {/* Completion Message */}\n                <AnimatePresence>\n                  {allRevealed && (\n                    <motion.div\n                      initial={{ opacity: 0, y: 10 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      exit={{ opacity: 0, y: 10 }}\n                      transition={{ delay: 0.3 }}\n                      className=\"text-center text-xs text-primary font-medium pt-3 border-t mt-3\"\n                    >\n                      ğŸ‰ å…¨éƒ¨è§£é”å®Œæˆï¼\n                    </motion.div>\n                  )}\n                </AnimatePresence>\n              </CardContent>\n            </Card>\n          </div>\n        </motion.div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":13783},"client/src/components/ConnectionLines.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { motion } from \"framer-motion\";\n\ninterface ConnectionPoint {\n  x: number;\n  y: number;\n  id: string;\n}\n\ninterface ConnectionLinesProps {\n  points: ConnectionPoint[];\n  containerRef?: React.RefObject<HTMLElement>;\n}\n\nexport default function ConnectionLines({ points }: ConnectionLinesProps) {\n  const [particles, setParticles] = useState<Array<{ id: string; pathIndex: number }>>([]);\n\n  useEffect(() => {\n    const initialParticles = points.slice(0, -1).map((_, index) => ({\n      id: `particle-${index}`,\n      pathIndex: index,\n    }));\n    setParticles(initialParticles);\n  }, [points]);\n\n  if (points.length < 2) return null;\n\n  const paths: Array<[ConnectionPoint, ConnectionPoint]> = [];\n  for (let i = 0; i < points.length - 1; i++) {\n    paths.push([points[i], points[i + 1]]);\n  }\n\n  return (\n    <svg\n      className=\"absolute inset-0 pointer-events-none\"\n      style={{ width: \"100%\", height: \"100%\" }}\n    >\n      <defs>\n        <linearGradient id=\"connectionGradient\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\n          <stop offset=\"0%\" stopColor=\"hsl(var(--primary))\" stopOpacity=\"0.1\" />\n          <stop offset=\"50%\" stopColor=\"hsl(var(--primary))\" stopOpacity=\"0.3\" />\n          <stop offset=\"100%\" stopColor=\"hsl(var(--primary))\" stopOpacity=\"0.1\" />\n        </linearGradient>\n        \n        <filter id=\"glow\">\n          <feGaussianBlur stdDeviation=\"2\" result=\"coloredBlur\" />\n          <feMerge>\n            <feMergeNode in=\"coloredBlur\" />\n            <feMergeNode in=\"SourceGraphic\" />\n          </feMerge>\n        </filter>\n      </defs>\n\n      {paths.map(([start, end], index) => {\n        const midX = (start.x + end.x) / 2;\n        const midY = (start.y + end.y) / 2;\n        const controlY = midY - 30;\n\n        const path = `M ${start.x} ${start.y} Q ${midX} ${controlY} ${end.x} ${end.y}`;\n\n        return (\n          <g key={`connection-${index}`}>\n            <motion.path\n              d={path}\n              fill=\"none\"\n              stroke=\"url(#connectionGradient)\"\n              strokeWidth=\"2\"\n              strokeDasharray=\"5,5\"\n              initial={{ pathLength: 0, opacity: 0 }}\n              animate={{ pathLength: 1, opacity: 1 }}\n              transition={{ duration: 1, delay: index * 0.2, ease: \"easeInOut\" }}\n            />\n\n            <motion.circle\n              r=\"3\"\n              fill=\"hsl(var(--primary))\"\n              filter=\"url(#glow)\"\n              initial={{ opacity: 0 }}\n              animate={{ opacity: [0, 1, 1, 0] }}\n              transition={{\n                duration: 2,\n                delay: index * 0.3,\n                repeat: Infinity,\n                repeatDelay: 1,\n              }}\n            >\n              <animateMotion dur=\"2s\" repeatCount=\"indefinite\" path={path} />\n            </motion.circle>\n          </g>\n        );\n      })}\n    </svg>\n  );\n}\n","size_bytes":2883},"client/src/components/InteractiveArchetypeChart.tsx":{"content":"import { useState } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Card, CardContent } from \"@/components/ui/card\";\n\ninterface ArchetypeData {\n  name: string;\n  percentage: number;\n  color: string;\n  emoji: string;\n  description: string;\n}\n\ninterface InteractiveArchetypeChartProps {\n  data: ArchetypeData[];\n}\n\nexport default function InteractiveArchetypeChart({ data }: InteractiveArchetypeChartProps) {\n  const [selectedArchetype, setSelectedArchetype] = useState<ArchetypeData | null>(null);\n  const [hoveredIndex, setHoveredIndex] = useState<number | null>(null);\n\n  const total = data.reduce((sum, item) => sum + item.percentage, 0);\n  let currentAngle = -90;\n\n  return (\n    <div className=\"space-y-2\">\n      <div className=\"relative w-full aspect-square max-w-[240px] mx-auto\">\n        <svg viewBox=\"0 0 200 200\" className=\"transform -rotate-90\">\n          {data.map((item, index) => {\n            const percentage = (item.percentage / total) * 100;\n            const angle = (percentage / 100) * 360;\n            const radius = 70;\n            const strokeWidth = 20;\n            const normalizedRadius = radius - strokeWidth / 2;\n            const circumference = normalizedRadius * 2 * Math.PI;\n            const strokeDashoffset = circumference - (percentage / 100) * circumference;\n\n            const startAngle = currentAngle;\n            currentAngle += angle;\n\n            const isHovered = hoveredIndex === index;\n            const isSelected = selectedArchetype?.name === item.name;\n            const scale = isHovered || isSelected ? 1.05 : 1;\n\n            return (\n              <g key={item.name}>\n                <circle\n                  cx=\"100\"\n                  cy=\"100\"\n                  r={normalizedRadius}\n                  fill=\"none\"\n                  stroke={item.color}\n                  strokeWidth={strokeWidth}\n                  strokeDasharray={`${circumference} ${circumference}`}\n                  strokeDashoffset={strokeDashoffset}\n                  strokeLinecap=\"round\"\n                  className=\"transition-all duration-300 cursor-pointer hover-elevate\"\n                  style={{\n                    transform: `rotate(${startAngle}deg)`,\n                    transformOrigin: \"100px 100px\",\n                    opacity: isHovered || isSelected ? 1 : 0.85,\n                    filter: isHovered || isSelected ? \"brightness(1.2)\" : \"none\",\n                    strokeWidth: isHovered || isSelected ? strokeWidth + 2 : strokeWidth,\n                  }}\n                  onClick={() => setSelectedArchetype(item)}\n                  onMouseEnter={() => setHoveredIndex(index)}\n                  onMouseLeave={() => setHoveredIndex(null)}\n                  data-testid={`chart-segment-${index}`}\n                />\n              </g>\n            );\n          })}\n          \n          <circle\n            cx=\"100\"\n            cy=\"100\"\n            r=\"45\"\n            fill=\"hsl(var(--card))\"\n            className=\"pointer-events-none\"\n          />\n        </svg>\n\n        <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none\">\n          <div className=\"text-center\">\n            <div className=\"text-3xl mb-1\">\n              {hoveredIndex !== null ? data[hoveredIndex].emoji : \"ğŸ‘¥\"}\n            </div>\n            <div className=\"text-xs text-muted-foreground\">\n              {hoveredIndex !== null ? `${data[hoveredIndex].percentage}%` : \"äººç¾¤\"}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-1.5\">\n        {data.map((item, index) => (\n          <motion.button\n            key={item.name}\n            onClick={() => setSelectedArchetype(item)}\n            onMouseEnter={() => setHoveredIndex(index)}\n            onMouseLeave={() => setHoveredIndex(null)}\n            className=\"flex items-center gap-1.5 p-1.5 rounded-md hover-elevate active-elevate-2 text-left transition-all\"\n            whileTap={{ scale: 0.98 }}\n            data-testid={`archetype-button-${index}`}\n          >\n            <div\n              className=\"w-2.5 h-2.5 rounded-full flex-shrink-0\"\n              style={{ backgroundColor: item.color }}\n            />\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"text-xs font-medium truncate\">{item.name}</div>\n              <div className=\"text-xs text-muted-foreground\">{item.percentage}%</div>\n            </div>\n          </motion.button>\n        ))}\n      </div>\n\n      <AnimatePresence>\n        {selectedArchetype && (\n          <motion.div\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            exit={{ opacity: 0, y: 10 }}\n            transition={{ duration: 0.2 }}\n          >\n            <Card className=\"border-2\" style={{ borderColor: selectedArchetype.color }}>\n              <CardContent className=\"p-3\">\n                <div className=\"flex items-start gap-2\">\n                  <div className=\"text-2xl\">{selectedArchetype.emoji}</div>\n                  <div className=\"flex-1\">\n                    <h3 className=\"font-bold text-base mb-0.5\">{selectedArchetype.name}</h3>\n                    <p className=\"text-xs text-muted-foreground\">{selectedArchetype.description}</p>\n                  </div>\n                  <button\n                    onClick={() => setSelectedArchetype(null)}\n                    className=\"text-muted-foreground hover:text-foreground\"\n                    data-testid=\"button-close-archetype\"\n                  >\n                    âœ•\n                  </button>\n                </div>\n              </CardContent>\n            </Card>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n","size_bytes":5720},"client/src/components/InterestTagCloud.tsx":{"content":"import { useRef, useState, useEffect } from \"react\";\nimport { motion, useMotionValue, useTransform } from \"framer-motion\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface InterestTag {\n  name: string;\n  icon: string;\n}\n\ninterface InterestTagCloudProps {\n  interests: string[];\n}\n\nconst interestIcons: Record<string, string> = {\n  \"ç”µå½±å¨±ä¹\": \"ğŸ¬\",\n  \"æ—…è¡Œæ¢ç´¢\": \"ğŸŒ\",\n  \"ç¾é£Ÿé¤é¥®\": \"ğŸœ\",\n  \"éŸ³ä¹æ¼”å‡º\": \"ğŸµ\",\n  \"é˜…è¯»ä¹¦ç±\": \"ğŸ“š\",\n  \"è‰ºæœ¯æ–‡åŒ–\": \"ğŸ¨\",\n  \"è¿åŠ¨å¥èº«\": \"âš½\",\n  \"å¥èº«å¥åº·\": \"ğŸ’ª\",\n  \"æ‘„å½±\": \"ğŸ“·\",\n  \"æ¸¸æˆ\": \"ğŸ®\",\n  \"ç§‘æŠ€\": \"ğŸ’»\",\n  \"åˆ›ä¸š\": \"ğŸš€\",\n  \"ç¤¾äº¤æ‹“å±•\": \"ğŸ¤\",\n  \"æˆ·å¤–æ´»åŠ¨\": \"ğŸ•ï¸\",\n  \"ç‘œä¼½å†¥æƒ³\": \"ğŸ§˜\",\n  \"å“é…’\": \"ğŸ·\",\n  \"å’–å•¡èŒ¶è‰º\": \"â˜•\",\n  \"çƒ¹é¥ªçƒ˜ç„™\": \"ğŸ‘¨â€ğŸ³\",\n};\n\nexport default function InterestTagCloud({ interests }: InterestTagCloudProps) {\n  const scrollRef = useRef<HTMLDivElement>(null);\n  const [isDragging, setIsDragging] = useState(false);\n  const scrollX = useMotionValue(0);\n\n  const tags: InterestTag[] = interests.map(interest => ({\n    name: interest,\n    icon: interestIcons[interest] || \"âœ¨\",\n  }));\n\n  return (\n    <div className=\"relative overflow-hidden\">\n      <div className=\"absolute left-0 top-0 bottom-0 w-8 bg-gradient-to-r from-background to-transparent z-10 pointer-events-none\" />\n      <div className=\"absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-background to-transparent z-10 pointer-events-none\" />\n      \n      <motion.div\n        ref={scrollRef}\n        className=\"flex gap-3 overflow-x-auto scrollbar-hide py-2 px-2 cursor-grab active:cursor-grabbing\"\n        drag=\"x\"\n        dragConstraints={{ left: -200, right: 0 }}\n        onDragStart={() => setIsDragging(true)}\n        onDragEnd={() => setIsDragging(false)}\n        style={{ x: scrollX }}\n        data-testid=\"interest-tag-cloud\"\n      >\n        {tags.map((tag, index) => {\n          const xOffset = useTransform(\n            scrollX,\n            [0, -100],\n            [0, index % 2 === 0 ? 10 : -10]\n          );\n\n          return (\n            <motion.div\n              key={`${tag.name}-${index}`}\n              style={{ x: xOffset }}\n              whileHover={{ scale: isDragging ? 1 : 1.05, y: -2 }}\n              transition={{ type: \"spring\", stiffness: 300, damping: 20 }}\n              data-testid={`interest-tag-${index}`}\n            >\n              <Badge \n                variant=\"secondary\"\n                className=\"text-sm px-4 py-2 whitespace-nowrap bg-gradient-to-br from-primary/10 to-accent/10 border border-primary/20 hover-elevate\"\n              >\n                <span className=\"mr-2 text-base\">{tag.icon}</span>\n                {tag.name}\n              </Badge>\n            </motion.div>\n          );\n        })}\n      </motion.div>\n    </div>\n  );\n}\n","size_bytes":2808},"client/src/components/CompletedEventCard.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { MapPin, DollarSign, Users, Star, MessageSquare, CheckCircle2, Sparkles } from \"lucide-react\";\nimport type { BlindBoxEvent, EventFeedback } from \"@shared/schema\";\nimport { getCurrencySymbol } from \"@/lib/currency\";\nimport { useLocation } from \"wouter\";\n\ninterface CompletedEventCardProps {\n  event: BlindBoxEvent;\n  feedback?: EventFeedback;\n}\n\nexport default function CompletedEventCard({ event, feedback }: CompletedEventCardProps) {\n  const [, setLocation] = useLocation();\n  const currencySymbol = getCurrencySymbol(event.city as \"é¦™æ¸¯\" | \"æ·±åœ³\");\n\n  const formatDate = (dateTime: Date) => {\n    const date = new Date(dateTime);\n    const month = date.getMonth() + 1;\n    const day = date.getDate();\n    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];\n    const weekday = weekdays[date.getDay()];\n    const hours = date.getHours().toString().padStart(2, '0');\n    const minutes = date.getMinutes().toString().padStart(2, '0');\n    return `${month}æœˆ${day}æ—¥ ${weekday} ${hours}:${minutes}`;\n  };\n\n  const getParticipantInfo = () => {\n    if (event.isGirlsNight) {\n      return `${event.totalParticipants}äºº Girls Night`;\n    }\n    if (event.maleCount && event.femaleCount) {\n      return `${event.totalParticipants}äººï¼ˆ${event.maleCount}ç”·${event.femaleCount}å¥³ï¼‰`;\n    }\n    return `${event.totalParticipants}äºº`;\n  };\n\n  // Extract individual scores from feedback\n  const getFeedbackScores = () => {\n    if (!feedback) return null;\n    \n    const scores: { label: string; score: number }[] = [];\n    \n    // Add atmosphere score (1-5)\n    if (feedback.atmosphereScore) {\n      scores.push({ label: \"æ´»åŠ¨æ°›å›´\", score: feedback.atmosphereScore });\n    }\n    \n    // Add connection radar scores (1-5 each)\n    if (feedback.connectionRadar && typeof feedback.connectionRadar === 'object') {\n      const radar = feedback.connectionRadar as any;\n      if (radar.topicResonance) scores.push({ label: \"è¯é¢˜å…±é¸£\", score: radar.topicResonance });\n      if (radar.personalityMatch) scores.push({ label: \"æ€§æ ¼å¥‘åˆ\", score: radar.personalityMatch });\n      if (radar.backgroundDiversity) scores.push({ label: \"èƒŒæ™¯å¤šå…ƒ\", score: radar.backgroundDiversity });\n      if (radar.overallFit) scores.push({ label: \"æ•´ä½“åŒ¹é…\", score: radar.overallFit });\n    }\n    \n    if (scores.length === 0) return null;\n    \n    const average = scores.reduce((a, b) => a + b.score, 0) / scores.length;\n    return {\n      scores,\n      average: Math.round(average * 10) / 10,\n    };\n  };\n\n  const feedbackScores = getFeedbackScores();\n  const hasFeedback = !!feedback;\n\n  return (\n    <Card \n      className=\"border shadow-sm hover-elevate active-elevate-2 cursor-pointer relative overflow-hidden\" \n      onClick={() => setLocation(`/blind-box-events/${event.id}`)}\n      data-testid={`card-completed-${event.id}`}\n    >\n      {/* Status Badge - Top Right Corner */}\n      <div className=\"absolute top-0 right-0 z-10\">\n        <div className=\"relative\">\n          <div className=\"absolute -top-1 -right-1\">\n            {hasFeedback ? (\n              <Badge \n                variant=\"secondary\" \n                className=\"rounded-full bg-primary/10 text-primary border-primary/30 font-semibold px-3 py-1 shadow-sm\"\n              >\n                <Sparkles className=\"h-3 w-3 mr-1\" />\n                å·²åé¦ˆ\n              </Badge>\n            ) : (\n              <Badge \n                variant=\"secondary\" \n                className=\"rounded-full bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 border-emerald-500/30 font-semibold px-3 py-1 shadow-sm\"\n              >\n                <CheckCircle2 className=\"h-3 w-3 mr-1\" />\n                å·²å®Œæˆ\n              </Badge>\n            )}\n          </div>\n        </div>\n      </div>\n\n      <CardContent className=\"p-4 space-y-3\">\n        {/* æ ‡é¢˜ */}\n        <div className=\"space-y-1 pr-20\">\n          <div className=\"flex items-start justify-between gap-3\">\n            <h3 className=\"text-base font-semibold flex-1\">\n              {formatDate(event.dateTime)} Â· {event.eventType}\n            </h3>\n            {event.isGirlsNight && (\n              <Badge className=\"text-xs bg-pink-500 hover:bg-pink-600\">\n                ğŸ‘­ Girls Night\n              </Badge>\n            )}\n          </div>\n        </div>\n\n        {/* Feedback Scores Display */}\n        {hasFeedback && feedbackScores && (\n          <div className=\"bg-primary/5 border border-primary/10 rounded-lg p-3 space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-1.5\">\n                <Star className=\"h-4 w-4 fill-amber-400 text-amber-400\" />\n                <span className=\"font-semibold text-amber-600 dark:text-amber-400\">\n                  {feedbackScores.average}\n                </span>\n                <span className=\"text-muted-foreground text-xs\">/ 5.0</span>\n              </div>\n              <span className=\"text-xs text-primary font-medium\">ä½ çš„è¯„åˆ†</span>\n            </div>\n            \n            {/* Individual Scores */}\n            <div className=\"grid grid-cols-2 gap-2\">\n              {feedbackScores.scores.map((item, index) => (\n                <div key={index} className=\"flex items-center justify-between text-xs\">\n                  <span className=\"text-muted-foreground\">{item.label}</span>\n                  <div className=\"flex items-center gap-0.5\">\n                    {[...Array(5)].map((_, i) => (\n                      <Star\n                        key={i}\n                        className={`h-3 w-3 ${\n                          i < item.score\n                            ? \"fill-amber-400 text-amber-400\"\n                            : \"text-muted-foreground/30\"\n                        }`}\n                      />\n                    ))}\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* äººæ•°ä¸æ€§åˆ« */}\n        <div className=\"flex items-center gap-2 text-sm\">\n          <Users className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"font-medium\">{getParticipantInfo()}</span>\n        </div>\n\n        {/* åœ°ç‚¹ */}\n        <div className=\"space-y-1\">\n          <div className=\"flex items-center gap-2 text-sm\">\n            <MapPin className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"font-medium\">{event.restaurantName}</span>\n          </div>\n          <div className=\"text-xs text-muted-foreground pl-6\">\n            {event.city}â€¢{event.district}\n          </div>\n        </div>\n\n        {/* é¢„ç®—æ¡£ */}\n        <div className=\"flex items-center gap-2 text-sm\">\n          <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n          <span>{currencySymbol}{event.budgetTier}</span>\n        </div>\n\n        {/* èœå¼æ ‡ç­¾ */}\n        {event.cuisineTags && event.cuisineTags.length > 0 && (\n          <div className=\"flex flex-wrap gap-1.5\">\n            {event.cuisineTags.map((tag, index) => (\n              <Badge key={index} variant=\"secondary\" className=\"text-xs\">\n                {tag}\n              </Badge>\n            ))}\n          </div>\n        )}\n\n        {/* æ“ä½œæŒ‰é’® */}\n        <div className=\"flex gap-2 pt-2\">\n          {!hasFeedback && (\n            <Button \n              size=\"sm\" \n              variant=\"default\"\n              className=\"flex-1\"\n              onClick={(e) => {\n                e.stopPropagation();\n                setLocation(`/events/${event.id}/feedback`);\n              }}\n              data-testid={`button-give-feedback-${event.id}`}\n            >\n              <MessageSquare className=\"h-4 w-4 mr-2\" />\n              åˆ†äº«åé¦ˆ\n            </Button>\n          )}\n          \n          <Button \n            size=\"sm\" \n            variant={hasFeedback ? \"default\" : \"outline\"}\n            className={hasFeedback ? \"flex-1\" : \"\"}\n            onClick={(e) => {\n              e.stopPropagation();\n              setLocation(`/blind-box-events/${event.id}`);\n            }}\n            data-testid={`button-view-details-${event.id}`}\n          >\n            æŸ¥çœ‹è¯¦æƒ…\n          </Button>\n        </div>\n\n        {/* Feedback Incentive (only if no feedback) */}\n        {!hasFeedback && (\n          <div className=\"flex items-center gap-2 p-3 rounded-lg bg-primary/5 border border-primary/10\">\n            <span className=\"text-2xl\">ğŸ</span>\n            <div className=\"flex-1\">\n              <p className=\"text-xs font-medium text-primary\">åˆ†äº«ä½“éªŒè·å¾—50ç§¯åˆ†</p>\n              <p className=\"text-xs text-muted-foreground\">å¸®åŠ©æˆ‘ä»¬åšå¾—æ›´å¥½</p>\n            </div>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":8888},"client/src/components/feedback/TraitTagsWall.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { ChevronDown, ChevronUp } from \"lucide-react\";\n\ninterface Attendee {\n  userId: string;\n  displayName: string;\n  archetype?: string;\n}\n\ninterface TraitData {\n  displayName: string;\n  tags: string[];\n  needsImprovement: boolean;\n  improvementNote: string;\n}\n\ninterface TraitTagsWallProps {\n  attendees: Attendee[];\n  initialTraits?: Record<string, TraitData>;\n  onNext: (data: { attendeeTraits: Record<string, TraitData> }) => void;\n}\n\nconst TRAIT_TAGS = [\n  \"å¹½é»˜é£è¶£\",\n  \"å–„äºå€¾å¬\",\n  \"è§è¯†å¹¿åš\",\n  \"çœŸè¯šå‹å–„\",\n  \"ç§¯æä¸»åŠ¨\",\n  \"å–„äºè¡¨è¾¾\",\n  \"æœ‰åŒç†å¿ƒ\",\n  \"æ€ç»´æ•æ·\",\n  \"ç»†å¿ƒä½“è´´\",\n  \"å¼€æ”¾åŒ…å®¹\",\n];\n\n// 8ä¸ªæ ¸å¿ƒç¤¾äº¤è§’è‰²ç³»ç»Ÿ\nconst archetypeIcons: Record<string, string> = {\n  \"ç«èŠ±å¡\": \"ğŸ™Œ\",\n  \"æ¢ç´¢è€…\": \"ğŸ§­\",\n  \"æ•…äº‹å®¶\": \"ğŸ—£ï¸\",\n  \"æŒ‘æˆ˜è€…\": \"ğŸ’ª\",\n  \"è¿æ¥è€…\": \"ğŸ¤—\",\n  \"åè°ƒè€…\": \"ğŸ§˜\",\n  \"æ°›å›´ç»„\": \"ğŸ•º\",\n  \"è‚¯å®šè€…\": \"ğŸ™\",\n};\n\nexport default function TraitTagsWall({ attendees, initialTraits = {}, onNext }: TraitTagsWallProps) {\n  const [traits, setTraits] = useState<Record<string, TraitData>>(initialTraits);\n  const [expandedAttendee, setExpandedAttendee] = useState<string | null>(null);\n\n  const toggleTag = (userId: string, tag: string) => {\n    setTraits(prev => {\n      const current = prev[userId] || {\n        displayName: attendees.find(a => a.userId === userId)?.displayName || \"\",\n        tags: [],\n        needsImprovement: false,\n        improvementNote: \"\",\n      };\n\n      const tags = current.tags.includes(tag)\n        ? current.tags.filter(t => t !== tag)\n        : [...current.tags, tag];\n\n      return {\n        ...prev,\n        [userId]: { ...current, tags },\n      };\n    });\n  };\n\n  const toggleNeedsImprovement = (userId: string) => {\n    setTraits(prev => {\n      const current = prev[userId] || {\n        displayName: attendees.find(a => a.userId === userId)?.displayName || \"\",\n        tags: [],\n        needsImprovement: false,\n        improvementNote: \"\",\n      };\n\n      return {\n        ...prev,\n        [userId]: { ...current, needsImprovement: !current.needsImprovement },\n      };\n    });\n  };\n\n  const setImprovementNote = (userId: string, note: string) => {\n    setTraits(prev => {\n      const current = prev[userId] || {\n        displayName: attendees.find(a => a.userId === userId)?.displayName || \"\",\n        tags: [],\n        needsImprovement: false,\n        improvementNote: \"\",\n      };\n\n      return {\n        ...prev,\n        [userId]: { ...current, improvementNote: note },\n      };\n    });\n  };\n\n  const handleSubmit = () => {\n    // Only include attendees with at least one tag or improvement feedback\n    const filteredTraits = Object.entries(traits).reduce((acc, [userId, data]) => {\n      if (data.tags.length > 0 || data.needsImprovement) {\n        acc[userId] = data;\n      }\n      return acc;\n    }, {} as Record<string, TraitData>);\n\n    onNext({ attendeeTraits: filteredTraits });\n  };\n\n  const totalTagsGiven = Object.values(traits).reduce((sum, t) => sum + t.tags.length, 0);\n\n  return (\n    <div className=\"max-w-md mx-auto space-y-6\">\n      <Card>\n        <CardContent className=\"p-6 space-y-6\">\n          {/* Header */}\n          <div className=\"text-center space-y-2\">\n            <div className=\"text-4xl\">ğŸ·ï¸</div>\n            <h2 className=\"text-xl font-bold\">ä¸ºä¼™ä¼´è´´ä¸Šå°è±¡æ ‡ç­¾</h2>\n            <p className=\"text-sm text-muted-foreground\">\n              ç‚¹å‡»é€‰æ‹©æœ€ç¬¦åˆçš„å°è±¡ï¼ˆå¯é€‰1-3ä½ä¼™ä¼´ï¼‰\n            </p>\n          </div>\n\n          {/* Progress Indicator */}\n          <div className=\"flex items-center justify-between text-sm p-3 rounded-lg bg-muted/50\">\n            <span className=\"text-muted-foreground\">å·²æ ‡è®°</span>\n            <span className=\"font-medium text-primary\">{totalTagsGiven} ä¸ªæ ‡ç­¾</span>\n          </div>\n\n          {/* Attendee List */}\n          <div className=\"space-y-3\">\n            {attendees.map((attendee) => {\n              const isExpanded = expandedAttendee === attendee.userId;\n              const attendeeTraits = traits[attendee.userId] || {\n                displayName: attendee.displayName,\n                tags: [],\n                needsImprovement: false,\n                improvementNote: \"\",\n              };\n              const tagCount = attendeeTraits.tags.length;\n\n              const archetypeIcon = attendee.archetype \n                ? archetypeIcons[attendee.archetype] || \"âœ¨\"\n                : \"âœ¨\";\n\n              return (\n                <div key={attendee.userId} className=\"border rounded-lg overflow-hidden\">\n                  {/* Attendee Header */}\n                  <button\n                    onClick={() => setExpandedAttendee(isExpanded ? null : attendee.userId)}\n                    className=\"w-full p-4 flex items-center justify-between hover-elevate active-elevate-2 bg-background transition-colors\"\n                    data-testid={`button-expand-attendee-${attendee.userId}`}\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"text-2xl\">\n                        {archetypeIcon}\n                      </div>\n                      <div className=\"text-left\">\n                        <p className=\"font-semibold\">{attendee.displayName}</p>\n                        {attendee.archetype && (\n                          <p className=\"text-xs text-muted-foreground\">{attendee.archetype}</p>\n                        )}\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      {tagCount > 0 && (\n                        <Badge variant=\"secondary\" className=\"text-xs\">\n                          {tagCount} ä¸ªæ ‡ç­¾\n                        </Badge>\n                      )}\n                      {isExpanded ? (\n                        <ChevronUp className=\"h-4 w-4 text-muted-foreground\" />\n                      ) : (\n                        <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\n                      )}\n                    </div>\n                  </button>\n\n                  {/* Expanded Tag Selection */}\n                  <AnimatePresence>\n                    {isExpanded && (\n                      <motion.div\n                        initial={{ height: 0, opacity: 0 }}\n                        animate={{ height: \"auto\", opacity: 1 }}\n                        exit={{ height: 0, opacity: 0 }}\n                        transition={{ duration: 0.2 }}\n                        className=\"overflow-hidden\"\n                      >\n                        <div className=\"p-4 pt-0 space-y-4 border-t\">\n                          {/* Tag Grid */}\n                          <div className=\"flex flex-wrap gap-2.5\">\n                            {TRAIT_TAGS.map((tag) => {\n                              const isSelected = attendeeTraits.tags.includes(tag);\n                              return (\n                                <Badge\n                                  key={tag}\n                                  variant={isSelected ? \"default\" : \"outline\"}\n                                  className=\"cursor-pointer hover-elevate active-elevate-2 text-sm px-3.5 py-1.5\"\n                                  onClick={() => toggleTag(attendee.userId, tag)}\n                                  data-testid={`tag-${attendee.userId}-${tag}`}\n                                >\n                                  {isSelected && \"âœ“ \"}\n                                  {tag}\n                                </Badge>\n                              );\n                            })}\n                          </div>\n\n                          {/* Needs Improvement Toggle */}\n                          <div className=\"pt-3 border-t\">\n                            <label className=\"flex items-center gap-2 cursor-pointer\">\n                              <input\n                                type=\"checkbox\"\n                                checked={attendeeTraits.needsImprovement}\n                                onChange={() => toggleNeedsImprovement(attendee.userId)}\n                                className=\"h-4 w-4 rounded border-input\"\n                                data-testid={`checkbox-improvement-${attendee.userId}`}\n                              />\n                              <span className=\"text-sm font-medium\">éœ€è¦æ”¹è¿›</span>\n                            </label>\n\n                            {/* Improvement Note (Conditional) */}\n                            <AnimatePresence>\n                              {attendeeTraits.needsImprovement && (\n                                <motion.div\n                                  initial={{ height: 0, opacity: 0 }}\n                                  animate={{ height: \"auto\", opacity: 1 }}\n                                  exit={{ height: 0, opacity: 0 }}\n                                  className=\"mt-3\"\n                                >\n                                  <Textarea\n                                    value={attendeeTraits.improvementNote}\n                                    onChange={(e) => setImprovementNote(attendee.userId, e.target.value)}\n                                    placeholder=\"å…·ä½“å»ºè®®ï¼ˆåŒ¿åï¼‰\"\n                                    rows={2}\n                                    maxLength={100}\n                                    className=\"resize-none\"\n                                    data-testid={`textarea-improvement-${attendee.userId}`}\n                                  />\n                                  <p className=\"text-xs text-muted-foreground mt-1\">\n                                    {attendeeTraits.improvementNote.length}/100\n                                  </p>\n                                </motion.div>\n                              )}\n                            </AnimatePresence>\n                          </div>\n                        </div>\n                      </motion.div>\n                    )}\n                  </AnimatePresence>\n                </div>\n              );\n            })}\n          </div>\n\n          {/* Skip/Next Button */}\n          <div className=\"space-y-2\">\n            <Button \n              onClick={handleSubmit} \n              size=\"lg\" \n              className=\"w-full\"\n              data-testid=\"button-next-traits\"\n            >\n              {totalTagsGiven > 0 ? \"ä¸‹ä¸€æ­¥\" : \"è·³è¿‡\"}\n            </Button>\n            {totalTagsGiven === 0 && (\n              <p className=\"text-xs text-center text-muted-foreground\">\n                å¯ä»¥è·³è¿‡è¿™ä¸€æ­¥ï¼Œç»§ç»­å…¶ä»–åé¦ˆ\n              </p>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":10980},"client/src/pages/DeepFeedbackFlow.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useParams, useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { ArrowLeft, Sparkles } from \"lucide-react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport MatchPointValidation from \"@/components/feedback/MatchPointValidation\";\nimport ConversationDynamics from \"@/components/feedback/ConversationDynamics\";\nimport MatchingPreferences from \"@/components/feedback/MatchingPreferences\";\nimport DeepFeedbackCompletion from \"@/components/feedback/DeepFeedbackCompletion\";\nimport { Users, Briefcase, Globe, BookOpen } from \"lucide-react\";\n\ninterface DeepFeedbackData {\n  matchPointValidation?: Record<string, { discussed: string; notes?: string }>;\n  additionalMatchPoints?: string;\n  conversationBalance?: number;\n  conversationComfort?: number;\n  conversationNotes?: string;\n  futurePreferences?: string[];\n  futurePreferencesOther?: string;\n}\n\nexport default function DeepFeedbackFlow() {\n  const { eventId } = useParams<{ eventId: string }>();\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n\n  const [currentStep, setCurrentStep] = useState(1);\n  const [deepFeedbackData, setDeepFeedbackData] = useState<DeepFeedbackData>({});\n  const [isCompleted, setIsCompleted] = useState(false);\n\n  // Fetch event details\n  const { data: event, isLoading: eventLoading } = useQuery({\n    queryKey: [\"/api/blind-box-events\", eventId],\n    enabled: !!eventId,\n  });\n\n  // Fetch existing feedback\n  const { data: existingFeedback } = useQuery({\n    queryKey: [\"/api/events\", eventId, \"feedback\"],\n    enabled: !!eventId,\n  });\n\n  // Mock match points from event data\n  const matchPoints = [\n    {\n      id: \"overseas\",\n      label: \"éƒ½æœ‰æµ·å¤–ç»å†\",\n      icon: Globe,\n      description: \"åœ¨å›½å¤–ç”Ÿæ´»æˆ–å·¥ä½œçš„ç»å†\",\n    },\n    {\n      id: \"tech\",\n      label: \"åŒä¸ºç§‘æŠ€è¡Œä¸š\",\n      icon: Briefcase,\n      description: \"ä»äº‹ç§‘æŠ€æˆ–äº’è”ç½‘ç›¸å…³å·¥ä½œ\",\n    },\n    {\n      id: \"reading\",\n      label: \"éƒ½å–œæ¬¢é˜…è¯»\",\n      icon: BookOpen,\n      description: \"å¯¹ä¹¦ç±ã€çŸ¥è¯†è·å–æœ‰å…±åŒå…´è¶£\",\n    },\n  ];\n\n  // Submit deep feedback mutation\n  const submitMutation = useMutation({\n    mutationFn: async (data: DeepFeedbackData) => {\n      const response = await apiRequest(\n        \"POST\",\n        `/api/events/${eventId}/feedback/deep`,\n        {\n          hasDeepFeedback: true,\n          matchPointValidation: data.matchPointValidation,\n          additionalMatchPoints: data.additionalMatchPoints,\n          conversationBalance: data.conversationBalance,\n          conversationComfort: data.conversationComfort,\n          conversationNotes: data.conversationNotes,\n          futurePreferences: data.futurePreferences,\n          futurePreferencesOther: data.futurePreferencesOther,\n        }\n      );\n      return await response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/events\", eventId, \"feedback\"] });\n      setIsCompleted(true);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"æäº¤å¤±è´¥\",\n        description: error.message || \"æ— æ³•ä¿å­˜æ·±åº¦åé¦ˆï¼Œè¯·ç¨åé‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Handle step completion\n  const handleStep1Complete = (data: { validation: any; additional: string }) => {\n    setDeepFeedbackData(prev => ({\n      ...prev,\n      matchPointValidation: data.validation,\n      additionalMatchPoints: data.additional,\n    }));\n    setCurrentStep(2);\n  };\n\n  const handleStep2Complete = (data: { balance: number; comfort: number; notes: string }) => {\n    setDeepFeedbackData(prev => ({\n      ...prev,\n      conversationBalance: data.balance,\n      conversationComfort: data.comfort,\n      conversationNotes: data.notes,\n    }));\n    setCurrentStep(3);\n  };\n\n  const handleStep3Complete = (data: { preferences: string[]; other: string }) => {\n    const finalData = {\n      ...deepFeedbackData,\n      futurePreferences: data.preferences,\n      futurePreferencesOther: data.other,\n    };\n    setDeepFeedbackData(finalData);\n    submitMutation.mutate(finalData);\n  };\n\n  const handleSkip = () => {\n    if (currentStep < 3) {\n      setCurrentStep(prev => prev + 1);\n    } else {\n      // Skip to completion\n      submitMutation.mutate(deepFeedbackData);\n    }\n  };\n\n  const handleDone = () => {\n    navigate(\"/events\");\n  };\n\n  const totalSteps = 3;\n  const progress = (currentStep / totalSteps) * 100;\n\n  if (eventLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-center space-y-3\">\n          <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n          <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (isCompleted) {\n    return <DeepFeedbackCompletion onDone={handleDone} />;\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <div className=\"sticky top-0 z-10 bg-background/95 backdrop-blur border-b\">\n        <div className=\"max-w-2xl mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between mb-3\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => navigate(\"/events\")}\n              data-testid=\"button-back\"\n            >\n              <ArrowLeft className=\"h-4 w-4 mr-2\" />\n              è¿”å›\n            </Button>\n            <Badge variant=\"outline\" className=\"gap-1\">\n              <Sparkles className=\"h-3 w-3\" />\n              æ·±åº¦åé¦ˆ\n            </Badge>\n          </div>\n\n          {/* Progress Bar */}\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between text-sm\">\n              <span className=\"text-muted-foreground\">è¿›åº¦</span>\n              <span className=\"font-medium\">{currentStep}/{totalSteps}</span>\n            </div>\n            <Progress value={progress} className=\"h-2\" />\n          </div>\n        </div>\n      </div>\n\n      {/* Main Content */}\n      <div className=\"max-w-2xl mx-auto px-4 py-10\">\n        <AnimatePresence mode=\"wait\">\n          {currentStep === 1 && (\n            <motion.div\n              key=\"step1\"\n              initial={{ opacity: 0, x: 20 }}\n              animate={{ opacity: 1, x: 0 }}\n              exit={{ opacity: 0, x: -20 }}\n              transition={{ duration: 0.3 }}\n            >\n              <MatchPointValidation\n                matchPoints={matchPoints}\n                initialData={deepFeedbackData.matchPointValidation}\n                onNext={handleStep1Complete}\n                onSkip={handleSkip}\n              />\n            </motion.div>\n          )}\n\n          {currentStep === 2 && (\n            <motion.div\n              key=\"step2\"\n              initial={{ opacity: 0, x: 20 }}\n              animate={{ opacity: 1, x: 0 }}\n              exit={{ opacity: 0, x: -20 }}\n              transition={{ duration: 0.3 }}\n            >\n              <ConversationDynamics\n                initialData={{\n                  balance: deepFeedbackData.conversationBalance,\n                  comfort: deepFeedbackData.conversationComfort,\n                  notes: deepFeedbackData.conversationNotes,\n                }}\n                onNext={handleStep2Complete}\n                onSkip={handleSkip}\n              />\n            </motion.div>\n          )}\n\n          {currentStep === 3 && (\n            <motion.div\n              key=\"step3\"\n              initial={{ opacity: 0, x: 20 }}\n              animate={{ opacity: 1, x: 0 }}\n              exit={{ opacity: 0, x: -20 }}\n              transition={{ duration: 0.3 }}\n            >\n              <MatchingPreferences\n                initialData={{\n                  preferences: deepFeedbackData.futurePreferences,\n                  other: deepFeedbackData.futurePreferencesOther,\n                }}\n                onNext={handleStep3Complete}\n                onSkip={handleSkip}\n              />\n            </motion.div>\n          )}\n        </AnimatePresence>\n\n        {/* Loading Overlay */}\n        {submitMutation.isPending && (\n          <div className=\"fixed inset-0 bg-background/80 backdrop-blur-sm flex items-center justify-center z-50\">\n            <Card>\n              <CardContent className=\"p-6 flex flex-col items-center gap-4\">\n                <div className=\"w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin\" />\n                <p className=\"text-sm font-medium\">æ­£åœ¨æäº¤ä½ çš„æ·±åº¦åé¦ˆ...</p>\n              </CardContent>\n            </Card>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":9045},"client/src/components/feedback/AtmosphereThermometer.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { motion } from \"framer-motion\";\n\ninterface AtmosphereThermometerProps {\n  initialScore?: number;\n  initialNote?: string;\n  onNext: (data: { atmosphereScore: number; atmosphereNote?: string }) => void;\n}\n\nconst ATMOSPHERE_LABELS = [\n  { value: 1, emoji: \"ğŸ˜\", label: \"å°´å°¬\", description: \"æ°”æ°›ä¸å¤ªå¥½\" },\n  { value: 2, emoji: \"ğŸ˜\", label: \"å¹³æ·¡\", description: \"æ„Ÿè§‰è¿˜è¡Œ\" },\n  { value: 3, emoji: \"ğŸ˜Š\", label: \"èˆ’é€‚\", description: \"æŒºæ„‰å¿«çš„\" },\n  { value: 4, emoji: \"ğŸ¤©\", label: \"çƒ­çƒˆ\", description: \"éå¸¸å¼€å¿ƒ\" },\n  { value: 5, emoji: \"âœ¨\", label: \"å®Œç¾\", description: \"å¤ªæ£’äº†ï¼\" },\n];\n\nexport default function AtmosphereThermometer({ \n  initialScore = 3, \n  initialNote = \"\", \n  onNext \n}: AtmosphereThermometerProps) {\n  const [score, setScore] = useState(initialScore);\n  const [note, setNote] = useState(initialNote);\n\n  const currentLabel = ATMOSPHERE_LABELS.find(l => l.value === score) || ATMOSPHERE_LABELS[2];\n\n  // Calculate thermometer fill percentage (0-100%)\n  const fillPercentage = ((score - 1) / 4) * 100;\n\n  // Get color based on score\n  const getColor = (value: number) => {\n    if (value <= 2) return \"hsl(var(--destructive))\";\n    if (value === 3) return \"hsl(var(--warning))\";\n    return \"hsl(var(--primary))\";\n  };\n\n  const handleSubmit = () => {\n    onNext({ \n      atmosphereScore: score, \n      atmosphereNote: note.trim() || undefined \n    });\n  };\n\n  return (\n    <div className=\"max-w-md mx-auto space-y-6\">\n      <Card>\n        <CardContent className=\"p-6 space-y-6\">\n          {/* Header */}\n          <div className=\"text-center space-y-2\">\n            <div className=\"text-4xl\">{currentLabel.emoji}</div>\n            <h2 className=\"text-xl font-bold\">ç°åœºæ°›å›´å¦‚ä½•ï¼Ÿ</h2>\n            <p className=\"text-sm text-muted-foreground\">æ»‘åŠ¨æè¿°ä½ çš„æ„Ÿå—</p>\n          </div>\n\n          {/* Thermometer Visualization */}\n          <div className=\"space-y-4\">\n            {/* Thermometer Bar */}\n            <div className=\"relative h-12 bg-muted rounded-full overflow-hidden\">\n              <motion.div\n                className=\"absolute left-0 top-0 h-full rounded-full\"\n                style={{ backgroundColor: getColor(score) }}\n                initial={{ width: \"0%\" }}\n                animate={{ width: `${fillPercentage}%` }}\n                transition={{ duration: 0.3, ease: \"easeOut\" }}\n              />\n              <div className=\"absolute inset-0 flex items-center justify-center\">\n                <span className=\"font-bold text-foreground mix-blend-difference\">\n                  {currentLabel.label}\n                </span>\n              </div>\n            </div>\n\n            {/* Slider */}\n            <Slider\n              value={[score]}\n              onValueChange={(values) => setScore(values[0])}\n              min={1}\n              max={5}\n              step={1}\n              className=\"w-full\"\n              data-testid=\"slider-atmosphere\"\n            />\n\n            {/* Labels */}\n            <div className=\"flex justify-between text-xs text-muted-foreground px-2\">\n              <span>ğŸ˜ å°´å°¬</span>\n              <span>ğŸ˜ å¹³æ·¡</span>\n              <span>ğŸ˜Š èˆ’é€‚</span>\n              <span>ğŸ¤© çƒ­çƒˆ</span>\n              <span>âœ¨ å®Œç¾</span>\n            </div>\n          </div>\n\n          {/* Current Selection Display */}\n          <motion.div\n            key={score}\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ duration: 0.2 }}\n            className=\"text-center p-4 rounded-lg bg-primary/5 border border-primary/10\"\n          >\n            <p className=\"text-sm font-medium text-primary\">\n              {currentLabel.description}\n            </p>\n          </motion.div>\n\n          {/* Optional Note */}\n          <div className=\"space-y-2\">\n            <label className=\"text-sm font-medium\">\n              è¡¥å……è¯´æ˜ï¼ˆå¯é€‰ï¼‰\n            </label>\n            <Textarea\n              value={note}\n              onChange={(e) => setNote(e.target.value)}\n              placeholder=\"æœ‰ä»€ä¹ˆç‰¹åˆ«æƒ³è¯´çš„å—ï¼Ÿ\"\n              rows={3}\n              maxLength={200}\n              className=\"resize-none\"\n              data-testid=\"textarea-atmosphere-note\"\n            />\n            <p className=\"text-xs text-muted-foreground text-right\">\n              {note.length}/200\n            </p>\n          </div>\n\n          {/* Next Button */}\n          <Button \n            onClick={handleSubmit} \n            size=\"lg\" \n            className=\"w-full\"\n            data-testid=\"button-next-atmosphere\"\n          >\n            ä¸‹ä¸€æ­¥\n          </Button>\n        </CardContent>\n      </Card>\n\n      {/* Insight Card */}\n      {score >= 4 && (\n        <motion.div\n          initial={{ opacity: 0, scale: 0.95 }}\n          animate={{ opacity: 1, scale: 1 }}\n          className=\"text-center p-4 rounded-lg bg-muted/50 text-sm text-muted-foreground\"\n        >\n          ğŸ’¡ {((score / 5) * 100).toFixed(0)}% ç”¨æˆ·åŒæ„Ÿ\n        </motion.div>\n      )}\n    </div>\n  );\n}\n","size_bytes":5312},"client/src/components/feedback/ConnectionRadar.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Label } from \"@/components/ui/label\";\nimport { Star } from \"lucide-react\";\nimport { motion } from \"framer-motion\";\n\ninterface RadarData {\n  topicResonance: number;\n  personalityMatch: number;\n  backgroundDiversity: number;\n  overallFit: number;\n}\n\ninterface ConnectionRadarProps {\n  initialRadar?: RadarData;\n  initialHasConnections?: boolean;\n  initialConnectionStatus?: string;\n  onNext: (data: {\n    connectionRadar: RadarData;\n    hasNewConnections?: boolean;\n    connectionStatus?: string;\n  }) => void;\n}\n\nconst DEFAULT_RADAR: RadarData = {\n  topicResonance: 3,\n  personalityMatch: 3,\n  backgroundDiversity: 3,\n  overallFit: 3,\n};\n\nconst RADAR_DIMENSIONS = [\n  { key: \"topicResonance\" as keyof RadarData, label: \"è¯é¢˜å…±é¸£åº¦\", emoji: \"ğŸ’¬\" },\n  { key: \"personalityMatch\" as keyof RadarData, label: \"æ€§æ ¼åŒ¹é…åº¦\", emoji: \"ğŸ­\" },\n  { key: \"backgroundDiversity\" as keyof RadarData, label: \"èƒŒæ™¯å¤šæ ·æ€§\", emoji: \"ğŸŒ\" },\n  { key: \"overallFit\" as keyof RadarData, label: \"æ•´ä½“å¥‘åˆæ„Ÿ\", emoji: \"âœ¨\" },\n];\n\nconst CONNECTION_OPTIONS = [\n  { value: \"å·²äº¤æ¢è”ç³»æ–¹å¼\", label: \"æœ‰ï¼Œå·²äº¤æ¢è”ç³»æ–¹å¼\", emoji: \"ğŸ“±\" },\n  { value: \"æœ‰ä½†è¿˜æ²¡è”ç³»\", label: \"æœ‰ï¼Œä½†è¿˜æ²¡è”ç³»\", emoji: \"ğŸ‘‹\" },\n  { value: \"æ²¡æœ‰ä½†å¾ˆæ„‰å¿«\", label: \"æ²¡æœ‰ï¼Œä½†å¾ˆæ„‰å¿«\", emoji: \"ğŸ˜Š\" },\n  { value: \"æ²¡æœ‰ä¸å¤ªåˆé€‚\", label: \"æ²¡æœ‰ï¼Œä¸å¤ªåˆé€‚\", emoji: \"ğŸ¤”\" },\n];\n\nexport default function ConnectionRadar({\n  initialRadar = DEFAULT_RADAR,\n  initialHasConnections,\n  initialConnectionStatus,\n  onNext,\n}: ConnectionRadarProps) {\n  const [radar, setRadar] = useState<RadarData>(initialRadar);\n  const [connectionStatus, setConnectionStatus] = useState<string | undefined>(initialConnectionStatus);\n\n  const updateDimension = (key: keyof RadarData, value: number) => {\n    setRadar(prev => ({ ...prev, [key]: value }));\n  };\n\n  const handleSubmit = () => {\n    const hasConnections = connectionStatus === \"å·²äº¤æ¢è”ç³»æ–¹å¼\" || connectionStatus === \"æœ‰ä½†è¿˜æ²¡è”ç³»\";\n    \n    onNext({\n      connectionRadar: radar,\n      hasNewConnections: hasConnections,\n      connectionStatus,\n    });\n  };\n\n  const averageScore = (\n    (radar.topicResonance + radar.personalityMatch + radar.backgroundDiversity + radar.overallFit) / 4\n  ).toFixed(1);\n\n  return (\n    <div className=\"max-w-md mx-auto space-y-6\">\n      <Card>\n        <CardContent className=\"p-6 space-y-6\">\n          {/* Header */}\n          <div className=\"text-center space-y-2\">\n            <div className=\"text-4xl\">ğŸ“¡</div>\n            <h2 className=\"text-xl font-bold\">ç¤¾äº¤è¿æ¥åº¦</h2>\n            <p className=\"text-sm text-muted-foreground\">è¿™æ¡Œä¼™ä¼´çš„åŒ¹é…åº¦å¦‚ä½•ï¼Ÿ</p>\n          </div>\n\n          {/* Radar Dimensions */}\n          <div className=\"space-y-6\">\n            {RADAR_DIMENSIONS.map((dimension) => (\n              <div key={dimension.key} className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <span>{dimension.emoji}</span>\n                    <span className=\"text-sm font-medium\">{dimension.label}</span>\n                  </div>\n                  <div className=\"flex items-center gap-1\">\n                    {[...Array(radar[dimension.key])].map((_, i) => (\n                      <Star key={i} className=\"h-3 w-3 fill-primary text-primary\" />\n                    ))}\n                    <span className=\"text-sm text-muted-foreground ml-1\">\n                      {radar[dimension.key]}/5\n                    </span>\n                  </div>\n                </div>\n\n                {/* Star Rating */}\n                <div className=\"flex gap-2\">\n                  {[1, 2, 3, 4, 5].map((value) => (\n                    <button\n                      key={value}\n                      onClick={() => updateDimension(dimension.key, value)}\n                      className=\"flex-1 h-10 rounded-lg border hover-elevate active-elevate-2 transition-all\"\n                      data-testid={`star-${dimension.key}-${value}`}\n                    >\n                      <Star\n                        className={`h-5 w-5 mx-auto ${\n                          value <= radar[dimension.key]\n                            ? \"fill-primary text-primary\"\n                            : \"text-muted-foreground\"\n                        }`}\n                      />\n                    </button>\n                  ))}\n                </div>\n              </div>\n            ))}\n          </div>\n\n          {/* Average Score Display */}\n          <motion.div\n            key={averageScore}\n            initial={{ scale: 0.95, opacity: 0 }}\n            animate={{ scale: 1, opacity: 1 }}\n            className=\"p-4 rounded-lg bg-primary/5 border border-primary/10 text-center\"\n          >\n            <p className=\"text-sm text-muted-foreground mb-1\">å¹³å‡è¯„åˆ†</p>\n            <p className=\"text-3xl font-bold text-primary\">{averageScore}</p>\n            <div className=\"flex items-center justify-center gap-1 mt-2\">\n              {[...Array(Math.round(parseFloat(averageScore)))].map((_, i) => (\n                <Star key={i} className=\"h-4 w-4 fill-primary text-primary\" />\n              ))}\n            </div>\n          </motion.div>\n\n          {/* Connection Status */}\n          <div className=\"space-y-3 pt-4 border-t\">\n            <p className=\"text-sm font-medium\">è¯·é€‰æ‹©å¸Œæœ›ç»§ç»­ä¿æŒè”ç³»çš„äºº</p>\n            <RadioGroup \n              value={connectionStatus} \n              onValueChange={setConnectionStatus}\n              data-testid=\"radio-connection-status\"\n            >\n              {CONNECTION_OPTIONS.map((option) => (\n                <div \n                  key={option.value} \n                  className=\"flex items-center gap-3 p-3 rounded-lg border hover-elevate active-elevate-2 transition-all cursor-pointer\"\n                  onClick={() => setConnectionStatus(option.value)}\n                >\n                  <RadioGroupItem value={option.value} id={option.value} />\n                  <Label htmlFor={option.value} className=\"flex-1 cursor-pointer\">\n                    <div className=\"flex items-center gap-2\">\n                      <span>{option.emoji}</span>\n                      <span className=\"text-sm\">{option.label}</span>\n                    </div>\n                  </Label>\n                </div>\n              ))}\n            </RadioGroup>\n          </div>\n\n          {/* Next Button */}\n          <Button \n            onClick={handleSubmit} \n            size=\"lg\" \n            className=\"w-full\"\n            disabled={!connectionStatus}\n            data-testid=\"button-next-radar\"\n          >\n            ä¸‹ä¸€æ­¥\n          </Button>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":6992},"client/src/components/feedback/ConversationDynamics.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { motion } from \"framer-motion\";\nimport { MessageSquare, Scale, Smile } from \"lucide-react\";\nimport { useState } from \"react\";\n\ninterface ConversationDynamicsProps {\n  initialData?: {\n    balance?: number;\n    comfort?: number;\n    notes?: string;\n  };\n  onNext: (data: { balance: number; comfort: number; notes: string }) => void;\n  onSkip: () => void;\n}\n\nconst comfortEmojis = [\n  { value: 0, emoji: \"ğŸ˜\", label: \"å¾ˆä¸èˆ’é€‚\" },\n  { value: 25, emoji: \"ğŸ˜\", label: \"æœ‰ç‚¹å°´å°¬\" },\n  { value: 50, emoji: \"ğŸ™‚\", label: \"è¿˜å¯ä»¥\" },\n  { value: 75, emoji: \"ğŸ˜Š\", label: \"å¾ˆèˆ’é€‚\" },\n  { value: 100, emoji: \"ğŸ˜„\", label: \"éå¸¸æ„‰å¿«\" },\n];\n\nexport default function ConversationDynamics({ \n  initialData = {}, \n  onNext, \n  onSkip \n}: ConversationDynamicsProps) {\n  const [balance, setBalance] = useState<number>(initialData.balance ?? 50);\n  const [comfort, setComfort] = useState<number>(initialData.comfort ?? 50);\n  const [notes, setNotes] = useState(initialData.notes ?? \"\");\n\n  const handleSubmit = () => {\n    onNext({ balance, comfort, notes });\n  };\n\n  // Find closest emoji for comfort level\n  const closestComfortEmoji = comfortEmojis.reduce((prev, curr) => {\n    return Math.abs(curr.value - comfort) < Math.abs(prev.value - comfort) ? curr : prev;\n  });\n\n  // Get balance description\n  const getBalanceDescription = () => {\n    if (balance < 30) return \"å¯¹æ–¹ä¸»å¯¼äº†å¤§éƒ¨åˆ†è¯é¢˜\";\n    if (balance > 70) return \"ä½ ä¸»å¯¼äº†å¤§éƒ¨åˆ†è¯é¢˜\";\n    return \"åŒæ–¹äº’åŠ¨æ¯”è¾ƒå‡è¡¡\";\n  };\n\n  return (\n    <div className=\"space-y-8\">\n      {/* Header */}\n      <motion.div\n        initial={{ opacity: 0, y: -10 }}\n        animate={{ opacity: 1, y: 0 }}\n        className=\"space-y-3\"\n      >\n        <div className=\"flex items-center gap-3\">\n          <div className=\"p-3 rounded-lg bg-primary/10\">\n            <MessageSquare className=\"h-6 w-6 text-primary\" />\n          </div>\n          <div>\n            <h2 className=\"text-xl font-bold\">å›å¿†ä½ ä»¬çš„å¯¹è¯æµç¨‹</h2>\n            <p className=\"text-sm text-muted-foreground\">å¸®åŠ©æˆ‘ä»¬ç†è§£äº¤æµåŠ¨æ€</p>\n          </div>\n        </div>\n      </motion.div>\n\n      {/* Progress Indicator */}\n      <div className=\"flex items-center justify-between text-sm\">\n        <span className=\"text-muted-foreground\">å¯é€‰é—®é¢˜ 2/3</span>\n        <Badge variant=\"outline\">ç®€å•æ»‘åŠ¨å³å¯</Badge>\n      </div>\n\n      {/* Conversation Balance */}\n      <motion.div\n        initial={{ opacity: 0, y: 10 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ delay: 0.1 }}\n      >\n        <Card>\n          <CardContent className=\"p-6 space-y-5\">\n            <div className=\"flex items-center gap-3\">\n              <Scale className=\"h-5 w-5 text-primary\" />\n              <div className=\"flex-1\">\n                <h3 className=\"font-semibold\">ä¸»å¯¼è¯é¢˜çš„å¤§è‡´æ¯”ä¾‹</h3>\n                <p className=\"text-sm text-muted-foreground mt-1\">{getBalanceDescription()}</p>\n              </div>\n            </div>\n\n            {/* Balance Slider */}\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between text-sm\">\n                <span className=\"text-muted-foreground\">å¯¹æ–¹ TA</span>\n                <span className=\"font-medium text-primary\">{balance}%</span>\n                <span className=\"text-muted-foreground\">æˆ‘</span>\n              </div>\n              \n              <Slider\n                value={[balance]}\n                onValueChange={(values) => setBalance(values[0])}\n                min={0}\n                max={100}\n                step={5}\n                className=\"w-full\"\n                data-testid=\"slider-balance\"\n              />\n\n              {/* Visual Representation */}\n              <div className=\"flex gap-1 h-2 rounded-full overflow-hidden bg-muted\">\n                <div \n                  className=\"bg-gradient-to-r from-blue-400 to-blue-500 transition-all duration-300\"\n                  style={{ width: `${100 - balance}%` }}\n                />\n                <div \n                  className=\"bg-gradient-to-r from-primary/80 to-primary transition-all duration-300\"\n                  style={{ width: `${balance}%` }}\n                />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </motion.div>\n\n      {/* Conversation Comfort */}\n      <motion.div\n        initial={{ opacity: 0, y: 10 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ delay: 0.2 }}\n      >\n        <Card>\n          <CardContent className=\"p-6 space-y-5\">\n            <div className=\"flex items-center gap-3\">\n              <Smile className=\"h-5 w-5 text-primary\" />\n              <div className=\"flex-1\">\n                <h3 className=\"font-semibold\">æ•´ä½“äº¤æµèˆ’é€‚åº¦</h3>\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  {closestComfortEmoji.label}\n                </p>\n              </div>\n              <div className=\"text-4xl\">{closestComfortEmoji.emoji}</div>\n            </div>\n\n            {/* Comfort Slider */}\n            <div className=\"space-y-4\">\n              <Slider\n                value={[comfort]}\n                onValueChange={(values) => setComfort(values[0])}\n                min={0}\n                max={100}\n                step={5}\n                className=\"w-full\"\n                data-testid=\"slider-comfort\"\n              />\n\n              {/* Emoji Scale */}\n              <div className=\"flex justify-between\">\n                {comfortEmojis.map(item => (\n                  <button\n                    key={item.value}\n                    onClick={() => setComfort(item.value)}\n                    className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors ${\n                      Math.abs(item.value - comfort) < 15 \n                        ? 'bg-primary/10' \n                        : 'hover:bg-muted'\n                    }`}\n                    data-testid={`button-comfort-${item.value}`}\n                  >\n                    <span className=\"text-2xl\">{item.emoji}</span>\n                    <span className=\"text-xs text-muted-foreground whitespace-nowrap\">\n                      {item.label}\n                    </span>\n                  </button>\n                ))}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </motion.div>\n\n      {/* Optional Notes */}\n      <motion.div\n        initial={{ opacity: 0, y: 10 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ delay: 0.3 }}\n      >\n        <Card>\n          <CardContent className=\"p-5 space-y-3\">\n            <h3 className=\"font-semibold\">ğŸ’­ æƒ³è¡¥å……è¯´æ˜çš„ï¼ˆå¯é€‰ï¼‰</h3>\n            <Textarea\n              placeholder=\"ä¾‹å¦‚ï¼šå‰åŠæ®µæ¯”è¾ƒå®‰é™ï¼ŒååŠæ®µèŠå¼€äº†...\"\n              value={notes}\n              onChange={(e) => setNotes(e.target.value)}\n              className=\"min-h-20\"\n              data-testid=\"textarea-dynamics-notes\"\n            />\n            <p className=\"text-xs text-muted-foreground\">\n              å¯é€‰å¡«å†™ Â· å¸®åŠ©æˆ‘ä»¬ç†è§£å¯¹è¯æ¼”å˜è¿‡ç¨‹\n            </p>\n          </CardContent>\n        </Card>\n      </motion.div>\n\n      {/* Value Impact */}\n      <motion.div\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        transition={{ delay: 0.4 }}\n        className=\"p-4 rounded-lg bg-primary/5 border border-primary/10\"\n      >\n        <p className=\"text-sm\">\n          <span className=\"font-medium text-primary\">ğŸ“Š ä½ çš„å…±å»ºè´¡çŒ®</span>\n          <span className=\"text-muted-foreground ml-2\">\n            å·²å®Œæˆ 2/3 ä¸ªå¯é€‰æ¨¡å— Â· ä½ çš„æ¯ä¸ªå›ç­”éƒ½åœ¨å¸®åŠ©æ ¡å‡†ç³»ç»Ÿ\n          </span>\n        </p>\n      </motion.div>\n\n      {/* Actions */}\n      <div className=\"flex gap-3\">\n        <Button\n          variant=\"outline\"\n          size=\"lg\"\n          onClick={onSkip}\n          className=\"flex-1\"\n          data-testid=\"button-skip\"\n        >\n          è·³è¿‡è¿™ä¸€æ­¥\n        </Button>\n        <Button\n          variant=\"default\"\n          size=\"lg\"\n          onClick={handleSubmit}\n          className=\"flex-1\"\n          data-testid=\"button-next\"\n        >\n          ä¸‹ä¸€æ­¥\n        </Button>\n      </div>\n\n      {/* Helper Text */}\n      <p className=\"text-center text-xs text-muted-foreground\">\n        ä½ çš„åˆ†äº«å°†ç»§ç»­è¿™ä¸ªæ”¹è¿›å¾ªç¯\n      </p>\n    </div>\n  );\n}\n","size_bytes":8651},"client/src/components/feedback/ImprovementCards.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { motion } from \"framer-motion\";\nimport { Check } from \"lucide-react\";\n\ninterface ImprovementCardsProps {\n  initialAreas?: string[];\n  initialOther?: string;\n  onNext: (data: { improvementAreas?: string[]; improvementOther?: string }) => void;\n  isSubmitting?: boolean;\n}\n\nconst IMPROVEMENT_OPTIONS = [\n  { id: \"matching\", label: \"æ›´ç²¾å‡†çš„åŒ¹é…ç®—æ³•\", emoji: \"ğŸ¯\", description: \"æå‡æ¡Œå‹åŒ¹é…åº¦\" },\n  { id: \"icebreaker\", label: \"æ›´æœ‰è¶£çš„ç ´å†°ç¯èŠ‚\", emoji: \"ğŸ²\", description: \"å¿«é€Ÿæ‰“å¼€è¯é¢˜\" },\n  { id: \"venue\", label: \"æ›´èˆ’é€‚çš„æ´»åŠ¨åœºåœ°\", emoji: \"ğŸ \", description: \"æå‡ç¯å¢ƒä½“éªŒ\" },\n  { id: \"theme\", label: \"æ›´æ˜ç¡®çš„ä¸»é¢˜å¼•å¯¼\", emoji: \"ğŸ“‹\", description: \"è®©èŠå¤©æ›´æœ‰æ–¹å‘\" },\n  { id: \"timing\", label: \"ä¼˜åŒ–æ´»åŠ¨æ—¶é—´å®‰æ’\", emoji: \"â°\", description: \"æ›´åˆç†çš„æ—¶é•¿\" },\n  { id: \"food\", label: \"æ›´å¥½çš„é¤é¥®é€‰æ‹©\", emoji: \"ğŸ½ï¸\", description: \"æå‡ç”¨é¤ä½“éªŒ\" },\n];\n\nexport default function ImprovementCards({\n  initialAreas = [],\n  initialOther = \"\",\n  onNext,\n  isSubmitting = false,\n}: ImprovementCardsProps) {\n  const [selectedAreas, setSelectedAreas] = useState<string[]>(initialAreas);\n  const [otherSuggestion, setOtherSuggestion] = useState(initialOther);\n\n  const toggleArea = (areaId: string) => {\n    setSelectedAreas(prev => {\n      if (prev.includes(areaId)) {\n        return prev.filter(id => id !== areaId);\n      } else if (prev.length < 3) {\n        return [...prev, areaId];\n      } else {\n        // Max 3 selections - replace the first one\n        return [...prev.slice(1), areaId];\n      }\n    });\n  };\n\n  const handleSubmit = () => {\n    onNext({\n      improvementAreas: selectedAreas.length > 0 ? selectedAreas : undefined,\n      improvementOther: otherSuggestion.trim() || undefined,\n    });\n  };\n\n  const canSubmit = selectedAreas.length > 0 || otherSuggestion.trim().length > 0;\n\n  return (\n    <div className=\"max-w-md mx-auto space-y-6\">\n      <Card>\n        <CardContent className=\"p-6 space-y-6\">\n          {/* Header */}\n          <div className=\"text-center space-y-2\">\n            <div className=\"text-4xl\">ğŸ¯</div>\n            <h2 className=\"text-xl font-bold\">è®©ä¸‹æ¬¡æ›´å®Œç¾</h2>\n            <p className=\"text-sm text-muted-foreground\">\n              é€‰æ‹©æœ€é‡è¦çš„æ”¹è¿›æ–¹å‘ï¼ˆæœ€å¤š3é¡¹ï¼‰\n            </p>\n          </div>\n\n          {/* Selection Counter */}\n          <div className=\"flex items-center justify-between text-sm p-3 rounded-lg bg-muted/50\">\n            <span className=\"text-muted-foreground\">å·²é€‰æ‹©</span>\n            <span className=\"font-medium text-primary\">\n              {selectedAreas.length}/3\n            </span>\n          </div>\n\n          {/* Improvement Cards Grid */}\n          <div className=\"grid grid-cols-1 gap-3\">\n            {IMPROVEMENT_OPTIONS.map((option, index) => {\n              const isSelected = selectedAreas.includes(option.id);\n              const selectionOrder = selectedAreas.indexOf(option.id) + 1;\n\n              return (\n                <motion.div\n                  key={option.id}\n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  transition={{ delay: index * 0.05 }}\n                >\n                  <button\n                    onClick={() => toggleArea(option.id)}\n                    className={`w-full p-4 rounded-lg border-2 text-left transition-all hover-elevate active-elevate-2 ${\n                      isSelected\n                        ? \"border-primary bg-primary/5\"\n                        : \"border-border bg-background\"\n                    }`}\n                    data-testid={`improvement-card-${option.id}`}\n                  >\n                    <div className=\"flex items-start gap-3\">\n                      {/* Emoji & Check */}\n                      <div className=\"relative\">\n                        <div className=\"text-2xl\">{option.emoji}</div>\n                        {isSelected && (\n                          <motion.div\n                            initial={{ scale: 0 }}\n                            animate={{ scale: 1 }}\n                            className=\"absolute -top-1 -right-1 bg-primary text-primary-foreground rounded-full h-5 w-5 flex items-center justify-center\"\n                          >\n                            <span className=\"text-xs font-bold\">{selectionOrder}</span>\n                          </motion.div>\n                        )}\n                      </div>\n\n                      {/* Content */}\n                      <div className=\"flex-1\">\n                        <p className=\"font-semibold text-sm\">{option.label}</p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">\n                          {option.description}\n                        </p>\n                      </div>\n\n                      {/* Checkmark */}\n                      {isSelected && (\n                        <motion.div\n                          initial={{ scale: 0 }}\n                          animate={{ scale: 1 }}\n                        >\n                          <Check className=\"h-5 w-5 text-primary\" />\n                        </motion.div>\n                      )}\n                    </div>\n                  </button>\n                </motion.div>\n              );\n            })}\n          </div>\n\n          {/* Other Suggestions */}\n          <div className=\"space-y-2 pt-4 border-t\">\n            <label className=\"text-sm font-medium flex items-center gap-2\">\n              <span>ğŸ’¡</span>\n              <span>å…¶ä»–å»ºè®®</span>\n            </label>\n            <Textarea\n              value={otherSuggestion}\n              onChange={(e) => setOtherSuggestion(e.target.value)}\n              placeholder=\"æœ‰å…¶ä»–æƒ³æ³•å—ï¼Ÿå†™ä¸‹æ¥å‘Šè¯‰æˆ‘ä»¬...\"\n              rows={3}\n              maxLength={200}\n              className=\"resize-none\"\n              data-testid=\"textarea-other-suggestion\"\n            />\n            <p className=\"text-xs text-muted-foreground text-right\">\n              {otherSuggestion.length}/200\n            </p>\n          </div>\n\n          {/* Submit Button */}\n          <div className=\"space-y-2\">\n            <Button \n              onClick={handleSubmit} \n              size=\"lg\" \n              className=\"w-full\"\n              disabled={!canSubmit || isSubmitting}\n              data-testid=\"button-submit-feedback\"\n            >\n              {isSubmitting ? (\n                <>\n                  <div className=\"h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2\" />\n                  æäº¤ä¸­...\n                </>\n              ) : (\n                \"å®Œæˆåé¦ˆ\"\n              )}\n            </Button>\n            {!canSubmit && (\n              <p className=\"text-xs text-center text-muted-foreground\">\n                è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹æ”¹è¿›æ–¹å‘æˆ–å¡«å†™å…¶ä»–å»ºè®®\n              </p>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Insight */}\n      {selectedAreas.length > 0 && (\n        <motion.div\n          initial={{ opacity: 0, scale: 0.95 }}\n          animate={{ opacity: 1, scale: 1 }}\n          className=\"p-4 rounded-lg bg-muted/50 space-y-2\"\n        >\n          <p className=\"text-sm font-medium\">ä½ çš„åé¦ˆå°†å¸®åŠ©ä¼˜åŒ–ï¼š</p>\n          <div className=\"flex flex-wrap gap-2\">\n            {selectedAreas.map((areaId) => {\n              const option = IMPROVEMENT_OPTIONS.find(o => o.id === areaId);\n              return option ? (\n                <Badge key={areaId} variant=\"secondary\" className=\"text-xs\">\n                  {option.emoji} {option.label}\n                </Badge>\n              ) : null;\n            })}\n          </div>\n        </motion.div>\n      )}\n    </div>\n  );\n}\n","size_bytes":7995},"client/src/components/feedback/DeepFeedbackCompletion.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { motion } from \"framer-motion\";\nimport { Heart, TrendingUp, Users } from \"lucide-react\";\n\ninterface DeepFeedbackCompletionProps {\n  onDone: () => void;\n}\n\nexport default function DeepFeedbackCompletion({ onDone }: DeepFeedbackCompletionProps) {\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-4\">\n      <motion.div\n        initial={{ scale: 0.9, opacity: 0 }}\n        animate={{ scale: 1, opacity: 1 }}\n        transition={{ duration: 0.4, ease: \"easeOut\" }}\n        className=\"max-w-md w-full\"\n      >\n        <Card>\n          <CardContent className=\"p-8 space-y-6\">\n            {/* Success Animation */}\n            <motion.div\n              initial={{ scale: 0 }}\n              animate={{ scale: 1 }}\n              transition={{ delay: 0.2, type: \"spring\", stiffness: 200 }}\n              className=\"text-center\"\n            >\n              <div className=\"relative mx-auto w-24 h-24 bg-gradient-to-br from-primary to-primary/50 rounded-full flex items-center justify-center\">\n                <Heart className=\"h-12 w-12 text-primary-foreground fill-current\" />\n                \n                {/* Pulse effect */}\n                <motion.div\n                  className=\"absolute inset-0 rounded-full border-4 border-primary\"\n                  initial={{ scale: 1, opacity: 0.5 }}\n                  animate={{ scale: 1.5, opacity: 0 }}\n                  transition={{ duration: 2, repeat: Infinity }}\n                />\n              </div>\n            </motion.div>\n\n            {/* Title */}\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.3 }}\n              className=\"text-center space-y-2\"\n            >\n              <h1 className=\"text-2xl font-bold\">ğŸ’« æ„Ÿè°¢ä½ çš„æ·±åº¦åˆ†äº«</h1>\n              <p className=\"text-sm text-muted-foreground\">\n                ä½ çš„åé¦ˆå·²åŠ å…¥æˆ‘ä»¬çš„æ”¹è¿›åˆ†æ\n              </p>\n            </motion.div>\n\n            {/* Impact Stats */}\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.4 }}\n              className=\"space-y-3\"\n            >\n              <div className=\"grid grid-cols-3 gap-3\">\n                <div className=\"text-center p-4 rounded-lg bg-primary/5\">\n                  <div className=\"text-2xl font-bold text-primary\">3</div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">æ¨¡å—å®Œæˆ</div>\n                </div>\n                <div className=\"text-center p-4 rounded-lg bg-primary/5\">\n                  <div className=\"text-2xl font-bold text-primary\">8+</div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">æœ‰æ•ˆæ´å¯Ÿ</div>\n                </div>\n                <div className=\"text-center p-4 rounded-lg bg-primary/5\">\n                  <div className=\"text-2xl font-bold text-primary\">5</div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">ç»´åº¦ä¼˜åŒ–</div>\n                </div>\n              </div>\n            </motion.div>\n\n            {/* Value Loop */}\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.5 }}\n              className=\"p-5 rounded-lg bg-gradient-to-br from-primary/10 to-primary/5 border border-primary/20 space-y-3\"\n            >\n              <div className=\"flex items-center gap-2\">\n                <TrendingUp className=\"h-5 w-5 text-primary\" />\n                <h3 className=\"font-semibold\">ä½ çš„åé¦ˆæ­£åœ¨å‘æŒ¥ä½œç”¨</h3>\n              </div>\n              <div className=\"space-y-2 text-sm text-muted-foreground\">\n                <div className=\"flex items-start gap-2\">\n                  <span className=\"text-primary\">âœ“</span>\n                  <span>å·²å½’å…¥ã€Œå¥‘åˆç‚¹æœ‰æ•ˆæ€§ã€åˆ†ææ± </span>\n                </div>\n                <div className=\"flex items-start gap-2\">\n                  <span className=\"text-primary\">âœ“</span>\n                  <span>å°†ç”¨äºæ ¡å‡†ã€Œäº¤æµåŠ¨æ€ã€é¢„æµ‹æ¨¡å‹</span>\n                </div>\n                <div className=\"flex items-start gap-2\">\n                  <span className=\"text-primary\">âœ“</span>\n                  <span>å¸®åŠ©è®¾è®¡ã€Œä¸ªæ€§åŒ–åå¥½ã€åŒ¹é…ç®—æ³•</span>\n                </div>\n              </div>\n            </motion.div>\n\n            {/* Community Impact */}\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.6 }}\n              className=\"p-4 rounded-lg bg-muted/50 space-y-2\"\n            >\n              <div className=\"flex items-center gap-2\">\n                <Users className=\"h-5 w-5 text-primary\" />\n                <span className=\"text-sm font-semibold\">ç¤¾åŒºå…±å»º</span>\n              </div>\n              <p className=\"text-sm text-muted-foreground\">\n                åŸºäºåƒä½ ä¸€æ ·çš„ç”¨æˆ·åé¦ˆï¼Œæˆ‘ä»¬æŒç»­æ”¹è¿›åŒ¹é…è´¨é‡ã€ä¼˜åŒ–æ´»åŠ¨ä½“éªŒï¼Œè®©æ¯ä¸ªäººéƒ½èƒ½æ‰¾åˆ°çœŸæ­£å¥‘åˆçš„ä¼™ä¼´\n              </p>\n            </motion.div>\n\n            {/* Action Button */}\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.7 }}\n            >\n              <Button \n                onClick={onDone} \n                size=\"lg\" \n                className=\"w-full\"\n                data-testid=\"button-done\"\n              >\n                è¿”å›æ´»åŠ¨åˆ—è¡¨\n              </Button>\n            </motion.div>\n\n            {/* Thank you message */}\n            <motion.p\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              transition={{ delay: 0.8 }}\n              className=\"text-center text-xs text-muted-foreground\"\n            >\n              ä½ çš„æ¯ä¸ªåˆ†äº«éƒ½è®© JoyJoin å˜å¾—æ›´å¥½ âœ¨\n            </motion.p>\n          </CardContent>\n        </Card>\n      </motion.div>\n    </div>\n  );\n}\n","size_bytes":6194},"client/src/components/feedback/FeedbackCompletion.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { motion } from \"framer-motion\";\nimport { Sparkles, Gift, Star, Target } from \"lucide-react\";\n\ninterface FeedbackCompletionProps {\n  onDone: () => void;\n  onDeepFeedback?: () => void;\n}\n\nexport default function FeedbackCompletion({ onDone, onDeepFeedback }: FeedbackCompletionProps) {\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-4\">\n      <motion.div\n        initial={{ scale: 0.9, opacity: 0 }}\n        animate={{ scale: 1, opacity: 1 }}\n        transition={{ duration: 0.4, ease: \"easeOut\" }}\n        className=\"max-w-md w-full\"\n      >\n        <Card>\n          <CardContent className=\"p-8 space-y-6\">\n            {/* Success Animation */}\n            <motion.div\n              initial={{ scale: 0 }}\n              animate={{ scale: 1 }}\n              transition={{ delay: 0.2, type: \"spring\", stiffness: 200 }}\n              className=\"text-center\"\n            >\n              <div className=\"relative mx-auto w-24 h-24 bg-gradient-to-br from-primary to-primary/50 rounded-full flex items-center justify-center\">\n                <Sparkles className=\"h-12 w-12 text-primary-foreground\" />\n                \n                {/* Confetti particles */}\n                {[...Array(8)].map((_, i) => (\n                  <motion.div\n                    key={i}\n                    className=\"absolute w-2 h-2 bg-primary rounded-full\"\n                    initial={{ scale: 0, x: 0, y: 0 }}\n                    animate={{\n                      scale: [0, 1, 0],\n                      x: [0, Math.cos(i * 45 * Math.PI / 180) * 40],\n                      y: [0, Math.sin(i * 45 * Math.PI / 180) * 40],\n                    }}\n                    transition={{\n                      duration: 0.8,\n                      delay: 0.3 + i * 0.05,\n                      ease: \"easeOut\",\n                    }}\n                  />\n                ))}\n              </div>\n            </motion.div>\n\n            {/* Title */}\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.4 }}\n              className=\"text-center space-y-2\"\n            >\n              <h1 className=\"text-2xl font-bold\">åé¦ˆå®Œæˆï¼</h1>\n              <p className=\"text-sm text-muted-foreground\">\n                æ„Ÿè°¢ä½ çš„å®è´µæ„è§ï¼Œå¸®åŠ©æˆ‘ä»¬å˜å¾—æ›´å¥½\n              </p>\n            </motion.div>\n\n            {/* Rewards Section */}\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.5 }}\n              className=\"space-y-3\"\n            >\n              <div className=\"flex items-center gap-2 mb-4\">\n                <Gift className=\"h-5 w-5 text-primary\" />\n                <span className=\"font-semibold\">æ„Ÿè°¢å¥–åŠ±</span>\n              </div>\n\n              {/* Reward Cards */}\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-3 p-4 rounded-lg bg-primary/5 border border-primary/10\">\n                  <div className=\"text-3xl\">ğŸ</div>\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium text-primary\">50 ç§¯åˆ†</p>\n                    <p className=\"text-xs text-muted-foreground\">å¯ç”¨äºä¸‹æ¬¡æ´»åŠ¨</p>\n                  </div>\n                  <Badge className=\"bg-primary/20 text-primary\">å·²è·å¾—</Badge>\n                </div>\n\n                <div className=\"flex items-center gap-3 p-4 rounded-lg bg-muted/50 border\">\n                  <div className=\"text-3xl\">â­</div>\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium\">ã€Œä¼˜è´¨åé¦ˆè€…ã€æ ‡è¯†</p>\n                    <p className=\"text-xs text-muted-foreground\">å±•ç¤ºä½ çš„è´¡çŒ®</p>\n                  </div>\n                  <Badge variant=\"outline\">å·²æ¿€æ´»</Badge>\n                </div>\n\n                <div className=\"flex items-center gap-3 p-4 rounded-lg bg-muted/50 border\">\n                  <div className=\"text-3xl\">ğŸ¯</div>\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium\">ä¸‹æœŸæ´»åŠ¨åŒ¹é…ä¼˜å…ˆæƒ</p>\n                    <p className=\"text-xs text-muted-foreground\">æ›´å¿«æ‰¾åˆ°å¿ƒä»ªæ´»åŠ¨</p>\n                  </div>\n                  <Badge variant=\"outline\">å·²æ¿€æ´»</Badge>\n                </div>\n              </div>\n            </motion.div>\n\n            {/* Impact Section */}\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.6 }}\n              className=\"p-4 rounded-lg bg-muted/50 space-y-3\"\n            >\n              <div className=\"flex items-center gap-2\">\n                <Target className=\"h-5 w-5 text-primary\" />\n                <span className=\"text-sm font-semibold\">ä½ çš„åé¦ˆå°†å¸®åŠ©ä¼˜åŒ–ï¼š</span>\n              </div>\n              <ul className=\"space-y-2 text-sm text-muted-foreground\">\n                <li className=\"flex items-start gap-2\">\n                  <span className=\"text-primary mt-1\">â€¢</span>\n                  <span>åŒ¹é…ç®—æ³•ç²¾å‡†åº¦</span>\n                </li>\n                <li className=\"flex items-start gap-2\">\n                  <span className=\"text-primary mt-1\">â€¢</span>\n                  <span>æ´»åŠ¨ä½“éªŒè´¨é‡</span>\n                </li>\n                <li className=\"flex items-start gap-2\">\n                  <span className=\"text-primary mt-1\">â€¢</span>\n                  <span>æœªæ¥ä¼™ä¼´æ¨è</span>\n                </li>\n              </ul>\n            </motion.div>\n\n            {/* Deep Feedback Invitation */}\n            {onDeepFeedback && (\n              <motion.div\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: 0.7 }}\n                className=\"p-6 rounded-lg bg-gradient-to-br from-primary/5 to-primary/10 border border-primary/20 space-y-4\"\n              >\n                <div className=\"flex items-start gap-3\">\n                  <div className=\"text-3xl\">ğŸ’«</div>\n                  <div className=\"flex-1 space-y-2\">\n                    <h3 className=\"font-semibold text-lg\">å¸®åŠ©æˆ‘ä»¬è®©åŒ¹é…æ›´ç²¾å‡†</h3>\n                    <p className=\"text-sm text-muted-foreground italic\">\n                      å¯é€‰ Â· çº¦3åˆ†é’Ÿ Â· åŒ¿åå¤„ç†\n                    </p>\n                    <div className=\"text-sm space-y-1\">\n                      <p className=\"text-muted-foreground\">ä½ çš„æ·±åº¦è§è§£å°†ç›´æ¥å¸®åŠ©æˆ‘ä»¬ï¼š</p>\n                      <ul className=\"space-y-1 ml-2\">\n                        <li className=\"flex items-start gap-2\">\n                          <span className=\"text-primary mt-0.5\">â€¢</span>\n                          <span className=\"text-muted-foreground\">æ ¡å‡†å¥‘åˆç‚¹ç³»ç»Ÿçš„å‡†ç¡®æ€§</span>\n                        </li>\n                        <li className=\"flex items-start gap-2\">\n                          <span className=\"text-primary mt-0.5\">â€¢</span>\n                          <span className=\"text-muted-foreground\">ç†è§£çœŸå®ç¤¾äº¤ä¸­çš„è¿æ¥é€»è¾‘</span>\n                        </li>\n                        <li className=\"flex items-start gap-2\">\n                          <span className=\"text-primary mt-0.5\">â€¢</span>\n                          <span className=\"text-muted-foreground\">ä¸ºæœªæ¥ç”¨æˆ·åˆ›é€ æ›´å¥½çš„ä½“éªŒ</span>\n                        </li>\n                      </ul>\n                    </div>\n                  </div>\n                </div>\n                \n                <div className=\"flex gap-3\">\n                  <Button\n                    onClick={onDeepFeedback}\n                    variant=\"default\"\n                    className=\"flex-1\"\n                    data-testid=\"button-deep-feedback\"\n                  >\n                    <Sparkles className=\"h-4 w-4 mr-2\" />\n                    å‚ä¸æ·±åº¦åé¦ˆï¼Œå…±å»ºæ›´å¥½ä½“éªŒ\n                  </Button>\n                </div>\n              </motion.div>\n            )}\n\n            {/* Action Button */}\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: onDeepFeedback ? 0.8 : 0.7 }}\n            >\n              <Button \n                onClick={onDone} \n                size=\"lg\" \n                variant={onDeepFeedback ? \"outline\" : \"default\"}\n                className=\"w-full\"\n                data-testid=\"button-done\"\n              >\n                {onDeepFeedback ? \"æš‚æ—¶ä¸ç”¨ï¼Œè°¢è°¢\" : \"è¿”å›æ´»åŠ¨åˆ—è¡¨\"}\n              </Button>\n            </motion.div>\n\n            {/* Thank you message */}\n            <motion.p\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              transition={{ delay: 0.8 }}\n              className=\"text-center text-xs text-muted-foreground\"\n            >\n              æœŸå¾…ä¸‹æ¬¡ä¸ä½ ç›¸é‡ âœ¨\n            </motion.p>\n          </CardContent>\n        </Card>\n      </motion.div>\n    </div>\n  );\n}\n","size_bytes":9250},"client/src/components/feedback/MatchPointValidation.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { motion } from \"framer-motion\";\nimport { Target, MessageCircle, Users, Briefcase } from \"lucide-react\";\nimport { useState } from \"react\";\n\ninterface MatchPoint {\n  id: string;\n  label: string;\n  icon: typeof Users;\n  description: string;\n}\n\ninterface MatchPointValidationProps {\n  matchPoints: MatchPoint[];\n  initialData?: Record<string, { discussed: string; notes?: string }>;\n  onNext: (data: { validation: Record<string, { discussed: string; notes?: string }>; additional: string }) => void;\n  onSkip: () => void;\n}\n\nconst discussionLevels = [\n  { value: \"deeply\", label: \"æ·±å…¥èŠåˆ°äº†\", color: \"bg-primary text-primary-foreground\" },\n  { value: \"briefly\", label: \"ç®€å•æåŠ\", color: \"bg-muted\" },\n  { value: \"not\", label: \"æ²¡èŠåˆ°\", color: \"bg-muted/50\" },\n];\n\nexport default function MatchPointValidation({ \n  matchPoints, \n  initialData = {}, \n  onNext, \n  onSkip \n}: MatchPointValidationProps) {\n  const [validation, setValidation] = useState<Record<string, { discussed: string; notes?: string }>>(initialData);\n  const [additionalPoints, setAdditionalPoints] = useState(\"\");\n\n  const handleDiscussionSelect = (pointId: string, level: string) => {\n    setValidation(prev => ({\n      ...prev,\n      [pointId]: { ...prev[pointId], discussed: level }\n    }));\n  };\n\n  const handleSubmit = () => {\n    onNext({ validation, additional: additionalPoints });\n  };\n\n  const completedCount = Object.values(validation).filter(v => v.discussed).length;\n  const canProceed = completedCount >= 1; // At least one match point rated\n\n  return (\n    <div className=\"space-y-8\">\n      {/* Header */}\n      <motion.div\n        initial={{ opacity: 0, y: -10 }}\n        animate={{ opacity: 1, y: 0 }}\n        className=\"space-y-3\"\n      >\n        <div className=\"flex items-center gap-3\">\n          <div className=\"p-3 rounded-lg bg-primary/10\">\n            <Target className=\"h-6 w-6 text-primary\" />\n          </div>\n          <div>\n            <h2 className=\"text-xl font-bold\">å¸®åŠ©æˆ‘ä»¬æ ¡å‡†åŒ¹é…ç®—æ³•</h2>\n            <p className=\"text-sm text-muted-foreground\">è¿™äº›å…±åŒç‚¹åœ¨å®é™…äº¤æµä¸­èµ·ä½œç”¨äº†å—ï¼Ÿ</p>\n          </div>\n        </div>\n\n        {/* Privacy Notice */}\n        <Card className=\"bg-muted/30\">\n          <CardContent className=\"p-3 flex items-start gap-2\">\n            <div className=\"text-sm\">\n              <span className=\"font-medium\">ğŸ”’ ä½ çš„åé¦ˆå®‰å…¨æ‰¿è¯ºï¼š</span>\n              <span className=\"text-muted-foreground ml-1\">\n                æ‰€æœ‰è¯„ä»·ä¸¥æ ¼åŒ¿åå¤„ç†ï¼Œæ•°æ®ä»…ç”¨äºç®—æ³•ä¼˜åŒ–\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n      </motion.div>\n\n      {/* Progress Indicator */}\n      <div className=\"flex items-center justify-between text-sm\">\n        <span className=\"text-muted-foreground\">å¯é€‰é—®é¢˜ 1/3</span>\n        <Badge variant=\"outline\">\n          å·²è¯„ä»· {completedCount}/{matchPoints.length}\n        </Badge>\n      </div>\n\n      {/* Match Points List */}\n      <div className=\"space-y-4\">\n        {matchPoints.map((point, index) => {\n          const Icon = point.icon;\n          const selectedLevel = validation[point.id]?.discussed;\n\n          return (\n            <motion.div\n              key={point.id}\n              initial={{ opacity: 0, x: -10 }}\n              animate={{ opacity: 1, x: 0 }}\n              transition={{ delay: index * 0.1 }}\n            >\n              <Card className={selectedLevel ? \"border-primary/30\" : \"\"}>\n                <CardContent className=\"p-5 space-y-4\">\n                  <div className=\"flex items-start gap-3\">\n                    <Icon className=\"h-5 w-5 text-primary mt-1\" />\n                    <div className=\"flex-1\">\n                      <h3 className=\"font-semibold\">{point.label}</h3>\n                      <p className=\"text-sm text-muted-foreground\">{point.description}</p>\n                    </div>\n                  </div>\n\n                  {/* Discussion Level Selection */}\n                  <div className=\"space-y-2\">\n                    <p className=\"text-sm font-medium\">è¿™ä¸ªè¯é¢˜ï¼š</p>\n                    <div className=\"flex gap-2\">\n                      {discussionLevels.map(level => (\n                        <Button\n                          key={level.value}\n                          variant={selectedLevel === level.value ? \"default\" : \"outline\"}\n                          size=\"sm\"\n                          onClick={() => handleDiscussionSelect(point.id, level.value)}\n                          className={selectedLevel === level.value ? level.color : \"\"}\n                          data-testid={`button-level-${point.id}-${level.value}`}\n                        >\n                          {level.label}\n                        </Button>\n                      ))}\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </motion.div>\n          );\n        })}\n      </div>\n\n      {/* Additional Match Points */}\n      <motion.div\n        initial={{ opacity: 0, y: 10 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ delay: 0.4 }}\n      >\n        <Card>\n          <CardContent className=\"p-5 space-y-3\">\n            <div className=\"flex items-center gap-2\">\n              <MessageCircle className=\"h-5 w-5 text-primary\" />\n              <h3 className=\"font-semibold\">ğŸ’¡ è¿˜æœ‰å…¶ä»–ä¿ƒè¿›äº¤æµçš„å…±åŒç‚¹å—ï¼Ÿ</h3>\n            </div>\n            <Textarea\n              placeholder=\"ä¾‹å¦‚ï¼šéƒ½å–œæ¬¢æ—…è¡Œã€éƒ½å…³æ³¨ç§‘æŠ€æ–°é—»ã€éƒ½åœ¨å­¦æ—¥è¯­...\"\n              value={additionalPoints}\n              onChange={(e) => setAdditionalPoints(e.target.value)}\n              className=\"min-h-20\"\n              data-testid=\"textarea-additional-points\"\n            />\n            <p className=\"text-xs text-muted-foreground\">\n              å¯é€‰å¡«å†™ Â· å¸®åŠ©æˆ‘ä»¬å‘ç°æ›´å¤šæœ‰ä»·å€¼çš„åŒ¹é…ç»´åº¦\n            </p>\n          </CardContent>\n        </Card>\n      </motion.div>\n\n      {/* Value Impact */}\n      <motion.div\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        transition={{ delay: 0.5 }}\n        className=\"p-4 rounded-lg bg-primary/5 border border-primary/10\"\n      >\n        <p className=\"text-sm\">\n          <span className=\"font-medium text-primary\">ğŸ’« æ¯ä¸ªåé¦ˆéƒ½åœ¨åˆ›é€ ä»·å€¼</span>\n          <span className=\"text-muted-foreground ml-2\">\n            åŸºäºç”¨æˆ·ä»¬çš„æ·±åº¦åé¦ˆï¼Œæˆ‘ä»¬å·²ä¼˜åŒ–äº†ã€ŒèŒä¸šèƒŒæ™¯ã€åŒ¹é…é€»è¾‘ï¼Œå‘ç°äº†ã€Œä»·å€¼è§‚ç›¸ä¼¼ã€çš„é‡è¦æ€§\n          </span>\n        </p>\n      </motion.div>\n\n      {/* Actions */}\n      <div className=\"flex gap-3\">\n        <Button\n          variant=\"outline\"\n          size=\"lg\"\n          onClick={onSkip}\n          className=\"flex-1\"\n          data-testid=\"button-skip\"\n        >\n          è·³è¿‡è¿™ä¸€æ­¥\n        </Button>\n        <Button\n          variant=\"default\"\n          size=\"lg\"\n          onClick={handleSubmit}\n          disabled={!canProceed}\n          className=\"flex-1\"\n          data-testid=\"button-next\"\n        >\n          ä¸‹ä¸€æ­¥\n        </Button>\n      </div>\n\n      {/* Helper Text */}\n      <p className=\"text-center text-xs text-muted-foreground\">\n        ä½ å¯ä»¥éšæ—¶è·³è¿‡ä¸æ„Ÿå…´è¶£çš„éƒ¨åˆ† Â· éƒ¨åˆ†å®Œæˆä¹Ÿæœ‰ä»·å€¼\n      </p>\n    </div>\n  );\n}\n","size_bytes":7504},"client/src/components/feedback/MatchingPreferences.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { motion } from \"framer-motion\";\nimport { Lightbulb, Check } from \"lucide-react\";\nimport { useState } from \"react\";\n\ninterface PreferenceOption {\n  id: string;\n  icon: string;\n  label: string;\n  description: string;\n}\n\ninterface MatchingPreferencesProps {\n  initialData?: {\n    preferences?: string[];\n    other?: string;\n  };\n  onNext: (data: { preferences: string[]; other: string }) => void;\n  onSkip: () => void;\n}\n\nconst preferenceOptions: PreferenceOption[] = [\n  {\n    id: \"diversity\",\n    icon: \"ğŸŒˆ\",\n    label: \"é‡åˆ°æ›´å¤šä¸åŒèƒŒæ™¯çš„ä¼™ä¼´\",\n    description: \"è·¨è¡Œä¸šã€è·¨é¢†åŸŸã€å¤šå…ƒåŒ–è§†è§’\"\n  },\n  {\n    id: \"deep_topics\",\n    icon: \"ğŸ’¡\",\n    label: \"æœ‰æ›´æ·±å…¥çš„ä¸“é¢˜è®¨è®º\",\n    description: \"å‡å°‘å¯’æš„ï¼Œèšç„¦æŸä¸ªè¯é¢˜æ·±å…¥äº¤æµ\"\n  },\n  {\n    id: \"casual\",\n    icon: \"â˜•\",\n    label: \"æ›´å¤šè½»æ¾æ„‰å¿«çš„äº¤æµ\",\n    description: \"ä¸é‚£ä¹ˆä¸¥è‚ƒï¼Œæ›´éšæ„è‡ªç„¶çš„æ°›å›´\"\n  },\n  {\n    id: \"similar_stage\",\n    icon: \"ğŸ¯\",\n    label: \"ç›¸ä¼¼äººç”Ÿé˜¶æ®µçš„ä¼™ä¼´\",\n    description: \"å¹´é¾„ã€èŒä¸šå‘å±•é˜¶æ®µæ›´æ¥è¿‘\"\n  },\n  {\n    id: \"shared_hobbies\",\n    icon: \"ğŸ¨\",\n    label: \"æœ‰å…±åŒå…´è¶£çˆ±å¥½çš„æœ‹å‹\",\n    description: \"è¿åŠ¨ã€è‰ºæœ¯ã€ç§‘æŠ€ç­‰å…·ä½“å…´è¶£å¥‘åˆ\"\n  },\n  {\n    id: \"networking\",\n    icon: \"ğŸ¤\",\n    label: \"å»ºç«‹æœ‰ä»·å€¼çš„èŒä¸šè”ç³»\",\n    description: \"å¯èƒ½äº§ç”Ÿåˆä½œæˆ–èŒä¸šå‘å±•æœºä¼š\"\n  },\n];\n\nexport default function MatchingPreferences({ \n  initialData = {}, \n  onNext, \n  onSkip \n}: MatchingPreferencesProps) {\n  const [selectedPreferences, setSelectedPreferences] = useState<string[]>(\n    initialData.preferences ?? []\n  );\n  const [otherPreference, setOtherPreference] = useState(initialData.other ?? \"\");\n\n  const togglePreference = (id: string) => {\n    setSelectedPreferences(prev => \n      prev.includes(id) \n        ? prev.filter(p => p !== id)\n        : [...prev, id]\n    );\n  };\n\n  const handleSubmit = () => {\n    onNext({ preferences: selectedPreferences, other: otherPreference });\n  };\n\n  const canProceed = selectedPreferences.length >= 1 || otherPreference.trim().length > 0;\n\n  return (\n    <div className=\"space-y-8\">\n      {/* Header */}\n      <motion.div\n        initial={{ opacity: 0, y: -10 }}\n        animate={{ opacity: 1, y: 0 }}\n        className=\"space-y-3\"\n      >\n        <div className=\"flex items-center gap-3\">\n          <div className=\"p-3 rounded-lg bg-primary/10\">\n            <Lightbulb className=\"h-6 w-6 text-primary\" />\n          </div>\n          <div>\n            <h2 className=\"text-xl font-bold\">å¸®åŠ©æˆ‘ä»¬ç†è§£ä½ çš„åå¥½</h2>\n            <p className=\"text-sm text-muted-foreground\">æˆ‘å¸Œæœ›æœªæ¥æ´»åŠ¨ä¸­...</p>\n          </div>\n        </div>\n      </motion.div>\n\n      {/* Progress Indicator */}\n      <div className=\"flex items-center justify-between text-sm\">\n        <span className=\"text-muted-foreground\">å¯é€‰é—®é¢˜ 3/3</span>\n        <Badge variant=\"outline\">\n          å·²é€‰æ‹© {selectedPreferences.length} ä¸ªåå¥½\n        </Badge>\n      </div>\n\n      {/* Preference Options */}\n      <div className=\"grid gap-3\">\n        {preferenceOptions.map((option, index) => {\n          const isSelected = selectedPreferences.includes(option.id);\n\n          return (\n            <motion.div\n              key={option.id}\n              initial={{ opacity: 0, x: -10 }}\n              animate={{ opacity: 1, x: 0 }}\n              transition={{ delay: index * 0.08 }}\n            >\n              <Card \n                className={`cursor-pointer transition-all hover-elevate ${\n                  isSelected \n                    ? 'border-primary bg-primary/5' \n                    : 'border-border'\n                }`}\n                onClick={() => togglePreference(option.id)}\n                data-testid={`card-preference-${option.id}`}\n              >\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-start gap-3\">\n                    {/* Checkbox */}\n                    <div className={`\n                      mt-0.5 w-5 h-5 rounded border-2 flex items-center justify-center transition-colors\n                      ${isSelected \n                        ? 'border-primary bg-primary' \n                        : 'border-muted-foreground/30'\n                      }\n                    `}>\n                      {isSelected && <Check className=\"h-3 w-3 text-primary-foreground\" />}\n                    </div>\n\n                    {/* Icon */}\n                    <div className=\"text-2xl\">{option.icon}</div>\n\n                    {/* Content */}\n                    <div className=\"flex-1\">\n                      <h3 className=\"font-semibold\">{option.label}</h3>\n                      <p className=\"text-sm text-muted-foreground mt-1\">\n                        {option.description}\n                      </p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </motion.div>\n          );\n        })}\n      </div>\n\n      {/* Other Preferences */}\n      <motion.div\n        initial={{ opacity: 0, y: 10 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ delay: 0.5 }}\n      >\n        <Card>\n          <CardContent className=\"p-5 space-y-3\">\n            <h3 className=\"font-semibold\">ğŸ’¬ å…¶ä»–æœŸå¾…</h3>\n            <Textarea\n              placeholder=\"ä¾‹å¦‚ï¼šå¸Œæœ›æ´»åŠ¨æ—¶é•¿æ›´çµæ´»ã€æƒ³è¦æ›´å°è§„æ¨¡çš„èšä¼šã€æœŸå¾…å›ºå®šçš„å…´è¶£å°ç»„...\"\n              value={otherPreference}\n              onChange={(e) => setOtherPreference(e.target.value)}\n              className=\"min-h-24\"\n              data-testid=\"textarea-other-preferences\"\n            />\n            <p className=\"text-xs text-muted-foreground\">\n              å¯é€‰å¡«å†™ Â· ä½ çš„å»ºè®®å°†å¸®åŠ©æˆ‘ä»¬è®¾è®¡æ›´å¤šå…ƒçš„æ´»åŠ¨ç±»å‹\n            </p>\n          </CardContent>\n        </Card>\n      </motion.div>\n\n      {/* Impact Showcase */}\n      <motion.div\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        transition={{ delay: 0.6 }}\n        className=\"space-y-3\"\n      >\n        <Card className=\"bg-gradient-to-br from-primary/10 to-primary/5 border-primary/20\">\n          <CardContent className=\"p-5 space-y-3\">\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-2xl\">ğŸ”</span>\n              <h3 className=\"font-semibold\">ä½ çš„åé¦ˆå¦‚ä½•è¢«ä½¿ç”¨</h3>\n            </div>\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm\">\n              <div className=\"flex items-start gap-2\">\n                <span className=\"text-primary mt-1\">1.</span>\n                <div>\n                  <p className=\"font-medium\">æ¨¡å¼è¯†åˆ«</p>\n                  <p className=\"text-muted-foreground\">åˆ†æå¤§é‡åé¦ˆä¸­çš„å…±åŒæ¨¡å¼</p>\n                </div>\n              </div>\n              <div className=\"flex items-start gap-2\">\n                <span className=\"text-primary mt-1\">2.</span>\n                <div>\n                  <p className=\"font-medium\">ç®—æ³•æ ¡å‡†</p>\n                  <p className=\"text-muted-foreground\">è°ƒæ•´å¥‘åˆç‚¹æƒé‡å’Œé€»è¾‘</p>\n                </div>\n              </div>\n              <div className=\"flex items-start gap-2\">\n                <span className=\"text-primary mt-1\">3.</span>\n                <div>\n                  <p className=\"font-medium\">äº§å“è¿­ä»£</p>\n                  <p className=\"text-muted-foreground\">åŸºäºä½“éªŒæ”¹è¿›åŠŸèƒ½è®¾è®¡</p>\n                </div>\n              </div>\n              <div className=\"flex items-start gap-2\">\n                <span className=\"text-primary mt-1\">4.</span>\n                <div>\n                  <p className=\"font-medium\">ä½“éªŒæå‡</p>\n                  <p className=\"text-muted-foreground\">ä¸ºæ‰€æœ‰ç”¨æˆ·åˆ›é€ æ›´å¥½ä½“éªŒ</p>\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </motion.div>\n\n      {/* Actions */}\n      <div className=\"flex gap-3\">\n        <Button\n          variant=\"outline\"\n          size=\"lg\"\n          onClick={onSkip}\n          className=\"flex-1\"\n          data-testid=\"button-skip\"\n        >\n          è·³è¿‡è¿™ä¸€æ­¥\n        </Button>\n        <Button\n          variant=\"default\"\n          size=\"lg\"\n          onClick={handleSubmit}\n          disabled={!canProceed}\n          className=\"flex-1\"\n          data-testid=\"button-submit\"\n        >\n          å®Œæˆæ·±åº¦åé¦ˆ\n        </Button>\n      </div>\n\n      {/* Encouragement */}\n      <motion.div\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        transition={{ delay: 0.7 }}\n        className=\"text-center space-y-2\"\n      >\n        <p className=\"text-sm text-muted-foreground\">\n          ğŸ¤ å…±åŒåˆ›é€ æ›´å¥½çš„ç¤¾äº¤ä½“éªŒ\n        </p>\n        <p className=\"text-xs text-muted-foreground\">\n          æ„Ÿè°¢ä½ é€‰æ‹©åˆ†äº«è§è§£ Â· æ¯ä¸ªç”¨æˆ·çš„çœŸå®ä½“éªŒéƒ½å®è´µ\n        </p>\n      </motion.div>\n    </div>\n  );\n}\n","size_bytes":9153},"client/src/pages/EventFeedbackFlow.tsx":{"content":"import { useState } from \"react\";\nimport { useParams, useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { ChevronLeft, Sparkles } from \"lucide-react\";\nimport type { BlindBoxEvent, EventFeedback } from \"@shared/schema\";\nimport AtmosphereThermometer from \"@/components/feedback/AtmosphereThermometer\";\nimport TraitTagsWall from \"@/components/feedback/TraitTagsWall\";\nimport ConnectionRadar from \"@/components/feedback/ConnectionRadar\";\nimport SelectConnectionsStep from \"@/components/feedback/SelectConnectionsStep\";\nimport ImprovementCards from \"@/components/feedback/ImprovementCards\";\nimport FeedbackCompletion from \"@/components/feedback/FeedbackCompletion\";\n\ntype FeedbackStep = \"intro\" | \"atmosphere\" | \"traits\" | \"radar\" | \"selectConnections\" | \"improvement\" | \"completion\";\n\ninterface FeedbackData {\n  atmosphereScore?: number;\n  atmosphereNote?: string;\n  attendeeTraits?: Record<string, any>;\n  connectionRadar?: {\n    topicResonance: number;\n    personalityMatch: number;\n    backgroundDiversity: number;\n    overallFit: number;\n  };\n  hasNewConnections?: boolean;\n  connectionStatus?: string;\n  connections?: string[];\n  improvementAreas?: string[];\n  improvementOther?: string;\n}\n\nexport default function EventFeedbackFlow() {\n  const { eventId } = useParams<{ eventId: string }>();\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  \n  const [currentStep, setCurrentStep] = useState<FeedbackStep>(\"intro\");\n  const [feedbackData, setFeedbackData] = useState<FeedbackData>({});\n\n  // Fetch event details\n  const { data: event, isLoading } = useQuery<BlindBoxEvent>({\n    queryKey: [`/api/blind-box-events/${eventId}`],\n    enabled: !!eventId,\n  });\n\n  // Check if feedback already exists\n  const { data: existingFeedback } = useQuery<EventFeedback | null>({\n    queryKey: [`/api/events/${eventId}/feedback`],\n    enabled: !!eventId,\n  });\n\n  // Submit feedback mutation\n  const submitMutation = useMutation({\n    mutationFn: async (data: FeedbackData) => {\n      return await apiRequest(\"POST\", `/api/events/${eventId}/feedback`, data);\n    },\n    onSuccess: (response: any) => {\n      queryClient.invalidateQueries({ queryKey: [`/api/events/${eventId}/feedback`] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/my-events\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/my-feedbacks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/direct-messages\"] });\n      \n      // Check for mutual matches\n      if (response.mutualMatches && response.mutualMatches.length > 0) {\n        const matchCount = response.mutualMatches.length;\n        const names = response.mutualMatches\n          .map((m: any) => m.displayName || \"æŸä½å‚ä¸è€…\")\n          .join(\"ã€\");\n        \n        toast({\n          title: \"ğŸ‰ åŒå‘åŒ¹é…æˆåŠŸï¼\",\n          description: `ä½ å’Œ${names}äº’ç›¸é€‰æ‹©äº†å¯¹æ–¹ï¼ç°åœ¨å¯ä»¥å¼€å§‹1å¯¹1ç§èŠäº†ï½`,\n          duration: 6000,\n        });\n      }\n      \n      setCurrentStep(\"completion\");\n    },\n    onError: (error) => {\n      toast({\n        title: \"æäº¤å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const steps: FeedbackStep[] = [\"intro\", \"atmosphere\", \"traits\", \"radar\", \"selectConnections\", \"improvement\", \"completion\"];\n  const currentStepIndex = steps.indexOf(currentStep);\n  const progressPercentage = (currentStepIndex / (steps.length - 1)) * 100;\n\n  const handleNext = (stepData: Partial<FeedbackData>) => {\n    const updatedData = { ...feedbackData, ...stepData };\n    setFeedbackData(updatedData);\n\n    if (currentStep === \"intro\") setCurrentStep(\"atmosphere\");\n    else if (currentStep === \"atmosphere\") setCurrentStep(\"traits\");\n    else if (currentStep === \"traits\") setCurrentStep(\"radar\");\n    else if (currentStep === \"radar\") setCurrentStep(\"selectConnections\");\n    else if (currentStep === \"selectConnections\") setCurrentStep(\"improvement\");\n    else if (currentStep === \"improvement\") {\n      // Submit feedback\n      submitMutation.mutate(updatedData);\n    }\n  };\n\n  const handleBack = () => {\n    if (currentStep === \"atmosphere\") setCurrentStep(\"intro\");\n    else if (currentStep === \"traits\") setCurrentStep(\"atmosphere\");\n    else if (currentStep === \"radar\") setCurrentStep(\"traits\");\n    else if (currentStep === \"selectConnections\") setCurrentStep(\"radar\");\n    else if (currentStep === \"improvement\") setCurrentStep(\"selectConnections\");\n    else if (currentStep === \"intro\") navigate(\"/events\");\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"text-center space-y-4\">\n          <div className=\"h-8 w-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n          <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!event) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card>\n          <CardContent className=\"p-6 text-center\">\n            <p className=\"text-muted-foreground\">æ´»åŠ¨ä¸å­˜åœ¨</p>\n            <Button onClick={() => navigate(\"/events\")} className=\"mt-4\">\n              è¿”å›æ´»åŠ¨åˆ—è¡¨\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (existingFeedback && currentStep !== \"completion\") {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card>\n          <CardContent className=\"p-6 text-center space-y-4\">\n            <div className=\"text-4xl\">âœ…</div>\n            <p className=\"font-medium\">ä½ å·²ç»å®Œæˆäº†è¿™æ¬¡æ´»åŠ¨çš„åé¦ˆ</p>\n            <Button onClick={() => navigate(\"/events\")}>\n              è¿”å›æ´»åŠ¨åˆ—è¡¨\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      {currentStep !== \"completion\" && (\n        <header className=\"sticky top-0 z-10 bg-background border-b\">\n          <div className=\"flex items-center justify-between p-4\">\n            <Button \n              variant=\"ghost\" \n              size=\"icon\"\n              onClick={handleBack}\n              data-testid=\"button-back\"\n            >\n              <ChevronLeft className=\"h-5 w-5\" />\n            </Button>\n            <div className=\"flex-1 mx-4\">\n              <Progress value={progressPercentage} className=\"h-2\" />\n              <p className=\"text-xs text-muted-foreground text-center mt-2\">\n                {currentStepIndex}/{steps.length - 2}\n              </p>\n            </div>\n            <div className=\"w-10\" /> {/* Spacer for symmetry */}\n          </div>\n        </header>\n      )}\n\n      {/* Step Content */}\n      <div className=\"p-4\">\n        {currentStep === \"intro\" && (\n          <IntroStep event={event} onNext={() => handleNext({})} />\n        )}\n        \n        {currentStep === \"atmosphere\" && (\n          <AtmosphereThermometer\n            initialScore={feedbackData.atmosphereScore}\n            initialNote={feedbackData.atmosphereNote}\n            onNext={handleNext}\n          />\n        )}\n        \n        {currentStep === \"traits\" && event?.matchedAttendees && Array.isArray(event.matchedAttendees) ? (\n          <TraitTagsWall\n            attendees={event.matchedAttendees as Array<{userId: string; displayName: string; archetype?: string}>}\n            initialTraits={feedbackData.attendeeTraits}\n            onNext={handleNext}\n          />\n        ) : null}\n        \n        {currentStep === \"radar\" && (\n          <ConnectionRadar\n            initialRadar={feedbackData.connectionRadar}\n            initialHasConnections={feedbackData.hasNewConnections}\n            initialConnectionStatus={feedbackData.connectionStatus}\n            onNext={handleNext}\n          />\n        )}\n        \n        {currentStep === \"selectConnections\" && event?.matchedAttendees && Array.isArray(event.matchedAttendees) ? (\n          <SelectConnectionsStep\n            attendees={event.matchedAttendees.map((a: any) => ({\n              userId: a.userId,\n              displayName: a.displayName,\n              archetype: a.archetype,\n              gender: a.gender,\n              age: a.age,\n              educationLevel: a.educationLevel,\n              industry: a.industry,\n              relationshipStatus: a.relationshipStatus,\n            }))}\n            initialConnections={feedbackData.connections}\n            onNext={handleNext}\n          />\n        ) : null}\n        \n        {currentStep === \"improvement\" && (\n          <ImprovementCards\n            initialAreas={feedbackData.improvementAreas}\n            initialOther={feedbackData.improvementOther}\n            onNext={handleNext}\n            isSubmitting={submitMutation.isPending}\n          />\n        )}\n        \n        {currentStep === \"completion\" && (\n          <FeedbackCompletion \n            onDone={() => navigate(\"/events\")}\n            onDeepFeedback={() => navigate(`/events/${eventId}/deep-feedback`)}\n          />\n        )}\n      </div>\n    </div>\n  );\n}\n\n// Intro Step Component\nfunction IntroStep({ event, onNext }: { event: BlindBoxEvent; onNext: () => void }) {\n  const eventDate = event.dateTime ? new Date(event.dateTime) : null;\n  const formattedDate = eventDate \n    ? new Intl.DateTimeFormat('zh-CN', { month: 'long', day: 'numeric', weekday: 'short' }).format(eventDate)\n    : '';\n  const formattedTime = eventDate \n    ? new Intl.DateTimeFormat('zh-CN', { hour: '2-digit', minute: '2-digit' }).format(eventDate)\n    : '';\n  \n  const eventTypeDisplay = event.eventType === 'é¥­å±€' ? 'ğŸ½ï¸ é¥­å±€' : 'ğŸ· é…’å±€';\n  const totalPeople = event.totalParticipants || 0;\n\n  return (\n    <Card className=\"max-w-md mx-auto\">\n      <CardContent className=\"p-6 space-y-6\">\n        {/* Header */}\n        <div className=\"text-center space-y-2\">\n          <div className=\"text-4xl mx-auto w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center\">\n            <Sparkles className=\"h-8 w-8 text-primary\" />\n          </div>\n          <h1 className=\"text-2xl font-bold\">å›é¡¾ä½ çš„æ´»åŠ¨æ—¶åˆ»</h1>\n          <p className=\"text-sm text-muted-foreground\">\n            èŠ±2åˆ†é’Ÿåˆ†äº«ä½“éªŒï¼Œå¸®åŠ©æˆ‘ä»¬åšå¾—æ›´å¥½\n          </p>\n        </div>\n\n        {/* Event Info Card */}\n        <div className=\"p-4 rounded-lg bg-muted/50 space-y-3\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"font-semibold\">{eventTypeDisplay}</span>\n          </div>\n          <div className=\"grid grid-cols-2 gap-2 text-sm text-foreground\">\n            <div>ğŸ“… {formattedDate}</div>\n            <div>ğŸ• {formattedTime}</div>\n            <div className=\"col-span-2\">ğŸ“ {event.restaurantName || `${event.city} Â· ${event.district}`}</div>\n            <div>ğŸ‘¥ {totalPeople}äººå‚åŠ </div>\n          </div>\n        </div>\n\n        {/* Benefits */}\n        <div className=\"space-y-3\">\n          <p className=\"text-sm font-medium\">å®Œæˆåé¦ˆä½ å°†è·å¾—ï¼š</p>\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center gap-3 text-sm\">\n              <span className=\"text-2xl\">ğŸ</span>\n              <span>50 ç§¯åˆ†ï¼ˆå¯ç”¨äºä¸‹æ¬¡æ´»åŠ¨ï¼‰</span>\n            </div>\n            <div className=\"flex items-center gap-3 text-sm\">\n              <span className=\"text-2xl\">â­</span>\n              <span>ã€Œä¼˜è´¨åé¦ˆè€…ã€æ ‡è¯†</span>\n            </div>\n            <div className=\"flex items-center gap-3 text-sm\">\n              <span className=\"text-2xl\">ğŸ¯</span>\n              <span>ä¸‹æœŸæ´»åŠ¨åŒ¹é…ä¼˜å…ˆæƒ</span>\n            </div>\n          </div>\n        </div>\n\n        {/* Action Button */}\n        <Button \n          onClick={onNext} \n          size=\"lg\" \n          className=\"w-full\"\n          data-testid=\"button-start-feedback\"\n        >\n          å¼€å§‹åé¦ˆ\n        </Button>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":12298},"server/phoneAuth.ts":{"content":"import type { Express, RequestHandler } from \"express\";\nimport { storage } from \"./storage\";\n\n// ç®€åŒ–çš„éªŒè¯ç å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨Redisï¼‰\nconst verificationCodes = new Map<string, { code: string; expiresAt: number }>();\n\n// ğŸ¯ DEMO MODE: ä¸‡èƒ½éªŒè¯ç ï¼Œæ–¹ä¾¿æ¼”ç¤º\nconst DEMO_CODE = \"666666\";\n\n// ç”Ÿæˆ6ä½æ•°éªŒè¯ç \nfunction generateCode(): string {\n  return Math.floor(100000 + Math.random() * 900000).toString();\n}\n\nexport function setupPhoneAuth(app: Express) {\n  // å‘é€éªŒè¯ç \n  app.post(\"/api/auth/send-code\", async (req, res) => {\n    try {\n      const { phoneNumber } = req.body;\n\n      if (!phoneNumber || !/^1\\d{10}$/.test(phoneNumber)) {\n        return res.status(400).json({ message: \"Invalid phone number\" });\n      }\n\n      const code = generateCode();\n      const expiresAt = Date.now() + 5 * 60 * 1000; // 5åˆ†é’Ÿè¿‡æœŸ\n\n      verificationCodes.set(phoneNumber, { code, expiresAt });\n\n      // åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œå°†éªŒè¯ç æ‰“å°åˆ°console\n      console.log(`ğŸ“± Verification code for ${phoneNumber}: ${code}`);\n\n      // ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨çŸ­ä¿¡æœåŠ¡å•†APIå‘é€éªŒè¯ç \n      // ä¾‹å¦‚ï¼šawait sendSMS(phoneNumber, `æ‚¨çš„éªŒè¯ç æ˜¯ï¼š${code}ï¼Œ5åˆ†é’Ÿå†…æœ‰æ•ˆ`);\n\n      res.json({ message: \"Verification code sent successfully\" });\n    } catch (error) {\n      console.error(\"Error sending verification code:\", error);\n      res.status(500).json({ message: \"Failed to send verification code\" });\n    }\n  });\n\n  // æ‰‹æœºå·ç™»å½•\n  app.post(\"/api/auth/phone-login\", async (req, res) => {\n    try {\n      const { phoneNumber, code } = req.body;\n\n      if (!phoneNumber || !code) {\n        return res.status(400).json({ message: \"Phone number and code are required\" });\n      }\n\n      // ğŸ¯ DEMO MODE: ä¸‡èƒ½éªŒè¯ç  666666 æ€»æ˜¯æœ‰æ•ˆ\n      if (code === DEMO_CODE) {\n        console.log(`âœ… Demo code ${DEMO_CODE} accepted for ${phoneNumber}`);\n      } else {\n        // éªŒè¯çœŸå®éªŒè¯ç \n        const storedData = verificationCodes.get(phoneNumber);\n        \n        if (!storedData) {\n          return res.status(400).json({ message: \"éªŒè¯ç æ— æ•ˆæˆ–å·²è¿‡æœŸ\" });\n        }\n\n        if (storedData.expiresAt < Date.now()) {\n          verificationCodes.delete(phoneNumber);\n          return res.status(400).json({ message: \"éªŒè¯ç å·²è¿‡æœŸ\" });\n        }\n\n        if (storedData.code !== code) {\n          return res.status(400).json({ message: \"éªŒè¯ç é”™è¯¯\" });\n        }\n\n        // éªŒè¯æˆåŠŸï¼Œåˆ é™¤éªŒè¯ç \n        verificationCodes.delete(phoneNumber);\n      }\n\n      // æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·\n      const users = await storage.getUserByPhone(phoneNumber);\n      let userId: string;\n\n      if (users.length > 0) {\n        // ç”¨æˆ·å·²å­˜åœ¨\n        userId = users[0].id;\n      } else {\n        // åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆæ‰‹æœºå·ä½œä¸ºä¸´æ—¶æ ‡è¯†ï¼‰\n        const newUser = await storage.createUserWithPhone({\n          phoneNumber,\n          email: `${phoneNumber}@temp.joyjoin.com`, // ä¸´æ—¶é‚®ç®±\n          firstName: \"ç”¨æˆ·\",\n          lastName: phoneNumber.slice(-4), // ä½¿ç”¨æ‰‹æœºå·å4ä½\n        });\n        userId = newUser.id;\n        \n        // ğŸ¯ DEMO MODE: ä¸ºæ–°ç”¨æˆ·åˆ›å»ºæ¼”ç¤ºæ•°æ®\n        // å¦‚æœä½¿ç”¨çš„æ˜¯æ¼”ç¤ºéªŒè¯ç 666666ï¼Œåªåˆ›å»ºåŸºç¡€è´¦å·è®©ç”¨æˆ·æµ‹è¯•æ³¨å†Œæµç¨‹\n        // å¦åˆ™åˆ›å»ºå®Œæ•´æ¼”ç¤ºæ•°æ®\n        const isUsingDemoCode = code === DEMO_CODE;\n        if (!isUsingDemoCode) {\n          await createDemoDataForUser(userId);\n        }\n      }\n\n      // è®¾ç½®session\n      req.session.regenerate(async (err) => {\n        if (err) {\n          console.error(\"Session regeneration error:\", err);\n          return res.status(500).json({ message: \"Login failed\" });\n        }\n\n        req.session.userId = userId;\n        req.session.save(async (err) => {\n          if (err) {\n            console.error(\"Session save error:\", err);\n            return res.status(500).json({ message: \"Login failed\" });\n          }\n\n          // è·å–å®Œæ•´çš„ç”¨æˆ·æ•°æ®å¹¶è¿”å›ï¼ˆåŒ…æ‹¬isAdminå­—æ®µï¼‰\n          const user = await storage.getUserById(userId);\n          \n          res.json({ \n            message: \"Login successful\",\n            userId,\n            ...user\n          });\n        });\n      });\n    } catch (error) {\n      console.error(\"Error during phone login:\", error);\n      res.status(500).json({ message: \"Login failed\" });\n    }\n  });\n\n  // ç™»å‡º\n  app.post(\"/api/auth/logout\", (req, res) => {\n    req.session.destroy((err) => {\n      if (err) {\n        return res.status(500).json({ message: \"Logout failed\" });\n      }\n      res.json({ message: \"Logout successful\" });\n    });\n  });\n}\n\n// è®¤è¯ä¸­é—´ä»¶\nexport const isPhoneAuthenticated: RequestHandler = async (req, res, next) => {\n  if (req.session && req.session.userId) {\n    return next();\n  }\n  res.status(401).json({ message: \"Unauthorized\" });\n};\n\n// ğŸ¯ DEMO MODE: ä¸ºæ–°ç”¨æˆ·åˆ›å»ºå®Œæ•´çš„æ¼”ç¤ºæ•°æ®\nasync function createDemoDataForUser(userId: string) {\n  try {\n    const { db } = await import(\"./db\");\n    const { users, roleResults, blindBoxEvents } = await import(\"@shared/schema\");\n    const { eq } = await import(\"drizzle-orm\");\n    \n    console.log(`ğŸ¯ Creating demo data for user: ${userId}`);\n    \n    // 1. è®¾ç½®ç”¨æˆ·ä¸ºå·²å®Œæˆæ‰€æœ‰ onboarding æ­¥éª¤ï¼Œå¹¶æ·»åŠ èƒŒæ™¯ä¿¡æ¯\n    await db.update(users)\n      .set({\n        hasCompletedRegistration: true,\n        hasCompletedInterestsTopics: true,\n        hasCompletedPersonalityTest: true,\n        hasCompletedProfileSetup: true,\n        hasCompletedVoiceQuiz: true,\n        // æ·»åŠ èƒŒæ™¯ä¿¡æ¯ä»¥è§¦å‘Epicå¥‘åˆç‚¹\n        educationLevel: 'Master\\'s',\n        studyLocale: 'Overseas',\n        fieldOfStudy: 'CS',\n        seniority: 'Founder',\n        industry: 'ç§‘æŠ€',\n        interestsTop: ['æ‘„å½±', 'å†™ä½œ', 'åˆ›ä¸š', 'å¯æŒç»­å‘å±•', 'å’–å•¡'],\n        languagesComfort: ['æ™®é€šè¯', 'è‹±è¯­', 'ç²¤è¯­'],\n      })\n      .where(eq(users.id, userId));\n    \n    // 2. åˆ›å»ºæ¼”ç¤ºæ€§æ ¼æµ‹è¯•ç»“æœ\n    await db.insert(roleResults).values({\n      userId,\n      primaryRole: 'è¿æ¥è€…',\n      primaryRoleScore: 18,\n      secondaryRole: 'æ¢ç´¢è€…',\n      secondaryRoleScore: 15,\n      roleSubtype: 'balanced',\n      roleScores: {\n        'è¿æ¥è€…': 18,\n        'æ¢ç´¢è€…': 15,\n        'ç«èŠ±å¡': 12,\n        'æ°›å›´ç»„': 10,\n        'æ•…äº‹å®¶': 9,\n        'ç¤¾äº¤è¾¾äºº': 8,\n        'åˆ›æ„å®¶': 6,\n        'å®ˆæŠ¤è€…': 4\n      },\n      affinityScore: 8,\n      opennessScore: 9,\n      conscientiousnessScore: 7,\n      emotionalStabilityScore: 8,\n      extraversionScore: 7,\n      positivityScore: 9,\n      strengths: 'ä½ å¤©ç”Ÿå–„äºè¿æ¥ä¸åŒèƒŒæ™¯çš„äººï¼Œæ€»èƒ½æ‰¾åˆ°å¤§å®¶çš„å…±åŒè¯é¢˜ã€‚ä½ çš„äº²å’ŒåŠ›è®©äººæ„Ÿåˆ°èˆ’é€‚ï¼Œæ„¿æ„å‘ä½ æ•å¼€å¿ƒæ‰‰ã€‚',\n      challenges: 'æœ‰æ—¶å¯èƒ½å› ä¸ºå¤ªåœ¨æ„ä»–äººæ„Ÿå—è€Œå¿½ç•¥è‡ªå·±çš„éœ€æ±‚ï¼Œéœ€è¦å­¦ä¼šé€‚å½“è¡¨è¾¾è‡ªå·±çš„è§‚ç‚¹ã€‚',\n      idealFriendTypes: ['æ¢ç´¢è€…', 'æ•…äº‹å®¶', 'åˆ›æ„å®¶'],\n      testVersion: 1,\n    });\n    \n    // 3. æ›´æ–°ç”¨æˆ·çš„ archetype å­—æ®µ\n    await db.update(users)\n      .set({\n        primaryRole: 'è¿æ¥è€…',\n        secondaryRole: 'æ¢ç´¢è€…',\n        archetype: 'è¿æ¥è€…',\n      })\n      .where(eq(users.id, userId));\n    \n    // 4. åˆ›å»ºå·²åŒ¹é…æ´»åŠ¨ï¼ˆæ˜å¤©æ™šä¸Šçš„æ—¥æ–™èšé¤ï¼‰\n    const tomorrow = new Date();\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    tomorrow.setHours(19, 0, 0, 0);\n    \n    await db.insert(blindBoxEvents).values({\n      userId,\n      title: 'å‘¨å›› 19:00 Â· é¥­å±€',\n      eventType: 'é¥­å±€',\n      city: 'é¦™æ¸¯',\n      district: 'ä¸­ç¯',\n      dateTime: tomorrow,\n      budgetTier: '150-250',\n      selectedLanguages: ['ç²¤è¯­', 'æ™®é€šè¯'],\n      selectedCuisines: ['æ—¥æœ¬æ–™ç†', 'ç²¤èœ'],\n      acceptNearby: true,\n      status: 'matched',\n      progress: 100,\n      currentParticipants: 5,\n      totalParticipants: 5,\n      maleCount: 2,\n      femaleCount: 3,\n      restaurantName: 'é®¨ä¸€ Sushi Ichi',\n      restaurantAddress: 'ä¸­ç¯äº‘å’¸è¡—28å·',\n      cuisineTags: ['æ—¥æœ¬æ–™ç†', 'å¯¿å¸'],\n      matchedAttendees: [\n        { \n          userId: 'demo-epic-1', \n          displayName: 'Sophia', \n          archetype: 'æ¢ç´¢è€…', \n          topInterests: ['æ‘„å½±', 'éŸ³ä¹åˆ›ä½œ', 'å¯æŒç»­å‘å±•'], \n          age: 30,\n          birthdate: '1995-03-15',\n          gender: 'Woman',\n          hometownRegionCity: 'ä¸Šæµ·',\n          industry: 'è®¾è®¡',\n          educationLevel: 'Master\\'s',\n          studyLocale: 'Overseas',\n          fieldOfStudy: 'è‰ºæœ¯è®¾è®¡',\n          seniority: 'Senior',\n          relationshipStatus: 'Single',\n          languagesComfort: ['æ™®é€šè¯', 'è‹±è¯­', 'æ—¥è¯­'],\n          ageVisible: true,\n          educationVisible: true,\n          industryVisible: true\n        },\n        { \n          userId: 'demo-epic-2', \n          displayName: 'Max', \n          archetype: 'ç«èŠ±å¡', \n          topInterests: ['åˆ›ä¸š', 'å…¬ç›Š', 'å†™ä½œ'], \n          age: 32,\n          birthdate: '1993-06-20',\n          gender: 'Man',\n          hometownRegionCity: 'åŒ—äº¬',\n          industry: 'ç¤¾ä¼šåˆ›æ–°',\n          educationLevel: 'Master\\'s',\n          studyLocale: 'Both',\n          fieldOfStudy: 'å•†ä¸šç®¡ç†',\n          seniority: 'Founder',\n          relationshipStatus: 'Single',\n          languagesComfort: ['æ™®é€šè¯', 'è‹±è¯­', 'æ³•è¯­', 'è¥¿ç­ç‰™è¯­'],\n          ageVisible: true,\n          educationVisible: true,\n          industryVisible: true\n        },\n        { \n          userId: 'demo-epic-3', \n          displayName: 'è‰¾ç±³', \n          archetype: 'è¿æ¥è€…', \n          topInterests: ['ç»˜ç”»', 'æ‘„å½±', 'æ•°å­—æ¸¸æ°‘'], \n          age: 28,\n          birthdate: '1997-08-10',\n          gender: 'Woman',\n          hometownRegionCity: 'å¹¿å·',\n          industry: 'è®¾è®¡',\n          educationLevel: 'Bachelor\\'s',\n          studyLocale: 'Overseas',\n          fieldOfStudy: 'è§†è§‰è®¾è®¡',\n          seniority: 'Mid',\n          relationshipStatus: 'Single',\n          languagesComfort: ['æ™®é€šè¯', 'è‹±è¯­', 'ç²¤è¯­'],\n          ageVisible: true,\n          educationVisible: true,\n          industryVisible: true\n        },\n        { \n          userId: 'demo-epic-4', \n          displayName: 'Leo', \n          archetype: 'åˆ›æ„å®¶', \n          topInterests: ['éŸ³ä¹åˆ›ä½œ', 'å¯æŒç»­', 'å’–å•¡'], \n          age: 31,\n          birthdate: '1994-11-25',\n          gender: 'Man',\n          hometownRegionCity: 'æ·±åœ³',\n          industry: 'ç§‘æŠ€',\n          educationLevel: 'Doctorate',\n          studyLocale: 'Overseas',\n          fieldOfStudy: 'è®¡ç®—æœºç§‘å­¦',\n          seniority: 'Founder',\n          relationshipStatus: 'Married/Partnered',\n          languagesComfort: ['æ™®é€šè¯', 'è‹±è¯­', 'å¾·è¯­'],\n          ageVisible: true,\n          educationVisible: true,\n          industryVisible: true\n        }\n      ],\n      matchExplanation: 'è¿™æ¡Œæ˜¯æ—¥æ–™çˆ±å¥½è€…çš„èšä¼šï¼å¤§å®¶éƒ½å¯¹ç²¾è‡´æ–™ç†å’Œæ–‡åŒ–äº¤æµå……æ»¡çƒ­æƒ…ï¼Œå¹´é¾„ç›¸è¿‘ï¼Œè¯é¢˜å¥‘åˆåº¦é«˜ã€‚',\n    });\n    \n    // 5. åˆ›å»ºå·²å®Œæˆæ´»åŠ¨ï¼ˆä¸Šå‘¨çš„ç²¾é…¿å•¤é…’èšä¼šï¼‰\n    const lastWeek = new Date();\n    lastWeek.setDate(lastWeek.getDate() - 7);\n    lastWeek.setHours(20, 0, 0, 0);\n    \n    await db.insert(blindBoxEvents).values({\n      userId,\n      title: 'å‘¨ä¸‰ 20:00 Â· é…’å±€',\n      eventType: 'é…’å±€',\n      city: 'æ·±åœ³',\n      district: 'å—å±±åŒº',\n      dateTime: lastWeek,\n      budgetTier: '200-300',\n      selectedLanguages: ['æ™®é€šè¯', 'è‹±è¯­'],\n      selectedCuisines: ['è¥¿é¤', 'é…’å§'],\n      acceptNearby: false,\n      status: 'completed',\n      progress: 100,\n      currentParticipants: 6,\n      totalParticipants: 6,\n      maleCount: 3,\n      femaleCount: 3,\n      restaurantName: 'The Tap House ç²¾é…¿é…’å§',\n      restaurantAddress: 'å—å±±åŒºæµ·å¾·ä¸‰é“1186å·',\n      cuisineTags: ['é…’å§', 'è¥¿é¤'],\n      matchedAttendees: [\n        { \n          userId: 'demo-5', \n          displayName: 'Sarah', \n          archetype: 'æ°›å›´ç»„', \n          topInterests: ['éŸ³ä¹', 'ç¤¾äº¤', 'ç¾é£Ÿ'], \n          age: 29, \n          birthdate: '1996-04-12', \n          gender: 'Woman',\n          industry: 'åˆ›ä¸š',\n          educationLevel: 'Bachelor\\'s',\n          studyLocale: 'Overseas',\n          fieldOfStudy: 'å¸‚åœºè¥é”€',\n          seniority: 'Founder',\n          relationshipStatus: 'Single',\n          hometownRegionCity: 'æ·±åœ³',\n          languagesComfort: ['æ™®é€šè¯', 'è‹±è¯­'],\n          ageVisible: true,\n          educationVisible: true,\n          industryVisible: true\n        },\n        { \n          userId: 'demo-6', \n          displayName: 'Alex', \n          archetype: 'ç«èŠ±å¡', \n          topInterests: ['åˆ›ä¸š', 'ç§‘æŠ€', 'é˜…è¯»'], \n          age: 31, \n          birthdate: '1994-09-08', \n          gender: 'Man',\n          industry: 'äº’è”ç½‘',\n          educationLevel: 'Master\\'s',\n          studyLocale: 'Both',\n          fieldOfStudy: 'è½¯ä»¶å·¥ç¨‹',\n          seniority: 'Senior',\n          relationshipStatus: 'Single',\n          hometownRegionCity: 'æ­å·',\n          languagesComfort: ['æ™®é€šè¯', 'è‹±è¯­'],\n          ageVisible: true,\n          educationVisible: true,\n          industryVisible: true\n        },\n        { \n          userId: 'demo-7', \n          displayName: 'å°çº¢', \n          archetype: 'æ•…äº‹å®¶', \n          topInterests: ['æ—…è¡Œ', 'æ‘„å½±', 'ç¾é£Ÿ'], \n          age: 28, \n          birthdate: '1997-02-18', \n          gender: 'Woman',\n          industry: 'å¸‚åœº',\n          educationLevel: 'Bachelor\\'s',\n          studyLocale: 'Domestic',\n          fieldOfStudy: 'å¸‚åœºè¥é”€',\n          seniority: 'Mid',\n          relationshipStatus: 'Single',\n          hometownRegionCity: 'æˆéƒ½',\n          languagesComfort: ['æ™®é€šè¯'],\n          ageVisible: true,\n          educationVisible: true,\n          industryVisible: true\n        },\n        { \n          userId: 'demo-8', \n          displayName: 'Tom', \n          archetype: 'æ¢ç´¢è€…', \n          topInterests: ['éŸ³ä¹', 'ç”µå½±', 'æ—…è¡Œ'], \n          age: 30, \n          birthdate: '1995-07-22', \n          gender: 'Man',\n          industry: 'è®¾è®¡',\n          educationLevel: 'Bachelor\\'s',\n          studyLocale: 'Overseas',\n          fieldOfStudy: 'è§†è§‰è®¾è®¡',\n          seniority: 'Mid',\n          relationshipStatus: 'Married/Partnered',\n          hometownRegionCity: 'é¦™æ¸¯',\n          languagesComfort: ['è‹±è¯­', 'ç²¤è¯­'],\n          ageVisible: true,\n          educationVisible: true,\n          industryVisible: true\n        },\n        { \n          userId: 'demo-9', \n          displayName: 'Emma', \n          archetype: 'è¿æ¥è€…', \n          topInterests: ['è‰ºæœ¯', 'æ–‡åŒ–', 'å’–å•¡'], \n          age: 27, \n          birthdate: '1998-01-30', \n          gender: 'Woman',\n          industry: 'å’¨è¯¢',\n          educationLevel: 'Master\\'s',\n          studyLocale: 'Both',\n          fieldOfStudy: 'ç®¡ç†å’¨è¯¢',\n          seniority: 'Junior',\n          relationshipStatus: 'Single',\n          hometownRegionCity: 'ä¸Šæµ·',\n          languagesComfort: ['æ™®é€šè¯', 'è‹±è¯­'],\n          ageVisible: true,\n          educationVisible: true,\n          industryVisible: true\n        }\n      ],\n      matchExplanation: 'è¿™æ˜¯ä¸€åœºåˆ›æ„äººçš„æ·±å¤œèšä¼šï¼ç²¾é…¿å•¤é…’é…ä¸Šæœ‰è¶£çš„çµé­‚ï¼Œå¤§å®¶éƒ½å–œæ¬¢åˆ†äº«æ•…äº‹å’Œåˆ›æ„æƒ³æ³•ã€‚',\n    });\n    \n    console.log('âœ… Demo data created successfully for user:', userId);\n  } catch (error) {\n    console.error('âŒ Failed to create demo data:', error);\n  }\n}\n","size_bytes":15513},"client/src/pages/LoginPage.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Users, Brain, Gift, Smile } from \"lucide-react\";\nimport { SiWechat } from \"react-icons/si\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { motion } from \"framer-motion\";\n\nexport default function LoginPage() {\n  const { toast } = useToast();\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n  const [verificationCode, setVerificationCode] = useState(\"\");\n  const [codeSent, setCodeSent] = useState(false);\n  const [countdown, setCountdown] = useState(0);\n\n  const sendCodeMutation = useMutation({\n    mutationFn: async (phone: string) => {\n      return await apiRequest(\"POST\", \"/api/auth/send-code\", { phoneNumber: phone });\n    },\n    onSuccess: () => {\n      setCodeSent(true);\n      setCountdown(60);\n      const timer = setInterval(() => {\n        setCountdown((prev) => {\n          if (prev <= 1) {\n            clearInterval(timer);\n            return 0;\n          }\n          return prev - 1;\n        });\n      }, 1000);\n      \n      toast({\n        title: \"éªŒè¯ç å·²å‘é€\",\n        description: \"è¯·æŸ¥æ”¶çŸ­ä¿¡éªŒè¯ç \",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"å‘é€å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const loginMutation = useMutation({\n    mutationFn: async (data: { phoneNumber: string; code: string }) => {\n      return await apiRequest(\"POST\", \"/api/auth/phone-login\", data);\n    },\n    onSuccess: async () => {\n      // ğŸ¯ DEMO: è‡ªåŠ¨ç”Ÿæˆæ¼”ç¤ºæ´»åŠ¨æ•°æ®\n      try {\n        await apiRequest(\"POST\", \"/api/demo/seed-events\", {});\n        console.log(\"âœ… Demo events seeded\");\n      } catch (error) {\n        console.log(\"Demo events may already exist:\", error);\n      }\n      \n      toast({\n        title: \"ç™»å½•æˆåŠŸ\",\n        description: \"æ¬¢è¿å›æ¥ï¼\",\n      });\n      \n      // æ¸…é™¤ç¼“å­˜ï¼Œè§¦å‘useAuthé‡æ–°è·å–ç”¨æˆ·æ•°æ®ï¼ŒApp.tsxä¼šè‡ªåŠ¨é‡å®šå‘\n      await queryClient.invalidateQueries({ queryKey: ['/api/auth/user'] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"ç™»å½•å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSendCode = () => {\n    if (!phoneNumber || phoneNumber.length !== 11) {\n      toast({\n        title: \"æ‰‹æœºå·æ ¼å¼é”™è¯¯\",\n        description: \"è¯·è¾“å…¥11ä½æ‰‹æœºå·\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    sendCodeMutation.mutate(phoneNumber);\n  };\n\n  const handleLogin = () => {\n    if (!phoneNumber || !verificationCode) {\n      toast({\n        title: \"ä¿¡æ¯ä¸å®Œæ•´\",\n        description: \"è¯·è¾“å…¥æ‰‹æœºå·å’ŒéªŒè¯ç \",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    loginMutation.mutate({ phoneNumber, code: verificationCode });\n  };\n\n  const handleWeChatLogin = () => {\n    toast({\n      title: \"å¾®ä¿¡ç™»å½•\",\n      description: \"å¾®ä¿¡æˆæƒç™»å½•åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…\",\n    });\n  };\n\n  const features = [\n    {\n      icon: <Users className=\"h-6 w-6\" />,\n      title: \"4-6äººç²¾å“å°å±€\",\n      subtitle: \"ç¥ç§˜é¥­å±€ Â· æ·±åº¦ç¤¾äº¤\",\n      description: \"å°è€Œç¾çš„èšä¼šï¼ŒçœŸæ­£çš„æ·±åº¦äº¤æµ\",\n      color: \"from-purple-500 to-purple-600\",\n      delay: 0.1,\n    },\n    {\n      icon: <Brain className=\"h-6 w-6\" />,\n      title: \"AIæ™ºèƒ½åŒ¹é…\",\n      subtitle: \"8ç»´ç”»åƒ Â· ç²¾å‡†è¿æ¥ Â· å¿—è¶£ç›¸æŠ•\",\n      description: \"åŸºäºå…´è¶£ã€æ€§æ ¼ã€è¯é¢˜çš„æ™ºèƒ½åŒ¹é…\",\n      color: \"from-blue-500 to-blue-600\",\n      delay: 0.2,\n    },\n    {\n      icon: <Gift className=\"h-6 w-6\" />,\n      title: \"ç¥ç§˜ç›²ç›’ä½“éªŒ\",\n      subtitle: \"ç¿»å¡è§£é” Â· æƒŠå–œç›¸é‡ Â· æ¯æ¬¡éƒ½æ˜¯æ–°å†’é™©\",\n      description: \"å……æ»¡æœŸå¾…çš„ç¤¾äº¤æ¢é™©\",\n      color: \"from-pink-500 to-pink-600\",\n      delay: 0.3,\n    },\n    {\n      icon: <Smile className=\"h-6 w-6\" />,\n      title: \"åŒ…å¼€å¿ƒæœ‰è¶£\",\n      subtitle: \"è½»æ¾æ°›å›´ Â· æ„‰æ‚¦ä½“éªŒ Â· ç¬‘å£°ä¸æ–­\",\n      description: \"è®©æ¯æ¬¡èšä¼šéƒ½å……æ»¡æ¬¢ä¹\",\n      color: \"from-orange-500 to-orange-600\",\n      delay: 0.4,\n    },\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-primary/5 via-background to-background flex items-center justify-center p-4 py-8\">\n      <div className=\"w-full max-w-md space-y-8\">\n        {/* Brand Section */}\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5 }}\n          className=\"text-center space-y-4\"\n        >\n          <div className=\"flex justify-center mb-4\">\n            <div className=\"h-20 w-20 rounded-2xl bg-gradient-to-br from-primary via-primary to-primary/70 flex items-center justify-center shadow-lg\">\n              <span className=\"text-4xl\">ğŸª</span>\n            </div>\n          </div>\n          \n          <h1 className=\"text-3xl font-display font-bold bg-gradient-to-r from-primary to-primary/60 bg-clip-text text-transparent\">\n            æ‚¦èšÂ·Joy\n          </h1>\n          \n          <p className=\"text-lg font-medium text-primary px-6 leading-relaxed\">\n            æ¢ç´¢æ¸¯æ·±å¥‡é‡ï¼Œé‚‚é€…æœ‰è¶£çµé­‚\n          </p>\n        </motion.div>\n\n        {/* Highlights Section */}\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5, delay: 0.1 }}\n          className=\"space-y-4\"\n        >\n          {/* Featured Card - 4-6äººç²¾å“å°å±€ */}\n          <Card className=\"border-2 border-primary shadow-lg overflow-hidden\">\n            <CardContent className=\"p-6 bg-gradient-to-br from-primary/5 to-primary/10\">\n              <div className=\"text-center space-y-3\">\n                <Badge className=\"bg-primary text-primary-foreground px-4 py-1.5 text-sm font-semibold\">\n                  æ ¸å¿ƒç‰¹è‰²\n                </Badge>\n                <div className=\"text-2xl font-bold\">4-6äººç²¾å“å°å±€</div>\n                <p className=\"text-sm font-medium text-muted-foreground\">\n                  ç¥ç§˜é¥­å±€ Â· æ·±åº¦ç¤¾äº¤ Â· å°è€Œç¾çš„èšä¼š\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Other Features */}\n          <div className=\"space-y-3\">\n            {features.slice(1).map((feature, index) => (\n              <motion.div\n                key={feature.title}\n                initial={{ opacity: 0, x: -20 }}\n                animate={{ opacity: 1, x: 0 }}\n                transition={{ duration: 0.4, delay: feature.delay }}\n              >\n                <Card className=\"border hover-elevate transition-all\">\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-start gap-4\">\n                      <div className={`h-11 w-11 rounded-xl bg-gradient-to-br ${feature.color} flex items-center justify-center text-white flex-shrink-0`}>\n                        {feature.icon}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <h3 className=\"font-semibold text-sm mb-1\">{feature.title}</h3>\n                        <p className=\"text-xs text-muted-foreground leading-relaxed\">\n                          {feature.subtitle}\n                        </p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </motion.div>\n            ))}\n          </div>\n        </motion.div>\n\n        {/* Login Form */}\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.5, delay: 0.5 }}\n        >\n          <Card className=\"border shadow-lg\">\n            <CardContent className=\"p-6 space-y-5\">\n              {/* WeChat Login */}\n              <Button\n                size=\"lg\"\n                className=\"w-full bg-[#07C160] hover:bg-[#06AD56] text-white border-0\"\n                onClick={handleWeChatLogin}\n                data-testid=\"button-wechat-login\"\n              >\n                <SiWechat className=\"h-5 w-5 mr-2\" />\n                å¾®ä¿¡ä¸€é”®ç™»å½•\n              </Button>\n\n              {/* Divider */}\n              <div className=\"relative\">\n                <div className=\"absolute inset-0 flex items-center\">\n                  <div className=\"w-full border-t border-border\"></div>\n                </div>\n                <div className=\"relative flex justify-center text-xs\">\n                  <span className=\"bg-card px-3 text-muted-foreground\">æˆ–ä½¿ç”¨æ‰‹æœºå·ç™»å½•</span>\n                </div>\n              </div>\n\n              {/* Phone Number Login */}\n              <div className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"phone\" className=\"text-sm font-medium\">æ‰‹æœºå·</Label>\n                  <Input\n                    id=\"phone\"\n                    type=\"tel\"\n                    placeholder=\"è¯·è¾“å…¥11ä½æ‰‹æœºå·\"\n                    value={phoneNumber}\n                    onChange={(e) => setPhoneNumber(e.target.value.replace(/\\D/g, '').slice(0, 11))}\n                    maxLength={11}\n                    className=\"h-11\"\n                    data-testid=\"input-phone\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"code\" className=\"text-sm font-medium\">éªŒè¯ç </Label>\n                  <div className=\"flex gap-2\">\n                    <Input\n                      id=\"code\"\n                      type=\"text\"\n                      placeholder=\"è¯·è¾“å…¥éªŒè¯ç \"\n                      value={verificationCode}\n                      onChange={(e) => setVerificationCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n                      maxLength={6}\n                      className=\"h-11\"\n                      data-testid=\"input-code\"\n                    />\n                    <Button\n                      type=\"button\"\n                      variant=\"outline\"\n                      onClick={handleSendCode}\n                      disabled={countdown > 0 || sendCodeMutation.isPending}\n                      className=\"min-w-[100px] h-11\"\n                      data-testid=\"button-send-code\"\n                    >\n                      {countdown > 0 ? `${countdown}ç§’` : codeSent ? \"é‡æ–°å‘é€\" : \"å‘é€éªŒè¯ç \"}\n                    </Button>\n                  </div>\n                </div>\n\n                <Button\n                  size=\"lg\"\n                  className=\"w-full h-11\"\n                  onClick={handleLogin}\n                  disabled={loginMutation.isPending}\n                  data-testid=\"button-login\"\n                >\n                  {loginMutation.isPending ? \"ç™»å½•ä¸­...\" : \"ç™»å½•\"}\n                </Button>\n              </div>\n\n              {/* Terms */}\n              <p className=\"text-xs text-center text-muted-foreground leading-relaxed\">\n                ç™»å½•å³è¡¨ç¤ºåŒæ„\n                <a href=\"#\" className=\"text-primary hover:underline ml-1\">ã€Šç”¨æˆ·åè®®ã€‹</a>\n                å’Œ\n                <a href=\"#\" className=\"text-primary hover:underline\">ã€Šéšç§æ”¿ç­–ã€‹</a>\n              </p>\n            </CardContent>\n          </Card>\n        </motion.div>\n\n        {/* Footer */}\n        <motion.p\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          transition={{ duration: 0.5, delay: 0.6 }}\n          className=\"text-center text-sm text-muted-foreground\"\n        >\n          ä¸“æ³¨é¦™æ¸¯å’Œæ·±åœ³æœ¬åœ°ç¤¾äº¤\n        </motion.p>\n      </div>\n    </div>\n  );\n}\n","size_bytes":11929},"server/session.d.ts":{"content":"import \"express-session\";\n\ndeclare module \"express-session\" {\n  interface SessionData {\n    userId: string;\n  }\n}\n","size_bytes":114},"shared/utils.ts":{"content":"/**\n * Calculate age from birthdate\n * @param birthdate - ISO date string (YYYY-MM-DD) or Date object\n * @returns Age in years\n */\nexport function calculateAge(birthdate: string | Date): number {\n  const birth = typeof birthdate === 'string' ? new Date(birthdate) : birthdate;\n  const today = new Date();\n  \n  let age = today.getFullYear() - birth.getFullYear();\n  const monthDiff = today.getMonth() - birth.getMonth();\n  \n  // Adjust age if birthday hasn't occurred this year yet\n  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {\n    age--;\n  }\n  \n  return age;\n}\n\n/**\n * Format age for display\n * @param birthdate - ISO date string (YYYY-MM-DD) or Date object\n * @param visibility - Age visibility setting\n * @returns Formatted age string or null if hidden\n */\nexport function formatAge(\n  birthdate: string | Date | null | undefined,\n  visibility: string = \"hide_all\"\n): string | null {\n  if (!birthdate || visibility === \"hide_all\") {\n    return null;\n  }\n  \n  const age = calculateAge(birthdate);\n  \n  if (visibility === \"show_exact_age\") {\n    return `${age}å²`;\n  }\n  \n  return null;\n}\n","size_bytes":1125},"client/src/components/SlidingTabs.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { motion } from \"framer-motion\";\n\ninterface Tab {\n  value: string;\n  label: string;\n  count?: number;\n}\n\ninterface SlidingTabsProps {\n  tabs: Tab[];\n  activeTab: string;\n  onTabChange: (value: string) => void;\n}\n\nexport default function SlidingTabs({ tabs, activeTab, onTabChange }: SlidingTabsProps) {\n  const [sliderStyle, setSliderStyle] = useState({ width: 0, left: 0 });\n  const tabRefs = useRef<(HTMLButtonElement | null)[]>([]);\n  const containerRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const activeIndex = tabs.findIndex(tab => tab.value === activeTab);\n    const activeTabElement = tabRefs.current[activeIndex];\n    \n    if (activeTabElement && containerRef.current) {\n      const containerRect = containerRef.current.getBoundingClientRect();\n      const tabRect = activeTabElement.getBoundingClientRect();\n      \n      setSliderStyle({\n        width: tabRect.width,\n        left: tabRect.left - containerRect.left,\n      });\n    }\n  }, [activeTab, tabs]);\n\n  return (\n    <div \n      ref={containerRef}\n      className=\"relative flex bg-muted/40 rounded-xl p-1.5 mx-4 mt-4 mb-2\"\n      data-testid=\"sliding-tabs-container\"\n    >\n      {/* Animated Slider */}\n      <motion.div\n        className=\"absolute top-1.5 bottom-1.5 bg-primary rounded-lg shadow-lg\"\n        style={{\n          boxShadow: '0 4px 12px rgba(139, 92, 246, 0.3)',\n        }}\n        initial={false}\n        animate={{\n          width: sliderStyle.width,\n          left: sliderStyle.left,\n        }}\n        transition={{\n          type: \"spring\",\n          stiffness: 300,\n          damping: 30,\n        }}\n      />\n\n      {/* Tab Items */}\n      {tabs.map((tab, index) => {\n        const isActive = tab.value === activeTab;\n        \n        return (\n          <button\n            key={tab.value}\n            ref={(el) => (tabRefs.current[index] = el)}\n            onClick={() => onTabChange(tab.value)}\n            className={`\n              relative flex-1 z-10 py-3 px-2 rounded-lg text-sm font-medium\n              transition-all duration-200 ease-out\n              ${isActive \n                ? 'text-primary-foreground' \n                : 'text-muted-foreground hover:text-foreground hover:bg-muted/50'\n              }\n              active:scale-[0.98]\n            `}\n            data-testid={`tab-${tab.value}`}\n          >\n            <span className=\"flex items-center justify-center gap-1\">\n              <span className={isActive ? 'font-semibold' : 'font-medium'}>\n                {tab.label}\n              </span>\n              {tab.count !== undefined && tab.count > 0 && (\n                <motion.span\n                  className={`\n                    inline-flex items-center justify-center min-w-[20px] h-[18px] px-1.5 \n                    rounded-md text-[11px] font-semibold\n                    ${isActive \n                      ? 'bg-primary-foreground text-primary' \n                      : 'bg-muted text-muted-foreground'\n                    }\n                  `}\n                  initial={{ scale: 0.8, opacity: 0 }}\n                  animate={{ scale: 1, opacity: 1 }}\n                  transition={{ delay: 0.1 }}\n                >\n                  {tab.count}\n                </motion.span>\n              )}\n            </span>\n          </button>\n        );\n      })}\n    </div>\n  );\n}\n","size_bytes":3376},"client/src/hooks/useNotificationCounts.ts":{"content":"import { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { NotificationCounts } from \"@shared/schema\";\n\nexport function useNotificationCounts() {\n  return useQuery<NotificationCounts>({\n    queryKey: ['/api/notifications/counts'],\n    refetchInterval: 30000, // Refetch every 30 seconds\n  });\n}\n\nexport function useMarkNotificationsAsRead() {\n  return useMutation({\n    mutationFn: async (category: string) => {\n      const response = await fetch('/api/notifications/mark-read', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ category }),\n        credentials: 'include',\n      });\n      \n      if (!response.ok) {\n        throw new Error('Failed to mark notifications as read');\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/notifications/counts'] });\n    },\n  });\n}\n","size_bytes":1016},"client/src/pages/DirectChatPage.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useParams, useLocation } from \"wouter\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { ArrowLeft, Send, Sparkles, ArrowDown, CheckCheck } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { User, DirectMessage } from \"@shared/schema\";\n\ntype DirectThreadWithDetails = {\n  id: string;\n  user1Id: string;\n  user2Id: string;\n  eventId: string;\n  connectionPointTypes: string[] | null;\n  createdAt: Date;\n  otherUser: {\n    id: string;\n    displayName: string | null;\n    archetype: string | null;\n  };\n  event: {\n    title: string;\n    dateTime: Date;\n  };\n};\n\n// Archetype configuration with full descriptions\nconst archetypeConfig: Record<string, { \n  icon: string; \n  color: string;\n  bgColor: string;\n  description: string;\n}> = {\n  \"ç«èŠ±å¡\": { \n    icon: \"ğŸ™Œ\", \n    color: \"text-orange-600 dark:text-orange-400\",\n    bgColor: \"bg-orange-100 dark:bg-orange-900/20\",\n    description: \"ç‚¹ç‡ƒè¯é¢˜çš„å¼€åœºé«˜æ‰‹ï¼Œèƒ½æ‰“ç ´æ²‰é»˜ï¼Œå¸¦åŠ¨æ°”æ°›\"\n  },\n  \"æ¢ç´¢è€…\": { \n    icon: \"ğŸ§­\", \n    color: \"text-purple-600 dark:text-purple-400\",\n    bgColor: \"bg-purple-100 dark:bg-purple-900/20\",\n    description: \"å¥½å¥‡å¿ƒé©±åŠ¨ï¼Œå–œæ¬¢å‘ç°æ–°äº‹ç‰©å’Œæ·±å…¥è®¨è®º\"\n  },\n  \"æ•…äº‹å®¶\": { \n    icon: \"ğŸ“–\", \n    color: \"text-green-600 dark:text-green-400\",\n    bgColor: \"bg-green-100 dark:bg-green-900/20\",\n    description: \"å–„äºåˆ†äº«ç»å†ï¼Œç”¨æ•…äº‹è¿æ¥äººå¿ƒ\"\n  },\n  \"æŒ‘æˆ˜è€…\": { \n    icon: \"âš¡\", \n    color: \"text-red-600 dark:text-red-400\",\n    bgColor: \"bg-red-100 dark:bg-red-900/20\",\n    description: \"æ€ç»´æ•é”ï¼Œå–œæ¬¢è¾©è®ºå’ŒæŒ‘æˆ˜ä¼ ç»Ÿè§‚ç‚¹\"\n  },\n  \"è¿æ¥è€…\": { \n    icon: \"ğŸ¤\", \n    color: \"text-cyan-600 dark:text-cyan-400\",\n    bgColor: \"bg-cyan-100 dark:bg-cyan-900/20\",\n    description: \"å¤©ç”Ÿçš„ç¤¾äº¤æ¡¥æ¢ï¼Œå¸®åŠ©ä»–äººå»ºç«‹è”ç³»\"\n  },\n  \"åè°ƒè€…\": { \n    icon: \"ğŸ¯\", \n    color: \"text-indigo-600 dark:text-indigo-400\",\n    bgColor: \"bg-indigo-100 dark:bg-indigo-900/20\",\n    description: \"å¹³è¡¡å„æ–¹æ„è§ï¼Œç¡®ä¿æ¯ä¸ªäººéƒ½è¢«å¬åˆ°\"\n  },\n  \"æ°›å›´ç»„\": { \n    icon: \"ğŸ­\", \n    color: \"text-pink-600 dark:text-pink-400\",\n    bgColor: \"bg-pink-100 dark:bg-pink-900/20\",\n    description: \"æ´»è·ƒæ°”æ°›ï¼Œç”¨å¹½é»˜å’Œæ´»åŠ›æ„ŸæŸ“ä»–äºº\"\n  },\n  \"è‚¯å®šè€…\": { \n    icon: \"ğŸŒŸ\", \n    color: \"text-yellow-600 dark:text-yellow-400\",\n    bgColor: \"bg-yellow-100 dark:bg-yellow-900/20\",\n    description: \"ç»™äºˆé¼“åŠ±å’Œæ”¯æŒï¼Œè®©ä»–äººæ„Ÿåˆ°è¢«è®¤å¯\"\n  },\n};\n\n// Helper function to group messages by date\nfunction groupMessagesByDate(messages: Array<DirectMessage & { user: User }>) {\n  const groups: Array<{ date: string; label: string; messages: Array<DirectMessage & { user: User }> }> = [];\n  \n  messages.forEach(msg => {\n    const msgDate = new Date(msg.createdAt!);\n    const today = new Date();\n    const yesterday = new Date(today);\n    yesterday.setDate(yesterday.getDate() - 1);\n    \n    let label: string;\n    const dateKey = msgDate.toDateString();\n    \n    if (msgDate.toDateString() === today.toDateString()) {\n      label = \"ä»Šå¤©\";\n    } else if (msgDate.toDateString() === yesterday.toDateString()) {\n      label = \"æ˜¨å¤©\";\n    } else {\n      label = msgDate.toLocaleDateString(\"zh-CN\", { month: \"long\", day: \"numeric\" });\n    }\n    \n    const existingGroup = groups.find(g => g.date === dateKey);\n    if (existingGroup) {\n      existingGroup.messages.push(msg);\n    } else {\n      groups.push({ date: dateKey, label, messages: [msg] });\n    }\n  });\n  \n  return groups;\n}\n\nexport default function DirectChatPage() {\n  const { threadId } = useParams();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const [message, setMessage] = useState(\"\");\n  const [showScrollButton, setShowScrollButton] = useState(false);\n  const [isTyping, setIsTyping] = useState(false);\n  \n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const messagesContainerRef = useRef<HTMLDivElement>(null);\n\n  // Fetch all threads and find the current one\n  const { data: allThreads } = useQuery<Array<DirectThreadWithDetails>>({\n    queryKey: [\"/api/direct-messages\"],\n  });\n\n  const thread = allThreads?.find(t => t.id === threadId);\n  const threadLoading = !allThreads;\n\n  // Fetch messages for this thread\n  const { data: messages, isLoading: messagesLoading } = useQuery<Array<DirectMessage & { user: User }>>({\n    queryKey: [\"/api/direct-messages\", threadId],\n    select: (data: any) => {\n      // The API returns messages directly, map sender to user for compatibility\n      return data.map((msg: any) => ({ ...msg, user: msg.sender }));\n    },\n    refetchInterval: 3000,\n    enabled: !!threadId,\n  });\n\n  const { data: currentUser } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n  });\n\n  const sendMessageMutation = useMutation({\n    mutationFn: async (msg: string) => {\n      return await apiRequest(\"POST\", `/api/direct-messages/${threadId}`, { message: msg });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/direct-messages\", threadId, \"messages\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/direct-messages\"] });\n      setMessage(\"\");\n    },\n    onError: (error) => {\n      toast({\n        title: \"å‘é€å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Auto-scroll to bottom with animation\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  // Handle scroll button visibility\n  useEffect(() => {\n    const container = messagesContainerRef.current;\n    if (!container) return;\n\n    const handleScroll = () => {\n      const { scrollTop, scrollHeight, clientHeight } = container;\n      const isNearBottom = scrollHeight - scrollTop - clientHeight < 100;\n      setShowScrollButton(!isNearBottom);\n    };\n\n    container.addEventListener(\"scroll\", handleScroll);\n    return () => container.removeEventListener(\"scroll\", handleScroll);\n  }, []);\n\n  // Simulate typing indicator\n  useEffect(() => {\n    let timeout: NodeJS.Timeout;\n    if (message.length > 0) {\n      setIsTyping(true);\n      timeout = setTimeout(() => setIsTyping(false), 1000);\n    } else {\n      setIsTyping(false);\n    }\n    return () => clearTimeout(timeout);\n  }, [message]);\n\n  const handleSendMessage = () => {\n    if (message.trim()) {\n      sendMessageMutation.mutate(message.trim());\n    }\n  };\n\n  const handleKeyPress = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSendMessage();\n    }\n  };\n\n  const scrollToBottom = () => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  };\n\n  const getConnectionPointLabel = (type: string) => {\n    const labels: Record<string, string> = {\n      interests: \"å…±åŒå…´è¶£\",\n      topics_happy: \"è¯é¢˜å¥‘åˆ\",\n      archetype: \"æ€§æ ¼äº’è¡¥\",\n      debate_comfort: \"äº¤æµé£æ ¼\",\n      life_stage: \"äººç”Ÿé˜¶æ®µ\",\n      languages: \"è¯­è¨€ç›¸é€š\",\n      communication_style: \"æ²Ÿé€šæ–¹å¼\",\n      gender: \"æ€§åˆ«ç›¸åŒ\",\n      family_status: \"å®¶åº­çŠ¶å†µ\",\n      overseas_region: \"æµ·å¤–èƒŒæ™¯\",\n      hometown: \"è€ä¹¡\",\n    };\n    return labels[type] || type;\n  };\n\n  if (threadLoading || !thread) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"text-center space-y-4\">\n          <div className=\"h-8 w-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n          <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n        </div>\n      </div>\n    );\n  }\n\n  const otherUserArchetype = thread.otherUser.archetype && archetypeConfig[thread.otherUser.archetype]\n    ? archetypeConfig[thread.otherUser.archetype]\n    : { icon: \"âœ¨\", color: \"text-muted-foreground\", bgColor: \"bg-muted\", description: \"ç‹¬ç‰¹ä¸ªæ€§\" };\n\n  const messageGroups = groupMessagesByDate(messages || []);\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col\">\n      {/* Header */}\n      <div className=\"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b\">\n        <div className=\"flex items-center gap-3 px-4 py-3\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={() => setLocation(\"/chats\")}\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          \n          <TooltipProvider>\n            <div className=\"flex items-center gap-3 flex-1\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Avatar className=\"h-10 w-10 cursor-pointer ring-2 ring-transparent hover:ring-primary/20 transition-all\">\n                    <AvatarFallback className={`${otherUserArchetype.bgColor} text-2xl`}>\n                      {otherUserArchetype.icon}\n                    </AvatarFallback>\n                  </Avatar>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\" className=\"max-w-xs\">\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-2xl\">{otherUserArchetype.icon}</span>\n                      <div>\n                        <p className=\"font-semibold\">{thread.otherUser.archetype}</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {thread.otherUser.displayName}\n                        </p>\n                      </div>\n                    </div>\n                    <p className=\"text-sm\">{otherUserArchetype.description}</p>\n                  </div>\n                </TooltipContent>\n              </Tooltip>\n              \n              <div className=\"flex-1 min-w-0\">\n                <h1 className=\"font-semibold truncate\">\n                  {thread.otherUser.displayName || \"ç”¨æˆ·\"}\n                </h1>\n                {thread.otherUser.archetype && (\n                  <Badge \n                    variant=\"secondary\" \n                    className={`text-[10px] h-5 ${otherUserArchetype.color} animate-pulse-glow`}\n                  >\n                    {thread.otherUser.archetype}\n                  </Badge>\n                )}\n              </div>\n            </div>\n          </TooltipProvider>\n        </div>\n\n        {/* Connection Points Banner */}\n        {thread.connectionPointTypes && thread.connectionPointTypes.length > 0 && (\n          <div className=\"px-4 pb-3\">\n            <Card className=\"bg-primary/5 border-primary/20 hover-elevate\">\n              <CardContent className=\"p-3\">\n                <div className=\"flex items-start gap-2\">\n                  <Sparkles className=\"h-4 w-4 text-primary flex-shrink-0 mt-0.5\" />\n                  <div className=\"flex-1\">\n                    <p className=\"text-xs font-medium text-primary mb-1\">\n                      ä½ ä»¬çš„å¥‘åˆç‚¹\n                    </p>\n                    <div className=\"flex flex-wrap gap-1.5\">\n                      {thread.connectionPointTypes.map((type, index) => (\n                        <Badge \n                          key={index}\n                          variant=\"secondary\" \n                          className=\"text-[10px] h-5 bg-primary/10 text-primary border-primary/20\"\n                        >\n                          {getConnectionPointLabel(type)}\n                        </Badge>\n                      ))}\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        )}\n\n        {/* Event Context */}\n        {thread.event && (\n          <div className=\"px-4 pb-3\">\n            <p className=\"text-xs text-muted-foreground\">\n              æ¥è‡ªæ´»åŠ¨ï¼š{thread.event.title}\n            </p>\n          </div>\n        )}\n      </div>\n\n      {/* Messages */}\n      <div \n        ref={messagesContainerRef}\n        className=\"flex-1 overflow-y-auto px-4 py-4 space-y-6 relative\"\n      >\n        {messagesLoading ? (\n          <div className=\"flex items-center justify-center py-8\">\n            <div className=\"text-center space-y-2\">\n              <div className=\"h-6 w-6 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n              <p className=\"text-xs text-muted-foreground\">åŠ è½½æ¶ˆæ¯ä¸­...</p>\n            </div>\n          </div>\n        ) : messages && messages.length > 0 ? (\n          <TooltipProvider>\n            {messageGroups.map((group) => (\n              <div key={group.date} className=\"space-y-4\">\n                {/* Date divider */}\n                <div className=\"flex items-center gap-3 py-2\">\n                  <div className=\"flex-1 h-px bg-border\" />\n                  <span className=\"text-xs text-muted-foreground font-medium px-3 py-1 bg-muted rounded-full\">\n                    {group.label}\n                  </span>\n                  <div className=\"flex-1 h-px bg-border\" />\n                </div>\n\n                {/* Messages */}\n                {group.messages.map((msg, idx) => {\n                  const isOwnMessage = msg.senderId === currentUser?.id;\n                  const userArchetype = msg.user.archetype && archetypeConfig[msg.user.archetype]\n                    ? archetypeConfig[msg.user.archetype]\n                    : { icon: \"âœ¨\", color: \"text-muted-foreground\", bgColor: \"bg-muted\", description: \"ç‹¬ç‰¹ä¸ªæ€§\" };\n\n                  return (\n                    <div\n                      key={msg.id}\n                      className={`flex gap-3 animate-in fade-in slide-in-from-bottom-2 duration-300 ${\n                        isOwnMessage ? \"flex-row-reverse\" : \"\"\n                      }`}\n                      style={{ animationDelay: `${idx * 50}ms` }}\n                      data-testid={`message-${msg.id}`}\n                    >\n                      {/* Avatar (only for other user) */}\n                      {!isOwnMessage && (\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <Avatar className=\"h-10 w-10 flex-shrink-0 cursor-pointer ring-2 ring-transparent hover:ring-primary/20 transition-all\">\n                              <AvatarFallback className={`${userArchetype.bgColor} text-2xl`}>\n                                {userArchetype.icon}\n                              </AvatarFallback>\n                            </Avatar>\n                          </TooltipTrigger>\n                          <TooltipContent side=\"right\" className=\"max-w-xs\">\n                            <div className=\"space-y-2\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className=\"text-2xl\">{userArchetype.icon}</span>\n                                <div>\n                                  <p className=\"font-semibold\">{msg.user.archetype}</p>\n                                  <p className=\"text-xs text-muted-foreground\">\n                                    {msg.user.displayName || \"ç”¨æˆ·\"}\n                                  </p>\n                                </div>\n                              </div>\n                              <p className=\"text-sm\">{userArchetype.description}</p>\n                            </div>\n                          </TooltipContent>\n                        </Tooltip>\n                      )}\n\n                      {/* Message bubble */}\n                      <div className={`flex-1 min-w-0 max-w-[75%] ${isOwnMessage ? \"flex flex-col items-end\" : \"\"}`}>\n                        {/* Message content */}\n                        <div \n                          className={`\n                            group relative px-4 py-2.5 rounded-[18px] shadow-sm\n                            transition-all duration-200 hover:shadow-md hover:scale-[1.02]\n                            ${isOwnMessage \n                              ? \"bg-primary text-primary-foreground rounded-br-[4px]\" \n                              : \"bg-muted text-foreground rounded-bl-[4px]\"\n                            }\n                          `}\n                        >\n                          {isOwnMessage && (\n                            <div className=\"text-xs opacity-90 mb-1\">æˆ‘</div>\n                          )}\n                          <p className=\"text-sm break-words leading-relaxed\">{msg.message}</p>\n                          \n                          {/* Time */}\n                          <div className={`text-[10px] mt-1 flex items-center gap-1 ${\n                            isOwnMessage ? \"text-primary-foreground/70\" : \"text-muted-foreground\"\n                          }`}>\n                            <span>\n                              {msg.createdAt && new Date(msg.createdAt).toLocaleTimeString('zh-CN', { \n                                hour: '2-digit', \n                                minute: '2-digit' \n                              })}\n                            </span>\n                            {isOwnMessage && (\n                              <CheckCheck className=\"h-3 w-3\" />\n                            )}\n                          </div>\n                        </div>\n\n                        {/* Message status (only for own messages) */}\n                        {isOwnMessage && (\n                          <div className=\"text-xs text-muted-foreground px-1 mt-0.5\">\n                            å·²é€è¾¾\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n            ))}\n\n            {/* Typing indicator */}\n            {isTyping && (\n              <div className=\"flex gap-3 animate-in fade-in slide-in-from-bottom-2\">\n                <div className=\"h-10 w-10\" />\n                <div className=\"bg-muted px-4 py-3 rounded-[18px] rounded-bl-[4px]\">\n                  <div className=\"flex gap-1\">\n                    <div className=\"h-2 w-2 bg-muted-foreground/40 rounded-full animate-bounce\" style={{ animationDelay: \"0ms\" }} />\n                    <div className=\"h-2 w-2 bg-muted-foreground/40 rounded-full animate-bounce\" style={{ animationDelay: \"150ms\" }} />\n                    <div className=\"h-2 w-2 bg-muted-foreground/40 rounded-full animate-bounce\" style={{ animationDelay: \"300ms\" }} />\n                  </div>\n                </div>\n              </div>\n            )}\n          </TooltipProvider>\n        ) : (\n          <div className=\"text-center py-8\">\n            <p className=\"text-sm text-muted-foreground\">\n              è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œå¼€å§‹èŠå¤©å§ï¼\n            </p>\n          </div>\n        )}\n        <div ref={messagesEndRef} />\n      </div>\n\n      {/* Scroll to bottom button */}\n      {showScrollButton && (\n        <Button\n          size=\"icon\"\n          variant=\"secondary\"\n          className=\"absolute bottom-20 right-6 z-10 rounded-full shadow-lg animate-in fade-in slide-in-from-bottom-4\"\n          onClick={scrollToBottom}\n          data-testid=\"button-scroll-to-bottom\"\n        >\n          <ArrowDown className=\"h-4 w-4\" />\n        </Button>\n      )}\n\n      {/* Message Input */}\n      <div className=\"sticky bottom-0 bg-background border-t p-4\">\n        <div className=\"flex gap-2\">\n          <Input\n            value={message}\n            onChange={(e) => setMessage(e.target.value)}\n            onKeyPress={handleKeyPress}\n            placeholder=\"è¾“å…¥æ¶ˆæ¯...\"\n            className=\"flex-1\"\n            disabled={sendMessageMutation.isPending}\n            data-testid=\"input-message\"\n          />\n          <Button\n            onClick={handleSendMessage}\n            disabled={!message.trim() || sendMessageMutation.isPending}\n            size=\"icon\"\n            data-testid=\"button-send\"\n          >\n            <Send className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </div>\n\n      {/* Custom CSS for animations */}\n      <style>{`\n        @keyframes pulse-glow {\n          0%, 100% {\n            box-shadow: 0 0 0 0 currentColor;\n          }\n          50% {\n            box-shadow: 0 0 8px 2px currentColor;\n          }\n        }\n        \n        .animate-pulse-glow {\n          animation: pulse-glow 3s ease-in-out infinite;\n        }\n      `}</style>\n    </div>\n  );\n}\n","size_bytes":20731},"client/src/components/feedback/SelectConnectionsStep.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Check } from \"lucide-react\";\nimport { motion } from \"framer-motion\";\nimport { archetypeConfig } from \"@/lib/archetypes\";\nimport { \n  getGenderDisplay, \n  formatAge, \n  getEducationDisplay\n} from \"@/lib/userFieldMappings\";\n\ninterface Attendee {\n  userId: string;\n  displayName: string;\n  archetype?: string;\n  gender?: string;\n  age?: number;\n  educationLevel?: string;\n  industry?: string;\n  relationshipStatus?: string;\n}\n\ninterface SelectConnectionsStepProps {\n  attendees: Attendee[];\n  initialConnections?: string[];\n  onNext: (data: { connections: string[] }) => void;\n}\n\n\nexport default function SelectConnectionsStep({\n  attendees,\n  initialConnections = [],\n  onNext,\n}: SelectConnectionsStepProps) {\n  const [selectedConnections, setSelectedConnections] = useState<string[]>(initialConnections);\n\n  const toggleSelection = (userId: string) => {\n    setSelectedConnections(prev => {\n      if (prev.includes(userId)) {\n        return prev.filter(id => id !== userId);\n      } else {\n        return [...prev, userId];\n      }\n    });\n  };\n\n  const handleSubmit = () => {\n    onNext({ connections: selectedConnections });\n  };\n\n  const selectionCount = selectedConnections.length;\n\n  return (\n    <div className=\"max-w-md mx-auto space-y-6\">\n      <Card>\n        <CardContent className=\"p-6 space-y-6\">\n          {/* Header */}\n          <div className=\"text-center space-y-2\">\n            <div className=\"text-4xl\">ğŸ’«</div>\n            <h2 className=\"text-xl font-bold\">é€‰æ‹©æƒ³ç»§ç»­è”ç³»çš„äºº</h2>\n            <p className=\"text-sm text-muted-foreground\">\n              åªæœ‰åŒæ–¹äº’é€‰æ‰ä¼šè§£é”1å¯¹1ç§èŠï¼Œä¿æŠ¤ä½ çš„éšç§\n            </p>\n          </div>\n\n          {/* Info Banner */}\n          <div className=\"bg-primary/5 border border-primary/20 rounded-lg p-4\">\n            <div className=\"flex items-start gap-3\">\n              <div className=\"text-2xl\">ğŸ”’</div>\n              <div className=\"flex-1 text-sm\">\n                <p className=\"font-medium text-primary mb-1\">éšç§ä¿æŠ¤æœºåˆ¶</p>\n                <p className=\"text-muted-foreground leading-relaxed\">\n                  å¯¹æ–¹ä¸ä¼šçŸ¥é“ä½ é€‰äº†Taï¼Œé™¤éTaä¹Ÿé€‰äº†ä½ ã€‚åªæœ‰åŒå‘åŒ¹é…æ‰è§£é”ç§èŠï¼Œé¿å…å°´å°¬å’Œéªšæ‰°ã€‚\n                </p>\n              </div>\n            </div>\n          </div>\n\n          {/* Attendee Selection */}\n          <div className=\"space-y-3\">\n            {attendees.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <p className=\"text-sm\">æ²¡æœ‰å…¶ä»–å‚ä¸è€…</p>\n              </div>\n            ) : (\n              attendees.map((attendee) => {\n                const isSelected = selectedConnections.includes(attendee.userId);\n                const archetypeData = attendee.archetype && archetypeConfig[attendee.archetype]\n                  ? archetypeConfig[attendee.archetype]\n                  : { icon: \"âœ¨\", bgColor: \"bg-muted\" };\n\n                // Build info chips\n                const infoChips: string[] = [];\n                if (attendee.gender && attendee.age) {\n                  infoChips.push(`${getGenderDisplay(attendee.gender)} Â· ${formatAge(attendee.age)}`);\n                } else if (attendee.gender) {\n                  infoChips.push(getGenderDisplay(attendee.gender));\n                } else if (attendee.age) {\n                  infoChips.push(formatAge(attendee.age));\n                }\n                \n                if (attendee.educationLevel) {\n                  infoChips.push(getEducationDisplay(attendee.educationLevel));\n                }\n                \n                if (attendee.industry) {\n                  infoChips.push(attendee.industry);\n                }\n\n                return (\n                  <motion.button\n                    key={attendee.userId}\n                    onClick={() => toggleSelection(attendee.userId)}\n                    className={`w-full border-2 rounded-lg p-4 transition-all hover-elevate active-elevate-2 ${\n                      isSelected \n                        ? \"border-primary bg-primary/5\" \n                        : \"border-border\"\n                    }`}\n                    whileTap={{ scale: 0.98 }}\n                    data-testid={`select-connection-${attendee.userId}`}\n                  >\n                    <div className=\"flex items-center gap-4\">\n                      {/* Avatar with Archetype Icon */}\n                      <div className=\"relative flex-shrink-0\">\n                        <div className={`h-14 w-14 rounded-full ${archetypeData.bgColor} flex items-center justify-center text-2xl`}>\n                          {archetypeData.icon}\n                        </div>\n                        {isSelected && (\n                          <motion.div\n                            initial={{ scale: 0 }}\n                            animate={{ scale: 1 }}\n                            className=\"absolute -top-1 -right-1 h-5 w-5 bg-primary rounded-full flex items-center justify-center\"\n                          >\n                            <Check className=\"h-3 w-3 text-white\" />\n                          </motion.div>\n                        )}\n                      </div>\n\n                      {/* User Info */}\n                      <div className=\"flex-1 text-left min-w-0\">\n                        <div className=\"font-medium truncate\">\n                          {attendee.displayName || \"å‚ä¸è€…\"}\n                        </div>\n                        \n                        {attendee.archetype && (\n                          <div className=\"mt-0.5\">\n                            <Badge variant=\"secondary\" className=\"text-xs\">\n                              {attendee.archetype}\n                            </Badge>\n                          </div>\n                        )}\n                        \n                        {infoChips.length > 0 && (\n                          <div className=\"flex flex-wrap gap-1.5 mt-2\">\n                            {infoChips.map((chip, idx) => (\n                              <span \n                                key={idx} \n                                className=\"text-xs text-muted-foreground bg-muted/50 px-2 py-0.5 rounded\"\n                              >\n                                {chip}\n                              </span>\n                            ))}\n                          </div>\n                        )}\n                      </div>\n\n                      {/* Selection Indicator */}\n                      <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0 ${\n                        isSelected \n                          ? \"border-primary bg-primary\" \n                          : \"border-muted-foreground/30\"\n                      }`}>\n                        {isSelected && <Check className=\"h-4 w-4 text-white\" />}\n                      </div>\n                    </div>\n                  </motion.button>\n                );\n              })\n            )}\n          </div>\n\n          {/* Selection Counter */}\n          {selectionCount > 0 && (\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"text-center\"\n            >\n              <Badge variant=\"secondary\" className=\"text-sm px-4 py-1.5\">\n                å·²é€‰æ‹© {selectionCount} ä½å‚ä¸è€…\n              </Badge>\n            </motion.div>\n          )}\n\n          {/* Helpful Tip */}\n          <div className=\"bg-muted/30 rounded-lg p-3\">\n            <p className=\"text-xs text-muted-foreground text-center leading-relaxed\">\n              ğŸ’¡ å°è´´å£«ï¼šå¯ä»¥é€‰æ‹©å¤šä½å‚ä¸è€…ï¼Œä¹Ÿå¯ä»¥ä¸€ä¸ªéƒ½ä¸é€‰ã€‚åŒå‘åŒ¹é…æˆåŠŸåä¼šæ”¶åˆ°é€šçŸ¥ï½\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Next Button */}\n      <Button\n        onClick={handleSubmit}\n        className=\"w-full\"\n        size=\"lg\"\n        data-testid=\"button-next-connections\"\n      >\n        {selectionCount > 0 ? `ç»§ç»­ï¼ˆå·²é€‰${selectionCount}ä½ï¼‰` : \"è·³è¿‡æ­¤æ­¥\"}\n      </Button>\n    </div>\n  );\n}\n","size_bytes":8380},"client/src/lib/userFieldMappings.ts":{"content":"/**\n * User field Chinese mappings for displaying demographic information\n */\n\nexport const genderMap: Record<string, string> = {\n  \"Woman\": \"å¥³\",\n  \"Man\": \"ç”·\",\n  \"Nonbinary\": \"éäºŒå…ƒ\",\n  \"Self-describe\": \"è‡ªå®šä¹‰\",\n  \"Prefer not to say\": \"ä¸ä¾¿é€éœ²\",\n};\n\nexport const genderIconMap: Record<string, string> = {\n  \"Woman\": \"â™€\",\n  \"Man\": \"â™‚\",\n  \"Nonbinary\": \"âš§\",\n  \"Self-describe\": \"â—†\",\n  \"Prefer not to say\": \"â€¢\",\n};\n\nexport const educationLevelMap: Record<string, string> = {\n  \"High school/below\": \"é«˜ä¸­åŠä»¥ä¸‹\",\n  \"Some college/Associate\": \"å¤§ä¸“\",\n  \"Bachelor's\": \"æœ¬ç§‘\",\n  \"Master's\": \"ç¡•å£«\",\n  \"Doctorate\": \"åšå£«\",\n  \"Trade/Vocational\": \"èŒä¸šæŠ€æœ¯\",\n  \"Prefer not to say\": \"ä¸ä¾¿é€éœ²\",\n};\n\nexport const relationshipStatusMap: Record<string, string> = {\n  \"Single\": \"å•èº«\",\n  \"In a relationship\": \"æ‹çˆ±ä¸­\",\n  \"Married/Partnered\": \"å·²å©š\",\n  \"It's complicated\": \"å¤æ‚\",\n  \"Prefer not to say\": \"ä¸ä¾¿é€éœ²\",\n};\n\nexport const studyLocaleMap: Record<string, string> = {\n  \"Local\": \"æœ¬åœ°\",\n  \"Overseas\": \"æµ·å¤–\",\n  \"Both\": \"éƒ½æœ‰\",\n  \"Prefer not to say\": \"ä¸ä¾¿é€éœ²\",\n};\n\nexport const seniorityMap: Record<string, string> = {\n  \"Intern\": \"å®ä¹ ç”Ÿ\",\n  \"Junior\": \"åˆçº§\",\n  \"Mid\": \"ä¸­çº§\",\n  \"Senior\": \"é«˜çº§\",\n  \"Founder\": \"åˆ›å§‹äºº\",\n  \"Executive\": \"é«˜ç®¡\",\n};\n\nexport const childrenMap: Record<string, string> = {\n  \"No kids\": \"æ— å­©å­\",\n  \"Expecting\": \"æœŸå¾…ä¸­\",\n  \"0-5\": \"0-5å²\",\n  \"6-12\": \"6-12å²\",\n  \"13-18\": \"13-18å²\",\n  \"Adult\": \"æˆå¹´\",\n  \"Prefer not to say\": \"ä¸ä¾¿é€éœ²\",\n};\n\nexport const intentMap: Record<string, string> = {\n  \"networking\": \"æ‹“å±•äººè„‰\",\n  \"friends\": \"äº¤æœ‹å‹\",\n  \"discussion\": \"æ·±åº¦è®¨è®º\",\n  \"fun\": \"å¨±ä¹æ”¾æ¾\",\n  \"romance\": \"æµªæ¼«ç¤¾äº¤\",\n  \"flexible\": \"çµæ´»å¼€æ”¾Â·éƒ½å¯ä»¥\",\n};\n\n// Intent options with descriptions for selection UI\nexport const intentOptions = [\n  { value: \"networking\", label: \"æ‹“å±•äººè„‰\", description: \"ç»“è¯†ä¸“ä¸šäººå£«ï¼Œæ‰©å¤§ç¤¾äº¤åœˆ\" },\n  { value: \"friends\", label: \"äº¤æœ‹å‹\", description: \"å¯»æ‰¾å¿—åŒé“åˆçš„æœ‹å‹\" },\n  { value: \"discussion\", label: \"æ·±åº¦è®¨è®º\", description: \"äº¤æµæƒ³æ³•ï¼Œæ·±å…¥æ¢è®¨è¯é¢˜\" },\n  { value: \"fun\", label: \"å¨±ä¹æ”¾æ¾\", description: \"è½»æ¾æ„‰å¿«ï¼Œäº«å—ç¤¾äº¤æ—¶å…‰\" },\n  { value: \"romance\", label: \"æµªæ¼«ç¤¾äº¤\", description: \"è®¤è¯†æ½œåœ¨çš„æ‹çˆ±å¯¹è±¡\" },\n  { value: \"flexible\", label: \"çµæ´»å¼€æ”¾Â·éƒ½å¯ä»¥\", description: \"å¯¹æ‰€æœ‰æ´»åŠ¨ç±»å‹ä¿æŒå¼€æ”¾\" },\n] as const;\n\n/**\n * Format age with Chinese unit\n */\nexport function formatAge(age: number | null | undefined): string {\n  if (!age || age <= 0) return \"\";\n  return `${age}å²`;\n}\n\n/**\n * Calculate age from birthdate\n */\nexport function calculateAge(birthdate: string | null | undefined): number {\n  if (!birthdate) return 0;\n  const today = new Date();\n  const birth = new Date(birthdate);\n  let age = today.getFullYear() - birth.getFullYear();\n  const monthDiff = today.getMonth() - birth.getMonth();\n  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {\n    age--;\n  }\n  return age;\n}\n\n/**\n * Get gender display text\n */\nexport function getGenderDisplay(gender: string | null | undefined): string {\n  if (!gender) return \"\";\n  return genderMap[gender] || gender;\n}\n\n/**\n * Get gender icon\n */\nexport function getGenderIcon(gender: string | null | undefined): string {\n  if (!gender) return \"\";\n  return genderIconMap[gender] || \"â€¢\";\n}\n\n/**\n * Get education level display text\n */\nexport function getEducationDisplay(educationLevel: string | null | undefined): string {\n  if (!educationLevel) return \"\";\n  return educationLevelMap[educationLevel] || educationLevel;\n}\n\n/**\n * Get relationship status display text\n */\nexport function getRelationshipDisplay(relationshipStatus: string | null | undefined): string {\n  if (!relationshipStatus) return \"\";\n  return relationshipStatusMap[relationshipStatus] || relationshipStatus;\n}\n\n/**\n * Get study locale display text\n */\nexport function getStudyLocaleDisplay(studyLocale: string | null | undefined): string {\n  if (!studyLocale) return \"\";\n  return studyLocaleMap[studyLocale] || studyLocale;\n}\n\n/**\n * Get seniority display text\n */\nexport function getSeniorityDisplay(seniority: string | null | undefined): string {\n  if (!seniority) return \"\";\n  return seniorityMap[seniority] || seniority;\n}\n\n/**\n * Get children status display text\n */\nexport function getChildrenDisplay(children: string | null | undefined): string {\n  if (!children) return \"\";\n  return childrenMap[children] || children;\n}\n\n/**\n * Get intent display text (supports both single string and array)\n */\nexport function getIntentDisplay(intent: string | string[] | null | undefined): string {\n  if (!intent) return \"\";\n  if (Array.isArray(intent)) {\n    if (intent.length === 0) return \"\";\n    return intent.map(i => intentMap[i] || i).join(\"ã€\");\n  }\n  return intentMap[intent] || intent;\n}\n\n/**\n * Format array with bullet separator\n */\nexport function formatArray(arr: string[] | null | undefined): string {\n  if (!arr || arr.length === 0) return \"\";\n  return arr.join(\" Â· \");\n}\n\n/**\n * 12ä¸ªç¤¾äº¤æ°›å›´åŸå‹æ˜ å°„\n */\nexport const archetypeMap: Record<string, string> = {\n  \"å¼€å¿ƒæŸ¯åŸº\": \"å¼€å¿ƒæŸ¯åŸº ğŸ¶\",\n  \"å¤ªé˜³é¸¡\": \"å¤ªé˜³é¸¡ ğŸ”\",\n  \"å¤¸å¤¸è±š\": \"å¤¸å¤¸è±š ğŸ¹\",\n  \"æœºæ™ºç‹\": \"æœºæ™ºç‹ ğŸ¦Š\",\n  \"æ·¡å®šæµ·è±š\": \"æ·¡å®šæµ·è±š ğŸ¬\",\n  \"ç»‡ç½‘è››\": \"ç»‡ç½‘è›› ğŸ•·ï¸\",\n  \"æš–å¿ƒç†Š\": \"æš–å¿ƒç†Š ğŸ¨\",\n  \"çµæ„Ÿç« é±¼\": \"çµæ„Ÿç« é±¼ ğŸ™\",\n  \"æ²‰æ€çŒ«å¤´é¹°\": \"æ²‰æ€çŒ«å¤´é¹° ğŸ¦‰\",\n  \"å®šå¿ƒå¤§è±¡\": \"å®šå¿ƒå¤§è±¡ ğŸ˜\",\n  \"ç¨³å¦‚é¾Ÿ\": \"ç¨³å¦‚é¾Ÿ ğŸ¢\",\n  \"éšèº«çŒ«\": \"éšèº«çŒ« ğŸ±\",\n};\n\nexport const archetypeNicknameMap: Record<string, string> = {\n  \"å¼€å¿ƒæŸ¯åŸº\": \"æ‘‡å°¾ç‚¹ç«å®˜\",\n  \"å¤ªé˜³é¸¡\": \"å’¯å’¯å°å¤ªé˜³\",\n  \"å¤¸å¤¸è±š\": \"æŒå£°å‘åŠ¨æœº\",\n  \"æœºæ™ºç‹\": \"å··å£å¯†æ¢\",\n  \"æ·¡å®šæµ·è±š\": \"æ°”æ°›å†²æµªæ‰‹\",\n  \"ç»‡ç½‘è››\": \"å…³ç³»ç»‡ç½‘å¸ˆ\",\n  \"æš–å¿ƒç†Š\": \"æ€€æŠ±æ•…äº‹ç†Š\",\n  \"çµæ„Ÿç« é±¼\": \"è„‘æ´å–·å¢¨ç« \",\n  \"æ²‰æ€çŒ«å¤´é¹°\": \"æ¨é•œæ€è€ƒå®˜\",\n  \"å®šå¿ƒå¤§è±¡\": \"è±¡é¼»å®šå¿ƒé”š\",\n  \"ç¨³å¦‚é¾Ÿ\": \"æ…¢è¯­çœŸçŸ¥é¾Ÿ\",\n  \"éšèº«çŒ«\": \"å®‰é™ä¼´ä¼´çŒ«\",\n};\n\nexport const archetypeOptions = [\n  { value: \"å¼€å¿ƒæŸ¯åŸº\", label: \"å¼€å¿ƒæŸ¯åŸº ğŸ¶\", nickname: \"æ‘‡å°¾ç‚¹ç«å®˜\", energy: 95 },\n  { value: \"å¤ªé˜³é¸¡\", label: \"å¤ªé˜³é¸¡ ğŸ”\", nickname: \"å’¯å’¯å°å¤ªé˜³\", energy: 90 },\n  { value: \"å¤¸å¤¸è±š\", label: \"å¤¸å¤¸è±š ğŸ¹\", nickname: \"æŒå£°å‘åŠ¨æœº\", energy: 85 },\n  { value: \"æœºæ™ºç‹\", label: \"æœºæ™ºç‹ ğŸ¦Š\", nickname: \"å··å£å¯†æ¢\", energy: 82 },\n  { value: \"æ·¡å®šæµ·è±š\", label: \"æ·¡å®šæµ·è±š ğŸ¬\", nickname: \"æ°”æ°›å†²æµªæ‰‹\", energy: 75 },\n  { value: \"ç»‡ç½‘è››\", label: \"ç»‡ç½‘è›› ğŸ•·ï¸\", nickname: \"å…³ç³»ç»‡ç½‘å¸ˆ\", energy: 72 },\n  { value: \"æš–å¿ƒç†Š\", label: \"æš–å¿ƒç†Š ğŸ¨\", nickname: \"æ€€æŠ±æ•…äº‹ç†Š\", energy: 70 },\n  { value: \"çµæ„Ÿç« é±¼\", label: \"çµæ„Ÿç« é±¼ ğŸ™\", nickname: \"è„‘æ´å–·å¢¨ç« \", energy: 68 },\n  { value: \"æ²‰æ€çŒ«å¤´é¹°\", label: \"æ²‰æ€çŒ«å¤´é¹° ğŸ¦‰\", nickname: \"æ¨é•œæ€è€ƒå®˜\", energy: 55 },\n  { value: \"å®šå¿ƒå¤§è±¡\", label: \"å®šå¿ƒå¤§è±¡ ğŸ˜\", nickname: \"è±¡é¼»å®šå¿ƒé”š\", energy: 52 },\n  { value: \"ç¨³å¦‚é¾Ÿ\", label: \"ç¨³å¦‚é¾Ÿ ğŸ¢\", nickname: \"æ…¢è¯­çœŸçŸ¥é¾Ÿ\", energy: 38 },\n  { value: \"éšèº«çŒ«\", label: \"éšèº«çŒ« ğŸ±\", nickname: \"å®‰é™ä¼´ä¼´çŒ«\", energy: 30 },\n] as const;\n\n/**\n * Get archetype display text (with emoji)\n */\nexport function getArchetypeDisplay(archetype: string | null | undefined): string {\n  if (!archetype) return \"\";\n  return archetypeMap[archetype] || archetype;\n}\n\n/**\n * Get archetype nickname\n */\nexport function getArchetypeNickname(archetype: string | null | undefined): string {\n  if (!archetype) return \"\";\n  return archetypeNicknameMap[archetype] || \"\";\n}\n","size_bytes":7720},"client/src/lib/archetypes.ts":{"content":"/**\n * 12-Archetype Animal Social Vibe System\n * ç”¨äºJoyJoinç›²ç›’æ´»åŠ¨çš„AIåŒ¹é…ç®—æ³•\n */\n\nexport const archetypeConfig: Record<string, { \n  icon: string; \n  color: string;\n  bgColor: string;\n  description: string;\n  traits: string[]; // æ ¸å¿ƒç‰¹è´¨\n  energyLevel: number; // ç¤¾äº¤èƒ½é‡å€¼ (30-95)\n  nickname: string; // é²œæ´»æ˜µç§°\n  tagline: string; // ä¸€å¥å®šä½\n  epicDescription: string; // è§’è‰²å²è¯—æè¿°\n  styleQuote: string; // ç‹¬ç‰¹é£æ ¼æè¿°\n  coreContributions: string; // æ ¸å¿ƒè´¡çŒ®\n}> = {\n  // é«˜èƒ½é‡åŒº (82-95)\n  \"å¼€å¿ƒæŸ¯åŸº\": { \n    icon: \"ğŸ•\", \n    color: \"text-orange-600 dark:text-orange-400\",\n    bgColor: \"bg-orange-100 dark:bg-orange-900/20\",\n    description: \"å›¢é˜Ÿæ°¸åŠ¨æœºï¼Œæ‘‡å°¾ç‚¹ç«å®˜ï¼Œæ“…é•¿ç ´å†°å’Œå¸¦åŠ¨æ°”æ°›\",\n    traits: [\"èƒ½é‡å……æ²›\", \"å¹½é»˜æ„Ÿå¼º\", \"å–„äºè°ƒåŠ¨æ°”æ°›\"],\n    energyLevel: 95,\n    nickname: \"æ‘‡å°¾ç‚¹ç«å®˜\",\n    tagline: \"ç¬é—´ç ´å†°çš„æ°”æ°›ç‚¹ç«æ‰‹\",\n    epicDescription: \"ä»–ä»¬æ˜¯åœºåŸŸä¸­ä¸å¯æˆ–ç¼ºçš„æ´»åŠ›æºæ³‰ï¼Œå¦‚åŒä¸€ä½æŠ€è‰ºé«˜è¶…çš„å¼•ç«è€…ï¼Œæ€»èƒ½ä»¥æå…·æ„ŸæŸ“åŠ›çš„å¼€æœ—ä¸çƒ­æƒ…è¿…é€Ÿç‚¹ç‡ƒå…¨åœºã€‚å½“å¯¹è¯é™·å…¥åƒµå±€æˆ–ç©ºæ°”çªç„¶å®‰é™æ—¶ï¼Œä»–ä»¬ä¸€ä¸ªæ°åˆ°å¥½å¤„çš„æé—®ã€ä¸€ä¸ªåº”æ™¯çš„å¹½é»˜ç©ç¬‘ï¼Œä¾¿èƒ½ç¬é—´æ‰“ç ´åšå†°ï¼Œå°†åŸæœ¬å¯èƒ½å°´å°¬çš„æ²‰é»˜å·§å¦™è½¬åŒ–ä¸ºæ‰€æœ‰äººå‚ä¸å…¶ä¸­çš„ã€çƒ­ç«æœå¤©çš„æ¬¢ä¹è®¨è®ºã€‚\",\n    styleQuote: \"å›¢é˜Ÿæ°¸åŠ¨æœºï¼Œå°¾å·´æ‘‡ä¸€æ‘‡ï¼Œå†·åœºç„¦è™‘å…¨èµ¶è·‘\",\n    coreContributions: \"ç ´å†°å¯åŠ¨ï¼Œåˆ›é€ æ¬¢ä¹æ°›å›´\"\n  },\n  \"å¤ªé˜³é¸¡\": { \n    icon: \"ğŸ“\", \n    color: \"text-amber-600 dark:text-amber-400\",\n    bgColor: \"bg-amber-100 dark:bg-amber-900/20\",\n    description: \"äººé—´å°æš–æ°”ï¼Œå’¯å’¯å°å¤ªé˜³ï¼Œæ•£å‘ç¨³å®šæ¸©æš–çš„æ­£èƒ½é‡\",\n    traits: [\"ä¹è§‚å¼€æœ—\", \"æ„ŸæŸ“åŠ›å¼º\", \"æƒ…ç»ªç¨³å®š\"],\n    energyLevel: 90,\n    nickname: \"å’¯å’¯å°å¤ªé˜³\",\n    tagline: \"ç¨³å®šè¾“å‡ºçš„æš–æ„åŸºçº¿\",\n    epicDescription: \"ä»–ä»¬æ˜¯ç¾¤ä½“ä¸­'å¿«ä¹çš„å¸¸é‡'ï¼Œæœ¬èº«å°±æ˜¯ä¸€ä¸ªæ¸©æš–çš„å°å®‡å®™ã€‚æ— éœ€åˆ»æ„åˆ¶é€ è¯é¢˜æˆ–è¡ŒåŠ¨ï¼Œä»–ä»¬ç¨³å®šè€Œä¹è§‚çš„å­˜åœ¨ï¼Œå°±åƒä¸€é“å’Œç…¦çš„é˜³å…‰ï¼Œèƒ½è‡ªç„¶è€Œç„¶åœ°æå‡æ•´ä¸ªç©ºé—´çš„å¹¸ç¦åŸºçº¿ã€‚å½“ä½ å’Œä»–ä»¬ç›¸å¤„æ—¶ï¼Œä¼šä¸è‡ªè§‰åœ°æ„Ÿè§‰ä¸–ç•Œç®€å•ç¾å¥½äº†ä¸€äº›ï¼Œé‚£äº›å°å°çš„å‹åŠ›ä¸çƒ¦æ¼ä¹Ÿéšä¹‹æ‚„ç„¶æ¶ˆæ•£ã€‚\",\n    styleQuote: \"äººé—´å°æš–æ°”ï¼Œå’¯å’¯å’¯ä¸€ç¬‘ï¼Œè´Ÿé¢æƒ…ç»ªå…¨è’¸å‘\",\n    coreContributions: \"æ•£å‘æ¸©æš–èƒ½é‡ï¼Œæå‡æ•´ä½“å¹¸ç¦æ„Ÿ\"\n  },\n  \"å¤¸å¤¸è±š\": { \n    icon: \"ğŸ¬\", \n    color: \"text-cyan-600 dark:text-cyan-400\",\n    bgColor: \"bg-cyan-100 dark:bg-cyan-900/20\",\n    description: \"æŒå£°å‘åŠ¨æœºï¼Œé¦–å¸­é¼“æŒå®˜ï¼Œå–„äºå‘ç°å’Œæ”¾å¤§ä»–äººä¼˜ç‚¹\",\n    traits: [\"é¼“åŠ±æ€§å¼º\", \"ååº”çƒ­æƒ…\", \"æ­£èƒ½é‡æ»¡æ»¡\"],\n    energyLevel: 85,\n    nickname: \"é¦–å¸­é¼“æŒå®˜\",\n    tagline: \"å³æ—¶æ­£åé¦ˆçš„è‡ªä¿¡æ”¾å¤§å™¨\",\n    epicDescription: \"ä»–ä»¬æ˜¯å›¢é˜Ÿä¸­ä¸å¯æˆ–ç¼ºçš„ç§¯æèƒ½é‡æºæ³‰ï¼Œæ˜¯ä¸€ä½ä¸“ä¸šçš„'é—ªå…‰æ—¶åˆ»'æ•æ‰å¸ˆã€‚æ— è®ºè°åšå‡ºäº†ä½•ç§åˆ†äº«ï¼Œä»–ä»¬æ€»èƒ½æŠ¥ä»¥æœ€åŠæ—¶çš„å…´å¥‹ã€æœ€ä¸“æ³¨çš„å€¾å¬ä¸æœ€çœŸè¯šçš„èµç¾ã€‚ä»–ä»¬çš„å­˜åœ¨æœ¬èº«å°±åƒä¸€ç§æ— å½¢çš„å£°æ´ï¼Œè®©å›¢é˜Ÿä¸­çš„æ¯ä¸€ä½æˆå‘˜éƒ½æ„Ÿè§‰è‡ªå·±çš„å‘è¨€æ˜¯æœ‰è¶£çš„ã€è¢«æ¬£èµçš„ï¼Œä»è€Œè·å¾—æ›´å¤šè‡ªä¿¡ï¼Œæ›´æ„¿æ„æ•å¼€å¿ƒæ‰‰ã€‚\",\n    styleQuote: \"é¦–å¸­é¼“æŒå®˜ï¼Œå°æ‰‹æ‹ä¸€æ‹ï¼Œä½ çš„é­…åŠ›å…¨æ‰“å¼€\",\n    coreContributions: \"æä¾›ç§¯æåé¦ˆï¼Œå¢å¼ºå›¢é˜Ÿä¿¡å¿ƒ\"\n  },\n  \"æœºæ™ºç‹\": { \n    icon: \"ğŸ¦Š\", \n    color: \"text-red-600 dark:text-red-400\",\n    bgColor: \"bg-red-100 dark:bg-red-900/20\",\n    description: \"åŸå¸‚æ¢é™©å®¶ï¼Œå··å£å¯†æ¢ï¼Œå¥½å¥‡å¿ƒå¼ºã€ä¿¡æ¯çµé€š\",\n    traits: [\"å¥½å¥‡å¿ƒå¼º\", \"ä¿¡æ¯çµé€š\", \"å‹‡äºå°è¯•\"],\n    energyLevel: 82,\n    nickname: \"å··å£å¯†æ¢\",\n    tagline: \"å¸¦æ¥æ–°é²œç©æ³•ä¸åœ°ç‚¹çš„å‘ç°å®˜\",\n    epicDescription: \"ä»–ä»¬æ˜¯åŸå¸‚é‡Œè¡Œèµ°çš„æƒŠå¥‡å‘ç°å®˜ï¼Œä»¿ä½›æ‹¥æœ‰ä¸€å¼ æ—äººæ— æ³•çª¥è§çš„ç§˜å¯†åœ°å›¾ã€‚å½“èšä¼šæµäºå¯»å¸¸å¥—è·¯æ—¶ï¼Œä»–ä»¬æ€»èƒ½å¦‚æ•°å®¶çåœ°æŠ›å‡ºè—åŒ¿äºå°å··æ·±å¤„çš„ç‰¹è‰²å°åº—ï¼Œæˆ–æ˜¯ä¸€ä¸ªåˆ«å‡ºå¿ƒè£çš„æ´»åŠ¨ç‚¹å­ï¼Œè½»æ˜“å°†ä¸€æ¬¡å¹³å‡¡çš„ç›¸èšå‡çº§ä¸ºä¸€åœºä»¤äººå›å‘³æ— ç©·çš„ã€å……æ»¡å‘ç°æ„Ÿçš„å…±åŒå†’é™©ã€‚\",\n    styleQuote: \"åŸå¸‚æ¢é™©å®¶ï¼Œé¼»å­å—…ä¸€å—…ï¼Œæ–°å¥‡ç©æ³•å…¨éƒ½æœ‰\",\n    coreContributions: \"å¼•å…¥æ–°é²œä½“éªŒï¼Œæ‹“å±•æ´»åŠ¨è¾¹ç•Œ\"\n  },\n  \n  // ä¸­èƒ½é‡åŒº (68-75)\n  \"æ·¡å®šæµ·è±š\": { \n    icon: \"ğŸ¬\", \n    color: \"text-indigo-600 dark:text-indigo-400\",\n    bgColor: \"bg-indigo-100 dark:bg-indigo-900/20\",\n    description: \"æ°”æ°›è°ƒé¢‘æ‰‹ï¼Œæ°”æ°›å†²æµªæ‰‹ï¼Œæƒ…å•†é«˜ã€åº”å˜åŠ›å¼º\",\n    traits: [\"æƒ…å•†é«˜\", \"åº”å˜åŠ›å¼º\", \"åŒ…å®¹æ€§å¥½\"],\n    energyLevel: 75,\n    nickname: \"æ°”æ°›å†²æµªæ‰‹\",\n    tagline: \"åœ¨æƒ…ç»ªæ³¢åŠ¨æ—¶çš„æ°”æ°›è°ƒé¢‘æ‰‹\",\n    epicDescription: \"ä»–ä»¬å¦‚åŒä¸€ä½åœ¨ç¤¾äº¤æƒ…ç»ªæ³¢æµªä¸­è‡ªå¦‚æ»‘è¡Œçš„å†²æµªæ‰‹ï¼Œæˆ–è€…è¯´æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„ç°åœºDJã€‚å‡­å€Ÿéå‡¡çš„è§‚å¯ŸåŠ›ï¼Œä»–ä»¬èƒ½ç²¾å‡†æ•æ‰åˆ°ç©ºæ°”ä¸­æ¯ä¸€ä¸å¾®å¦™çš„æƒ…æ„Ÿæ³¢åŠ¨ä¸èƒ½é‡æµå‘ï¼Œå¹¶ç”¨ä¸€å¥è½»æ¾çš„ç©ç¬‘åŒ–è§£æ½œåœ¨çš„ç´§å¼ ï¼Œå¾®å¦™åœ°è°ƒå’Œç€æ°”æ°›ï¼Œå§‹ç»ˆç»´æŒç€æ•´ä¸ªåœºåŸŸçš„å’Œè°ã€è½»æ¾ä¸åŒ…å®¹ã€‚\",\n    styleQuote: \"æ°”æ°›å†²æµªæ‰‹ï¼Œå¾®ç¬‘éœ²ä¸€éœ²ï¼Œå°´å°¬ç´§å¼ å…¨å†²èµ°\",\n    coreContributions: \"å¹³è¡¡ç¾¤ä½“æ°›å›´ï¼ŒåŒ–è§£æ½œåœ¨å†²çª\"\n  },\n  \"ç»‡ç½‘è››\": { \n    icon: \"ğŸ•·ï¸\", \n    color: \"text-purple-600 dark:text-purple-400\",\n    bgColor: \"bg-purple-100 dark:bg-purple-900/20\",\n    description: \"ç¤¾äº¤é»åˆå‰‚ï¼Œå…³ç³»ç»‡ç½‘å¸ˆï¼Œå–„äºå»ºç«‹è¿æ¥å’Œæ„å»ºç½‘ç»œ\",\n    traits: [\"è§‚å¯Ÿæ•é”\", \"å–„äºå‘ç°å…±åŒç‚¹\", \"äººè„‰å¹¿æ³›\"],\n    energyLevel: 72,\n    nickname: \"å…³ç³»ç»‡ç½‘å¸ˆ\",\n    tagline: \"å‘ç°å…±åŒç‚¹å¹¶æ’®åˆäº¤æµçš„è¿æ¥å™¨\",\n    epicDescription: \"ä»–ä»¬æ˜¯äººç¾¤ä¸­å¤©ç”Ÿçš„å…³ç³»å»ºç­‘å¸ˆï¼Œæ‹¥æœ‰å¦‚èœ˜è››ä¾ èˆ¬çš„æ•é”ç›´è§‰ã€‚ä»–ä»¬èƒ½ç²¾å‡†æ„ŸçŸ¥åˆ°äººä¸äººä¹‹é—´é‚£äº›å°šæœªè¢«å‘ç°çš„å…±åŒå…´è¶£æˆ–æ½œåœ¨å…³è”ï¼Œå¹¶ä¹äºæ‰®æ¼”é‚£ä¸ªå…³é”®çš„è¿æ¥ç‚¹ï¼Œç”¨å·§å¦™çš„è¯è¯­ä½œä¸çº¿ï¼Œç¼–ç»‡å‡ºä¸€å¼ è®©æ‰€æœ‰äººæƒŠå¹çš„ç¤¾äº¤ç½‘ç»œï¼Œç¡®ä¿æ²¡æœ‰ä»»ä½•ä¸€ä¸ªäººåœ¨è¿™åœºé›†ä½“å¯¹è¯ä¸­æˆä¸ºå­¤å²›ã€‚\",\n    styleQuote: \"ç¤¾äº¤é»åˆå‰‚ï¼Œç½‘ç»œç»‡ä¸€ç»‡ï¼Œé™Œç”Ÿæœ‹å‹å˜çŸ¥å·±\",\n    coreContributions: \"è¿æ¥ä¸åŒäººç¾¤ï¼Œæ„å»ºç¤¾äº¤ç½‘ç»œ\"\n  },\n  \"æš–å¿ƒç†Š\": { \n    icon: \"ğŸ»\", \n    color: \"text-pink-600 dark:text-pink-400\",\n    bgColor: \"bg-pink-100 dark:bg-pink-900/20\",\n    description: \"æ•…äº‹æ”¶è—å®¶ï¼Œæ€€æŠ±æ•…äº‹ç†Šï¼Œå–„äºå€¾å¬å’Œå…±æƒ…\",\n    traits: [\"å–„äºå€¾å¬\", \"å…±æƒ…åŠ›å¼º\", \"æ•…äº‹åŠ›ä¸°å¯Œ\"],\n    energyLevel: 70,\n    nickname: \"æ€€æŠ±æ•…äº‹ç†Š\",\n    tagline: \"æŠŠç‰‡æ®µå˜æ•…äº‹çš„æƒ…æ„Ÿé»åˆå‰‚\",\n    epicDescription: \"ä»–ä»¬æ˜¯ç¾¤ä½“ä¸­æ¸©æš–çš„æƒ…æ„Ÿè”ç»“è€…ï¼Œå¦‚åŒä¸€ä¸ªæ‰¿è½½ç€æ— æ•°çè´µç‰‡æ®µçš„æ´»ä½“åšç‰©é¦†ã€‚ä»–ä»¬ä¸ä»…å–„äºå°†å¹³å‡¡çš„æ—¥å¸¸ç¼–ç»‡æˆå¼•äººå…¥èƒœçš„æ•…äº‹ï¼Œæ›´æ‹¥æœ‰ä¸€åŒèƒ½å¬è§å¿ƒè·³çš„è€³æœµï¼Œè®©æ¯ä¸ªäººçš„åˆ†äº«éƒ½å¾—åˆ°æœ€æ·±æƒ…çš„å›å“ã€‚ç»ç”±ä»–ä»¬çš„è®²è¿°ä¸å€¾å¬ï¼Œé™Œç”Ÿçš„ä¸ªä½“ä¹‹é—´å¾—ä»¥å»ºç«‹èµ·åšå®çš„æƒ…æ„Ÿçº½å¸¦ï¼Œè®©æ•´ä¸ªåœºåŸŸå› è¿™ä»½æ·±å±‚çš„æ‡‚å¾—è€Œå˜å¾—æ ¼å¤–ç´§å¯†ã€‚\",\n    styleQuote: \"æ•…äº‹æ”¶è—å®¶ï¼Œæ€€æŠ±æš–ä¸€æš–ï¼Œå¿ƒäº‹çƒ¦æ¼å…¨æ¶ˆæ•£\",\n    coreContributions: \"å»ºç«‹æƒ…æ„Ÿè¿æ¥ï¼Œè¥é€ æ·±åº¦äº¤æµ\"\n  },\n  \"çµæ„Ÿç« é±¼\": { \n    icon: \"ğŸ™\", \n    color: \"text-violet-600 dark:text-violet-400\",\n    bgColor: \"bg-violet-100 dark:bg-violet-900/20\",\n    description: \"åˆ›æ„å–·å°„å™¨ï¼Œè„‘æ´å–·å¢¨ç« ï¼Œæ€ç»´è·³è·ƒã€è”æƒ³ä¸°å¯Œ\",\n    traits: [\"æ€ç»´è·³è·ƒ\", \"è”æƒ³ä¸°å¯Œ\", \"åˆ›æ„æ— ç©·\"],\n    energyLevel: 68,\n    nickname: \"è„‘æ´å–·å¢¨ç« \",\n    tagline: \"å¤šçº¿å‘æ•£çš„åˆ›æ„å–·å°„å£\",\n    epicDescription: \"ä»–ä»¬çš„æ€ç»´å¦‚åŒä¸€ä¸ªæ°¸ä¸åœæ­‡çš„è„‘æ´å–·å°„å™¨ï¼Œæ€»èƒ½ä»æœ€å¹³å‡¡çš„äº‹ç‰©ä¸­æŒ–æ˜å‡ºä»¤äººæƒŠå¹çš„è¶£å‘³ã€‚æ— è®ºæ˜¯ä¸€ä¸ªå¼‚æƒ³å¤©å¼€çš„æ¸¸æˆè®¾è®¡ï¼Œè¿˜æ˜¯ä¸€ä¸ªå¯¹å¯»å¸¸æ¦‚å¿µçš„ç»å¦™æ¯”å–»ï¼Œä»–ä»¬æ€»èƒ½å‡­å€Ÿå‡ºå…¶ä¸æ„çš„å¹½é»˜æ„Ÿå’Œç‹¬ç‰¹è§†è§’ï¼Œä¸ºæ¯ä¸€æ¬¡èšä¼šæ³¨å…¥é­”æ³•èˆ¬çš„æƒŠå–œä¸æŒç»­ä¸æ–­çš„æ–°é²œæ„Ÿã€‚\",\n    styleQuote: \"åˆ›æ„å–·å°„å™¨ï¼Œè§¦æ‰‹ä¼¸ä¸€ä¼¸ï¼Œå¥‡å¦™ç‚¹å­å…«æ–¹æ¥\",\n    coreContributions: \"å¤šçº¿ç¨‹å‘æ•£æ€ç»´ï¼Œæ¿€å‘é›†ä½“è„‘æš´\"\n  },\n  \n  // ä½èƒ½é‡åŒº (52-55)\n  \"æ²‰æ€çŒ«å¤´é¹°\": { \n    icon: \"ğŸ¦‰\", \n    color: \"text-slate-600 dark:text-slate-400\",\n    bgColor: \"bg-slate-100 dark:bg-slate-900/20\",\n    description: \"å“²å­¦å¸¦å¸ˆï¼Œæ¨é•œæ€è€ƒå®˜ï¼Œé€»è¾‘æ€§å¼ºã€å–„äºæé—®\",\n    traits: [\"é€»è¾‘æ€§å¼º\", \"å–„äºæé—®\", \"è¿½æ±‚çœŸç†\"],\n    energyLevel: 55,\n    nickname: \"æ¨é•œæ€è€ƒå®˜\",\n    tagline: \"æŠŠé—²èŠå¼•å‘æœ¬è´¨çš„æ·±æ½œå¼•å¯¼è€…\",\n    epicDescription: \"åœ¨ä¹ æƒ¯äºå¯’æš„çš„ç¤¾äº¤æµ…æ°´åŒºï¼Œä»–ä»¬æ˜¯ä¸€ä½æ¸©å’Œè€Œåšå®šçš„æ€æƒ³æ·±æ½œæ•™ç»ƒã€‚ä¸æ»¡è¶³äºåœç•™åœ¨'ä»Šå¤©å¤©æ°”çœŸå¥½'çš„è¡¨é¢ï¼Œä»–ä»¬ä¼šç”¨å……æ»¡æ™ºæ…§çš„è¿½é—®ï¼Œå·§å¦™åœ°æŒ‘æˆ˜æˆè§ï¼Œå¼•å¯¼å¤§å®¶æ½œå…¥æ€ç»´çš„æµ·åº•ï¼Œå»æ¢è®¨ç°è±¡èƒŒåçš„æœ¬è´¨ï¼Œä»è€Œå°†è½»æ¾çš„é—²èŠå‚¬ç”Ÿä¸ºè¥å…»ä¸°å¯Œã€æ›´å…·å¯å‘æ€§çš„é«˜è´¨é‡æ€æƒ³äº¤é”‹ã€‚\",\n    styleQuote: \"å“²å­¦å¸¦å¸ˆï¼Œé•œæ¡†æ¨ä¸€æ¨ï¼ŒèŠå¤©æ·±åº¦å¾€ä¸Šé£\",\n    coreContributions: \"æå‡å¯¹è¯è´¨é‡ï¼Œæ¿€å‘æ·±åº¦æ€è€ƒ\"\n  },\n  \"å®šå¿ƒå¤§è±¡\": { \n    icon: \"ğŸ˜\", \n    color: \"text-gray-600 dark:text-gray-400\",\n    bgColor: \"bg-gray-100 dark:bg-gray-900/20\",\n    description: \"å›¢é˜Ÿå®šç›˜æ˜Ÿï¼Œè±¡é¼»å®šå¿ƒé”šï¼Œç¨³é‡å¯é ã€åŒ…å®¹è±è¾¾\",\n    traits: [\"ç¨³é‡å¯é \", \"åŒ…å®¹è±è¾¾\", \"ç»™äººå®‰å…¨æ„Ÿ\"],\n    energyLevel: 52,\n    nickname: \"è±¡é¼»å®šå¿ƒé”š\",\n    tagline: \"è®©äººå®‰å¿ƒçš„ç¨³å®šåç›¾ä¸å®ˆæœ›è€…\",\n    epicDescription: \"ä»–ä»¬æ˜¯å›¢é˜Ÿä¸­æ¸©æš–è€Œåšå®çš„åç›¾ï¼Œå¤©ç”Ÿå…·å¤‡ä¸€ç§è®©äººå¿ƒå®‰çš„åŠ›é‡ã€‚ä»–ä»¬æˆ–è®¸ä¸æ˜¯è¯é¢˜çš„ä¸­å¿ƒï¼Œä½†æ€»æ˜¯ç”¨ç»†è…»çš„è§‚å¯ŸåŠ›é»˜é»˜å…³æ€€ç€æ¯ä¸ªäººï¼Œåƒä¸€ä½æ— å£°çš„å®ˆæŠ¤è€…ï¼Œé€šè¿‡ä¸€ä¸ªé»˜å¥‘çš„çœ¼ç¥ã€ä¸€æ¬¡åŠæ—¶çš„æ´æ‰‹ï¼Œä¸ºæ•´ä¸ªåœºåŸŸå¥ å®šä¸‹é«˜åº¦ä¿¡ä»»ä¸å®‰å…¨çš„åŸºè°ƒï¼Œè®©æ‰€æœ‰äººéƒ½èƒ½å®‰å¿ƒåœ°åšè‡ªå·±ã€‚\",\n    styleQuote: \"å›¢é˜Ÿå®šç›˜æ˜Ÿï¼Œè±¡é¼»å·ä¸€å·ï¼Œå®‰å…¨æ„Ÿç«‹é©¬æ‹‰æ»¡\",\n    coreContributions: \"æä¾›ç¨³å®šæ”¯æŒï¼Œå¥ å®šå®‰å¿ƒåŸºè°ƒ\"\n  },\n  \n  // è¶…ä½èƒ½é‡åŒº (30-38)\n  \"ç¨³å¦‚é¾Ÿ\": { \n    icon: \"ğŸ¢\", \n    color: \"text-emerald-600 dark:text-emerald-400\",\n    bgColor: \"bg-emerald-100 dark:bg-emerald-900/20\",\n    description: \"äººé—´è§‚å¯Ÿå®¶ï¼Œæ…¢è¯­çœŸçŸ¥é¾Ÿï¼Œæ€è€ƒæ·±å…¥ã€è¨€ç®€æ„èµ…\",\n    traits: [\"æ€è€ƒæ·±å…¥\", \"è¨€ç®€æ„èµ…\", \"æ´å¯ŸåŠ›å¼º\"],\n    energyLevel: 38,\n    nickname: \"æ…¢è¯­çœŸçŸ¥é¾Ÿ\",\n    tagline: \"ä½é¢‘é«˜è´¨çš„æ´å¯ŸæŠ•æ”¾è€…\",\n    epicDescription: \"ä»–ä»¬æ˜¯ç¤¾äº¤ä¸­çš„æ·±åº¦æ€è€ƒè€…ï¼Œä¿¡å¥‰'æ²‰é»˜æ˜¯é‡‘ï¼Œä½†çœŸç†æ˜¯é’»çŸ³'ã€‚ä»–ä»¬äº«å—é€šè¿‡è§‚å¯Ÿä¸å€¾å¬æ¥å‚ä¸ç¤¾äº¤ï¼Œç”¨ä¸€ç§æ›´æ·±åˆ»çš„æ–¹å¼'å“å°'å¯¹è¯ã€‚å½“ä»–ä»¬ç»è¿‡æ·±æ€ç†Ÿè™‘ç»ˆäºå¼€å£æ—¶ï¼Œå¾€å¾€èƒ½æä¾›ç‹¬ä¸€æ— äºŒçš„è§†è§’æˆ–ä¸€é’ˆè§è¡€çš„æ€»ç»“ï¼Œè½»æ˜“æ¨åŠ¨å¯¹è¯è¿›å…¥ä¸€ä¸ªæ›´å…·æ´å¯ŸåŠ›çš„æ–°å±‚æ¬¡ã€‚\",\n    styleQuote: \"äººé—´è§‚å¯Ÿå®¶ï¼Œè„–å­ä¼¸ä¸€ä¼¸ï¼Œä¸€è¯­é“ç ´ä¸‡äº‹çš†\",\n    coreContributions: \"æä¾›æ·±åº¦æ´å¯Ÿï¼Œè´¡çŒ®ç‹¬åˆ°è§è§£\"\n  },\n  \"éšèº«çŒ«\": { \n    icon: \"ğŸ±\", \n    color: \"text-indigo-600 dark:text-indigo-400\",\n    bgColor: \"bg-indigo-100 dark:bg-indigo-900/20\",\n    description: \"å®‰é™é™ªä¼´è€…ï¼Œå®‰é™ä¼´ä¼´çŒ«ï¼Œå­˜åœ¨æ„Ÿä½ä½†ä¸æ–½åŠ å‹åŠ›\",\n    traits: [\"å­˜åœ¨æ„Ÿä½\", \"ä¸æ–½åŠ å‹åŠ›\", \"äº«å—æ—è§‚\"],\n    energyLevel: 30,\n    nickname: \"å®‰é™ä¼´ä¼´çŒ«\",\n    tagline: \"ä½å‹é™ªä¼´çš„é™é»˜åŒåœ¨è€…\",\n    epicDescription: \"ä»–ä»¬æ˜¯'é™ªä¼´å¼ç¤¾äº¤'çš„å®Œç¾ä»£è¨€äººï¼Œä¸º'ç¤¾æ'æˆ–ç¤¾äº¤èƒ½é‡ä½çš„ç”¨æˆ·æä¾›äº†æœ€èˆ’é€‚çš„èº«ä»½è®¤åŒã€‚ä»–ä»¬å‚ä¸ç¤¾äº¤çš„æ ¸å¿ƒç›®çš„å¹¶éäº¤æ¢ä¿¡æ¯ï¼Œè€Œæ˜¯ä¸ºäº†å¯¹æŠ—å­¤ç‹¬ï¼Œäº«å—ä¸€ç§'å…±åŒå­˜åœ¨'çš„æ¸©æš–é™ªä¼´ã€‚ä»–ä»¬çš„å­˜åœ¨ï¼Œå¦‚åŒä¸€ä¸ªå®‰é™è€Œèˆ’é€‚çš„è§’è½ï¼Œè®©æ•´ä¸ªåœºåŸŸçš„æ°›å›´å˜å¾—æ›´åŠ è½»æ¾å’Œæ— å‹ã€‚\",\n    styleQuote: \"å®‰é™é™ªä¼´è€…ï¼Œè§’è½çªä¸€çªï¼Œä½ åœ¨èº«è¾¹å°±å¿«ä¹\",\n    coreContributions: \"æä¾›å®‰é™é™ªä¼´ï¼Œè¥é€ è½»æ¾æ°›å›´\"\n  },\n};\n\n// åŸå‹åˆ†ç±»ï¼ˆæŒ‰èƒ½é‡åŒºåˆ†ï¼‰\nexport const archetypeCategories = {\n  highEnergy: [\"å¼€å¿ƒæŸ¯åŸº\", \"å¤ªé˜³é¸¡\", \"å¤¸å¤¸è±š\", \"æœºæ™ºç‹\"],\n  mediumEnergy: [\"æ·¡å®šæµ·è±š\", \"ç»‡ç½‘è››\", \"æš–å¿ƒç†Š\", \"çµæ„Ÿç« é±¼\"],\n  lowEnergy: [\"æ²‰æ€çŒ«å¤´é¹°\", \"å®šå¿ƒå¤§è±¡\"],\n  veryLowEnergy: [\"ç¨³å¦‚é¾Ÿ\", \"éšèº«çŒ«\"],\n};\n\n// è·å–æ‰€æœ‰åŸå‹åç§°\nexport const allArchetypes = Object.keys(archetypeConfig);\n\n// æ ¹æ®åˆ†ç±»è·å–åŸå‹\nexport function getArchetypesByCategory(category: keyof typeof archetypeCategories): string[] {\n  return archetypeCategories[category];\n}\n\n// æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆåŸå‹\nexport function isValidArchetype(archetype: string): boolean {\n  return allArchetypes.includes(archetype);\n}\n\n// æ ¹æ®èƒ½é‡ç­‰çº§è·å–åŸå‹\nexport function getArchetypesByEnergyRange(min: number, max: number): string[] {\n  return allArchetypes.filter(\n    archetype => {\n      const energy = archetypeConfig[archetype].energyLevel;\n      return energy >= min && energy <= max;\n    }\n  );\n}\n","size_bytes":12823},"client/src/components/EditProfileDialog.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\n\ntype SectionType = \"basic\" | \"education\" | \"work\" | \"personal\" | \"interests\";\n\ninterface EditProfileDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  section: SectionType;\n  user: any;\n  onSave: (data: any) => void;\n}\n\nconst basicSchema = z.object({\n  displayName: z.string().min(1, \"è¯·è¾“å…¥æ˜µç§°\"),\n  gender: z.string().optional(),\n  birthdate: z.string().optional(),\n  languagesComfort: z.array(z.string()).optional(),\n});\n\nconst educationSchema = z.object({\n  educationLevel: z.string().optional(),\n  fieldOfStudy: z.string().optional(),\n  studyLocale: z.string().optional(),\n  overseasRegions: z.array(z.string()).optional(),\n});\n\nconst workSchema = z.object({\n  industry: z.string().optional(),\n  roleTitleShort: z.string().optional(),\n  seniority: z.string().optional(),\n});\n\nconst personalSchema = z.object({\n  relationshipStatus: z.string().optional(),\n  children: z.string().optional(),\n});\n\nconst interestsSchema = z.object({\n  interestsTop: z.array(z.string()).optional(),\n});\n\nconst getSchema = (section: SectionType) => {\n  switch (section) {\n    case \"basic\":\n      return basicSchema;\n    case \"education\":\n      return educationSchema;\n    case \"work\":\n      return workSchema;\n    case \"personal\":\n      return personalSchema;\n    case \"interests\":\n      return interestsSchema;\n    default:\n      return basicSchema;\n  }\n};\n\nconst getDefaultValues = (section: SectionType, user: any) => {\n  switch (section) {\n    case \"basic\":\n      return {\n        displayName: user?.displayName || \"\",\n        gender: user?.gender || \"\",\n        birthdate: user?.birthdate ? new Date(user.birthdate).toISOString().split('T')[0] : \"\",\n        languagesComfort: user?.languagesComfort || [],\n      };\n    case \"education\":\n      return {\n        educationLevel: user?.educationLevel || \"\",\n        fieldOfStudy: user?.fieldOfStudy || \"\",\n        studyLocale: user?.studyLocale || \"\",\n        overseasRegions: user?.overseasRegions || [],\n      };\n    case \"work\":\n      return {\n        industry: user?.industry || \"\",\n        roleTitleShort: user?.roleTitleShort || \"\",\n        seniority: user?.seniority || \"\",\n      };\n    case \"personal\":\n      return {\n        relationshipStatus: user?.relationshipStatus || \"\",\n        children: user?.children || \"\",\n      };\n    case \"interests\":\n      return {\n        interestsTop: user?.interestsTop || [],\n      };\n    default:\n      return {};\n  }\n};\n\nconst sectionTitles: Record<SectionType, string> = {\n  basic: \"ç¼–è¾‘åŸºæœ¬ä¿¡æ¯\",\n  education: \"ç¼–è¾‘æ•™è‚²èƒŒæ™¯\",\n  work: \"ç¼–è¾‘å·¥ä½œä¿¡æ¯\",\n  personal: \"ç¼–è¾‘ä¸ªäººèƒŒæ™¯\",\n  interests: \"ç¼–è¾‘å…´è¶£åå¥½\",\n};\n\nconst languageOptions = [\n  \"æ™®é€šè¯\",\n  \"ç²¤è¯­\",\n  \"è‹±è¯­\",\n  \"æ—¥è¯­\",\n  \"éŸ©è¯­\",\n  \"æ³•è¯­\",\n  \"å¾·è¯­\",\n  \"è¥¿ç­ç‰™è¯­\",\n];\n\nconst overseasRegionOptions = [\n  \"åŒ—ç¾\",\n  \"æ¬§æ´²\",\n  \"ä¸œäºš\",\n  \"ä¸œå—äºš\",\n  \"å—äºš\",\n  \"ä¸­ä¸œ\",\n  \"å¤§æ´‹æ´²\",\n  \"æ‹‰ç¾\",\n  \"éæ´²\",\n];\n\nconst industryOptions = [\n  \"å¤§å‚\",\n  \"é‡‘è\",\n  \"ç§‘æŠ€åˆåˆ›\",\n  \"AI/ML\",\n  \"è·¨å¢ƒç”µå•†\",\n  \"æŠ•èµ„\",\n  \"å’¨è¯¢\",\n  \"æ¶ˆè´¹å“\",\n  \"è‰ºæœ¯/è®¾è®¡\",\n  \"æ•™è‚²\",\n  \"åŒ»ç–—\",\n  \"æ”¿åºœ/å…¬å…±\",\n  \"å…¶ä»–\",\n];\n\nconst interestOptions = [\n  \"ç¾é£Ÿæ¢åº—\",\n  \"å’–å•¡\",\n  \"éŸ³ä¹\",\n  \"ç”µå½±\",\n  \"é˜…è¯»\",\n  \"æ—…è¡Œ\",\n  \"å¥èº«\",\n  \"æ‘„å½±\",\n  \"è‰ºæœ¯\",\n  \"ç§‘æŠ€\",\n  \"åˆ›ä¸š\",\n  \"æŠ•èµ„\",\n  \"æ¸¸æˆ\",\n  \"æˆ·å¤–è¿åŠ¨\",\n  \"å® ç‰©\",\n];\n\nconst budgetOptions = [\n  \"100ä»¥ä¸‹\",\n  \"100-200\",\n  \"200-300\",\n  \"300-500\",\n  \"500+\",\n];\n\nexport default function EditProfileDialog({\n  open,\n  onOpenChange,\n  section,\n  user,\n  onSave,\n}: EditProfileDialogProps) {\n  const form = useForm({\n    resolver: zodResolver(getSchema(section)),\n    defaultValues: getDefaultValues(section, user),\n  });\n\n  const handleSubmit = (data: any) => {\n    // Remove empty string values to prevent validation errors\n    const cleanedData = Object.fromEntries(\n      Object.entries(data).filter(([_, value]) => {\n        if (typeof value === 'string') return value !== '';\n        if (Array.isArray(value)) return value.length > 0;\n        return value !== null && value !== undefined;\n      })\n    );\n    onSave(cleanedData);\n  };\n\n  const toggleArrayItem = (field: string, value: string) => {\n    const current = (form.watch(field as any) as string[]) || [];\n    if (current.includes(value)) {\n      form.setValue(field as any, current.filter((v: string) => v !== value) as any);\n    } else {\n      form.setValue(field as any, [...current, value] as any);\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-md max-h-[85vh] overflow-y-auto\" data-testid={`dialog-edit-${section}`}>\n        <DialogHeader>\n          <DialogTitle>{sectionTitles[section]}</DialogTitle>\n          <DialogDescription className=\"sr-only\">ç¼–è¾‘ä¸ªäººèµ„æ–™ä¿¡æ¯</DialogDescription>\n        </DialogHeader>\n\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(handleSubmit)} className=\"space-y-4 py-4\">\n            {section === \"basic\" && (\n              <>\n                <FormField\n                  control={form.control}\n                  name=\"displayName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>æ˜µç§° *</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"è¾“å…¥æ˜µç§°\" data-testid=\"input-display-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"gender\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>æ€§åˆ«</FormLabel>\n                      <Select value={field.value} onValueChange={field.onChange}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-gender\">\n                            <SelectValue placeholder=\"é€‰æ‹©æ€§åˆ«\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"Woman\">å¥³æ€§</SelectItem>\n                          <SelectItem value=\"Man\">ç”·æ€§</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"birthdate\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>å‡ºç”Ÿæ—¥æœŸ</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"date\"\n                          {...field}\n                          max={new Date().toISOString().split('T')[0]}\n                          data-testid=\"input-birthdate\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div>\n                  <Label className=\"mb-2 block\">å¸¸ç”¨è¯­è¨€</Label>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {languageOptions.map((lang) => (\n                      <Badge\n                        key={lang}\n                        variant={(form.watch(\"languagesComfort\") || []).includes(lang) ? \"default\" : \"outline\"}\n                        className=\"cursor-pointer\"\n                        onClick={() => toggleArrayItem(\"languagesComfort\", lang)}\n                        data-testid={`badge-language-${lang}`}\n                      >\n                        {lang}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              </>\n            )}\n\n            {section === \"education\" && (\n              <>\n                <FormField\n                  control={form.control}\n                  name=\"educationLevel\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>æ•™è‚²æ°´å¹³</FormLabel>\n                      <Select value={field.value} onValueChange={field.onChange}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-education-level\">\n                            <SelectValue placeholder=\"é€‰æ‹©æ•™è‚²æ°´å¹³\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"High school/below\">é«˜ä¸­åŠä»¥ä¸‹</SelectItem>\n                          <SelectItem value=\"Some college/Associate\">å¤§ä¸“/å‰¯å­¦å£«</SelectItem>\n                          <SelectItem value=\"Bachelor's\">æœ¬ç§‘</SelectItem>\n                          <SelectItem value=\"Master's\">ç¡•å£«</SelectItem>\n                          <SelectItem value=\"Doctorate\">åšå£«</SelectItem>\n                          <SelectItem value=\"Trade/Vocational\">èŒä¸šåŸ¹è®­</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"fieldOfStudy\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>ä¸“ä¸šé¢†åŸŸ</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"ä¾‹å¦‚ï¼šè®¡ç®—æœºç§‘å­¦\" data-testid=\"input-field-of-study\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"studyLocale\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>å­¦ä¹ åœ°ç‚¹</FormLabel>\n                      <Select value={field.value} onValueChange={field.onChange}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-study-locale\">\n                            <SelectValue placeholder=\"é€‰æ‹©å­¦ä¹ åœ°ç‚¹\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"Local\">æœ¬åœ°</SelectItem>\n                          <SelectItem value=\"Overseas\">æµ·å¤–</SelectItem>\n                          <SelectItem value=\"Both\">éƒ½æœ‰</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {(form.watch(\"studyLocale\") === \"Overseas\" || form.watch(\"studyLocale\") === \"Both\") && (\n                  <div>\n                    <Label className=\"mb-2 block\">æµ·å¤–åœ°åŒº</Label>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {overseasRegionOptions.map((region) => (\n                        <Badge\n                          key={region}\n                          variant={((form.watch(\"overseasRegions\") as string[] | undefined) || []).includes(region) ? \"default\" : \"outline\"}\n                          className=\"cursor-pointer\"\n                          onClick={() => toggleArrayItem(\"overseasRegions\", region)}\n                          data-testid={`badge-region-${region}`}\n                        >\n                          {region}\n                        </Badge>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </>\n            )}\n\n            {section === \"work\" && (\n              <>\n                <FormField\n                  control={form.control}\n                  name=\"industry\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>è¡Œä¸š</FormLabel>\n                      <Select value={field.value} onValueChange={field.onChange}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-industry\">\n                            <SelectValue placeholder=\"é€‰æ‹©è¡Œä¸š\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {industryOptions.map((option) => (\n                            <SelectItem key={option} value={option}>\n                              {option}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"roleTitleShort\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>èŒä½ç®€ç§°</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"ä¾‹å¦‚ï¼šäº§å“ç»ç†\" data-testid=\"input-role-title\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"seniority\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>èµ„å†ç­‰çº§</FormLabel>\n                      <Select value={field.value} onValueChange={field.onChange}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-seniority\">\n                            <SelectValue placeholder=\"é€‰æ‹©èµ„å†ç­‰çº§\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"Intern\">å®ä¹ ç”Ÿ</SelectItem>\n                          <SelectItem value=\"Junior\">åˆçº§</SelectItem>\n                          <SelectItem value=\"Mid\">ä¸­çº§</SelectItem>\n                          <SelectItem value=\"Senior\">é«˜çº§</SelectItem>\n                          <SelectItem value=\"Founder\">åˆ›å§‹äºº</SelectItem>\n                          <SelectItem value=\"Executive\">é«˜ç®¡</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </>\n            )}\n\n            {section === \"personal\" && (\n              <>\n                <FormField\n                  control={form.control}\n                  name=\"relationshipStatus\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>å…³ç³»çŠ¶æ€</FormLabel>\n                      <Select value={field.value} onValueChange={field.onChange}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-relationship-status\">\n                            <SelectValue placeholder=\"é€‰æ‹©å…³ç³»çŠ¶æ€\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"Single\">å•èº«</SelectItem>\n                          <SelectItem value=\"In a relationship\">æ‹çˆ±ä¸­</SelectItem>\n                          <SelectItem value=\"Married/Partnered\">å·²å©š/å·²ç»“ä¼´</SelectItem>\n                          <SelectItem value=\"It's complicated\">å¤æ‚</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"children\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>å­©å­çŠ¶å†µ</FormLabel>\n                      <Select value={field.value} onValueChange={field.onChange}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-children\">\n                            <SelectValue placeholder=\"é€‰æ‹©å­©å­çŠ¶å†µ\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"No kids\">æ— å­©å­</SelectItem>\n                          <SelectItem value=\"Expecting\">æœŸå¾…ä¸­</SelectItem>\n                          <SelectItem value=\"0-5\">0-5å²</SelectItem>\n                          <SelectItem value=\"6-12\">6-12å²</SelectItem>\n                          <SelectItem value=\"13-18\">13-18å²</SelectItem>\n                          <SelectItem value=\"Adult\">æˆå¹´</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <p className=\"text-xs text-muted-foreground\">\n                  æç¤ºï¼šæ­¤ä¿¡æ¯ä»…è‡ªå·±å¯è§\n                </p>\n              </>\n            )}\n\n            {section === \"interests\" && (\n              <>\n                <div>\n                  <Label className=\"mb-2 block\">å…´è¶£çˆ±å¥½</Label>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {interestOptions.map((interest) => (\n                      <Badge\n                        key={interest}\n                        variant={((form.watch(\"interestsTop\") as string[] | undefined) || []).includes(interest) ? \"default\" : \"outline\"}\n                        className=\"cursor-pointer\"\n                        onClick={() => toggleArrayItem(\"interestsTop\", interest)}\n                        data-testid={`badge-interest-${interest}`}\n                      >\n                        {interest}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              </>\n            )}\n\n            <DialogFooter className=\"pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => onOpenChange(false)}\n                data-testid=\"button-cancel\"\n              >\n                å–æ¶ˆ\n              </Button>\n              <Button type=\"submit\" data-testid=\"button-save\">\n                ä¿å­˜\n              </Button>\n            </DialogFooter>\n          </form>\n        </Form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":19454},"client/src/components/EditFullProfileDialog.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\n\nconst fullProfileSchema = z.object({\n  displayName: z.string().min(1, \"è¯·è¾“å…¥æ˜µç§°\"),\n  gender: z.string().optional(),\n  birthdate: z.string().optional(),\n  languagesComfort: z.array(z.string()).optional(),\n  educationLevel: z.string().optional(),\n  fieldOfStudy: z.string().optional(),\n  studyLocale: z.string().optional(),\n  overseasRegions: z.array(z.string()).optional(),\n  industry: z.string().optional(),\n  roleTitleShort: z.string().optional(),\n  seniority: z.string().optional(),\n  relationshipStatus: z.string().optional(),\n  children: z.string().optional(),\n  interestsTop: z.array(z.string()).optional(),\n});\n\nconst languageOptions = [\n  \"æ™®é€šè¯\",\n  \"ç²¤è¯­\",\n  \"è‹±è¯­\",\n  \"æ—¥è¯­\",\n  \"éŸ©è¯­\",\n  \"æ³•è¯­\",\n  \"å¾·è¯­\",\n  \"è¥¿ç­ç‰™è¯­\",\n];\n\nconst overseasRegionOptions = [\n  \"åŒ—ç¾\",\n  \"æ¬§æ´²\",\n  \"ä¸œäºš\",\n  \"ä¸œå—äºš\",\n  \"å—äºš\",\n  \"ä¸­ä¸œ\",\n  \"å¤§æ´‹æ´²\",\n  \"æ‹‰ç¾\",\n  \"éæ´²\",\n];\n\nconst industryOptions = [\n  \"å¤§å‚\",\n  \"é‡‘è\",\n  \"ç§‘æŠ€åˆåˆ›\",\n  \"AI/ML\",\n  \"è·¨å¢ƒç”µå•†\",\n  \"æŠ•èµ„\",\n  \"å’¨è¯¢\",\n  \"æ¶ˆè´¹å“\",\n  \"è‰ºæœ¯/è®¾è®¡\",\n  \"æ•™è‚²\",\n  \"åŒ»ç–—\",\n  \"æ”¿åºœ/å…¬å…±\",\n  \"å…¶ä»–\",\n];\n\nconst interestOptions = [\n  \"ç¾é£Ÿæ¢åº—\",\n  \"å’–å•¡\",\n  \"éŸ³ä¹\",\n  \"ç”µå½±\",\n  \"é˜…è¯»\",\n  \"æ—…è¡Œ\",\n  \"å¥èº«\",\n  \"æ‘„å½±\",\n  \"è‰ºæœ¯\",\n  \"ç§‘æŠ€\",\n  \"åˆ›ä¸š\",\n  \"æŠ•èµ„\",\n  \"æ¸¸æˆ\",\n  \"æˆ·å¤–è¿åŠ¨\",\n  \"å® ç‰©\",\n];\n\nconst budgetOptions = [\n  \"100ä»¥ä¸‹\",\n  \"100-200\",\n  \"200-300\",\n  \"300-500\",\n  \"500+\",\n];\n\ninterface EditFullProfileDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  user: any;\n  onSave: (data: any) => void;\n}\n\nexport default function EditFullProfileDialog({\n  open,\n  onOpenChange,\n  user,\n  onSave,\n}: EditFullProfileDialogProps) {\n  const form = useForm({\n    resolver: zodResolver(fullProfileSchema),\n    defaultValues: {\n      displayName: user?.displayName || \"\",\n      gender: user?.gender || \"\",\n      birthdate: user?.birthdate ? new Date(user.birthdate).toISOString().split('T')[0] : \"\",\n      languagesComfort: user?.languagesComfort || [],\n      educationLevel: user?.educationLevel || \"\",\n      fieldOfStudy: user?.fieldOfStudy || \"\",\n      studyLocale: user?.studyLocale || \"\",\n      overseasRegions: user?.overseasRegions || [],\n      industry: user?.industry || \"\",\n      roleTitleShort: user?.roleTitleShort || \"\",\n      seniority: user?.seniority || \"\",\n      relationshipStatus: user?.relationshipStatus || \"\",\n      children: user?.children || \"\",\n      interestsTop: user?.interestsTop || [],\n    },\n  });\n\n  const handleSubmit = (data: any) => {\n    // Remove empty string values to prevent validation errors\n    const cleanedData = Object.fromEntries(\n      Object.entries(data).filter(([_, value]) => {\n        if (typeof value === 'string') return value !== '';\n        if (Array.isArray(value)) return value.length > 0;\n        return value !== null && value !== undefined;\n      })\n    );\n    onSave(cleanedData);\n  };\n\n  const toggleArrayItem = (field: string, value: string) => {\n    const current = (form.watch(field as any) as string[]) || [];\n    if (current.includes(value)) {\n      form.setValue(field as any, current.filter((v: string) => v !== value) as any);\n    } else {\n      form.setValue(field as any, [...current, value] as any);\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-lg max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-edit-full-profile\">\n        <DialogHeader>\n          <DialogTitle>ç¼–è¾‘ä¸ªäººèµ„æ–™</DialogTitle>\n          <DialogDescription className=\"sr-only\">ç¼–è¾‘å®Œæ•´ä¸ªäººèµ„æ–™ä¿¡æ¯</DialogDescription>\n        </DialogHeader>\n\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(handleSubmit)} className=\"space-y-6 py-4\">\n            {/* åŸºæœ¬ä¿¡æ¯ */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-sm font-medium text-muted-foreground\">åŸºæœ¬ä¿¡æ¯</h3>\n              \n              <FormField\n                control={form.control}\n                name=\"displayName\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>æ˜µç§° *</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"è¾“å…¥æ˜µç§°\" data-testid=\"input-display-name\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"gender\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>æ€§åˆ«</FormLabel>\n                    <Select value={field.value} onValueChange={field.onChange}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-gender\">\n                          <SelectValue placeholder=\"é€‰æ‹©æ€§åˆ«\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"Woman\">å¥³æ€§</SelectItem>\n                        <SelectItem value=\"Man\">ç”·æ€§</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"birthdate\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>å‡ºç”Ÿæ—¥æœŸ</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"date\"\n                        {...field}\n                        max={new Date().toISOString().split('T')[0]}\n                        data-testid=\"input-birthdate\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div>\n                <Label className=\"mb-2 block\">å¸¸ç”¨è¯­è¨€</Label>\n                <div className=\"flex flex-wrap gap-2\">\n                  {languageOptions.map((lang) => (\n                    <Badge\n                      key={lang}\n                      variant={(form.watch(\"languagesComfort\") || []).includes(lang) ? \"default\" : \"outline\"}\n                      className=\"cursor-pointer\"\n                      onClick={() => toggleArrayItem(\"languagesComfort\", lang)}\n                      data-testid={`badge-language-${lang}`}\n                    >\n                      {lang}\n                    </Badge>\n                  ))}\n                </div>\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* æ•™è‚²èƒŒæ™¯ */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-sm font-medium text-muted-foreground\">æ•™è‚²èƒŒæ™¯</h3>\n              \n              <FormField\n                control={form.control}\n                name=\"educationLevel\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>æ•™è‚²æ°´å¹³</FormLabel>\n                    <Select value={field.value} onValueChange={field.onChange}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-education-level\">\n                          <SelectValue placeholder=\"é€‰æ‹©æ•™è‚²æ°´å¹³\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"High school/below\">é«˜ä¸­åŠä»¥ä¸‹</SelectItem>\n                        <SelectItem value=\"Some college/Associate\">å¤§ä¸“/å‰¯å­¦å£«</SelectItem>\n                        <SelectItem value=\"Bachelor's\">æœ¬ç§‘</SelectItem>\n                        <SelectItem value=\"Master's\">ç¡•å£«</SelectItem>\n                        <SelectItem value=\"Doctorate\">åšå£«</SelectItem>\n                        <SelectItem value=\"Trade/Vocational\">èŒä¸šåŸ¹è®­</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"fieldOfStudy\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>ä¸“ä¸šé¢†åŸŸ</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"ä¾‹å¦‚ï¼šè®¡ç®—æœºç§‘å­¦\" data-testid=\"input-field-of-study\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"studyLocale\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>å­¦ä¹ åœ°ç‚¹</FormLabel>\n                    <Select value={field.value} onValueChange={field.onChange}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-study-locale\">\n                          <SelectValue placeholder=\"é€‰æ‹©å­¦ä¹ åœ°ç‚¹\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"Local\">æœ¬åœ°</SelectItem>\n                        <SelectItem value=\"Overseas\">æµ·å¤–</SelectItem>\n                        <SelectItem value=\"Both\">éƒ½æœ‰</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              {(form.watch(\"studyLocale\") === \"Overseas\" || form.watch(\"studyLocale\") === \"Both\") && (\n                <div>\n                  <Label className=\"mb-2 block\">æµ·å¤–åœ°åŒº</Label>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {overseasRegionOptions.map((region) => (\n                      <Badge\n                        key={region}\n                        variant={((form.watch(\"overseasRegions\") as string[] | undefined) || []).includes(region) ? \"default\" : \"outline\"}\n                        className=\"cursor-pointer\"\n                        onClick={() => toggleArrayItem(\"overseasRegions\", region)}\n                        data-testid={`badge-region-${region}`}\n                      >\n                        {region}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n            </div>\n\n            <Separator />\n\n            {/* å·¥ä½œä¿¡æ¯ */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-sm font-medium text-muted-foreground\">å·¥ä½œä¿¡æ¯</h3>\n              \n              <FormField\n                control={form.control}\n                name=\"industry\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>è¡Œä¸š</FormLabel>\n                    <Select value={field.value} onValueChange={field.onChange}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-industry\">\n                          <SelectValue placeholder=\"é€‰æ‹©è¡Œä¸š\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {industryOptions.map((option) => (\n                          <SelectItem key={option} value={option}>\n                            {option}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"roleTitleShort\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>èŒä½ç®€ç§°</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"ä¾‹å¦‚ï¼šäº§å“ç»ç†\" data-testid=\"input-role-title\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"seniority\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>èµ„å†ç­‰çº§</FormLabel>\n                    <Select value={field.value} onValueChange={field.onChange}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-seniority\">\n                          <SelectValue placeholder=\"é€‰æ‹©èµ„å†ç­‰çº§\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"Intern\">å®ä¹ ç”Ÿ</SelectItem>\n                        <SelectItem value=\"Junior\">åˆçº§</SelectItem>\n                        <SelectItem value=\"Mid\">ä¸­çº§</SelectItem>\n                        <SelectItem value=\"Senior\">é«˜çº§</SelectItem>\n                        <SelectItem value=\"Founder\">åˆ›å§‹äºº</SelectItem>\n                        <SelectItem value=\"Executive\">é«˜ç®¡</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </div>\n\n            <Separator />\n\n            {/* ä¸ªäººèƒŒæ™¯ */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-sm font-medium text-muted-foreground\">ä¸ªäººèƒŒæ™¯</h3>\n              \n              <FormField\n                control={form.control}\n                name=\"relationshipStatus\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>å…³ç³»çŠ¶æ€</FormLabel>\n                    <Select value={field.value} onValueChange={field.onChange}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-relationship-status\">\n                          <SelectValue placeholder=\"é€‰æ‹©å…³ç³»çŠ¶æ€\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"Single\">å•èº«</SelectItem>\n                        <SelectItem value=\"In a relationship\">æ‹çˆ±ä¸­</SelectItem>\n                        <SelectItem value=\"Married/Partnered\">å·²å©š/å·²ç»“ä¼´</SelectItem>\n                        <SelectItem value=\"It's complicated\">å¤æ‚</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"children\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>å­©å­çŠ¶å†µ</FormLabel>\n                    <Select value={field.value} onValueChange={field.onChange}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-children\">\n                          <SelectValue placeholder=\"é€‰æ‹©å­©å­çŠ¶å†µ\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"No kids\">æ— å­©å­</SelectItem>\n                        <SelectItem value=\"Expecting\">æœŸå¾…ä¸­</SelectItem>\n                        <SelectItem value=\"0-5\">0-5å²</SelectItem>\n                        <SelectItem value=\"6-12\">6-12å²</SelectItem>\n                        <SelectItem value=\"13-18\">13-18å²</SelectItem>\n                        <SelectItem value=\"Adult\">æˆå¹´</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <p className=\"text-xs text-muted-foreground\">\n                æç¤ºï¼šæ­¤ä¿¡æ¯ä»…è‡ªå·±å¯è§\n              </p>\n            </div>\n\n            <Separator />\n\n            {/* å…´è¶£åå¥½ */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-sm font-medium text-muted-foreground\">å…´è¶£åå¥½</h3>\n              \n              <div>\n                <Label className=\"mb-2 block\">å…´è¶£çˆ±å¥½</Label>\n                <div className=\"flex flex-wrap gap-2\">\n                  {interestOptions.map((interest) => (\n                    <Badge\n                      key={interest}\n                      variant={((form.watch(\"interestsTop\") as string[] | undefined) || []).includes(interest) ? \"default\" : \"outline\"}\n                      className=\"cursor-pointer\"\n                      onClick={() => toggleArrayItem(\"interestsTop\", interest)}\n                      data-testid={`badge-interest-${interest}`}\n                    >\n                      {interest}\n                    </Badge>\n                  ))}\n                </div>\n              </div>\n            </div>\n\n            <DialogFooter className=\"pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => onOpenChange(false)}\n                data-testid=\"button-cancel-edit\"\n              >\n                å–æ¶ˆ\n              </Button>\n              <Button type=\"submit\" data-testid=\"button-save-profile\">\n                ä¿å­˜\n              </Button>\n            </DialogFooter>\n          </form>\n        </Form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":18393},"client/src/pages/EditInterestsPage.tsx":{"content":"import { useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Label } from \"@/components/ui/label\";\nimport { ChevronLeft } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\n// Same interest options as InterestsTopicsPage with emojis\nconst INTERESTS_OPTIONS = [\n  { id: \"outdoor_adventure\", label: \"æˆ·å¤–å†’é™©\", emoji: \"ğŸ”ï¸\" },\n  { id: \"sports_fitness\", label: \"è¿åŠ¨å¥èº«\", emoji: \"âš½\" },\n  { id: \"food_dining\", label: \"ç¾é£Ÿæ¢åº—\", emoji: \"ğŸœ\" },\n  { id: \"arts_culture\", label: \"è‰ºæœ¯æ–‡åŒ–\", emoji: \"ğŸ¨\" },\n  { id: \"music_concerts\", label: \"éŸ³ä¹ç°åœº\", emoji: \"ğŸµ\" },\n  { id: \"reading_books\", label: \"é˜…è¯»ä¹¦ç±\", emoji: \"ğŸ“š\" },\n  { id: \"tech_gadgets\", label: \"ç§‘æŠ€æ•°ç \", emoji: \"ğŸ’»\" },\n  { id: \"games_board\", label: \"æ¡Œæ¸¸å¡ç‰Œ\", emoji: \"ğŸ²\" },\n  { id: \"games_video\", label: \"ç”µå­æ¸¸æˆ\", emoji: \"ğŸ®\" },\n  { id: \"photography\", label: \"æ‘„å½±æ‹ç…§\", emoji: \"ğŸ“·\" },\n  { id: \"travel\", label: \"æ—…è¡Œæ¢ç´¢\", emoji: \"âœˆï¸\" },\n  { id: \"diy_crafts\", label: \"æ‰‹å·¥DIY\", emoji: \"âœ‚ï¸\" },\n  { id: \"pets_animals\", label: \"å® ç‰©åŠ¨ç‰©\", emoji: \"ğŸ¶\" },\n  { id: \"volunteering\", label: \"å¿—æ„¿å…¬ç›Š\", emoji: \"ğŸ¤\" },\n  { id: \"entrepreneurship\", label: \"åˆ›ä¸šå•†ä¸š\", emoji: \"ğŸ’¡\" },\n  { id: \"investing\", label: \"æŠ•èµ„ç†è´¢\", emoji: \"ğŸ’°\" },\n  { id: \"meditation\", label: \"å†¥æƒ³æ­£å¿µ\", emoji: \"ğŸ§˜\" },\n  { id: \"languages\", label: \"è¯­è¨€å­¦ä¹ \", emoji: \"ğŸ—£ï¸\" },\n];\n\n// Conversation topics with categories\nconst TOPICS_OPTIONS = [\n  { id: \"career_growth\", label: \"èŒä¸šå‘å±•\", category: \"work\" },\n  { id: \"startup_ideas\", label: \"åˆ›ä¸šæƒ³æ³•\", category: \"work\" },\n  { id: \"tech_trends\", label: \"ç§‘æŠ€è¶‹åŠ¿\", category: \"tech\" },\n  { id: \"ai_future\", label: \"AIä¸æœªæ¥\", category: \"tech\" },\n  { id: \"relationships\", label: \"äººé™…å…³ç³»\", category: \"personal\" },\n  { id: \"dating_love\", label: \"æ‹çˆ±æƒ…æ„Ÿ\", category: \"personal\" },\n  { id: \"mental_health\", label: \"å¿ƒç†å¥åº·\", category: \"personal\" },\n  { id: \"life_philosophy\", label: \"äººç”Ÿå“²å­¦\", category: \"personal\" },\n  { id: \"movies_shows\", label: \"å½±è§†å‰§é›†\", category: \"entertainment\" },\n  { id: \"music_taste\", label: \"éŸ³ä¹å“å‘³\", category: \"entertainment\" },\n  { id: \"travel_stories\", label: \"æ—…è¡Œæ•…äº‹\", category: \"lifestyle\" },\n  { id: \"food_culture\", label: \"ç¾é£Ÿæ–‡åŒ–\", category: \"lifestyle\" },\n  { id: \"fashion_style\", label: \"æ—¶å°šç©¿æ­\", category: \"lifestyle\" },\n  { id: \"current_events\", label: \"æ—¶äº‹æ–°é—»\", category: \"society\" },\n  { id: \"politics\", label: \"æ”¿æ²»è¯é¢˜\", category: \"society\" },\n  { id: \"social_issues\", label: \"ç¤¾ä¼šè®®é¢˜\", category: \"society\" },\n  { id: \"parenting\", label: \"è‚²å„¿ç»éªŒ\", category: \"family\" },\n  { id: \"hobbies_deep\", label: \"å°ä¼—çˆ±å¥½\", category: \"other\" },\n];\n\nconst interestsSchema = z.object({\n  interestsTop: z.array(z.string()).optional(),\n  topicsHappy: z.array(z.string()).optional(),\n  topicsAvoid: z.array(z.string()).optional(),\n});\n\ntype InterestsForm = z.infer<typeof interestsSchema>;\n\nexport default function EditInterestsPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  const { data: user, isLoading } = useQuery<any>({ queryKey: [\"/api/auth/user\"] });\n\n  const form = useForm<InterestsForm>({\n    resolver: zodResolver(interestsSchema),\n    defaultValues: {\n      interestsTop: user?.interestsTop || [],\n      topicsHappy: user?.topicsHappy || [],\n      topicsAvoid: user?.topicsAvoid || [],\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: InterestsForm) => {\n      return await apiRequest(\"PATCH\", \"/api/profile\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"ä¿å­˜æˆåŠŸ\",\n        description: \"å…´è¶£åå¥½å·²æ›´æ–°\",\n      });\n      setLocation(\"/profile/edit\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"ä¿å­˜å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: InterestsForm) => {\n    updateMutation.mutate(data);\n  };\n\n  const toggleInterest = (interestId: string) => {\n    const current = form.watch(\"interestsTop\") || [];\n    if (current.includes(interestId)) {\n      form.setValue(\"interestsTop\", current.filter(i => i !== interestId));\n    } else {\n      form.setValue(\"interestsTop\", [...current, interestId]);\n    }\n  };\n\n  const toggleTopicHappy = (topicId: string) => {\n    const current = form.watch(\"topicsHappy\") || [];\n    if (current.includes(topicId)) {\n      form.setValue(\"topicsHappy\", current.filter(t => t !== topicId));\n    } else {\n      form.setValue(\"topicsHappy\", [...current, topicId]);\n    }\n  };\n\n  const toggleTopicAvoid = (topicId: string) => {\n    const current = form.watch(\"topicsAvoid\") || [];\n    if (current.includes(topicId)) {\n      form.setValue(\"topicsAvoid\", current.filter(t => t !== topicId));\n    } else {\n      form.setValue(\"topicsAvoid\", [...current, topicId]);\n    }\n  };\n\n  if (isLoading || !user) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4\"></div>\n          <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n        </div>\n      </div>\n    );\n  }\n\n  const selectedInterests = form.watch(\"interestsTop\") || [];\n  const selectedTopicsHappy = form.watch(\"topicsHappy\") || [];\n  const selectedTopicsAvoid = form.watch(\"topicsAvoid\") || [];\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <div className=\"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b\">\n        <div className=\"flex items-center h-14 px-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => setLocation(\"/profile/edit\")}\n            data-testid=\"button-back\"\n          >\n            <ChevronLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"ml-2 text-lg font-semibold\">å…´è¶£åå¥½</h1>\n        </div>\n      </div>\n\n      {/* Content */}\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"p-4 space-y-8 max-w-2xl mx-auto pb-24\">\n        {/* Interests Section */}\n        <div className=\"space-y-3\">\n          <div>\n            <Label className=\"text-base font-semibold\">å…´è¶£çˆ±å¥½</Label>\n            <p className=\"text-sm text-muted-foreground mt-1\">é€‰æ‹©ä½ æ„Ÿå…´è¶£çš„æ´»åŠ¨ç±»å‹</p>\n          </div>\n          <div className=\"flex flex-wrap gap-3\">\n            {INTERESTS_OPTIONS.map((interest) => (\n              <Badge\n                key={interest.id}\n                variant={selectedInterests.includes(interest.id) ? \"default\" : \"outline\"}\n                className=\"cursor-pointer text-base px-4 py-2.5\"\n                onClick={() => toggleInterest(interest.id)}\n                data-testid={`badge-interest-${interest.id}`}\n              >\n                <span className=\"mr-1\">{interest.emoji}</span>\n                {interest.label}\n              </Badge>\n            ))}\n          </div>\n        </div>\n\n        {/* Topics Happy Section */}\n        <div className=\"space-y-3\">\n          <div>\n            <Label className=\"text-base font-semibold\">å–œæ¬¢èŠçš„è¯é¢˜</Label>\n            <p className=\"text-sm text-muted-foreground mt-1\">é€‰æ‹©ä½ æ„Ÿå…´è¶£çš„èŠå¤©è¯é¢˜</p>\n          </div>\n          <div className=\"flex flex-wrap gap-3\">\n            {TOPICS_OPTIONS.map((topic) => (\n              <Badge\n                key={topic.id}\n                variant={selectedTopicsHappy.includes(topic.id) ? \"default\" : \"outline\"}\n                className=\"cursor-pointer text-base px-4 py-2.5\"\n                onClick={() => toggleTopicHappy(topic.id)}\n                data-testid={`badge-topic-happy-${topic.id}`}\n              >\n                {topic.label}\n              </Badge>\n            ))}\n          </div>\n        </div>\n\n        {/* Topics Avoid Section */}\n        <div className=\"space-y-3\">\n          <div>\n            <Label className=\"text-base font-semibold\">é¿å…çš„è¯é¢˜</Label>\n            <p className=\"text-sm text-muted-foreground mt-1\">é€‰æ‹©ä½ ä¸æƒ³èŠçš„è¯é¢˜</p>\n          </div>\n          <div className=\"flex flex-wrap gap-3\">\n            {TOPICS_OPTIONS.map((topic) => (\n              <Badge\n                key={topic.id}\n                variant={selectedTopicsAvoid.includes(topic.id) ? \"destructive\" : \"outline\"}\n                className=\"cursor-pointer text-base px-4 py-2.5\"\n                onClick={() => toggleTopicAvoid(topic.id)}\n                data-testid={`badge-topic-avoid-${topic.id}`}\n              >\n                {topic.label}\n              </Badge>\n            ))}\n          </div>\n        </div>\n\n        {/* Save Button */}\n        <div className=\"fixed bottom-0 left-0 right-0 p-4 bg-background border-t\">\n          <Button \n            type=\"submit\" \n            className=\"w-full\"\n            disabled={updateMutation.isPending}\n            data-testid=\"button-save\"\n          >\n            {updateMutation.isPending ? \"ä¿å­˜ä¸­...\" : \"ä¿å­˜\"}\n          </Button>\n        </div>\n      </form>\n    </div>\n  );\n}\n","size_bytes":9572},"client/src/pages/EditWorkPage.tsx":{"content":"import { useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { ChevronLeft } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\nconst workSchema = z.object({\n  industry: z.string().optional(),\n  roleTitleShort: z.string().optional(),\n  seniority: z.enum([\"Intern\", \"Junior\", \"Mid\", \"Senior\", \"Founder\", \"Executive\"]).optional(),\n  workVisibility: z.enum([\"hide_all\", \"show_industry_only\"]).optional(),\n});\n\ntype WorkForm = z.infer<typeof workSchema>;\n\nconst industryOptions = [\n  \"å¤§å‚\", \"é‡‘è\", \"ç§‘æŠ€åˆåˆ›\", \"AI/ML\", \"è·¨å¢ƒç”µå•†\", \"æŠ•èµ„\",\n  \"å’¨è¯¢\", \"æ¶ˆè´¹å“\", \"è‰ºæœ¯/è®¾è®¡\", \"æ•™è‚²\", \"åŒ»ç–—\", \"æ”¿åºœ/å…¬å…±\", \"å…¶ä»–\"\n];\n\nexport default function EditWorkPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  const { data: user, isLoading } = useQuery<any>({ queryKey: [\"/api/auth/user\"] });\n\n  const form = useForm<WorkForm>({\n    resolver: zodResolver(workSchema),\n    defaultValues: {\n      industry: user?.industry || \"\",\n      roleTitleShort: user?.roleTitleShort || \"\",\n      seniority: user?.seniority || undefined,\n      workVisibility: user?.workVisibility || \"show_industry_only\",\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: WorkForm) => {\n      return await apiRequest(\"PATCH\", \"/api/profile\", data);\n    },\n    onSuccess: async () => {\n      await queryClient.refetchQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"ä¿å­˜æˆåŠŸ\",\n        description: \"å·¥ä½œä¿¡æ¯å·²æ›´æ–°\",\n      });\n      setLocation(\"/profile/edit\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"ä¿å­˜å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: WorkForm) => {\n    // Clean up empty strings - send undefined instead of empty string for optional fields\n    const cleanedData = {\n      ...data,\n      industry: data.industry && data.industry.trim() !== '' ? data.industry : undefined,\n      roleTitleShort: data.roleTitleShort && data.roleTitleShort.trim() !== '' ? data.roleTitleShort : undefined,\n    };\n    updateMutation.mutate(cleanedData);\n  };\n\n  if (isLoading || !user) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4\"></div>\n          <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <div className=\"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b\">\n        <div className=\"flex items-center h-14 px-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => setLocation(\"/profile/edit\")}\n            data-testid=\"button-back\"\n          >\n            <ChevronLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"ml-2 text-lg font-semibold\">å·¥ä½œä¿¡æ¯</h1>\n        </div>\n      </div>\n\n      {/* Content */}\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"p-4 space-y-6 max-w-2xl mx-auto pb-24\">\n        {/* Industry */}\n        <div className=\"space-y-2\">\n          <Label>è¡Œä¸š</Label>\n          <div className=\"space-y-3 mt-2\">\n            {industryOptions.map((ind) => (\n              <button\n                key={ind}\n                type=\"button\"\n                onClick={() => form.setValue(\"industry\", ind)}\n                className={`\n                  w-full px-5 py-4 text-left rounded-lg border transition-all text-base\n                  ${form.watch(\"industry\") === ind\n                    ? 'border-primary bg-primary/5 text-primary' \n                    : 'border-border hover-elevate active-elevate-2'\n                  }\n                `}\n                data-testid={`button-industry-${ind}`}\n              >\n                {ind}\n              </button>\n            ))}\n          </div>\n        </div>\n\n        {/* Role Title */}\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"roleTitleShort\">èŒä½</Label>\n          <Input\n            id=\"roleTitleShort\"\n            placeholder=\"ä¾‹å¦‚ï¼šäº§å“ç»ç†ã€è½¯ä»¶å·¥ç¨‹å¸ˆç­‰\"\n            {...form.register(\"roleTitleShort\")}\n            data-testid=\"input-roleTitleShort\"\n          />\n        </div>\n\n        {/* Seniority */}\n        <div className=\"space-y-2\">\n          <Label>èµ„å†</Label>\n          <div className=\"space-y-3 mt-2\">\n            {[\n              { value: \"Intern\", label: \"å®ä¹ ç”Ÿ\" },\n              { value: \"Junior\", label: \"åˆçº§\" },\n              { value: \"Mid\", label: \"ä¸­çº§\" },\n              { value: \"Senior\", label: \"é«˜çº§\" },\n              { value: \"Founder\", label: \"åˆ›å§‹äºº\" },\n              { value: \"Executive\", label: \"é«˜ç®¡\" },\n            ].map((option) => (\n              <button\n                key={option.value}\n                type=\"button\"\n                onClick={() => form.setValue(\"seniority\", option.value as any)}\n                className={`\n                  w-full px-5 py-4 text-left rounded-lg border transition-all text-base\n                  ${form.watch(\"seniority\") === option.value\n                    ? 'border-primary bg-primary/5 text-primary' \n                    : 'border-border hover-elevate active-elevate-2'\n                  }\n                `}\n                data-testid={`button-seniority-${option.value}`}\n              >\n                {option.label}\n              </button>\n            ))}\n          </div>\n        </div>\n\n        {/* Work Visibility */}\n        <div className=\"space-y-2\">\n          <Label>å·¥ä½œä¿¡æ¯å¯è§æ€§</Label>\n          <p className=\"text-xs text-muted-foreground mb-2\">\n            æ§åˆ¶å…¶ä»–äººèƒ½çœ‹åˆ°ä½ çš„å¤šå°‘å·¥ä½œä¿¡æ¯\n          </p>\n          <div className=\"space-y-3\">\n            {[\n              { value: \"hide_all\", label: \"å®Œå…¨éšè—\" },\n              { value: \"show_industry_only\", label: \"ä»…æ˜¾ç¤ºè¡Œä¸š\" },\n            ].map((option) => (\n              <button\n                key={option.value}\n                type=\"button\"\n                onClick={() => form.setValue(\"workVisibility\", option.value as any)}\n                className={`\n                  w-full px-5 py-4 text-left rounded-lg border transition-all text-base\n                  ${form.watch(\"workVisibility\") === option.value\n                    ? 'border-primary bg-primary/5 text-primary' \n                    : 'border-border hover-elevate active-elevate-2'\n                  }\n                `}\n                data-testid={`button-work-visibility-${option.value}`}\n              >\n                {option.label}\n              </button>\n            ))}\n          </div>\n        </div>\n\n        {/* Save Button */}\n        <div className=\"fixed bottom-0 left-0 right-0 p-4 bg-background border-t\">\n          <Button \n            type=\"submit\" \n            className=\"w-full\"\n            disabled={updateMutation.isPending}\n            data-testid=\"button-save\"\n          >\n            {updateMutation.isPending ? \"ä¿å­˜ä¸­...\" : \"ä¿å­˜\"}\n          </Button>\n        </div>\n      </form>\n    </div>\n  );\n}\n","size_bytes":7745},"client/src/pages/EditProfilePage.tsx":{"content":"import { useLocation } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { ChevronLeft, ChevronRight, User, GraduationCap, Briefcase, Heart, Star, Target } from \"lucide-react\";\nimport {\n  getGenderDisplay,\n  calculateAge,\n  formatAge,\n  getEducationDisplay,\n  getStudyLocaleDisplay,\n  getSeniorityDisplay,\n  getRelationshipDisplay,\n  getChildrenDisplay,\n  getIntentDisplay,\n} from \"@/lib/userFieldMappings\";\n\nexport default function EditProfilePage() {\n  const [, setLocation] = useLocation();\n  \n  const { data: user, isLoading } = useQuery<any>({ queryKey: [\"/api/auth/user\"] });\n\n  if (isLoading || !user) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4\"></div>\n          <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n        </div>\n      </div>\n    );\n  }\n\n  const age = user.birthdate ? calculateAge(user.birthdate) : null;\n  const ageDisplay = age ? formatAge(age) : null;\n\n  // Section cards configuration\n  const sections = [\n    {\n      id: \"basic\",\n      title: \"åŸºæœ¬ä¿¡æ¯\",\n      icon: <User className=\"h-4 w-4\" />,\n      path: \"/profile/edit/basic\",\n      fields: [\n        { label: \"æ˜µç§°\", value: user.displayName },\n        { label: \"æ€§åˆ«\", value: user.gender ? getGenderDisplay(user.gender) : null },\n        { label: \"å¹´é¾„\", value: ageDisplay },\n        { label: \"å¸¸ç”¨è¯­è¨€\", value: user.languagesComfort?.join(\", \") },\n      ],\n    },\n    {\n      id: \"personal\",\n      title: \"ä¸ªäººèƒŒæ™¯\",\n      icon: <Heart className=\"h-4 w-4\" />,\n      path: \"/profile/edit/personal\",\n      fields: [\n        { label: \"å…³ç³»çŠ¶æ€\", value: user.relationshipStatus ? getRelationshipDisplay(user.relationshipStatus) : null },\n        { label: \"å­©å­çŠ¶å†µ\", value: user.children ? getChildrenDisplay(user.children) : null },\n      ],\n      hint: \"ğŸ’¡ æç¤ºï¼šæ­¤ä¿¡æ¯ä»…è‡ªå·±å¯è§\",\n    },\n    {\n      id: \"education\",\n      title: \"æ•™è‚²èƒŒæ™¯\",\n      icon: <GraduationCap className=\"h-4 w-4\" />,\n      path: \"/profile/edit/education\",\n      fields: [\n        { label: \"æ•™è‚²æ°´å¹³\", value: user.educationLevel ? getEducationDisplay(user.educationLevel) : null },\n        { label: \"ä¸“ä¸šé¢†åŸŸ\", value: user.fieldOfStudy },\n        { label: \"å­¦ä¹ åœ°ç‚¹\", value: user.studyLocale ? getStudyLocaleDisplay(user.studyLocale) : null },\n        ...(user.studyLocale === \"Overseas\" || user.studyLocale === \"Both\"\n          ? [{ label: \"æµ·å¤–åœ°åŒº\", value: user.overseasRegions?.join(\", \") }]\n          : []),\n      ],\n    },\n    {\n      id: \"work\",\n      title: \"å·¥ä½œä¿¡æ¯\",\n      icon: <Briefcase className=\"h-4 w-4\" />,\n      path: \"/profile/edit/work\",\n      fields: [\n        { label: \"è¡Œä¸š\", value: user.industry },\n        { label: \"èŒä½\", value: user.roleTitleShort },\n        { label: \"èµ„å†\", value: user.seniority ? getSeniorityDisplay(user.seniority) : null },\n      ],\n    },\n    {\n      id: \"intent\",\n      title: \"æ´»åŠ¨æ„å›¾\",\n      icon: <Target className=\"h-4 w-4\" />,\n      path: \"/profile/edit/intent\",\n      fields: [\n        { label: \"é»˜è®¤æ´»åŠ¨æ„å›¾\", value: user.intent ? getIntentDisplay(user.intent) : null },\n      ],\n      hint: \"ğŸ’¡ æç¤ºï¼šè¿™æ˜¯é»˜è®¤è®¾ç½®ï¼ŒåŠ å…¥æ´»åŠ¨æ—¶å¯ä»¥è°ƒæ•´\",\n    },\n    {\n      id: \"interests\",\n      title: \"å…´è¶£åå¥½\",\n      icon: <Star className=\"h-4 w-4\" />,\n      path: \"/profile/edit/interests\",\n      fields: [\n        { label: \"å…´è¶£çˆ±å¥½\", value: user.interestsTop?.join(\", \") },\n        { label: \"å–œæ¬¢èŠçš„è¯é¢˜\", value: user.topicsHappy?.join(\", \") },\n        { label: \"é¿å…çš„è¯é¢˜\", value: user.topicsAvoid?.join(\", \") },\n      ],\n    },\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <div className=\"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b\">\n        <div className=\"flex items-center h-14 px-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => setLocation(\"/profile\")}\n            data-testid=\"button-back\"\n          >\n            <ChevronLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"ml-2 text-lg font-semibold\">ç¼–è¾‘èµ„æ–™</h1>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div className=\"p-4 space-y-3 max-w-2xl mx-auto\">\n        {sections.map((section) => (\n          <Card \n            key={section.id} \n            className=\"border shadow-sm cursor-pointer hover-elevate active-elevate-2 transition-all\"\n            onClick={() => setLocation(section.path)}\n            data-testid={`card-${section.id}`}\n          >\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  {section.icon}\n                  <CardTitle className=\"text-base\">{section.title}</CardTitle>\n                </div>\n                <ChevronRight className=\"h-5 w-5 text-muted-foreground\" />\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-2 text-sm\">\n              {section.fields.map((field, idx) => (\n                <div key={idx} className=\"flex justify-between items-start gap-2\">\n                  <span className=\"text-muted-foreground\">{field.label}</span>\n                  <span className=\"text-right flex-1 font-medium\">\n                    {field.value || <span className=\"text-muted-foreground font-normal\">æœªå¡«å†™</span>}\n                  </span>\n                </div>\n              ))}\n              {section.hint && (\n                <div className=\"text-xs text-muted-foreground pt-2\">\n                  {section.hint}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n}\n","size_bytes":6064},"client/src/pages/EditPersonalPage.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { ChevronLeft, Check } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ntype PersonalData = {\n  relationshipStatus?: string;\n  children?: string;\n};\n\nconst relationshipOptions = [\n  { value: \"Single\", label: \"å•èº«\" },\n  { value: \"In a relationship\", label: \"æ‹çˆ±ä¸­\" },\n  { value: \"Married/Partnered\", label: \"å·²å©š/å·²ç»“ä¼´\" },\n];\n\nconst childrenOptions = [\n  { value: \"No kids\", label: \"æ— å­©å­\" },\n  { value: \"Expecting\", label: \"æœŸå¾…ä¸­\" },\n  { value: \"Has kids\", label: \"æœ‰å­©å­\" },\n];\n\nexport default function EditPersonalPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  const { data: user, isLoading } = useQuery<any>({ queryKey: [\"/api/auth/user\"] });\n  \n  const [relationshipStatus, setRelationshipStatus] = useState<string | undefined>(user?.relationshipStatus);\n  const [children, setChildren] = useState<string | undefined>(user?.children);\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: PersonalData) => {\n      return await apiRequest(\"PATCH\", \"/api/profile\", data);\n    },\n    onSuccess: async () => {\n      await queryClient.refetchQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"ä¿å­˜æˆåŠŸ\",\n        description: \"ä¸ªäººèƒŒæ™¯å·²æ›´æ–°\",\n      });\n      setLocation(\"/profile/edit\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"ä¿å­˜å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSave = () => {\n    updateMutation.mutate({\n      relationshipStatus,\n      children,\n    });\n  };\n\n  if (isLoading || !user) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4\"></div>\n          <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <div className=\"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b\">\n        <div className=\"flex items-center h-14 px-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => setLocation(\"/profile/edit\")}\n            data-testid=\"button-back\"\n          >\n            <ChevronLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"ml-2 text-lg font-semibold\">ä¸ªäººèƒŒæ™¯</h1>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div className=\"p-4 space-y-8 max-w-2xl mx-auto pb-24\">\n        {/* Relationship Status */}\n        <div className=\"space-y-4\">\n          <h2 className=\"text-lg font-semibold\">å…³ç³»çŠ¶æ€</h2>\n          <div className=\"space-y-3\">\n            {relationshipOptions.map((option) => (\n              <button\n                key={option.value}\n                onClick={() => setRelationshipStatus(option.value)}\n                className={`\n                  w-full px-5 py-4 text-left rounded-lg border transition-all\n                  ${relationshipStatus === option.value\n                    ? 'border-primary bg-primary/5 text-primary'\n                    : 'border-border hover-elevate active-elevate-2'\n                  }\n                `}\n                data-testid={`button-relationship-${option.value}`}\n              >\n                <span className=\"text-base\">{option.label}</span>\n              </button>\n            ))}\n          </div>\n        </div>\n\n        {/* Children Status */}\n        <div className=\"space-y-4\">\n          <h2 className=\"text-lg font-semibold\">å­©å­çŠ¶å†µ</h2>\n          <div className=\"space-y-3\">\n            {childrenOptions.map((option) => (\n              <button\n                key={option.value}\n                onClick={() => setChildren(option.value)}\n                className={`\n                  w-full px-5 py-4 text-left rounded-lg border transition-all\n                  ${children === option.value\n                    ? 'border-primary bg-primary/5 text-primary'\n                    : 'border-border hover-elevate active-elevate-2'\n                  }\n                `}\n                data-testid={`button-children-${option.value}`}\n              >\n                <span className=\"text-base\">{option.label}</span>\n              </button>\n            ))}\n          </div>\n        </div>\n\n        {/* Privacy Notice */}\n        <div className=\"text-center text-sm text-muted-foreground\">\n          ğŸ’¡ æç¤ºï¼šæ­¤ä¿¡æ¯ä»…è‡ªå·±å¯è§\n        </div>\n\n        {/* Save Button */}\n        <div className=\"fixed bottom-0 left-0 right-0 p-4 bg-background border-t\">\n          <Button \n            onClick={handleSave}\n            className=\"w-full\"\n            disabled={updateMutation.isPending}\n            data-testid=\"button-save\"\n          >\n            {updateMutation.isPending ? \"ä¿å­˜ä¸­...\" : \"ä¿å­˜\"}\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":5273},"client/src/pages/EditEducationPage.tsx":{"content":"import { useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ChevronLeft } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\n\nconst educationSchema = z.object({\n  educationLevel: z.enum([\"Bachelor's\", \"Master's\", \"PhD\", \"Some college/Associate\", \"Trade/Vocational\"]).optional(),\n  fieldOfStudy: z.string().optional(),\n  studyLocale: z.enum([\"Local\", \"Overseas\", \"Both\"]).optional(),\n  overseasRegions: z.array(z.string()).optional(),\n});\n\ntype EducationForm = z.infer<typeof educationSchema>;\n\nconst overseasRegionOptions = [\n  \"ç¾å›½\", \"è‹±å›½\", \"åŠ æ‹¿å¤§\", \"æ¾³å¤§åˆ©äºš\", \"æ–°è¥¿å…°\",\n  \"æ–°åŠ å¡\", \"é¦™æ¸¯\", \"æ—¥æœ¬\", \"éŸ©å›½\", \"å¾·å›½\", \"æ³•å›½\", \"å…¶ä»–\"\n];\n\nexport default function EditEducationPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  const { data: user, isLoading } = useQuery<any>({ queryKey: [\"/api/auth/user\"] });\n\n  const form = useForm<EducationForm>({\n    resolver: zodResolver(educationSchema),\n    defaultValues: {\n      educationLevel: user?.educationLevel || undefined,\n      fieldOfStudy: user?.fieldOfStudy || \"\",\n      studyLocale: user?.studyLocale || undefined,\n      overseasRegions: user?.overseasRegions || [],\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: EducationForm) => {\n      return await apiRequest(\"PATCH\", \"/api/profile\", data);\n    },\n    onSuccess: async () => {\n      await queryClient.refetchQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"ä¿å­˜æˆåŠŸ\",\n        description: \"æ•™è‚²èƒŒæ™¯å·²æ›´æ–°\",\n      });\n      setLocation(\"/profile/edit\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"ä¿å­˜å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: EducationForm) => {\n    // Clean up empty strings - send undefined instead of empty string for optional fields\n    const cleanedData = {\n      ...data,\n      fieldOfStudy: data.fieldOfStudy && data.fieldOfStudy.trim() !== '' ? data.fieldOfStudy : undefined,\n    };\n    updateMutation.mutate(cleanedData);\n  };\n\n  const toggleRegion = (region: string) => {\n    const current = form.watch(\"overseasRegions\") || [];\n    if (current.includes(region)) {\n      form.setValue(\"overseasRegions\", current.filter(r => r !== region));\n    } else {\n      form.setValue(\"overseasRegions\", [...current, region]);\n    }\n  };\n\n  if (isLoading || !user) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4\"></div>\n          <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n        </div>\n      </div>\n    );\n  }\n\n  const studyLocale = form.watch(\"studyLocale\");\n  const selectedRegions = form.watch(\"overseasRegions\") || [];\n  const showOverseasRegions = studyLocale === \"Overseas\" || studyLocale === \"Both\";\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <div className=\"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b\">\n        <div className=\"flex items-center h-14 px-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => setLocation(\"/profile/edit\")}\n            data-testid=\"button-back\"\n          >\n            <ChevronLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"ml-2 text-lg font-semibold\">æ•™è‚²èƒŒæ™¯</h1>\n        </div>\n      </div>\n\n      {/* Content */}\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"p-4 space-y-6 max-w-2xl mx-auto pb-24\">\n        {/* Education Level */}\n        <div className=\"space-y-2\">\n          <Label>æ•™è‚²æ°´å¹³</Label>\n          <div className=\"space-y-3 mt-2\">\n            {[\n              { value: \"High school/below\", label: \"é«˜ä¸­åŠä»¥ä¸‹\" },\n              { value: \"Some college/Associate\", label: \"å¤§ä¸“/å‰¯å­¦å£«\" },\n              { value: \"Bachelor's\", label: \"æœ¬ç§‘\" },\n              { value: \"Master's\", label: \"ç¡•å£«\" },\n              { value: \"PhD\", label: \"åšå£«\" },\n              { value: \"Trade/Vocational\", label: \"èŒä¸šåŸ¹è®­\" },\n            ].map((option) => (\n              <button\n                key={option.value}\n                type=\"button\"\n                onClick={() => form.setValue(\"educationLevel\", option.value as any)}\n                className={`\n                  w-full px-5 py-4 text-left rounded-lg border transition-all text-base\n                  ${form.watch(\"educationLevel\") === option.value\n                    ? 'border-primary bg-primary/5 text-primary' \n                    : 'border-border hover-elevate active-elevate-2'\n                  }\n                `}\n                data-testid={`button-education-${option.value}`}\n              >\n                {option.label}\n              </button>\n            ))}\n          </div>\n        </div>\n\n        {/* Field of Study */}\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"fieldOfStudy\">ä¸“ä¸šé¢†åŸŸ</Label>\n          <Input\n            id=\"fieldOfStudy\"\n            placeholder=\"ä¾‹å¦‚ï¼šè®¡ç®—æœºç§‘å­¦ã€é‡‘èç­‰\"\n            {...form.register(\"fieldOfStudy\")}\n            data-testid=\"input-fieldOfStudy\"\n          />\n        </div>\n\n        {/* Study Locale */}\n        <div className=\"space-y-2\">\n          <Label>å­¦ä¹ åœ°ç‚¹</Label>\n          <div className=\"space-y-3 mt-2\">\n            {[\n              { value: \"Local\", label: \"æœ¬åœ°\" },\n              { value: \"Overseas\", label: \"æµ·å¤–\" },\n              { value: \"Both\", label: \"éƒ½æœ‰\" },\n            ].map((option) => (\n              <button\n                key={option.value}\n                type=\"button\"\n                onClick={() => form.setValue(\"studyLocale\", option.value as any)}\n                className={`\n                  w-full px-5 py-4 text-left rounded-lg border transition-all text-base\n                  ${form.watch(\"studyLocale\") === option.value\n                    ? 'border-primary bg-primary/5 text-primary' \n                    : 'border-border hover-elevate active-elevate-2'\n                  }\n                `}\n                data-testid={`button-study-locale-${option.value}`}\n              >\n                {option.label}\n              </button>\n            ))}\n          </div>\n        </div>\n\n        {/* Overseas Regions */}\n        {showOverseasRegions && (\n          <div className=\"space-y-3\">\n            <Label>æµ·å¤–åœ°åŒº</Label>\n            <p className=\"text-xs text-muted-foreground\">\n              é€‰æ‹©ä½ åœ¨æµ·å¤–å­¦ä¹ çš„åœ°åŒº\n            </p>\n            <div className=\"grid grid-cols-2 gap-2\">\n              {overseasRegionOptions.map((region) => (\n                <button\n                  key={region}\n                  type=\"button\"\n                  onClick={() => toggleRegion(region)}\n                  className={`\n                    px-5 py-4 rounded-lg border transition-all text-left text-base\n                    ${selectedRegions.includes(region)\n                      ? 'border-primary bg-primary/5 text-primary' \n                      : 'border-border hover-elevate active-elevate-2'\n                    }\n                  `}\n                  data-testid={`button-region-${region}`}\n                >\n                  {region}\n                </button>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Save Button */}\n        <div className=\"fixed bottom-0 left-0 right-0 p-4 bg-background border-t\">\n          <Button \n            type=\"submit\" \n            className=\"w-full\"\n            disabled={updateMutation.isPending}\n            data-testid=\"button-save\"\n          >\n            {updateMutation.isPending ? \"ä¿å­˜ä¸­...\" : \"ä¿å­˜\"}\n          </Button>\n        </div>\n      </form>\n    </div>\n  );\n}\n","size_bytes":8426},"client/src/pages/EditBasicInfoPage.tsx":{"content":"import { useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ChevronLeft } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { DatePicker } from \"@/components/ui/date-picker\";\n\nconst languageOptions = [\"æ™®é€šè¯\", \"è‹±è¯­\", \"ç²¤è¯­\", \"æ³•è¯­\", \"æ—¥è¯­\", \"éŸ©è¯­\", \"è¥¿ç­ç‰™è¯­\", \"å¾·è¯­\"];\n\nconst basicInfoSchema = z.object({\n  displayName: z.string().min(1, \"è¯·è¾“å…¥æ˜µç§°\"),\n  gender: z.enum([\"Woman\", \"Man\"]).optional(),\n  birthdate: z.string().optional(),\n  languagesComfort: z.array(z.string()).optional(),\n});\n\ntype BasicInfoForm = z.infer<typeof basicInfoSchema>;\n\nexport default function EditBasicInfoPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  const { data: user, isLoading } = useQuery<any>({ queryKey: [\"/api/auth/user\"] });\n\n  const form = useForm<BasicInfoForm>({\n    resolver: zodResolver(basicInfoSchema),\n    defaultValues: {\n      displayName: user?.displayName || \"\",\n      gender: user?.gender || undefined,\n      birthdate: user?.birthdate ? new Date(user.birthdate).toISOString().split('T')[0] : \"\",\n      languagesComfort: user?.languagesComfort || [],\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: BasicInfoForm) => {\n      return await apiRequest(\"PATCH\", \"/api/profile\", data);\n    },\n    onSuccess: async () => {\n      await queryClient.refetchQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"ä¿å­˜æˆåŠŸ\",\n        description: \"åŸºæœ¬ä¿¡æ¯å·²æ›´æ–°\",\n      });\n      setLocation(\"/profile/edit\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"ä¿å­˜å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: BasicInfoForm) => {\n    // Clean up empty strings - send undefined instead of empty string for optional fields\n    const cleanedData = {\n      ...data,\n      birthdate: data.birthdate && data.birthdate.trim() !== '' ? data.birthdate : undefined,\n    };\n    updateMutation.mutate(cleanedData);\n  };\n\n  const toggleLanguage = (lang: string) => {\n    const current = form.watch(\"languagesComfort\") || [];\n    if (current.includes(lang)) {\n      form.setValue(\"languagesComfort\", current.filter(l => l !== lang));\n    } else {\n      form.setValue(\"languagesComfort\", [...current, lang]);\n    }\n  };\n\n  if (isLoading || !user) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4\"></div>\n          <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n        </div>\n      </div>\n    );\n  }\n\n  const selectedLanguages = form.watch(\"languagesComfort\") || [];\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <div className=\"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b\">\n        <div className=\"flex items-center h-14 px-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => setLocation(\"/profile/edit\")}\n            data-testid=\"button-back\"\n          >\n            <ChevronLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"ml-2 text-lg font-semibold\">åŸºæœ¬ä¿¡æ¯</h1>\n        </div>\n      </div>\n\n      {/* Content */}\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"p-4 space-y-6 max-w-2xl mx-auto pb-24\">\n        {/* Display Name */}\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"displayName\">æ˜µç§° *</Label>\n          <Input\n            id=\"displayName\"\n            placeholder=\"è¾“å…¥ä½ çš„æ˜µç§°\"\n            {...form.register(\"displayName\")}\n            data-testid=\"input-displayName\"\n          />\n          {form.formState.errors.displayName && (\n            <p className=\"text-sm text-destructive\">{form.formState.errors.displayName.message}</p>\n          )}\n        </div>\n\n        {/* Gender */}\n        <div className=\"space-y-2\">\n          <Label>æ€§åˆ«</Label>\n          <div className=\"space-y-3 mt-2\">\n            {[\n              { value: \"Woman\", label: \"å¥³æ€§\" },\n              { value: \"Man\", label: \"ç”·æ€§\" },\n            ].map((option) => (\n              <button\n                key={option.value}\n                type=\"button\"\n                onClick={() => form.setValue(\"gender\", option.value as \"Woman\" | \"Man\")}\n                className={`\n                  w-full px-5 py-4 text-left rounded-lg border transition-all\n                  ${form.watch(\"gender\") === option.value\n                    ? 'border-primary bg-primary/5 text-primary' \n                    : 'border-border hover-elevate active-elevate-2'\n                  }\n                `}\n                data-testid={`button-gender-${option.value}`}\n              >\n                <span className=\"text-base\">{option.label}</span>\n              </button>\n            ))}\n          </div>\n        </div>\n\n        {/* Birthdate */}\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"birthdate\">ç”Ÿæ—¥</Label>\n          <DatePicker\n            value={form.watch(\"birthdate\") && form.watch(\"birthdate\") !== \"\" ? new Date(form.watch(\"birthdate\")!) : undefined}\n            onChange={(date) => {\n              if (date) {\n                form.setValue(\"birthdate\", date.toISOString().split('T')[0]);\n              } else {\n                form.setValue(\"birthdate\", \"\");\n              }\n            }}\n            maxDate={new Date()}\n            placeholder=\"é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ\"\n            data-testid=\"input-birthdate\"\n          />\n        </div>\n\n        {/* Languages */}\n        <div className=\"space-y-3\">\n          <Label>å¸¸ç”¨è¯­è¨€</Label>\n          <div className=\"flex flex-wrap gap-3\">\n            {languageOptions.map((lang) => (\n              <Badge\n                key={lang}\n                variant={selectedLanguages.includes(lang) ? \"default\" : \"outline\"}\n                className=\"cursor-pointer px-4 py-2 text-base\"\n                onClick={() => toggleLanguage(lang)}\n                data-testid={`badge-language-${lang}`}\n              >\n                {lang}\n              </Badge>\n            ))}\n          </div>\n        </div>\n\n        {/* Save Button */}\n        <div className=\"fixed bottom-0 left-0 right-0 p-4 bg-background border-t\">\n          <Button \n            type=\"submit\" \n            className=\"w-full\"\n            disabled={updateMutation.isPending}\n            data-testid=\"button-save\"\n          >\n            {updateMutation.isPending ? \"ä¿å­˜ä¸­...\" : \"ä¿å­˜\"}\n          </Button>\n        </div>\n      </form>\n    </div>\n  );\n}\n","size_bytes":7220},"client/src/components/UserInfoCard.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ChevronRight } from \"lucide-react\";\nimport { ReactNode } from \"react\";\n\ninterface InfoField {\n  label: string;\n  value: string | string[] | null | undefined;\n  type?: \"text\" | \"badge-list\";\n  placeholder?: string;\n}\n\ninterface UserInfoCardProps {\n  title: string;\n  icon?: ReactNode;\n  fields: InfoField[];\n  editable?: boolean;\n  onEdit?: () => void;\n  className?: string;\n}\n\nexport default function UserInfoCard({\n  title,\n  icon,\n  fields,\n  editable = false,\n  onEdit,\n  className = \"\",\n}: UserInfoCardProps) {\n  const renderValue = (field: InfoField) => {\n    // Handle empty values\n    if (!field.value || (Array.isArray(field.value) && field.value.length === 0)) {\n      return (\n        <span className=\"text-muted-foreground text-sm\">\n          {field.placeholder || \"æœªå¡«å†™\"}\n        </span>\n      );\n    }\n\n    // Handle badge list (arrays)\n    if (field.type === \"badge-list\" && Array.isArray(field.value)) {\n      return (\n        <div className=\"flex flex-wrap gap-1.5 mt-1\">\n          {field.value.map((item, idx) => (\n            <Badge key={idx} variant=\"secondary\" className=\"text-xs\">\n              {item}\n            </Badge>\n          ))}\n        </div>\n      );\n    }\n\n    // Handle text values\n    return (\n      <span className=\"text-foreground text-sm\">\n        {Array.isArray(field.value) ? field.value.join(\"ã€\") : field.value}\n      </span>\n    );\n  };\n\n  return (\n    <Card \n      className={`${className} ${editable ? \"cursor-pointer hover-elevate active-elevate-2\" : \"\"}`}\n      onClick={editable && onEdit ? onEdit : undefined}\n      data-testid={`card-${title.toLowerCase().replace(/\\s+/g, \"-\")}`}\n    >\n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-3\">\n        <CardTitle className=\"text-base font-medium flex items-center gap-2\">\n          {icon}\n          <span>{title}</span>\n        </CardTitle>\n        {editable && (\n          <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n        )}\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        {fields.map((field, idx) => (\n          <div key={idx} className=\"flex flex-col gap-1\">\n            <span className=\"text-xs text-muted-foreground\">{field.label}</span>\n            {renderValue(field)}\n          </div>\n        ))}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":2458},"client/src/pages/EditIntentPage.tsx":{"content":"import { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ChevronLeft } from \"lucide-react\";\nimport { intentOptions } from \"@/lib/userFieldMappings\";\nimport { useEffect } from \"react\";\n\nconst intentSchema = z.object({\n  intent: z.array(z.enum([\"networking\", \"friends\", \"discussion\", \"fun\", \"romance\", \"flexible\"])).min(1, \"è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ´»åŠ¨æ„å›¾\"),\n});\n\ntype IntentForm = z.infer<typeof intentSchema>;\n\nexport default function EditIntentPage() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n\n  const { data: user, isLoading } = useQuery<any>({ queryKey: [\"/api/auth/user\"] });\n\n  const form = useForm<IntentForm>({\n    resolver: zodResolver(intentSchema),\n    defaultValues: {\n      intent: [],\n    },\n  });\n\n  // Update form when user data loads\n  useEffect(() => {\n    if (user?.intent) {\n      form.setValue(\"intent\", Array.isArray(user.intent) ? user.intent : [user.intent]);\n    }\n  }, [user, form]);\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: IntentForm) => {\n      return await apiRequest(\"PATCH\", \"/api/profile\", data);\n    },\n    onSuccess: async () => {\n      await queryClient.refetchQueries({ queryKey: [\"/api/auth/user\"] });\n      toast({\n        title: \"ä¿å­˜æˆåŠŸ\",\n        description: \"æ´»åŠ¨æ„å›¾å·²æ›´æ–°\",\n      });\n      setLocation(\"/profile/edit\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"ä¿å­˜å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Toggle intent selection with flexible exclusivity logic\n  const toggleIntent = (intentValue: \"networking\" | \"friends\" | \"discussion\" | \"fun\" | \"romance\" | \"flexible\") => {\n    const current = form.watch(\"intent\") || [];\n    \n    if (intentValue === \"flexible\") {\n      // If selecting \"flexible\", clear all other intents\n      if (current.includes(\"flexible\")) {\n        form.setValue(\"intent\", []);\n      } else {\n        form.setValue(\"intent\", [\"flexible\"]);\n      }\n    } else {\n      // If selecting a specific intent\n      if (current.includes(intentValue)) {\n        // Deselect this intent\n        form.setValue(\"intent\", current.filter(i => i !== intentValue) as typeof current);\n      } else {\n        // Select this intent and remove \"flexible\" if present\n        const newIntents = current.filter(i => i !== \"flexible\");\n        form.setValue(\"intent\", [...newIntents, intentValue] as typeof current);\n      }\n    }\n  };\n\n  const onSubmit = (data: IntentForm) => {\n    updateMutation.mutate(data);\n  };\n\n  if (isLoading || !user) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4\"></div>\n          <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <div className=\"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b\">\n        <div className=\"flex items-center h-14 px-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => setLocation(\"/profile/edit\")}\n            data-testid=\"button-back\"\n          >\n            <ChevronLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"ml-2 text-lg font-semibold\">æ´»åŠ¨æ„å›¾</h1>\n        </div>\n      </div>\n\n      {/* Content */}\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"p-4 space-y-6 max-w-2xl mx-auto pb-24\">\n        <div className=\"space-y-2\">\n          <Label>é»˜è®¤æ´»åŠ¨æ„å›¾ *</Label>\n          <p className=\"text-xs text-muted-foreground mb-2\">\n            ä½ å‚åŠ æ´»åŠ¨çš„ä¸»è¦ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿè¿™æ˜¯é»˜è®¤è®¾ç½®ï¼ŒåŠ å…¥æ´»åŠ¨æ—¶å¯ä»¥è°ƒæ•´\n          </p>\n          <div className=\"space-y-3 mt-2\">\n            {intentOptions.map((option) => {\n              const currentIntents = form.watch(\"intent\") || [];\n              const isSelected = currentIntents.includes(option.value);\n              const isFlexible = option.value === \"flexible\";\n              const hasFlexible = currentIntents.includes(\"flexible\");\n              const isDisabled = !isFlexible && hasFlexible;\n\n              return (\n                <button\n                  key={option.value}\n                  type=\"button\"\n                  onClick={() => toggleIntent(option.value)}\n                  disabled={isDisabled}\n                  className={`\n                    w-full px-5 py-4 text-left rounded-lg border transition-all\n                    ${isSelected\n                      ? 'border-primary bg-primary/5 text-primary' \n                      : isDisabled\n                      ? 'border-border bg-muted/30 text-muted-foreground cursor-not-allowed'\n                      : 'border-border hover-elevate active-elevate-2'\n                    }\n                  `}\n                  data-testid={`button-intent-${option.value}`}\n                >\n                  <div className=\"flex items-start gap-4\">\n                    <div className={`\n                      mt-1 flex-shrink-0 w-6 h-6 rounded border-2 flex items-center justify-center\n                      ${isSelected \n                        ? 'bg-primary border-primary' \n                        : 'border-border'\n                      }\n                    `}>\n                      {isSelected && (\n                        <svg className=\"w-4 h-4 text-primary-foreground\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={3} d=\"M5 13l4 4L19 7\" />\n                        </svg>\n                      )}\n                    </div>\n                    <div className=\"flex-1\">\n                      <div className=\"font-medium text-base\">{option.label}</div>\n                      <div className=\"text-sm text-muted-foreground mt-1\">{option.description}</div>\n                    </div>\n                  </div>\n                </button>\n              );\n            })}\n          </div>\n          {form.formState.errors.intent && (\n            <p className=\"text-sm text-destructive mt-1\">\n              {form.formState.errors.intent.message}\n            </p>\n          )}\n        </div>\n      </form>\n\n      {/* Bottom action */}\n      <div className=\"fixed bottom-0 left-0 right-0 p-4 bg-background border-t\">\n        <Button \n          onClick={form.handleSubmit(onSubmit)} \n          className=\"w-full\"\n          disabled={updateMutation.isPending}\n          data-testid=\"button-save\"\n        >\n          {updateMutation.isPending ? \"ä¿å­˜ä¸­...\" : \"ä¿å­˜\"}\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":7147},"client/src/components/MiniRadarChart.tsx":{"content":"import { motion } from \"framer-motion\";\n\ninterface MiniRadarChartProps {\n  progress: number; // 0-100\n  answeredQuestions: number;\n  totalQuestions: number;\n}\n\nexport default function MiniRadarChart({ progress, answeredQuestions, totalQuestions }: MiniRadarChartProps) {\n  // Calculate how many dimensions to show based on progress\n  const dimensionsToShow = Math.min(6, Math.floor((answeredQuestions / totalQuestions) * 6) + 1);\n  \n  // Mock data that \"grows\" as user answers\n  const dimensions = [\n    { label: \"äº²\", value: progress * 0.7 },\n    { label: \"å¼€\", value: progress * 0.8 },\n    { label: \"ä¸¥\", value: progress * 0.6 },\n    { label: \"ç¨³\", value: progress * 0.75 },\n    { label: \"å¤–\", value: progress * 0.65 },\n    { label: \"æ­£\", value: progress * 0.85 },\n  ];\n\n  const size = 60;\n  const center = size / 2;\n  const maxRadius = size / 2 - 8;\n\n  // Calculate polygon points\n  const calculatePoint = (value: number, index: number, total: number) => {\n    const angle = (Math.PI * 2 * index) / total - Math.PI / 2;\n    const radius = (value / 100) * maxRadius;\n    const x = center + radius * Math.cos(angle);\n    const y = center + radius * Math.sin(angle);\n    return `${x},${y}`;\n  };\n\n  const visibleDimensions = dimensions.slice(0, dimensionsToShow);\n  const points = visibleDimensions.map((dim, i) => \n    calculatePoint(dim.value, i, dimensionsToShow)\n  ).join(' ');\n\n  return (\n    <div className=\"relative inline-block\">\n      <svg width={size} height={size} className=\"overflow-visible\">\n        {/* Background circles */}\n        {[20, 40, 60, 80, 100].map((percent, i) => (\n          <circle\n            key={i}\n            cx={center}\n            cy={center}\n            r={(maxRadius * percent) / 100}\n            fill=\"none\"\n            stroke=\"hsl(var(--muted))\"\n            strokeWidth=\"0.5\"\n            opacity={0.3}\n          />\n        ))}\n\n        {/* Axis lines */}\n        {visibleDimensions.map((_, i) => {\n          const angle = (Math.PI * 2 * i) / dimensionsToShow - Math.PI / 2;\n          const x2 = center + maxRadius * Math.cos(angle);\n          const y2 = center + maxRadius * Math.sin(angle);\n          return (\n            <motion.line\n              key={i}\n              x1={center}\n              y1={center}\n              x2={x2}\n              y2={y2}\n              stroke=\"hsl(var(--muted))\"\n              strokeWidth=\"0.5\"\n              opacity={0.4}\n              initial={{ pathLength: 0 }}\n              animate={{ pathLength: 1 }}\n              transition={{ duration: 0.5, delay: i * 0.1 }}\n            />\n          );\n        })}\n\n        {/* Data polygon */}\n        {visibleDimensions.length >= 3 && (\n          <motion.polygon\n            points={points}\n            fill=\"hsl(var(--primary))\"\n            fillOpacity={0.3}\n            stroke=\"hsl(var(--primary))\"\n            strokeWidth=\"1.5\"\n            initial={{ scale: 0, opacity: 0 }}\n            animate={{ scale: 1, opacity: 1 }}\n            transition={{ duration: 0.5 }}\n          />\n        )}\n\n        {/* Data points */}\n        {visibleDimensions.map((dim, i) => {\n          const angle = (Math.PI * 2 * i) / dimensionsToShow - Math.PI / 2;\n          const radius = (dim.value / 100) * maxRadius;\n          const x = center + radius * Math.cos(angle);\n          const y = center + radius * Math.sin(angle);\n          return (\n            <motion.circle\n              key={i}\n              cx={x}\n              cy={y}\n              r=\"2\"\n              fill=\"hsl(var(--primary))\"\n              initial={{ scale: 0 }}\n              animate={{ scale: 1 }}\n              transition={{ delay: 0.3 + i * 0.05 }}\n            />\n          );\n        })}\n      </svg>\n\n      {/* Growing indicator */}\n      {answeredQuestions > 0 && answeredQuestions < totalQuestions && (\n        <motion.div\n          initial={{ opacity: 0, scale: 0 }}\n          animate={{ opacity: 1, scale: 1 }}\n          className=\"absolute -bottom-1 -right-1 bg-primary text-primary-foreground text-[10px] rounded-full w-4 h-4 flex items-center justify-center font-bold\"\n        >\n          âœ¨\n        </motion.div>\n      )}\n    </div>\n  );\n}\n","size_bytes":4132},"client/src/lib/archetypeAvatars.ts":{"content":"// 12-Archetype Animal Social Vibe System\n// Avatar image mapping system with high-res illustrations\n\nimport corgiImg from '@assets/å¼€å¿ƒæŸ¯åŸº_1763997660297.png';\nimport chickenImg from '@assets/å¤ªé˜³é¸¡_1763997660294.png';\nimport dolphinImg from '@assets/å¤¸å¤¸è±š_1763997660288.png';\nimport foxImg from '@assets/æœºæ™ºç‹_1763997660293.png';\nimport calmDolphinImg from '@assets/æ·¡å®šæµ·è±š_1763997660293.png';\nimport spiderImg from '@assets/ç»‡ç½‘è››_1763997660291.png';\nimport bearImg from '@assets/æš–å¿ƒç†Š_1763997660292.png';\nimport octopusImg from '@assets/çµæ„Ÿç« é±¼_1763997660292.png';\nimport owlImg from '@assets/æ²‰æ€çŒ«å¤´é¹°_1763997660294.png';\nimport elephantImg from '@assets/å®šå¿ƒå¤§è±¡_1763997660293.png';\nimport turtleImg from '@assets/ç¨³å¦‚é¾Ÿ_1763997660291.png';\nimport catImg from '@assets/éšèº«çŒ«_1763997660297.png';\n\nexport const archetypeAvatars: Record<string, string> = {\n  'å¼€å¿ƒæŸ¯åŸº': corgiImg,\n  'å¤ªé˜³é¸¡': chickenImg,\n  'å¤¸å¤¸è±š': dolphinImg,\n  'æœºæ™ºç‹': foxImg,\n  'æ·¡å®šæµ·è±š': calmDolphinImg,\n  'ç»‡ç½‘è››': spiderImg,\n  'æš–å¿ƒç†Š': bearImg,\n  'çµæ„Ÿç« é±¼': octopusImg,\n  'æ²‰æ€çŒ«å¤´é¹°': owlImg,\n  'å®šå¿ƒå¤§è±¡': elephantImg,\n  'ç¨³å¦‚é¾Ÿ': turtleImg,\n  'éšèº«çŒ«': catImg,\n};\n\n// Gradient backgrounds for each archetype (energy-based color mapping)\nexport const archetypeGradients: Record<string, string> = {\n  'å¼€å¿ƒæŸ¯åŸº': 'from-yellow-500 via-orange-500 to-red-500',      // High energy\n  'å¤ªé˜³é¸¡': 'from-amber-500 via-yellow-500 to-orange-500',       // High energy\n  'å¤¸å¤¸è±š': 'from-cyan-500 via-blue-500 to-indigo-500',         // High energy\n  'æœºæ™ºç‹': 'from-orange-500 via-red-500 to-pink-500',          // High energy\n  'æ·¡å®šæµ·è±š': 'from-blue-500 via-indigo-500 to-purple-500',      // Medium energy\n  'ç»‡ç½‘è››': 'from-purple-500 via-pink-500 to-fuchsia-500',      // Medium energy\n  'æš–å¿ƒç†Š': 'from-rose-500 via-pink-500 to-red-500',            // Medium energy\n  'çµæ„Ÿç« é±¼': 'from-violet-500 via-purple-500 to-indigo-500',    // Medium energy\n  'æ²‰æ€çŒ«å¤´é¹°': 'from-slate-500 via-gray-500 to-zinc-500',        // Low energy\n  'å®šå¿ƒå¤§è±¡': 'from-gray-500 via-slate-500 to-stone-500',        // Low energy\n  'ç¨³å¦‚é¾Ÿ': 'from-green-500 via-emerald-500 to-teal-500',       // Very low energy\n  'éšèº«çŒ«': 'from-indigo-500 via-purple-500 to-violet-500',     // Very low energy\n};\n\n// Animal emoji avatars (primary visual representation)\nexport const archetypeEmojis: Record<string, string> = {\n  'å¼€å¿ƒæŸ¯åŸº': 'ğŸ•',\n  'å¤ªé˜³é¸¡': 'ğŸ“',\n  'å¤¸å¤¸è±š': 'ğŸ¬',\n  'æœºæ™ºç‹': 'ğŸ¦Š',\n  'æ·¡å®šæµ·è±š': 'ğŸ¬',\n  'ç»‡ç½‘è››': 'ğŸ•·ï¸',\n  'æš–å¿ƒç†Š': 'ğŸ»',\n  'çµæ„Ÿç« é±¼': 'ğŸ™',\n  'æ²‰æ€çŒ«å¤´é¹°': 'ğŸ¦‰',\n  'å®šå¿ƒå¤§è±¡': 'ğŸ˜',\n  'ç¨³å¦‚é¾Ÿ': 'ğŸ¢',\n  'éšèº«çŒ«': 'ğŸ±',\n};\n","size_bytes":2800},"client/src/pages/admin/AdminCouponsPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Ticket, Plus, Edit, TrendingUp, Users, DollarSign } from \"lucide-react\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { format, isPast, isFuture } from \"date-fns\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface Coupon {\n  id: string;\n  code: string;\n  discount_type: string;\n  discount_value: number;\n  valid_from: string;\n  valid_until: string | null;\n  usage_limit: number | null;\n  is_active: boolean;\n  created_at: string;\n  used_count: string;\n}\n\nexport default function AdminCouponsPage() {\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [selectedCoupon, setSelectedCoupon] = useState<Coupon | null>(null);\n  const [showUsageDialog, setShowUsageDialog] = useState(false);\n  \n  const [formData, setFormData] = useState({\n    code: \"\",\n    discountType: \"percentage\",\n    discountValue: \"\",\n    validFrom: \"\",\n    validUntil: \"\",\n    maxUses: \"\",\n  });\n\n  const { toast } = useToast();\n\n  const { data: coupons = [], isLoading } = useQuery<Coupon[]>({\n    queryKey: [\"/api/admin/coupons\"],\n  });\n\n  const { data: usageStats = [] } = useQuery<any[]>({\n    queryKey: [\"/api/admin/coupons\", selectedCoupon?.id, \"usage\"],\n    enabled: !!selectedCoupon && showUsageDialog,\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: any) =>\n      fetch(\"/api/admin/coupons\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      }).then((r) => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/coupons\"] });\n      setShowCreateDialog(false);\n      resetForm();\n      toast({\n        title: \"ä¼˜æƒ åˆ¸åˆ›å»ºæˆåŠŸ\",\n        description: \"ä¼˜æƒ åˆ¸å·²æˆåŠŸåˆ›å»º\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"åˆ›å»ºå¤±è´¥\",\n        description: \"æ— æ³•åˆ›å»ºä¼˜æƒ åˆ¸ï¼Œè¯·é‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) =>\n      fetch(`/api/admin/coupons/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      }).then((r) => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/coupons\"] });\n      setShowEditDialog(false);\n      setSelectedCoupon(null);\n      toast({\n        title: \"æ›´æ–°æˆåŠŸ\",\n        description: \"ä¼˜æƒ åˆ¸å·²æ›´æ–°\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      code: \"\",\n      discountType: \"percentage\",\n      discountValue: \"\",\n      validFrom: \"\",\n      validUntil: \"\",\n      maxUses: \"\",\n    });\n  };\n\n  const handleCreate = () => {\n    if (!formData.code || !formData.discountValue) {\n      toast({\n        title: \"ä¿¡æ¯ä¸å®Œæ•´\",\n        description: \"è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    createMutation.mutate({\n      code: formData.code,\n      discountType: formData.discountType,\n      discountValue: parseFloat(formData.discountValue),\n      validFrom: formData.validFrom || undefined,\n      validUntil: formData.validUntil || undefined,\n      maxUses: formData.maxUses ? parseInt(formData.maxUses) : undefined,\n    });\n  };\n\n  const handleEdit = (coupon: Coupon) => {\n    setSelectedCoupon(coupon);\n    setFormData({\n      code: coupon.code,\n      discountType: coupon.discount_type,\n      discountValue: coupon.discount_value.toString(),\n      validFrom: coupon.valid_from ? format(new Date(coupon.valid_from), \"yyyy-MM-dd\") : \"\",\n      validUntil: coupon.valid_until ? format(new Date(coupon.valid_until), \"yyyy-MM-dd\") : \"\",\n      maxUses: coupon.max_uses?.toString() || \"\",\n    });\n    setShowEditDialog(true);\n  };\n\n  const handleUpdate = () => {\n    if (!selectedCoupon) return;\n\n    updateMutation.mutate({\n      id: selectedCoupon.id,\n      data: {\n        code: formData.code,\n        discountType: formData.discountType,\n        discountValue: parseFloat(formData.discountValue),\n        validFrom: formData.validFrom || undefined,\n        validUntil: formData.validUntil || undefined,\n        maxUses: formData.maxUses ? parseInt(formData.maxUses) : null,\n      },\n    });\n  };\n\n  const toggleActive = (coupon: Coupon) => {\n    updateMutation.mutate({\n      id: coupon.id,\n      data: { isActive: !coupon.is_active },\n    });\n  };\n\n  const viewUsage = (coupon: Coupon) => {\n    setSelectedCoupon(coupon);\n    setShowUsageDialog(true);\n  };\n\n  const getStatusBadge = (coupon: Coupon) => {\n    if (!coupon.is_active) {\n      return <Badge variant=\"secondary\">å·²ç¦ç”¨</Badge>;\n    }\n    if (coupon.valid_until && isPast(new Date(coupon.valid_until))) {\n      return <Badge variant=\"destructive\">å·²è¿‡æœŸ</Badge>;\n    }\n    if (coupon.usage_limit && parseInt(coupon.used_count) >= coupon.usage_limit) {\n      return <Badge variant=\"secondary\">å·²ç”¨å®Œ</Badge>;\n    }\n    return <Badge className=\"bg-green-500\">æ´»è·ƒ</Badge>;\n  };\n\n  const getDiscountDisplay = (coupon: Coupon) => {\n    if (coupon.discount_type === \"percentage\") {\n      return `${coupon.discount_value}% æŠ˜æ‰£`;\n    }\n    return `Â¥${coupon.discount_value} å‡å…`;\n  };\n\n  const activeCoupons = coupons.filter(\n    (c) => c.is_active && (!c.valid_until || isFuture(new Date(c.valid_until)))\n  ).length;\n\n  const totalUsage = coupons.reduce((sum, c) => sum + parseInt(c.used_count || \"0\"), 0);\n\n  return (\n    <div className=\"p-8 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">ä¼˜æƒ åˆ¸ç®¡ç†</h1>\n          <p className=\"text-muted-foreground mt-1\">åˆ›å»ºå’Œç®¡ç†å¹³å°ä¼˜æƒ åˆ¸</p>\n        </div>\n        <Button onClick={() => setShowCreateDialog(true)} data-testid=\"button-create-coupon\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          åˆ›å»ºä¼˜æƒ åˆ¸\n        </Button>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ´»è·ƒä¼˜æƒ åˆ¸</CardTitle>\n            <Ticket className=\"h-4 w-4 text-primary\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{activeCoupons}</div>\n            <p className=\"text-xs text-muted-foreground\">å½“å‰å¯ç”¨ä¼˜æƒ åˆ¸</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ€»ä¼˜æƒ åˆ¸æ•°</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-blue-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{coupons.length}</div>\n            <p className=\"text-xs text-muted-foreground\">å†å²åˆ›å»ºæ€»æ•°</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ€»ä½¿ç”¨æ¬¡æ•°</CardTitle>\n            <Users className=\"h-4 w-4 text-green-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{totalUsage}</div>\n            <p className=\"text-xs text-muted-foreground\">ç´¯è®¡ä½¿ç”¨æ¬¡æ•°</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">ä¼˜æƒ æ€»é¢</CardTitle>\n            <DollarSign className=\"h-4 w-4 text-amber-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">--</div>\n            <p className=\"text-xs text-muted-foreground\">å¾…ç»Ÿè®¡</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader className=\"space-y-2\">\n                <div className=\"h-4 bg-muted rounded w-3/4\" />\n                <div className=\"h-3 bg-muted rounded w-1/2\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2\">\n                  <div className=\"h-3 bg-muted rounded\" />\n                  <div className=\"h-3 bg-muted rounded w-5/6\" />\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : coupons.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-12 text-center text-muted-foreground\">\n            æš‚æ— ä¼˜æƒ åˆ¸è®°å½•\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {coupons.map((coupon) => (\n            <Card key={coupon.id} data-testid={`card-coupon-${coupon.id}`}>\n              <CardHeader className=\"flex flex-row items-start justify-between gap-2 space-y-0 pb-3\">\n                <div className=\"flex-1 min-w-0\">\n                  <CardTitle className=\"text-lg font-bold\">{coupon.code}</CardTitle>\n                  <p className=\"text-sm text-muted-foreground\">{getDiscountDisplay(coupon)}</p>\n                </div>\n                {getStatusBadge(coupon)}\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                <div className=\"space-y-2 text-sm\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">ä½¿ç”¨æ¬¡æ•°</span>\n                    <span className=\"font-medium\">\n                      {coupon.used_count}\n                      {coupon.usage_limit && ` / ${coupon.usage_limit}`}\n                    </span>\n                  </div>\n                  {coupon.valid_from && (\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">å¼€å§‹æ—¥æœŸ</span>\n                      <span className=\"font-medium\">\n                        {format(new Date(coupon.valid_from), \"yyyy/MM/dd\")}\n                      </span>\n                    </div>\n                  )}\n                  {coupon.valid_until && (\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">ç»“æŸæ—¥æœŸ</span>\n                      <span className=\"font-medium\">\n                        {format(new Date(coupon.valid_until), \"yyyy/MM/dd\")}\n                      </span>\n                    </div>\n                  )}\n                </div>\n                <div className=\"flex gap-2 pt-2 border-t\">\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    className=\"flex-1\"\n                    onClick={() => handleEdit(coupon)}\n                    data-testid={`button-edit-${coupon.id}`}\n                  >\n                    <Edit className=\"h-3 w-3 mr-1\" />\n                    ç¼–è¾‘\n                  </Button>\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    className=\"flex-1\"\n                    onClick={() => viewUsage(coupon)}\n                    data-testid={`button-usage-${coupon.id}`}\n                  >\n                    æŸ¥çœ‹ä½¿ç”¨\n                  </Button>\n                  <Button\n                    size=\"sm\"\n                    variant={coupon.is_active ? \"destructive\" : \"default\"}\n                    onClick={() => toggleActive(coupon)}\n                    data-testid={`button-toggle-${coupon.id}`}\n                  >\n                    {coupon.is_active ? \"ç¦ç”¨\" : \"å¯ç”¨\"}\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>åˆ›å»ºä¼˜æƒ åˆ¸</DialogTitle>\n            <DialogDescription>åˆ›å»ºæ–°çš„ä¼˜æƒ åˆ¸ä»£ç </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"code\">ä¼˜æƒ ç  *</Label>\n              <Input\n                id=\"code\"\n                placeholder=\"SUMMER2024\"\n                value={formData.code}\n                onChange={(e) => setFormData({ ...formData, code: e.target.value.toUpperCase() })}\n                data-testid=\"input-code\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"discountType\">æŠ˜æ‰£ç±»å‹ *</Label>\n              <Select value={formData.discountType} onValueChange={(v) => setFormData({ ...formData, discountType: v })}>\n                <SelectTrigger data-testid=\"select-discount-type\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"percentage\">ç™¾åˆ†æ¯”æŠ˜æ‰£</SelectItem>\n                  <SelectItem value=\"fixed\">å›ºå®šé‡‘é¢</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"discountValue\">\n                æŠ˜æ‰£æ•°å€¼ * {formData.discountType === \"percentage\" ? \"(0-100)\" : \"(Â¥)\"}\n              </Label>\n              <Input\n                id=\"discountValue\"\n                type=\"number\"\n                min=\"0\"\n                max={formData.discountType === \"percentage\" ? \"100\" : undefined}\n                placeholder={formData.discountType === \"percentage\" ? \"20\" : \"50\"}\n                value={formData.discountValue}\n                onChange={(e) => setFormData({ ...formData, discountValue: e.target.value })}\n                data-testid=\"input-discount-value\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"validFrom\">å¼€å§‹æ—¥æœŸ</Label>\n                <Input\n                  id=\"validFrom\"\n                  type=\"date\"\n                  value={formData.validFrom}\n                  onChange={(e) => setFormData({ ...formData, validFrom: e.target.value })}\n                  data-testid=\"input-valid-from\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"validUntil\">ç»“æŸæ—¥æœŸ</Label>\n                <Input\n                  id=\"validUntil\"\n                  type=\"date\"\n                  value={formData.validUntil}\n                  onChange={(e) => setFormData({ ...formData, validUntil: e.target.value })}\n                  data-testid=\"input-valid-until\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"maxUses\">æœ€å¤§ä½¿ç”¨æ¬¡æ•°ï¼ˆç•™ç©ºä¸ºæ— é™åˆ¶ï¼‰</Label>\n              <Input\n                id=\"maxUses\"\n                type=\"number\"\n                min=\"1\"\n                placeholder=\"100\"\n                value={formData.maxUses}\n                onChange={(e) => setFormData({ ...formData, maxUses: e.target.value })}\n                data-testid=\"input-max-uses\"\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => { setShowCreateDialog(false); resetForm(); }} data-testid=\"button-cancel\">\n              å–æ¶ˆ\n            </Button>\n            <Button onClick={handleCreate} disabled={createMutation.isPending} data-testid=\"button-submit-coupon\">\n              {createMutation.isPending ? \"åˆ›å»ºä¸­...\" : \"åˆ›å»ºä¼˜æƒ åˆ¸\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showEditDialog} onOpenChange={setShowEditDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>ç¼–è¾‘ä¼˜æƒ åˆ¸</DialogTitle>\n            <DialogDescription>ä¿®æ”¹ä¼˜æƒ åˆ¸ä¿¡æ¯</DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-code\">ä¼˜æƒ ç </Label>\n              <Input\n                id=\"edit-code\"\n                value={formData.code}\n                onChange={(e) => setFormData({ ...formData, code: e.target.value.toUpperCase() })}\n                data-testid=\"input-edit-code\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-discountValue\">\n                æŠ˜æ‰£æ•°å€¼ {formData.discountType === \"percentage\" ? \"(0-100)\" : \"(Â¥)\"}\n              </Label>\n              <Input\n                id=\"edit-discountValue\"\n                type=\"number\"\n                value={formData.discountValue}\n                onChange={(e) => setFormData({ ...formData, discountValue: e.target.value })}\n                data-testid=\"input-edit-discount-value\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-validFrom\">å¼€å§‹æ—¥æœŸ</Label>\n                <Input\n                  id=\"edit-validFrom\"\n                  type=\"date\"\n                  value={formData.validFrom}\n                  onChange={(e) => setFormData({ ...formData, validFrom: e.target.value })}\n                  data-testid=\"input-edit-valid-from\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-validUntil\">ç»“æŸæ—¥æœŸ</Label>\n                <Input\n                  id=\"edit-validUntil\"\n                  type=\"date\"\n                  value={formData.validUntil}\n                  onChange={(e) => setFormData({ ...formData, validUntil: e.target.value })}\n                  data-testid=\"input-edit-valid-until\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-maxUses\">æœ€å¤§ä½¿ç”¨æ¬¡æ•°</Label>\n              <Input\n                id=\"edit-maxUses\"\n                type=\"number\"\n                value={formData.maxUses}\n                onChange={(e) => setFormData({ ...formData, maxUses: e.target.value })}\n                data-testid=\"input-edit-max-uses\"\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowEditDialog(false)} data-testid=\"button-cancel-edit\">\n              å–æ¶ˆ\n            </Button>\n            <Button onClick={handleUpdate} disabled={updateMutation.isPending} data-testid=\"button-submit-edit\">\n              {updateMutation.isPending ? \"æ›´æ–°ä¸­...\" : \"æ›´æ–°ä¼˜æƒ åˆ¸\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showUsageDialog} onOpenChange={setShowUsageDialog}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>ä½¿ç”¨è®°å½• - {selectedCoupon?.code}</DialogTitle>\n            <DialogDescription>æŸ¥çœ‹ä¼˜æƒ åˆ¸ä½¿ç”¨è¯¦æƒ…</DialogDescription>\n          </DialogHeader>\n\n          <div className=\"py-4\">\n            {usageStats.length === 0 ? (\n              <p className=\"text-center text-muted-foreground py-8\">æš‚æ— ä½¿ç”¨è®°å½•</p>\n            ) : (\n              <div className=\"space-y-2 max-h-96 overflow-y-auto\">\n                {usageStats.map((usage: any, index: number) => (\n                  <Card key={index}>\n                    <CardContent className=\"py-3\">\n                      <div className=\"flex justify-between items-center\">\n                        <div>\n                          <p className=\"font-medium\">\n                            {usage.first_name} {usage.last_name}\n                          </p>\n                          <p className=\"text-sm text-muted-foreground\">{usage.email}</p>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"text-sm font-medium\">\n                            {format(new Date(usage.used_at), \"yyyy/MM/dd HH:mm\")}\n                          </p>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            )}\n          </div>\n\n          <DialogFooter>\n            <Button onClick={() => setShowUsageDialog(false)} data-testid=\"button-close-usage\">\n              å…³é—­\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":21512},"client/src/pages/admin/AdminSubscriptionsPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Crown, Calendar, TrendingUp, DollarSign, Users, Plus } from \"lucide-react\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { format, differenceInDays } from \"date-fns\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface Subscription {\n  id: string;\n  user_id: string;\n  first_name: string;\n  last_name: string;\n  email: string;\n  phone_number: string;\n  plan_type: string;\n  start_date: string;\n  end_date: string;\n  is_active: boolean;\n  auto_renew: boolean;\n  created_at: string;\n}\n\nexport default function AdminSubscriptionsPage() {\n  const [filterStatus, setFilterStatus] = useState<\"all\" | \"active\">(\"active\");\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [selectedUserId, setSelectedUserId] = useState(\"\");\n  const [planType, setPlanType] = useState(\"monthly\");\n  const [durationMonths, setDurationMonths] = useState(\"1\");\n  const { toast } = useToast();\n\n  const { data: subscriptions = [], isLoading } = useQuery<Subscription[]>({\n    queryKey: [\"/api/admin/subscriptions\", { filter: filterStatus === \"all\" ? undefined : filterStatus }],\n  });\n\n  const { data: users = [] } = useQuery<any[]>({\n    queryKey: [\"/api/admin/users\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: any) =>\n      fetch(\"/api/admin/subscriptions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      }).then((r) => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/subscriptions\"] });\n      setShowCreateDialog(false);\n      setSelectedUserId(\"\");\n      setPlanType(\"monthly\");\n      setDurationMonths(\"1\");\n      toast({\n        title: \"è®¢é˜…åˆ›å»ºæˆåŠŸ\",\n        description: \"ç”¨æˆ·è®¢é˜…å·²æˆåŠŸåˆ›å»º\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"åˆ›å»ºå¤±è´¥\",\n        description: \"æ— æ³•åˆ›å»ºè®¢é˜…ï¼Œè¯·é‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleCreateSubscription = () => {\n    if (!selectedUserId || !planType || !durationMonths) {\n      toast({\n        title: \"ä¿¡æ¯ä¸å®Œæ•´\",\n        description: \"è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    createMutation.mutate({\n      userId: selectedUserId,\n      planType,\n      durationMonths: parseInt(durationMonths),\n    });\n  };\n\n  const getStatusBadge = (subscription: Subscription) => {\n    const daysUntilExpiry = differenceInDays(new Date(subscription.end_date), new Date());\n    \n    if (!subscription.is_active) {\n      return <Badge variant=\"secondary\">å·²åœç”¨</Badge>;\n    }\n    if (daysUntilExpiry < 0) {\n      return <Badge variant=\"destructive\">å·²è¿‡æœŸ</Badge>;\n    }\n    if (daysUntilExpiry <= 7) {\n      return <Badge className=\"bg-amber-500\">å³å°†è¿‡æœŸ</Badge>;\n    }\n    return <Badge className=\"bg-green-500\">æ´»è·ƒ</Badge>;\n  };\n\n  const getPlanLabel = (planType: string) => {\n    const labels: Record<string, string> = {\n      monthly: \"æœˆåº¦ä¼šå‘˜ (Â¥98)\",\n      quarterly: \"å­£åº¦ä¼šå‘˜ (Â¥294)\",\n    };\n    return labels[planType] || planType;\n  };\n\n  const totalRevenue = subscriptions.reduce((sum, sub) => {\n    const revenue = sub.plan_type === \"monthly\" ? 98 : sub.plan_type === \"quarterly\" ? 294 : 0;\n    return sum + revenue;\n  }, 0);\n\n  const activeCount = subscriptions.filter((sub) => sub.is_active && differenceInDays(new Date(sub.end_date), new Date()) > 0).length;\n\n  return (\n    <div className=\"p-8 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">è®¢é˜…ç®¡ç†</h1>\n          <p className=\"text-muted-foreground mt-1\">ç®¡ç†ç”¨æˆ·ä¼šå‘˜è®¢é˜…å’Œæƒç›Š</p>\n        </div>\n        <Button onClick={() => setShowCreateDialog(true)} data-testid=\"button-create-subscription\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          åˆ›å»ºè®¢é˜…\n        </Button>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ´»è·ƒè®¢é˜…</CardTitle>\n            <Crown className=\"h-4 w-4 text-amber-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{activeCount}</div>\n            <p className=\"text-xs text-muted-foreground\">å½“å‰æ´»è·ƒä¼šå‘˜æ•°</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ€»è®¢é˜…æ•°</CardTitle>\n            <Users className=\"h-4 w-4 text-primary\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{subscriptions.length}</div>\n            <p className=\"text-xs text-muted-foreground\">å†å²è®¢é˜…æ€»æ•°</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">è®¢é˜…æ”¶å…¥</CardTitle>\n            <DollarSign className=\"h-4 w-4 text-green-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">Â¥{totalRevenue.toLocaleString()}</div>\n            <p className=\"text-xs text-muted-foreground\">ç´¯è®¡è®¢é˜…æ”¶å…¥</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">è½¬åŒ–ç‡</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-blue-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">--%</div>\n            <p className=\"text-xs text-muted-foreground\">å¾…ç»Ÿè®¡</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Tabs value={filterStatus} onValueChange={(v) => setFilterStatus(v as any)}>\n        <TabsList>\n          <TabsTrigger value=\"active\" data-testid=\"filter-active\">æ´»è·ƒè®¢é˜…</TabsTrigger>\n          <TabsTrigger value=\"all\" data-testid=\"filter-all\">å…¨éƒ¨è®¢é˜…</TabsTrigger>\n        </TabsList>\n      </Tabs>\n\n      {isLoading ? (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader className=\"space-y-2\">\n                <div className=\"h-4 bg-muted rounded w-3/4\" />\n                <div className=\"h-3 bg-muted rounded w-1/2\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2\">\n                  <div className=\"h-3 bg-muted rounded\" />\n                  <div className=\"h-3 bg-muted rounded w-5/6\" />\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : subscriptions.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-12 text-center text-muted-foreground\">\n            æš‚æ— è®¢é˜…è®°å½•\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {subscriptions.map((subscription) => (\n            <Card key={subscription.id} data-testid={`card-subscription-${subscription.id}`}>\n              <CardHeader className=\"flex flex-row items-start justify-between gap-2 space-y-0 pb-3\">\n                <div className=\"flex-1 min-w-0\">\n                  <CardTitle className=\"text-lg flex items-center gap-2\">\n                    {subscription.first_name} {subscription.last_name}\n                  </CardTitle>\n                  <p className=\"text-sm text-muted-foreground truncate\">{subscription.email}</p>\n                </div>\n                {getStatusBadge(subscription)}\n              </CardHeader>\n              <CardContent className=\"space-y-2 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">å¥—é¤ç±»å‹</span>\n                  <Badge variant=\"outline\">{getPlanLabel(subscription.plan_type)}</Badge>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">å¼€å§‹æ—¥æœŸ</span>\n                  <span className=\"font-medium\">{format(new Date(subscription.start_date), \"yyyy/MM/dd\")}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">ç»“æŸæ—¥æœŸ</span>\n                  <span className=\"font-medium\">{format(new Date(subscription.end_date), \"yyyy/MM/dd\")}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">å‰©ä½™å¤©æ•°</span>\n                  <span className=\"font-medium\">\n                    {differenceInDays(new Date(subscription.end_date), new Date())} å¤©\n                  </span>\n                </div>\n                {subscription.auto_renew && (\n                  <div className=\"pt-2 border-t\">\n                    <Badge variant=\"secondary\">è‡ªåŠ¨ç»­è´¹</Badge>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>åˆ›å»ºæ–°è®¢é˜…</DialogTitle>\n            <DialogDescription>ä¸ºç”¨æˆ·åˆ›å»ºä¼šå‘˜è®¢é˜…</DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"user\">é€‰æ‹©ç”¨æˆ·</Label>\n              <Select value={selectedUserId} onValueChange={setSelectedUserId}>\n                <SelectTrigger data-testid=\"select-user\">\n                  <SelectValue placeholder=\"é€‰æ‹©ç”¨æˆ·\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {users.map((user) => (\n                    <SelectItem key={user.id} value={user.id}>\n                      {user.firstName} {user.lastName} - {user.email}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"plan\">å¥—é¤ç±»å‹</Label>\n              <Select value={planType} onValueChange={setPlanType}>\n                <SelectTrigger data-testid=\"select-plan\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"monthly\">æœˆåº¦ä¼šå‘˜ (Â¥98/æœˆ)</SelectItem>\n                  <SelectItem value=\"quarterly\">å­£åº¦ä¼šå‘˜ (Â¥294/3æœˆ)</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"duration\">è®¢é˜…æ—¶é•¿ï¼ˆæœˆï¼‰</Label>\n              <Input\n                id=\"duration\"\n                type=\"number\"\n                min=\"1\"\n                max=\"12\"\n                value={durationMonths}\n                onChange={(e) => setDurationMonths(e.target.value)}\n                data-testid=\"input-duration\"\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowCreateDialog(false)} data-testid=\"button-cancel\">\n              å–æ¶ˆ\n            </Button>\n            <Button onClick={handleCreateSubscription} disabled={createMutation.isPending} data-testid=\"button-submit-subscription\">\n              {createMutation.isPending ? \"åˆ›å»ºä¸­...\" : \"åˆ›å»ºè®¢é˜…\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":12601},"client/src/components/admin/AdminSidebar.tsx":{"content":"import {\n  LayoutDashboard,\n  Users,\n  CreditCard,\n  Tag,\n  MapPin,\n  LayoutTemplate,\n  Calendar,\n  Layers,\n  DollarSign,\n  BarChart3,\n  FileText,\n  Bell,\n  Flag,\n  FlaskConical,\n  MessageSquareWarning,\n  MessageSquare,\n  Settings,\n  ScrollText,\n} from \"lucide-react\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarHeader,\n} from \"@/components/ui/sidebar\";\nimport { Link, useLocation } from \"wouter\";\n\nconst menuItems = [\n  {\n    title: \"æ•°æ®çœ‹æ¿\",\n    url: \"/admin/dashboard\",\n    icon: LayoutDashboard,\n  },\n  {\n    title: \"ç”¨æˆ·ç®¡ç†\",\n    url: \"/admin/users\",\n    icon: Users,\n  },\n  {\n    title: \"è®¢é˜…ç®¡ç†\",\n    url: \"/admin/subscriptions\",\n    icon: CreditCard,\n  },\n  {\n    title: \"ä¼˜æƒ åˆ¸\",\n    url: \"/admin/coupons\",\n    icon: Tag,\n  },\n  {\n    title: \"åœºåœ°ç®¡ç†\",\n    url: \"/admin/venues\",\n    icon: MapPin,\n  },\n  {\n    title: \"æ´»åŠ¨æ¨¡æ¿\",\n    url: \"/admin/templates\",\n    icon: LayoutTemplate,\n  },\n  {\n    title: \"æ´»åŠ¨ç®¡ç†\",\n    url: \"/admin/events\",\n    icon: Calendar,\n  },\n  {\n    title: \"æ´»åŠ¨æ± ç®¡ç†\",\n    url: \"/admin/event-pools\",\n    icon: Layers,\n  },\n  {\n    title: \"è´¢åŠ¡ç®¡ç†\",\n    url: \"/admin/finance\",\n    icon: DollarSign,\n  },\n];\n\nconst analyticsItems = [\n  {\n    title: \"æ•°æ®æ´å¯Ÿ\",\n    url: \"/admin/insights\",\n    icon: BarChart3,\n  },\n  {\n    title: \"åé¦ˆç®¡ç†\",\n    url: \"/admin/feedback\",\n    icon: MessageSquare,\n  },\n  {\n    title: \"å†…å®¹ç®¡ç†\",\n    url: \"/admin/content\",\n    icon: FileText,\n  },\n  {\n    title: \"é€šçŸ¥æ¨é€\",\n    url: \"/admin/notifications\",\n    icon: Bell,\n  },\n  {\n    title: \"ä¸¾æŠ¥å®¡æ ¸\",\n    url: \"/admin/moderation\",\n    icon: Flag,\n  },\n  {\n    title: \"ä¸¾æŠ¥ç®¡ç†\",\n    url: \"/admin/reports\",\n    icon: MessageSquareWarning,\n  },\n  {\n    title: \"èŠå¤©æ—¥å¿—\",\n    url: \"/admin/chat-logs\",\n    icon: FileText,\n  },\n  {\n    title: \"åŒ¹é…å®éªŒå®¤\",\n    url: \"/admin/matching\",\n    icon: FlaskConical,\n  },\n  {\n    title: \"åŒ¹é…é…ç½®\",\n    url: \"/admin/matching-config\",\n    icon: Settings,\n  },\n  {\n    title: \"åŒ¹é…æ—¥å¿—\",\n    url: \"/admin/matching-logs\",\n    icon: ScrollText,\n  },\n];\n\nexport function AdminSidebar() {\n  const [location] = useLocation();\n\n  return (\n    <Sidebar>\n      <SidebarHeader className=\"border-b px-6 py-4\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"flex h-8 w-8 items-center justify-center rounded-md bg-primary\">\n            <span className=\"text-lg font-bold text-primary-foreground\">æ‚¦</span>\n          </div>\n          <div>\n            <h2 className=\"text-lg font-semibold\">æ‚¦èšÂ·Joy</h2>\n            <p className=\"text-xs text-muted-foreground\">ç®¡ç†åå°</p>\n          </div>\n        </div>\n      </SidebarHeader>\n      <SidebarContent>\n        <SidebarGroup>\n          <SidebarGroupLabel>æ ¸å¿ƒç®¡ç†</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {menuItems.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton\n                    asChild\n                    isActive={location === item.url}\n                    data-testid={`nav-${item.title}`}\n                  >\n                    <Link href={item.url}>\n                      <item.icon className=\"h-4 w-4\" />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n\n        <SidebarGroup>\n          <SidebarGroupLabel>æ•°æ®ä¸ä¼˜åŒ–</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {analyticsItems.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton\n                    asChild\n                    isActive={location === item.url}\n                    data-testid={`nav-${item.title}`}\n                  >\n                    <Link href={item.url}>\n                      <item.icon className=\"h-4 w-4\" />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n      </SidebarContent>\n    </Sidebar>\n  );\n}\n","size_bytes":4445},"client/src/pages/admin/AdminLayout.tsx":{"content":"import { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AdminSidebar } from \"@/components/admin/AdminSidebar\";\nimport { AdminGuard } from \"@/components/admin/AdminGuard\";\nimport { Route, Switch } from \"wouter\";\nimport AdminDashboard from \"@/pages/admin/AdminDashboard\";\nimport AdminUsersPage from \"@/pages/admin/AdminUsersPage\";\nimport AdminSubscriptionsPage from \"@/pages/admin/AdminSubscriptionsPage\";\nimport AdminCouponsPage from \"@/pages/admin/AdminCouponsPage\";\nimport AdminVenuesPage from \"@/pages/admin/AdminVenuesPage\";\nimport AdminEventTemplatesPage from \"@/pages/admin/AdminEventTemplatesPage\";\nimport AdminEventsPage from \"@/pages/admin/AdminEventsPage\";\nimport AdminEventPoolsPage from \"@/pages/admin/AdminEventPoolsPage\";\nimport AdminFinancePage from \"@/pages/admin/AdminFinancePage\";\nimport AdminDataInsightsPage from \"@/pages/admin/AdminDataInsightsPage\";\nimport AdminContentPage from \"@/pages/admin/AdminContentPage\";\nimport AdminModerationPage from \"@/pages/admin/AdminModerationPage\";\nimport AdminMatchingLabPage from \"@/pages/admin/AdminMatchingLabPage\";\nimport AdminNotificationsPage from \"@/pages/admin/AdminNotificationsPage\";\nimport AdminReportsPage from \"@/pages/admin/AdminReportsPage\";\nimport AdminChatLogsPage from \"@/pages/admin/AdminChatLogsPage\";\nimport AdminFeedbackPage from \"@/pages/admin/AdminFeedbackPage\";\nimport AdminMatchingConfigPage from \"@/pages/admin/AdminMatchingConfigPage\";\nimport AdminMatchingLogsPage from \"@/pages/admin/AdminMatchingLogsPage\";\n\nexport default function AdminLayout() {\n  const sidebarStyle = {\n    \"--sidebar-width\": \"20rem\",\n    \"--sidebar-width-icon\": \"4rem\",\n  };\n\n  return (\n    <AdminGuard>\n      <SidebarProvider style={sidebarStyle as React.CSSProperties}>\n      <div className=\"flex h-screen w-full\">\n        <AdminSidebar />\n        <div className=\"flex flex-1 flex-col\">\n          <header className=\"flex items-center justify-between border-b px-6 py-3\">\n            <div className=\"flex items-center gap-2\">\n              <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n              <h1 className=\"text-lg font-medium\">ç®¡ç†åå°</h1>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-sm text-muted-foreground\">ç®¡ç†å‘˜</span>\n            </div>\n          </header>\n          <main className=\"flex-1 overflow-auto bg-muted/30\">\n            <Switch>\n              <Route path=\"/admin\" component={AdminDashboard} />\n              <Route path=\"/admin/dashboard\" component={AdminDashboard} />\n              <Route path=\"/admin/users\" component={AdminUsersPage} />\n              <Route path=\"/admin/subscriptions\" component={AdminSubscriptionsPage} />\n              <Route path=\"/admin/coupons\" component={AdminCouponsPage} />\n              <Route path=\"/admin/venues\" component={AdminVenuesPage} />\n              <Route path=\"/admin/templates\" component={AdminEventTemplatesPage} />\n              <Route path=\"/admin/events\" component={AdminEventsPage} />\n              <Route path=\"/admin/event-pools\" component={AdminEventPoolsPage} />\n              <Route path=\"/admin/finance\" component={AdminFinancePage} />\n              <Route path=\"/admin/insights\" component={AdminDataInsightsPage} />\n              <Route path=\"/admin/feedback\" component={AdminFeedbackPage} />\n              <Route path=\"/admin/content\" component={AdminContentPage} />\n              <Route path=\"/admin/notifications\" component={AdminNotificationsPage} />\n              <Route path=\"/admin/moderation\" component={AdminModerationPage} />\n              <Route path=\"/admin/reports\" component={AdminReportsPage} />\n              <Route path=\"/admin/chat-logs\" component={AdminChatLogsPage} />\n              <Route path=\"/admin/matching\" component={AdminMatchingLabPage} />\n              <Route path=\"/admin/matching-config\" component={AdminMatchingConfigPage} />\n              <Route path=\"/admin/matching-logs\" component={AdminMatchingLogsPage} />\n            </Switch>\n          </main>\n        </div>\n      </div>\n    </SidebarProvider>\n    </AdminGuard>\n  );\n}\n","size_bytes":4108},"client/src/components/ui/date-picker.tsx":{"content":"import { format } from \"date-fns\";\nimport { zhCN } from \"date-fns/locale\";\nimport { Calendar as CalendarIcon } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"@/components/ui/button\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\n\ninterface DatePickerProps {\n  value?: Date;\n  onChange: (date: Date | undefined) => void;\n  placeholder?: string;\n  disabled?: boolean;\n  maxDate?: Date;\n  minDate?: Date;\n  \"data-testid\"?: string;\n}\n\nexport function DatePicker({\n  value,\n  onChange,\n  placeholder = \"é€‰æ‹©æ—¥æœŸ\",\n  disabled = false,\n  maxDate,\n  minDate,\n  \"data-testid\": testId,\n}: DatePickerProps) {\n  return (\n    <Popover>\n      <PopoverTrigger asChild>\n        <Button\n          variant=\"outline\"\n          className={cn(\n            \"w-full justify-start text-left font-normal\",\n            !value && \"text-muted-foreground\"\n          )}\n          disabled={disabled}\n          data-testid={testId}\n        >\n          <CalendarIcon className=\"mr-2 h-4 w-4\" />\n          {value ? format(value, \"PPP\", { locale: zhCN }) : <span>{placeholder}</span>}\n        </Button>\n      </PopoverTrigger>\n      <PopoverContent className=\"w-auto p-0\" align=\"start\">\n        <Calendar\n          mode=\"single\"\n          selected={value}\n          onSelect={onChange}\n          disabled={(date) => {\n            if (maxDate && date > maxDate) return true;\n            if (minDate && date < minDate) return true;\n            return false;\n          }}\n          initialFocus\n        />\n      </PopoverContent>\n    </Popover>\n  );\n}\n","size_bytes":1648},"client/src/pages/admin/AdminUsersPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Search, UserX, UserCheck, Calendar, Crown, AlertCircle, RefreshCw } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { format } from \"date-fns\";\n\ninterface User {\n  id: string;\n  firstName: string;\n  lastName: string;\n  email: string;\n  phoneNumber: string;\n  gender?: string;\n  dateOfBirth?: string;\n  primaryRole?: string;\n  isAdmin: boolean;\n  isBanned: boolean;\n  hasCompletedRegistration: boolean;\n  createdAt: string;\n}\n\ninterface UserDetails extends User {\n  events: any[];\n  subscriptions: any[];\n  payments: any[];\n}\n\nexport default function AdminUsersPage() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filterStatus, setFilterStatus] = useState<\"all\" | \"subscribed\" | \"banned\">(\"all\");\n  const [selectedUser, setSelectedUser] = useState<string | null>(null);\n\n  const { data: users = [], isLoading, isError, error, refetch } = useQuery<User[]>({\n    queryKey: [\"/api/admin/users\", { search: searchQuery, filter: filterStatus === \"all\" ? undefined : filterStatus }],\n    retry: 2,\n  });\n\n  const { data: userDetails, isLoading: isLoadingDetails } = useQuery<UserDetails>({\n    queryKey: [\"/api/admin/users\", selectedUser],\n    enabled: !!selectedUser,\n  });\n\n  const banMutation = useMutation({\n    mutationFn: (userId: string) => \n      fetch(`/api/admin/users/${userId}/ban`, { \n        method: \"PATCH\",\n        credentials: \"include\",\n      }).then(r => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      setSelectedUser(null);\n    },\n  });\n\n  const unbanMutation = useMutation({\n    mutationFn: (userId: string) => \n      fetch(`/api/admin/users/${userId}/unban`, { \n        method: \"PATCH\",\n        credentials: \"include\",\n      }).then(r => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      setSelectedUser(null);\n    },\n  });\n\n  const handleBanToggle = (user: User) => {\n    if (user.isBanned) {\n      unbanMutation.mutate(user.id);\n    } else {\n      banMutation.mutate(user.id);\n    }\n  };\n\n  const calculateAge = (dateOfBirth?: string) => {\n    if (!dateOfBirth) return null;\n    const today = new Date();\n    const birthDate = new Date(dateOfBirth);\n    let age = today.getFullYear() - birthDate.getFullYear();\n    const monthDiff = today.getMonth() - birthDate.getMonth();\n    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {\n      age--;\n    }\n    return age;\n  };\n\n  if (isError) {\n    return (\n      <div className=\"flex h-full items-center justify-center p-8\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6\">\n            <div className=\"space-y-4 text-center\">\n              <AlertCircle className=\"mx-auto h-12 w-12 text-destructive\" />\n              <div>\n                <h3 className=\"text-lg font-semibold\">åŠ è½½å¤±è´¥</h3>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  {error instanceof Error && error.message.includes(\"401\") \n                    ? \"æ‚¨æ²¡æœ‰è®¿é—®æƒé™\"\n                    : \"æ— æ³•åŠ è½½ç”¨æˆ·æ•°æ®ï¼Œè¯·ç¨åé‡è¯•\"}\n                </p>\n              </div>\n              <Button \n                onClick={() => refetch()} \n                variant=\"default\"\n                data-testid=\"button-retry-users\"\n              >\n                <RefreshCw className=\"mr-2 h-4 w-4\" />\n                é‡è¯•\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-8 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">ç”¨æˆ·ç®¡ç†</h1>\n          <p className=\"text-muted-foreground mt-1\">æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰ç”¨æˆ·è´¦æˆ·</p>\n        </div>\n      </div>\n\n      <div className=\"flex flex-col sm:flex-row gap-4\">\n        <div className=\"relative flex-1\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"æœç´¢ç”¨æˆ·ï¼ˆå§“åã€é‚®ç®±ã€æ‰‹æœºå·ï¼‰\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-users\"\n          />\n        </div>\n        <Tabs value={filterStatus} onValueChange={(v) => setFilterStatus(v as any)}>\n          <TabsList>\n            <TabsTrigger value=\"all\" data-testid=\"filter-all\">å…¨éƒ¨</TabsTrigger>\n            <TabsTrigger value=\"subscribed\" data-testid=\"filter-subscribed\">ä¼šå‘˜</TabsTrigger>\n            <TabsTrigger value=\"banned\" data-testid=\"filter-banned\">å·²å°ç¦</TabsTrigger>\n          </TabsList>\n        </Tabs>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3, 4, 5, 6].map((i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader className=\"space-y-2\">\n                <div className=\"h-4 bg-muted rounded w-3/4\" />\n                <div className=\"h-3 bg-muted rounded w-1/2\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2\">\n                  <div className=\"h-3 bg-muted rounded\" />\n                  <div className=\"h-3 bg-muted rounded w-5/6\" />\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : users.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-12 text-center text-muted-foreground\">\n            {searchQuery ? \"æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·\" : \"æš‚æ— ç”¨æˆ·\"}\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {users.map((user) => (\n            <Card\n              key={user.id}\n              className=\"cursor-pointer hover-elevate active-elevate-2 transition-all\"\n              onClick={() => setSelectedUser(user.id)}\n              data-testid={`card-user-${user.id}`}\n            >\n              <CardHeader className=\"flex flex-row items-start justify-between gap-2 space-y-0 pb-3\">\n                <div className=\"flex-1 min-w-0\">\n                  <CardTitle className=\"text-lg flex items-center gap-2\">\n                    {user.firstName} {user.lastName}\n                    {user.isAdmin && <Crown className=\"h-4 w-4 text-amber-500\" />}\n                  </CardTitle>\n                  <p className=\"text-sm text-muted-foreground truncate\">{user.email}</p>\n                </div>\n                <div className=\"flex flex-col gap-1\">\n                  {user.isBanned && <Badge variant=\"destructive\">å·²å°ç¦</Badge>}\n                  {!user.hasCompletedRegistration && <Badge variant=\"secondary\">æœªå®Œæˆæ³¨å†Œ</Badge>}\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-2 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">æ‰‹æœºå·</span>\n                  <span className=\"font-medium\">{user.phoneNumber}</span>\n                </div>\n                {user.gender && (\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">æ€§åˆ«</span>\n                    <span className=\"font-medium\">\n                      {user.gender === \"male\" ? \"ç”·\" : user.gender === \"female\" ? \"å¥³\" : \"å…¶ä»–\"}\n                    </span>\n                  </div>\n                )}\n                {user.dateOfBirth && (\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">å¹´é¾„</span>\n                    <span className=\"font-medium\">{calculateAge(user.dateOfBirth)}å²</span>\n                  </div>\n                )}\n                {user.primaryRole && (\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">ç¤¾äº¤è§’è‰²</span>\n                    <Badge variant=\"outline\">{user.primaryRole}</Badge>\n                  </div>\n                )}\n                <div className=\"flex justify-between pt-2 border-t\">\n                  <span className=\"text-muted-foreground\">æ³¨å†Œæ—¶é—´</span>\n                  <span className=\"text-xs\">{format(new Date(user.createdAt), \"yyyy/MM/dd\")}</span>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={!!selectedUser} onOpenChange={() => setSelectedUser(null)}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              ç”¨æˆ·è¯¦æƒ…\n              {userDetails?.isAdmin && <Crown className=\"h-5 w-5 text-amber-500\" />}\n              {userDetails?.isBanned && <Badge variant=\"destructive\">å·²å°ç¦</Badge>}\n            </DialogTitle>\n            <DialogDescription>æŸ¥çœ‹ç”¨æˆ·çš„å®Œæ•´ä¿¡æ¯å’Œæ´»åŠ¨è®°å½•</DialogDescription>\n          </DialogHeader>\n\n          {isLoadingDetails ? (\n            <div className=\"space-y-4 py-4\">\n              <div className=\"h-4 bg-muted rounded w-3/4 animate-pulse\" />\n              <div className=\"h-4 bg-muted rounded w-1/2 animate-pulse\" />\n              <div className=\"h-4 bg-muted rounded animate-pulse\" />\n            </div>\n          ) : userDetails ? (\n            <div className=\"space-y-6\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">å§“å</p>\n                  <p className=\"font-medium\">{userDetails.firstName} {userDetails.lastName}</p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">é‚®ç®±</p>\n                  <p className=\"font-medium\">{userDetails.email}</p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">æ‰‹æœºå·</p>\n                  <p className=\"font-medium\">{userDetails.phoneNumber}</p>\n                </div>\n                {userDetails.gender && (\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">æ€§åˆ«</p>\n                    <p className=\"font-medium\">\n                      {userDetails.gender === \"male\" ? \"ç”·\" : userDetails.gender === \"female\" ? \"å¥³\" : \"å…¶ä»–\"}\n                    </p>\n                  </div>\n                )}\n                {userDetails.dateOfBirth && (\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">å¹´é¾„</p>\n                    <p className=\"font-medium\">{calculateAge(userDetails.dateOfBirth)}å²</p>\n                  </div>\n                )}\n                {userDetails.primaryRole && (\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">ç¤¾äº¤è§’è‰²</p>\n                    <Badge variant=\"outline\">{userDetails.primaryRole}</Badge>\n                  </div>\n                )}\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">æ³¨å†Œæ—¶é—´</p>\n                  <p className=\"font-medium flex items-center gap-1\">\n                    <Calendar className=\"h-3 w-3\" />\n                    {format(new Date(userDetails.createdAt), \"yyyyå¹´MMæœˆddæ—¥\")}\n                  </p>\n                </div>\n              </div>\n\n              <div>\n                <h3 className=\"font-semibold mb-2\">å‚ä¸æ´»åŠ¨</h3>\n                {userDetails.events.length === 0 ? (\n                  <p className=\"text-sm text-muted-foreground\">å°šæœªå‚ä¸ä»»ä½•æ´»åŠ¨</p>\n                ) : (\n                  <div className=\"space-y-2\">\n                    {userDetails.events.map((event) => (\n                      <div key={event.id} className=\"flex justify-between text-sm border-l-2 border-primary pl-3 py-1\">\n                        <span>{event.eventType}</span>\n                        <span className=\"text-muted-foreground\">\n                          {format(new Date(event.dateTime), \"yyyy/MM/dd\")}\n                        </span>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n\n              <div>\n                <h3 className=\"font-semibold mb-2\">è®¢é˜…çŠ¶æ€</h3>\n                {userDetails.subscriptions.length === 0 ? (\n                  <p className=\"text-sm text-muted-foreground\">æš‚æ— æ´»è·ƒè®¢é˜…</p>\n                ) : (\n                  <div className=\"space-y-2\">\n                    {userDetails.subscriptions.map((sub) => (\n                      <div key={sub.id} className=\"flex justify-between text-sm\">\n                        <span>{sub.planType}</span>\n                        <Badge variant=\"outline\">{sub.isActive ? \"æ´»è·ƒ\" : \"å·²è¿‡æœŸ\"}</Badge>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n            </div>\n          ) : null}\n\n          <DialogFooter className=\"gap-2\">\n            <Button variant=\"outline\" onClick={() => setSelectedUser(null)} data-testid=\"button-close-details\">\n              å…³é—­\n            </Button>\n            {userDetails && !userDetails.isAdmin && (\n              <Button\n                variant={userDetails.isBanned ? \"default\" : \"destructive\"}\n                onClick={() => handleBanToggle(userDetails)}\n                disabled={banMutation.isPending || unbanMutation.isPending}\n                data-testid={userDetails.isBanned ? \"button-unban-user\" : \"button-ban-user\"}\n              >\n                {userDetails.isBanned ? (\n                  <>\n                    <UserCheck className=\"h-4 w-4 mr-2\" />\n                    è§£é™¤å°ç¦\n                  </>\n                ) : (\n                  <>\n                    <UserX className=\"h-4 w-4 mr-2\" />\n                    å°ç¦ç”¨æˆ·\n                  </>\n                )}\n              </Button>\n            )}\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":14614},"client/src/pages/admin/AdminDashboard.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Users, CreditCard, Calendar, DollarSign, UserPlus, TrendingUp, AlertCircle, RefreshCw } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\n\ninterface AdminStats {\n  totalUsers: number;\n  subscribedUsers: number;\n  eventsThisMonth: number;\n  monthlyRevenue: number;\n  newUsersThisWeek: number;\n  userGrowth: number;\n  personalityDistribution: Record<string, number>;\n}\n\nexport default function AdminDashboard() {\n  const { data: stats, isLoading, isError, error, refetch } = useQuery<AdminStats>({\n    queryKey: [\"/api/admin/stats\"],\n    retry: 2,\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-full items-center justify-center\">\n        <div className=\"space-y-4 text-center\">\n          <div className=\"mx-auto h-8 w-8 animate-spin rounded-full border-2 border-primary border-t-transparent\" />\n          <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (isError) {\n    return (\n      <div className=\"flex h-full items-center justify-center\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6\">\n            <div className=\"space-y-4 text-center\">\n              <AlertCircle className=\"mx-auto h-12 w-12 text-destructive\" />\n              <div>\n                <h3 className=\"text-lg font-semibold\">åŠ è½½å¤±è´¥</h3>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  {error instanceof Error && error.message.includes(\"401\") \n                    ? \"æ‚¨æ²¡æœ‰è®¿é—®æƒé™ï¼Œè¯·ç¡®è®¤æ‚¨æ‹¥æœ‰ç®¡ç†å‘˜æƒé™\"\n                    : \"æ— æ³•åŠ è½½æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•\"}\n                </p>\n              </div>\n              <Button \n                onClick={() => refetch()} \n                variant=\"default\"\n                data-testid=\"button-retry-stats\"\n              >\n                <RefreshCw className=\"mr-2 h-4 w-4\" />\n                é‡è¯•\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const statCards = [\n    {\n      title: \"ç”¨æˆ·æ€»æ•°\",\n      value: stats?.totalUsers?.toString() || \"0\",\n      icon: Users,\n      description: \"æ³¨å†Œç”¨æˆ·\",\n    },\n    {\n      title: \"è®¢é˜…ä¼šå‘˜\",\n      value: stats?.subscribedUsers?.toString() || \"0\",\n      icon: CreditCard,\n      description: \"æ´»è·ƒä¼šå‘˜æ•°\",\n    },\n    {\n      title: \"æœ¬æœˆæ´»åŠ¨\",\n      value: stats?.eventsThisMonth?.toString() || \"0\",\n      icon: Calendar,\n      description: \"å·²å‘å¸ƒæ´»åŠ¨\",\n    },\n    {\n      title: \"æœ¬æœˆæ”¶å…¥\",\n      value: `Â¥${stats?.monthlyRevenue || 0}`,\n      icon: DollarSign,\n      description: \"è®¢é˜… + å•æ¬¡ä»˜è´¹\",\n    },\n    {\n      title: \"æ–°å¢ç”¨æˆ·\",\n      value: stats?.newUsersThisWeek?.toString() || \"0\",\n      icon: UserPlus,\n      description: \"æœ¬å‘¨æ–°ç”¨æˆ·\",\n    },\n    {\n      title: \"ç”¨æˆ·å¢é•¿\",\n      value: `${stats?.userGrowth || 0}%`,\n      icon: TrendingUp,\n      description: \"ç›¸æ¯”ä¸Šå‘¨\",\n    },\n  ];\n\n  return (\n    <div className=\"p-6\">\n      <div className=\"mb-6\">\n        <h2 className=\"text-2xl font-bold\">æ•°æ®çœ‹æ¿</h2>\n        <p className=\"text-muted-foreground\">æ ¸å¿ƒä¸šåŠ¡æŒ‡æ ‡æ¦‚è§ˆ</p>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n        {statCards.map((stat) => (\n          <Card key={stat.title} data-testid={`stat-card-${stat.title}`}>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">\n                {stat.title}\n              </CardTitle>\n              <stat.icon className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid={`stat-value-${stat.title}`}>\n                {stat.value}\n              </div>\n              <p className=\"text-xs text-muted-foreground\">\n                {stat.description}\n              </p>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      <div className=\"mt-6 grid gap-4 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle>æ€§æ ¼ç±»å‹åˆ†å¸ƒ</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              {stats?.personalityDistribution && Object.keys(stats.personalityDistribution).length > 0 ? (\n                Object.entries(stats.personalityDistribution)\n                  .sort((a, b) => b[1] - a[1])\n                  .slice(0, 5)\n                  .map(([role, count]) => (\n                    <div key={role} className=\"flex items-center justify-between\">\n                      <span className=\"text-sm font-medium\">{role}</span>\n                      <span className=\"text-sm text-muted-foreground\">{count} äºº</span>\n                    </div>\n                  ))\n              ) : (\n                <div className=\"flex h-[200px] items-center justify-center text-muted-foreground\">\n                  æš‚æ— æ•°æ®\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>ç”¨æˆ·å¢é•¿è¶‹åŠ¿</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex h-[200px] items-center justify-center text-muted-foreground\">\n              æ•°æ®å›¾è¡¨å¼€å‘ä¸­\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":5621},"client/src/components/admin/AdminGuard.tsx":{"content":"import { useAuth } from \"@/hooks/useAuth\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle, Home, RefreshCw } from \"lucide-react\";\nimport { useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\n\nexport function AdminGuard({ children }: { children: React.ReactNode }) {\n  const { user, isLoading } = useAuth();\n  const [, setLocation] = useLocation();\n\n  useEffect(() => {\n    if (!isLoading && !user) {\n      setLocation(\"/admin/login\");\n    }\n  }, [isLoading, user, setLocation]);\n\n  useEffect(() => {\n    if (!isLoading && user && !user.isAdmin) {\n      const timer = setTimeout(() => setLocation(\"/admin/login\"), 2000);\n      return () => clearTimeout(timer);\n    }\n  }, [isLoading, user, setLocation]);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"space-y-4 text-center\">\n          <div className=\"mx-auto h-8 w-8 animate-spin rounded-full border-2 border-primary border-t-transparent\" />\n          <p className=\"text-sm text-muted-foreground\">éªŒè¯æƒé™ä¸­...</p>\n        </div>\n      </div>\n    );\n  }\n\n  useEffect(() => {\n    if (!isLoading && !user) {\n      setLocation(\"/admin/login\");\n    }\n  }, [isLoading, user, setLocation]);\n\n  if (!user) {\n    return null;\n  }\n\n  if (!user.isAdmin) {\n    return (\n      <div className=\"flex h-screen items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6\">\n            <div className=\"space-y-4 text-center\">\n              <AlertCircle className=\"mx-auto h-12 w-12 text-warning\" />\n              <div>\n                <h3 className=\"text-lg font-semibold\">æ— æƒè®¿é—®</h3>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  æ‚¨æ²¡æœ‰è®¿é—®ç®¡ç†åå°çš„æƒé™\n                </p>\n                <p className=\"text-xs text-muted-foreground mt-2\">\n                  å³å°†è‡ªåŠ¨è·³è½¬è‡³é¦–é¡µ...\n                </p>\n              </div>\n              <Button \n                onClick={() => setLocation(\"/\")} \n                variant=\"default\"\n                data-testid=\"button-goto-home\"\n              >\n                <Home className=\"mr-2 h-4 w-4\" />\n                è¿”å›é¦–é¡µ\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return <>{children}</>;\n}\n","size_bytes":2441},"client/src/pages/admin/AdminEventTemplatesPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Calendar, Plus, Edit, Trash2, Clock, TrendingUp, Users } from \"lucide-react\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface EventTemplate {\n  id: string;\n  name: string;\n  eventType: string;\n  dayOfWeek: number;\n  timeOfDay: string;\n  theme: string | null;\n  genderRestriction: string | null;\n  minAge: number | null;\n  maxAge: number | null;\n  minParticipants: number;\n  maxParticipants: number;\n  customPrice: number | null;\n  isActive: boolean;\n  createdAt: string;\n}\n\nconst EVENT_TYPES = [\n  { value: \"é¥­å±€\", label: \"é¥­å±€\" },\n  { value: \"é…’å±€\", label: \"é…’å±€\" },\n];\n\nconst DAY_OF_WEEK_MAP: Record<number, string> = {\n  0: 'å‘¨æ—¥',\n  1: 'å‘¨ä¸€',\n  2: 'å‘¨äºŒ',\n  3: 'å‘¨ä¸‰',\n  4: 'å‘¨å››',\n  5: 'å‘¨äº”',\n  6: 'å‘¨å…­',\n};\n\nconst GENDER_RESTRICTIONS = [\n  { value: \"none\", label: \"æ— é™åˆ¶\" },\n  { value: \"Woman\", label: \"ä»…é™å¥³æ€§\" },\n  { value: \"Man\", label: \"ä»…é™ç”·æ€§\" },\n];\n\nexport default function AdminEventTemplatesPage() {\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const [selectedTemplate, setSelectedTemplate] = useState<EventTemplate | null>(null);\n  const [filterType, setFilterType] = useState<\"all\" | \"é¥­å±€\" | \"é…’å±€\">(\"all\");\n  \n  const [formData, setFormData] = useState({\n    name: \"\",\n    eventType: \"é¥­å±€\",\n    dayOfWeek: \"5\",\n    timeOfDay: \"19:00\",\n    theme: \"\",\n    genderRestriction: \"none\",\n    minAge: \"\",\n    maxAge: \"\",\n    minParticipants: \"5\",\n    maxParticipants: \"10\",\n    customPrice: \"\",\n  });\n\n  const { toast } = useToast();\n\n  const { data: templates = [], isLoading } = useQuery<EventTemplate[]>({\n    queryKey: [\"/api/admin/event-templates\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: any) =>\n      fetch(\"/api/admin/event-templates\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      }).then((r) => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/event-templates\"] });\n      setShowCreateDialog(false);\n      resetForm();\n      toast({\n        title: \"æ¨¡æ¿åˆ›å»ºæˆåŠŸ\",\n        description: \"æ´»åŠ¨æ¨¡æ¿å·²æˆåŠŸæ·»åŠ åˆ°ç³»ç»Ÿ\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"åˆ›å»ºå¤±è´¥\",\n        description: \"æ— æ³•åˆ›å»ºæ¨¡æ¿ï¼Œè¯·é‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) =>\n      fetch(`/api/admin/event-templates/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      }).then((r) => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/event-templates\"] });\n      setShowEditDialog(false);\n      setSelectedTemplate(null);\n      toast({\n        title: \"æ›´æ–°æˆåŠŸ\",\n        description: \"æ¨¡æ¿ä¿¡æ¯å·²æ›´æ–°\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"æ›´æ–°å¤±è´¥\",\n        description: \"æ— æ³•æ›´æ–°æ¨¡æ¿ï¼Œè¯·é‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) =>\n      fetch(`/api/admin/event-templates/${id}`, {\n        method: \"DELETE\",\n        credentials: \"include\",\n      }).then((r) => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/event-templates\"] });\n      setShowDeleteDialog(false);\n      setSelectedTemplate(null);\n      toast({\n        title: \"åˆ é™¤æˆåŠŸ\",\n        description: \"æ¨¡æ¿å·²ä»ç³»ç»Ÿä¸­åˆ é™¤\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"åˆ é™¤å¤±è´¥\",\n        description: \"æ— æ³•åˆ é™¤æ¨¡æ¿ï¼Œè¯·é‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      eventType: \"é¥­å±€\",\n      dayOfWeek: \"5\",\n      timeOfDay: \"19:00\",\n      theme: \"\",\n      genderRestriction: \"none\",\n      minAge: \"\",\n      maxAge: \"\",\n      minParticipants: \"5\",\n      maxParticipants: \"10\",\n      customPrice: \"\",\n    });\n  };\n\n  const handleCreate = () => {\n    if (!formData.name || !formData.eventType || !formData.dayOfWeek || !formData.timeOfDay) {\n      toast({\n        title: \"ä¿¡æ¯ä¸å®Œæ•´\",\n        description: \"è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    createMutation.mutate({\n      name: formData.name,\n      eventType: formData.eventType,\n      dayOfWeek: parseInt(formData.dayOfWeek),\n      timeOfDay: formData.timeOfDay,\n      theme: formData.theme || undefined,\n      genderRestriction: formData.genderRestriction === \"none\" ? undefined : formData.genderRestriction,\n      minAge: formData.minAge ? parseInt(formData.minAge) : undefined,\n      maxAge: formData.maxAge ? parseInt(formData.maxAge) : undefined,\n      minParticipants: parseInt(formData.minParticipants),\n      maxParticipants: parseInt(formData.maxParticipants),\n      customPrice: formData.customPrice ? parseInt(formData.customPrice) : undefined,\n    });\n  };\n\n  const handleEdit = (template: EventTemplate) => {\n    setSelectedTemplate(template);\n    setFormData({\n      name: template.name,\n      eventType: template.eventType,\n      dayOfWeek: template.dayOfWeek.toString(),\n      timeOfDay: template.timeOfDay,\n      theme: template.theme || \"\",\n      genderRestriction: template.genderRestriction || \"none\",\n      minAge: template.minAge?.toString() || \"\",\n      maxAge: template.maxAge?.toString() || \"\",\n      minParticipants: template.minParticipants.toString(),\n      maxParticipants: template.maxParticipants.toString(),\n      customPrice: template.customPrice?.toString() || \"\",\n    });\n    setShowEditDialog(true);\n  };\n\n  const handleUpdate = () => {\n    if (!selectedTemplate) return;\n\n    updateMutation.mutate({\n      id: selectedTemplate.id,\n      data: {\n        name: formData.name,\n        eventType: formData.eventType,\n        dayOfWeek: parseInt(formData.dayOfWeek),\n        timeOfDay: formData.timeOfDay,\n        theme: formData.theme || null,\n        genderRestriction: formData.genderRestriction === \"none\" ? null : formData.genderRestriction,\n        minAge: formData.minAge ? parseInt(formData.minAge) : null,\n        maxAge: formData.maxAge ? parseInt(formData.maxAge) : null,\n        minParticipants: parseInt(formData.minParticipants),\n        maxParticipants: parseInt(formData.maxParticipants),\n        customPrice: formData.customPrice ? parseInt(formData.customPrice) : null,\n      },\n    });\n  };\n\n  const handleDelete = (template: EventTemplate) => {\n    setSelectedTemplate(template);\n    setShowDeleteDialog(true);\n  };\n\n  const confirmDelete = () => {\n    if (selectedTemplate) {\n      deleteMutation.mutate(selectedTemplate.id);\n    }\n  };\n\n  const toggleActive = (template: EventTemplate) => {\n    updateMutation.mutate({\n      id: template.id,\n      data: { isActive: !template.isActive },\n    });\n  };\n\n  const filteredTemplates = filterType === \"all\" \n    ? templates \n    : templates.filter(t => t.eventType === filterType);\n\n  const activeTemplates = templates.filter(t => t.isActive).length;\n  const weeklyEvents = templates.filter(t => t.isActive).length;\n\n  return (\n    <div className=\"p-8 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">æ´»åŠ¨æ¨¡æ¿ç®¡ç†</h1>\n          <p className=\"text-muted-foreground mt-1\">ç®¡ç†å‘¨æœŸæ€§æ´»åŠ¨æ—¶æ®µå’Œä¸»é¢˜</p>\n        </div>\n        <Button onClick={() => { resetForm(); setShowCreateDialog(true); }} data-testid=\"button-create-template\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          åˆ›å»ºæ¨¡æ¿\n        </Button>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ€»æ¨¡æ¿æ•°</CardTitle>\n            <Calendar className=\"h-4 w-4 text-primary\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"metric-total-templates\">{templates.length}</div>\n            <p className=\"text-xs text-muted-foreground\">å…¨éƒ¨æ´»åŠ¨æ¨¡æ¿</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ´»è·ƒæ¨¡æ¿</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-green-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"metric-active-templates\">{activeTemplates}</div>\n            <p className=\"text-xs text-muted-foreground\">å½“å‰å¯ç”¨æ¨¡æ¿</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æœ¬å‘¨æ´»åŠ¨æ•°</CardTitle>\n            <Users className=\"h-4 w-4 text-blue-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"metric-weekly-events\">{weeklyEvents}</div>\n            <p className=\"text-xs text-muted-foreground\">é¢„è®¡æœ¬å‘¨ä¸¾åŠ</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Tabs value={filterType} onValueChange={(v) => setFilterType(v as any)}>\n        <TabsList>\n          <TabsTrigger value=\"all\" data-testid=\"filter-all\">å…¨éƒ¨</TabsTrigger>\n          <TabsTrigger value=\"é¥­å±€\" data-testid=\"filter-dinner\">é¥­å±€</TabsTrigger>\n          <TabsTrigger value=\"é…’å±€\" data-testid=\"filter-drinks\">é…’å±€</TabsTrigger>\n        </TabsList>\n      </Tabs>\n\n      {isLoading ? (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader className=\"space-y-2\">\n                <div className=\"h-4 bg-muted rounded w-3/4\" />\n                <div className=\"h-3 bg-muted rounded w-1/2\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2\">\n                  <div className=\"h-3 bg-muted rounded\" />\n                  <div className=\"h-3 bg-muted rounded w-5/6\" />\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : filteredTemplates.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-12 text-center text-muted-foreground\">\n            {filterType === \"all\" ? \"æš‚æ— æ¨¡æ¿è®°å½•\" : `æš‚æ— ${filterType}æ¨¡æ¿`}\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {filteredTemplates.map((template) => (\n            <Card key={template.id} data-testid={`card-template-${template.id}`}>\n              <CardHeader className=\"flex flex-row items-start justify-between gap-2 space-y-0 pb-3\">\n                <div className=\"flex-1 min-w-0\">\n                  <CardTitle className=\"text-lg flex items-center gap-2 flex-wrap\">\n                    {template.name}\n                    <Badge variant=\"outline\">{template.eventType}</Badge>\n                  </CardTitle>\n                  <p className=\"text-sm text-muted-foreground flex items-center gap-1 mt-1\">\n                    <Clock className=\"h-3 w-3\" />\n                    {DAY_OF_WEEK_MAP[template.dayOfWeek]} {template.timeOfDay}\n                  </p>\n                </div>\n                {template.isActive ? (\n                  <Badge className=\"bg-green-500\">æ´»è·ƒ</Badge>\n                ) : (\n                  <Badge variant=\"secondary\">å·²åœç”¨</Badge>\n                )}\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                <div className=\"space-y-2 text-sm\">\n                  {template.theme && (\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">ä¸»é¢˜</span>\n                      <span className=\"font-medium\">{template.theme}</span>\n                    </div>\n                  )}\n                  {template.genderRestriction && (\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">æ€§åˆ«é™åˆ¶</span>\n                      <span className=\"font-medium\">\n                        {template.genderRestriction === \"Woman\" ? \"ä»…é™å¥³æ€§\" : \"ä»…é™ç”·æ€§\"}\n                      </span>\n                    </div>\n                  )}\n                  {(template.minAge || template.maxAge) && (\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">å¹´é¾„èŒƒå›´</span>\n                      <span className=\"font-medium\">\n                        {template.minAge || \"ä¸é™\"} - {template.maxAge || \"ä¸é™\"} å²\n                      </span>\n                    </div>\n                  )}\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">å‚ä¸äººæ•°</span>\n                    <span className=\"font-medium\">\n                      {template.minParticipants}-{template.maxParticipants} äºº\n                    </span>\n                  </div>\n                  {template.customPrice && (\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">ä»·æ ¼</span>\n                      <span className=\"font-medium\">Â¥{template.customPrice}</span>\n                    </div>\n                  )}\n                </div>\n                <div className=\"flex items-center gap-2 pt-2 border-t\">\n                  <div className=\"flex items-center gap-2 flex-1\">\n                    <Switch\n                      checked={template.isActive}\n                      onCheckedChange={() => toggleActive(template)}\n                      data-testid={`switch-active-${template.id}`}\n                    />\n                    <span className=\"text-sm text-muted-foreground\">\n                      {template.isActive ? \"å·²å¯ç”¨\" : \"å·²åœç”¨\"}\n                    </span>\n                  </div>\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    onClick={() => handleEdit(template)}\n                    data-testid={`button-edit-${template.id}`}\n                  >\n                    <Edit className=\"h-3 w-3 mr-1\" />\n                    ç¼–è¾‘\n                  </Button>\n                  <Button\n                    size=\"sm\"\n                    variant=\"destructive\"\n                    onClick={() => handleDelete(template)}\n                    data-testid={`button-delete-${template.id}`}\n                  >\n                    <Trash2 className=\"h-3 w-3\" />\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n        <DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>åˆ›å»ºæ´»åŠ¨æ¨¡æ¿</DialogTitle>\n            <DialogDescription>åˆ›å»ºæ–°çš„å‘¨æœŸæ€§æ´»åŠ¨æ¨¡æ¿</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"name\">æ¨¡æ¿åç§° *</Label>\n                <Input\n                  id=\"name\"\n                  placeholder=\"ä¾‹ï¼šå‘¨äº”å¥³ç”Ÿå±€\"\n                  value={formData.name}\n                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                  data-testid=\"input-name\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"eventType\">æ´»åŠ¨ç±»å‹ *</Label>\n                <Select value={formData.eventType} onValueChange={(v) => setFormData({ ...formData, eventType: v })}>\n                  <SelectTrigger data-testid=\"select-event-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {EVENT_TYPES.map(type => (\n                      <SelectItem key={type.value} value={type.value}>{type.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"dayOfWeek\">æ˜ŸæœŸ *</Label>\n                <Select value={formData.dayOfWeek} onValueChange={(v) => setFormData({ ...formData, dayOfWeek: v })}>\n                  <SelectTrigger data-testid=\"select-day-of-week\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {Object.entries(DAY_OF_WEEK_MAP).map(([value, label]) => (\n                      <SelectItem key={value} value={value}>{label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"timeOfDay\">æ—¶é—´ *</Label>\n                <Input\n                  id=\"timeOfDay\"\n                  type=\"time\"\n                  value={formData.timeOfDay}\n                  onChange={(e) => setFormData({ ...formData, timeOfDay: e.target.value })}\n                  data-testid=\"input-time-of-day\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"theme\">ä¸»é¢˜</Label>\n              <Input\n                id=\"theme\"\n                placeholder=\"ä¾‹ï¼šGirls Night, å•†åŠ¡ç¤¾äº¤\"\n                value={formData.theme}\n                onChange={(e) => setFormData({ ...formData, theme: e.target.value })}\n                data-testid=\"input-theme\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"genderRestriction\">æ€§åˆ«é™åˆ¶</Label>\n              <Select value={formData.genderRestriction} onValueChange={(v) => setFormData({ ...formData, genderRestriction: v })}>\n                <SelectTrigger data-testid=\"select-gender-restriction\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {GENDER_RESTRICTIONS.map(restriction => (\n                    <SelectItem key={restriction.value} value={restriction.value}>{restriction.label}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"minAge\">æœ€å°å¹´é¾„</Label>\n                <Input\n                  id=\"minAge\"\n                  type=\"number\"\n                  min=\"18\"\n                  max=\"100\"\n                  placeholder=\"æ— é™åˆ¶\"\n                  value={formData.minAge}\n                  onChange={(e) => setFormData({ ...formData, minAge: e.target.value })}\n                  data-testid=\"input-min-age\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"maxAge\">æœ€å¤§å¹´é¾„</Label>\n                <Input\n                  id=\"maxAge\"\n                  type=\"number\"\n                  min=\"18\"\n                  max=\"100\"\n                  placeholder=\"æ— é™åˆ¶\"\n                  value={formData.maxAge}\n                  onChange={(e) => setFormData({ ...formData, maxAge: e.target.value })}\n                  data-testid=\"input-max-age\"\n                />\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"minParticipants\">æœ€å°‘å‚ä¸äººæ•° *</Label>\n                <Input\n                  id=\"minParticipants\"\n                  type=\"number\"\n                  min=\"2\"\n                  value={formData.minParticipants}\n                  onChange={(e) => setFormData({ ...formData, minParticipants: e.target.value })}\n                  data-testid=\"input-min-participants\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"maxParticipants\">æœ€å¤šå‚ä¸äººæ•° *</Label>\n                <Input\n                  id=\"maxParticipants\"\n                  type=\"number\"\n                  min=\"2\"\n                  value={formData.maxParticipants}\n                  onChange={(e) => setFormData({ ...formData, maxParticipants: e.target.value })}\n                  data-testid=\"input-max-participants\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"customPrice\">è‡ªå®šä¹‰ä»·æ ¼ (Â¥)</Label>\n              <Input\n                id=\"customPrice\"\n                type=\"number\"\n                min=\"0\"\n                placeholder=\"é»˜è®¤ï¼šä¼šå‘˜å…è´¹/éä¼šå‘˜Â¥68\"\n                value={formData.customPrice}\n                onChange={(e) => setFormData({ ...formData, customPrice: e.target.value })}\n                data-testid=\"input-custom-price\"\n              />\n              <p className=\"text-xs text-muted-foreground\">ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤å®šä»·</p>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setShowCreateDialog(false)}\n              data-testid=\"button-cancel-create\"\n            >\n              å–æ¶ˆ\n            </Button>\n            <Button\n              onClick={handleCreate}\n              disabled={createMutation.isPending}\n              data-testid=\"button-confirm-create\"\n            >\n              {createMutation.isPending ? \"åˆ›å»ºä¸­...\" : \"åˆ›å»ºæ¨¡æ¿\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showEditDialog} onOpenChange={setShowEditDialog}>\n        <DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>ç¼–è¾‘æ´»åŠ¨æ¨¡æ¿</DialogTitle>\n            <DialogDescription>ä¿®æ”¹æ´»åŠ¨æ¨¡æ¿ä¿¡æ¯</DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-name\">æ¨¡æ¿åç§° *</Label>\n                <Input\n                  id=\"edit-name\"\n                  placeholder=\"ä¾‹ï¼šå‘¨äº”å¥³ç”Ÿå±€\"\n                  value={formData.name}\n                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                  data-testid=\"input-edit-name\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-eventType\">æ´»åŠ¨ç±»å‹ *</Label>\n                <Select value={formData.eventType} onValueChange={(v) => setFormData({ ...formData, eventType: v })}>\n                  <SelectTrigger data-testid=\"select-edit-event-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {EVENT_TYPES.map(type => (\n                      <SelectItem key={type.value} value={type.value}>{type.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-dayOfWeek\">æ˜ŸæœŸ *</Label>\n                <Select value={formData.dayOfWeek} onValueChange={(v) => setFormData({ ...formData, dayOfWeek: v })}>\n                  <SelectTrigger data-testid=\"select-edit-day-of-week\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {Object.entries(DAY_OF_WEEK_MAP).map(([value, label]) => (\n                      <SelectItem key={value} value={value}>{label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-timeOfDay\">æ—¶é—´ *</Label>\n                <Input\n                  id=\"edit-timeOfDay\"\n                  type=\"time\"\n                  value={formData.timeOfDay}\n                  onChange={(e) => setFormData({ ...formData, timeOfDay: e.target.value })}\n                  data-testid=\"input-edit-time-of-day\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-theme\">ä¸»é¢˜</Label>\n              <Input\n                id=\"edit-theme\"\n                placeholder=\"ä¾‹ï¼šGirls Night, å•†åŠ¡ç¤¾äº¤\"\n                value={formData.theme}\n                onChange={(e) => setFormData({ ...formData, theme: e.target.value })}\n                data-testid=\"input-edit-theme\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-genderRestriction\">æ€§åˆ«é™åˆ¶</Label>\n              <Select value={formData.genderRestriction} onValueChange={(v) => setFormData({ ...formData, genderRestriction: v })}>\n                <SelectTrigger data-testid=\"select-edit-gender-restriction\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {GENDER_RESTRICTIONS.map(restriction => (\n                    <SelectItem key={restriction.value} value={restriction.value}>{restriction.label}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-minAge\">æœ€å°å¹´é¾„</Label>\n                <Input\n                  id=\"edit-minAge\"\n                  type=\"number\"\n                  min=\"18\"\n                  max=\"100\"\n                  placeholder=\"æ— é™åˆ¶\"\n                  value={formData.minAge}\n                  onChange={(e) => setFormData({ ...formData, minAge: e.target.value })}\n                  data-testid=\"input-edit-min-age\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-maxAge\">æœ€å¤§å¹´é¾„</Label>\n                <Input\n                  id=\"edit-maxAge\"\n                  type=\"number\"\n                  min=\"18\"\n                  max=\"100\"\n                  placeholder=\"æ— é™åˆ¶\"\n                  value={formData.maxAge}\n                  onChange={(e) => setFormData({ ...formData, maxAge: e.target.value })}\n                  data-testid=\"input-edit-max-age\"\n                />\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-minParticipants\">æœ€å°‘å‚ä¸äººæ•° *</Label>\n                <Input\n                  id=\"edit-minParticipants\"\n                  type=\"number\"\n                  min=\"2\"\n                  value={formData.minParticipants}\n                  onChange={(e) => setFormData({ ...formData, minParticipants: e.target.value })}\n                  data-testid=\"input-edit-min-participants\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-maxParticipants\">æœ€å¤šå‚ä¸äººæ•° *</Label>\n                <Input\n                  id=\"edit-maxParticipants\"\n                  type=\"number\"\n                  min=\"2\"\n                  value={formData.maxParticipants}\n                  onChange={(e) => setFormData({ ...formData, maxParticipants: e.target.value })}\n                  data-testid=\"input-edit-max-participants\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-customPrice\">è‡ªå®šä¹‰ä»·æ ¼ (Â¥)</Label>\n              <Input\n                id=\"edit-customPrice\"\n                type=\"number\"\n                min=\"0\"\n                placeholder=\"é»˜è®¤ï¼šä¼šå‘˜å…è´¹/éä¼šå‘˜Â¥68\"\n                value={formData.customPrice}\n                onChange={(e) => setFormData({ ...formData, customPrice: e.target.value })}\n                data-testid=\"input-edit-custom-price\"\n              />\n              <p className=\"text-xs text-muted-foreground\">ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤å®šä»·</p>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setShowEditDialog(false)}\n              data-testid=\"button-cancel-edit\"\n            >\n              å–æ¶ˆ\n            </Button>\n            <Button\n              onClick={handleUpdate}\n              disabled={updateMutation.isPending}\n              data-testid=\"button-confirm-edit\"\n            >\n              {updateMutation.isPending ? \"æ›´æ–°ä¸­...\" : \"ä¿å­˜æ›´æ”¹\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>ç¡®è®¤åˆ é™¤</AlertDialogTitle>\n            <AlertDialogDescription>\n              ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ \"{selectedTemplate?.name}\" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">å–æ¶ˆ</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmDelete}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"åˆ é™¤ä¸­...\" : \"ç¡®è®¤åˆ é™¤\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","size_bytes":31455},"client/src/pages/admin/AdminVenuesPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Store, Plus, Edit, Trash2, Building, TrendingUp, Calendar, DollarSign } from \"lucide-react\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface Venue {\n  id: string;\n  name: string;\n  type: string;\n  address: string;\n  city: string;\n  district: string;\n  contactName: string | null;\n  contactPhone: string | null;\n  commissionRate: number;\n  tags: string[] | null;\n  cuisines: string[] | null;\n  priceRange: string | null;\n  maxConcurrentEvents: number;\n  isActive: boolean;\n  notes: string | null;\n  createdAt: string;\n  bookingCount?: number;\n  totalCommission?: number;\n}\n\nconst VENUE_TYPES = [\n  { value: \"restaurant\", label: \"é¤å…\" },\n  { value: \"bar\", label: \"é…’å§\" },\n];\n\nconst CITIES = [\n  { value: \"æ·±åœ³\", label: \"æ·±åœ³\" },\n  { value: \"é¦™æ¸¯\", label: \"é¦™æ¸¯\" },\n];\n\nconst PRICE_RANGES = [\n  { value: \"100-200\", label: \"Â¥100-200\" },\n  { value: \"200-300\", label: \"Â¥200-300\" },\n  { value: \"300+\", label: \"Â¥300+\" },\n];\n\nconst TAGS = [\"cozy\", \"lively\", \"upscale\", \"casual\"];\nconst CUISINES = [\"ç²¤èœ\", \"å·èœ\", \"æ—¥æ–™\", \"è¥¿é¤\", \"é…’å§\"];\n\nexport default function AdminVenuesPage() {\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const [selectedVenue, setSelectedVenue] = useState<Venue | null>(null);\n  const [filterType, setFilterType] = useState<\"all\" | \"restaurant\" | \"bar\">(\"all\");\n  \n  const [formData, setFormData] = useState({\n    name: \"\",\n    type: \"restaurant\",\n    address: \"\",\n    city: \"æ·±åœ³\",\n    district: \"\",\n    contactName: \"\",\n    contactPhone: \"\",\n    commissionRate: \"20\",\n    priceRange: \"100-200\",\n    maxConcurrentEvents: \"1\",\n    tags: [] as string[],\n    cuisines: [] as string[],\n    notes: \"\",\n  });\n\n  const { toast } = useToast();\n\n  const { data: venues = [], isLoading } = useQuery<Venue[]>({\n    queryKey: [\"/api/admin/venues\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: any) =>\n      fetch(\"/api/admin/venues\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      }).then((r) => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/venues\"] });\n      setShowCreateDialog(false);\n      resetForm();\n      toast({\n        title: \"åœºåœ°åˆ›å»ºæˆåŠŸ\",\n        description: \"åœºåœ°å·²æˆåŠŸæ·»åŠ åˆ°ç³»ç»Ÿ\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"åˆ›å»ºå¤±è´¥\",\n        description: \"æ— æ³•åˆ›å»ºåœºåœ°ï¼Œè¯·é‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) =>\n      fetch(`/api/admin/venues/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      }).then((r) => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/venues\"] });\n      setShowEditDialog(false);\n      setSelectedVenue(null);\n      toast({\n        title: \"æ›´æ–°æˆåŠŸ\",\n        description: \"åœºåœ°ä¿¡æ¯å·²æ›´æ–°\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"æ›´æ–°å¤±è´¥\",\n        description: \"æ— æ³•æ›´æ–°åœºåœ°ï¼Œè¯·é‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) =>\n      fetch(`/api/admin/venues/${id}`, {\n        method: \"DELETE\",\n        credentials: \"include\",\n      }).then((r) => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/venues\"] });\n      setShowDeleteDialog(false);\n      setSelectedVenue(null);\n      toast({\n        title: \"åˆ é™¤æˆåŠŸ\",\n        description: \"åœºåœ°å·²ä»ç³»ç»Ÿä¸­åˆ é™¤\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"åˆ é™¤å¤±è´¥\",\n        description: \"æ— æ³•åˆ é™¤åœºåœ°ï¼Œè¯·é‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      type: \"restaurant\",\n      address: \"\",\n      city: \"æ·±åœ³\",\n      district: \"\",\n      contactName: \"\",\n      contactPhone: \"\",\n      commissionRate: \"20\",\n      priceRange: \"100-200\",\n      maxConcurrentEvents: \"1\",\n      tags: [],\n      cuisines: [],\n      notes: \"\",\n    });\n  };\n\n  const handleCreate = () => {\n    if (!formData.name || !formData.type || !formData.address || !formData.city || !formData.district) {\n      toast({\n        title: \"ä¿¡æ¯ä¸å®Œæ•´\",\n        description: \"è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    createMutation.mutate({\n      name: formData.name,\n      type: formData.type,\n      address: formData.address,\n      city: formData.city,\n      district: formData.district,\n      contactName: formData.contactName || undefined,\n      contactPhone: formData.contactPhone || undefined,\n      commissionRate: parseInt(formData.commissionRate),\n      priceRange: formData.priceRange || undefined,\n      maxConcurrentEvents: parseInt(formData.maxConcurrentEvents),\n      tags: formData.tags.length > 0 ? formData.tags : undefined,\n      cuisines: formData.cuisines.length > 0 ? formData.cuisines : undefined,\n      notes: formData.notes || undefined,\n    });\n  };\n\n  const handleEdit = (venue: Venue) => {\n    setSelectedVenue(venue);\n    setFormData({\n      name: venue.name,\n      type: venue.type,\n      address: venue.address,\n      city: venue.city,\n      district: venue.district,\n      contactName: venue.contactName || \"\",\n      contactPhone: venue.contactPhone || \"\",\n      commissionRate: venue.commissionRate.toString(),\n      priceRange: venue.priceRange || \"100-200\",\n      maxConcurrentEvents: venue.maxConcurrentEvents.toString(),\n      tags: venue.tags || [],\n      cuisines: venue.cuisines || [],\n      notes: venue.notes || \"\",\n    });\n    setShowEditDialog(true);\n  };\n\n  const handleUpdate = () => {\n    if (!selectedVenue) return;\n\n    updateMutation.mutate({\n      id: selectedVenue.id,\n      data: {\n        name: formData.name,\n        type: formData.type,\n        address: formData.address,\n        city: formData.city,\n        district: formData.district,\n        contactName: formData.contactName || null,\n        contactPhone: formData.contactPhone || null,\n        commissionRate: parseInt(formData.commissionRate),\n        priceRange: formData.priceRange || null,\n        maxConcurrentEvents: parseInt(formData.maxConcurrentEvents),\n        tags: formData.tags.length > 0 ? formData.tags : null,\n        cuisines: formData.cuisines.length > 0 ? formData.cuisines : null,\n        notes: formData.notes || null,\n      },\n    });\n  };\n\n  const handleDelete = (venue: Venue) => {\n    setSelectedVenue(venue);\n    setShowDeleteDialog(true);\n  };\n\n  const confirmDelete = () => {\n    if (selectedVenue) {\n      deleteMutation.mutate(selectedVenue.id);\n    }\n  };\n\n  const toggleActive = (venue: Venue) => {\n    updateMutation.mutate({\n      id: venue.id,\n      data: { isActive: !venue.isActive },\n    });\n  };\n\n  const toggleTag = (tag: string) => {\n    setFormData(prev => ({\n      ...prev,\n      tags: prev.tags.includes(tag)\n        ? prev.tags.filter(t => t !== tag)\n        : [...prev.tags, tag]\n    }));\n  };\n\n  const toggleCuisine = (cuisine: string) => {\n    setFormData(prev => ({\n      ...prev,\n      cuisines: prev.cuisines.includes(cuisine)\n        ? prev.cuisines.filter(c => c !== cuisine)\n        : [...prev.cuisines, cuisine]\n    }));\n  };\n\n  const getTypeLabel = (type: string) => {\n    return VENUE_TYPES.find(t => t.value === type)?.label || type;\n  };\n\n  const filteredVenues = filterType === \"all\" \n    ? venues \n    : venues.filter(v => v.type === filterType);\n\n  const activeVenues = venues.filter(v => v.isActive).length;\n  const totalBookings = venues.reduce((sum, v) => sum + (v.bookingCount || 0), 0);\n  const totalCommission = venues.reduce((sum, v) => sum + (v.totalCommission || 0), 0);\n\n  return (\n    <div className=\"p-8 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">åœºåœ°ç®¡ç†</h1>\n          <p className=\"text-muted-foreground mt-1\">ç®¡ç†æ´»åŠ¨åœºåœ°å’Œåˆä½œå•†æˆ·</p>\n        </div>\n        <Button onClick={() => { resetForm(); setShowCreateDialog(true); }} data-testid=\"button-create-venue\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          æ·»åŠ åœºåœ°\n        </Button>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ€»åœºåœ°æ•°</CardTitle>\n            <Store className=\"h-4 w-4 text-primary\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"metric-total-venues\">{venues.length}</div>\n            <p className=\"text-xs text-muted-foreground\">å¹³å°åˆä½œåœºåœ°</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ´»è·ƒåœºåœ°</CardTitle>\n            <Building className=\"h-4 w-4 text-green-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"metric-active-venues\">{activeVenues}</div>\n            <p className=\"text-xs text-muted-foreground\">å½“å‰å¯ç”¨åœºåœ°</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ€»é¢„è®¢æ•°</CardTitle>\n            <Calendar className=\"h-4 w-4 text-blue-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"metric-total-bookings\">{totalBookings}</div>\n            <p className=\"text-xs text-muted-foreground\">ç´¯è®¡é¢„è®¢æ¬¡æ•°</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">ä½£é‡‘æ”¶å…¥</CardTitle>\n            <DollarSign className=\"h-4 w-4 text-amber-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"metric-commission-earned\">Â¥{totalCommission.toLocaleString()}</div>\n            <p className=\"text-xs text-muted-foreground\">ç´¯è®¡ä½£é‡‘</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Tabs value={filterType} onValueChange={(v) => setFilterType(v as any)}>\n        <TabsList>\n          <TabsTrigger value=\"all\" data-testid=\"filter-all\">å…¨éƒ¨</TabsTrigger>\n          <TabsTrigger value=\"restaurant\" data-testid=\"filter-restaurant\">é¤å…</TabsTrigger>\n          <TabsTrigger value=\"bar\" data-testid=\"filter-bar\">é…’å§</TabsTrigger>\n        </TabsList>\n      </Tabs>\n\n      {isLoading ? (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3].map((i) => (\n            <Card key={i} className=\"animate-pulse\">\n              <CardHeader className=\"space-y-2\">\n                <div className=\"h-4 bg-muted rounded w-3/4\" />\n                <div className=\"h-3 bg-muted rounded w-1/2\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2\">\n                  <div className=\"h-3 bg-muted rounded\" />\n                  <div className=\"h-3 bg-muted rounded w-5/6\" />\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : filteredVenues.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-12 text-center text-muted-foreground\">\n            {filterType === \"all\" ? \"æš‚æ— åœºåœ°è®°å½•\" : `æš‚æ— ${getTypeLabel(filterType)}è®°å½•`}\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {filteredVenues.map((venue) => (\n            <Card key={venue.id} data-testid={`card-venue-${venue.id}`}>\n              <CardHeader className=\"flex flex-row items-start justify-between gap-2 space-y-0 pb-3\">\n                <div className=\"flex-1 min-w-0\">\n                  <CardTitle className=\"text-lg flex items-center gap-2\">\n                    {venue.name}\n                    <Badge variant=\"outline\">{getTypeLabel(venue.type)}</Badge>\n                  </CardTitle>\n                  <p className=\"text-sm text-muted-foreground truncate\">{venue.city} Â· {venue.district}</p>\n                </div>\n                {venue.isActive ? (\n                  <Badge className=\"bg-green-500\">æ´»è·ƒ</Badge>\n                ) : (\n                  <Badge variant=\"secondary\">å·²åœç”¨</Badge>\n                )}\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                <div className=\"space-y-2 text-sm\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">åœ°å€</span>\n                    <span className=\"font-medium text-right truncate max-w-[60%]\">{venue.address}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">ä½£é‡‘æ¯”ä¾‹</span>\n                    <span className=\"font-medium\">{venue.commissionRate}%</span>\n                  </div>\n                  {venue.priceRange && (\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">äººå‡æ¶ˆè´¹</span>\n                      <span className=\"font-medium\">Â¥{venue.priceRange}</span>\n                    </div>\n                  )}\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">é¢„è®¢æ¬¡æ•°</span>\n                    <span className=\"font-medium\">{venue.bookingCount || 0}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">æ€»ä½£é‡‘</span>\n                    <span className=\"font-medium\">Â¥{(venue.totalCommission || 0).toLocaleString()}</span>\n                  </div>\n                </div>\n\n                {venue.tags && venue.tags.length > 0 && (\n                  <div className=\"flex flex-wrap gap-1\">\n                    {venue.tags.map(tag => (\n                      <Badge key={tag} variant=\"secondary\" className=\"text-xs\">{tag}</Badge>\n                    ))}\n                  </div>\n                )}\n\n                {venue.cuisines && venue.cuisines.length > 0 && (\n                  <div className=\"flex flex-wrap gap-1\">\n                    {venue.cuisines.map(cuisine => (\n                      <Badge key={cuisine} variant=\"outline\" className=\"text-xs\">{cuisine}</Badge>\n                    ))}\n                  </div>\n                )}\n\n                <div className=\"flex items-center justify-between pt-2 border-t\">\n                  <div className=\"flex items-center gap-2\">\n                    <Switch\n                      checked={venue.isActive}\n                      onCheckedChange={() => toggleActive(venue)}\n                      data-testid={`toggle-active-${venue.id}`}\n                    />\n                    <span className=\"text-xs text-muted-foreground\">\n                      {venue.isActive ? \"æ´»è·ƒ\" : \"åœç”¨\"}\n                    </span>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      onClick={() => handleEdit(venue)}\n                      data-testid={`button-edit-${venue.id}`}\n                    >\n                      <Edit className=\"h-3 w-3\" />\n                    </Button>\n                    <Button\n                      size=\"sm\"\n                      variant=\"destructive\"\n                      onClick={() => handleDelete(venue)}\n                      data-testid={`button-delete-${venue.id}`}\n                    >\n                      <Trash2 className=\"h-3 w-3\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>æ·»åŠ åœºåœ°</DialogTitle>\n            <DialogDescription>åˆ›å»ºæ–°çš„æ´»åŠ¨åœºåœ°</DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"name\">åœºåœ°åç§° *</Label>\n                <Input\n                  id=\"name\"\n                  placeholder=\"ä¾‹ï¼šæµ·åº•æç«é”…\"\n                  value={formData.name}\n                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                  data-testid=\"input-name\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"type\">åœºåœ°ç±»å‹ *</Label>\n                <Select value={formData.type} onValueChange={(v) => setFormData({ ...formData, type: v })}>\n                  <SelectTrigger data-testid=\"select-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {VENUE_TYPES.map(type => (\n                      <SelectItem key={type.value} value={type.value}>{type.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"address\">åœ°å€ *</Label>\n              <Textarea\n                id=\"address\"\n                placeholder=\"è¯¦ç»†åœ°å€\"\n                value={formData.address}\n                onChange={(e) => setFormData({ ...formData, address: e.target.value })}\n                rows={2}\n                data-testid=\"input-address\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"city\">åŸå¸‚ *</Label>\n                <Select value={formData.city} onValueChange={(v) => setFormData({ ...formData, city: v })}>\n                  <SelectTrigger data-testid=\"select-city\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {CITIES.map(city => (\n                      <SelectItem key={city.value} value={city.value}>{city.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"district\">åŒºåŸŸ *</Label>\n                <Input\n                  id=\"district\"\n                  placeholder=\"ä¾‹ï¼šå—å±±åŒº\"\n                  value={formData.district}\n                  onChange={(e) => setFormData({ ...formData, district: e.target.value })}\n                  data-testid=\"input-district\"\n                />\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"contactName\">è”ç³»äºº</Label>\n                <Input\n                  id=\"contactName\"\n                  placeholder=\"è”ç³»äººå§“å\"\n                  value={formData.contactName}\n                  onChange={(e) => setFormData({ ...formData, contactName: e.target.value })}\n                  data-testid=\"input-contact-name\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"contactPhone\">è”ç³»ç”µè¯</Label>\n                <Input\n                  id=\"contactPhone\"\n                  placeholder=\"è”ç³»ç”µè¯\"\n                  value={formData.contactPhone}\n                  onChange={(e) => setFormData({ ...formData, contactPhone: e.target.value })}\n                  data-testid=\"input-contact-phone\"\n                />\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-3 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"commissionRate\">ä½£é‡‘æ¯”ä¾‹ (%)</Label>\n                <Input\n                  id=\"commissionRate\"\n                  type=\"number\"\n                  min=\"0\"\n                  max=\"100\"\n                  value={formData.commissionRate}\n                  onChange={(e) => setFormData({ ...formData, commissionRate: e.target.value })}\n                  data-testid=\"input-commission-rate\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"priceRange\">äººå‡æ¶ˆè´¹</Label>\n                <Select value={formData.priceRange} onValueChange={(v) => setFormData({ ...formData, priceRange: v })}>\n                  <SelectTrigger data-testid=\"select-price-range\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {PRICE_RANGES.map(range => (\n                      <SelectItem key={range.value} value={range.value}>{range.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"maxConcurrentEvents\">æœ€å¤§åŒæ—¶æ´»åŠ¨æ•°</Label>\n                <Input\n                  id=\"maxConcurrentEvents\"\n                  type=\"number\"\n                  min=\"1\"\n                  value={formData.maxConcurrentEvents}\n                  onChange={(e) => setFormData({ ...formData, maxConcurrentEvents: e.target.value })}\n                  data-testid=\"input-max-events\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>æ°›å›´æ ‡ç­¾</Label>\n              <div className=\"flex flex-wrap gap-2\">\n                {TAGS.map(tag => (\n                  <Badge\n                    key={tag}\n                    variant={formData.tags.includes(tag) ? \"default\" : \"outline\"}\n                    className=\"cursor-pointer hover-elevate active-elevate-2\"\n                    onClick={() => toggleTag(tag)}\n                    data-testid={`tag-${tag}`}\n                  >\n                    {tag}\n                  </Badge>\n                ))}\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>èœç³»ç±»å‹</Label>\n              <div className=\"flex flex-wrap gap-2\">\n                {CUISINES.map(cuisine => (\n                  <Badge\n                    key={cuisine}\n                    variant={formData.cuisines.includes(cuisine) ? \"default\" : \"outline\"}\n                    className=\"cursor-pointer hover-elevate active-elevate-2\"\n                    onClick={() => toggleCuisine(cuisine)}\n                    data-testid={`cuisine-${cuisine}`}\n                  >\n                    {cuisine}\n                  </Badge>\n                ))}\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"notes\">å¤‡æ³¨</Label>\n              <Textarea\n                id=\"notes\"\n                placeholder=\"å†…éƒ¨å¤‡æ³¨ä¿¡æ¯\"\n                value={formData.notes}\n                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                rows={3}\n                data-testid=\"input-notes\"\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => { setShowCreateDialog(false); resetForm(); }} data-testid=\"button-cancel\">\n              å–æ¶ˆ\n            </Button>\n            <Button onClick={handleCreate} disabled={createMutation.isPending} data-testid=\"button-submit-venue\">\n              {createMutation.isPending ? \"åˆ›å»ºä¸­...\" : \"åˆ›å»ºåœºåœ°\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={showEditDialog} onOpenChange={setShowEditDialog}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>ç¼–è¾‘åœºåœ°</DialogTitle>\n            <DialogDescription>ä¿®æ”¹åœºåœ°ä¿¡æ¯</DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4 py-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-name\">åœºåœ°åç§° *</Label>\n                <Input\n                  id=\"edit-name\"\n                  placeholder=\"ä¾‹ï¼šæµ·åº•æç«é”…\"\n                  value={formData.name}\n                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                  data-testid=\"input-edit-name\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-type\">åœºåœ°ç±»å‹ *</Label>\n                <Select value={formData.type} onValueChange={(v) => setFormData({ ...formData, type: v })}>\n                  <SelectTrigger data-testid=\"select-edit-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {VENUE_TYPES.map(type => (\n                      <SelectItem key={type.value} value={type.value}>{type.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-address\">åœ°å€ *</Label>\n              <Textarea\n                id=\"edit-address\"\n                placeholder=\"è¯¦ç»†åœ°å€\"\n                value={formData.address}\n                onChange={(e) => setFormData({ ...formData, address: e.target.value })}\n                rows={2}\n                data-testid=\"input-edit-address\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-city\">åŸå¸‚ *</Label>\n                <Select value={formData.city} onValueChange={(v) => setFormData({ ...formData, city: v })}>\n                  <SelectTrigger data-testid=\"select-edit-city\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {CITIES.map(city => (\n                      <SelectItem key={city.value} value={city.value}>{city.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-district\">åŒºåŸŸ *</Label>\n                <Input\n                  id=\"edit-district\"\n                  placeholder=\"ä¾‹ï¼šå—å±±åŒº\"\n                  value={formData.district}\n                  onChange={(e) => setFormData({ ...formData, district: e.target.value })}\n                  data-testid=\"input-edit-district\"\n                />\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-contactName\">è”ç³»äºº</Label>\n                <Input\n                  id=\"edit-contactName\"\n                  placeholder=\"è”ç³»äººå§“å\"\n                  value={formData.contactName}\n                  onChange={(e) => setFormData({ ...formData, contactName: e.target.value })}\n                  data-testid=\"input-edit-contact-name\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-contactPhone\">è”ç³»ç”µè¯</Label>\n                <Input\n                  id=\"edit-contactPhone\"\n                  placeholder=\"è”ç³»ç”µè¯\"\n                  value={formData.contactPhone}\n                  onChange={(e) => setFormData({ ...formData, contactPhone: e.target.value })}\n                  data-testid=\"input-edit-contact-phone\"\n                />\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-3 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-commissionRate\">ä½£é‡‘æ¯”ä¾‹ (%)</Label>\n                <Input\n                  id=\"edit-commissionRate\"\n                  type=\"number\"\n                  min=\"0\"\n                  max=\"100\"\n                  value={formData.commissionRate}\n                  onChange={(e) => setFormData({ ...formData, commissionRate: e.target.value })}\n                  data-testid=\"input-edit-commission-rate\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-priceRange\">äººå‡æ¶ˆè´¹</Label>\n                <Select value={formData.priceRange} onValueChange={(v) => setFormData({ ...formData, priceRange: v })}>\n                  <SelectTrigger data-testid=\"select-edit-price-range\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {PRICE_RANGES.map(range => (\n                      <SelectItem key={range.value} value={range.value}>{range.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-maxConcurrentEvents\">æœ€å¤§åŒæ—¶æ´»åŠ¨æ•°</Label>\n                <Input\n                  id=\"edit-maxConcurrentEvents\"\n                  type=\"number\"\n                  min=\"1\"\n                  value={formData.maxConcurrentEvents}\n                  onChange={(e) => setFormData({ ...formData, maxConcurrentEvents: e.target.value })}\n                  data-testid=\"input-edit-max-events\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>æ°›å›´æ ‡ç­¾</Label>\n              <div className=\"flex flex-wrap gap-2\">\n                {TAGS.map(tag => (\n                  <Badge\n                    key={tag}\n                    variant={formData.tags.includes(tag) ? \"default\" : \"outline\"}\n                    className=\"cursor-pointer hover-elevate active-elevate-2\"\n                    onClick={() => toggleTag(tag)}\n                    data-testid={`edit-tag-${tag}`}\n                  >\n                    {tag}\n                  </Badge>\n                ))}\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>èœç³»ç±»å‹</Label>\n              <div className=\"flex flex-wrap gap-2\">\n                {CUISINES.map(cuisine => (\n                  <Badge\n                    key={cuisine}\n                    variant={formData.cuisines.includes(cuisine) ? \"default\" : \"outline\"}\n                    className=\"cursor-pointer hover-elevate active-elevate-2\"\n                    onClick={() => toggleCuisine(cuisine)}\n                    data-testid={`edit-cuisine-${cuisine}`}\n                  >\n                    {cuisine}\n                  </Badge>\n                ))}\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-notes\">å¤‡æ³¨</Label>\n              <Textarea\n                id=\"edit-notes\"\n                placeholder=\"å†…éƒ¨å¤‡æ³¨ä¿¡æ¯\"\n                value={formData.notes}\n                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                rows={3}\n                data-testid=\"input-edit-notes\"\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowEditDialog(false)} data-testid=\"button-cancel-edit\">\n              å–æ¶ˆ\n            </Button>\n            <Button onClick={handleUpdate} disabled={updateMutation.isPending} data-testid=\"button-submit-edit\">\n              {updateMutation.isPending ? \"æ›´æ–°ä¸­...\" : \"æ›´æ–°åœºåœ°\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>ç¡®è®¤åˆ é™¤</AlertDialogTitle>\n            <AlertDialogDescription>\n              ç¡®å®šè¦åˆ é™¤åœºåœ° \"{selectedVenue?.name}\" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">å–æ¶ˆ</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmDelete}\n              disabled={deleteMutation.isPending}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? \"åˆ é™¤ä¸­...\" : \"ç¡®è®¤åˆ é™¤\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","size_bytes":34583},"client/src/pages/admin/AdminDataInsightsPage.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { \n  TrendingUp, \n  TrendingDown, \n  Minus,\n  Users, \n  DollarSign, \n  Target, \n  Clock,\n  Star,\n  AlertTriangle,\n  CheckCircle\n} from \"lucide-react\";\nimport {\n  PieChart,\n  Pie,\n  Cell,\n  LineChart,\n  Line,\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  Legend,\n  ResponsiveContainer,\n} from \"recharts\";\n\ninterface InsightsData {\n  engagementMetrics: {\n    totalUsers: number;\n    activeUsers: number;\n    totalEvents: number;\n    avgEventsPerUser: number;\n    newUsers7Days: number;\n    newUsersPrevious7Days: number;\n  };\n  userGrowth: { date: string; count: number }[];\n  eventTrends: { date: string; count: number }[];\n  personalityDistribution: { archetype: string; count: number }[];\n  matchingEfficiency: {\n    successRate: number;\n    avgMatchTime: number;\n    attemptsPerUser: number;\n  };\n  retention: {\n    weeklyRetention: { week: number; retentionRate: number }[];\n    userSegments: {\n      new: number;\n      active: number;\n      dormant: number;\n      churned: number;\n    };\n    superUsers: {\n      count: number;\n      topArchetypes: { archetype: string; count: number }[];\n    };\n  };\n  eventQuality: {\n    completionRate: number;\n    avgRating: number;\n    complaintRate: number;\n    lowRatedEvents: { event_id: string; title: string; avg_rating: number; date: string }[];\n  };\n  monetization: {\n    conversionRate: number;\n    revenueBreakdown: {\n      subscription: number;\n      singleEvent: number;\n    };\n    arpu: number;\n    conversionFunnel: {\n      registered: number;\n      browsedEvents: number;\n      signedUp: number;\n      paid: number;\n    };\n    monthlyRevenue: number;\n  };\n}\n\nconst COLORS = {\n  new: \"hsl(145, 60%, 45%)\",\n  active: \"hsl(200, 80%, 50%)\",\n  dormant: \"hsl(35, 85%, 60%)\",\n  churned: \"hsl(0, 70%, 60%)\",\n};\n\nfunction TrendIndicator({ current, previous }: { current: number; previous: number }) {\n  if (previous === 0) {\n    return <span className=\"text-muted-foreground text-xs flex items-center gap-1\"><Minus className=\"h-3 w-3\" /> æ— æ•°æ®</span>;\n  }\n  \n  const percentChange = ((current - previous) / previous) * 100;\n  \n  if (Math.abs(percentChange) < 1) {\n    return (\n      <span className=\"text-muted-foreground text-xs flex items-center gap-1\">\n        <Minus className=\"h-3 w-3\" /> æŒå¹³\n      </span>\n    );\n  }\n  \n  if (percentChange > 0) {\n    return (\n      <span className=\"text-green-600 text-xs flex items-center gap-1\">\n        <TrendingUp className=\"h-3 w-3\" /> +{percentChange.toFixed(1)}%\n      </span>\n    );\n  }\n  \n  return (\n    <span className=\"text-red-600 text-xs flex items-center gap-1\">\n      <TrendingDown className=\"h-3 w-3\" /> {percentChange.toFixed(1)}%\n    </span>\n  );\n}\n\nfunction StarRating({ rating }: { rating: number }) {\n  const fullStars = Math.floor(rating);\n  const hasHalfStar = rating % 1 >= 0.5;\n  \n  return (\n    <div className=\"flex items-center gap-1\">\n      {[...Array(5)].map((_, i) => (\n        <Star\n          key={i}\n          className={`h-4 w-4 ${\n            i < fullStars\n              ? \"fill-yellow-400 text-yellow-400\"\n              : i === fullStars && hasHalfStar\n              ? \"fill-yellow-200 text-yellow-400\"\n              : \"text-muted-foreground\"\n          }`}\n        />\n      ))}\n      <span className=\"ml-1 text-sm font-medium\">{rating.toFixed(1)}</span>\n    </div>\n  );\n}\n\nexport default function AdminDataInsightsPage() {\n  const { data: insights, isLoading, error } = useQuery<InsightsData>({\n    queryKey: [\"/api/admin/insights\"],\n  });\n\n  if (error) {\n    return (\n      <div className=\"p-8\">\n        <div className=\"text-center py-12\">\n          <AlertTriangle className=\"h-12 w-12 text-destructive mx-auto mb-4\" />\n          <h3 className=\"text-lg font-semibold mb-2\">åŠ è½½å¤±è´¥</h3>\n          <p className=\"text-muted-foreground\">æ— æ³•åŠ è½½æ•°æ®æ´å¯Ÿï¼Œè¯·ç¨åé‡è¯•</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-8 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"heading-insights\">è¿è¥å†³ç­–æŒ‡æŒ¥ä¸­å¿ƒ</h1>\n        <p className=\"text-muted-foreground mt-1\">å®æ—¶ç›‘æ§å¹³å°æ ¸å¿ƒè¿è¥æŒ‡æ ‡</p>\n      </div>\n\n      {/* Top KPI Cards */}\n      <div className=\"grid gap-6 md:grid-cols-3\">\n        {/* 1. User Scale Card */}\n        <Card data-testid=\"card-kpi-user-scale\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">ç”¨æˆ·è§„æ¨¡</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <Skeleton className=\"h-8 w-24 mb-4\" />\n            ) : (\n              <>\n                <div className=\"text-2xl font-bold mb-1\" data-testid=\"text-total-users\">\n                  {insights?.engagementMetrics.totalUsers.toLocaleString() || 0}\n                </div>\n                <div className=\"space-y-2 text-sm\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-muted-foreground\">æ–°å¢ç”¨æˆ·ï¼ˆ7å¤©ï¼‰</span>\n                    <span className=\"font-medium\" data-testid=\"text-new-users-7d\">\n                      +{insights?.engagementMetrics.newUsers7Days || 0}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-muted-foreground\">æ´»è·ƒç”¨æˆ·ï¼ˆ30å¤©ï¼‰</span>\n                    <span className=\"font-medium\" data-testid=\"text-active-users-30d\">\n                      {insights?.engagementMetrics.activeUsers || 0}\n                    </span>\n                  </div>\n                  {insights && (\n                    <div className=\"pt-1\">\n                      <TrendIndicator\n                        current={insights.engagementMetrics.newUsers7Days}\n                        previous={insights.engagementMetrics.newUsersPrevious7Days}\n                      />\n                    </div>\n                  )}\n                </div>\n              </>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* 2. Business Health Card */}\n        <Card data-testid=\"card-kpi-business-health\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">å•†ä¸šå¥åº·</CardTitle>\n            <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <Skeleton className=\"h-8 w-24 mb-4\" />\n            ) : (\n              <>\n                <div className=\"text-2xl font-bold mb-1\" data-testid=\"text-monthly-revenue\">\n                  Â¥{(insights?.monetization.monthlyRevenue || 0).toLocaleString()}\n                </div>\n                <p className=\"text-xs text-muted-foreground mb-3\">æœ¬æœˆæ”¶å…¥</p>\n                <div className=\"space-y-2 text-sm\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-muted-foreground\">ä»˜è´¹è½¬åŒ–ç‡</span>\n                    <span className=\"font-medium\" data-testid=\"text-conversion-rate\">\n                      {insights?.monetization.conversionRate.toFixed(1) || 0}%\n                    </span>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-muted-foreground\">ARPU</span>\n                    <span className=\"font-medium\" data-testid=\"text-arpu\">\n                      Â¥{(insights?.monetization.arpu || 0).toFixed(0)}\n                    </span>\n                  </div>\n                </div>\n              </>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* 3. Matching Efficiency Card */}\n        <Card data-testid=\"card-kpi-matching-efficiency\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-2 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">åŒ¹é…æ•ˆç‡</CardTitle>\n            <Target className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <Skeleton className=\"h-8 w-24 mb-4\" />\n            ) : (\n              <>\n                <div className=\"text-2xl font-bold mb-1\" data-testid=\"text-match-success-rate\">\n                  {insights?.matchingEfficiency.successRate.toFixed(1) || 0}%\n                </div>\n                <p className=\"text-xs text-muted-foreground mb-3\">åŒ¹é…æˆåŠŸç‡</p>\n                <div className=\"space-y-2 text-sm\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-muted-foreground\">å¹³å‡åŒ¹é…è€—æ—¶</span>\n                    <span className=\"font-medium flex items-center gap-1\" data-testid=\"text-avg-match-time\">\n                      <Clock className=\"h-3 w-3\" />\n                      {insights?.matchingEfficiency.avgMatchTime.toFixed(1) || 0}h\n                    </span>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-muted-foreground\">äººå‡æŠ¥åæ¬¡æ•°</span>\n                    <span className=\"font-medium\" data-testid=\"text-attempts-per-user\">\n                      {insights?.matchingEfficiency.attemptsPerUser.toFixed(1) || 0}\n                    </span>\n                  </div>\n                </div>\n              </>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Middle Analysis Cards */}\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        {/* User Segmentation Pie Chart */}\n        <Card data-testid=\"card-user-segmentation\">\n          <CardHeader>\n            <CardTitle>ç”¨æˆ·åˆ†å±‚</CardTitle>\n            <CardDescription>æŒ‰æ´»è·ƒåº¦åˆ’åˆ†çš„ç”¨æˆ·ç¾¤ä½“</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <Skeleton className=\"h-64 w-full\" />\n            ) : insights?.retention.userSegments ? (\n              <div className=\"space-y-4\">\n                <ResponsiveContainer width=\"100%\" height={250}>\n                  <PieChart>\n                    <Pie\n                      data={[\n                        { name: \"æ–°ç”¨æˆ·\", value: insights.retention.userSegments.new, color: COLORS.new },\n                        { name: \"æ´»è·ƒ\", value: insights.retention.userSegments.active, color: COLORS.active },\n                        { name: \"æ²‰é»˜\", value: insights.retention.userSegments.dormant, color: COLORS.dormant },\n                        { name: \"æµå¤±\", value: insights.retention.userSegments.churned, color: COLORS.churned },\n                      ]}\n                      cx=\"50%\"\n                      cy=\"50%\"\n                      labelLine={false}\n                      label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}\n                      outerRadius={80}\n                      fill=\"#8884d8\"\n                      dataKey=\"value\"\n                    >\n                      {[\n                        COLORS.new,\n                        COLORS.active,\n                        COLORS.dormant,\n                        COLORS.churned,\n                      ].map((color, index) => (\n                        <Cell key={`cell-${index}`} fill={color} />\n                      ))}\n                    </Pie>\n                    <Tooltip />\n                  </PieChart>\n                </ResponsiveContainer>\n                <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                  <div className=\"flex items-center gap-2\" data-testid=\"segment-new\">\n                    <div className=\"w-3 h-3 rounded-full\" style={{ backgroundColor: COLORS.new }} />\n                    <span>æ–°ç”¨æˆ·: {insights.retention.userSegments.new}</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\" data-testid=\"segment-active\">\n                    <div className=\"w-3 h-3 rounded-full\" style={{ backgroundColor: COLORS.active }} />\n                    <span>æ´»è·ƒ: {insights.retention.userSegments.active}</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\" data-testid=\"segment-dormant\">\n                    <div className=\"w-3 h-3 rounded-full\" style={{ backgroundColor: COLORS.dormant }} />\n                    <span>æ²‰é»˜: {insights.retention.userSegments.dormant}</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\" data-testid=\"segment-churned\">\n                    <div className=\"w-3 h-3 rounded-full\" style={{ backgroundColor: COLORS.churned }} />\n                    <span>æµå¤±: {insights.retention.userSegments.churned}</span>\n                  </div>\n                </div>\n              </div>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">æš‚æ— æ•°æ®</div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Event Quality Dashboard */}\n        <Card data-testid=\"card-event-quality\">\n          <CardHeader>\n            <CardTitle>æ´»åŠ¨è´¨é‡ä»ªè¡¨ç›˜</CardTitle>\n            <CardDescription>è¯„ä¼°æ´»åŠ¨å®Œæˆåº¦ä¸ç”¨æˆ·æ»¡æ„åº¦</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <Skeleton className=\"h-64 w-full\" />\n            ) : (\n              <div className=\"space-y-6\">\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm text-muted-foreground\">æ´»åŠ¨å®Œæˆç‡</span>\n                    <span className=\"text-lg font-bold\" data-testid=\"text-completion-rate\">\n                      {insights?.eventQuality.completionRate.toFixed(1) || 0}%\n                    </span>\n                  </div>\n                  <div className=\"h-2 bg-muted rounded-full overflow-hidden\">\n                    <div\n                      className=\"h-full bg-green-500 transition-all\"\n                      style={{ width: `${insights?.eventQuality.completionRate || 0}%` }}\n                    />\n                  </div>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm text-muted-foreground\">å¹³å‡è¯„åˆ†</span>\n                    <div data-testid=\"rating-average\">\n                      <StarRating rating={insights?.eventQuality.avgRating || 0} />\n                    </div>\n                  </div>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm text-muted-foreground\">æŠ•è¯‰ç‡</span>\n                    <span\n                      className={`text-lg font-bold ${\n                        (insights?.eventQuality.complaintRate || 0) > 5 ? \"text-red-600\" : \"text-green-600\"\n                      }`}\n                      data-testid=\"text-complaint-rate\"\n                    >\n                      {insights?.eventQuality.complaintRate.toFixed(1) || 0}%\n                    </span>\n                  </div>\n                  <div className=\"h-2 bg-muted rounded-full overflow-hidden\">\n                    <div\n                      className={`h-full transition-all ${\n                        (insights?.eventQuality.complaintRate || 0) > 5 ? \"bg-red-500\" : \"bg-green-500\"\n                      }`}\n                      style={{ width: `${Math.min(insights?.eventQuality.complaintRate || 0, 100)}%` }}\n                    />\n                  </div>\n                </div>\n\n                {insights && insights.retention.superUsers.count > 0 && (\n                  <div className=\"pt-4 border-t\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                      <span className=\"text-sm font-medium\">è¶…çº§ç”¨æˆ·: {insights.retention.superUsers.count}</span>\n                    </div>\n                    {insights.retention.superUsers.topArchetypes.length > 0 && (\n                      <div className=\"text-xs text-muted-foreground\">\n                        ä¸»è¦è§’è‰²: {insights.retention.superUsers.topArchetypes.map(a => a.archetype).join(\", \")}\n                      </div>\n                    )}\n                  </div>\n                )}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Bottom Deep Analysis */}\n      <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n        {/* User Retention Curve */}\n        <Card className=\"md:col-span-2\" data-testid=\"card-retention-curve\">\n          <CardHeader>\n            <CardTitle>ç”¨æˆ·ç•™å­˜æ›²çº¿</CardTitle>\n            <CardDescription>æŒ‰å‘¨ç»Ÿè®¡çš„ç”¨æˆ·ç•™å­˜ç‡</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <Skeleton className=\"h-64 w-full\" />\n            ) : insights?.retention.weeklyRetention ? (\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <LineChart data={insights.retention.weeklyRetention}>\n                  <CartesianGrid strokeDasharray=\"3 3\" />\n                  <XAxis\n                    dataKey=\"week\"\n                    label={{ value: \"å‘¨\", position: \"insideBottom\", offset: -5 }}\n                  />\n                  <YAxis\n                    label={{ value: \"ç•™å­˜ç‡ (%)\", angle: -90, position: \"insideLeft\" }}\n                  />\n                  <Tooltip\n                    formatter={(value: number) => `${value.toFixed(1)}%`}\n                    labelFormatter={(label) => `ç¬¬${label}å‘¨`}\n                  />\n                  <Legend />\n                  <Line\n                    type=\"monotone\"\n                    dataKey=\"retentionRate\"\n                    stroke=\"hsl(200, 80%, 50%)\"\n                    strokeWidth={2}\n                    name=\"ç•™å­˜ç‡\"\n                    dot={{ r: 4 }}\n                  />\n                </LineChart>\n              </ResponsiveContainer>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">æš‚æ— æ•°æ®</div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Conversion Funnel */}\n        <Card data-testid=\"card-conversion-funnel\">\n          <CardHeader>\n            <CardTitle>æ”¶å…¥è½¬åŒ–æ¼æ–—</CardTitle>\n            <CardDescription>ç”¨æˆ·ä»æ³¨å†Œåˆ°ä»˜è´¹çš„è½¬åŒ–è·¯å¾„</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <Skeleton className=\"h-64 w-full\" />\n            ) : insights?.monetization.conversionFunnel ? (\n              <div className=\"space-y-3\">\n                {[\n                  { label: \"æ³¨å†Œ\", value: insights.monetization.conversionFunnel.registered, color: \"bg-blue-500\" },\n                  { label: \"æµè§ˆæ´»åŠ¨\", value: insights.monetization.conversionFunnel.browsedEvents, color: \"bg-cyan-500\" },\n                  { label: \"æŠ¥åæ´»åŠ¨\", value: insights.monetization.conversionFunnel.signedUp, color: \"bg-green-500\" },\n                  { label: \"ä»˜è´¹\", value: insights.monetization.conversionFunnel.paid, color: \"bg-purple-500\" },\n                ].map((stage, idx) => {\n                  const percentage =\n                    insights.monetization.conversionFunnel.registered > 0\n                      ? (stage.value / insights.monetization.conversionFunnel.registered) * 100\n                      : 0;\n                  return (\n                    <div key={idx} className=\"space-y-1\" data-testid={`funnel-stage-${idx}`}>\n                      <div className=\"flex items-center justify-between text-sm\">\n                        <span className=\"font-medium\">{stage.label}</span>\n                        <span className=\"text-muted-foreground\">\n                          {stage.value} ({percentage.toFixed(1)}%)\n                        </span>\n                      </div>\n                      <div className=\"h-8 bg-muted rounded overflow-hidden\">\n                        <div\n                          className={`h-full ${stage.color} transition-all flex items-center justify-center text-white text-xs font-medium`}\n                          style={{ width: `${percentage}%` }}\n                        >\n                          {percentage > 20 && `${percentage.toFixed(0)}%`}\n                        </div>\n                      </div>\n                    </div>\n                  );\n                })}\n                <div className=\"pt-3 border-t text-sm\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-muted-foreground\">è®¢é˜…æ”¶å…¥</span>\n                    <span className=\"font-medium\">\n                      Â¥{insights.monetization.revenueBreakdown.subscription.toLocaleString()}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center justify-between mt-1\">\n                    <span className=\"text-muted-foreground\">å•æ¬¡æ´»åŠ¨æ”¶å…¥</span>\n                    <span className=\"font-medium\">\n                      Â¥{insights.monetization.revenueBreakdown.singleEvent.toLocaleString()}\n                    </span>\n                  </div>\n                </div>\n              </div>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">æš‚æ— æ•°æ®</div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Personality Distribution Bar Chart */}\n      <Card data-testid=\"card-personality-distribution\">\n        <CardHeader>\n          <CardTitle>ç¤¾äº¤è§’è‰²åˆ†å¸ƒ</CardTitle>\n          <CardDescription>å„ç¤¾äº¤è§’è‰²åœ¨ç”¨æˆ·ä¸­çš„åˆ†å¸ƒæƒ…å†µ</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <Skeleton className=\"h-64 w-full\" />\n          ) : insights?.personalityDistribution && insights.personalityDistribution.length > 0 ? (\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <BarChart\n                data={insights.personalityDistribution}\n                layout=\"horizontal\"\n                margin={{ top: 5, right: 30, left: 20, bottom: 5 }}\n              >\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis type=\"number\" />\n                <YAxis dataKey=\"archetype\" type=\"category\" width={80} />\n                <Tooltip />\n                <Legend />\n                <Bar dataKey=\"count\" fill=\"hsl(280, 45%, 55%)\" name=\"ç”¨æˆ·æ•°\" />\n              </BarChart>\n            </ResponsiveContainer>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">æš‚æ— æ•°æ®</div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Low Rated Events Alert (if any) */}\n      {insights?.eventQuality.lowRatedEvents && insights.eventQuality.lowRatedEvents.length > 0 && (\n        <Card className=\"border-yellow-200 bg-yellow-50\" data-testid=\"card-low-rated-events\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <AlertTriangle className=\"h-5 w-5 text-yellow-600\" />\n              ä½è¯„åˆ†æ´»åŠ¨é¢„è­¦\n            </CardTitle>\n            <CardDescription>ä»¥ä¸‹æ´»åŠ¨è¯„åˆ†ä½äº3.0ï¼Œéœ€è¦å…³æ³¨</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              {insights.eventQuality.lowRatedEvents.map((event, idx) => (\n                <div\n                  key={event.event_id}\n                  className=\"flex items-center justify-between p-3 bg-white rounded-md\"\n                  data-testid={`low-rated-event-${idx}`}\n                >\n                  <div>\n                    <div className=\"font-medium\">{event.title}</div>\n                    <div className=\"text-xs text-muted-foreground\">\n                      {new Date(event.date).toLocaleDateString(\"zh-CN\")}\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <StarRating rating={event.avg_rating} />\n                  </div>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","size_bytes":24573},"client/src/pages/admin/AdminContentPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, Edit, Trash2, FileText, Send, Eye, Bell } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { zhCN } from \"date-fns/locale\";\n\ntype ContentType = \"announcement\" | \"help_article\" | \"faq\" | \"community_guideline\";\n\ninterface Content {\n  id: string;\n  type: ContentType;\n  title: string;\n  content: string;\n  category?: string;\n  status: \"draft\" | \"published\" | \"archived\";\n  priority: number;\n  publishedAt?: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\nconst CONTENT_TYPES = {\n  announcement: { label: \"å¹³å°å…¬å‘Š\", icon: \"ğŸ“¢\", color: \"bg-blue-500\" },\n  help_article: { label: \"å¸®åŠ©æ–‡ç« \", icon: \"ğŸ“–\", color: \"bg-green-500\" },\n  faq: { label: \"å¸¸è§é—®é¢˜\", icon: \"â“\", color: \"bg-yellow-500\" },\n  community_guideline: { label: \"ç¤¾åŒºè§„èŒƒ\", icon: \"ğŸ›¡ï¸\", color: \"bg-purple-500\" },\n};\n\nexport default function AdminContentPage() {\n  const [activeTab, setActiveTab] = useState<ContentType>(\"announcement\");\n  const [editingContent, setEditingContent] = useState<Content | null>(null);\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [isPublishDialogOpen, setIsPublishDialogOpen] = useState(false);\n  const [publishingContent, setPublishingContent] = useState<Content | null>(null);\n  const [sendNotification, setSendNotification] = useState(false);\n  const { toast } = useToast();\n\n  // Form state\n  const [formData, setFormData] = useState({\n    title: \"\",\n    content: \"\",\n    category: \"\",\n    priority: 0,\n    status: \"draft\" as \"draft\" | \"published\",\n  });\n\n  const { data: contents = [], isLoading } = useQuery<Content[]>({\n    queryKey: [\"/api/admin/contents\", activeTab],\n    queryFn: async () => {\n      const res = await fetch(`/api/admin/contents?type=${activeTab}`);\n      if (!res.ok) throw new Error(\"Failed to fetch contents\");\n      return res.json();\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return apiRequest(\"POST\", \"/api/admin/contents\", { ...data, type: activeTab });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/contents\"] });\n      toast({ title: \"åˆ›å»ºæˆåŠŸ\", description: \"å†…å®¹å·²åˆ›å»º\" });\n      handleCloseDialog();\n    },\n    onError: () => {\n      toast({ title: \"åˆ›å»ºå¤±è´¥\", description: \"è¯·ç¨åé‡è¯•\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: any }) => {\n      return apiRequest(\"PATCH\", `/api/admin/contents/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/contents\"] });\n      toast({ title: \"æ›´æ–°æˆåŠŸ\", description: \"å†…å®¹å·²æ›´æ–°\" });\n      handleCloseDialog();\n    },\n    onError: () => {\n      toast({ title: \"æ›´æ–°å¤±è´¥\", description: \"è¯·ç¨åé‡è¯•\", variant: \"destructive\" });\n    },\n  });\n\n  const publishMutation = useMutation({\n    mutationFn: async ({ id, sendNotification }: { id: string; sendNotification: boolean }) => {\n      return apiRequest(\"POST\", `/api/admin/contents/${id}/publish`, { sendNotification });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/contents\"] });\n      setIsPublishDialogOpen(false);\n      setSendNotification(false);\n      setPublishingContent(null);\n      toast({ title: \"å‘å¸ƒæˆåŠŸ\", description: \"å†…å®¹å·²å‘å¸ƒ\" });\n    },\n    onError: () => {\n      toast({ title: \"å‘å¸ƒå¤±è´¥\", description: \"è¯·ç¨åé‡è¯•\", variant: \"destructive\" });\n    },\n  });\n\n  const handleOpenPublishDialog = (content: Content) => {\n    setPublishingContent(content);\n    setSendNotification(content.type === \"announcement\");\n    setIsPublishDialogOpen(true);\n  };\n\n  const handleConfirmPublish = () => {\n    if (publishingContent) {\n      publishMutation.mutate({ id: publishingContent.id, sendNotification });\n    }\n  };\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/admin/contents/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/contents\"] });\n      toast({ title: \"åˆ é™¤æˆåŠŸ\", description: \"å†…å®¹å·²åˆ é™¤\" });\n    },\n    onError: () => {\n      toast({ title: \"åˆ é™¤å¤±è´¥\", description: \"è¯·ç¨åé‡è¯•\", variant: \"destructive\" });\n    },\n  });\n\n  const handleOpenDialog = (content?: Content) => {\n    if (content) {\n      setEditingContent(content);\n      setFormData({\n        title: content.title,\n        content: content.content,\n        category: content.category || \"\",\n        priority: content.priority,\n        status: content.status as \"draft\" | \"published\",\n      });\n    } else {\n      setEditingContent(null);\n      setFormData({ title: \"\", content: \"\", category: \"\", priority: 0, status: \"draft\" });\n    }\n    setIsDialogOpen(true);\n  };\n\n  const handleCloseDialog = () => {\n    setIsDialogOpen(false);\n    setEditingContent(null);\n    setFormData({ title: \"\", content: \"\", category: \"\", priority: 0, status: \"draft\" });\n  };\n\n  const handleSubmit = () => {\n    if (!formData.title || !formData.content) {\n      toast({ title: \"è¯·å¡«å†™å¿…å¡«é¡¹\", description: \"æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º\", variant: \"destructive\" });\n      return;\n    }\n\n    if (editingContent) {\n      updateMutation.mutate({ id: editingContent.id, data: formData });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  return (\n    <div className=\"p-8 space-y-6\" data-testid=\"page-content-management\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">å†…å®¹ç®¡ç†</h1>\n          <p className=\"text-muted-foreground mt-1\">ç®¡ç†å¹³å°å…¬å‘Šã€å¸®åŠ©æ–‡æ¡£å’Œç¤¾åŒºè§„èŒƒ</p>\n        </div>\n        <Button onClick={() => handleOpenDialog()} data-testid=\"button-create-content\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          åˆ›å»ºå†…å®¹\n        </Button>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as ContentType)} data-testid=\"tabs-content-types\">\n        <TabsList className=\"grid w-full grid-cols-4\">\n          {Object.entries(CONTENT_TYPES).map(([key, { label, icon }]) => (\n            <TabsTrigger key={key} value={key} data-testid={`tab-${key}`}>\n              <span className=\"mr-2\">{icon}</span>\n              {label}\n            </TabsTrigger>\n          ))}\n        </TabsList>\n\n        {Object.keys(CONTENT_TYPES).map((type) => (\n          <TabsContent key={type} value={type} className=\"space-y-4\">\n            {isLoading ? (\n              <Card>\n                <CardContent className=\"py-8\">\n                  <p className=\"text-center text-muted-foreground\">åŠ è½½ä¸­...</p>\n                </CardContent>\n              </Card>\n            ) : contents.length === 0 ? (\n              <Card>\n                <CardContent className=\"py-8\">\n                  <p className=\"text-center text-muted-foreground\">æš‚æ— å†…å®¹</p>\n                </CardContent>\n              </Card>\n            ) : (\n              <div className=\"grid gap-4\">\n                {contents.map((content) => (\n                  <Card key={content.id} data-testid={`content-card-${content.id}`}>\n                    <CardHeader>\n                      <div className=\"flex items-start justify-between\">\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-2\">\n                            <CardTitle data-testid={`text-title-${content.id}`}>{content.title}</CardTitle>\n                            <Badge\n                              variant={content.status === \"published\" ? \"default\" : \"secondary\"}\n                              data-testid={`badge-status-${content.id}`}\n                            >\n                              {content.status === \"published\" ? \"å·²å‘å¸ƒ\" : \"è‰ç¨¿\"}\n                            </Badge>\n                            {content.category && (\n                              <Badge variant=\"outline\" data-testid={`badge-category-${content.id}`}>\n                                {content.category}\n                              </Badge>\n                            )}\n                          </div>\n                          <CardDescription className=\"mt-2\">\n                            ä¼˜å…ˆçº§: {content.priority} | \n                            {content.publishedAt \n                              ? ` å‘å¸ƒäº ${format(new Date(content.publishedAt), \"PPP\", { locale: zhCN })}`\n                              : ` åˆ›å»ºäº ${format(new Date(content.createdAt), \"PPP\", { locale: zhCN })}`\n                            }\n                          </CardDescription>\n                        </div>\n                        <div className=\"flex gap-2\">\n                          {content.status === \"draft\" && (\n                            <Button\n                              size=\"sm\"\n                              variant=\"default\"\n                              onClick={() => handleOpenPublishDialog(content)}\n                              data-testid={`button-publish-${content.id}`}\n                            >\n                              <Send className=\"h-4 w-4 mr-1\" />\n                              å‘å¸ƒ\n                            </Button>\n                          )}\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => handleOpenDialog(content)}\n                            data-testid={`button-edit-${content.id}`}\n                          >\n                            <Edit className=\"h-4 w-4\" />\n                          </Button>\n                          <Button\n                            size=\"sm\"\n                            variant=\"destructive\"\n                            onClick={() => {\n                              if (confirm(\"ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå†…å®¹å—ï¼Ÿ\")) {\n                                deleteMutation.mutate(content.id);\n                              }\n                            }}\n                            data-testid={`button-delete-${content.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                      </div>\n                    </CardHeader>\n                    <CardContent>\n                      <p className=\"text-sm text-muted-foreground line-clamp-3\" data-testid={`text-preview-${content.id}`}>\n                        {content.content}\n                      </p>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            )}\n          </TabsContent>\n        ))}\n      </Tabs>\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent className=\"max-w-2xl\" data-testid=\"dialog-content-form\">\n          <DialogHeader>\n            <DialogTitle data-testid=\"text-dialog-title\">\n              {editingContent ? \"ç¼–è¾‘å†…å®¹\" : \"åˆ›å»ºæ–°å†…å®¹\"}\n            </DialogTitle>\n            <DialogDescription>\n              ç±»å‹: {CONTENT_TYPES[activeTab].label}\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"title\">æ ‡é¢˜ *</Label>\n              <Input\n                id=\"title\"\n                value={formData.title}\n                onChange={(e) => setFormData({ ...formData, title: e.target.value })}\n                placeholder=\"è¾“å…¥æ ‡é¢˜\"\n                data-testid=\"input-title\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"category\">åˆ†ç±»</Label>\n              <Input\n                id=\"category\"\n                value={formData.category}\n                onChange={(e) => setFormData({ ...formData, category: e.target.value })}\n                placeholder=\"ä¾‹å¦‚ï¼šå®‰å…¨ã€æ”¯ä»˜ã€æ´»åŠ¨\"\n                data-testid=\"input-category\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"content\">å†…å®¹ *</Label>\n              <Textarea\n                id=\"content\"\n                value={formData.content}\n                onChange={(e) => setFormData({ ...formData, content: e.target.value })}\n                placeholder=\"è¾“å…¥å†…å®¹ï¼ˆæ”¯æŒæ¢è¡Œï¼‰\"\n                rows={10}\n                data-testid=\"textarea-content\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label htmlFor=\"priority\">ä¼˜å…ˆçº§</Label>\n                <Input\n                  id=\"priority\"\n                  type=\"number\"\n                  value={formData.priority}\n                  onChange={(e) => setFormData({ ...formData, priority: parseInt(e.target.value) || 0 })}\n                  data-testid=\"input-priority\"\n                />\n                <p className=\"text-xs text-muted-foreground mt-1\">æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜</p>\n              </div>\n\n              <div>\n                <Label htmlFor=\"status\">çŠ¶æ€</Label>\n                <Select\n                  value={formData.status}\n                  onValueChange={(v) => setFormData({ ...formData, status: v as \"draft\" | \"published\" })}\n                >\n                  <SelectTrigger data-testid=\"select-status\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"draft\">è‰ç¨¿</SelectItem>\n                    <SelectItem value=\"published\">å‘å¸ƒ</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={handleCloseDialog} data-testid=\"button-cancel\">\n              å–æ¶ˆ\n            </Button>\n            <Button\n              onClick={handleSubmit}\n              disabled={createMutation.isPending || updateMutation.isPending}\n              data-testid=\"button-submit\"\n            >\n              {editingContent ? \"æ›´æ–°\" : \"åˆ›å»º\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Publish Confirmation Dialog */}\n      <Dialog open={isPublishDialogOpen} onOpenChange={setIsPublishDialogOpen}>\n        <DialogContent data-testid=\"dialog-publish-confirmation\">\n          <DialogHeader>\n            <DialogTitle>ç¡®è®¤å‘å¸ƒå†…å®¹</DialogTitle>\n            <DialogDescription>\n              ç¡®å®šè¦å‘å¸ƒè¿™æ¡{publishingContent && CONTENT_TYPES[publishingContent.type].label}å—ï¼Ÿ\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"py-4\">\n            <div className=\"space-y-4\">\n              <div className=\"rounded-md bg-muted p-4\">\n                <h4 className=\"font-semibold mb-2\">{publishingContent?.title}</h4>\n                <p className=\"text-sm text-muted-foreground line-clamp-3\">\n                  {publishingContent?.content}\n                </p>\n              </div>\n\n              {publishingContent?.type === \"announcement\" && (\n                <div className=\"flex items-start space-x-3 rounded-md border p-4\">\n                  <Checkbox\n                    id=\"send-notification\"\n                    checked={sendNotification}\n                    onCheckedChange={(checked) => setSendNotification(checked as boolean)}\n                    data-testid=\"checkbox-send-notification\"\n                  />\n                  <div className=\"space-y-1 leading-none\">\n                    <label\n                      htmlFor=\"send-notification\"\n                      className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer flex items-center gap-2\"\n                    >\n                      <Bell className=\"h-4 w-4\" />\n                      æ¨é€é€šçŸ¥ç»™æ‰€æœ‰ç”¨æˆ·\n                    </label>\n                    <p className=\"text-xs text-muted-foreground\">\n                      å‹¾é€‰åå°†å‘æ‰€æœ‰ç”¨æˆ·æ¨é€æ­¤å…¬å‘Šé€šçŸ¥\n                    </p>\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setIsPublishDialogOpen(false)}\n              data-testid=\"button-cancel-publish\"\n            >\n              å–æ¶ˆ\n            </Button>\n            <Button\n              onClick={handleConfirmPublish}\n              disabled={publishMutation.isPending}\n              data-testid=\"button-confirm-publish\"\n            >\n              {publishMutation.isPending ? \"å‘å¸ƒä¸­...\" : \"ç¡®è®¤å‘å¸ƒ\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":17724},"client/src/pages/admin/AdminModerationPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { \n  AlertTriangle, \n  CheckCircle2, \n  XCircle, \n  Shield, \n  UserX, \n  AlertOctagon,\n  FileText,\n  Ban,\n  Eye\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { zhCN } from \"date-fns/locale\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface ModerationStats {\n  totalReports: number;\n  pendingReports: number;\n  resolvedReports: number;\n  bannedUsers: number;\n}\n\ninterface Report {\n  id: string;\n  reporter_id: string;\n  reported_user_id: string;\n  report_type: \"harassment\" | \"inappropriate_content\" | \"spam\" | \"other\";\n  description: string;\n  evidence: string | null;\n  status: \"pending\" | \"resolved\" | \"dismissed\";\n  admin_notes: string | null;\n  created_at: string;\n  reporter_first_name: string | null;\n  reporter_last_name: string | null;\n  reporter_email: string | null;\n  reported_first_name: string | null;\n  reported_last_name: string | null;\n  reported_email: string | null;\n}\n\ninterface ModerationLog {\n  id: string;\n  admin_id: string;\n  action: \"ban\" | \"warn\" | \"unban\";\n  target_user_id: string;\n  reason: string | null;\n  notes: string | null;\n  created_at: string;\n  admin_first_name: string | null;\n  admin_last_name: string | null;\n  target_first_name: string | null;\n  target_last_name: string | null;\n  target_email: string | null;\n}\n\nconst REPORT_TYPE_MAP: Record<string, { label: string; variant: \"default\" | \"destructive\" | \"secondary\" | \"outline\" }> = {\n  harassment: { label: \"éªšæ‰°\", variant: \"destructive\" },\n  inappropriate_content: { label: \"ä¸å½“å†…å®¹\", variant: \"secondary\" },\n  spam: { label: \"åƒåœ¾ä¿¡æ¯\", variant: \"outline\" },\n  other: { label: \"å…¶ä»–\", variant: \"default\" },\n};\n\nconst STATUS_MAP: Record<string, { label: string; variant: \"default\" | \"secondary\" | \"destructive\"; icon: any }> = {\n  pending: { label: \"å¾…å¤„ç†\", variant: \"secondary\", icon: AlertTriangle },\n  resolved: { label: \"å·²è§£å†³\", variant: \"default\", icon: CheckCircle2 },\n  dismissed: { label: \"å·²é©³å›\", variant: \"destructive\", icon: XCircle },\n};\n\nconst ACTION_MAP: Record<string, { label: string; variant: \"default\" | \"destructive\" | \"secondary\"; icon: any }> = {\n  ban: { label: \"å°ç¦\", variant: \"destructive\", icon: Ban },\n  warn: { label: \"è­¦å‘Š\", variant: \"secondary\", icon: AlertOctagon },\n  unban: { label: \"è§£å°\", variant: \"default\", icon: CheckCircle2 },\n};\n\nexport default function AdminModerationPage() {\n  const [mainTab, setMainTab] = useState<\"reports\" | \"logs\">(\"reports\");\n  const [reportFilter, setReportFilter] = useState<\"all\" | \"pending\">(\"all\");\n  const [selectedReport, setSelectedReport] = useState<Report | null>(null);\n  const [editStatus, setEditStatus] = useState<string>(\"\");\n  const [adminNotes, setAdminNotes] = useState<string>(\"\");\n  const { toast } = useToast();\n\n  const { data: stats, isLoading: statsLoading } = useQuery<ModerationStats>({\n    queryKey: [\"/api/admin/moderation/stats\"],\n  });\n\n  const { data: reports = [], isLoading: reportsLoading } = useQuery<Report[]>({\n    queryKey: [\"/api/admin/moderation/reports\", reportFilter === \"all\" ? undefined : reportFilter],\n  });\n\n  const { data: logs = [], isLoading: logsLoading } = useQuery<ModerationLog[]>({\n    queryKey: [\"/api/admin/moderation/logs\"],\n  });\n\n  const updateReportMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: { status?: string; admin_notes?: string } }) =>\n      fetch(`/api/admin/moderation/reports/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      }).then(r => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/moderation/reports\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/moderation/stats\"] });\n      toast({\n        title: \"æ›´æ–°æˆåŠŸ\",\n        description: \"ä¸¾æŠ¥è®°å½•å·²æ›´æ–°\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"æ›´æ–°å¤±è´¥\",\n        description: \"è¯·ç¨åé‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createLogMutation = useMutation({\n    mutationFn: (data: { action: string; target_user_id: string; reason?: string; notes?: string }) =>\n      fetch(\"/api/admin/moderation/logs\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      }).then(r => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/moderation/logs\"] });\n    },\n  });\n\n  const banUserMutation = useMutation({\n    mutationFn: (userId: string) =>\n      fetch(`/api/admin/users/${userId}/ban`, {\n        method: \"PATCH\",\n        credentials: \"include\",\n      }).then(r => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/users\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/moderation/stats\"] });\n      toast({\n        title: \"å°ç¦æˆåŠŸ\",\n        description: \"ç”¨æˆ·å·²è¢«å°ç¦\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"å°ç¦å¤±è´¥\",\n        description: \"è¯·ç¨åé‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleOpenReport = (report: Report) => {\n    setSelectedReport(report);\n    setEditStatus(report.status);\n    setAdminNotes(report.admin_notes || \"\");\n  };\n\n  const handleCloseDialog = () => {\n    setSelectedReport(null);\n    setEditStatus(\"\");\n    setAdminNotes(\"\");\n  };\n\n  const handleSaveChanges = async () => {\n    if (!selectedReport) return;\n\n    await updateReportMutation.mutateAsync({\n      id: selectedReport.id,\n      data: {\n        status: editStatus,\n        admin_notes: adminNotes,\n      },\n    });\n\n    handleCloseDialog();\n  };\n\n  const handleBanUser = async () => {\n    if (!selectedReport) return;\n\n    await banUserMutation.mutateAsync(selectedReport.reported_user_id);\n    await createLogMutation.mutateAsync({\n      action: \"ban\",\n      target_user_id: selectedReport.reported_user_id,\n      reason: `ä¸¾æŠ¥: ${REPORT_TYPE_MAP[selectedReport.report_type]?.label}`,\n      notes: selectedReport.description,\n    });\n\n    handleCloseDialog();\n  };\n\n  const handleWarnUser = async () => {\n    if (!selectedReport) return;\n\n    await createLogMutation.mutateAsync({\n      action: \"warn\",\n      target_user_id: selectedReport.reported_user_id,\n      reason: `ä¸¾æŠ¥: ${REPORT_TYPE_MAP[selectedReport.report_type]?.label}`,\n      notes: selectedReport.description,\n    });\n\n    toast({\n      title: \"è­¦å‘Šå·²è®°å½•\",\n      description: \"å·²å¯¹ç”¨æˆ·å‘å‡ºè­¦å‘Š\",\n    });\n  };\n\n  const handleDismiss = async () => {\n    if (!selectedReport) return;\n\n    await updateReportMutation.mutateAsync({\n      id: selectedReport.id,\n      data: {\n        status: \"dismissed\",\n        admin_notes: adminNotes,\n      },\n    });\n\n    handleCloseDialog();\n  };\n\n  const formatDateTime = (dateTimeStr: string) => {\n    try {\n      const date = new Date(dateTimeStr);\n      return format(date, \"yyyyå¹´MMæœˆddæ—¥ HH:mm\", { locale: zhCN });\n    } catch (e) {\n      return dateTimeStr;\n    }\n  };\n\n  const getUserName = (firstName: string | null, lastName: string | null) => {\n    const first = firstName || \"\";\n    const last = lastName || \"\";\n    const fullName = `${first} ${last}`.trim();\n    return fullName || \"æœªçŸ¥ç”¨æˆ·\";\n  };\n\n  if (statsLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"space-y-6\">\n          <div className=\"grid gap-4 md:grid-cols-4\">\n            {[1, 2, 3, 4].map(i => (\n              <Card key={i} data-testid={`skeleton-metric-${i}`}>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">åŠ è½½ä¸­...</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">--</div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Metric Cards */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card data-testid=\"card-metric-total-reports\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ€»ä¸¾æŠ¥æ•°</CardTitle>\n            <Shield className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-reports\">\n              {stats?.totalReports || 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">æ‰€æœ‰ä¸¾æŠ¥è®°å½•</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-metric-pending-reports\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">å¾…å¤„ç†</CardTitle>\n            <AlertTriangle className=\"h-4 w-4 text-amber-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-amber-600\" data-testid=\"text-pending-reports\">\n              {stats?.pendingReports || 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">éœ€è¦å®¡æ ¸å¤„ç†</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-metric-resolved-reports\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">å·²è§£å†³</CardTitle>\n            <CheckCircle2 className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-resolved-reports\">\n              {stats?.resolvedReports || 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">å·²å¤„ç†å®Œæˆ</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-metric-banned-users\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">å°ç¦ç”¨æˆ·æ•°</CardTitle>\n            <UserX className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-banned-users\">\n              {stats?.bannedUsers || 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">è¢«å°ç¦çš„ç”¨æˆ·</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Main Tabs */}\n      <Card data-testid=\"card-moderation-content\">\n        <Tabs value={mainTab} onValueChange={(v) => setMainTab(v as any)}>\n          <CardHeader>\n            <TabsList data-testid=\"tabs-main\">\n              <TabsTrigger value=\"reports\" data-testid=\"tab-reports\">\n                ä¸¾æŠ¥è®°å½•\n              </TabsTrigger>\n              <TabsTrigger value=\"logs\" data-testid=\"tab-logs\">\n                æ“ä½œæ—¥å¿—\n              </TabsTrigger>\n            </TabsList>\n          </CardHeader>\n\n          <CardContent>\n            {/* Reports Tab */}\n            <TabsContent value=\"reports\" className=\"space-y-4\">\n              <Tabs value={reportFilter} onValueChange={(v) => setReportFilter(v as any)}>\n                <TabsList data-testid=\"tabs-report-filter\">\n                  <TabsTrigger value=\"all\" data-testid=\"filter-all\">\n                    å…¨éƒ¨\n                  </TabsTrigger>\n                  <TabsTrigger value=\"pending\" data-testid=\"filter-pending\">\n                    å¾…å¤„ç†\n                  </TabsTrigger>\n                </TabsList>\n              </Tabs>\n\n              {reportsLoading ? (\n                <div className=\"py-12 text-center text-muted-foreground\" data-testid=\"text-loading-reports\">\n                  åŠ è½½ä¸­...\n                </div>\n              ) : reports.length === 0 ? (\n                <div className=\"py-12 text-center text-muted-foreground\" data-testid=\"text-no-reports\">\n                  æš‚æ— ä¸¾æŠ¥è®°å½•\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {reports.map((report) => {\n                    const StatusIcon = STATUS_MAP[report.status]?.icon || AlertTriangle;\n                    return (\n                      <Card \n                        key={report.id} \n                        className=\"hover-elevate cursor-pointer\"\n                        onClick={() => handleOpenReport(report)}\n                        data-testid={`card-report-${report.id}`}\n                      >\n                        <CardHeader className=\"flex flex-row items-start justify-between gap-2 space-y-0 pb-3\">\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center gap-2 mb-2\">\n                              <CardTitle className=\"text-sm font-mono\" data-testid={`text-report-id-${report.id}`}>\n                                {report.id.slice(0, 8)}...\n                              </CardTitle>\n                              <Badge \n                                variant={REPORT_TYPE_MAP[report.report_type]?.variant || \"default\"}\n                                data-testid={`badge-report-type-${report.id}`}\n                              >\n                                {REPORT_TYPE_MAP[report.report_type]?.label || report.report_type}\n                              </Badge>\n                            </div>\n                          </div>\n                          <Badge \n                            variant={STATUS_MAP[report.status]?.variant || \"secondary\"}\n                            data-testid={`badge-status-${report.id}`}\n                          >\n                            <StatusIcon className=\"h-3 w-3 mr-1\" />\n                            {STATUS_MAP[report.status]?.label || report.status}\n                          </Badge>\n                        </CardHeader>\n                        <CardContent className=\"space-y-3\">\n                          <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                            <div>\n                              <p className=\"text-muted-foreground mb-1\">ä¸¾æŠ¥äºº</p>\n                              <p className=\"font-medium\" data-testid={`text-reporter-name-${report.id}`}>\n                                {getUserName(report.reporter_first_name, report.reporter_last_name)}\n                              </p>\n                              {report.reporter_email && (\n                                <p className=\"text-xs text-muted-foreground\" data-testid={`text-reporter-email-${report.id}`}>\n                                  {report.reporter_email}\n                                </p>\n                              )}\n                            </div>\n                            <div>\n                              <p className=\"text-muted-foreground mb-1\">è¢«ä¸¾æŠ¥äºº</p>\n                              <p className=\"font-medium\" data-testid={`text-reported-name-${report.id}`}>\n                                {getUserName(report.reported_first_name, report.reported_last_name)}\n                              </p>\n                              {report.reported_email && (\n                                <p className=\"text-xs text-muted-foreground\" data-testid={`text-reported-email-${report.id}`}>\n                                  {report.reported_email}\n                                </p>\n                              )}\n                            </div>\n                          </div>\n                          \n                          <div>\n                            <p className=\"text-muted-foreground text-sm mb-1\">ä¸¾æŠ¥æè¿°</p>\n                            <p className=\"text-sm\" data-testid={`text-description-${report.id}`}>\n                              {report.description}\n                            </p>\n                          </div>\n\n                          <div className=\"flex items-center justify-between pt-2 border-t\">\n                            <span className=\"text-xs text-muted-foreground\" data-testid={`text-created-at-${report.id}`}>\n                              {formatDateTime(report.created_at)}\n                            </span>\n                            <Button \n                              size=\"sm\" \n                              variant=\"outline\"\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                handleOpenReport(report);\n                              }}\n                              data-testid={`button-review-${report.id}`}\n                            >\n                              <Eye className=\"h-3 w-3 mr-1\" />\n                              å®¡æ ¸\n                            </Button>\n                          </div>\n                        </CardContent>\n                      </Card>\n                    );\n                  })}\n                </div>\n              )}\n            </TabsContent>\n\n            {/* Moderation Logs Tab */}\n            <TabsContent value=\"logs\" className=\"space-y-4\">\n              {logsLoading ? (\n                <div className=\"py-12 text-center text-muted-foreground\" data-testid=\"text-loading-logs\">\n                  åŠ è½½ä¸­...\n                </div>\n              ) : logs.length === 0 ? (\n                <div className=\"py-12 text-center text-muted-foreground\" data-testid=\"text-no-logs\">\n                  æš‚æ— æ“ä½œæ—¥å¿—\n                </div>\n              ) : (\n                <div className=\"rounded-md border\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead data-testid=\"header-action\">æ“ä½œç±»å‹</TableHead>\n                        <TableHead data-testid=\"header-admin\">ç®¡ç†å‘˜</TableHead>\n                        <TableHead data-testid=\"header-target-user\">ç›®æ ‡ç”¨æˆ·</TableHead>\n                        <TableHead data-testid=\"header-reason\">åŸå› </TableHead>\n                        <TableHead data-testid=\"header-notes\">å¤‡æ³¨</TableHead>\n                        <TableHead data-testid=\"header-timestamp\">æ—¶é—´</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {logs.map((log) => {\n                        const ActionIcon = ACTION_MAP[log.action]?.icon || FileText;\n                        return (\n                          <TableRow key={log.id} data-testid={`row-log-${log.id}`}>\n                            <TableCell>\n                              <Badge \n                                variant={ACTION_MAP[log.action]?.variant || \"default\"}\n                                data-testid={`badge-action-${log.id}`}\n                              >\n                                <ActionIcon className=\"h-3 w-3 mr-1\" />\n                                {ACTION_MAP[log.action]?.label || log.action}\n                              </Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"font-medium\" data-testid={`text-admin-name-${log.id}`}>\n                                {getUserName(log.admin_first_name, log.admin_last_name)}\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"space-y-1\">\n                                <div className=\"font-medium\" data-testid={`text-target-name-${log.id}`}>\n                                  {getUserName(log.target_first_name, log.target_last_name)}\n                                </div>\n                                {log.target_email && (\n                                  <div className=\"text-xs text-muted-foreground\" data-testid={`text-target-email-${log.id}`}>\n                                    {log.target_email}\n                                  </div>\n                                )}\n                              </div>\n                            </TableCell>\n                            <TableCell>\n                              <span className=\"text-sm\" data-testid={`text-reason-${log.id}`}>\n                                {log.reason || \"-\"}\n                              </span>\n                            </TableCell>\n                            <TableCell>\n                              <span className=\"text-sm text-muted-foreground\" data-testid={`text-notes-${log.id}`}>\n                                {log.notes || \"-\"}\n                              </span>\n                            </TableCell>\n                            <TableCell className=\"text-sm\" data-testid={`text-timestamp-${log.id}`}>\n                              {formatDateTime(log.created_at)}\n                            </TableCell>\n                          </TableRow>\n                        );\n                      })}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </TabsContent>\n          </CardContent>\n        </Tabs>\n      </Card>\n\n      {/* Review Report Dialog */}\n      <Dialog open={!!selectedReport} onOpenChange={(open) => !open && handleCloseDialog()}>\n        <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-review-report\">\n          <DialogHeader>\n            <DialogTitle>å®¡æ ¸ä¸¾æŠ¥</DialogTitle>\n            <DialogDescription>æŸ¥çœ‹ä¸¾æŠ¥è¯¦æƒ…å¹¶é‡‡å–ç›¸åº”æªæ–½</DialogDescription>\n          </DialogHeader>\n\n          {selectedReport && (\n            <div className=\"space-y-6\">\n              {/* Report Details */}\n              <div className=\"space-y-4\">\n                <div className=\"flex items-center gap-2\">\n                  <h3 className=\"font-semibold\">ä¸¾æŠ¥ä¿¡æ¯</h3>\n                  <Badge \n                    variant={REPORT_TYPE_MAP[selectedReport.report_type]?.variant || \"default\"}\n                    data-testid=\"dialog-report-type\"\n                  >\n                    {REPORT_TYPE_MAP[selectedReport.report_type]?.label || selectedReport.report_type}\n                  </Badge>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                  <div>\n                    <p className=\"text-muted-foreground mb-1\">ä¸¾æŠ¥äºº</p>\n                    <p className=\"font-medium\" data-testid=\"dialog-reporter-name\">\n                      {getUserName(selectedReport.reporter_first_name, selectedReport.reporter_last_name)}\n                    </p>\n                    {selectedReport.reporter_email && (\n                      <p className=\"text-xs text-muted-foreground\" data-testid=\"dialog-reporter-email\">\n                        {selectedReport.reporter_email}\n                      </p>\n                    )}\n                  </div>\n                  <div>\n                    <p className=\"text-muted-foreground mb-1\">è¢«ä¸¾æŠ¥äºº</p>\n                    <p className=\"font-medium\" data-testid=\"dialog-reported-name\">\n                      {getUserName(selectedReport.reported_first_name, selectedReport.reported_last_name)}\n                    </p>\n                    {selectedReport.reported_email && (\n                      <p className=\"text-xs text-muted-foreground\" data-testid=\"dialog-reported-email\">\n                        {selectedReport.reported_email}\n                      </p>\n                    )}\n                  </div>\n                </div>\n\n                <div>\n                  <p className=\"text-muted-foreground text-sm mb-1\">ä¸¾æŠ¥æè¿°</p>\n                  <p className=\"text-sm\" data-testid=\"dialog-description\">\n                    {selectedReport.description}\n                  </p>\n                </div>\n\n                {selectedReport.evidence && (\n                  <div>\n                    <p className=\"text-muted-foreground text-sm mb-1\">è¯æ®</p>\n                    <p className=\"text-sm\" data-testid=\"dialog-evidence\">\n                      {selectedReport.evidence}\n                    </p>\n                  </div>\n                )}\n\n                <div>\n                  <p className=\"text-muted-foreground text-sm mb-1\">åˆ›å»ºæ—¶é—´</p>\n                  <p className=\"text-sm\" data-testid=\"dialog-created-at\">\n                    {formatDateTime(selectedReport.created_at)}\n                  </p>\n                </div>\n              </div>\n\n              {/* Admin Actions */}\n              <div className=\"space-y-4 border-t pt-4\">\n                <h3 className=\"font-semibold\">ç®¡ç†æ“ä½œ</h3>\n\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm font-medium\">çŠ¶æ€</label>\n                  <Select value={editStatus} onValueChange={setEditStatus}>\n                    <SelectTrigger data-testid=\"select-status\">\n                      <SelectValue placeholder=\"é€‰æ‹©çŠ¶æ€\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"pending\" data-testid=\"option-pending\">å¾…å¤„ç†</SelectItem>\n                      <SelectItem value=\"resolved\" data-testid=\"option-resolved\">å·²è§£å†³</SelectItem>\n                      <SelectItem value=\"dismissed\" data-testid=\"option-dismissed\">å·²é©³å›</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm font-medium\">ç®¡ç†å‘˜å¤‡æ³¨</label>\n                  <Textarea\n                    value={adminNotes}\n                    onChange={(e) => setAdminNotes(e.target.value)}\n                    placeholder=\"æ·»åŠ å¤„ç†å¤‡æ³¨...\"\n                    rows={4}\n                    data-testid=\"textarea-admin-notes\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm font-medium\">å¿«é€Ÿæ“ä½œ</label>\n                  <div className=\"flex gap-2\">\n                    <Button\n                      variant=\"destructive\"\n                      size=\"sm\"\n                      onClick={handleBanUser}\n                      disabled={banUserMutation.isPending}\n                      data-testid=\"button-ban-user\"\n                    >\n                      <Ban className=\"h-4 w-4 mr-2\" />\n                      å°ç¦ç”¨æˆ·\n                    </Button>\n                    <Button\n                      variant=\"secondary\"\n                      size=\"sm\"\n                      onClick={handleWarnUser}\n                      disabled={createLogMutation.isPending}\n                      data-testid=\"button-warn-user\"\n                    >\n                      <AlertOctagon className=\"h-4 w-4 mr-2\" />\n                      è­¦å‘Šç”¨æˆ·\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={handleDismiss}\n                      disabled={updateReportMutation.isPending}\n                      data-testid=\"button-dismiss\"\n                    >\n                      <XCircle className=\"h-4 w-4 mr-2\" />\n                      é©³å›ä¸¾æŠ¥\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n\n          <DialogFooter className=\"gap-2\">\n            <Button \n              variant=\"outline\" \n              onClick={handleCloseDialog}\n              data-testid=\"button-close-dialog\"\n            >\n              å–æ¶ˆ\n            </Button>\n            <Button \n              onClick={handleSaveChanges}\n              disabled={updateReportMutation.isPending}\n              data-testid=\"button-save-changes\"\n            >\n              ä¿å­˜ä¿®æ”¹\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":28754},"client/src/pages/admin/AdminFinancePage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { DollarSign, CreditCard, TrendingUp, Receipt, Store } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { zhCN } from \"date-fns/locale\";\n\ninterface FinanceStats {\n  totalRevenue: number;\n  subscriptionRevenue: number;\n  eventRevenue: number;\n  totalPayments: number;\n}\n\ninterface Payment {\n  id: string;\n  user_id: string;\n  amount: number;\n  payment_type: \"subscription\" | \"event\";\n  status: \"completed\" | \"pending\" | \"failed\";\n  payment_method: string;\n  created_at: string;\n  user_first_name: string | null;\n  user_last_name: string | null;\n  user_email: string | null;\n}\n\ninterface VenueCommission {\n  id: string;\n  venue_name: string;\n  commission_rate: number;\n  booking_count: number;\n  total_revenue: number;\n  total_commission: number;\n}\n\nconst STATUS_MAP: Record<string, { label: string; variant: \"default\" | \"secondary\" | \"destructive\" }> = {\n  completed: { label: \"å·²å®Œæˆ\", variant: \"default\" },\n  pending: { label: \"å¾…å¤„ç†\", variant: \"secondary\" },\n  failed: { label: \"å¤±è´¥\", variant: \"destructive\" },\n};\n\nconst PAYMENT_TYPE_MAP: Record<string, { label: string; variant: \"default\" | \"outline\" }> = {\n  subscription: { label: \"ä¼šå‘˜\", variant: \"default\" },\n  event: { label: \"æ´»åŠ¨\", variant: \"outline\" },\n};\n\nexport default function AdminFinancePage() {\n  const [mainTab, setMainTab] = useState<\"payments\" | \"commissions\">(\"payments\");\n  const [paymentFilter, setPaymentFilter] = useState<\"all\" | \"subscription\" | \"event\">(\"all\");\n\n  const { data: stats, isLoading: statsLoading } = useQuery<FinanceStats>({\n    queryKey: [\"/api/admin/finance/stats\"],\n  });\n\n  const { data: payments = [], isLoading: paymentsLoading } = useQuery<Payment[]>({\n    queryKey: [\"/api/admin/finance/payments\", paymentFilter === \"all\" ? undefined : paymentFilter],\n  });\n\n  const { data: commissions = [], isLoading: commissionsLoading } = useQuery<VenueCommission[]>({\n    queryKey: [\"/api/admin/finance/commissions\"],\n  });\n\n  const formatCurrency = (amount: number) => {\n    return `Â¥${amount.toLocaleString(\"zh-CN\", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\n  };\n\n  const formatDateTime = (dateTimeStr: string) => {\n    try {\n      const date = new Date(dateTimeStr);\n      return format(date, \"yyyyå¹´MMæœˆddæ—¥ HH:mm\", { locale: zhCN });\n    } catch (e) {\n      return dateTimeStr;\n    }\n  };\n\n  const getUserName = (payment: Payment) => {\n    const firstName = payment.user_first_name || \"\";\n    const lastName = payment.user_last_name || \"\";\n    const fullName = `${firstName} ${lastName}`.trim();\n    return fullName || \"æœªçŸ¥ç”¨æˆ·\";\n  };\n\n  const sortedCommissions = [...commissions].sort((a, b) => b.total_commission - a.total_commission);\n\n  if (statsLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"space-y-6\">\n          <div className=\"grid gap-4 md:grid-cols-4\">\n            {[1, 2, 3, 4].map(i => (\n              <Card key={i} data-testid={`skeleton-metric-${i}`}>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">åŠ è½½ä¸­...</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">--</div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Metric Cards */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card data-testid=\"card-metric-total-revenue\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ€»æ”¶å…¥</CardTitle>\n            <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-revenue\">\n              {formatCurrency(stats?.totalRevenue || 0)}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">æ‰€æœ‰æ”¶å…¥æ€»å’Œ</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-metric-subscription-revenue\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">ä¼šå‘˜æ”¶å…¥</CardTitle>\n            <CreditCard className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-subscription-revenue\">\n              {formatCurrency(stats?.subscriptionRevenue || 0)}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">ä¼šå‘˜è®¢é˜…æ”¶å…¥</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-metric-event-revenue\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ´»åŠ¨æ”¶å…¥</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-event-revenue\">\n              {formatCurrency(stats?.eventRevenue || 0)}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">æ´»åŠ¨æ”¯ä»˜æ”¶å…¥</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-metric-total-payments\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ€»æ”¯ä»˜æ•°</CardTitle>\n            <Receipt className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-payments\">\n              {stats?.totalPayments || 0} ç¬”\n            </div>\n            <p className=\"text-xs text-muted-foreground\">æ‰€æœ‰æ”¯ä»˜è®°å½•</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Main Tabs */}\n      <Card data-testid=\"card-finance-content\">\n        <Tabs value={mainTab} onValueChange={(v) => setMainTab(v as any)}>\n          <CardHeader>\n            <TabsList data-testid=\"tabs-main\">\n              <TabsTrigger value=\"payments\" data-testid=\"tab-payments\">\n                æ”¯ä»˜è®°å½•\n              </TabsTrigger>\n              <TabsTrigger value=\"commissions\" data-testid=\"tab-commissions\">\n                åœºåœ°ä½£é‡‘\n              </TabsTrigger>\n            </TabsList>\n          </CardHeader>\n\n          <CardContent>\n            {/* Payment Records Tab */}\n            <TabsContent value=\"payments\" className=\"space-y-4\">\n              <Tabs value={paymentFilter} onValueChange={(v) => setPaymentFilter(v as any)}>\n                <TabsList data-testid=\"tabs-payment-filter\">\n                  <TabsTrigger value=\"all\" data-testid=\"filter-all\">\n                    å…¨éƒ¨\n                  </TabsTrigger>\n                  <TabsTrigger value=\"subscription\" data-testid=\"filter-subscription\">\n                    ä¼šå‘˜\n                  </TabsTrigger>\n                  <TabsTrigger value=\"event\" data-testid=\"filter-event\">\n                    æ´»åŠ¨\n                  </TabsTrigger>\n                </TabsList>\n              </Tabs>\n\n              {paymentsLoading ? (\n                <div className=\"py-12 text-center text-muted-foreground\" data-testid=\"text-loading-payments\">\n                  åŠ è½½ä¸­...\n                </div>\n              ) : payments.length === 0 ? (\n                <div className=\"py-12 text-center text-muted-foreground\" data-testid=\"text-no-payments\">\n                  æš‚æ— æ”¯ä»˜è®°å½•\n                </div>\n              ) : (\n                <div className=\"rounded-md border\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead data-testid=\"header-payment-id\">æ”¯ä»˜ID</TableHead>\n                        <TableHead data-testid=\"header-user\">ç”¨æˆ·</TableHead>\n                        <TableHead data-testid=\"header-payment-type\">ç±»å‹</TableHead>\n                        <TableHead data-testid=\"header-amount\">é‡‘é¢</TableHead>\n                        <TableHead data-testid=\"header-status\">çŠ¶æ€</TableHead>\n                        <TableHead data-testid=\"header-payment-method\">æ”¯ä»˜æ–¹å¼</TableHead>\n                        <TableHead data-testid=\"header-created-at\">åˆ›å»ºæ—¶é—´</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {payments.map((payment) => (\n                        <TableRow key={payment.id} data-testid={`row-payment-${payment.id}`}>\n                          <TableCell className=\"font-mono text-sm\" data-testid={`text-payment-id-${payment.id}`}>\n                            {payment.id.slice(0, 8)}...\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"space-y-1\">\n                              <div className=\"font-medium\" data-testid={`text-user-name-${payment.id}`}>\n                                {getUserName(payment)}\n                              </div>\n                              {payment.user_email && (\n                                <div className=\"text-xs text-muted-foreground\" data-testid={`text-user-email-${payment.id}`}>\n                                  {payment.user_email}\n                                </div>\n                              )}\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            <Badge \n                              variant={PAYMENT_TYPE_MAP[payment.payment_type]?.variant || \"outline\"}\n                              data-testid={`badge-payment-type-${payment.id}`}\n                            >\n                              {PAYMENT_TYPE_MAP[payment.payment_type]?.label || payment.payment_type}\n                            </Badge>\n                          </TableCell>\n                          <TableCell className=\"font-semibold\" data-testid={`text-amount-${payment.id}`}>\n                            {formatCurrency(payment.amount)}\n                          </TableCell>\n                          <TableCell>\n                            <Badge \n                              variant={STATUS_MAP[payment.status]?.variant || \"secondary\"}\n                              data-testid={`badge-status-${payment.id}`}\n                            >\n                              {STATUS_MAP[payment.status]?.label || payment.status}\n                            </Badge>\n                          </TableCell>\n                          <TableCell data-testid={`text-payment-method-${payment.id}`}>\n                            {payment.payment_method === \"wechat_pay\" ? \"å¾®ä¿¡æ”¯ä»˜\" : payment.payment_method}\n                          </TableCell>\n                          <TableCell className=\"text-sm\" data-testid={`text-created-at-${payment.id}`}>\n                            {formatDateTime(payment.created_at)}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </TabsContent>\n\n            {/* Venue Commissions Tab */}\n            <TabsContent value=\"commissions\" className=\"space-y-4\">\n              {commissionsLoading ? (\n                <div className=\"py-12 text-center text-muted-foreground\" data-testid=\"text-loading-commissions\">\n                  åŠ è½½ä¸­...\n                </div>\n              ) : sortedCommissions.length === 0 ? (\n                <div className=\"py-12 text-center text-muted-foreground\" data-testid=\"text-no-commissions\">\n                  æš‚æ— åœºåœ°ä½£é‡‘æ•°æ®\n                </div>\n              ) : (\n                <div className=\"rounded-md border\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead data-testid=\"header-venue-name\">åœºåœ°åç§°</TableHead>\n                        <TableHead data-testid=\"header-commission-rate\">ä½£é‡‘æ¯”ä¾‹</TableHead>\n                        <TableHead data-testid=\"header-booking-count\">é¢„è®¢æ•°é‡</TableHead>\n                        <TableHead data-testid=\"header-total-revenue\">æ€»è¥æ”¶</TableHead>\n                        <TableHead data-testid=\"header-total-commission\">æ€»ä½£é‡‘</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {sortedCommissions.map((commission) => (\n                        <TableRow key={commission.id} data-testid={`row-commission-${commission.id}`}>\n                          <TableCell>\n                            <div className=\"flex items-center gap-2\">\n                              <Store className=\"h-4 w-4 text-muted-foreground\" />\n                              <span className=\"font-medium\" data-testid={`text-venue-name-${commission.id}`}>\n                                {commission.venue_name}\n                              </span>\n                            </div>\n                          </TableCell>\n                          <TableCell data-testid={`text-commission-rate-${commission.id}`}>\n                            {commission.commission_rate}%\n                          </TableCell>\n                          <TableCell data-testid={`text-booking-count-${commission.id}`}>\n                            {commission.booking_count} æ¬¡\n                          </TableCell>\n                          <TableCell className=\"font-semibold\" data-testid={`text-total-revenue-${commission.id}`}>\n                            {formatCurrency(commission.total_revenue)}\n                          </TableCell>\n                          <TableCell className=\"font-semibold text-primary\" data-testid={`text-total-commission-${commission.id}`}>\n                            {formatCurrency(commission.total_commission)}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </TabsContent>\n          </CardContent>\n        </Tabs>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":14806},"client/src/pages/admin/AdminMatchingLabPage.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Label } from \"@/components/ui/label\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Sliders, TestTube2, Zap, Save, RotateCcw, Play, Users } from \"lucide-react\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\n\ninterface MatchingConfig {\n  configName: string;\n  personalityWeight: number;\n  interestsWeight: number;\n  intentWeight: number;\n  backgroundWeight: number;\n  cultureWeight: number;\n  minGroupSize: number;\n  maxGroupSize: number;\n  preferredGroupSize: number;\n  maxSameArchetypeRatio: number;\n  minChemistryScore: number;\n  isActive: boolean;\n}\n\ninterface User {\n  id: string;\n  firstName: string | null;\n  lastName: string | null;\n  displayName: string | null;\n  archetype: string | null;\n}\n\ninterface UsersResponse {\n  users: User[];\n  pagination: {\n    page: number;\n    limit: number;\n    total: number;\n    totalPages: number;\n  };\n}\n\ninterface MatchGroup {\n  groupId: string;\n  userIds: string[];\n  avgChemistryScore: number;\n  diversityScore: number;\n  overallScore: number;\n  users: User[];\n}\n\ninterface TestResult {\n  testId: string;\n  groups: MatchGroup[];\n  metrics: {\n    totalUsers: number;\n    groupCount: number;\n    avgChemistryScore: number;\n    avgDiversityScore: number;\n    overallMatchQuality: number;\n    executionTimeMs: number;\n  };\n}\n\nconst DEFAULT_CONFIG: MatchingConfig = {\n  configName: \"default\",\n  personalityWeight: 40,\n  interestsWeight: 25,\n  intentWeight: 10,\n  backgroundWeight: 15,\n  cultureWeight: 10,\n  minGroupSize: 5,\n  maxGroupSize: 10,\n  preferredGroupSize: 7,\n  maxSameArchetypeRatio: 40,\n  minChemistryScore: 60,\n  isActive: true,\n};\n\nexport default function AdminMatchingLabPage() {\n  const [config, setConfig] = useState<MatchingConfig>(DEFAULT_CONFIG);\n  const [selectedUserIds, setSelectedUserIds] = useState<string[]>([]);\n  const [testResult, setTestResult] = useState<TestResult | null>(null);\n  const { toast } = useToast();\n\n  // åŠ è½½å½“å‰é…ç½®\n  const { data: currentConfig, isLoading: configLoading } = useQuery<MatchingConfig>({\n    queryKey: [\"/api/matching/config\"],\n  });\n\n  // å½“é…ç½®åŠ è½½å®Œæˆæ—¶æ›´æ–°æœ¬åœ°çŠ¶æ€\n  useEffect(() => {\n    if (currentConfig) {\n      setConfig(currentConfig);\n    }\n  }, [currentConfig]);\n\n  // åŠ è½½æ‰€æœ‰ç”¨æˆ·ï¼ˆç”¨äºæµ‹è¯•åœºæ™¯ï¼‰- è¯·æ±‚æ›´å¤šç”¨æˆ·ä»¥ç¡®ä¿æœ‰è¶³å¤Ÿarchetypeç”¨æˆ·\n  const { data: usersResponse, isLoading: usersLoading } = useQuery<UsersResponse>({\n    queryKey: [\"/api/admin/users?limit=200\"],\n  });\n\n  const allUsers = usersResponse?.users || [];\n\n  // ä¿å­˜é…ç½®\n  const saveConfigMutation = useMutation({\n    mutationFn: (newConfig: MatchingConfig) =>\n      fetch(\"/api/matching/config\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(newConfig),\n      }).then((r) => {\n        if (!r.ok) throw new Error(\"Failed to save config\");\n        return r.json();\n      }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/matching/config\"] });\n      toast({\n        title: \"é…ç½®ä¿å­˜æˆåŠŸ\",\n        description: \"åŒ¹é…ç®—æ³•æƒé‡å·²æ›´æ–°\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"ä¿å­˜å¤±è´¥\",\n        description: \"æ— æ³•ä¿å­˜é…ç½®ï¼Œè¯·é‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // è¿è¡Œæµ‹è¯•åœºæ™¯\n  const runTestMutation = useMutation({\n    mutationFn: ({ userIds, config: testConfig }: { userIds: string[]; config: MatchingConfig }) =>\n      fetch(\"/api/matching/test-scenario\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ userIds, config: testConfig }),\n      }).then((r) => {\n        if (!r.ok) throw new Error(\"Failed to run test\");\n        return r.json();\n      }),\n    onSuccess: (data: TestResult) => {\n      setTestResult(data);\n      toast({\n        title: \"æµ‹è¯•å®Œæˆ\",\n        description: `æˆåŠŸåˆ›å»º ${data.groups.length} ä¸ªå°ç»„`,\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"æµ‹è¯•å¤±è´¥\",\n        description: error.message || \"æ— æ³•è¿è¡Œæµ‹è¯•åœºæ™¯\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const totalWeight = config.personalityWeight + config.interestsWeight + \n                      config.intentWeight + config.backgroundWeight + config.cultureWeight;\n\n  const handleWeightChange = (key: keyof MatchingConfig, value: number) => {\n    setConfig({ ...config, [key]: value });\n  };\n\n  const handleSave = () => {\n    if (totalWeight !== 100) {\n      toast({\n        title: \"æƒé‡æ€»å’Œå¿…é¡»ä¸º100%\",\n        description: `å½“å‰æ€»å’Œ: ${totalWeight}%`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n    saveConfigMutation.mutate(config);\n  };\n\n  const handleReset = () => {\n    if (currentConfig) {\n      setConfig(currentConfig);\n    } else {\n      setConfig(DEFAULT_CONFIG);\n    }\n  };\n\n  const handleRunTest = () => {\n    if (selectedUserIds.length < 5) {\n      toast({\n        title: \"ç”¨æˆ·æ•°é‡ä¸è¶³\",\n        description: \"è‡³å°‘éœ€è¦é€‰æ‹©5ä¸ªç”¨æˆ·è¿›è¡Œæµ‹è¯•\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    runTestMutation.mutate({ userIds: selectedUserIds, config });\n  };\n\n  const toggleUserSelection = (userId: string) => {\n    setSelectedUserIds((prev) =>\n      prev.includes(userId)\n        ? prev.filter((id) => id !== userId)\n        : [...prev, userId]\n    );\n  };\n\n  const selectRandomUsers = (count: number) => {\n    const usersWithArchetype = allUsers.filter(u => u.archetype);\n    const shuffled = [...usersWithArchetype].sort(() => Math.random() - 0.5);\n    setSelectedUserIds(shuffled.slice(0, count).map(u => u.id));\n  };\n\n  if (configLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-full\">\n        <div className=\"text-muted-foreground\">åŠ è½½ä¸­...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-8 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">åŒ¹é…å®éªŒå®¤</h1>\n        <p className=\"text-muted-foreground mt-1\">è°ƒæ•´AIåŒ¹é…ç®—æ³•å‚æ•°å’Œæµ‹è¯•åœºæ™¯</p>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        {/* å·¦ä¾§ï¼šç®—æ³•æƒé‡é…ç½® */}\n        <div className=\"space-y-6\">\n          <Card data-testid=\"card-algorithm-weights\">\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-primary/10 rounded-lg\">\n                    <Sliders className=\"h-5 w-5 text-primary\" />\n                  </div>\n                  <div>\n                    <CardTitle>ç®—æ³•æƒé‡é…ç½®</CardTitle>\n                    <CardDescription>è°ƒæ•´5ä¸ªç»´åº¦çš„æƒé‡ (æ€»å’Œå¿…é¡»ä¸º100%)</CardDescription>\n                  </div>\n                </div>\n                <Badge variant={totalWeight === 100 ? \"default\" : \"destructive\"} data-testid=\"badge-total-weight\">\n                  {totalWeight}%\n                </Badge>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              {/* æ€§æ ¼åŒ–å­¦ååº”æƒé‡ */}\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"text-sm font-medium\">æ€§æ ¼åŒ–å­¦ååº”</Label>\n                  <span className=\"text-sm font-semibold text-primary\" data-testid=\"text-personality-weight\">\n                    {config.personalityWeight}%\n                  </span>\n                </div>\n                <Slider\n                  value={[config.personalityWeight]}\n                  onValueChange={([value]) => handleWeightChange(\"personalityWeight\", value)}\n                  min={0}\n                  max={100}\n                  step={5}\n                  data-testid=\"slider-personality-weight\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  åŸºäº14ç§ç¤¾äº¤åŸå‹çš„å…¼å®¹æ€§è¯„åˆ†\n                </p>\n              </div>\n\n              <Separator />\n\n              {/* å…´è¶£é‡å åº¦æƒé‡ */}\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"text-sm font-medium\">å…´è¶£é‡å åº¦</Label>\n                  <span className=\"text-sm font-semibold text-primary\" data-testid=\"text-interests-weight\">\n                    {config.interestsWeight}%\n                  </span>\n                </div>\n                <Slider\n                  value={[config.interestsWeight]}\n                  onValueChange={([value]) => handleWeightChange(\"interestsWeight\", value)}\n                  min={0}\n                  max={100}\n                  step={5}\n                  data-testid=\"slider-interests-weight\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  å…±åŒå…´è¶£å’Œè¯é¢˜çš„åŒ¹é…åº¦\n                </p>\n              </div>\n\n              <Separator />\n\n              {/* èƒŒæ™¯å¤šæ ·æ€§æƒé‡ */}\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"text-sm font-medium\">èƒŒæ™¯å¤šæ ·æ€§</Label>\n                  <span className=\"text-sm font-semibold text-primary\" data-testid=\"text-background-weight\">\n                    {config.backgroundWeight}%\n                  </span>\n                </div>\n                <Slider\n                  value={[config.backgroundWeight]}\n                  onValueChange={([value]) => handleWeightChange(\"backgroundWeight\", value)}\n                  min={0}\n                  max={100}\n                  step={5}\n                  data-testid=\"slider-background-weight\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  å¹´é¾„ã€è¡Œä¸šã€åœ°åŸŸç­‰èƒŒæ™¯çš„å¤šæ ·æ€§\n                </p>\n              </div>\n\n              <Separator />\n\n              {/* å¯¹è¯å¹³è¡¡æƒé‡ */}\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"text-sm font-medium\">æ„å›¾å¯¹é½</Label>\n                  <span className=\"text-sm font-semibold text-primary\" data-testid=\"text-intent-weight\">\n                    {config.intentWeight}%\n                  </span>\n                </div>\n                <Slider\n                  value={[config.intentWeight]}\n                  onValueChange={([value]) => handleWeightChange(\"intentWeight\", value)}\n                  min={0}\n                  max={100}\n                  step={5}\n                  data-testid=\"slider-intent-weight\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  ç¤¾äº¤ç›®çš„å’Œæ„å›¾çš„ä¸€è‡´æ€§\n                </p>\n              </div>\n\n              <Separator />\n\n              {/* æ–‡åŒ–é€‚åº”æƒé‡ */}\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"text-sm font-medium\">æ–‡åŒ–é€‚åº”</Label>\n                  <span className=\"text-sm font-semibold text-primary\" data-testid=\"text-culture-weight\">\n                    {config.cultureWeight}%\n                  </span>\n                </div>\n                <Slider\n                  value={[config.cultureWeight]}\n                  onValueChange={([value]) => handleWeightChange(\"cultureWeight\", value)}\n                  min={0}\n                  max={100}\n                  step={5}\n                  data-testid=\"slider-culture-weight\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  è¯­è¨€åå¥½å’Œæ–‡åŒ–èƒŒæ™¯çš„åŒ¹é…åº¦\n                </p>\n              </div>\n\n              <Separator />\n\n              {/* æ“ä½œæŒ‰é’® */}\n              <div className=\"flex gap-2 pt-2\">\n                <Button\n                  onClick={handleSave}\n                  disabled={totalWeight !== 100 || saveConfigMutation.isPending}\n                  className=\"flex-1\"\n                  data-testid=\"button-save-config\"\n                >\n                  <Save className=\"mr-2 h-4 w-4\" />\n                  ä¿å­˜é…ç½®\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  onClick={handleReset}\n                  data-testid=\"button-reset-config\"\n                >\n                  <RotateCcw className=\"mr-2 h-4 w-4\" />\n                  é‡ç½®\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* å³ä¾§ï¼šæµ‹è¯•åœºæ™¯ */}\n        <div className=\"space-y-6\">\n          <Card data-testid=\"card-test-scenarios\">\n            <CardHeader>\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-primary/10 rounded-lg\">\n                  <TestTube2 className=\"h-5 w-5 text-primary\" />\n                </div>\n                <div>\n                  <CardTitle>æµ‹è¯•åœºæ™¯</CardTitle>\n                  <CardDescription>é€‰æ‹©ç”¨æˆ·è¿è¡ŒåŒ¹é…æµ‹è¯•</CardDescription>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"text-sm\">\n                  å·²é€‰æ‹© <span className=\"font-semibold text-primary\" data-testid=\"text-selected-count\">{selectedUserIds.length}</span> ä¸ªç”¨æˆ·\n                </div>\n                <div className=\"flex gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => selectRandomUsers(10)}\n                    data-testid=\"button-select-10-users\"\n                  >\n                    éšæœº10äºº\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => selectRandomUsers(20)}\n                    data-testid=\"button-select-20-users\"\n                  >\n                    éšæœº20äºº\n                  </Button>\n                </div>\n              </div>\n\n              <ScrollArea className=\"h-[300px] rounded-md border p-4\">\n                {usersLoading ? (\n                  <div className=\"text-sm text-muted-foreground\">åŠ è½½ç”¨æˆ·åˆ—è¡¨...</div>\n                ) : allUsers.filter(u => u.archetype).length === 0 ? (\n                  <div className=\"text-sm text-muted-foreground\">æš‚æ— å¯ç”¨ç”¨æˆ·</div>\n                ) : (\n                  <div className=\"space-y-2\">\n                    {allUsers.filter(u => u.archetype).map((user) => (\n                      <div\n                        key={user.id}\n                        className={`flex items-center justify-between p-2 rounded-md cursor-pointer hover-elevate ${\n                          selectedUserIds.includes(user.id) ? \"bg-primary/10\" : \"\"\n                        }`}\n                        onClick={() => toggleUserSelection(user.id)}\n                        data-testid={`user-item-${user.id}`}\n                      >\n                        <div className=\"flex items-center gap-2\">\n                          <div className=\"text-sm font-medium\">\n                            {user.displayName || user.firstName || \"æœªå‘½åç”¨æˆ·\"}\n                          </div>\n                          {user.archetype && (\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              {user.archetype}\n                            </Badge>\n                          )}\n                        </div>\n                        {selectedUserIds.includes(user.id) && (\n                          <div className=\"w-2 h-2 rounded-full bg-primary\" />\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </ScrollArea>\n\n              <Button\n                onClick={handleRunTest}\n                disabled={selectedUserIds.length < 5 || runTestMutation.isPending}\n                className=\"w-full\"\n                data-testid=\"button-run-test\"\n              >\n                <Play className=\"mr-2 h-4 w-4\" />\n                è¿è¡Œæµ‹è¯• ({selectedUserIds.length} äºº)\n              </Button>\n            </CardContent>\n          </Card>\n\n          {/* æµ‹è¯•ç»“æœ */}\n          {testResult && (\n            <Card data-testid=\"card-test-results\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-primary/10 rounded-lg\">\n                    <Zap className=\"h-5 w-5 text-primary\" />\n                  </div>\n                  <div>\n                    <CardTitle>åŒ¹é…ç»“æœ</CardTitle>\n                    <CardDescription>\n                      {testResult.metrics.groupCount} ä¸ªå°ç»„ Â· \n                      æ‰§è¡Œæ—¶é—´ {testResult.metrics.executionTimeMs}ms\n                    </CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {/* æ•´ä½“æŒ‡æ ‡ */}\n                <div className=\"grid grid-cols-3 gap-4\">\n                  <div className=\"text-center p-3 rounded-lg bg-muted\">\n                    <div className=\"text-2xl font-bold text-primary\" data-testid=\"text-avg-chemistry\">\n                      {testResult.metrics.avgChemistryScore}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground mt-1\">åŒ–å­¦ååº”</div>\n                  </div>\n                  <div className=\"text-center p-3 rounded-lg bg-muted\">\n                    <div className=\"text-2xl font-bold text-primary\" data-testid=\"text-avg-diversity\">\n                      {testResult.metrics.avgDiversityScore}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground mt-1\">å¤šæ ·æ€§</div>\n                  </div>\n                  <div className=\"text-center p-3 rounded-lg bg-muted\">\n                    <div className=\"text-2xl font-bold text-primary\" data-testid=\"text-overall-quality\">\n                      {testResult.metrics.overallMatchQuality}\n                    </div>\n                    <div className=\"text-xs text-muted-foreground mt-1\">æ•´ä½“è´¨é‡</div>\n                  </div>\n                </div>\n\n                <Separator />\n\n                {/* å„ç»„è¯¦æƒ… */}\n                <ScrollArea className=\"h-[200px]\">\n                  <div className=\"space-y-3\">\n                    {testResult.groups.map((group, idx) => (\n                      <div\n                        key={group.groupId}\n                        className=\"p-3 rounded-lg border\"\n                        data-testid={`group-result-${idx}`}\n                      >\n                        <div className=\"flex items-center justify-between mb-2\">\n                          <div className=\"flex items-center gap-2\">\n                            <Users className=\"h-4 w-4 text-muted-foreground\" />\n                            <span className=\"font-semibold\">å°ç»„ {idx + 1}</span>\n                            <Badge variant=\"outline\">{group.userIds.length}äºº</Badge>\n                          </div>\n                          <div className=\"text-sm\">\n                            <span className=\"text-muted-foreground\">æ€»åˆ† </span>\n                            <span className=\"font-semibold\">{group.overallScore}</span>\n                          </div>\n                        </div>\n                        <div className=\"flex gap-4 text-xs text-muted-foreground\">\n                          <div>åŒ–å­¦: {group.avgChemistryScore}</div>\n                          <div>å¤šæ ·: {group.diversityScore}</div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </ScrollArea>\n              </CardContent>\n            </Card>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":20592},"client/src/pages/admin/AdminEventsPage.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Calendar, Users, CheckCircle, Clock, TrendingUp } from \"lucide-react\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { format } from \"date-fns\";\nimport { zhCN } from \"date-fns/locale\";\nimport { useWebSocket } from \"@/hooks/useWebSocket\";\nimport { invalidateCacheForEvent } from \"@/lib/cacheInvalidation\";\n\ninterface EventCreator {\n  id: string;\n  firstName: string | null;\n  lastName: string | null;\n  email: string | null;\n  phoneNumber: string | null;\n}\n\ninterface BlindBoxEvent {\n  id: string;\n  userId: string;\n  title: string;\n  eventType: string;\n  city: string;\n  district: string;\n  dateTime: string;\n  budgetTier: string;\n  selectedLanguages: string[] | null;\n  selectedTasteIntensity: string[] | null;\n  selectedCuisines: string[] | null;\n  acceptNearby: boolean;\n  status: string;\n  progress: number;\n  currentParticipants: number;\n  etaMinutes: number | null;\n  restaurantName: string | null;\n  restaurantAddress: string | null;\n  totalParticipants: number | null;\n  maleCount: number | null;\n  femaleCount: number | null;\n  isGirlsNight: boolean;\n  matchedAttendees: any[] | null;\n  matchExplanation: string | null;\n  invitedCount: number;\n  invitedJoined: number;\n  createdAt: string;\n  updatedAt: string;\n  creator?: EventCreator;\n}\n\nconst STATUS_MAP: Record<string, { label: string; variant: \"default\" | \"secondary\" | \"destructive\" | \"outline\" }> = {\n  pending_match: { label: \"å¾…åŒ¹é…\", variant: \"secondary\" },\n  matched: { label: \"å·²åŒ¹é…\", variant: \"default\" },\n  completed: { label: \"å·²å®Œæˆ\", variant: \"outline\" },\n  canceled: { label: \"å·²å–æ¶ˆ\", variant: \"destructive\" },\n};\n\nexport default function AdminEventsPage() {\n  const [filterStatus, setFilterStatus] = useState<\"all\" | \"pending_match\" | \"matched\" | \"completed\">(\"all\");\n  const [selectedEvent, setSelectedEvent] = useState<BlindBoxEvent | null>(null);\n  const [showDetailsDialog, setShowDetailsDialog] = useState(false);\n  \n  const { toast } = useToast();\n  const { subscribe, isConnected } = useWebSocket();\n\n  const { data: events = [], isLoading } = useQuery<BlindBoxEvent[]>({\n    queryKey: [\"/api/admin/events\"],\n  });\n\n  // WebSocketå®æ—¶æ›´æ–°è®¢é˜…\n  useEffect(() => {\n    const unsubscribeStatus = subscribe('EVENT_STATUS_CHANGED', async (message) => {\n      console.log('[Admin] Event status changed:', message);\n      await invalidateCacheForEvent(message);\n      \n      const statusData = message.data as any;\n      toast({\n        title: \"æ´»åŠ¨çŠ¶æ€æ›´æ–°\",\n        description: `æ´»åŠ¨\"${statusData.eventTitle || 'æœªçŸ¥'}\"çŠ¶æ€å·²å˜æ›´ä¸º: ${statusData.newStatus}`,\n      });\n    });\n\n    const unsubscribeMatched = subscribe('EVENT_MATCHED', async (message) => {\n      console.log('[Admin] Event matched:', message);\n      await invalidateCacheForEvent(message);\n      \n      toast({\n        title: \"æ–°åŒ¹é…å®Œæˆ\",\n        description: \"æœ‰æ´»åŠ¨å®ŒæˆåŒ¹é…ï¼Œåˆ—è¡¨å·²æ›´æ–°\",\n      });\n    });\n\n    const unsubscribeUser = subscribe('USER_CONFIRMED', async (message) => {\n      console.log('[Admin] User confirmed:', message);\n      await invalidateCacheForEvent(message);\n    });\n\n    const unsubscribeCompleted = subscribe('EVENT_COMPLETED', async (message) => {\n      console.log('[Admin] Event completed:', message);\n      await invalidateCacheForEvent(message);\n      \n      toast({\n        title: \"æ´»åŠ¨å·²å®Œæˆ\",\n        description: \"æœ‰æ´»åŠ¨å·²æ ‡è®°ä¸ºå®Œæˆ\",\n      });\n    });\n\n    return () => {\n      unsubscribeStatus();\n      unsubscribeMatched();\n      unsubscribeUser();\n      unsubscribeCompleted();\n    };\n  }, [subscribe, toast]);\n\n  const updateStatusMutation = useMutation({\n    mutationFn: ({ id, status }: { id: string; status: string }) =>\n      fetch(`/api/admin/events/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ status }),\n      }).then((r) => r.json()),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/events\"] });\n      toast({\n        title: \"çŠ¶æ€æ›´æ–°æˆåŠŸ\",\n        description: \"æ´»åŠ¨çŠ¶æ€å·²æ›´æ–°\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"æ›´æ–°å¤±è´¥\",\n        description: \"æ— æ³•æ›´æ–°æ´»åŠ¨çŠ¶æ€ï¼Œè¯·é‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleViewDetails = async (event: BlindBoxEvent) => {\n    // Fetch detailed event data\n    try {\n      const response = await fetch(`/api/admin/events/${event.id}`, {\n        credentials: \"include\",\n      });\n      const detailedEvent = await response.json();\n      setSelectedEvent(detailedEvent);\n      setShowDetailsDialog(true);\n    } catch (error) {\n      toast({\n        title: \"åŠ è½½å¤±è´¥\",\n        description: \"æ— æ³•åŠ è½½æ´»åŠ¨è¯¦æƒ…\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleStatusUpdate = (newStatus: string) => {\n    if (selectedEvent) {\n      updateStatusMutation.mutate({ id: selectedEvent.id, status: newStatus });\n      setSelectedEvent({ ...selectedEvent, status: newStatus });\n    }\n  };\n\n  const filteredEvents = filterStatus === \"all\" \n    ? events \n    : events.filter(e => e.status === filterStatus);\n\n  const totalEvents = events.length;\n  const pendingCount = events.filter(e => e.status === \"pending_match\").length;\n  const matchedCount = events.filter(e => e.status === \"matched\").length;\n  const completedCount = events.filter(e => e.status === \"completed\").length;\n\n  const formatDateTime = (dateTimeStr: string) => {\n    try {\n      const date = new Date(dateTimeStr);\n      return format(date, \"yyyyå¹´MMæœˆddæ—¥ HH:mm\", { locale: zhCN });\n    } catch (e) {\n      return dateTimeStr;\n    }\n  };\n\n  const getCreatorName = (event: BlindBoxEvent) => {\n    if (!event.creator) return \"æœªçŸ¥ç”¨æˆ·\";\n    const firstName = event.creator.firstName || \"\";\n    const lastName = event.creator.lastName || \"\";\n    return `${firstName} ${lastName}`.trim() || event.creator.email || \"æœªçŸ¥ç”¨æˆ·\";\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"space-y-6\">\n          <div className=\"grid gap-4 md:grid-cols-4\">\n            {[1, 2, 3, 4].map(i => (\n              <Card key={i} data-testid={`skeleton-metric-${i}`}>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">åŠ è½½ä¸­...</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">--</div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      {/* Metric Cards */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card data-testid=\"card-metric-total\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ€»æ´»åŠ¨æ•°</CardTitle>\n            <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-total-events\">{totalEvents}</div>\n            <p className=\"text-xs text-muted-foreground\">æ‰€æœ‰ç›²ç›’æ´»åŠ¨</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-metric-pending\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">å¾…åŒ¹é…</CardTitle>\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-pending-events\">{pendingCount}</div>\n            <p className=\"text-xs text-muted-foreground\">ç­‰å¾…åŒ¹é…ä¸­</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-metric-matched\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">å·²åŒ¹é…</CardTitle>\n            <CheckCircle className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-matched-events\">{matchedCount}</div>\n            <p className=\"text-xs text-muted-foreground\">æˆåŠŸåŒ¹é…</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-metric-completed\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">å·²å®Œæˆ</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"text-completed-events\">{completedCount}</div>\n            <p className=\"text-xs text-muted-foreground\">æ´»åŠ¨å·²ç»“æŸ</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Filter Tabs */}\n      <Card data-testid=\"card-events-list\">\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <CardTitle>æ´»åŠ¨åˆ—è¡¨</CardTitle>\n          </div>\n          <Tabs value={filterStatus} onValueChange={(v) => setFilterStatus(v as any)}>\n            <TabsList data-testid=\"tabs-filter\">\n              <TabsTrigger value=\"all\" data-testid=\"tab-all\">å…¨éƒ¨</TabsTrigger>\n              <TabsTrigger value=\"pending_match\" data-testid=\"tab-pending\">å¾…åŒ¹é…</TabsTrigger>\n              <TabsTrigger value=\"matched\" data-testid=\"tab-matched\">å·²åŒ¹é…</TabsTrigger>\n              <TabsTrigger value=\"completed\" data-testid=\"tab-completed\">å·²å®Œæˆ</TabsTrigger>\n            </TabsList>\n          </Tabs>\n        </CardHeader>\n        <CardContent>\n          {filteredEvents.length === 0 ? (\n            <div className=\"py-12 text-center text-muted-foreground\" data-testid=\"text-no-events\">\n              æš‚æ— æ´»åŠ¨\n            </div>\n          ) : (\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n              {filteredEvents.map((event) => (\n                <Card key={event.id} className=\"overflow-hidden\" data-testid={`card-event-${event.id}`}>\n                  <CardHeader className=\"pb-3\">\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <div className=\"flex-1 space-y-1\">\n                        <CardTitle className=\"text-base\" data-testid={`text-event-title-${event.id}`}>\n                          {event.title}\n                        </CardTitle>\n                        <div className=\"flex items-center gap-2\">\n                          <Badge variant=\"outline\" data-testid={`badge-event-type-${event.id}`}>\n                            {event.eventType}\n                          </Badge>\n                          <Badge \n                            variant={STATUS_MAP[event.status]?.variant || \"default\"}\n                            data-testid={`badge-event-status-${event.id}`}\n                          >\n                            {STATUS_MAP[event.status]?.label || event.status}\n                          </Badge>\n                        </div>\n                      </div>\n                    </div>\n                  </CardHeader>\n                  <CardContent className=\"space-y-3\">\n                    <div className=\"space-y-2 text-sm\">\n                      <div className=\"flex items-center gap-2\">\n                        <Users className=\"h-4 w-4 text-muted-foreground\" />\n                        <span className=\"text-muted-foreground\">åˆ›å»ºè€…:</span>\n                        <span data-testid={`text-creator-name-${event.id}`}>\n                          {getCreatorName(event)}\n                        </span>\n                      </div>\n                      {event.creator?.email && (\n                        <div className=\"text-xs text-muted-foreground\" data-testid={`text-creator-email-${event.id}`}>\n                          {event.creator.email}\n                        </div>\n                      )}\n                      <div className=\"flex items-center gap-2\">\n                        <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                        <span data-testid={`text-event-datetime-${event.id}`}>\n                          {formatDateTime(event.dateTime)}\n                        </span>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Users className=\"h-4 w-4 text-muted-foreground\" />\n                        <span data-testid={`text-participants-${event.id}`}>\n                          {event.currentParticipants}/{event.totalParticipants || \"?\"} å‚ä¸è€…\n                        </span>\n                      </div>\n                      {(event.restaurantName || event.city) && (\n                        <div className=\"text-xs text-muted-foreground\" data-testid={`text-location-${event.id}`}>\n                          ğŸ“ {event.restaurantName || `${event.city} ${event.district}`}\n                        </div>\n                      )}\n                    </div>\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      className=\"w-full\"\n                      onClick={() => handleViewDetails(event)}\n                      data-testid={`button-view-details-${event.id}`}\n                    >\n                      æŸ¥çœ‹è¯¦æƒ…\n                    </Button>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Event Details Dialog */}\n      <Dialog open={showDetailsDialog} onOpenChange={setShowDetailsDialog}>\n        <DialogContent className=\"max-h-[80vh] max-w-2xl overflow-y-auto\" data-testid=\"dialog-event-details\">\n          <DialogHeader>\n            <DialogTitle data-testid=\"text-dialog-title\">\n              {selectedEvent?.title}\n            </DialogTitle>\n          </DialogHeader>\n          {selectedEvent && (\n            <div className=\"space-y-6\">\n              {/* Basic Info */}\n              <div className=\"space-y-3\">\n                <h3 className=\"font-semibold\">åŸºæœ¬ä¿¡æ¯</h3>\n                <div className=\"grid gap-3 text-sm\">\n                  <div className=\"grid grid-cols-3 gap-2\">\n                    <span className=\"text-muted-foreground\">æ´»åŠ¨ç±»å‹:</span>\n                    <span className=\"col-span-2\" data-testid=\"text-detail-event-type\">\n                      {selectedEvent.eventType}\n                    </span>\n                  </div>\n                  <div className=\"grid grid-cols-3 gap-2\">\n                    <span className=\"text-muted-foreground\">æ´»åŠ¨æ—¶é—´:</span>\n                    <span className=\"col-span-2\" data-testid=\"text-detail-datetime\">\n                      {formatDateTime(selectedEvent.dateTime)}\n                    </span>\n                  </div>\n                  <div className=\"grid grid-cols-3 gap-2\">\n                    <span className=\"text-muted-foreground\">åŸå¸‚/å•†åœˆ:</span>\n                    <span className=\"col-span-2\" data-testid=\"text-detail-location\">\n                      {selectedEvent.city} - {selectedEvent.district}\n                    </span>\n                  </div>\n                  <div className=\"grid grid-cols-3 gap-2\">\n                    <span className=\"text-muted-foreground\">é¢„ç®—:</span>\n                    <span className=\"col-span-2\" data-testid=\"text-detail-budget\">\n                      Â¥{selectedEvent.budgetTier}\n                    </span>\n                  </div>\n                  <div className=\"grid grid-cols-3 gap-2\">\n                    <span className=\"text-muted-foreground\">çŠ¶æ€:</span>\n                    <div className=\"col-span-2\">\n                      <Badge \n                        variant={STATUS_MAP[selectedEvent.status]?.variant || \"default\"}\n                        data-testid=\"badge-detail-status\"\n                      >\n                        {STATUS_MAP[selectedEvent.status]?.label || selectedEvent.status}\n                      </Badge>\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              {/* Creator Info */}\n              <div className=\"space-y-3\">\n                <h3 className=\"font-semibold\">åˆ›å»ºè€…ä¿¡æ¯</h3>\n                <div className=\"grid gap-3 text-sm\">\n                  <div className=\"grid grid-cols-3 gap-2\">\n                    <span className=\"text-muted-foreground\">å§“å:</span>\n                    <span className=\"col-span-2\" data-testid=\"text-detail-creator-name\">\n                      {getCreatorName(selectedEvent)}\n                    </span>\n                  </div>\n                  {selectedEvent.creator?.email && (\n                    <div className=\"grid grid-cols-3 gap-2\">\n                      <span className=\"text-muted-foreground\">é‚®ç®±:</span>\n                      <span className=\"col-span-2\" data-testid=\"text-detail-creator-email\">\n                        {selectedEvent.creator.email}\n                      </span>\n                    </div>\n                  )}\n                  {selectedEvent.creator?.phoneNumber && (\n                    <div className=\"grid grid-cols-3 gap-2\">\n                      <span className=\"text-muted-foreground\">ç”µè¯:</span>\n                      <span className=\"col-span-2\" data-testid=\"text-detail-creator-phone\">\n                        {selectedEvent.creator.phoneNumber}\n                      </span>\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              {/* Preferences */}\n              <div className=\"space-y-3\">\n                <h3 className=\"font-semibold\">æ´»åŠ¨åå¥½</h3>\n                <div className=\"grid gap-3 text-sm\">\n                  {selectedEvent.selectedLanguages && selectedEvent.selectedLanguages.length > 0 && (\n                    <div className=\"grid grid-cols-3 gap-2\">\n                      <span className=\"text-muted-foreground\">è¯­è¨€:</span>\n                      <span className=\"col-span-2\" data-testid=\"text-detail-languages\">\n                        {selectedEvent.selectedLanguages.join(\", \")}\n                      </span>\n                    </div>\n                  )}\n                  {selectedEvent.selectedCuisines && selectedEvent.selectedCuisines.length > 0 && (\n                    <div className=\"grid grid-cols-3 gap-2\">\n                      <span className=\"text-muted-foreground\">èœç³»:</span>\n                      <span className=\"col-span-2\" data-testid=\"text-detail-cuisines\">\n                        {selectedEvent.selectedCuisines.join(\", \")}\n                      </span>\n                    </div>\n                  )}\n                  {selectedEvent.selectedTasteIntensity && selectedEvent.selectedTasteIntensity.length > 0 && (\n                    <div className=\"grid grid-cols-3 gap-2\">\n                      <span className=\"text-muted-foreground\">å£å‘³å¼ºåº¦:</span>\n                      <span className=\"col-span-2\" data-testid=\"text-detail-taste\">\n                        {selectedEvent.selectedTasteIntensity.join(\", \")}\n                      </span>\n                    </div>\n                  )}\n                  <div className=\"grid grid-cols-3 gap-2\">\n                    <span className=\"text-muted-foreground\">æ¥å—é™„è¿‘:</span>\n                    <span className=\"col-span-2\" data-testid=\"text-detail-nearby\">\n                      {selectedEvent.acceptNearby ? \"æ˜¯\" : \"å¦\"}\n                    </span>\n                  </div>\n                  {selectedEvent.isGirlsNight && (\n                    <div className=\"grid grid-cols-3 gap-2\">\n                      <span className=\"text-muted-foreground\">å¥³ç”Ÿä¸“åœº:</span>\n                      <span className=\"col-span-2\" data-testid=\"text-detail-girls-night\">\n                        æ˜¯\n                      </span>\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              {/* Matched Details */}\n              {(selectedEvent.status === \"matched\" || selectedEvent.status === \"completed\") && (\n                <>\n                  {selectedEvent.restaurantName && (\n                    <div className=\"space-y-3\">\n                      <h3 className=\"font-semibold\">åœºåœ°ä¿¡æ¯</h3>\n                      <div className=\"grid gap-3 text-sm\">\n                        <div className=\"grid grid-cols-3 gap-2\">\n                          <span className=\"text-muted-foreground\">é¤å…åç§°:</span>\n                          <span className=\"col-span-2\" data-testid=\"text-detail-restaurant\">\n                            {selectedEvent.restaurantName}\n                          </span>\n                        </div>\n                        {selectedEvent.restaurantAddress && (\n                          <div className=\"grid grid-cols-3 gap-2\">\n                            <span className=\"text-muted-foreground\">åœ°å€:</span>\n                            <span className=\"col-span-2\" data-testid=\"text-detail-address\">\n                              {selectedEvent.restaurantAddress}\n                            </span>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  )}\n\n                  {selectedEvent.matchedAttendees && selectedEvent.matchedAttendees.length > 0 && (\n                    <div className=\"space-y-3\">\n                      <h3 className=\"font-semibold\">å‚ä¸è€…åˆ—è¡¨</h3>\n                      <div className=\"space-y-2\">\n                        {selectedEvent.matchedAttendees.map((attendee: any, idx: number) => (\n                          <div \n                            key={idx} \n                            className=\"rounded-lg border p-3 text-sm\"\n                            data-testid={`card-attendee-${idx}`}\n                          >\n                            <div className=\"font-medium\" data-testid={`text-attendee-name-${idx}`}>\n                              {attendee.displayName || \"åŒ¿åç”¨æˆ·\"}\n                            </div>\n                            {attendee.archetype && (\n                              <div className=\"text-xs text-muted-foreground\">\n                                {attendee.archetype}\n                              </div>\n                            )}\n                            {attendee.topInterests && attendee.topInterests.length > 0 && (\n                              <div className=\"mt-1 flex flex-wrap gap-1\">\n                                {attendee.topInterests.map((interest: string, i: number) => (\n                                  <Badge key={i} variant=\"secondary\" className=\"text-xs\">\n                                    {interest}\n                                  </Badge>\n                                ))}\n                              </div>\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {selectedEvent.matchExplanation && (\n                    <div className=\"space-y-3\">\n                      <h3 className=\"font-semibold\">åŒ¹é…è¯´æ˜</h3>\n                      <p className=\"text-sm text-muted-foreground\" data-testid=\"text-detail-explanation\">\n                        {selectedEvent.matchExplanation}\n                      </p>\n                    </div>\n                  )}\n                </>\n              )}\n\n              {/* Status Update */}\n              <div className=\"space-y-3\">\n                <h3 className=\"font-semibold\">ç®¡ç†æ“ä½œ</h3>\n                <div className=\"flex items-center gap-3\">\n                  <Label>æ›´æ–°çŠ¶æ€:</Label>\n                  <Select \n                    value={selectedEvent.status} \n                    onValueChange={handleStatusUpdate}\n                  >\n                    <SelectTrigger className=\"w-40\" data-testid=\"select-update-status\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"pending_match\" data-testid=\"option-status-pending\">\n                        å¾…åŒ¹é…\n                      </SelectItem>\n                      <SelectItem value=\"matched\" data-testid=\"option-status-matched\">\n                        å·²åŒ¹é…\n                      </SelectItem>\n                      <SelectItem value=\"completed\" data-testid=\"option-status-completed\">\n                        å·²å®Œæˆ\n                      </SelectItem>\n                      <SelectItem value=\"canceled\" data-testid=\"option-status-canceled\">\n                        å·²å–æ¶ˆ\n                      </SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":25748},"server/paymentService.ts":{"content":"import { storage } from \"./storage\";\n\n/**\n * Payment Service for WeChat Pay Integration\n * \n * SETUP REQUIRED:\n * 1. Register for WeChat Pay merchant account (https://pay.weixin.qq.com/)\n * 2. Install WeChat Pay SDK: npm install wechatpay-node-v3\n * 3. Add environment variables:\n *    - WECHAT_PAY_APP_ID\n *    - WECHAT_PAY_MCH_ID (Merchant ID)\n *    - WECHAT_PAY_SERIAL_NO (Certificate serial number)\n *    - WECHAT_PAY_PRIVATE_KEY (API v3 private key)\n *    - WECHAT_PAY_APIV3_KEY (API v3 key)\n * \n * Docs: https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml\n */\n\nexport interface CreatePaymentParams {\n  userId: string;\n  paymentType: \"subscription\" | \"event\";\n  relatedId: string; // subscription ID or event ID\n  originalAmount: number; // in cents (Â¥98 = 9800)\n  couponId?: string;\n}\n\nexport interface PaymentResult {\n  paymentId: string;\n  wechatOrderId: string;\n  prepayId?: string; // WeChat prepay_id for H5/JSAPI\n  codeUrl?: string; // QR code URL for Native payment\n  h5Url?: string; // H5 payment URL\n}\n\nexport class PaymentService {\n  /**\n   * Create a new payment order\n   */\n  async createPayment(params: CreatePaymentParams): Promise<PaymentResult> {\n    const { userId, paymentType, relatedId, originalAmount, couponId } = params;\n    \n    // Calculate discount if coupon provided\n    let discountAmount = 0;\n    let finalAmount = originalAmount;\n    \n    if (couponId) {\n      const coupon = await storage.getCoupon(couponId);\n      if (coupon && coupon.isActive) {\n        // Validate coupon\n        const now = new Date();\n        const validFrom = new Date(coupon.validFrom);\n        const validUntil = coupon.validUntil ? new Date(coupon.validUntil) : null;\n        \n        if (now >= validFrom && (!validUntil || now <= validUntil)) {\n          // Check usage limits\n          if (coupon.maxUses === null || coupon.currentUses < coupon.maxUses) {\n            // Calculate discount\n            if (coupon.discountType === \"fixed_amount\") {\n              discountAmount = coupon.discountValue;\n            } else if (coupon.discountType === \"percentage\") {\n              discountAmount = Math.floor(originalAmount * (coupon.discountValue / 100));\n            }\n            finalAmount = Math.max(0, originalAmount - discountAmount);\n          }\n        }\n      }\n    }\n    \n    // Generate unique order ID\n    const wechatOrderId = `JJ${Date.now()}${Math.random().toString(36).substr(2, 9)}`;\n    \n    // Create payment record\n    const payment = await storage.createPayment({\n      userId,\n      paymentType,\n      relatedId,\n      originalAmount,\n      discountAmount,\n      finalAmount,\n      couponId,\n      wechatOrderId,\n      status: \"pending\",\n    });\n    \n    // TODO: Call WeChat Pay API to create prepay order\n    // This is where you would integrate the actual WeChat Pay SDK\n    // Example (pseudo-code):\n    // const wechatPay = new WeChatPay({ appId, mchId, ... });\n    // const prepayResult = await wechatPay.transactions.h5({\n    //   description: paymentType === 'subscription' ? 'JoyJoinä¼šå‘˜è®¢é˜…' : 'JoyJoinæ´»åŠ¨æŠ¥å',\n    //   out_trade_no: wechatOrderId,\n    //   amount: { total: finalAmount, currency: 'CNY' },\n    //   scene_info: { payer_client_ip: '...' },\n    // });\n    \n    console.log(`[Payment] Created payment ${payment.id} for user ${userId}, amount: Â¥${finalAmount / 100}`);\n    \n    // MOCK RESPONSE - Replace with actual WeChat Pay response\n    return {\n      paymentId: payment.id,\n      wechatOrderId,\n      h5Url: `https://wx.tenpay.com/cgi-bin/mmpayweb-bin/checkmweb?prepay_id=MOCK_${wechatOrderId}`,\n    };\n  }\n  \n  /**\n   * Handle WeChat Pay webhook callback\n   * \n   * WeChat Pay will send a POST request to your webhook URL when payment status changes\n   * Endpoint: POST /api/webhooks/wechat-pay\n   */\n  async handleWebhook(payload: any): Promise<void> {\n    // TODO: Verify WeChat Pay signature\n    // const verified = this.verifySignature(payload);\n    // if (!verified) throw new Error('Invalid signature');\n    \n    const { resource, event_type } = payload;\n    \n    if (event_type === \"TRANSACTION.SUCCESS\") {\n      // Payment successful\n      const { out_trade_no, transaction_id, amount } = resource.ciphertext\n        ? this.decryptResource(resource) // Decrypt if encrypted\n        : resource;\n      \n      await this.handlePaymentSuccess(out_trade_no, transaction_id);\n    } else if (event_type === \"REFUND.SUCCESS\") {\n      // Refund successful\n      const { out_trade_no } = resource.ciphertext \n        ? this.decryptResource(resource)\n        : resource;\n      \n      await this.handleRefundSuccess(out_trade_no);\n    }\n  }\n  \n  /**\n   * Handle successful payment - activate subscription or event registration\n   */\n  private async handlePaymentSuccess(wechatOrderId: string, transactionId: string): Promise<void> {\n    console.log(`[Payment] Processing successful payment: ${wechatOrderId}`);\n    \n    // Find payment by WeChat order ID\n    const payments = await storage.getAllPayments();\n    const payment = payments.find(p => p.wechatOrderId === wechatOrderId);\n    \n    if (!payment) {\n      console.error(`[Payment] Payment not found for order ${wechatOrderId}`);\n      return;\n    }\n    \n    // Update payment status\n    await storage.updatePayment(payment.id, {\n      status: \"completed\",\n      wechatTransactionId: transactionId,\n      paidAt: new Date(),\n    });\n    \n    // Record coupon usage if applicable\n    if (payment.couponId) {\n      await storage.recordCouponUsage({\n        couponId: payment.couponId,\n        userId: payment.userId,\n        paymentId: payment.id,\n        discountApplied: payment.discountAmount,\n      });\n    }\n    \n    // Activate subscription or confirm event registration\n    if (payment.paymentType === \"subscription\") {\n      await this.activateSubscription(payment.relatedId, payment.id);\n    } else if (payment.paymentType === \"event\") {\n      await this.confirmEventRegistration(payment.relatedId, payment.userId);\n    }\n    \n    // TODO: Send notification to user\n    await storage.createNotification({\n      userId: payment.userId,\n      category: \"activities\",\n      type: payment.paymentType === \"subscription\" ? \"subscription_activated\" : \"event_confirmed\",\n      title: payment.paymentType === \"subscription\" ? \"ä¼šå‘˜è®¢é˜…æˆåŠŸ\" : \"æ´»åŠ¨æŠ¥åæˆåŠŸ\",\n      message: payment.paymentType === \"subscription\" \n        ? \"æ‚¨çš„JoyJoinä¼šå‘˜å·²æ¿€æ´»ï¼Œå¼€å§‹æ¢ç´¢ç²¾å½©æ´»åŠ¨å§ï¼\" \n        : \"æ‚¨çš„æ´»åŠ¨æŠ¥åå·²ç¡®è®¤ï¼ŒæœŸå¾…ä¸æ‚¨è§é¢ï¼\",\n      relatedResourceId: payment.relatedId,\n    });\n  }\n  \n  /**\n   * Activate subscription after successful payment\n   */\n  private async activateSubscription(subscriptionId: string, paymentId: string): Promise<void> {\n    await storage.updateSubscription(subscriptionId, {\n      status: \"active\",\n      paymentId,\n    });\n    \n    console.log(`[Payment] Activated subscription ${subscriptionId}`);\n  }\n  \n  /**\n   * Confirm event registration after successful payment\n   */\n  private async confirmEventRegistration(eventId: string, userId: string): Promise<void> {\n    // TODO: Mark event attendance as paid/confirmed\n    console.log(`[Payment] Confirmed event registration for event ${eventId}, user ${userId}`);\n  }\n  \n  /**\n   * Handle successful refund\n   */\n  private async handleRefundSuccess(wechatOrderId: string): Promise<void> {\n    console.log(`[Payment] Processing refund for order: ${wechatOrderId}`);\n    \n    const payments = await storage.getAllPayments();\n    const payment = payments.find(p => p.wechatOrderId === wechatOrderId);\n    \n    if (!payment) {\n      console.error(`[Payment] Payment not found for refund ${wechatOrderId}`);\n      return;\n    }\n    \n    await storage.updatePayment(payment.id, {\n      status: \"refunded\",\n    });\n    \n    // Deactivate subscription if it was a subscription payment\n    if (payment.paymentType === \"subscription\" && payment.relatedId) {\n      await storage.updateSubscription(payment.relatedId, {\n        status: \"cancelled\",\n      });\n    }\n  }\n  \n  /**\n   * Decrypt WeChat Pay encrypted resource\n   * See: https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_2.shtml\n   */\n  private decryptResource(resource: any): any {\n    // TODO: Implement AES-256-GCM decryption\n    // const { ciphertext, nonce, associated_data } = resource;\n    // Use APIV3_KEY to decrypt\n    throw new Error(\"Decryption not implemented - add WeChat Pay SDK\");\n  }\n  \n  /**\n   * Verify WeChat Pay webhook signature\n   */\n  private verifySignature(payload: any): boolean {\n    // TODO: Implement signature verification\n    // See: https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_1.shtml\n    return true; // MOCK - always return true in development\n  }\n  \n  /**\n   * Query payment status from WeChat Pay\n   */\n  async queryPaymentStatus(wechatOrderId: string): Promise<string> {\n    // TODO: Call WeChat Pay API to query payment status\n    // const status = await wechatPay.transactions.queryByOutTradeNo({ out_trade_no: wechatOrderId });\n    console.log(`[Payment] Querying status for order ${wechatOrderId}`);\n    return \"pending\"; // MOCK\n  }\n  \n  /**\n   * Create refund for a payment\n   */\n  async createRefund(paymentId: string, reason: string): Promise<void> {\n    const payments = await storage.getAllPayments();\n    const payment = payments.find(p => p.id === paymentId);\n    \n    if (!payment) {\n      throw new Error(\"Payment not found\");\n    }\n    \n    if (payment.status !== \"completed\") {\n      throw new Error(\"Can only refund completed payments\");\n    }\n    \n    // TODO: Call WeChat Pay refund API\n    // const refund = await wechatPay.refunds.create({\n    //   out_trade_no: payment.wechatOrderId,\n    //   out_refund_no: `RF${Date.now()}`,\n    //   amount: { refund: payment.finalAmount, total: payment.finalAmount, currency: 'CNY' },\n    //   reason,\n    // });\n    \n    console.log(`[Payment] Initiated refund for payment ${paymentId}, reason: ${reason}`);\n  }\n}\n\nexport const paymentService = new PaymentService();\n","size_bytes":9994},"server/venueMatchingService.ts":{"content":"import { storage } from \"./storage\";\n\n/**\n * Venue Matching Service\n * \n * Intelligently selects appropriate venues for events based on:\n * - Event type and theme\n * - Participant count\n * - Location preferences\n * - Cuisine preferences (for dining events)\n * - Venue capacity and availability\n */\n\nexport interface VenueMatchingCriteria {\n  eventType: string;\n  theme?: string;\n  participantCount: number;\n  preferredDistrict?: string;\n  preferredCity?: string;\n  cuisinePreferences?: string[];\n  priceRange?: string;\n  dateTime?: Date;\n}\n\nexport interface VenueMatchResult {\n  venue: any;\n  matchScore: number;\n  reasons: string[];\n}\n\nexport class VenueMatchingService {\n  /**\n   * Find the best matching venues for an event\n   * Returns top 5 venues sorted by match score\n   */\n  async findMatchingVenues(criteria: VenueMatchingCriteria): Promise<VenueMatchResult[]> {\n    const allVenues = await storage.getAllVenues();\n    \n    // Filter only active venues\n    const activeVenues = allVenues.filter(v => v.isActive);\n    \n    if (activeVenues.length === 0) {\n      console.warn(\"[VenueMatching] No active venues available\");\n      return [];\n    }\n    \n    // Score each venue\n    const scoredVenues = activeVenues.map(venue => {\n      const { score, reasons } = this.calculateVenueScore(venue, criteria);\n      return {\n        venue,\n        matchScore: score,\n        reasons,\n      };\n    });\n    \n    // Sort by score (highest first) and return top 5\n    const topVenues = scoredVenues\n      .filter(v => v.matchScore > 0) // Only return venues with positive scores\n      .sort((a, b) => b.matchScore - a.matchScore)\n      .slice(0, 5);\n    \n    console.log(`[VenueMatching] Found ${topVenues.length} matching venues for ${criteria.eventType} with ${criteria.participantCount} participants`);\n    \n    return topVenues;\n  }\n  \n  /**\n   * Calculate match score for a single venue\n   * Score range: 0-100\n   */\n  private calculateVenueScore(venue: any, criteria: VenueMatchingCriteria): { score: number; reasons: string[] } {\n    let score = 0;\n    const reasons: string[] = [];\n    \n    // 1. Event type match (20 points)\n    const eventTypeMatch = this.matchEventType(venue.type, criteria.eventType);\n    if (eventTypeMatch.matches) {\n      score += 20;\n      reasons.push(eventTypeMatch.reason);\n    } else {\n      // If event type doesn't match at all, return low score\n      return { score: 5, reasons: [\"åœºåœ°ç±»å‹ä¸å¤ªåŒ¹é…\"] };\n    }\n    \n    // 2. Capacity match (25 points)\n    const capacityMatch = this.matchCapacity(venue, criteria.participantCount);\n    score += capacityMatch.score;\n    if (capacityMatch.reason) {\n      reasons.push(capacityMatch.reason);\n    }\n    \n    // 3. Location match (20 points)\n    const locationMatch = this.matchLocation(venue, criteria);\n    score += locationMatch.score;\n    if (locationMatch.reason) {\n      reasons.push(locationMatch.reason);\n    }\n    \n    // 4. Cuisine match (15 points) - only for dining events\n    if (criteria.eventType === \"dining\" && criteria.cuisinePreferences && criteria.cuisinePreferences.length > 0) {\n      const cuisineMatch = this.matchCuisine(venue, criteria.cuisinePreferences);\n      score += cuisineMatch.score;\n      if (cuisineMatch.reason) {\n        reasons.push(cuisineMatch.reason);\n      }\n    } else if (criteria.eventType === \"dining\") {\n      score += 10; // Partial points if no cuisine preference specified\n    }\n    \n    // 5. Price range match (10 points)\n    if (criteria.priceRange) {\n      const priceMatch = this.matchPriceRange(venue, criteria.priceRange);\n      score += priceMatch.score;\n      if (priceMatch.reason) {\n        reasons.push(priceMatch.reason);\n      }\n    } else {\n      score += 5; // Partial points if no price preference\n    }\n    \n    // 6. Availability bonus (10 points)\n    // Check if venue has capacity for concurrent events\n    if (venue.maxConcurrentEvents > 1) {\n      score += 10;\n      reasons.push(\"åœºåœ°å¯åŒæ—¶ä¸¾åŠå¤šåœºæ´»åŠ¨\");\n    } else {\n      score += 5;\n    }\n    \n    return { score: Math.min(100, score), reasons };\n  }\n  \n  /**\n   * Match event type to venue type\n   */\n  private matchEventType(venueType: string, eventType: string): { matches: boolean; reason: string } {\n    const typeMapping: Record<string, string[]> = {\n      restaurant: [\"dining\", \"networking\", \"social\"],\n      cafe: [\"casual\", \"networking\", \"creative\", \"social\"],\n      bar: [\"social\", \"networking\", \"entertainment\"],\n      workspace: [\"professional\", \"creative\", \"workshop\", \"networking\"],\n      studio: [\"creative\", \"workshop\", \"fitness\", \"wellness\"],\n      outdoor: [\"sports\", \"adventure\", \"wellness\"],\n      venue: [\"entertainment\", \"cultural\", \"workshop\"],\n    };\n    \n    const compatibleTypes = typeMapping[venueType] || [];\n    const matches = compatibleTypes.includes(eventType);\n    \n    if (matches) {\n      return { matches: true, reason: `é€‚åˆ${this.getEventTypeLabel(eventType)}æ´»åŠ¨` };\n    }\n    \n    return { matches: false, reason: \"åœºåœ°ç±»å‹ä¸åŒ¹é…\" };\n  }\n  \n  /**\n   * Match participant count to venue capacity\n   */\n  private matchCapacity(venue: any, participantCount: number): { score: number; reason?: string } {\n    // Most venues should handle 5-10 people comfortably\n    // We want venues that can handle the group but aren't too large\n    \n    if (participantCount <= 10) {\n      // Perfect for small groups (blind box events are typically 5-10 people)\n      return { score: 25, reason: \"å®¹é‡å®Œç¾é€‚é…å°å‹èšä¼š\" };\n    } else if (participantCount <= 15) {\n      return { score: 20, reason: \"å¯å®¹çº³ä¸­å°å‹å›¢ä½“\" };\n    } else if (participantCount <= 20) {\n      return { score: 15, reason: \"é€‚åˆä¸­å‹æ´»åŠ¨\" };\n    } else {\n      return { score: 10, reason: \"å¯å®¹çº³è¾ƒå¤§å‹æ´»åŠ¨\" };\n    }\n  }\n  \n  /**\n   * Match location preferences\n   */\n  private matchLocation(venue: any, criteria: VenueMatchingCriteria): { score: number; reason?: string } {\n    let score = 0;\n    let reason = \"\";\n    \n    // City match (10 points)\n    if (criteria.preferredCity && venue.city === criteria.preferredCity) {\n      score += 10;\n      reason = `ä½äº${venue.city}`;\n    } else if (criteria.preferredCity) {\n      score += 3; // Partial points for different city\n    } else {\n      score += 5; // No preference specified\n    }\n    \n    // District match (10 points)\n    if (criteria.preferredDistrict && venue.district === criteria.preferredDistrict) {\n      score += 10;\n      reason = reason ? `${reason}${venue.district}åŒº` : `ä½äº${venue.district}åŒº`;\n    } else if (criteria.preferredDistrict) {\n      score += 3; // Partial points for different district\n    } else {\n      score += 5; // No preference specified\n    }\n    \n    return { score, reason };\n  }\n  \n  /**\n   * Match cuisine preferences for dining events\n   */\n  private matchCuisine(venue: any, cuisinePreferences: string[]): { score: number; reason?: string } {\n    if (!venue.cuisines || venue.cuisines.length === 0) {\n      return { score: 5, reason: undefined }; // Partial points if venue has no cuisine tags\n    }\n    \n    const matchingCuisines = venue.cuisines.filter((c: string) => \n      cuisinePreferences.includes(c)\n    );\n    \n    if (matchingCuisines.length > 0) {\n      const score = Math.min(15, matchingCuisines.length * 7);\n      return { \n        score, \n        reason: `æä¾›${matchingCuisines.join(\"ã€\")}æ–™ç†` \n      };\n    }\n    \n    return { score: 3, reason: undefined }; // Small points for having cuisine data even if no match\n  }\n  \n  /**\n   * Match price range\n   */\n  private matchPriceRange(venue: any, preferredRange: string): { score: number; reason?: string } {\n    if (!venue.priceRange) {\n      return { score: 5, reason: undefined };\n    }\n    \n    if (venue.priceRange === preferredRange) {\n      return { score: 10, reason: `ä»·æ ¼åŒºé—´${this.getPriceRangeLabel(preferredRange)}` };\n    }\n    \n    // Adjacent price ranges get partial points\n    const ranges = [\"budget\", \"moderate\", \"upscale\", \"luxury\"];\n    const preferredIndex = ranges.indexOf(preferredRange);\n    const venueIndex = ranges.indexOf(venue.priceRange);\n    \n    if (Math.abs(preferredIndex - venueIndex) === 1) {\n      return { score: 5, reason: undefined };\n    }\n    \n    return { score: 2, reason: undefined };\n  }\n  \n  /**\n   * Get user-friendly event type label\n   */\n  private getEventTypeLabel(eventType: string): string {\n    const labels: Record<string, string> = {\n      dining: \"ç¾é£Ÿ\",\n      networking: \"ç¤¾äº¤\",\n      casual: \"ä¼‘é—²\",\n      creative: \"åˆ›æ„\",\n      professional: \"ä¸“ä¸š\",\n      workshop: \"å·¥ä½œåŠ\",\n      fitness: \"å¥èº«\",\n      wellness: \"å…»ç”Ÿ\",\n      sports: \"è¿åŠ¨\",\n      adventure: \"æ¢é™©\",\n      entertainment: \"å¨±ä¹\",\n      cultural: \"æ–‡åŒ–\",\n      social: \"ç¤¾äº¤\",\n    };\n    \n    return labels[eventType] || eventType;\n  }\n  \n  /**\n   * Get user-friendly price range label\n   */\n  private getPriceRangeLabel(priceRange: string): string {\n    const labels: Record<string, string> = {\n      budget: \"ç»æµå®æƒ \",\n      moderate: \"ä¸­ç­‰ä»·ä½\",\n      upscale: \"é«˜æ¡£\",\n      luxury: \"å¥¢å\",\n    };\n    \n    return labels[priceRange] || priceRange;\n  }\n  \n  /**\n   * Select the best venue for an event (returns single venue)\n   */\n  async selectBestVenue(criteria: VenueMatchingCriteria): Promise<VenueMatchResult | null> {\n    const matches = await this.findMatchingVenues(criteria);\n    \n    if (matches.length === 0) {\n      console.warn(\"[VenueMatching] No suitable venues found for criteria\");\n      return null;\n    }\n    \n    return matches[0]; // Return the highest-scoring venue\n  }\n}\n\nexport const venueMatchingService = new VenueMatchingService();\n","size_bytes":9683},"server/subscriptionService.ts":{"content":"import { storage } from \"./storage\";\n\n/**\n * Subscription Management Service\n * \n * Handles subscription expiry checks, renewals, and status updates.\n */\n\nexport class SubscriptionService {\n  private checkInterval: NodeJS.Timeout | null = null;\n  \n  /**\n   * Start the subscription expiry checker\n   * Runs every hour to check for expired subscriptions\n   */\n  startExpiryChecker(intervalMs: number = 60 * 60 * 1000): void {\n    console.log(\"[Subscription] Starting expiry checker...\");\n    \n    // Run immediately on startup\n    this.checkExpiredSubscriptions();\n    \n    // Then run on interval\n    this.checkInterval = setInterval(() => {\n      this.checkExpiredSubscriptions();\n    }, intervalMs);\n  }\n  \n  /**\n   * Stop the subscription expiry checker\n   */\n  stopExpiryChecker(): void {\n    if (this.checkInterval) {\n      clearInterval(this.checkInterval);\n      this.checkInterval = null;\n      console.log(\"[Subscription] Expiry checker stopped\");\n    }\n  }\n  \n  /**\n   * Check for expired subscriptions and update their status\n   */\n  async checkExpiredSubscriptions(): Promise<void> {\n    try {\n      console.log(\"[Subscription] Checking for expired subscriptions...\");\n      \n      const activeSubscriptions = await storage.getActiveSubscriptions();\n      const now = new Date();\n      let expiredCount = 0;\n      let expiringCount = 0;\n      \n      for (const subscription of activeSubscriptions) {\n        const endDate = new Date(subscription.endDate);\n        \n        // Check if subscription has expired\n        if (endDate < now) {\n          await storage.updateSubscription(subscription.id, {\n            status: \"expired\",\n          });\n          \n          // Notify user about expiration\n          await storage.createNotification({\n            userId: subscription.userId,\n            category: \"activities\",\n            type: \"subscription_expired\",\n            title: \"ä¼šå‘˜å·²è¿‡æœŸ\",\n            message: \"æ‚¨çš„JoyJoinä¼šå‘˜å·²è¿‡æœŸã€‚ç»­è´¹ä»¥ç»§ç»­äº«å—ä¼šå‘˜æƒç›Šï¼\",\n            relatedResourceId: subscription.id,\n          });\n          \n          expiredCount++;\n          console.log(`[Subscription] Expired subscription ${subscription.id} for user ${subscription.userId}`);\n        }\n        \n        // Check if subscription is expiring soon (within 3 days)\n        const threeDaysFromNow = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);\n        if (endDate > now && endDate <= threeDaysFromNow) {\n          // Send expiring soon notification (only if not already sent)\n          // We can add a field to track if notification was sent, for now just send it\n          await storage.createNotification({\n            userId: subscription.userId,\n            category: \"activities\",\n            type: \"subscription_expiring\",\n            title: \"ä¼šå‘˜å³å°†è¿‡æœŸ\",\n            message: `æ‚¨çš„JoyJoinä¼šå‘˜å°†åœ¨ ${this.formatDaysRemaining(now, endDate)} åè¿‡æœŸã€‚ç«‹å³ç»­è´¹äº«å—ä¸é—´æ–­æœåŠ¡ï¼`,\n            relatedResourceId: subscription.id,\n          });\n          \n          expiringCount++;\n          console.log(`[Subscription] Subscription ${subscription.id} expiring soon for user ${subscription.userId}`);\n        }\n      }\n      \n      if (expiredCount > 0 || expiringCount > 0) {\n        console.log(`[Subscription] Processed ${expiredCount} expired and ${expiringCount} expiring subscriptions`);\n      } else {\n        console.log(\"[Subscription] No expired or expiring subscriptions found\");\n      }\n    } catch (error) {\n      console.error(\"[Subscription] Error checking expired subscriptions:\", error);\n    }\n  }\n  \n  /**\n   * Format remaining days for notification message\n   */\n  private formatDaysRemaining(now: Date, endDate: Date): string {\n    const msRemaining = endDate.getTime() - now.getTime();\n    const daysRemaining = Math.ceil(msRemaining / (24 * 60 * 60 * 1000));\n    \n    if (daysRemaining === 1) {\n      return \"1å¤©\";\n    } else if (daysRemaining < 1) {\n      const hoursRemaining = Math.ceil(msRemaining / (60 * 60 * 1000));\n      return `${hoursRemaining}å°æ—¶`;\n    } else {\n      return `${daysRemaining}å¤©`;\n    }\n  }\n  \n  /**\n   * Get subscription status for a user\n   */\n  async getUserSubscriptionStatus(userId: string): Promise<{\n    hasActiveSubscription: boolean;\n    subscription?: any;\n    daysRemaining?: number;\n  }> {\n    const subscription = await storage.getUserSubscription(userId);\n    \n    if (!subscription || subscription.status !== \"active\") {\n      return { hasActiveSubscription: false };\n    }\n    \n    const now = new Date();\n    const endDate = new Date(subscription.endDate);\n    const msRemaining = endDate.getTime() - now.getTime();\n    const daysRemaining = Math.ceil(msRemaining / (24 * 60 * 60 * 1000));\n    \n    return {\n      hasActiveSubscription: true,\n      subscription,\n      daysRemaining: Math.max(0, daysRemaining),\n    };\n  }\n  \n  /**\n   * Cancel a subscription (mark as cancelled)\n   */\n  async cancelSubscription(subscriptionId: string, reason?: string): Promise<void> {\n    await storage.updateSubscription(subscriptionId, {\n      status: \"cancelled\",\n    });\n    \n    console.log(`[Subscription] Cancelled subscription ${subscriptionId}, reason: ${reason || \"N/A\"}`);\n  }\n  \n  /**\n   * Renew a subscription by creating a new payment\n   * Returns the payment details for WeChat Pay checkout\n   */\n  async renewSubscription(userId: string, planType: \"monthly\" | \"quarterly\"): Promise<any> {\n    // Get the user's current subscription\n    const currentSubscription = await storage.getUserSubscription(userId);\n    \n    // Calculate amount based on plan type\n    const amounts = {\n      monthly: 9800,   // Â¥98 in cents\n      quarterly: 29400, // Â¥294 in cents (3 months)\n    };\n    \n    const originalAmount = amounts[planType];\n    \n    // Create a new subscription record (pending until payment completes)\n    const startDate = currentSubscription && new Date(currentSubscription.endDate) > new Date()\n      ? new Date(currentSubscription.endDate) // Start after current subscription ends\n      : new Date(); // Start immediately if no active subscription\n    \n    const endDate = new Date(startDate);\n    endDate.setMonth(endDate.getMonth() + (planType === \"monthly\" ? 1 : 3));\n    \n    const newSubscription = await storage.createSubscription({\n      userId,\n      planType,\n      startDate,\n      endDate,\n      status: \"pending\", // Will be activated when payment completes\n      paymentId: null, // Will be set by payment webhook\n    });\n    \n    console.log(`[Subscription] Created pending ${planType} renewal for user ${userId}`);\n    \n    // Return subscription ID for payment creation\n    return {\n      subscriptionId: newSubscription.id,\n      amount: originalAmount,\n      planType,\n    };\n  }\n}\n\nexport const subscriptionService = new SubscriptionService();\n","size_bytes":6815},"client/src/pages/admin/AdminLoginPage.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Shield, AlertCircle } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\n\nexport default function AdminLoginPage() {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [verificationCode, setVerificationCode] = useState(\"\");\n  const [codeSent, setCodeSent] = useState(false);\n  const [countdown, setCountdown] = useState(0);\n  const [error, setError] = useState(\"\");\n\n  const { data: user } = useQuery({\n    queryKey: ['/api/auth/user'],\n    queryFn: async () => {\n      try {\n        return await apiRequest(\"GET\", \"/api/auth/user\");\n      } catch {\n        return null;\n      }\n    },\n    retry: false,\n  });\n\n  useEffect(() => {\n    if (user && (user as any).isAdmin) {\n      setLocation(\"/admin\");\n    }\n  }, [user, setLocation]);\n\n  const sendCodeMutation = useMutation({\n    mutationFn: async (phone: string) => {\n      return await apiRequest(\"POST\", \"/api/auth/send-code\", { phoneNumber: phone });\n    },\n    onSuccess: () => {\n      setCodeSent(true);\n      setCountdown(60);\n      const timer = setInterval(() => {\n        setCountdown((prev) => {\n          if (prev <= 1) {\n            clearInterval(timer);\n            return 0;\n          }\n          return prev - 1;\n        });\n      }, 1000);\n      \n      toast({\n        title: \"éªŒè¯ç å·²å‘é€\",\n        description: \"è¯·æŸ¥æ”¶çŸ­ä¿¡éªŒè¯ç \",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"å‘é€å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const passwordLoginMutation = useMutation({\n    mutationFn: async (data: { phoneNumber: string; password: string }) => {\n      return await apiRequest(\"POST\", \"/api/auth/admin-login\", data);\n    },\n    onSuccess: async () => {\n      toast({\n        title: \"ç™»å½•æˆåŠŸ\",\n        description: \"æ¬¢è¿è®¿é—®ç®¡ç†åå°\",\n      });\n      \n      await queryClient.invalidateQueries({ queryKey: ['/api/auth/user'] });\n      setTimeout(() => {\n        setLocation(\"/admin\");\n      }, 500);\n    },\n    onError: (error: Error) => {\n      setError(error.message);\n      toast({\n        title: \"ç™»å½•å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const codeLoginMutation = useMutation({\n    mutationFn: async (data: { phoneNumber: string; code: string }) => {\n      const res = await apiRequest(\"POST\", \"/api/auth/phone-login\", data);\n      return await res.json();\n    },\n    onSuccess: async (userData) => {\n      // æ£€æŸ¥ç™»å½•æˆåŠŸçš„ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜\n      if (!userData.isAdmin) {\n        setError(\"è¯¥è´¦å·ä¸æ˜¯ç®¡ç†å‘˜è´¦å·\");\n        toast({\n          title: \"ç™»å½•å¤±è´¥\",\n          description: \"è¯¥è´¦å·ä¸æ˜¯ç®¡ç†å‘˜è´¦å·\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      \n      toast({\n        title: \"ç™»å½•æˆåŠŸ\",\n        description: \"æ¬¢è¿è®¿é—®ç®¡ç†åå°\",\n      });\n      \n      await queryClient.invalidateQueries({ queryKey: ['/api/auth/user'] });\n      setTimeout(() => {\n        setLocation(\"/admin\");\n      }, 500);\n    },\n    onError: (error: Error) => {\n      setError(error.message);\n      toast({\n        title: \"ç™»å½•å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSendCode = () => {\n    if (!phoneNumber || phoneNumber.length !== 11) {\n      toast({\n        title: \"æ‰‹æœºå·æ ¼å¼é”™è¯¯\",\n        description: \"è¯·è¾“å…¥11ä½æ‰‹æœºå·\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    sendCodeMutation.mutate(phoneNumber);\n  };\n\n  const handlePasswordLogin = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!phoneNumber || !password) {\n      toast({\n        title: \"ä¿¡æ¯ä¸å®Œæ•´\",\n        description: \"è¯·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç \",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    if (phoneNumber.length !== 11) {\n      toast({\n        title: \"æ‰‹æœºå·æ ¼å¼é”™è¯¯\",\n        description: \"è¯·è¾“å…¥11ä½æ‰‹æœºå·\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    setError(\"\");\n    passwordLoginMutation.mutate({ phoneNumber, password });\n  };\n\n  const handleCodeLogin = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!phoneNumber || !verificationCode) {\n      toast({\n        title: \"ä¿¡æ¯ä¸å®Œæ•´\",\n        description: \"è¯·è¾“å…¥æ‰‹æœºå·å’ŒéªŒè¯ç \",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    if (phoneNumber.length !== 11) {\n      toast({\n        title: \"æ‰‹æœºå·æ ¼å¼é”™è¯¯\",\n        description: \"è¯·è¾“å…¥11ä½æ‰‹æœºå·\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    setError(\"\");\n    codeLoginMutation.mutate({ phoneNumber, code: verificationCode });\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md shadow-lg\">\n        <CardHeader className=\"space-y-4 text-center pb-6\">\n          <div className=\"flex justify-center\">\n            <div className=\"h-16 w-16 rounded-xl bg-gradient-to-br from-slate-700 to-slate-900 dark:from-slate-600 dark:to-slate-800 flex items-center justify-center shadow-md\">\n              <Shield className=\"h-8 w-8 text-white\" />\n            </div>\n          </div>\n          \n          <div>\n            <CardTitle className=\"text-2xl font-bold\">ç®¡ç†åå°</CardTitle>\n            <CardDescription className=\"mt-2\">\n              æ‚¦èšÂ·Joy Admin Portal\n            </CardDescription>\n          </div>\n        </CardHeader>\n\n        <CardContent className=\"space-y-5\">\n          {error && (\n            <Alert variant=\"destructive\">\n              <AlertCircle className=\"h-4 w-4\" />\n              <AlertDescription>\n                {error}\n              </AlertDescription>\n            </Alert>\n          )}\n\n          <Tabs defaultValue=\"code\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-2\">\n              <TabsTrigger value=\"code\" data-testid=\"tab-code-login\">éªŒè¯ç ç™»å½•</TabsTrigger>\n              <TabsTrigger value=\"password\" data-testid=\"tab-password-login\">å¯†ç ç™»å½•</TabsTrigger>\n            </TabsList>\n            \n            <TabsContent value=\"code\" className=\"space-y-4 mt-4\">\n              <form onSubmit={handleCodeLogin} className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"admin-phone-code\" className=\"text-sm font-medium\">\n                    ç®¡ç†å‘˜æ‰‹æœºå·\n                  </Label>\n                  <Input\n                    id=\"admin-phone-code\"\n                    type=\"tel\"\n                    placeholder=\"è¯·è¾“å…¥11ä½æ‰‹æœºå·\"\n                    value={phoneNumber}\n                    onChange={(e) => setPhoneNumber(e.target.value.replace(/\\D/g, '').slice(0, 11))}\n                    maxLength={11}\n                    className=\"h-11\"\n                    data-testid=\"input-admin-phone-code\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"admin-code\" className=\"text-sm font-medium\">éªŒè¯ç </Label>\n                  <div className=\"flex gap-2\">\n                    <Input\n                      id=\"admin-code\"\n                      type=\"text\"\n                      placeholder=\"è¯·è¾“å…¥éªŒè¯ç \"\n                      value={verificationCode}\n                      onChange={(e) => setVerificationCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n                      maxLength={6}\n                      className=\"h-11\"\n                      data-testid=\"input-admin-code\"\n                    />\n                    <Button\n                      type=\"button\"\n                      variant=\"outline\"\n                      onClick={handleSendCode}\n                      disabled={countdown > 0 || sendCodeMutation.isPending}\n                      className=\"min-w-[100px] h-11\"\n                      data-testid=\"button-send-admin-code\"\n                    >\n                      {countdown > 0 ? `${countdown}ç§’` : codeSent ? \"é‡æ–°å‘é€\" : \"å‘é€éªŒè¯ç \"}\n                    </Button>\n                  </div>\n                </div>\n\n                <Button\n                  type=\"submit\"\n                  size=\"lg\"\n                  className=\"w-full h-11\"\n                  disabled={codeLoginMutation.isPending}\n                  data-testid=\"button-admin-code-login\"\n                >\n                  {codeLoginMutation.isPending ? \"ç™»å½•ä¸­...\" : \"ç™»å½•ç®¡ç†åå°\"}\n                </Button>\n              </form>\n            </TabsContent>\n            \n            <TabsContent value=\"password\" className=\"space-y-4 mt-4\">\n              <form onSubmit={handlePasswordLogin} className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"admin-phone-pwd\" className=\"text-sm font-medium\">\n                    ç®¡ç†å‘˜æ‰‹æœºå·\n                  </Label>\n                  <Input\n                    id=\"admin-phone-pwd\"\n                    type=\"tel\"\n                    placeholder=\"è¯·è¾“å…¥11ä½æ‰‹æœºå·\"\n                    value={phoneNumber}\n                    onChange={(e) => setPhoneNumber(e.target.value.replace(/\\D/g, '').slice(0, 11))}\n                    maxLength={11}\n                    className=\"h-11\"\n                    data-testid=\"input-admin-phone-pwd\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"admin-password\" className=\"text-sm font-medium\">\n                    å¯†ç \n                  </Label>\n                  <Input\n                    id=\"admin-password\"\n                    type=\"password\"\n                    placeholder=\"è¯·è¾“å…¥å¯†ç \"\n                    value={password}\n                    onChange={(e) => setPassword(e.target.value)}\n                    className=\"h-11\"\n                    data-testid=\"input-admin-password\"\n                  />\n                </div>\n\n                <Button\n                  type=\"submit\"\n                  size=\"lg\"\n                  className=\"w-full h-11\"\n                  disabled={passwordLoginMutation.isPending}\n                  data-testid=\"button-admin-pwd-login\"\n                >\n                  {passwordLoginMutation.isPending ? \"ç™»å½•ä¸­...\" : \"ç™»å½•ç®¡ç†åå°\"}\n                </Button>\n              </form>\n            </TabsContent>\n          </Tabs>\n\n          <div className=\"pt-4 border-t\">\n            <p className=\"text-xs text-center text-muted-foreground\">\n              ä»…é™æˆæƒç®¡ç†å‘˜è®¿é—® Â· æ‰€æœ‰æ“ä½œå°†è¢«è®°å½•\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":11497},"server/userMatchingService.ts":{"content":"/**\n * ç”¨æˆ·åŒ¹é…ç®—æ³•æœåŠ¡\n * å®ç°åŸºäº14ç§æ€§æ ¼åŸå‹çš„å¤šç»´åº¦æ™ºèƒ½åŒ¹é…\n */\n\nimport type { User } from '@shared/schema';\nimport { getChemistryScore, calculateGroupChemistry, type ArchetypeName } from './archetypeChemistry';\n\n// åŒ¹é…é…ç½®æ¥å£\nexport interface MatchingWeights {\n  personalityWeight: number;   // æ€§æ ¼å…¼å®¹æ€§æƒé‡ (0-100)\n  interestsWeight: number;      // å…´è¶£åŒ¹é…æƒé‡ (0-100)\n  intentWeight: number;         // æ„å›¾åŒ¹é…æƒé‡ (0-100)\n  backgroundWeight: number;     // èƒŒæ™¯å¤šæ ·æ€§æƒé‡ (0-100)\n  cultureWeight: number;        // æ–‡åŒ–è¯­è¨€æƒé‡ (0-100)\n}\n\n// é»˜è®¤æƒé‡é…ç½®\nexport const DEFAULT_WEIGHTS: MatchingWeights = {\n  personalityWeight: 30,\n  interestsWeight: 25,\n  intentWeight: 20,\n  backgroundWeight: 15,\n  cultureWeight: 10,\n};\n\n// ç”¨æˆ·åŒ¹é…åˆ†æ•°æ¥å£\nexport interface UserMatchScore {\n  userId: string;\n  overallScore: number;       // æ€»åˆ† (0-100)\n  personalityScore: number;   // æ€§æ ¼å…¼å®¹æ€§åˆ†æ•°\n  interestsScore: number;     // å…´è¶£åŒ¹é…åˆ†æ•°\n  intentScore: number;        // æ„å›¾åŒ¹é…åˆ†æ•°\n  backgroundScore: number;    // èƒŒæ™¯å¤šæ ·æ€§åˆ†æ•°\n  cultureScore: number;       // æ–‡åŒ–è¯­è¨€åˆ†æ•°\n  chemistryScore: number;     // åŒ–å­¦ååº”åˆ†æ•°ï¼ˆåŸºäºåŸå‹ï¼‰\n  matchPoints: string[];      // åŒ¹é…ç‚¹ï¼ˆç”¨äºè§£é‡Šï¼‰\n}\n\n// å°ç»„åŒ¹é…ç»“æœ\nexport interface GroupMatch {\n  groupId: string;\n  userIds: string[];\n  users: Partial<User>[];\n  avgChemistryScore: number;\n  diversityScore: number;\n  overallScore: number;\n  matchExplanation: string;\n}\n\n/**\n * è®¡ç®—ä¸¤ä¸ªç”¨æˆ·ä¹‹é—´çš„æ€§æ ¼å…¼å®¹æ€§åˆ†æ•°\n */\nfunction calculatePersonalityScore(user1: Partial<User>, user2: Partial<User>): number {\n  if (!user1.primaryRole || !user2.primaryRole) return 50;\n  \n  try {\n    const chemistry = getChemistryScore(\n      user1.primaryRole as ArchetypeName,\n      user2.primaryRole as ArchetypeName\n    );\n    return chemistry;\n  } catch {\n    return 50; // å¦‚æœåŸå‹ä¸åœ¨çŸ©é˜µä¸­ï¼Œè¿”å›ä¸­ç­‰åˆ†æ•°\n  }\n}\n\n/**\n * è®¡ç®—ä¸¤ä¸ªç”¨æˆ·ä¹‹é—´çš„å…´è¶£åŒ¹é…åˆ†æ•°\n */\nfunction calculateInterestsScore(user1: Partial<User>, user2: Partial<User>): number {\n  const interests1 = user1.interestsTop || [];\n  const interests2 = user2.interestsTop || [];\n  \n  if (interests1.length === 0 || interests2.length === 0) return 50;\n  \n  // è®¡ç®—äº¤é›†\n  const commonInterests = interests1.filter(i => interests2.includes(i));\n  const matchRatio = commonInterests.length / Math.max(interests1.length, interests2.length);\n  \n  // è½¬æ¢ä¸º0-100åˆ†æ•°\n  return Math.min(100, Math.round(matchRatio * 100 + 30)); // è‡³å°‘30åˆ†åŸºç¡€åˆ†\n}\n\n/**\n * è®¡ç®—ä¸¤ä¸ªç”¨æˆ·ä¹‹é—´çš„æ„å›¾åŒ¹é…åˆ†æ•°\n */\nfunction calculateIntentScore(user1: Partial<User>, user2: Partial<User>): number {\n  const intent1 = user1.intent || [];\n  const intent2 = user2.intent || [];\n  \n  if (intent1.length === 0 || intent2.length === 0) return 50;\n  \n  // è®¡ç®—äº¤é›†\n  const commonIntent = intent1.filter(i => intent2.includes(i));\n  \n  // \"flexible\"æ„å›¾ä¸ä»»ä½•æ„å›¾éƒ½å…¼å®¹\n  const hasFlexible = intent1.includes(\"flexible\") || intent2.includes(\"flexible\");\n  \n  if (commonIntent.length > 0) {\n    return 90; // æœ‰å…±åŒæ„å›¾ï¼Œé«˜åˆ†\n  } else if (hasFlexible) {\n    return 75; // ä¸€æ–¹flexibleï¼Œè‰¯å¥½å…¼å®¹\n  } else {\n    return 40; // æ„å›¾å®Œå…¨ä¸åŒï¼Œè¾ƒä½åˆ†\n  }\n}\n\n/**\n * è®¡ç®—ä¸¤ä¸ªç”¨æˆ·ä¹‹é—´çš„èƒŒæ™¯å¤šæ ·æ€§åˆ†æ•°\n * æ³¨æ„ï¼šå¤šæ ·æ€§åˆ†æ•°è¶Šé«˜è¡¨ç¤ºèƒŒæ™¯è¶Šä¸åŒï¼Œè¿™å¯¹äºä¸°å¯Œå¯¹è¯å¾ˆæœ‰ä»·å€¼\n */\nfunction calculateBackgroundScore(user1: Partial<User>, user2: Partial<User>): number {\n  let diversityPoints = 0;\n  let totalChecks = 0;\n  \n  // è¡Œä¸šä¸åŒ (+1)\n  if (user1.industry && user2.industry) {\n    totalChecks++;\n    if (user1.industry !== user2.industry) diversityPoints += 1;\n  }\n  \n  // æ•™è‚²èƒŒæ™¯ä¸åŒ (+1)\n  if (user1.educationLevel && user2.educationLevel) {\n    totalChecks++;\n    if (user1.educationLevel !== user2.educationLevel) diversityPoints += 0.5;\n  }\n  \n  // å­¦ä¹ åœ°åŸŸä¸åŒ (+1)\n  if (user1.studyLocale && user2.studyLocale) {\n    totalChecks++;\n    if (user1.studyLocale !== user2.studyLocale) diversityPoints += 1;\n  }\n  \n  // å®¶ä¹¡ä¸åŒ (+1)\n  if (user1.hometownCountry && user2.hometownCountry) {\n    totalChecks++;\n    if (user1.hometownCountry !== user2.hometownCountry) diversityPoints += 1;\n  }\n  \n  if (totalChecks === 0) return 50;\n  \n  // è½¬æ¢ä¸º0-100åˆ†æ•°ï¼ˆå¤šæ ·æ€§è¶Šé«˜ï¼Œåˆ†æ•°è¶Šé«˜ï¼‰\n  const diversityRatio = diversityPoints / totalChecks;\n  return Math.round(diversityRatio * 100);\n}\n\n/**\n * è®¡ç®—ä¸¤ä¸ªç”¨æˆ·ä¹‹é—´çš„æ–‡åŒ–è¯­è¨€åˆ†æ•°\n */\nfunction calculateCultureScore(user1: Partial<User>, user2: Partial<User>): number {\n  const lang1 = user1.languagesComfort || [];\n  const lang2 = user2.languagesComfort || [];\n  \n  if (lang1.length === 0 || lang2.length === 0) return 50;\n  \n  // è®¡ç®—å…±åŒè¯­è¨€\n  const commonLanguages = lang1.filter(l => lang2.includes(l));\n  \n  if (commonLanguages.length === 0) {\n    return 20; // æ²¡æœ‰å…±åŒè¯­è¨€ï¼Œä½åˆ†\n  } else if (commonLanguages.length >= 2) {\n    return 95; // å¤šä¸ªå…±åŒè¯­è¨€ï¼Œé«˜åˆ†\n  } else {\n    return 75; // ä¸€ä¸ªå…±åŒè¯­è¨€ï¼Œè‰¯å¥½\n  }\n}\n\n/**\n * è®¡ç®—ä¸¤ä¸ªç”¨æˆ·ä¹‹é—´çš„ç»¼åˆåŒ¹é…åˆ†æ•°\n */\nexport function calculateUserMatchScore(\n  user1: Partial<User>,\n  user2: Partial<User>,\n  weights: MatchingWeights = DEFAULT_WEIGHTS\n): UserMatchScore {\n  const personalityScore = calculatePersonalityScore(user1, user2);\n  const interestsScore = calculateInterestsScore(user1, user2);\n  const intentScore = calculateIntentScore(user1, user2);\n  const backgroundScore = calculateBackgroundScore(user1, user2);\n  const cultureScore = calculateCultureScore(user1, user2);\n  \n  // è®¡ç®—åŠ æƒæ€»åˆ†\n  const overallScore = Math.round(\n    (personalityScore * weights.personalityWeight +\n     interestsScore * weights.interestsWeight +\n     intentScore * weights.intentWeight +\n     backgroundScore * weights.backgroundWeight +\n     cultureScore * weights.cultureWeight) / 100\n  );\n  \n  // ç”ŸæˆåŒ¹é…ç‚¹\n  const matchPoints: string[] = [];\n  \n  if (personalityScore >= 80) {\n    matchPoints.push(`æ€§æ ¼é«˜åº¦äº’è¡¥ (${personalityScore}åˆ†)`);\n  }\n  if (interestsScore >= 70) {\n    const common = (user1.interestsTop || []).filter(i => \n      (user2.interestsTop || []).includes(i)\n    );\n    if (common.length > 0) {\n      matchPoints.push(`å…±åŒå…´è¶£ï¼š${common.slice(0, 2).join('ã€')}`);\n    }\n  }\n  if (intentScore >= 75) {\n    matchPoints.push('æ´»åŠ¨æ„å›¾ä¸€è‡´');\n  }\n  if (backgroundScore >= 70) {\n    matchPoints.push('èƒŒæ™¯å¤šå…ƒåŒ–');\n  }\n  if (cultureScore >= 80) {\n    matchPoints.push('è¯­è¨€æ–‡åŒ–ç›¸é€š');\n  }\n  \n  return {\n    userId: user2.id || '',\n    overallScore,\n    personalityScore,\n    interestsScore,\n    intentScore,\n    backgroundScore,\n    cultureScore,\n    chemistryScore: personalityScore, // åŒ–å­¦ååº”åˆ†æ•°å³æ€§æ ¼åˆ†æ•°\n    matchPoints,\n  };\n}\n\n/**\n * ä¸ºä¸€ç»„ç”¨æˆ·è¿›è¡ŒåŒ¹é…å¹¶åˆ†ç»„\n * ä½¿ç”¨è´ªå¿ƒç®—æ³•å°†ç”¨æˆ·åˆ†é…åˆ°æœ€ä½³å°ç»„\n */\nexport function matchUsersToGroups(\n  users: Partial<User>[],\n  config: {\n    minGroupSize?: number;\n    maxGroupSize?: number;\n    preferredGroupSize?: number;\n    weights?: MatchingWeights;\n  } = {}\n): GroupMatch[] {\n  const {\n    minGroupSize = 5,\n    maxGroupSize = 10,\n    preferredGroupSize = 7,\n    weights = DEFAULT_WEIGHTS,\n  } = config;\n  \n  if (users.length < minGroupSize) {\n    throw new Error(`ç”¨æˆ·æ•°é‡ä¸è¶³ï¼Œè‡³å°‘éœ€è¦${minGroupSize}äºº`);\n  }\n  \n  const groups: GroupMatch[] = [];\n  const assignedUsers = new Set<string>();\n  const remainingUsers = [...users];\n  \n  let groupCounter = 1;\n  \n  while (remainingUsers.length >= minGroupSize) {\n    // åˆ›å»ºæ–°ç»„\n    const group: Partial<User>[] = [];\n    \n    // é€‰æ‹©ç¬¬ä¸€ä¸ªæœªåˆ†é…çš„ç”¨æˆ·ä½œä¸ºç§å­\n    const seedUser = remainingUsers.find(u => !assignedUsers.has(u.id || ''));\n    if (!seedUser) break;\n    \n    group.push(seedUser);\n    assignedUsers.add(seedUser.id || '');\n    \n    // è´ªå¿ƒé€‰æ‹©ï¼šä¸ºå½“å‰ç»„æ·»åŠ ä¸ç°æœ‰æˆå‘˜æœ€åŒ¹é…çš„ç”¨æˆ·\n    while (group.length < preferredGroupSize && remainingUsers.length > 0) {\n      let bestUser: Partial<User> | null = null;\n      let bestScore = -1;\n      \n      for (const candidate of remainingUsers) {\n        if (assignedUsers.has(candidate.id || '')) continue;\n        \n        // è®¡ç®—å€™é€‰ç”¨æˆ·ä¸å½“å‰ç»„æ‰€æœ‰æˆå‘˜çš„å¹³å‡åŒ¹é…åˆ†æ•°\n        let totalScore = 0;\n        for (const member of group) {\n          const score = calculateUserMatchScore(member, candidate, weights);\n          totalScore += score.overallScore;\n        }\n        const avgScore = totalScore / group.length;\n        \n        if (avgScore > bestScore) {\n          bestScore = avgScore;\n          bestUser = candidate;\n        }\n      }\n      \n      if (bestUser && bestScore > 0) {\n        group.push(bestUser);\n        assignedUsers.add(bestUser.id || '');\n      } else {\n        break; // æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ç”¨æˆ·\n      }\n    }\n    \n    // è®¡ç®—ç»„çš„è¯„åˆ†æŒ‡æ ‡\n    const archetypes = group\n      .map(u => u.primaryRole)\n      .filter(Boolean) as ArchetypeName[];\n    \n    const avgChemistryScore = calculateGroupChemistry(archetypes);\n    \n    // è®¡ç®—å¤šæ ·æ€§åˆ†æ•°ï¼ˆèƒŒæ™¯ã€è¡Œä¸šç­‰çš„å¤šæ ·æ€§ï¼‰\n    const industries = new Set(group.map(u => u.industry).filter(Boolean));\n    const educations = new Set(group.map(u => u.educationLevel).filter(Boolean));\n    const diversityScore = Math.round(\n      ((industries.size / group.length) * 50 +\n       (educations.size / group.length) * 50)\n    );\n    \n    const overallScore = Math.round((avgChemistryScore + diversityScore) / 2);\n    \n    groups.push({\n      groupId: `group-${groupCounter++}`,\n      userIds: group.map(u => u.id || ''),\n      users: group,\n      avgChemistryScore,\n      diversityScore,\n      overallScore,\n      matchExplanation: generateGroupExplanation(group, avgChemistryScore, diversityScore),\n    });\n  }\n  \n  // å¤„ç†å‰©ä½™ç”¨æˆ·ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰\n  const unassignedUsers = users.filter(u => !assignedUsers.has(u.id || ''));\n  \n  if (unassignedUsers.length > 0 && groups.length > 0) {\n    // å°†å‰©ä½™ç”¨æˆ·åˆ†é…åˆ°ç°æœ‰ç»„\n    for (const user of unassignedUsers) {\n      let bestGroup: GroupMatch | null = null;\n      let bestScore = -1;\n      \n      for (const group of groups) {\n        if (group.users.length >= maxGroupSize) continue;\n        \n        // è®¡ç®—ç”¨æˆ·ä¸è¯¥ç»„çš„å¹³å‡åŒ¹é…åˆ†æ•°\n        let totalScore = 0;\n        for (const member of group.users) {\n          const score = calculateUserMatchScore(member, user, weights);\n          totalScore += score.overallScore;\n        }\n        const avgScore = totalScore / group.users.length;\n        \n        if (avgScore > bestScore) {\n          bestScore = avgScore;\n          bestGroup = group;\n        }\n      }\n      \n      if (bestGroup) {\n        bestGroup.users.push(user);\n        bestGroup.userIds.push(user.id || '');\n        assignedUsers.add(user.id || '');\n      }\n    }\n  }\n  \n  return groups;\n}\n\n/**\n * ç”Ÿæˆå°ç»„åŒ¹é…è§£é‡Šæ–‡æœ¬\n */\nfunction generateGroupExplanation(\n  users: Partial<User>[],\n  chemistryScore: number,\n  diversityScore: number\n): string {\n  const parts: string[] = [];\n  \n  // æ€§æ ¼åŸå‹åˆ†å¸ƒ\n  const archetypes = users.map(u => u.primaryRole).filter(Boolean);\n  const archetypeCount = new Map<string, number>();\n  archetypes.forEach(a => {\n    archetypeCount.set(a!, (archetypeCount.get(a!) || 0) + 1);\n  });\n  \n  const topArchetypes = Array.from(archetypeCount.entries())\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 2)\n    .map(([name]) => name);\n  \n  if (topArchetypes.length > 0) {\n    parts.push(`è¿™ä¸€æ¡Œæ±‡èšäº†${topArchetypes.join('ä¸')}ç­‰å¤šå…ƒæ€§æ ¼`);\n  }\n  \n  // åŒ–å­¦ååº”è¯„ä»·\n  if (chemistryScore >= 80) {\n    parts.push('æ€§æ ¼é«˜åº¦äº’è¡¥ï¼Œå¯¹è¯ç«èŠ±å››æº…');\n  } else if (chemistryScore >= 65) {\n    parts.push('æ€§æ ¼æ­é…å’Œè°ï¼Œäº’åŠ¨è‡ªç„¶æµç•…');\n  }\n  \n  // å¤šæ ·æ€§è¯„ä»·\n  if (diversityScore >= 70) {\n    parts.push('èƒŒæ™¯å¤šå…ƒåŒ–ï¼Œèƒ½å¸¦æ¥ä¸åŒè§†è§’');\n  }\n  \n  // å…´è¶£å…±é¸£\n  const interests = users.flatMap(u => u.interestsTop || []);\n  const interestCount = new Map<string, number>();\n  interests.forEach(i => {\n    interestCount.set(i, (interestCount.get(i) || 0) + 1);\n  });\n  \n  const commonInterests = Array.from(interestCount.entries())\n    .filter(([, count]) => count >= 2)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 2)\n    .map(([name]) => name);\n  \n  if (commonInterests.length > 0) {\n    parts.push(`å…±åŒå–œæ¬¢${commonInterests.join('ã€')}`);\n  }\n  \n  return parts.join('ï¼Œ') + 'ã€‚';\n}\n\n/**\n * éªŒè¯æƒé‡é…ç½®æ˜¯å¦æœ‰æ•ˆ\n */\nexport function validateWeights(weights: MatchingWeights): { \n  valid: boolean; \n  error?: string \n} {\n  const total = \n    weights.personalityWeight +\n    weights.interestsWeight +\n    weights.intentWeight +\n    weights.backgroundWeight +\n    weights.cultureWeight;\n  \n  if (total !== 100) {\n    return {\n      valid: false,\n      error: `æƒé‡æ€»å’Œå¿…é¡»ä¸º100ï¼Œå½“å‰ä¸º${total}`,\n    };\n  }\n  \n  // æ£€æŸ¥æ¯ä¸ªæƒé‡æ˜¯å¦åœ¨0-100èŒƒå›´å†…\n  const values = Object.values(weights);\n  if (values.some(v => v < 0 || v > 100)) {\n    return {\n      valid: false,\n      error: 'æ¯ä¸ªæƒé‡å¿…é¡»åœ¨0-100ä¹‹é—´',\n    };\n  }\n  \n  return { valid: true };\n}\n","size_bytes":13325},"server/archetypeChemistry.ts":{"content":"/**\n * 12ç§ç¤¾äº¤æ°›å›´åŸå‹åŒ–å­¦ååº”çŸ©é˜µ\n * å®šä¹‰æ¯å¯¹åŸå‹ä¹‹é—´çš„å…¼å®¹æ€§è¯„åˆ† (0-100)\n * \n * è¯„åˆ†æ ‡å‡†ï¼š\n * 90-100: å®Œç¾äº’è¡¥ï¼Œç«èŠ±å››æº…\n * 75-89: é«˜åº¦å…¼å®¹ï¼Œäº’ç›¸æ¿€å‘\n * 60-74: è‰¯å¥½äº’åŠ¨ï¼Œç¨³å®šæ„‰å¿«\n * 45-59: ä¸­ç­‰å…¼å®¹ï¼Œéœ€è¦ç£¨åˆ\n * 30-44: è¾ƒä½å…¼å®¹ï¼Œå¯èƒ½å†²çª\n * 0-29: ä¸å»ºè®®é…å¯¹ï¼Œé«˜å†²çªé£é™©\n */\n\nexport type ArchetypeName = \n  | \"å¼€å¿ƒæŸ¯åŸº\" | \"å¤ªé˜³é¸¡\" | \"å¤¸å¤¸è±š\" | \"æœºæ™ºç‹\"     // é«˜èƒ½é‡åŒº\n  | \"æ·¡å®šæµ·è±š\" | \"ç»‡ç½‘è››\" | \"æš–å¿ƒç†Š\" | \"çµæ„Ÿç« é±¼\"   // ä¸­èƒ½é‡åŒº\n  | \"æ²‰æ€çŒ«å¤´é¹°\" | \"å®šå¿ƒå¤§è±¡\"                     // ä½èƒ½é‡åŒº\n  | \"ç¨³å¦‚é¾Ÿ\" | \"éšèº«çŒ«\";                         // è¶…ä½èƒ½é‡åŒº\n\n// ç¤¾äº¤èƒ½é‡å€¼æ˜ å°„ (0-100)\nexport const ARCHETYPE_ENERGY: Record<ArchetypeName, number> = {\n  \"å¼€å¿ƒæŸ¯åŸº\": 95,    // æ‘‡å°¾ç‚¹ç«å®˜ - å›¢é˜Ÿæ°¸åŠ¨æœº\n  \"å¤ªé˜³é¸¡\": 90,      // å’¯å’¯å°å¤ªé˜³ - äººé—´å°æš–æ°”\n  \"å¤¸å¤¸è±š\": 85,      // æŒå£°å‘åŠ¨æœº - é¦–å¸­é¼“æŒå®˜\n  \"æœºæ™ºç‹\": 82,      // å··å£å¯†æ¢ - åŸå¸‚æ¢é™©å®¶\n  \"æ·¡å®šæµ·è±š\": 75,    // æ°”æ°›å†²æµªæ‰‹ - æ°”æ°›è°ƒé¢‘æ‰‹\n  \"ç»‡ç½‘è››\": 72,      // å…³ç³»ç»‡ç½‘å¸ˆ - ç¤¾äº¤é»åˆå‰‚\n  \"æš–å¿ƒç†Š\": 70,      // æ€€æŠ±æ•…äº‹ç†Š - æ•…äº‹æ”¶è—å®¶\n  \"çµæ„Ÿç« é±¼\": 68,    // è„‘æ´å–·å¢¨ç«  - åˆ›æ„å–·å°„å™¨\n  \"æ²‰æ€çŒ«å¤´é¹°\": 55,  // æ¨é•œæ€è€ƒå®˜ - å“²å­¦å¸¦å¸ˆ\n  \"å®šå¿ƒå¤§è±¡\": 52,    // è±¡é¼»å®šå¿ƒé”š - å›¢é˜Ÿå®šç›˜æ˜Ÿ\n  \"ç¨³å¦‚é¾Ÿ\": 38,      // æ…¢è¯­çœŸçŸ¥é¾Ÿ - äººé—´è§‚å¯Ÿå®¶\n  \"éšèº«çŒ«\": 30,      // å®‰é™ä¼´ä¼´çŒ« - å®‰é™é™ªä¼´è€…\n};\n\n// åŒ–å­¦ååº”çŸ©é˜µï¼šæ¯å¯¹åŸå‹çš„å…¼å®¹æ€§è¯„åˆ†\nexport const chemistryMatrix: Record<ArchetypeName, Record<ArchetypeName, number>> = {\n  \"å¼€å¿ƒæŸ¯åŸº\": {\n    \"å¼€å¿ƒæŸ¯åŸº\": 70,   // åŒæŸ¯åŸºèƒ½é‡çˆ†æ£šï¼Œä½†å¯èƒ½ç«äº‰ä¸»å¯¼\n    \"å¤ªé˜³é¸¡\": 88,     // ç ´å†°+æ¸©æš–=å®Œç¾æ°›å›´åŸºç¡€\n    \"å¤¸å¤¸è±š\": 90,     // ç‚¹ç«+é¼“æŒ=åŒå‘æ­£èƒ½é‡å¾ªç¯\n    \"æœºæ™ºç‹\": 85,     // ç ´å†°+æ–°é²œ=æƒŠå–œè¿è¿\n    \"æ·¡å®šæµ·è±š\": 82,   // çƒ­æƒ…è¢«æµ·è±šå¹³è¡¡ï¼ŒèŠ‚å¥èˆ’é€‚\n    \"ç»‡ç½‘è››\": 83,     // ç ´å†°åèœ˜è››è¿æ¥æ·±åŒ–å…³ç³»\n    \"æš–å¿ƒç†Š\": 92,     // ç ´å†°â†’èµ°å¿ƒï¼Œå®Œç¾çš„\"çƒ­åœºâ†’æ·±åº¦\"\n    \"çµæ„Ÿç« é±¼\": 86,   // æ´»åŠ›+åˆ›æ„=è„‘æ´å¤§å¼€\n    \"æ²‰æ€çŒ«å¤´é¹°\": 75, // èƒ½é‡å·®é€‚ä¸­ï¼ŒæŸ¯åŸºå¸¦åŠ¨çŒ«é¹°æ€è€ƒ\n    \"å®šå¿ƒå¤§è±¡\": 78,   // æŸ¯åŸºæ´»è·ƒï¼Œå¤§è±¡ç¨³å®šåæ–¹\n    \"ç¨³å¦‚é¾Ÿ\": 68,     // èƒ½é‡å·®è¾ƒå¤§ï¼Œä½†é¾Ÿèƒ½æä¾›æ·±åº¦\n    \"éšèº«çŒ«\": 65,     // èƒ½é‡å·®è¿‡å¤§ï¼Œå¯èƒ½è®©éšèº«çŒ«æœ‰å‹åŠ›\n  },\n  \n  \"å¤ªé˜³é¸¡\": {\n    \"å¼€å¿ƒæŸ¯åŸº\": 88,\n    \"å¤ªé˜³é¸¡\": 75,     // åŒå¤ªé˜³æ¸©æš–ä½†å¯èƒ½ç¼ºä¹å˜åŒ–\n    \"å¤¸å¤¸è±š\": 85,     // æ¸©æš–+é¼“åŠ±=è¶…çº§æ­£èƒ½é‡åœº\n    \"æœºæ™ºç‹\": 80,     // ç¨³å®šæ¸©æš–ç»™æ¢ç´¢æä¾›å®‰å…¨åŸºåœ°\n    \"æ·¡å®šæµ·è±š\": 88,   // æ¸©æš–+å¹³è¡¡=å’Œè°åŸºè°ƒ\n    \"ç»‡ç½‘è››\": 82,     // æ¸©æš–æ°›å›´åŠ©åŠ›èœ˜è››ç»‡ç½‘\n    \"æš–å¿ƒç†Š\": 87,     // åŒé‡æ¸©æš–ï¼Œæƒ…æ„Ÿè¿æ¥æ·±åš\n    \"çµæ„Ÿç« é±¼\": 83,   // æ¸©æš–åŒ…å®¹ç« é±¼çš„å¥‡æ€å¦™æƒ³\n    \"æ²‰æ€çŒ«å¤´é¹°\": 72, // æ¸©æš–èåŒ–çŒ«é¹°çš„ä¸¥è‚ƒ\n    \"å®šå¿ƒå¤§è±¡\": 85,   // æ¸©æš–+ç¨³å®š=è¶…çº§å®‰å…¨æ„Ÿ\n    \"ç¨³å¦‚é¾Ÿ\": 70,     // æ¸©æš–é¼“åŠ±é¾Ÿå¼€å£\n    \"éšèº«çŒ«\": 68,     // æ¸©æš–ä¸æ–½å‹ï¼Œç»™çŒ«èˆ’é€‚ç©ºé—´\n  },\n  \n  \"å¤¸å¤¸è±š\": {\n    \"å¼€å¿ƒæŸ¯åŸº\": 90,\n    \"å¤ªé˜³é¸¡\": 85,\n    \"å¤¸å¤¸è±š\": 70,     // åŒå¤¸å¤¸å¯èƒ½è¿‡äºçƒ­æƒ…ç¼ºä¹æ·±åº¦\n    \"æœºæ™ºç‹\": 82,     // é¼“åŠ±æ¢ç´¢å‘ç°ï¼Œæ¿€åŠ±åˆ›æ–°\n    \"æ·¡å®šæµ·è±š\": 80,   // çƒ­æƒ…è¢«æµ·è±šè°ƒèŠ‚ï¼Œé¿å…è¿‡åº¦\n    \"ç»‡ç½‘è››\": 85,     // é¼“åŠ±è¿æ¥è€…å¤§èƒ†ç»‡ç½‘\n    \"æš–å¿ƒç†Š\": 88,     // é¼“åŠ±+å€¾å¬=å®Œç¾æ”¯æŒç³»ç»Ÿ\n    \"çµæ„Ÿç« é±¼\": 84,   // é¼“åŠ±è„‘æ´ï¼Œæ¿€å‘æ›´å¤šåˆ›æ„\n    \"æ²‰æ€çŒ«å¤´é¹°\": 73, // é¼“åŠ±æ€è€ƒè€…è¡¨è¾¾è§è§£\n    \"å®šå¿ƒå¤§è±¡\": 80,   // é¼“åŠ±+ç¨³å®š=å®‰å¿ƒæˆé•¿\n    \"ç¨³å¦‚é¾Ÿ\": 69,     // é¼“åŠ±ä½é¢‘å‘è¨€è€…å¼€å£\n    \"éšèº«çŒ«\": 66,     // çƒ­æƒ…å¯èƒ½è®©éšèº«çŒ«ä¸é€‚\n  },\n  \n  \"æœºæ™ºç‹\": {\n    \"å¼€å¿ƒæŸ¯åŸº\": 85,\n    \"å¤ªé˜³é¸¡\": 80,\n    \"å¤¸å¤¸è±š\": 82,\n    \"æœºæ™ºç‹\": 72,     // åŒç‹æ¢ç´¢æ¬²å¼ºä½†å¯èƒ½åˆ†æ•£\n    \"æ·¡å®šæµ·è±š\": 83,   // æ¢ç´¢è¢«æµ·è±šå¼•å¯¼ï¼Œä¸å¤±ç„¦\n    \"ç»‡ç½‘è››\": 90,     // å‘ç°+è¿æ¥=ç¤¾äº¤æ‰©å¼ ç»„åˆ\n    \"æš–å¿ƒç†Š\": 84,     // æ–°é²œå‘ç°+æ•…äº‹è®²è¿°=ç²¾å½©\n    \"çµæ„Ÿç« é±¼\": 92,   // æ–°å¥‡ä½“éªŒ+åˆ›æ„è„‘æ´=æ¢ç´¢ç»é…\n    \"æ²‰æ€çŒ«å¤´é¹°\": 78, // å¥½å¥‡å¿ƒ+æ·±åº¦æ€è€ƒ=çŸ¥è¯†ç¢°æ’\n    \"å®šå¿ƒå¤§è±¡\": 75,   // æ¢ç´¢æœ‰ç¨³å®šåç›¾ï¼Œå®‰å¿ƒå†’é™©\n    \"ç¨³å¦‚é¾Ÿ\": 72,     // æ¢ç´¢+æ´å¯Ÿ=å‘ç°æ–°è§†è§’\n    \"éšèº«çŒ«\": 60,     // æ¢ç´¢æ¬²vsç¤¾æï¼ŒèŠ‚å¥ä¸åŒ¹é…\n  },\n  \n  \"æ·¡å®šæµ·è±š\": {\n    \"å¼€å¿ƒæŸ¯åŸº\": 82,\n    \"å¤ªé˜³é¸¡\": 88,\n    \"å¤¸å¤¸è±š\": 80,\n    \"æœºæ™ºç‹\": 83,\n    \"æ·¡å®šæµ·è±š\": 75,   // åŒæµ·è±šå¹³è¡¡ä½†å¯èƒ½ç¼ºä¹é©±åŠ¨åŠ›\n    \"ç»‡ç½‘è››\": 88,     // è°ƒèŠ‚+è¿æ¥=ç¤¾äº¤åè°ƒå¤§å¸ˆ\n    \"æš–å¿ƒç†Š\": 85,     // å¹³è¡¡+å€¾å¬=æƒ…æ„Ÿæ™ºæ…§ç»„åˆ\n    \"çµæ„Ÿç« é±¼\": 81,   // å¹³è¡¡ç« é±¼çš„å‘æ•£æ€ç»´\n    \"æ²‰æ€çŒ«å¤´é¹°\": 80, // è°ƒèŠ‚æ€è€ƒèŠ‚å¥ï¼Œé¿å…è¿‡äºä¸¥è‚ƒ\n    \"å®šå¿ƒå¤§è±¡\": 90,   // è°ƒé¢‘+å®šå¿ƒ=å›¢é˜Ÿå‹èˆ±çŸ³\n    \"ç¨³å¦‚é¾Ÿ\": 77,     // å¹³è¡¡ä½é¢‘é«˜è´¨çš„èŠ‚å¥\n    \"éšèº«çŒ«\": 73,     // ä¸æ–½å‹çš„é™ªä¼´ï¼Œèˆ’é€‚å…±å¤„\n  },\n  \n  \"ç»‡ç½‘è››\": {\n    \"å¼€å¿ƒæŸ¯åŸº\": 83,\n    \"å¤ªé˜³é¸¡\": 82,\n    \"å¤¸å¤¸è±š\": 85,\n    \"æœºæ™ºç‹\": 90,\n    \"æ·¡å®šæµ·è±š\": 88,\n    \"ç»‡ç½‘è››\": 78,     // åŒèœ˜è››è¿æ¥ä½†å¯èƒ½è¿‡äºnetworking\n    \"æš–å¿ƒç†Š\": 86,     // è¿æ¥+æƒ…æ„Ÿ=æ·±åº¦å…³ç³»å»ºç«‹\n    \"çµæ„Ÿç« é±¼\": 87,   // è¿æ¥+åˆ›æ„=ç½‘ç»œèŠ‚ç‚¹åˆ›æ–°\n    \"æ²‰æ€çŒ«å¤´é¹°\": 82, // è¿æ¥æ€æƒ³è€…ï¼Œä¿ƒè¿›æ·±åº¦äº¤æµ\n    \"å®šå¿ƒå¤§è±¡\": 84,   // è¿æ¥+ç¨³å®š=å¯é ç¤¾äº¤ç½‘ç»œ\n    \"ç¨³å¦‚é¾Ÿ\": 76,     // è¿æ¥ä½è°ƒè§‚å¯Ÿè€…ï¼Œå¼•å‡ºæ´å¯Ÿ\n    \"éšèº«çŒ«\": 71,     // è½»åº¦è¿æ¥ï¼Œä¸å¼ºæ±‚ç¤¾æå‚ä¸\n  },\n  \n  \"æš–å¿ƒç†Š\": {\n    \"å¼€å¿ƒæŸ¯åŸº\": 92,\n    \"å¤ªé˜³é¸¡\": 87,\n    \"å¤¸å¤¸è±š\": 88,\n    \"æœºæ™ºç‹\": 84,\n    \"æ·¡å®šæµ·è±š\": 85,\n    \"ç»‡ç½‘è››\": 86,\n    \"æš–å¿ƒç†Š\": 80,     // åŒç†Šæ¸©æš–ä½†å¯èƒ½ç¼ºä¹æ–¹å‘\n    \"çµæ„Ÿç« é±¼\": 82,   // å€¾å¬+åˆ›æ„=è„‘æ´è¢«ç†è§£\n    \"æ²‰æ€çŒ«å¤´é¹°\": 88, // æƒ…æ„Ÿå…±é¸£+æ·±åº¦æ€è€ƒ=å¿ƒçµå¯¹è¯\n    \"å®šå¿ƒå¤§è±¡\": 87,   // å€¾å¬+ç¨³å®š=è¶…çº§æ”¯æŒç³»ç»Ÿ\n    \"ç¨³å¦‚é¾Ÿ\": 85,     // å€¾å¬é¼“åŠ±é¾Ÿåˆ†äº«æ´å¯Ÿ\n    \"éšèº«çŒ«\": 79,     // æ¸©æš–å€¾å¬ï¼Œç»™çŒ«å®‰å…¨ç©ºé—´\n  },\n  \n  \"çµæ„Ÿç« é±¼\": {\n    \"å¼€å¿ƒæŸ¯åŸº\": 86,\n    \"å¤ªé˜³é¸¡\": 83,\n    \"å¤¸å¤¸è±š\": 84,\n    \"æœºæ™ºç‹\": 92,\n    \"æ·¡å®šæµ·è±š\": 81,\n    \"ç»‡ç½‘è››\": 87,\n    \"æš–å¿ƒç†Š\": 82,\n    \"çµæ„Ÿç« é±¼\": 73,   // åŒç« é±¼åˆ›æ„ä½†å¯èƒ½è¿‡äºå‘æ•£\n    \"æ²‰æ€çŒ«å¤´é¹°\": 84, // åˆ›æ„+æ€è€ƒ=å“²å­¦è„‘æš´\n    \"å®šå¿ƒå¤§è±¡\": 78,   // åˆ›æ„æœ‰ç¨³å®šæ¡†æ¶ï¼Œè½åœ°æ€§å¼º\n    \"ç¨³å¦‚é¾Ÿ\": 80,     // åˆ›æ„+æ´å¯Ÿ=æ·±åº¦åˆ›æ–°\n    \"éšèº«çŒ«\": 68,     // ç« é±¼å¤šçº¿ç¨‹å¯èƒ½è®©çŒ«ç–²æƒ«\n  },\n  \n  \"æ²‰æ€çŒ«å¤´é¹°\": {\n    \"å¼€å¿ƒæŸ¯åŸº\": 75,\n    \"å¤ªé˜³é¸¡\": 72,\n    \"å¤¸å¤¸è±š\": 73,\n    \"æœºæ™ºç‹\": 78,\n    \"æ·¡å®šæµ·è±š\": 80,\n    \"ç»‡ç½‘è››\": 82,\n    \"æš–å¿ƒç†Š\": 88,\n    \"çµæ„Ÿç« é±¼\": 84,\n    \"æ²‰æ€çŒ«å¤´é¹°\": 77, // åŒçŒ«é¹°æ·±åº¦ä½†å¯èƒ½è¿‡äºä¸¥è‚ƒ\n    \"å®šå¿ƒå¤§è±¡\": 85,   // æ€è€ƒ+ç¨³å®š=å“²å­¦å®‰å…¨åŸºåœ°\n    \"ç¨³å¦‚é¾Ÿ\": 92,     // æ·±åº¦æ€è€ƒåŒäººç»„ï¼Œå“²å­¦å¯¹è¯å·…å³°\n    \"éšèº«çŒ«\": 82,     // ä½å‹æ·±åº¦å¯¹è¯ï¼Œç¤¾æå‹å¥½\n  },\n  \n  \"å®šå¿ƒå¤§è±¡\": {\n    \"å¼€å¿ƒæŸ¯åŸº\": 78,\n    \"å¤ªé˜³é¸¡\": 85,\n    \"å¤¸å¤¸è±š\": 80,\n    \"æœºæ™ºç‹\": 75,\n    \"æ·¡å®šæµ·è±š\": 90,\n    \"ç»‡ç½‘è››\": 84,\n    \"æš–å¿ƒç†Š\": 87,\n    \"çµæ„Ÿç« é±¼\": 78,\n    \"æ²‰æ€çŒ«å¤´é¹°\": 85,\n    \"å®šå¿ƒå¤§è±¡\": 80,   // åŒè±¡ç¨³å®šä½†å¯èƒ½ç¼ºä¹æ´»åŠ›\n    \"ç¨³å¦‚é¾Ÿ\": 88,     // ç¨³å®š+æ´å¯Ÿ=å¯é æ™ºæ…§\n    \"éšèº«çŒ«\": 85,     // ç¨³å®šåç›¾ï¼Œç»™çŒ«ç»å¯¹å®‰å…¨æ„Ÿ\n  },\n  \n  \"ç¨³å¦‚é¾Ÿ\": {\n    \"å¼€å¿ƒæŸ¯åŸº\": 68,\n    \"å¤ªé˜³é¸¡\": 70,\n    \"å¤¸å¤¸è±š\": 69,\n    \"æœºæ™ºç‹\": 72,\n    \"æ·¡å®šæµ·è±š\": 77,\n    \"ç»‡ç½‘è››\": 76,\n    \"æš–å¿ƒç†Š\": 85,\n    \"çµæ„Ÿç« é±¼\": 80,\n    \"æ²‰æ€çŒ«å¤´é¹°\": 92,\n    \"å®šå¿ƒå¤§è±¡\": 88,\n    \"ç¨³å¦‚é¾Ÿ\": 75,     // åŒé¾Ÿæ·±åº¦ä½†å¯èƒ½è¿‡äºå®‰é™\n    \"éšèº«çŒ«\": 90,     // ä½é¢‘é«˜è´¨+å®‰é™é™ªä¼´=ç¤¾æå¤©å ‚\n  },\n  \n  \"éšèº«çŒ«\": {\n    \"å¼€å¿ƒæŸ¯åŸº\": 65,\n    \"å¤ªé˜³é¸¡\": 68,\n    \"å¤¸å¤¸è±š\": 66,\n    \"æœºæ™ºç‹\": 60,\n    \"æ·¡å®šæµ·è±š\": 73,\n    \"ç»‡ç½‘è››\": 71,\n    \"æš–å¿ƒç†Š\": 79,\n    \"çµæ„Ÿç« é±¼\": 68,\n    \"æ²‰æ€çŒ«å¤´é¹°\": 82,\n    \"å®šå¿ƒå¤§è±¡\": 85,\n    \"ç¨³å¦‚é¾Ÿ\": 90,\n    \"éšèº«çŒ«\": 70,     // åŒçŒ«å®‰é™ä½†å¯èƒ½ç¼ºä¹äº’åŠ¨\n  },\n};\n\n/**\n * åŸå‹æ ¸å¿ƒç‰¹è´¨æè¿°\n */\nexport const ARCHETYPE_DESCRIPTIONS: Record<ArchetypeName, {\n  nickname: string;\n  emoji: string;\n  coreContribution: string;\n  keyTraits: string[];\n}> = {\n  \"å¼€å¿ƒæŸ¯åŸº\": {\n    nickname: \"æ‘‡å°¾ç‚¹ç«å®˜\",\n    emoji: \"ğŸ¶\",\n    coreContribution: \"ç ´å†°å¯åŠ¨ï¼Œåˆ›é€ æ¬¢ä¹æ°›å›´\",\n    keyTraits: [\"èƒ½é‡å……æ²›\", \"å¹½é»˜æ„Ÿå¼º\", \"å–„äºè°ƒåŠ¨æ°”æ°›\"],\n  },\n  \"å¤ªé˜³é¸¡\": {\n    nickname: \"å’¯å’¯å°å¤ªé˜³\",\n    emoji: \"ğŸ”\",\n    coreContribution: \"æ•£å‘æ¸©æš–èƒ½é‡ï¼Œæå‡æ•´ä½“å¹¸ç¦æ„Ÿ\",\n    keyTraits: [\"ä¹è§‚å¼€æœ—\", \"æ„ŸæŸ“åŠ›å¼º\", \"æƒ…ç»ªç¨³å®š\"],\n  },\n  \"å¤¸å¤¸è±š\": {\n    nickname: \"æŒå£°å‘åŠ¨æœº\",\n    emoji: \"ğŸ¹\",\n    coreContribution: \"æä¾›ç§¯æåé¦ˆï¼Œå¢å¼ºå›¢é˜Ÿä¿¡å¿ƒ\",\n    keyTraits: [\"é¼“åŠ±æ€§å¼º\", \"ååº”çƒ­æƒ…\", \"æ­£èƒ½é‡æ»¡æ»¡\"],\n  },\n  \"æœºæ™ºç‹\": {\n    nickname: \"å··å£å¯†æ¢\",\n    emoji: \"ğŸ¦Š\",\n    coreContribution: \"å¼•å…¥æ–°é²œä½“éªŒï¼Œæ‹“å±•æ´»åŠ¨è¾¹ç•Œ\",\n    keyTraits: [\"å¥½å¥‡å¿ƒå¼º\", \"ä¿¡æ¯çµé€š\", \"å‹‡äºå°è¯•\"],\n  },\n  \"æ·¡å®šæµ·è±š\": {\n    nickname: \"æ°”æ°›å†²æµªæ‰‹\",\n    emoji: \"ğŸ¬\",\n    coreContribution: \"å¹³è¡¡ç¾¤ä½“æ°›å›´ï¼ŒåŒ–è§£æ½œåœ¨å†²çª\",\n    keyTraits: [\"æƒ…å•†é«˜\", \"åº”å˜åŠ›å¼º\", \"åŒ…å®¹æ€§å¥½\"],\n  },\n  \"ç»‡ç½‘è››\": {\n    nickname: \"å…³ç³»ç»‡ç½‘å¸ˆ\",\n    emoji: \"ğŸ•·ï¸\",\n    coreContribution: \"è¿æ¥ä¸åŒäººç¾¤ï¼Œæ„å»ºç¤¾äº¤ç½‘ç»œ\",\n    keyTraits: [\"è§‚å¯Ÿæ•é”\", \"å–„äºå‘ç°å…±åŒç‚¹\", \"äººè„‰å¹¿æ³›\"],\n  },\n  \"æš–å¿ƒç†Š\": {\n    nickname: \"æ€€æŠ±æ•…äº‹ç†Š\",\n    emoji: \"ğŸ¨\",\n    coreContribution: \"å»ºç«‹æƒ…æ„Ÿè¿æ¥ï¼Œè¥é€ æ·±åº¦äº¤æµ\",\n    keyTraits: [\"å–„äºå€¾å¬\", \"å…±æƒ…åŠ›å¼º\", \"æ•…äº‹åŠ›ä¸°å¯Œ\"],\n  },\n  \"çµæ„Ÿç« é±¼\": {\n    nickname: \"è„‘æ´å–·å¢¨ç« \",\n    emoji: \"ğŸ™\",\n    coreContribution: \"å¤šçº¿ç¨‹å‘æ•£æ€ç»´ï¼Œæ¿€å‘é›†ä½“è„‘æš´\",\n    keyTraits: [\"æ€ç»´è·³è·ƒ\", \"è”æƒ³ä¸°å¯Œ\", \"åˆ›æ„æ— ç©·\"],\n  },\n  \"æ²‰æ€çŒ«å¤´é¹°\": {\n    nickname: \"æ¨é•œæ€è€ƒå®˜\",\n    emoji: \"ğŸ¦‰\",\n    coreContribution: \"æå‡å¯¹è¯è´¨é‡ï¼Œæ¿€å‘æ·±åº¦æ€è€ƒ\",\n    keyTraits: [\"é€»è¾‘æ€§å¼º\", \"å–„äºæé—®\", \"è¿½æ±‚çœŸç†\"],\n  },\n  \"å®šå¿ƒå¤§è±¡\": {\n    nickname: \"è±¡é¼»å®šå¿ƒé”š\",\n    emoji: \"ğŸ˜\",\n    coreContribution: \"æä¾›ç¨³å®šæ”¯æŒï¼Œå¥ å®šå®‰å¿ƒåŸºè°ƒ\",\n    keyTraits: [\"ç¨³é‡å¯é \", \"åŒ…å®¹è±è¾¾\", \"ç»™äººå®‰å…¨æ„Ÿ\"],\n  },\n  \"ç¨³å¦‚é¾Ÿ\": {\n    nickname: \"æ…¢è¯­çœŸçŸ¥é¾Ÿ\",\n    emoji: \"ğŸ¢\",\n    coreContribution: \"æä¾›æ·±åº¦æ´å¯Ÿï¼Œè´¡çŒ®ç‹¬åˆ°è§è§£\",\n    keyTraits: [\"æ€è€ƒæ·±å…¥\", \"è¨€ç®€æ„èµ…\", \"æ´å¯ŸåŠ›å¼º\"],\n  },\n  \"éšèº«çŒ«\": {\n    nickname: \"å®‰é™ä¼´ä¼´çŒ«\",\n    emoji: \"ğŸ±\",\n    coreContribution: \"æä¾›å®‰é™é™ªä¼´ï¼Œè¥é€ è½»æ¾æ°›å›´\",\n    keyTraits: [\"å­˜åœ¨æ„Ÿä½\", \"ä¸æ–½åŠ å‹åŠ›\", \"äº«å—æ—è§‚\"],\n  },\n};\n\n/**\n * è·å–ä¸¤ä¸ªåŸå‹ä¹‹é—´çš„åŒ–å­¦ååº”åˆ†æ•°\n */\nexport function getChemistryScore(archetype1: ArchetypeName, archetype2: ArchetypeName): number {\n  return chemistryMatrix[archetype1]?.[archetype2] ?? 50; // é»˜è®¤ä¸­ç­‰å…¼å®¹\n}\n\n/**\n * è·å–åŒ–å­¦ååº”ç­‰çº§æè¿°\n */\nexport function getChemistryLevel(score: number): {\n  level: string;\n  description: string;\n  color: string;\n} {\n  if (score >= 90) {\n    return {\n      level: \"å®Œç¾äº’è¡¥\",\n      description: \"ç«èŠ±å››æº…ï¼Œæ€ç»´ç¢°æ’æ¿€çƒˆ\",\n      color: \"text-purple-600 dark:text-purple-400\"\n    };\n  } else if (score >= 75) {\n    return {\n      level: \"é«˜åº¦å…¼å®¹\",\n      description: \"äº’ç›¸æ¿€å‘ï¼Œå¯¹è¯æµç•…\",\n      color: \"text-green-600 dark:text-green-400\"\n    };\n  } else if (score >= 60) {\n    return {\n      level: \"è‰¯å¥½äº’åŠ¨\",\n      description: \"ç¨³å®šæ„‰å¿«ï¼Œæ°›å›´å’Œè°\",\n      color: \"text-blue-600 dark:text-blue-400\"\n    };\n  } else if (score >= 45) {\n    return {\n      level: \"ä¸­ç­‰å…¼å®¹\",\n      description: \"éœ€è¦ç£¨åˆï¼Œå¯èƒ½æœ‰å°æ‘©æ“¦\",\n      color: \"text-yellow-600 dark:text-yellow-400\"\n    };\n  } else if (score >= 30) {\n    return {\n      level: \"è¾ƒä½å…¼å®¹\",\n      description: \"å®¹æ˜“å†²çªï¼Œéœ€è¦åè°ƒè€…\",\n      color: \"text-orange-600 dark:text-orange-400\"\n    };\n  } else {\n    return {\n      level: \"ä¸å»ºè®®é…å¯¹\",\n      description: \"é«˜å†²çªé£é™©ï¼Œæ…é‡è€ƒè™‘\",\n      color: \"text-red-600 dark:text-red-400\"\n    };\n  }\n}\n\n/**\n * è®¡ç®—ä¸€ç»„ç”¨æˆ·çš„å¹³å‡åŒ–å­¦ååº”åˆ†æ•°\n */\nexport function calculateGroupChemistry(archetypes: ArchetypeName[]): number {\n  if (archetypes.length < 2) return 0;\n  \n  let totalScore = 0;\n  let pairCount = 0;\n  \n  for (let i = 0; i < archetypes.length; i++) {\n    for (let j = i + 1; j < archetypes.length; j++) {\n      totalScore += getChemistryScore(archetypes[i], archetypes[j]);\n      pairCount++;\n    }\n  }\n  \n  return pairCount > 0 ? Math.round(totalScore / pairCount) : 0;\n}\n\n/**\n * æ¨èæœ€ä½³é…å¯¹åŸå‹\n */\nexport function getBestMatchArchetypes(archetype: ArchetypeName, count: number = 3): ArchetypeName[] {\n  const scores = Object.entries(chemistryMatrix[archetype])\n    .filter(([other]) => other !== archetype)\n    .sort(([, scoreA], [, scoreB]) => scoreB - scoreA)\n    .slice(0, count)\n    .map(([name]) => name as ArchetypeName);\n  \n  return scores;\n}\n\n/**\n * æ¨èåº”é¿å…çš„é…å¯¹åŸå‹\n */\nexport function getWorstMatchArchetypes(archetype: ArchetypeName, count: number = 3): ArchetypeName[] {\n  const scores = Object.entries(chemistryMatrix[archetype])\n    .filter(([other]) => other !== archetype)\n    .sort(([, scoreA], [, scoreB]) => scoreA - scoreB)\n    .slice(0, count)\n    .map(([name]) => name as ArchetypeName);\n  \n  return scores;\n}\n","size_bytes":13790},"client/src/pages/admin/AdminNotificationsPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Bell, Send, Users, CheckCircle, Clock } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\n\ntype User = {\n  id: string;\n  firstName: string;\n  lastName: string;\n  phoneNumber: string;\n  archetype: string | null;\n};\n\ntype NotificationHistory = {\n  id: string;\n  title: string;\n  message: string;\n  category: string;\n  type: string;\n  recipientCount: number;\n  readCount: number;\n  createdAt: string;\n};\n\nexport default function AdminNotificationsPage() {\n  const { toast } = useToast();\n  const [category, setCategory] = useState(\"discover\");\n  const [type, setType] = useState(\"admin_announcement\");\n  const [title, setTitle] = useState(\"\");\n  const [message, setMessage] = useState(\"\");\n  const [selectedUserIds, setSelectedUserIds] = useState<string[]>([]);\n  const [recipientFilter, setRecipientFilter] = useState<\"all\" | \"selected\">(\"all\");\n\n  const { data: usersData, isLoading: usersLoading } = useQuery({\n    queryKey: [\"/api/admin/users\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/users?limit=500\");\n      if (!res.ok) throw new Error(\"Failed to fetch users\");\n      const data = await res.json();\n      return data?.users || [];\n    },\n  });\n\n  const { data: notificationsData, isLoading: notificationsLoading } = useQuery({\n    queryKey: [\"/api/admin/notifications\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/notifications\");\n      if (!res.ok) throw new Error(\"Failed to fetch notifications\");\n      const data = await res.json();\n      return data?.notifications || [];\n    },\n  });\n\n  const sendNotificationMutation = useMutation({\n    mutationFn: async (data: { userIds: string[]; category: string; type: string; title: string; message: string }) => {\n      return apiRequest(\"POST\", \"/api/admin/notifications/broadcast\", data);\n    },\n    onSuccess: (data: any) => {\n      toast({\n        title: \"é€šçŸ¥å‘é€æˆåŠŸ\",\n        description: `æˆåŠŸå‘é€ç»™ ${data.sent} ä½ç”¨æˆ·`,\n      });\n      setTitle(\"\");\n      setMessage(\"\");\n      setSelectedUserIds([]);\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/notifications\"] });\n    },\n    onError: () => {\n      toast({\n        title: \"å‘é€å¤±è´¥\",\n        description: \"æ— æ³•å‘é€é€šçŸ¥ï¼Œè¯·é‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSend = () => {\n    if (!title.trim()) {\n      toast({\n        title: \"è¯·è¾“å…¥æ ‡é¢˜\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    let userIds: string[] = [];\n    if (recipientFilter === \"all\") {\n      userIds = (usersData || []).map((u: User) => u.id);\n    } else {\n      userIds = selectedUserIds;\n    }\n\n    if (userIds.length === 0) {\n      toast({\n        title: \"è¯·é€‰æ‹©æ¥æ”¶ç”¨æˆ·\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    sendNotificationMutation.mutate({ userIds, category, type, title, message });\n  };\n\n  const toggleUserSelection = (userId: string) => {\n    setSelectedUserIds(prev =>\n      prev.includes(userId) ? prev.filter(id => id !== userId) : [...prev, userId]\n    );\n  };\n\n  const toggleAllUsers = () => {\n    if (selectedUserIds.length === (usersData || []).length) {\n      setSelectedUserIds([]);\n    } else {\n      setSelectedUserIds((usersData || []).map((u: User) => u.id));\n    }\n  };\n\n  if (usersLoading || notificationsLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <p className=\"text-muted-foreground\">åŠ è½½ä¸­...</p>\n      </div>\n    );\n  }\n\n  const users = usersData || [];\n  const notifications = notificationsData || [];\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex items-center gap-3\">\n        <Bell className=\"h-8 w-8 text-primary\" />\n        <h1 className=\"text-3xl font-bold\">é€šçŸ¥æ¨é€ç®¡ç†</h1>\n      </div>\n\n      <Tabs defaultValue=\"send\" className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-2\">\n          <TabsTrigger value=\"send\" data-testid=\"tab-send-notification\">å‘é€é€šçŸ¥</TabsTrigger>\n          <TabsTrigger value=\"history\" data-testid=\"tab-notification-history\">å‘é€å†å²</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"send\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle>åˆ›å»ºå¹¶å‘é€é€šçŸ¥</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>é€šçŸ¥åˆ†ç±»</Label>\n                  <Select value={category} onValueChange={setCategory}>\n                    <SelectTrigger data-testid=\"select-category\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"discover\">å‘ç°</SelectItem>\n                      <SelectItem value=\"activities\">æ´»åŠ¨</SelectItem>\n                      <SelectItem value=\"chat\">èŠå¤©</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>é€šçŸ¥ç±»å‹</Label>\n                  <Select value={type} onValueChange={setType}>\n                    <SelectTrigger data-testid=\"select-type\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"admin_announcement\">ç®¡ç†å‘˜å…¬å‘Š</SelectItem>\n                      <SelectItem value=\"new_activity\">æ–°æ´»åŠ¨</SelectItem>\n                      <SelectItem value=\"match_success\">åŒ¹é…æˆåŠŸ</SelectItem>\n                      <SelectItem value=\"activity_reminder\">æ´»åŠ¨æé†’</SelectItem>\n                      <SelectItem value=\"new_message\">æ–°æ¶ˆæ¯</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>æ ‡é¢˜ *</Label>\n                <Input\n                  value={title}\n                  onChange={(e) => setTitle(e.target.value)}\n                  placeholder=\"è¾“å…¥é€šçŸ¥æ ‡é¢˜\"\n                  data-testid=\"input-title\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>å†…å®¹</Label>\n                <Textarea\n                  value={message}\n                  onChange={(e) => setMessage(e.target.value)}\n                  placeholder=\"è¾“å…¥é€šçŸ¥å†…å®¹ï¼ˆå¯é€‰ï¼‰\"\n                  rows={4}\n                  data-testid=\"textarea-message\"\n                />\n              </div>\n\n              <div className=\"space-y-4\">\n                <Label>æ¥æ”¶å¯¹è±¡</Label>\n                <div className=\"flex gap-4\">\n                  <Button\n                    variant={recipientFilter === \"all\" ? \"default\" : \"outline\"}\n                    onClick={() => setRecipientFilter(\"all\")}\n                    data-testid=\"button-select-all-users\"\n                  >\n                    <Users className=\"mr-2 h-4 w-4\" />\n                    æ‰€æœ‰ç”¨æˆ· ({users.length})\n                  </Button>\n                  <Button\n                    variant={recipientFilter === \"selected\" ? \"default\" : \"outline\"}\n                    onClick={() => setRecipientFilter(\"selected\")}\n                    data-testid=\"button-select-specific-users\"\n                  >\n                    æŒ‡å®šç”¨æˆ· ({selectedUserIds.length})\n                  </Button>\n                </div>\n\n                {recipientFilter === \"selected\" && (\n                  <Card>\n                    <CardHeader>\n                      <div className=\"flex items-center justify-between\">\n                        <CardTitle className=\"text-lg\">é€‰æ‹©ç”¨æˆ·</CardTitle>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={toggleAllUsers}\n                          data-testid=\"button-toggle-all\"\n                        >\n                          {selectedUserIds.length === users.length ? \"å–æ¶ˆå…¨é€‰\" : \"å…¨é€‰\"}\n                        </Button>\n                      </div>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"max-h-96 overflow-y-auto space-y-2\">\n                        {users.map((user: User) => (\n                          <div\n                            key={user.id}\n                            className=\"flex items-center space-x-3 p-3 rounded-lg hover-elevate\"\n                            data-testid={`user-item-${user.id}`}\n                          >\n                            <Checkbox\n                              checked={selectedUserIds.includes(user.id)}\n                              onCheckedChange={() => toggleUserSelection(user.id)}\n                              data-testid={`checkbox-user-${user.id}`}\n                            />\n                            <div className=\"flex-1\">\n                              <p className=\"font-medium\">\n                                {user.firstName} {user.lastName}\n                              </p>\n                              <p className=\"text-sm text-muted-foreground\">{user.phoneNumber}</p>\n                            </div>\n                            {user.archetype && (\n                              <Badge variant=\"secondary\">{user.archetype}</Badge>\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                    </CardContent>\n                  </Card>\n                )}\n              </div>\n\n              <div className=\"flex justify-end gap-3 pt-4\">\n                <Button\n                  onClick={handleSend}\n                  disabled={sendNotificationMutation.isPending}\n                  data-testid=\"button-send-notification\"\n                >\n                  <Send className=\"mr-2 h-4 w-4\" />\n                  {sendNotificationMutation.isPending ? \"å‘é€ä¸­...\" : \"å‘é€é€šçŸ¥\"}\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"history\">\n          <Card>\n            <CardHeader>\n              <CardTitle>é€šçŸ¥å‘é€å†å²</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {notifications.length === 0 ? (\n                <div className=\"text-center py-12 text-muted-foreground\">\n                  <Bell className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>æš‚æ— å‘é€è®°å½•</p>\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {notifications.map((notif: NotificationHistory) => (\n                    <Card key={notif.id} data-testid={`notification-${notif.id}`}>\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-start justify-between\">\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center gap-3 mb-2\">\n                              <h3 className=\"font-semibold text-lg\" data-testid=\"text-notification-title\">\n                                {notif.title}\n                              </h3>\n                              <Badge variant=\"outline\">{notif.category}</Badge>\n                              <Badge variant=\"secondary\">{notif.type}</Badge>\n                            </div>\n                            {notif.message && (\n                              <p className=\"text-muted-foreground mb-3\" data-testid=\"text-notification-message\">\n                                {notif.message}\n                              </p>\n                            )}\n                            <div className=\"flex items-center gap-6 text-sm text-muted-foreground\">\n                              <div className=\"flex items-center gap-2\">\n                                <Users className=\"h-4 w-4\" />\n                                <span data-testid=\"text-recipient-count\">\n                                  å‘é€ç»™ {notif.recipientCount} äºº\n                                </span>\n                              </div>\n                              <div className=\"flex items-center gap-2\">\n                                <CheckCircle className=\"h-4 w-4\" />\n                                <span data-testid=\"text-read-count\">\n                                  {notif.readCount} äººå·²è¯»\n                                </span>\n                              </div>\n                              <div className=\"flex items-center gap-2\">\n                                <Clock className=\"h-4 w-4\" />\n                                <span data-testid=\"text-created-at\">\n                                  {new Date(notif.createdAt).toLocaleString(\"zh-CN\")}\n                                </span>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","size_bytes":13983},"server/wsService.ts":{"content":"import { WebSocketServer, WebSocket } from 'ws';\nimport { Server } from 'http';\nimport type { WSMessage, WSEventType } from '../shared/wsEvents';\n\ninterface AuthenticatedWebSocket extends WebSocket {\n  userId?: string;\n  isAlive?: boolean;\n}\n\nclass WebSocketService {\n  private wss: WebSocketServer | null = null;\n  private clients: Map<string, Set<AuthenticatedWebSocket>> = new Map();\n  private eventRooms: Map<string, Set<AuthenticatedWebSocket>> = new Map();\n\n  initialize(server: Server) {\n    this.wss = new WebSocketServer({ server, path: '/ws' });\n\n    this.wss.on('connection', (ws: AuthenticatedWebSocket, req) => {\n      console.log('[WS] New client connected');\n      ws.isAlive = true;\n\n      // å¿ƒè·³æ£€æµ‹\n      ws.on('pong', () => {\n        ws.isAlive = true;\n      });\n\n      ws.on('message', (data: Buffer) => {\n        try {\n          const message: WSMessage = JSON.parse(data.toString());\n          this.handleMessage(ws, message);\n        } catch (error) {\n          console.error('[WS] Error parsing message:', error);\n        }\n      });\n\n      ws.on('close', () => {\n        this.handleDisconnect(ws);\n      });\n\n      ws.on('error', (error) => {\n        console.error('[WS] WebSocket error:', error);\n        \n        // Log WebSocket error\n        fetch('http://localhost:5000/api/chat-logs', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            eventType: 'ws_error',\n            userId: ws.userId,\n            severity: 'error',\n            message: 'WebSocket connection error',\n            metadata: { error: error.message, stack: error.stack },\n          }),\n        }).catch(err => console.error('[WS] Failed to log error:', err));\n      });\n    });\n\n    // å¿ƒè·³æ£€æµ‹å®šæ—¶å™¨\n    const interval = setInterval(() => {\n      this.wss?.clients.forEach((ws: WebSocket) => {\n        const authWs = ws as AuthenticatedWebSocket;\n        if (!authWs.isAlive) {\n          return authWs.terminate();\n        }\n        authWs.isAlive = false;\n        authWs.ping();\n      });\n    }, 30000);\n\n    this.wss.on('close', () => {\n      clearInterval(interval);\n    });\n\n    console.log('[WS] WebSocket server initialized');\n  }\n\n  private handleMessage(ws: AuthenticatedWebSocket, message: WSMessage) {\n    switch (message.type) {\n      case 'PING':\n        this.sendToClient(ws, { type: 'PONG', timestamp: new Date().toISOString() });\n        break;\n\n      case 'USER_JOINED':\n        // ç”¨æˆ·åŠ å…¥æ—¶ï¼Œä¿å­˜userIdå’Œè®¢é˜…eventId\n        if (message.userId) {\n          ws.userId = message.userId;\n          this.addClientToUser(message.userId, ws);\n        }\n        if (message.eventId) {\n          this.subscribeToEvent(ws, message.eventId);\n        }\n        console.log(`[WS] User ${message.userId} joined event ${message.eventId}`);\n        break;\n\n      case 'USER_LEFT':\n        if (message.eventId) {\n          this.unsubscribeFromEvent(ws, message.eventId);\n        }\n        break;\n\n      default:\n        console.log(`[WS] Received message type: ${message.type}`);\n    }\n  }\n\n  private handleDisconnect(ws: AuthenticatedWebSocket) {\n    const userId = ws.userId;\n    \n    if (userId) {\n      this.removeClientFromUser(userId, ws);\n    }\n    // ä»æ‰€æœ‰event roomsç§»é™¤\n    this.eventRooms.forEach((clients) => {\n      clients.delete(ws);\n    });\n    console.log('[WS] Client disconnected');\n    \n    // Log disconnection\n    fetch('http://localhost:5000/api/chat-logs', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        eventType: 'ws_disconnected',\n        userId,\n        severity: 'info',\n        message: 'WebSocket client disconnected',\n      }),\n    }).catch(err => console.error('[WS] Failed to log disconnection:', err));\n  }\n\n  private addClientToUser(userId: string, ws: AuthenticatedWebSocket) {\n    if (!this.clients.has(userId)) {\n      this.clients.set(userId, new Set());\n    }\n    this.clients.get(userId)!.add(ws);\n  }\n\n  private removeClientFromUser(userId: string, ws: AuthenticatedWebSocket) {\n    const userClients = this.clients.get(userId);\n    if (userClients) {\n      userClients.delete(ws);\n      if (userClients.size === 0) {\n        this.clients.delete(userId);\n      }\n    }\n  }\n\n  private subscribeToEvent(ws: AuthenticatedWebSocket, eventId: string) {\n    if (!this.eventRooms.has(eventId)) {\n      this.eventRooms.set(eventId, new Set());\n    }\n    this.eventRooms.get(eventId)!.add(ws);\n  }\n\n  private unsubscribeFromEvent(ws: AuthenticatedWebSocket, eventId: string) {\n    const room = this.eventRooms.get(eventId);\n    if (room) {\n      room.delete(ws);\n      if (room.size === 0) {\n        this.eventRooms.delete(eventId);\n      }\n    }\n  }\n\n  private sendToClient(ws: AuthenticatedWebSocket, message: WSMessage) {\n    if (ws.readyState === WebSocket.OPEN) {\n      ws.send(JSON.stringify(message));\n    }\n  }\n\n  // å‘é€ç»™æŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰è¿æ¥\n  broadcastToUser(userId: string, message: WSMessage) {\n    const userClients = this.clients.get(userId);\n    if (userClients) {\n      userClients.forEach((ws) => {\n        this.sendToClient(ws, message);\n      });\n      console.log(`[WS] Broadcast to user ${userId}: ${message.type}`);\n    }\n  }\n\n  // å‘é€ç»™æŒ‡å®šæ´»åŠ¨æˆ¿é—´çš„æ‰€æœ‰å®¢æˆ·ç«¯\n  broadcastToEvent(eventId: string, message: WSMessage) {\n    const room = this.eventRooms.get(eventId);\n    if (room) {\n      room.forEach((ws) => {\n        this.sendToClient(ws, message);\n      });\n      console.log(`[WS] Broadcast to event ${eventId}: ${message.type} to ${room.size} clients`);\n    }\n  }\n\n  // å‘é€ç»™å¤šä¸ªç”¨æˆ·\n  broadcastToUsers(userIds: string[], message: WSMessage) {\n    userIds.forEach((userId) => {\n      this.broadcastToUser(userId, message);\n    });\n  }\n\n  // å…¨å±€å¹¿æ’­ï¼ˆæ…ç”¨ï¼‰\n  broadcastToAll(message: WSMessage) {\n    this.wss?.clients.forEach((ws: WebSocket) => {\n      const authWs = ws as AuthenticatedWebSocket;\n      this.sendToClient(authWs, message);\n    });\n    console.log(`[WS] Global broadcast: ${message.type} to ${this.wss?.clients.size} clients`);\n  }\n\n  // è·å–è¿æ¥ç»Ÿè®¡\n  getStats() {\n    return {\n      totalConnections: this.wss?.clients.size || 0,\n      uniqueUsers: this.clients.size,\n      activeEventRooms: this.eventRooms.size,\n    };\n  }\n}\n\nexport const wsService = new WebSocketService();\n","size_bytes":6387},"server/eventBroadcast.ts":{"content":"import { wsService } from './wsService';\nimport { storage } from './storage';\nimport type {\n  EventStatusChangedData,\n  EventMatchedData,\n  UserConfirmedData,\n  MatchProgressUpdateData,\n  AdminActionData,\n} from '../shared/wsEvents';\n\n/**\n * å¹¿æ’­æ´»åŠ¨çŠ¶æ€å˜æ›´äº‹ä»¶\n */\nexport async function broadcastEventStatusChanged(\n  eventId: string,\n  oldStatus: string,\n  newStatus: string,\n  updatedBy: string,\n  reason?: string\n) {\n  const data: EventStatusChangedData = {\n    eventId,\n    oldStatus,\n    newStatus,\n    updatedBy,\n    reason,\n  };\n\n  // æ¨é€ç»™æ´»åŠ¨æˆ¿é—´çš„æ‰€æœ‰ç”¨æˆ·\n  wsService.broadcastToEvent(eventId, {\n    type: 'EVENT_STATUS_CHANGED',\n    eventId,\n    data,\n    timestamp: new Date().toISOString(),\n  });\n\n  // å¦‚æœçŠ¶æ€å˜æ›´æ˜¯é‡è¦çš„ï¼Œä¹Ÿåˆ›å»ºnotification\n  if (shouldCreateNotification(oldStatus, newStatus)) {\n    await createStatusChangeNotification(eventId, newStatus);\n  }\n}\n\n/**\n * å¹¿æ’­æ´»åŠ¨åŒ¹é…å®Œæˆäº‹ä»¶\n */\nexport async function broadcastEventMatched(\n  eventId: string,\n  participants: Array<{ userId: string; displayName: string; archetype: string }>,\n  matchQualityScore: number,\n  restaurantName: string,\n  restaurantAddress: string\n) {\n  const data: EventMatchedData = {\n    eventId,\n    participants,\n    matchQualityScore,\n    restaurantName,\n    restaurantAddress,\n  };\n\n  // æ¨é€ç»™æ´»åŠ¨æˆ¿é—´çš„æ‰€æœ‰ç”¨æˆ·\n  wsService.broadcastToEvent(eventId, {\n    type: 'EVENT_MATCHED',\n    eventId,\n    data,\n    timestamp: new Date().toISOString(),\n  });\n\n  // æ¨é€ç»™æ‰€æœ‰å‚ä¸è€…ï¼ˆå³ä½¿ä»–ä»¬è¿˜æ²¡åŠ å…¥WebSocketæˆ¿é—´ï¼‰\n  const userIds = participants.map(p => p.userId);\n  wsService.broadcastToUsers(userIds, {\n    type: 'EVENT_MATCHED',\n    eventId,\n    data,\n    timestamp: new Date().toISOString(),\n  });\n\n  // åˆ›å»ºnotificationç»™æ‰€æœ‰å‚ä¸è€…\n  await Promise.all(\n    userIds.map(userId =>\n      storage.createNotification({\n        userId,\n        category: 'activities',\n        type: 'event_reminder',\n        title: 'åŒ¹é…æˆåŠŸï¼',\n        message: `æ‚¨çš„æ´»åŠ¨å·²æˆåŠŸåŒ¹é…ï¼Œ${participants.length}ä½å‚ä¸è€…ï¼Œåœ°ç‚¹ï¼š${restaurantName}`,\n        relatedResourceId: eventId,\n      })\n    )\n  );\n}\n\n/**\n * å¹¿æ’­ç”¨æˆ·ç¡®è®¤å‚ä¸äº‹ä»¶\n */\nexport async function broadcastUserConfirmed(\n  eventId: string,\n  userId: string,\n  displayName: string,\n  confirmedCount: number,\n  totalParticipants: number\n) {\n  const data: UserConfirmedData = {\n    eventId,\n    userId,\n    displayName,\n    confirmedCount,\n    totalParticipants,\n  };\n\n  // æ¨é€ç»™æ´»åŠ¨æˆ¿é—´çš„æ‰€æœ‰ç”¨æˆ·\n  wsService.broadcastToEvent(eventId, {\n    type: 'USER_CONFIRMED',\n    eventId,\n    data,\n    timestamp: new Date().toISOString(),\n  });\n}\n\n/**\n * å¹¿æ’­åŒ¹é…è¿›åº¦æ›´æ–°\n */\nexport async function broadcastMatchProgressUpdate(\n  eventId: string,\n  progress: number,\n  etaMinutes: number | null,\n  currentParticipants: number\n) {\n  const data: MatchProgressUpdateData = {\n    eventId,\n    progress,\n    etaMinutes,\n    currentParticipants,\n  };\n\n  // æ¨é€ç»™æ´»åŠ¨æˆ¿é—´çš„æ‰€æœ‰ç”¨æˆ·\n  wsService.broadcastToEvent(eventId, {\n    type: 'MATCH_PROGRESS_UPDATE',\n    eventId,\n    data,\n    timestamp: new Date().toISOString(),\n  });\n}\n\n/**\n * å¹¿æ’­ç®¡ç†å‘˜æ“ä½œ\n */\nexport async function broadcastAdminAction(\n  eventId: string,\n  action: string,\n  adminId: string,\n  details?: any\n) {\n  const data: AdminActionData = {\n    eventId,\n    action,\n    adminId,\n    details,\n  };\n\n  // æ¨é€ç»™æ´»åŠ¨æˆ¿é—´çš„æ‰€æœ‰ç”¨æˆ·\n  wsService.broadcastToEvent(eventId, {\n    type: 'ADMIN_ACTION',\n    eventId,\n    data,\n    timestamp: new Date().toISOString(),\n  });\n\n  // æŸäº›ç®¡ç†å‘˜æ“ä½œéœ€è¦åˆ›å»ºnotification\n  if (shouldNotifyUsers(action)) {\n    await createAdminActionNotification(eventId, action, details);\n  }\n}\n\n/**\n * åˆ¤æ–­çŠ¶æ€å˜æ›´æ˜¯å¦éœ€è¦åˆ›å»ºnotification\n */\nfunction shouldCreateNotification(oldStatus: string, newStatus: string): boolean {\n  const importantTransitions = [\n    { from: 'pending_match', to: 'matched' },\n    { from: 'matched', to: 'completed' },\n    { from: '*', to: 'canceled' },\n  ];\n\n  return importantTransitions.some(\n    t => (t.from === '*' || t.from === oldStatus) && t.to === newStatus\n  );\n}\n\n/**\n * åˆ›å»ºçŠ¶æ€å˜æ›´notification\n */\nasync function createStatusChangeNotification(eventId: string, newStatus: string) {\n  try {\n    // è·å–æ´»åŠ¨å‚ä¸è€…\n    const event = await storage.getBlindBoxEventAdmin(eventId);\n    if (!event || !event.matchedAttendees) return;\n\n    const participants = (event.matchedAttendees as any[]).map((p: any) => p.userId);\n    \n    let title = '';\n    let message = '';\n    \n    switch (newStatus) {\n      case 'matched':\n        title = 'åŒ¹é…æˆåŠŸï¼';\n        message = 'æ‚¨çš„æ´»åŠ¨å·²æˆåŠŸåŒ¹é…ï¼ŒæŸ¥çœ‹è¯¦æƒ…äº†è§£æ›´å¤š';\n        break;\n      case 'completed':\n        title = 'æ´»åŠ¨å·²å®Œæˆ';\n        message = 'æ„Ÿè°¢å‚ä¸ï¼è¯·ä¸ºæ´»åŠ¨æä¾›åé¦ˆ';\n        break;\n      case 'canceled':\n        title = 'æ´»åŠ¨å·²å–æ¶ˆ';\n        message = 'å¾ˆæŠ±æ­‰ï¼Œæ´»åŠ¨å·²è¢«å–æ¶ˆ';\n        break;\n      default:\n        return;\n    }\n\n    // åˆ›å»ºnotifications\n    await Promise.all(\n      participants.map((userId: string) =>\n        storage.createNotification({\n          userId,\n          category: 'activities',\n          type: 'event_reminder',\n          title,\n          message,\n          relatedResourceId: eventId,\n        })\n      )\n    );\n  } catch (error) {\n    console.error('[EventBroadcast] Error creating status change notification:', error);\n  }\n}\n\n/**\n * åˆ¤æ–­ç®¡ç†å‘˜æ“ä½œæ˜¯å¦éœ€è¦é€šçŸ¥ç”¨æˆ·\n */\nfunction shouldNotifyUsers(action: string): boolean {\n  const notifiableActions = ['cancel_event', 'update_venue', 'update_time'];\n  return notifiableActions.includes(action);\n}\n\n/**\n * åˆ›å»ºç®¡ç†å‘˜æ“ä½œnotification\n */\nasync function createAdminActionNotification(\n  eventId: string,\n  action: string,\n  details?: any\n) {\n  try {\n    const event = await storage.getBlindBoxEventAdmin(eventId);\n    if (!event || !event.matchedAttendees) return;\n\n    const participants = (event.matchedAttendees as any[]).map((p: any) => p.userId);\n    \n    let title = '';\n    let message = '';\n    \n    switch (action) {\n      case 'cancel_event':\n        title = 'æ´»åŠ¨å·²å–æ¶ˆ';\n        message = details?.reason || 'ç®¡ç†å‘˜å–æ¶ˆäº†æ´»åŠ¨';\n        break;\n      case 'update_venue':\n        title = 'æ´»åŠ¨åœ°ç‚¹å˜æ›´';\n        message = `æ–°åœ°ç‚¹ï¼š${details?.venueName || 'å¾…å®š'}`;\n        break;\n      case 'update_time':\n        title = 'æ´»åŠ¨æ—¶é—´å˜æ›´';\n        message = `æ–°æ—¶é—´ï¼š${details?.newTime || 'å¾…å®š'}`;\n        break;\n      default:\n        return;\n    }\n\n    await Promise.all(\n      participants.map((userId: string) =>\n        storage.createNotification({\n          userId,\n          category: 'system',\n          type: 'system_alert',\n          title,\n          message,\n          relatedResourceId: eventId,\n        })\n      )\n    );\n  } catch (error) {\n    console.error('[EventBroadcast] Error creating admin action notification:', error);\n  }\n}\n","size_bytes":7062},"client/src/lib/cacheInvalidation.ts":{"content":"import { queryClient } from './queryClient';\nimport type { WSMessage } from '@/../../shared/wsEvents';\n\n/**\n * æ™ºèƒ½ç¼“å­˜å¤±æ•ˆç³»ç»Ÿ\n * æ ¹æ®WebSocketäº‹ä»¶ç±»å‹ç²¾ç¡®å¤±æ•ˆç›¸å…³æŸ¥è¯¢ç¼“å­˜\n */\n\nexport async function invalidateCacheForEvent(message: WSMessage) {\n  const eventId = message.eventId;\n  \n  switch (message.type) {\n    case 'EVENT_STATUS_CHANGED':\n      // å¤±æ•ˆæ´»åŠ¨ç›¸å…³çš„æ‰€æœ‰ç¼“å­˜\n      await Promise.all([\n        queryClient.invalidateQueries({ queryKey: ['/api/blind-box-events'] }),\n        eventId && queryClient.invalidateQueries({ queryKey: ['/api/blind-box-events', eventId] }),\n        queryClient.invalidateQueries({ queryKey: ['/api/admin/events'] }),\n        eventId && queryClient.invalidateQueries({ queryKey: ['/api/admin/events', eventId] }),\n        queryClient.invalidateQueries({ queryKey: ['/api/my-events'] }),\n      ].filter(Boolean));\n      break;\n      \n    case 'EVENT_MATCHED':\n      // å¤±æ•ˆæ´»åŠ¨å’ŒåŒ¹é…ç›¸å…³ç¼“å­˜\n      await Promise.all([\n        eventId && queryClient.invalidateQueries({ queryKey: ['/api/blind-box-events', eventId] }),\n        eventId && queryClient.invalidateQueries({ queryKey: ['/api/admin/events', eventId] }),\n        queryClient.invalidateQueries({ queryKey: ['/api/my-events'] }),\n      ].filter(Boolean));\n      break;\n      \n    case 'USER_JOINED':\n    case 'USER_LEFT':\n      // å¤±æ•ˆæ´»åŠ¨å‚ä¸è€…ç›¸å…³ç¼“å­˜\n      await Promise.all([\n        eventId && queryClient.invalidateQueries({ queryKey: ['/api/blind-box-events', eventId] }),\n        eventId && queryClient.invalidateQueries({ queryKey: ['/api/admin/events', eventId] }),\n        queryClient.invalidateQueries({ queryKey: ['/api/my-events'] }),\n      ].filter(Boolean));\n      break;\n      \n    case 'EVENT_UPDATED':\n      // å¤±æ•ˆæ‰€æœ‰æ´»åŠ¨åˆ—è¡¨å’ŒåŒ¹é…ç›¸å…³ç¼“å­˜\n      await Promise.all([\n        queryClient.invalidateQueries({ queryKey: ['/api/blind-box-events'] }),\n        queryClient.invalidateQueries({ queryKey: ['/api/admin/events'] }),\n        queryClient.invalidateQueries({ queryKey: ['/api/matching'] }),\n      ]);\n      break;\n      \n    case 'EVENT_CANCELED':\n    case 'EVENT_COMPLETED':\n      // å¤±æ•ˆæ´»åŠ¨ç›¸å…³çš„æ‰€æœ‰ç¼“å­˜\n      await Promise.all([\n        queryClient.invalidateQueries({ queryKey: ['/api/blind-box-events'] }),\n        eventId && queryClient.invalidateQueries({ queryKey: ['/api/blind-box-events', eventId] }),\n        queryClient.invalidateQueries({ queryKey: ['/api/admin/events'] }),\n        eventId && queryClient.invalidateQueries({ queryKey: ['/api/admin/events', eventId] }),\n        queryClient.invalidateQueries({ queryKey: ['/api/my-events'] }),\n      ].filter(Boolean));\n      break;\n      \n    case 'ADMIN_ACTION':\n      // å¤±æ•ˆç®¡ç†å‘˜ç›¸å…³ç¼“å­˜\n      await invalidateAdminCache();\n      break;\n      \n    default:\n      console.warn('Unknown event type for cache invalidation:', message.type);\n  }\n}\n\n/**\n * å¤±æ•ˆç®¡ç†å‘˜ç›¸å…³ç¼“å­˜\n */\nexport async function invalidateAdminCache() {\n  await Promise.all([\n    queryClient.invalidateQueries({ queryKey: ['/api/admin/events'] }),\n    queryClient.invalidateQueries({ queryKey: ['/api/admin/finance/stats'] }),\n    queryClient.invalidateQueries({ queryKey: ['/api/admin/insights/stats'] }),\n  ]);\n}\n\n/**\n * å¤±æ•ˆç”¨æˆ·æ´»åŠ¨ç¼“å­˜\n */\nexport async function invalidateUserEventsCache(userId?: string) {\n  await Promise.all([\n    queryClient.invalidateQueries({ queryKey: ['/api/my-events'] }),\n    queryClient.invalidateQueries({ queryKey: ['/api/blind-box-events'] }),\n  ]);\n  \n  if (userId) {\n    await queryClient.invalidateQueries({ queryKey: ['/api/users', userId] });\n  }\n}\n","size_bytes":3653},"client/src/hooks/useWebSocket.ts":{"content":"import { useEffect, useRef, useState, useCallback } from 'react';\nimport type { WSMessage, WSEventType } from '@/../../shared/wsEvents';\n\ntype MessageHandler = (message: WSMessage) => void;\n\ninterface UseWebSocketOptions {\n  userId?: string;\n  eventId?: string;\n  onMessage?: MessageHandler;\n  autoConnect?: boolean;\n}\n\nexport function useWebSocket(options: UseWebSocketOptions = {}) {\n  const { userId, eventId, onMessage, autoConnect = true } = options;\n  const [isConnected, setIsConnected] = useState(false);\n  const [isReconnecting, setIsReconnecting] = useState(false);\n  const wsRef = useRef<WebSocket | null>(null);\n  const messageHandlersRef = useRef<Map<WSEventType, Set<MessageHandler>>>(new Map());\n  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const reconnectAttemptsRef = useRef(0);\n\n  const connect = useCallback(() => {\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      return;\n    }\n\n    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n    const wsUrl = `${protocol}//${window.location.host}/ws`;\n\n    try {\n      const ws = new WebSocket(wsUrl);\n      wsRef.current = ws;\n\n      ws.onopen = () => {\n        console.log('[WS] Connected');\n        setIsConnected(true);\n        setIsReconnecting(false);\n        reconnectAttemptsRef.current = 0;\n\n        // å‘é€ç”¨æˆ·åŠ å…¥æ¶ˆæ¯\n        if (userId || eventId) {\n          const joinMessage: WSMessage = {\n            type: 'USER_JOINED',\n            userId,\n            eventId,\n            timestamp: new Date().toISOString(),\n          };\n          ws.send(JSON.stringify(joinMessage));\n        }\n\n        // å¯åŠ¨å¿ƒè·³\n        const heartbeatInterval = setInterval(() => {\n          if (ws.readyState === WebSocket.OPEN) {\n            ws.send(JSON.stringify({\n              type: 'PING',\n              timestamp: new Date().toISOString(),\n            }));\n          }\n        }, 30000);\n\n        ws.addEventListener('close', () => {\n          clearInterval(heartbeatInterval);\n        });\n      };\n\n      ws.onmessage = (event) => {\n        try {\n          const message: WSMessage = JSON.parse(event.data);\n          \n          // è°ƒç”¨å…¨å±€handler\n          onMessage?.(message);\n\n          // è°ƒç”¨ç±»å‹ç‰¹å®šçš„handlers\n          const handlers = messageHandlersRef.current.get(message.type);\n          if (handlers) {\n            handlers.forEach((handler) => handler(message));\n          }\n        } catch (error) {\n          console.error('[WS] Error parsing message:', error);\n        }\n      };\n\n      ws.onerror = (error) => {\n        console.error('[WS] Error:', error);\n      };\n\n      ws.onclose = () => {\n        console.log('[WS] Disconnected');\n        setIsConnected(false);\n        wsRef.current = null;\n\n        // è‡ªåŠ¨é‡è¿é€»è¾‘\n        if (autoConnect && reconnectAttemptsRef.current < 10) {\n          setIsReconnecting(true);\n          const delay = Math.min(1000 * Math.pow(2, reconnectAttemptsRef.current), 30000);\n          console.log(`[WS] Reconnecting in ${delay}ms...`);\n          \n          reconnectTimeoutRef.current = setTimeout(() => {\n            reconnectAttemptsRef.current++;\n            connect();\n          }, delay);\n        }\n      };\n    } catch (error) {\n      console.error('[WS] Connection error:', error);\n    }\n  }, [userId, eventId, onMessage, autoConnect]);\n\n  const disconnect = useCallback(() => {\n    if (reconnectTimeoutRef.current) {\n      clearTimeout(reconnectTimeoutRef.current);\n    }\n    if (wsRef.current) {\n      // å‘é€ç¦»å¼€æ¶ˆæ¯\n      if (eventId) {\n        try {\n          wsRef.current.send(JSON.stringify({\n            type: 'USER_LEFT',\n            eventId,\n            userId,\n            timestamp: new Date().toISOString(),\n          }));\n        } catch (error) {\n          console.error('[WS] Error sending leave message:', error);\n        }\n      }\n      wsRef.current.close();\n      wsRef.current = null;\n    }\n    setIsConnected(false);\n    setIsReconnecting(false);\n  }, [eventId, userId]);\n\n  const send = useCallback((message: Omit<WSMessage, 'timestamp'>) => {\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      wsRef.current.send(JSON.stringify({\n        ...message,\n        timestamp: new Date().toISOString(),\n      }));\n    } else {\n      console.warn('[WS] Cannot send message, not connected');\n    }\n  }, []);\n\n  const subscribe = useCallback((type: WSEventType, handler: MessageHandler) => {\n    if (!messageHandlersRef.current.has(type)) {\n      messageHandlersRef.current.set(type, new Set());\n    }\n    messageHandlersRef.current.get(type)!.add(handler);\n\n    // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°\n    return () => {\n      const handlers = messageHandlersRef.current.get(type);\n      if (handlers) {\n        handlers.delete(handler);\n        if (handlers.size === 0) {\n          messageHandlersRef.current.delete(type);\n        }\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (autoConnect) {\n      connect();\n    }\n\n    return () => {\n      disconnect();\n    };\n  }, [connect, disconnect, autoConnect]);\n\n  return {\n    isConnected,\n    isReconnecting,\n    connect,\n    disconnect,\n    send,\n    subscribe,\n  };\n}\n","size_bytes":5159},"shared/wsEvents.ts":{"content":"// WebSocketäº‹ä»¶ç±»å‹å®šä¹‰\n\nexport type WSEventType =\n  | \"EVENT_CREATED\"\n  | \"EVENT_UPDATED\"\n  | \"EVENT_MATCHED\"\n  | \"EVENT_STATUS_CHANGED\"\n  | \"EVENT_COMPLETED\"\n  | \"EVENT_CANCELED\"\n  | \"POOL_MATCHED\"\n  | \"USER_JOINED\"\n  | \"USER_CONFIRMED\"\n  | \"USER_LEFT\"\n  | \"MATCH_PROGRESS_UPDATE\"\n  | \"ADMIN_ACTION\"\n  | \"PING\"\n  | \"PONG\";\n\nexport interface WSMessage {\n  type: WSEventType;\n  eventId?: string;\n  userId?: string;\n  data?: any;\n  timestamp: string;\n}\n\n// äº‹ä»¶åˆ›å»º\nexport interface EventCreatedData {\n  eventId: string;\n  userId: string;\n  title: string;\n  eventType: string;\n  dateTime: string;\n}\n\n// äº‹ä»¶çŠ¶æ€å˜æ›´\nexport interface EventStatusChangedData {\n  eventId: string;\n  oldStatus: string;\n  newStatus: string;\n  updatedBy: string;\n  reason?: string;\n}\n\n// åŒ¹é…å®Œæˆ\nexport interface EventMatchedData {\n  eventId: string;\n  participants: Array<{\n    userId: string;\n    displayName: string;\n    archetype: string;\n  }>;\n  matchQualityScore: number;\n  restaurantName: string;\n  restaurantAddress: string;\n}\n\n// ç”¨æˆ·ç¡®è®¤å‚ä¸\nexport interface UserConfirmedData {\n  eventId: string;\n  userId: string;\n  displayName: string;\n  confirmedCount: number;\n  totalParticipants: number;\n}\n\n// åŒ¹é…è¿›åº¦æ›´æ–°\nexport interface MatchProgressUpdateData {\n  eventId: string;\n  progress: number;\n  etaMinutes: number | null;\n  currentParticipants: number;\n}\n\n// ç®¡ç†å‘˜æ“ä½œ\nexport interface AdminActionData {\n  eventId: string;\n  action: string;\n  adminId: string;\n  details?: any;\n}\n\n// æ´»åŠ¨æ± åŒ¹é…å®Œæˆ\nexport interface PoolMatchedData {\n  poolId: string;\n  poolTitle: string;\n  groupId: string;\n  groupNumber: number;\n  matchScore: number;\n  memberCount: number;\n  temperatureLevel: string; // fire | warm | mild | cold\n}\n","size_bytes":1753},"client/src/pages/admin/AdminChatLogsPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { AlertCircle, RefreshCw, FileText, AlertTriangle, Info, XCircle } from \"lucide-react\";\nimport { format } from \"date-fns\";\n\ninterface ChatLog {\n  id: string;\n  eventType: string;\n  eventId?: string;\n  threadId?: string;\n  userId?: string;\n  severity: string;\n  message: string;\n  metadata?: any;\n  createdAt: string;\n}\n\ninterface ChatLogStats {\n  total: number;\n  info: number;\n  warning: number;\n  error: number;\n}\n\nconst severityConfig: Record<string, { label: string; icon: any; variant: \"default\" | \"secondary\" | \"destructive\" }> = {\n  info: { label: \"ä¿¡æ¯\", icon: Info, variant: \"default\" },\n  warning: { label: \"è­¦å‘Š\", icon: AlertTriangle, variant: \"secondary\" },\n  error: { label: \"é”™è¯¯\", icon: XCircle, variant: \"destructive\" },\n};\n\nexport default function AdminChatLogsPage() {\n  const [eventIdFilter, setEventIdFilter] = useState(\"\");\n  const [userIdFilter, setUserIdFilter] = useState(\"\");\n  const [severityFilter, setSeverityFilter] = useState<string>(\"all\");\n  const [startDate, setStartDate] = useState(\"\");\n  const [endDate, setEndDate] = useState(\"\");\n  const [selectedLog, setSelectedLog] = useState<ChatLog | null>(null);\n\n  const buildQueryParams = () => {\n    const params: any = {};\n    if (eventIdFilter) params.eventId = eventIdFilter;\n    if (userIdFilter) params.userId = userIdFilter;\n    if (severityFilter && severityFilter !== \"all\") params.severity = severityFilter;\n    if (startDate) params.startDate = startDate;\n    if (endDate) params.endDate = endDate;\n    return params;\n  };\n\n  const { data: stats } = useQuery<ChatLogStats>({\n    queryKey: [\"/api/admin/chat-logs/stats\"],\n  });\n\n  const { data: logs = [], isLoading, isError, error, refetch } = useQuery<ChatLog[]>({\n    queryKey: [\"/api/admin/chat-logs\", buildQueryParams()],\n    retry: 2,\n  });\n\n  if (isError) {\n    return (\n      <div className=\"flex h-full items-center justify-center p-8\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6\">\n            <div className=\"space-y-4 text-center\">\n              <AlertCircle className=\"mx-auto h-12 w-12 text-destructive\" />\n              <div>\n                <h3 className=\"text-lg font-semibold\">åŠ è½½å¤±è´¥</h3>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  {error instanceof Error && error.message.includes(\"401\") \n                    ? \"æ‚¨æ²¡æœ‰è®¿é—®æƒé™\"\n                    : \"æ— æ³•åŠ è½½æ—¥å¿—æ•°æ®ï¼Œè¯·ç¨åé‡è¯•\"}\n                </p>\n              </div>\n              <Button \n                onClick={() => refetch()} \n                variant=\"default\"\n                data-testid=\"button-retry-logs\"\n              >\n                <RefreshCw className=\"mr-2 h-4 w-4\" />\n                é‡è¯•\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">èŠå¤©æ—¥å¿—</h1>\n          <p className=\"text-muted-foreground mt-1\">æŸ¥çœ‹èŠå¤©ç³»ç»Ÿæ—¥å¿—å’Œé”™è¯¯è®°å½•</p>\n        </div>\n        <Button\n          variant=\"outline\"\n          size=\"sm\"\n          onClick={() => refetch()}\n          data-testid=\"button-refresh-logs\"\n        >\n          <RefreshCw className=\"h-4 w-4 mr-2\" />\n          åˆ·æ–°\n        </Button>\n      </div>\n\n      {/* Stats Cards */}\n      {stats && (\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-primary/10 rounded-lg\">\n                  <FileText className=\"h-5 w-5 text-primary\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">æ€»æ•°</p>\n                  <p className=\"text-2xl font-bold\" data-testid=\"stat-total\">{stats.total}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-blue-500/10 rounded-lg\">\n                  <Info className=\"h-5 w-5 text-blue-600\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">ä¿¡æ¯</p>\n                  <p className=\"text-2xl font-bold\" data-testid=\"stat-info\">{stats.info}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-yellow-500/10 rounded-lg\">\n                  <AlertTriangle className=\"h-5 w-5 text-yellow-600\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">è­¦å‘Š</p>\n                  <p className=\"text-2xl font-bold\" data-testid=\"stat-warning\">{stats.warning}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 bg-destructive/10 rounded-lg\">\n                  <XCircle className=\"h-5 w-5 text-destructive\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">é”™è¯¯</p>\n                  <p className=\"text-2xl font-bold\" data-testid=\"stat-error\">{stats.error}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle>ç­›é€‰æ¡ä»¶</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"filter-event-id\">æ´»åŠ¨ID</Label>\n              <Input\n                id=\"filter-event-id\"\n                placeholder=\"è¾“å…¥æ´»åŠ¨ID...\"\n                value={eventIdFilter}\n                onChange={(e) => setEventIdFilter(e.target.value)}\n                data-testid=\"input-filter-event-id\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"filter-user-id\">ç”¨æˆ·ID</Label>\n              <Input\n                id=\"filter-user-id\"\n                placeholder=\"è¾“å…¥ç”¨æˆ·ID...\"\n                value={userIdFilter}\n                onChange={(e) => setUserIdFilter(e.target.value)}\n                data-testid=\"input-filter-user-id\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"filter-severity\">ä¸¥é‡ç¨‹åº¦</Label>\n              <Select value={severityFilter} onValueChange={setSeverityFilter}>\n                <SelectTrigger data-testid=\"select-filter-severity\">\n                  <SelectValue placeholder=\"é€‰æ‹©ä¸¥é‡ç¨‹åº¦\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">å…¨éƒ¨</SelectItem>\n                  <SelectItem value=\"info\">ä¿¡æ¯</SelectItem>\n                  <SelectItem value=\"warning\">è­¦å‘Š</SelectItem>\n                  <SelectItem value=\"error\">é”™è¯¯</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"filter-start-date\">å¼€å§‹æ—¥æœŸ</Label>\n              <Input\n                id=\"filter-start-date\"\n                type=\"datetime-local\"\n                value={startDate}\n                onChange={(e) => setStartDate(e.target.value)}\n                data-testid=\"input-filter-start-date\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"filter-end-date\">ç»“æŸæ—¥æœŸ</Label>\n              <Input\n                id=\"filter-end-date\"\n                type=\"datetime-local\"\n                value={endDate}\n                onChange={(e) => setEndDate(e.target.value)}\n                data-testid=\"input-filter-end-date\"\n              />\n            </div>\n\n            <div className=\"flex items-end\">\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setEventIdFilter(\"\");\n                  setUserIdFilter(\"\");\n                  setSeverityFilter(\"all\");\n                  setStartDate(\"\");\n                  setEndDate(\"\");\n                }}\n                data-testid=\"button-clear-filters\"\n                className=\"w-full\"\n              >\n                æ¸…é™¤ç­›é€‰\n              </Button>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Logs Table */}\n      <Card>\n        <CardHeader>\n          <CardTitle>æ—¥å¿—åˆ—è¡¨ ({logs.length})</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8\">\n              <div className=\"h-6 w-6 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n            </div>\n          ) : logs.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <FileText className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n              <p>æš‚æ— æ—¥å¿—</p>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full\">\n                <thead>\n                  <tr className=\"border-b\">\n                    <th className=\"text-left p-3 font-medium\">æ—¶é—´</th>\n                    <th className=\"text-left p-3 font-medium\">äº‹ä»¶ç±»å‹</th>\n                    <th className=\"text-left p-3 font-medium\">ä¸¥é‡ç¨‹åº¦</th>\n                    <th className=\"text-left p-3 font-medium\">æ¶ˆæ¯</th>\n                    <th className=\"text-left p-3 font-medium\">æ´»åŠ¨ID</th>\n                    <th className=\"text-left p-3 font-medium\">ç”¨æˆ·ID</th>\n                    <th className=\"text-left p-3 font-medium\">æ“ä½œ</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {logs.map((log) => {\n                    const config = severityConfig[log.severity] || severityConfig.info;\n                    const Icon = config.icon;\n\n                    return (\n                      <tr\n                        key={log.id}\n                        className=\"border-b hover-elevate transition-colors\"\n                        data-testid={`row-log-${log.id}`}\n                      >\n                        <td className=\"p-3 text-sm\">\n                          {format(new Date(log.createdAt), \"yyyy-MM-dd HH:mm:ss\")}\n                        </td>\n                        <td className=\"p-3 text-sm\">\n                          <code className=\"text-xs bg-muted px-2 py-1 rounded\">{log.eventType}</code>\n                        </td>\n                        <td className=\"p-3\">\n                          <Badge variant={config.variant} className=\"text-xs\">\n                            <Icon className=\"h-3 w-3 mr-1\" />\n                            {config.label}\n                          </Badge>\n                        </td>\n                        <td className=\"p-3 text-sm max-w-md truncate\">{log.message}</td>\n                        <td className=\"p-3 text-sm\">\n                          {log.eventId ? (\n                            <code className=\"text-xs bg-muted px-2 py-1 rounded\">{log.eventId.substring(0, 8)}...</code>\n                          ) : (\n                            <span className=\"text-muted-foreground\">-</span>\n                          )}\n                        </td>\n                        <td className=\"p-3 text-sm\">\n                          {log.userId ? (\n                            <code className=\"text-xs bg-muted px-2 py-1 rounded\">{log.userId.substring(0, 8)}...</code>\n                          ) : (\n                            <span className=\"text-muted-foreground\">-</span>\n                          )}\n                        </td>\n                        <td className=\"p-3\">\n                          <Button\n                            size=\"sm\"\n                            variant=\"ghost\"\n                            onClick={() => setSelectedLog(log)}\n                            data-testid={`button-view-log-${log.id}`}\n                          >\n                            æŸ¥çœ‹è¯¦æƒ…\n                          </Button>\n                        </td>\n                      </tr>\n                    );\n                  })}\n                </tbody>\n              </table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Log Details Dialog */}\n      <Dialog open={!!selectedLog} onOpenChange={(open) => !open && setSelectedLog(null)}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>æ—¥å¿—è¯¦æƒ…</DialogTitle>\n          </DialogHeader>\n\n          {selectedLog && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">æ—¶é—´</Label>\n                  <p className=\"text-sm mt-1\">\n                    {format(new Date(selectedLog.createdAt), \"yyyy-MM-dd HH:mm:ss\")}\n                  </p>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">ä¸¥é‡ç¨‹åº¦</Label>\n                  <div className=\"mt-1\">\n                    {(() => {\n                      const config = severityConfig[selectedLog.severity] || severityConfig.info;\n                      const Icon = config.icon;\n                      return (\n                        <Badge variant={config.variant} className=\"text-xs\">\n                          <Icon className=\"h-3 w-3 mr-1\" />\n                          {config.label}\n                        </Badge>\n                      );\n                    })()}\n                  </div>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">äº‹ä»¶ç±»å‹</Label>\n                  <p className=\"text-sm mt-1\">\n                    <code className=\"text-xs bg-muted px-2 py-1 rounded\">{selectedLog.eventType}</code>\n                  </p>\n                </div>\n                {selectedLog.eventId && (\n                  <div>\n                    <Label className=\"text-xs text-muted-foreground\">æ´»åŠ¨ID</Label>\n                    <p className=\"text-sm mt-1\">\n                      <code className=\"text-xs bg-muted px-2 py-1 rounded\">{selectedLog.eventId}</code>\n                    </p>\n                  </div>\n                )}\n                {selectedLog.userId && (\n                  <div>\n                    <Label className=\"text-xs text-muted-foreground\">ç”¨æˆ·ID</Label>\n                    <p className=\"text-sm mt-1\">\n                      <code className=\"text-xs bg-muted px-2 py-1 rounded\">{selectedLog.userId}</code>\n                    </p>\n                  </div>\n                )}\n                {selectedLog.threadId && (\n                  <div>\n                    <Label className=\"text-xs text-muted-foreground\">çº¿ç¨‹ID</Label>\n                    <p className=\"text-sm mt-1\">\n                      <code className=\"text-xs bg-muted px-2 py-1 rounded\">{selectedLog.threadId}</code>\n                    </p>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label className=\"text-xs text-muted-foreground\">æ¶ˆæ¯</Label>\n                <div className=\"bg-muted/50 rounded-lg p-4\">\n                  <p className=\"text-sm\">{selectedLog.message}</p>\n                </div>\n              </div>\n\n              {selectedLog.metadata && (\n                <div className=\"space-y-2\">\n                  <Label className=\"text-xs text-muted-foreground\">å…ƒæ•°æ®</Label>\n                  <div className=\"bg-muted/50 rounded-lg p-4 overflow-auto max-h-64\">\n                    <pre className=\"text-xs\">\n                      {JSON.stringify(selectedLog.metadata, null, 2)}\n                    </pre>\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":16978},"client/src/pages/admin/AdminReportsPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { AlertCircle, RefreshCw, Flag, UserX, MessageSquareWarning, Trash2 } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { format } from \"date-fns\";\n\ninterface ChatReport {\n  id: string;\n  messageId: string;\n  eventId?: string;\n  reportedBy: string;\n  reportedUserId: string;\n  reportType: string;\n  description?: string;\n  status: string;\n  reviewedBy?: string;\n  reviewNotes?: string;\n  actionTaken?: string;\n  createdAt: string;\n  reviewedAt?: string;\n  reporter?: { displayName?: string; firstName?: string };\n  reportedUser?: { displayName?: string; firstName?: string };\n  message?: { message: string };\n}\n\nconst reportTypeLabels: Record<string, string> = {\n  harassment: \"éªšæ‰°æˆ–å¨èƒ\",\n  spam: \"åƒåœ¾ä¿¡æ¯\",\n  inappropriate: \"ä¸å½“å†…å®¹\",\n  hate_speech: \"ä»‡æ¨è¨€è®º\",\n  other: \"å…¶ä»–\",\n};\n\nconst statusLabels: Record<string, { label: string; variant: \"default\" | \"secondary\" | \"destructive\" | \"outline\" }> = {\n  pending: { label: \"å¾…å¤„ç†\", variant: \"default\" },\n  reviewed: { label: \"å·²å¤„ç†\", variant: \"secondary\" },\n  dismissed: { label: \"å·²é©³å›\", variant: \"outline\" },\n  action_taken: { label: \"å·²å¤„ç†\", variant: \"secondary\" },\n};\n\nconst actionLabels: Record<string, string> = {\n  none: \"æ— æ“ä½œ\",\n  warning: \"è­¦å‘Šç”¨æˆ·\",\n  temporary_ban: \"ä¸´æ—¶å°ç¦\",\n  permanent_ban: \"æ°¸ä¹…å°ç¦\",\n  message_deleted: \"åˆ é™¤æ¶ˆæ¯\",\n};\n\nexport default function AdminReportsPage() {\n  const { toast } = useToast();\n  const [filterStatus, setFilterStatus] = useState<string>(\"all\");\n  const [selectedReport, setSelectedReport] = useState<ChatReport | null>(null);\n  const [reviewNotes, setReviewNotes] = useState(\"\");\n  const [actionTaken, setActionTaken] = useState(\"none\");\n\n  const { data: reports = [], isLoading, isError, error, refetch } = useQuery<ChatReport[]>({\n    queryKey: [\"/api/admin/chat-reports\", filterStatus === \"all\" ? undefined : { status: filterStatus }],\n    retry: 2,\n  });\n\n  const reviewMutation = useMutation({\n    mutationFn: async ({ id, status, reviewNotes, actionTaken }: {\n      id: string;\n      status: string;\n      reviewNotes?: string;\n      actionTaken?: string;\n    }) => {\n      return await apiRequest(\"PATCH\", `/api/admin/chat-reports/${id}`, {\n        status,\n        reviewNotes,\n        actionTaken,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/chat-reports\"] });\n      toast({\n        title: \"å¤„ç†æˆåŠŸ\",\n        description: \"ä¸¾æŠ¥å·²å¤„ç†\",\n      });\n      setSelectedReport(null);\n      setReviewNotes(\"\");\n      setActionTaken(\"none\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"å¤„ç†å¤±è´¥\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleReview = (status: string) => {\n    if (!selectedReport) return;\n    \n    reviewMutation.mutate({\n      id: selectedReport.id,\n      status,\n      reviewNotes: reviewNotes || undefined,\n      actionTaken: actionTaken !== \"none\" ? actionTaken : undefined,\n    });\n  };\n\n  const filteredReports = reports.filter(report => {\n    if (filterStatus === \"all\") return true;\n    if (filterStatus === \"pending\") return report.status === \"pending\";\n    if (filterStatus === \"reviewed\") return report.status === \"reviewed\" || report.status === \"action_taken\";\n    if (filterStatus === \"dismissed\") return report.status === \"dismissed\";\n    return true;\n  });\n\n  if (isError) {\n    return (\n      <div className=\"flex h-full items-center justify-center p-8\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6\">\n            <div className=\"space-y-4 text-center\">\n              <AlertCircle className=\"mx-auto h-12 w-12 text-destructive\" />\n              <div>\n                <h3 className=\"text-lg font-semibold\">åŠ è½½å¤±è´¥</h3>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  {error instanceof Error && error.message.includes(\"401\") \n                    ? \"æ‚¨æ²¡æœ‰è®¿é—®æƒé™\"\n                    : \"æ— æ³•åŠ è½½ä¸¾æŠ¥æ•°æ®ï¼Œè¯·ç¨åé‡è¯•\"}\n                </p>\n              </div>\n              <Button \n                onClick={() => refetch()} \n                variant=\"default\"\n                data-testid=\"button-retry-reports\"\n              >\n                <RefreshCw className=\"mr-2 h-4 w-4\" />\n                é‡è¯•\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">ä¸¾æŠ¥ç®¡ç†</h1>\n          <p className=\"text-muted-foreground mt-1\">æŸ¥çœ‹å’Œå¤„ç†ç”¨æˆ·ä¸¾æŠ¥</p>\n        </div>\n        <Button\n          variant=\"outline\"\n          size=\"sm\"\n          onClick={() => refetch()}\n          data-testid=\"button-refresh-reports\"\n        >\n          <RefreshCw className=\"h-4 w-4 mr-2\" />\n          åˆ·æ–°\n        </Button>\n      </div>\n\n      <Tabs value={filterStatus} onValueChange={setFilterStatus}>\n        <TabsList>\n          <TabsTrigger value=\"all\" data-testid=\"tab-reports-all\">\n            å…¨éƒ¨ ({reports.length})\n          </TabsTrigger>\n          <TabsTrigger value=\"pending\" data-testid=\"tab-reports-pending\">\n            å¾…å¤„ç† ({reports.filter(r => r.status === \"pending\").length})\n          </TabsTrigger>\n          <TabsTrigger value=\"reviewed\" data-testid=\"tab-reports-reviewed\">\n            å·²å¤„ç† ({reports.filter(r => r.status === \"reviewed\" || r.status === \"action_taken\").length})\n          </TabsTrigger>\n          <TabsTrigger value=\"dismissed\" data-testid=\"tab-reports-dismissed\">\n            å·²é©³å› ({reports.filter(r => r.status === \"dismissed\").length})\n          </TabsTrigger>\n        </TabsList>\n      </Tabs>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>ä¸¾æŠ¥åˆ—è¡¨</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8\">\n              <div className=\"h-6 w-6 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n            </div>\n          ) : filteredReports.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <Flag className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n              <p>æš‚æ— ä¸¾æŠ¥</p>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full\">\n                <thead>\n                  <tr className=\"border-b\">\n                    <th className=\"text-left p-3 font-medium\">ä¸¾æŠ¥æ—¶é—´</th>\n                    <th className=\"text-left p-3 font-medium\">ä¸¾æŠ¥äºº</th>\n                    <th className=\"text-left p-3 font-medium\">è¢«ä¸¾æŠ¥äºº</th>\n                    <th className=\"text-left p-3 font-medium\">æ¶ˆæ¯å†…å®¹</th>\n                    <th className=\"text-left p-3 font-medium\">ä¸¾æŠ¥ç±»å‹</th>\n                    <th className=\"text-left p-3 font-medium\">çŠ¶æ€</th>\n                    <th className=\"text-left p-3 font-medium\">æ“ä½œ</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {filteredReports.map((report) => (\n                    <tr\n                      key={report.id}\n                      className=\"border-b hover-elevate transition-colors cursor-pointer\"\n                      onClick={() => setSelectedReport(report)}\n                      data-testid={`row-report-${report.id}`}\n                    >\n                      <td className=\"p-3 text-sm\">\n                        {format(new Date(report.createdAt), \"yyyy-MM-dd HH:mm\")}\n                      </td>\n                      <td className=\"p-3 text-sm\">\n                        {report.reporter?.displayName || report.reporter?.firstName || \"æœªçŸ¥ç”¨æˆ·\"}\n                      </td>\n                      <td className=\"p-3 text-sm\">\n                        {report.reportedUser?.displayName || report.reportedUser?.firstName || \"æœªçŸ¥ç”¨æˆ·\"}\n                      </td>\n                      <td className=\"p-3 text-sm max-w-xs truncate\">\n                        {report.message?.message || \"æ¶ˆæ¯å·²åˆ é™¤\"}\n                      </td>\n                      <td className=\"p-3\">\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {reportTypeLabels[report.reportType] || report.reportType}\n                        </Badge>\n                      </td>\n                      <td className=\"p-3\">\n                        <Badge variant={statusLabels[report.status]?.variant || \"default\"} className=\"text-xs\">\n                          {statusLabels[report.status]?.label || report.status}\n                        </Badge>\n                      </td>\n                      <td className=\"p-3\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            setSelectedReport(report);\n                          }}\n                          data-testid={`button-view-report-${report.id}`}\n                        >\n                          æŸ¥çœ‹è¯¦æƒ…\n                        </Button>\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Report Details Dialog */}\n      <Dialog open={!!selectedReport} onOpenChange={(open) => !open && setSelectedReport(null)}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>ä¸¾æŠ¥è¯¦æƒ…</DialogTitle>\n            <DialogDescription>\n              æŸ¥çœ‹ä¸¾æŠ¥è¯¦æƒ…å¹¶é‡‡å–ç›¸åº”æªæ–½\n            </DialogDescription>\n          </DialogHeader>\n\n          {selectedReport && (\n            <div className=\"space-y-4\">\n              {/* Report info */}\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">ä¸¾æŠ¥æ—¶é—´</Label>\n                  <p className=\"text-sm mt-1\">\n                    {format(new Date(selectedReport.createdAt), \"yyyy-MM-dd HH:mm:ss\")}\n                  </p>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">ä¸¾æŠ¥ç±»å‹</Label>\n                  <p className=\"text-sm mt-1\">\n                    {reportTypeLabels[selectedReport.reportType] || selectedReport.reportType}\n                  </p>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">ä¸¾æŠ¥äºº</Label>\n                  <p className=\"text-sm mt-1\">\n                    {selectedReport.reporter?.displayName || selectedReport.reporter?.firstName || \"æœªçŸ¥ç”¨æˆ·\"}\n                  </p>\n                </div>\n                <div>\n                  <Label className=\"text-xs text-muted-foreground\">è¢«ä¸¾æŠ¥äºº</Label>\n                  <p className=\"text-sm mt-1\">\n                    {selectedReport.reportedUser?.displayName || selectedReport.reportedUser?.firstName || \"æœªçŸ¥ç”¨æˆ·\"}\n                  </p>\n                </div>\n              </div>\n\n              {/* Message content */}\n              <div className=\"space-y-2\">\n                <Label className=\"text-xs text-muted-foreground\">è¢«ä¸¾æŠ¥æ¶ˆæ¯</Label>\n                <div className=\"bg-muted/50 rounded-lg p-4\">\n                  <p className=\"text-sm\">{selectedReport.message?.message || \"æ¶ˆæ¯å·²åˆ é™¤\"}</p>\n                </div>\n              </div>\n\n              {/* Report description */}\n              {selectedReport.description && (\n                <div className=\"space-y-2\">\n                  <Label className=\"text-xs text-muted-foreground\">ä¸¾æŠ¥è¯´æ˜</Label>\n                  <div className=\"bg-muted/50 rounded-lg p-4\">\n                    <p className=\"text-sm\">{selectedReport.description}</p>\n                  </div>\n                </div>\n              )}\n\n              {/* Review section (only if pending) */}\n              {selectedReport.status === \"pending\" && (\n                <>\n                  <div className=\"border-t pt-4 space-y-4\">\n                    <div className=\"space-y-2\">\n                      <Label>é‡‡å–æªæ–½</Label>\n                      <RadioGroup value={actionTaken} onValueChange={setActionTaken}>\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"none\" id=\"action-none\" data-testid=\"radio-action-none\" />\n                          <Label htmlFor=\"action-none\" className=\"cursor-pointer\">æ— éœ€æ“ä½œ</Label>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"warning\" id=\"action-warning\" data-testid=\"radio-action-warning\" />\n                          <Label htmlFor=\"action-warning\" className=\"cursor-pointer\">è­¦å‘Šç”¨æˆ·</Label>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"message_deleted\" id=\"action-delete\" data-testid=\"radio-action-delete\" />\n                          <Label htmlFor=\"action-delete\" className=\"cursor-pointer\">åˆ é™¤æ¶ˆæ¯</Label>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"temporary_ban\" id=\"action-temp-ban\" data-testid=\"radio-action-temp-ban\" />\n                          <Label htmlFor=\"action-temp-ban\" className=\"cursor-pointer\">ä¸´æ—¶å°ç¦</Label>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"permanent_ban\" id=\"action-perm-ban\" data-testid=\"radio-action-perm-ban\" />\n                          <Label htmlFor=\"action-perm-ban\" className=\"cursor-pointer\">æ°¸ä¹…å°ç¦</Label>\n                        </div>\n                      </RadioGroup>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"review-notes\">ç®¡ç†å‘˜å¤‡æ³¨</Label>\n                      <Textarea\n                        id=\"review-notes\"\n                        placeholder=\"è®°å½•å¤„ç†è¯¦æƒ…...\"\n                        value={reviewNotes}\n                        onChange={(e) => setReviewNotes(e.target.value)}\n                        data-testid=\"textarea-review-notes\"\n                        rows={3}\n                      />\n                    </div>\n                  </div>\n\n                  <DialogFooter>\n                    <Button\n                      variant=\"outline\"\n                      onClick={() => handleReview(\"dismissed\")}\n                      disabled={reviewMutation.isPending}\n                      data-testid=\"button-dismiss-report\"\n                    >\n                      é©³å›ä¸¾æŠ¥\n                    </Button>\n                    <Button\n                      onClick={() => handleReview(actionTaken === \"none\" ? \"reviewed\" : \"action_taken\")}\n                      disabled={reviewMutation.isPending}\n                      data-testid=\"button-process-report\"\n                    >\n                      {reviewMutation.isPending ? \"å¤„ç†ä¸­...\" : \"ç¡®è®¤å¤„ç†\"}\n                    </Button>\n                  </DialogFooter>\n                </>\n              )}\n\n              {/* Already reviewed */}\n              {selectedReport.status !== \"pending\" && (\n                <div className=\"border-t pt-4 space-y-2\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <Label className=\"text-xs text-muted-foreground\">å¤„ç†çŠ¶æ€</Label>\n                      <p className=\"text-sm mt-1\">\n                        {statusLabels[selectedReport.status]?.label || selectedReport.status}\n                      </p>\n                    </div>\n                    {selectedReport.actionTaken && (\n                      <div>\n                        <Label className=\"text-xs text-muted-foreground\">é‡‡å–æªæ–½</Label>\n                        <p className=\"text-sm mt-1\">\n                          {actionLabels[selectedReport.actionTaken] || selectedReport.actionTaken}\n                        </p>\n                      </div>\n                    )}\n                    {selectedReport.reviewedAt && (\n                      <div>\n                        <Label className=\"text-xs text-muted-foreground\">å¤„ç†æ—¶é—´</Label>\n                        <p className=\"text-sm mt-1\">\n                          {format(new Date(selectedReport.reviewedAt), \"yyyy-MM-dd HH:mm:ss\")}\n                        </p>\n                      </div>\n                    )}\n                  </div>\n                  \n                  {selectedReport.reviewNotes && (\n                    <div className=\"space-y-2\">\n                      <Label className=\"text-xs text-muted-foreground\">ç®¡ç†å‘˜å¤‡æ³¨</Label>\n                      <div className=\"bg-muted/50 rounded-lg p-4\">\n                        <p className=\"text-sm\">{selectedReport.reviewNotes}</p>\n                      </div>\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":18211},"client/src/pages/admin/AdminFeedbackPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { AlertCircle, MessageSquare, TrendingUp, Eye, CheckCircle, XCircle, Users } from \"lucide-react\";\nimport { RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, ResponsiveContainer } from \"recharts\";\nimport { format } from \"date-fns\";\nimport { cn } from \"@/lib/utils\";\n\ninterface FeedbackStats {\n  totalFeedbacks: number;\n  avgAtmosphereScore: number;\n  lowRatedCount: number;\n  deepFeedbackRate: number;\n  topImprovementAreas: Array<{ area: string; count: number }>;\n  connectionStatusBreakdown: Record<string, number>;\n}\n\ninterface FeedbackDetail {\n  id: string;\n  eventId: string;\n  userId: string;\n  atmosphereScore: number | null;\n  atmosphereNote: string | null;\n  connectionRadar: {\n    topicResonance: number;\n    personalityMatch: number;\n    backgroundDiversity: number;\n    overallFit: number;\n  } | null;\n  hasNewConnections: boolean | null;\n  connectionStatus: string | null;\n  attendeeTraits: Record<string, {\n    displayName: string;\n    tags: string[];\n    needsImprovement: boolean;\n    improvementNote: string;\n  }> | null;\n  improvementAreas: string[] | null;\n  improvementOther: string | null;\n  hasDeepFeedback: boolean | null;\n  conversationBalance: number | null;\n  conversationComfort: number | null;\n  conversationNotes: string | null;\n  matchPointValidation: Record<string, {\n    discussed: string;\n    notes: string;\n  }> | null;\n  additionalMatchPoints: string | null;\n  futurePreferences: string[] | null;\n  futurePreferencesOther: string | null;\n  createdAt: Date;\n  user: {\n    displayName: string | null;\n    phoneNumber: string | null;\n  };\n  event: {\n    title: string;\n    dateTime: Date;\n    status: string | null;\n  };\n}\n\ninterface EventListItem {\n  id: string;\n  title: string;\n  dateTime: Date;\n  status: string | null;\n}\n\ninterface FeedbackListItem {\n  id: string;\n  eventId: string;\n  userId: string;\n  atmosphereScore: number | null;\n  atmosphereNote: string | null;\n  connectionStatus: string | null;\n  hasNewConnections: boolean | null;\n  hasDeepFeedback: boolean | null;\n  createdAt: Date;\n  user: {\n    displayName: string | null;\n    phoneNumber: string | null;\n  };\n  event: {\n    title: string;\n    dateTime: Date;\n    status: string | null;\n  };\n}\n\nexport default function AdminFeedbackPage() {\n  const [filters, setFilters] = useState({\n    eventId: \"\",\n    minRating: \"\",\n    maxRating: \"\",\n    startDate: \"\",\n    endDate: \"\",\n    hasDeepFeedback: undefined as boolean | undefined,\n  });\n\n  const [selectedFeedbackId, setSelectedFeedbackId] = useState<string | null>(null);\n\n  // Fetch feedback stats\n  const { data: stats } = useQuery<FeedbackStats>({\n    queryKey: [\"/api/admin/feedback/stats\"],\n  });\n\n  // Fetch all feedbacks with filters\n  const { data: feedbacks = [], isLoading } = useQuery<FeedbackListItem[]>({\n    queryKey: [\n      \"/api/admin/feedback\",\n      filters.eventId,\n      filters.minRating,\n      filters.maxRating,\n      filters.startDate,\n      filters.endDate,\n      filters.hasDeepFeedback,\n    ],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (filters.eventId) params.append(\"eventId\", filters.eventId);\n      if (filters.minRating) params.append(\"minRating\", filters.minRating);\n      if (filters.maxRating) params.append(\"maxRating\", filters.maxRating);\n      if (filters.startDate) params.append(\"startDate\", filters.startDate);\n      if (filters.endDate) params.append(\"endDate\", filters.endDate);\n      if (filters.hasDeepFeedback !== undefined) params.append(\"hasDeepFeedback\", String(filters.hasDeepFeedback));\n\n      const response = await fetch(`/api/admin/feedback?${params}`);\n      if (!response.ok) throw new Error(\"Failed to fetch feedbacks\");\n      return response.json();\n    },\n  });\n\n  // Fetch events for filter dropdown\n  const { data: events = [] } = useQuery<EventListItem[]>({\n    queryKey: [\"/api/admin/events\"],\n  });\n\n  // Fetch selected feedback details\n  const { data: selectedFeedback } = useQuery<FeedbackDetail>({\n    queryKey: [\"/api/admin/feedback\", selectedFeedbackId],\n    enabled: !!selectedFeedbackId,\n  });\n\n  const getAtmosphereColor = (score: number | null) => {\n    if (!score) return \"text-muted-foreground\";\n    if (score <= 2) return \"text-red-500\";\n    if (score === 3) return \"text-yellow-500\";\n    return \"text-green-500\";\n  };\n\n  const getAtmosphereLabel = (score: number | null) => {\n    if (!score) return \"æœªè¯„åˆ†\";\n    const labels = [\"\", \"å°´å°¬\", \"å¹³æ·¡\", \"èˆ’é€‚\", \"çƒ­çƒˆ\", \"å®Œç¾\"];\n    return labels[score] || \"æœªçŸ¥\";\n  };\n\n  const getConnectionStatusColor = (status: string | null) => {\n    switch (status) {\n      case \"å·²äº¤æ¢è”ç³»æ–¹å¼\":\n        return \"bg-green-500\";\n      case \"æœ‰ä½†è¿˜æ²¡è”ç³»\":\n        return \"bg-blue-500\";\n      case \"æ²¡æœ‰ä½†å¾ˆæ„‰å¿«\":\n        return \"bg-yellow-500\";\n      case \"æ²¡æœ‰ä¸å¤ªåˆé€‚\":\n        return \"bg-red-500\";\n      default:\n        return \"bg-gray-500\";\n    }\n  };\n\n  return (\n    <div className=\"space-y-6 p-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"heading-feedback-management\">åé¦ˆç®¡ç†</h1>\n        <p className=\"text-muted-foreground\">æŸ¥çœ‹å’Œåˆ†æç”¨æˆ·æ´»åŠ¨åé¦ˆ</p>\n      </div>\n\n      {/* Stats Cards */}\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <Card data-testid=\"card-total-feedbacks\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ€»åé¦ˆæ•°</CardTitle>\n            <MessageSquare className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{stats?.totalFeedbacks || 0}</div>\n            <p className=\"text-xs text-muted-foreground\">\n              å¹³å‡æ°›å›´è¯„åˆ†: <span className=\"font-medium\">{stats?.avgAtmosphereScore || 0}</span>/5\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-low-rated\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">ä½åˆ†é¢„è­¦</CardTitle>\n            <AlertCircle className=\"h-4 w-4 text-red-500\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-red-500\">{stats?.lowRatedCount || 0}</div>\n            <p className=\"text-xs text-muted-foreground\">æ°›å›´è¯„åˆ† &lt; 3 åˆ†çš„åé¦ˆ</p>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-deep-feedback-rate\">\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ·±åº¦åé¦ˆå®Œæˆç‡</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{stats?.deepFeedbackRate || 0}%</div>\n            <p className=\"text-xs text-muted-foreground\">ç”¨æˆ·æ·±åº¦åé¦ˆå‚ä¸åº¦</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Filters */}\n      <Card data-testid=\"card-filters\">\n        <CardHeader>\n          <CardTitle>ç­›é€‰æ¡ä»¶</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid gap-4 md:grid-cols-3\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"filter-event\">æ´»åŠ¨</Label>\n              <Select\n                value={filters.eventId}\n                onValueChange={(value) => setFilters({ ...filters, eventId: value })}\n              >\n                <SelectTrigger id=\"filter-event\" data-testid=\"select-filter-event\">\n                  <SelectValue placeholder=\"å…¨éƒ¨æ´»åŠ¨\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"\">å…¨éƒ¨æ´»åŠ¨</SelectItem>\n                  {events.map((event: any) => (\n                    <SelectItem key={event.id} value={event.id}>\n                      {event.title}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"filter-min-rating\">æœ€ä½è¯„åˆ†</Label>\n              <Select\n                value={filters.minRating}\n                onValueChange={(value) => setFilters({ ...filters, minRating: value })}\n              >\n                <SelectTrigger id=\"filter-min-rating\" data-testid=\"select-min-rating\">\n                  <SelectValue placeholder=\"ä¸é™\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"\">ä¸é™</SelectItem>\n                  {[1, 2, 3, 4, 5].map((rating) => (\n                    <SelectItem key={rating} value={String(rating)}>\n                      {rating} åˆ†\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"filter-max-rating\">æœ€é«˜è¯„åˆ†</Label>\n              <Select\n                value={filters.maxRating}\n                onValueChange={(value) => setFilters({ ...filters, maxRating: value })}\n              >\n                <SelectTrigger id=\"filter-max-rating\" data-testid=\"select-max-rating\">\n                  <SelectValue placeholder=\"ä¸é™\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"\">ä¸é™</SelectItem>\n                  {[1, 2, 3, 4, 5].map((rating) => (\n                    <SelectItem key={rating} value={String(rating)}>\n                      {rating} åˆ†\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"filter-start-date\">å¼€å§‹æ—¥æœŸ</Label>\n              <Input\n                id=\"filter-start-date\"\n                type=\"date\"\n                value={filters.startDate}\n                onChange={(e) => setFilters({ ...filters, startDate: e.target.value })}\n                data-testid=\"input-start-date\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"filter-end-date\">ç»“æŸæ—¥æœŸ</Label>\n              <Input\n                id=\"filter-end-date\"\n                type=\"date\"\n                value={filters.endDate}\n                onChange={(e) => setFilters({ ...filters, endDate: e.target.value })}\n                data-testid=\"input-end-date\"\n              />\n            </div>\n\n            <div className=\"flex items-center space-x-2 pt-8\">\n              <Switch\n                id=\"filter-deep-feedback\"\n                checked={filters.hasDeepFeedback || false}\n                onCheckedChange={(checked) =>\n                  setFilters({ ...filters, hasDeepFeedback: checked ? true : undefined })\n                }\n                data-testid=\"switch-deep-feedback\"\n              />\n              <Label htmlFor=\"filter-deep-feedback\">ä»…æ˜¾ç¤ºæ·±åº¦åé¦ˆ</Label>\n            </div>\n          </div>\n\n          <div className=\"mt-4 flex gap-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() =>\n                setFilters({\n                  eventId: \"\",\n                  minRating: \"\",\n                  maxRating: \"\",\n                  startDate: \"\",\n                  endDate: \"\",\n                  hasDeepFeedback: undefined,\n                })\n              }\n              data-testid=\"button-clear-filters\"\n            >\n              æ¸…é™¤ç­›é€‰\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Top Improvement Areas */}\n      {stats?.topImprovementAreas && stats.topImprovementAreas.length > 0 && (\n        <Card data-testid=\"card-top-improvements\">\n          <CardHeader>\n            <CardTitle>æœ€å¸¸è§çš„æ”¹è¿›å»ºè®® (Top 5)</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {stats.topImprovementAreas.map((item: any, index: number) => (\n                <div key={index} className=\"space-y-1\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm font-medium\">{item.area}</span>\n                    <span className=\"text-sm text-muted-foreground\">{item.count} æ¬¡</span>\n                  </div>\n                  <Progress\n                    value={(item.count / stats.totalFeedbacks) * 100}\n                    className=\"h-2\"\n                    data-testid={`progress-improvement-${index}`}\n                  />\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Feedback Table */}\n      <Card data-testid=\"card-feedback-table\">\n        <CardHeader>\n          <CardTitle>åé¦ˆåˆ—è¡¨</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8\">åŠ è½½ä¸­...</div>\n          ) : feedbacks.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">æš‚æ— åé¦ˆæ•°æ®</div>\n          ) : (\n            <div className=\"rounded-md border\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>æ´»åŠ¨åç§°</TableHead>\n                    <TableHead>ç”¨æˆ·</TableHead>\n                    <TableHead>æ°›å›´è¯„åˆ†</TableHead>\n                    <TableHead>è¿æ¥çŠ¶æ€</TableHead>\n                    <TableHead>æäº¤æ—¶é—´</TableHead>\n                    <TableHead>æ“ä½œ</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {feedbacks.map((feedback: any) => (\n                    <TableRow\n                      key={feedback.id}\n                      className={cn(\n                        \"cursor-pointer hover-elevate\",\n                        feedback.atmosphereScore && feedback.atmosphereScore < 3 && \"bg-red-50 dark:bg-red-950/20\"\n                      )}\n                      onClick={() => setSelectedFeedbackId(feedback.id)}\n                      data-testid={`row-feedback-${feedback.id}`}\n                    >\n                      <TableCell className=\"font-medium\">{feedback.event.title}</TableCell>\n                      <TableCell>\n                        {feedback.user.displayName || \"æœªè®¾ç½®\"}\n                        <div className=\"text-xs text-muted-foreground\">{feedback.user.phoneNumber}</div>\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex items-center gap-2\">\n                          <span\n                            className={cn(\"text-2xl font-bold\", getAtmosphereColor(feedback.atmosphereScore))}\n                            data-testid={`text-atmosphere-score-${feedback.id}`}\n                          >\n                            {feedback.atmosphereScore || \"-\"}\n                          </span>\n                          <span className=\"text-sm text-muted-foreground\">\n                            {getAtmosphereLabel(feedback.atmosphereScore)}\n                          </span>\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        {feedback.connectionStatus ? (\n                          <Badge\n                            className={cn(\"text-white\", getConnectionStatusColor(feedback.connectionStatus))}\n                            data-testid={`badge-connection-status-${feedback.id}`}\n                          >\n                            {feedback.connectionStatus}\n                          </Badge>\n                        ) : (\n                          <span className=\"text-muted-foreground\">-</span>\n                        )}\n                      </TableCell>\n                      <TableCell className=\"text-sm\">\n                        {feedback.createdAt ? format(new Date(feedback.createdAt), \"yyyy-MM-dd HH:mm\") : \"-\"}\n                      </TableCell>\n                      <TableCell>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            setSelectedFeedbackId(feedback.id);\n                          }}\n                          data-testid={`button-view-feedback-${feedback.id}`}\n                        >\n                          <Eye className=\"h-4 w-4 mr-1\" />\n                          æŸ¥çœ‹è¯¦æƒ…\n                        </Button>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Feedback Detail Dialog */}\n      <Dialog open={!!selectedFeedbackId} onOpenChange={() => setSelectedFeedbackId(null)}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-feedback-detail\">\n          <DialogHeader>\n            <DialogTitle>åé¦ˆè¯¦æƒ…</DialogTitle>\n          </DialogHeader>\n\n          {selectedFeedback && (\n            <div className=\"space-y-6\">\n              {/* Basic Info */}\n              <div className=\"grid gap-4 md:grid-cols-2\">\n                <div>\n                  <Label className=\"text-muted-foreground\">æ´»åŠ¨åç§°</Label>\n                  <p className=\"font-medium\">{selectedFeedback.event.title}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">æ´»åŠ¨æ—¥æœŸ</Label>\n                  <p className=\"font-medium\">\n                    {format(new Date(selectedFeedback.event.dateTime), \"yyyy-MM-dd HH:mm\")}\n                  </p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">ç”¨æˆ·å§“å</Label>\n                  <p className=\"font-medium\">{selectedFeedback.user.displayName || \"æœªè®¾ç½®\"}</p>\n                </div>\n                <div>\n                  <Label className=\"text-muted-foreground\">æäº¤æ—¶é—´</Label>\n                  <p className=\"font-medium\">\n                    {selectedFeedback.createdAt\n                      ? format(new Date(selectedFeedback.createdAt), \"yyyy-MM-dd HH:mm\")\n                      : \"-\"}\n                  </p>\n                </div>\n              </div>\n\n              <Separator />\n\n              {/* Atmosphere Score */}\n              <div className=\"space-y-3\" data-testid=\"section-atmosphere-score\">\n                <h3 className=\"text-lg font-semibold\">æ°›å›´è¯„åˆ†</h3>\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm\">å°´å°¬</span>\n                    <span className=\"text-sm\">å®Œç¾</span>\n                  </div>\n                  <div className=\"relative\">\n                    <Progress value={(selectedFeedback.atmosphereScore || 0) * 20} className=\"h-4\" />\n                    <div className=\"absolute inset-0 flex items-center justify-center text-xs font-medium\">\n                      {selectedFeedback.atmosphereScore || 0} / 5 -{\" \"}\n                      {getAtmosphereLabel(selectedFeedback.atmosphereScore)}\n                    </div>\n                  </div>\n                  {selectedFeedback.atmosphereNote && (\n                    <p className=\"text-sm text-muted-foreground italic\">\"{selectedFeedback.atmosphereNote}\"</p>\n                  )}\n                </div>\n              </div>\n\n              <Separator />\n\n              {/* Connection Radar */}\n              {selectedFeedback.connectionRadar && (\n                <>\n                  <div className=\"space-y-3\" data-testid=\"section-connection-radar\">\n                    <h3 className=\"text-lg font-semibold\">è¿æ¥é›·è¾¾å›¾</h3>\n                    <div className=\"h-64\">\n                      <ResponsiveContainer width=\"100%\" height=\"100%\">\n                        <RadarChart\n                          data={[\n                            {\n                              dimension: \"è¯é¢˜å…±é¸£\",\n                              value: selectedFeedback.connectionRadar.topicResonance || 0,\n                            },\n                            {\n                              dimension: \"æ€§æ ¼åŒ¹é…\",\n                              value: selectedFeedback.connectionRadar.personalityMatch || 0,\n                            },\n                            {\n                              dimension: \"èƒŒæ™¯å¤šæ ·æ€§\",\n                              value: selectedFeedback.connectionRadar.backgroundDiversity || 0,\n                            },\n                            {\n                              dimension: \"æ•´ä½“å¥‘åˆ\",\n                              value: selectedFeedback.connectionRadar.overallFit || 0,\n                            },\n                          ]}\n                        >\n                          <PolarGrid />\n                          <PolarAngleAxis dataKey=\"dimension\" />\n                          <PolarRadiusAxis domain={[0, 5]} />\n                          <Radar name=\"è¯„åˆ†\" dataKey=\"value\" stroke=\"hsl(var(--primary))\" fill=\"hsl(var(--primary))\" fillOpacity={0.6} />\n                        </RadarChart>\n                      </ResponsiveContainer>\n                    </div>\n                  </div>\n                  <Separator />\n                </>\n              )}\n\n              {/* Connection Status */}\n              <div className=\"space-y-3\">\n                <h3 className=\"text-lg font-semibold\">è¿æ¥çŠ¶æ€</h3>\n                <div className=\"flex items-center gap-4\">\n                  {selectedFeedback.connectionStatus && (\n                    <Badge\n                      className={cn(\"text-white\", getConnectionStatusColor(selectedFeedback.connectionStatus))}\n                    >\n                      {selectedFeedback.connectionStatus}\n                    </Badge>\n                  )}\n                  {selectedFeedback.hasNewConnections !== null && (\n                    <div className=\"flex items-center gap-2\">\n                      {selectedFeedback.hasNewConnections ? (\n                        <CheckCircle className=\"h-5 w-5 text-green-500\" />\n                      ) : (\n                        <XCircle className=\"h-5 w-5 text-red-500\" />\n                      )}\n                      <span className=\"text-sm\">\n                        {selectedFeedback.hasNewConnections ? \"æœ‰æ–°è¿æ¥\" : \"æ— æ–°è¿æ¥\"}\n                      </span>\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              <Separator />\n\n              {/* Attendee Traits */}\n              {selectedFeedback.attendeeTraits && Object.keys(selectedFeedback.attendeeTraits).length > 0 && (\n                <>\n                  <div className=\"space-y-3\" data-testid=\"section-attendee-traits\">\n                    <h3 className=\"text-lg font-semibold\">å‚ä¸è€…å°è±¡æ ‡ç­¾</h3>\n                    <div className=\"grid gap-4 md:grid-cols-2\">\n                      {Object.entries(selectedFeedback.attendeeTraits).map(([userId, data]: [string, any]) => (\n                        <Card key={userId}>\n                          <CardHeader className=\"pb-3\">\n                            <CardTitle className=\"text-sm flex items-center gap-2\">\n                              <Users className=\"h-4 w-4\" />\n                              {data.displayName}\n                            </CardTitle>\n                          </CardHeader>\n                          <CardContent className=\"space-y-2\">\n                            {data.tags && data.tags.length > 0 && (\n                              <div className=\"flex flex-wrap gap-1\">\n                                {data.tags.map((tag: string, idx: number) => (\n                                  <Badge key={idx} variant=\"secondary\">\n                                    {tag}\n                                  </Badge>\n                                ))}\n                              </div>\n                            )}\n                            {data.needsImprovement && data.improvementNote && (\n                              <div className=\"mt-2 p-2 bg-yellow-50 dark:bg-yellow-950/20 rounded-md\">\n                                <p className=\"text-xs text-muted-foreground\">æ”¹è¿›å»ºè®®ï¼š</p>\n                                <p className=\"text-sm\">{data.improvementNote}</p>\n                              </div>\n                            )}\n                          </CardContent>\n                        </Card>\n                      ))}\n                    </div>\n                  </div>\n                  <Separator />\n                </>\n              )}\n\n              {/* Improvement Suggestions */}\n              {(selectedFeedback.improvementAreas || selectedFeedback.improvementOther) && (\n                <>\n                  <div className=\"space-y-3\" data-testid=\"section-improvements\">\n                    <h3 className=\"text-lg font-semibold\">æ”¹è¿›å»ºè®®</h3>\n                    {selectedFeedback.improvementAreas && selectedFeedback.improvementAreas.length > 0 && (\n                      <div className=\"flex flex-wrap gap-2\">\n                        {selectedFeedback.improvementAreas.map((area: string, idx: number) => (\n                          <Badge key={idx} variant=\"outline\">\n                            {area}\n                          </Badge>\n                        ))}\n                      </div>\n                    )}\n                    {selectedFeedback.improvementOther && (\n                      <div className=\"p-3 bg-muted rounded-md\">\n                        <p className=\"text-sm font-medium mb-1\">è‡ªå®šä¹‰å»ºè®®ï¼š</p>\n                        <p className=\"text-sm\">{selectedFeedback.improvementOther}</p>\n                      </div>\n                    )}\n                  </div>\n                  <Separator />\n                </>\n              )}\n\n              {/* Deep Feedback Section */}\n              {selectedFeedback.hasDeepFeedback && (\n                <div className=\"space-y-4 p-4 bg-primary/5 rounded-lg\" data-testid=\"section-deep-feedback\">\n                  <h3 className=\"text-lg font-semibold flex items-center gap-2\">\n                    <TrendingUp className=\"h-5 w-5\" />\n                    æ·±åº¦åé¦ˆ\n                  </h3>\n\n                  {/* Conversation Balance */}\n                  {selectedFeedback.conversationBalance !== null && selectedFeedback.conversationBalance !== undefined && (\n                    <div className=\"space-y-2\">\n                      <Label>å¯¹è¯å¹³è¡¡åº¦</Label>\n                      <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                        <span>å…¨æ˜¯ä»–ä»¬è¯´</span>\n                        <span>å¹³è¡¡</span>\n                        <span>å…¨æ˜¯æˆ‘è¯´</span>\n                      </div>\n                      <Progress value={selectedFeedback.conversationBalance} className=\"h-3\" />\n                      <p className=\"text-sm text-center\">{selectedFeedback.conversationBalance}%</p>\n                    </div>\n                  )}\n\n                  {/* Conversation Comfort */}\n                  {selectedFeedback.conversationComfort !== null && selectedFeedback.conversationComfort !== undefined && (\n                    <div className=\"space-y-2\">\n                      <Label>å¯¹è¯èˆ’é€‚åº¦</Label>\n                      <Progress value={selectedFeedback.conversationComfort} className=\"h-3\" />\n                      <p className=\"text-sm text-center\">{selectedFeedback.conversationComfort}%</p>\n                    </div>\n                  )}\n\n                  {/* Conversation Notes */}\n                  {selectedFeedback.conversationNotes && (\n                    <div className=\"space-y-2\">\n                      <Label>å¯¹è¯å¤‡æ³¨</Label>\n                      <p className=\"text-sm p-2 bg-background rounded-md\">{selectedFeedback.conversationNotes}</p>\n                    </div>\n                  )}\n\n                  {/* Match Point Validation */}\n                  {selectedFeedback.matchPointValidation && (\n                    <div className=\"space-y-2\">\n                      <Label>åŒ¹é…ç‚¹éªŒè¯</Label>\n                      <div className=\"rounded-md border overflow-hidden\">\n                        <Table>\n                          <TableHeader>\n                            <TableRow>\n                              <TableHead>åŒ¹é…ç‚¹</TableHead>\n                              <TableHead>è®¨è®ºæ·±åº¦</TableHead>\n                              <TableHead>å¤‡æ³¨</TableHead>\n                            </TableRow>\n                          </TableHeader>\n                          <TableBody>\n                            {Object.entries(selectedFeedback.matchPointValidation).map(([point, data]: [string, any]) => (\n                              <TableRow key={point}>\n                                <TableCell className=\"font-medium\">{point}</TableCell>\n                                <TableCell>\n                                  <Badge variant={data.discussed === \"deeply\" ? \"default\" : data.discussed === \"briefly\" ? \"secondary\" : \"outline\"}>\n                                    {data.discussed === \"deeply\" ? \"æ·±å…¥è®¨è®º\" : data.discussed === \"briefly\" ? \"ç®€çŸ­æåŠ\" : \"æœªè®¨è®º\"}\n                                  </Badge>\n                                </TableCell>\n                                <TableCell className=\"text-sm\">{data.notes || \"-\"}</TableCell>\n                              </TableRow>\n                            ))}\n                          </TableBody>\n                        </Table>\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Additional Match Points */}\n                  {selectedFeedback.additionalMatchPoints && (\n                    <div className=\"space-y-2\">\n                      <Label>é¢å¤–åŒ¹é…ç‚¹</Label>\n                      <p className=\"text-sm p-2 bg-background rounded-md\">{selectedFeedback.additionalMatchPoints}</p>\n                    </div>\n                  )}\n\n                  {/* Future Preferences */}\n                  {selectedFeedback.futurePreferences && selectedFeedback.futurePreferences.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <Label>æœªæ¥åå¥½</Label>\n                      <div className=\"flex flex-wrap gap-2\">\n                        {selectedFeedback.futurePreferences.map((pref: string, idx: number) => (\n                          <Badge key={idx} variant=\"secondary\">\n                            {pref}\n                          </Badge>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {selectedFeedback.futurePreferencesOther && (\n                    <div className=\"space-y-2\">\n                      <Label>è‡ªå®šä¹‰åå¥½</Label>\n                      <p className=\"text-sm p-2 bg-background rounded-md\">{selectedFeedback.futurePreferencesOther}</p>\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":32140},"QUICK_REFERENCE.md":{"content":"# JoyJoin Quick Reference Guide\n\n**For rapid onboarding and daily development reference**\n\n---\n\n## ğŸš€ Getting Started (5 Minutes)\n\n### Local Setup\n```bash\ngit clone <repo>\nnpm install\nnpm run db:push          # Sync database schema\nnpm run dev              # Start on http://localhost:5000\n```\n\n### Admin Access\n- **URL:** http://localhost:5000/admin\n- **Phone:** 19896500978\n- **Password:** Lasalle11\n\n### Test User Flow\n1. Go to `/register`\n2. Enter any phone (SMS bypassed in dev)\n3. Complete profile â†’ Take personality test â†’ Browse events\n\n---\n\n## ğŸ“‚ Essential Files (Top 10)\n\n| File | Purpose | Lines |\n|------|---------|-------|\n| `server/routes.ts` | All API endpoints | 3,400+ |\n| `shared/schema.ts` | Database schema | 3,000+ |\n| `server/userMatchingService.ts` | Matching algorithm | 500+ |\n| `client/src/pages/PersonalityTestPage.tsx` | 10-question test | 530 |\n| `client/src/pages/admin/AdminDataInsightsPage.tsx` | Analytics dashboard | 800+ |\n| `server/paymentService.ts` | WeChat Pay integration | 300 |\n| `server/wsService.ts` | WebSocket real-time sync | 250 |\n| `client/src/lib/archetypes.ts` | 14 archetype configs | 143 |\n| `replit.md` | Project architecture | - |\n| `PRODUCT_REQUIREMENTS.md` | Full PRD | 2,000+ |\n\n---\n\n## ğŸ­ 14 Personality Archetypes\n\n### 8 Core (Mapped in Test)\n1. ğŸ™Œ **ç«èŠ±å¡ (Spark Plug)** - Energizer, icebreaker\n2. ğŸ§­ **æ¢ç´¢è€… (Explorer)** - Curious, deep thinker\n3. ğŸ“– **æ•…äº‹å®¶ (Storyteller)** - Shares experiences\n4. âš¡ **æŒ‘æˆ˜è€… (Challenger)** - Critical thinker, debater\n5. ğŸ¤ **è¿æ¥è€… (Connector)** - Social bridge\n6. ğŸ¯ **åè°ƒè€… (Coordinator)** - Mediator\n7. ğŸ­ **æ°›å›´ç»„ (Vibe Keeper)** - Humor, energy\n8. ğŸŒŸ **è‚¯å®šè€… (Affirmer)** - Encourager, supporter\n\n### 6 Extended (Configured, Not Mapped)\n9. ğŸ¦‰ æ™ºè€… (Sage)\n10. ğŸ›¡ï¸ å®ˆæŠ¤è€… (Guardian)\n11. ğŸŒˆ æ¢¦æƒ³å®¶ (Dreamer)\n12. ğŸ¨ è‰ºæœ¯å®¶ (Artist)\n13. ğŸ“‹ ç»„ç»‡è€… (Organizer)\n14. ğŸ”§ å®å¹²å®¶ (Pragmatist)\n\n---\n\n## ğŸ§® Personality Test Quick Facts\n\n- **Questions:** 10 total\n  - 6 single-choice (2 points)\n  - 4 dual-choice (2 + 1 points)\n- **Max Score:** 24 points distributed\n- **Calculation:** Highest score = Primary, 2nd = Secondary\n- **6 Dimensions:** Affinity, Openness, Conscientiousness, Emotional Stability, Extraversion, Positivity\n- **Blending:** 70% Primary + 30% Secondary\n\n---\n\n## ğŸ”€ 5-Dimensional Matching Algorithm\n\n**Default Weights:**\n```typescript\n{\n  personality: 40%,    // Chemistry matrix score\n  interests: 25%,      // Jaccard similarity of tags\n  background: 15%,     // Education/career alignment\n  conversation: 10%,   // Openness + Extraversion\n  intent: 10%          // Why they joined\n}\n```\n\n**File:** `server/userMatchingService.ts`\n\n**Test in Admin:** `/admin/matching-lab`\n\n---\n\n## ğŸ’³ Payment & Subscription\n\n### Tiers\n- **æœˆåº¦ä¼šå‘˜:** Â¥98/month\n- **å­£åº¦ä¼šå‘˜:** Â¥294/3 months (15% discount)\n- **å•æ¬¡ç¥¨:** Â¥148/event\n\n### WeChat Pay Flow\n```\nUser clicks pay â†’ Backend creates payment record\nâ†’ WeChat JSAPI â†’ User pays\nâ†’ Webhook validates â†’ Update subscription\nâ†’ WebSocket notifies user\n```\n\n**File:** `server/paymentService.ts`\n\n---\n\n## ğŸ“Š Event Lifecycle\n\n```\ndraft â†’ matching â†’ registration_open â†’ confirmed \nâ†’ in_progress â†’ completed\n     â†“ (can cancel at any stage)\n  cancelled\n```\n\n### Status Actions\n- **matching:** AI finding participants\n- **registration_open:** Accepting sign-ups\n- **confirmed:** Min attendees met, venue booked\n- **in_progress:** Event day (chat enabled)\n- **completed:** Feedback unlocked\n\n---\n\n## ğŸ’¬ Chat System\n\n### Event Group Chat\n- **Access:** Payment completed + Event in_progress\n- **Real-time:** WebSocket (100ms latency)\n- **Features:** Mentions, typing indicators, read receipts\n- **File:** `client/src/pages/EventChatDetailPage.tsx`\n\n### Direct Messages\n- **Access:** Must have attended same event\n- **Schema:** `direct_message_threads` + `direct_messages`\n\n### Moderation\n- **Reports:** User-submitted + auto-flagged\n- **Actions:** Delete, warn, mute (24h), ban\n- **Admin:** `/admin/moderation`\n\n---\n\n## ğŸ“ˆ Admin Portal Pages (18)\n\n| Page | Route | Purpose |\n|------|-------|---------|\n| Dashboard | `/admin` | Key metrics + activity feed |\n| Users | `/admin/users` | User management |\n| Subscriptions | `/admin/subscriptions` | Subscription records |\n| Coupons | `/admin/coupons` | Discount codes |\n| Venues | `/admin/venues` | Partner venues |\n| Templates | `/admin/event-templates` | Reusable event configs |\n| Events | `/admin/events` | Event oversight |\n| Finance | `/admin/finance` | Revenue + payments |\n| **Data Insights** | `/admin/data-insights` | **7 analytics modules** |\n| Feedback | `/admin/feedback` | User feedback review |\n| Matching Lab | `/admin/matching-lab` | Algorithm tuning |\n| Content | `/admin/content` | CMS (announcements) |\n| Notifications | `/admin/notifications` | Push broadcasts |\n| Moderation | `/admin/moderation` | Chat reports |\n| Reports | `/admin/reports` | User reports |\n| Chat Logs | `/admin/chat-logs` | Audit trail |\n\n---\n\n## ğŸ¯ Data Insights Modules (7)\n\n**File:** `client/src/pages/admin/AdminDataInsightsPage.tsx`\n\n1. **User Scale** - Total users, DAU/MAU, acquisition funnel\n2. **Business Health** - MRR, ARR, churn rate, LTV\n3. **Matching Efficiency** - Match scores, fill rates, algorithm performance\n4. **User Retention** - Cohort analysis, engagement, reactivation\n5. **Activity Quality** - Atmosphere scores, NPS, connection depth\n6. **Revenue Funnel** - Conversion rates, optimization opportunities\n7. **Social Role Distribution** - Archetype analytics, pairing success\n\n---\n\n## ğŸ”— Key API Endpoints\n\n### User Authentication\n```\nPOST /api/phone/register        # Send SMS\nPOST /api/phone/verify          # Verify code\nPOST /api/phone/login           # Login\n```\n\n### Personality Test\n```\nPOST /api/personality-test/submit       # Submit answers\nGET  /api/personality-test/results      # Get results\nGET  /api/personality-test/stats        # Archetype distribution\n```\n\n### Events\n```\nGET  /api/events                # List events\nGET  /api/events/:id            # Event details\nPOST /api/events/:id/register   # Register for event\n```\n\n### Payments\n```\nPOST /api/payments/create       # Create payment\nPOST /api/coupons/validate      # Validate coupon\n```\n\n### Admin\n```\nGET  /api/admin/stats                      # Dashboard metrics\nGET  /api/admin/users                      # List users\nPOST /api/admin/events                     # Create event\nGET  /api/admin/feedbacks                  # List feedbacks\nGET  /api/admin/data-insights              # Analytics data\nPOST /api/admin/matching/test              # Test matching\nPOST /api/admin/notifications/broadcast    # Send notification\n```\n\n**Full list:** See `server/routes.ts`\n\n---\n\n## ğŸ’¾ Database Tables (Top 10)\n\n1. **users** - User profiles + personality\n2. **events** - Event listings\n3. **event_attendance** - User-event registrations\n4. **event_feedback** - Post-event feedback\n5. **subscriptions** - Subscription records\n6. **payments** - Payment transactions\n7. **venues** - Partner venues\n8. **chat_messages** - Event group chat\n9. **event_templates** - Reusable configs\n10. **contents** - CMS content\n\n**Full schema:** See `shared/schema.ts`\n\n---\n\n## ğŸŒ WebSocket Messages\n\n### User App\n```typescript\n'chat_message'             // Real-time chat\n'event_updated'            // Event status change\n'new_connection'           // Connection request\n'subscription_activated'   // Payment confirmed\n```\n\n### Admin\n```typescript\n'new_user_registered'      // User signed up\n'payment_completed'        // Payment received\n'chat_report_filed'        // Message reported\n'event_filled'             // Event reached capacity\n```\n\n**File:** `server/wsService.ts`\n\n---\n\n## ğŸ› ï¸ Common Dev Tasks\n\n### Add New API Endpoint\n1. Edit `server/routes.ts`\n2. Add route handler\n3. Update storage if needed (`server/storage.ts`)\n4. Test with frontend\n\n### Add New Admin Page\n1. Create `client/src/pages/admin/AdminXyzPage.tsx`\n2. Add route to `client/src/App.tsx`\n3. Add to AdminSidebar navigation\n4. Protect with `requireAdmin` middleware\n\n### Modify Database Schema\n1. Edit `shared/schema.ts`\n2. Run `npm run db:push` (or `--force` if needed)\n3. Update TypeScript types if needed\n4. Test migrations\n\n### Update Matching Algorithm\n1. Edit `server/userMatchingService.ts`\n2. Adjust weights or chemistry matrix\n3. Test in Matching Lab (`/admin/matching-lab`)\n4. Deploy gradually (A/B test)\n\n---\n\n## ğŸ› Debugging Tips\n\n### Common Issues\n\n**\"Port 5000 already in use\"**\n```bash\npkill -f node\nnpm run dev\n```\n\n**\"Session not persisting\"**\n- Check `DATABASE_URL` is set\n- Verify session table exists\n- Check cookie settings\n\n**\"Payment webhook failing\"**\n- Verify WeChat Pay signature\n- Check `WECHAT_PAY_API_KEY`\n- Test with WeChat sandbox\n\n**\"WebSocket not connecting\"**\n- Check firewall rules\n- Verify WSS (not WS) in production\n- Check auth token in connection\n\n### Debug Tools\n- **Database:** Use `execute_sql_tool` or `/api/admin` routes\n- **Logs:** Check Replit workflow logs\n- **Network:** Browser DevTools â†’ Network tab\n- **State:** React Query DevTools\n\n---\n\n## ğŸ“± Frontend Tech Stack\n\n- **React 18** - UI framework\n- **TypeScript** - Type safety\n- **Vite** - Build tool\n- **Wouter** - Routing (lightweight)\n- **TanStack Query v5** - Server state\n- **shadcn/ui** - Component library\n- **Tailwind CSS** - Styling\n- **Recharts** - Charts\n- **Framer Motion** - Animations\n\n**Config:** `vite.config.ts`, `tailwind.config.ts`\n\n---\n\n## ğŸ” Security Checklist\n\n- [x] Phone auth with SMS verification\n- [x] bcrypt password hashing\n- [x] Session-based authentication (7-day TTL)\n- [x] Admin role checking (`requireAdmin`)\n- [x] Payment webhook signature verification\n- [x] Chat message reporting system\n- [x] All moderation actions logged\n- [x] WebSocket auth via token\n- [x] SQL injection prevention (Drizzle ORM)\n\n---\n\n## ğŸ“¦ Environment Variables\n\n```bash\n# Database\nDATABASE_URL=postgresql://...\n\n# Session\nSESSION_SECRET=random_secret_here\n\n# WeChat Pay\nWECHAT_PAY_APP_ID=wx...\nWECHAT_PAY_MCH_ID=...\nWECHAT_PAY_API_KEY=...\n\n# Node\nNODE_ENV=production\n```\n\n---\n\n## ğŸš¢ Deployment\n\n**Build:**\n```bash\nnpm run build\n```\n\n**Start:**\n```bash\nnpm run dev  # Development\nnpm start    # Production\n```\n\n**Database Migration:**\n```bash\nnpm run db:push        # Sync schema\nnpm run db:push --force # Force sync (use carefully)\n```\n\n---\n\n## ğŸ“Š Key Metrics to Monitor\n\n### Daily\n- DAU (Daily Active Users)\n- Payment completion rate\n- Event fill rate\n- Average atmosphere score\n\n### Weekly\n- WAU (Weekly Active Users)\n- Subscription conversions\n- Churn rate\n- Chat reports count\n\n### Monthly\n- MAU (Monthly Active Users)\n- MRR (Monthly Recurring Revenue)\n- User retention cohorts\n- NPS (Net Promoter Score)\n\n**Dashboard:** `/admin/data-insights`\n\n---\n\n## ğŸ¨ Design System\n\n**Colors:**\n- Primary: Purple tones (warmth + energy)\n- Gradients: Per archetype (see `archetypeAvatars.ts`)\n- Dark mode: Fully supported\n\n**Components:**\n- Radix UI primitives\n- shadcn/ui prebuilt components\n- Custom components in `client/src/components/`\n\n**Icons:**\n- lucide-react (UI icons)\n- Emoji (archetype avatars)\n\n---\n\n## ğŸ§ª Testing\n\n**E2E Tests:**\n```bash\n# Use run_test tool for playwright tests\n```\n\n**Manual Testing:**\n1. Create test user\n2. Complete personality test\n3. Register for event\n4. Make payment\n5. Send chat message\n6. Submit feedback\n7. Check admin portal\n\n---\n\n## ğŸ“š Documentation Hierarchy\n\n1. **This file (QUICK_REFERENCE.md)** - Quick lookups\n2. **PRODUCT_REQUIREMENTS.md** - Full detailed PRD (50+ pages)\n3. **replit.md** - Project architecture + history\n4. **Inline code comments** - Implementation details\n\n---\n\n## ğŸ”„ Development Workflow\n\n1. **Pull latest code**\n2. **Check `replit.md` for recent changes**\n3. **Create feature branch**\n4. **Make changes**\n5. **Test locally**\n6. **Test in admin portal if applicable**\n7. **Update `replit.md` if architecture changed**\n8. **Commit & push**\n\n---\n\n## ğŸ¯ Roadmap Preview (v1.1)\n\n- [ ] Mobile app (React Native)\n- [ ] AI conversation starters\n- [ ] Video profiles\n- [ ] Advanced A/B testing\n- [ ] English full launch\n- [ ] Group event types (workshops)\n- [ ] Recurring subscription auto-pay\n\n---\n\n## ğŸ“ Quick Help\n\n**Stuck?** Check in order:\n1. This quick reference\n2. `PRODUCT_REQUIREMENTS.md`\n3. `replit.md`\n4. Inline code comments\n5. Ask team lead\n\n**Bug?** \n1. Check logs (workflow + browser console)\n2. Reproduce in dev environment\n3. Check recent `replit.md` changes\n4. Debug with DevTools\n\n**New feature?**\n1. Review similar existing features\n2. Check admin portal for management needs\n3. Update matching algorithm if affects events\n4. Add to Data Insights if metrics needed\n5. Update this quick reference\n\n---\n\n**Last updated:** November 14, 2025  \n**Version:** 1.0  \n**Pairs with:** PRODUCT_REQUIREMENTS.md\n","size_bytes":12874},"PRODUCT_REQUIREMENTS.md":{"content":"# JoyJoin (æ‚¦èšÂ·Joy) - Product Requirements Document\n\n**Version:** 1.1  \n**Last Updated:** November 20, 2025  \n**Platform:** WeChat H5 Mini-App  \n**Target Market:** Hong Kong & Shenzhen  \n\n---\n\n## ğŸ“‹ Table of Contents\n\n1. [Executive Summary](#executive-summary)\n2. [Product Vision](#product-vision)\n3. [User App Features](#user-app-features)\n4. [Admin Portal Features](#admin-portal-features)\n5. [Technical Architecture](#technical-architecture)\n6. [Data Models](#data-models)\n7. [API Reference](#api-reference)\n8. [Implementation Status](#implementation-status)\n\n---\n\n## ğŸ†• Recent Updates (Nov 18-20, 2025)\n\n### Major Feature Releases\n\n**1. Temperature Concept System** ğŸŒ¡ï¸\n- Dual-temperature visualization: Social Energy (ç¤¾äº¤èƒ½é‡) + Chemistry Reaction (åŒ–å­¦ååº”æ¸©åº¦)\n- 14 archetypes mapped to 0-100 energy scale\n- Visual emoji indicators: ğŸ”¥ ç‚½çƒ­ (â‰¥85) | ğŸŒ¡ï¸ æ¸©æš– (70-84) | ğŸŒ¤ï¸ é€‚å®œ (55-69) | â„ï¸ å†·æ·¡ (<55)\n- Prevents unbalanced groups (all high-energy or all low-energy)\n\n**2. Matching Algorithm Fix** ğŸ”§\n- Corrected critical diversity double-counting bug\n- Updated scoring formula: **60% pair compatibility + 25% diversity + 15% energy balance**\n- Clarified pair score components: chemistry (37.5%) + interest (31.25%) + preference (25%) + language (18.75%)\n\n**3. Real-time Dynamic Matching System** âš¡\n- Three-tier threshold system with time decay algorithm\n- Automated continuous matching (instant + hourly + final 24h scans)\n- Admin configuration UI and decision history logs\n- Database-driven parameters (no code changes needed for tuning)\n\n**4. Invitation & Viral Growth System** ğŸ\n- Auto-issue Â¥50 INVITE_REWARD coupon when invited users match together\n- Invitation badges: Purple \"å·²é‚€è¯·\" for inviters, Blue \"[name] é‚€è¯·çš„\" for invitees\n- Database tracking: `user_coupons` and `invitation_uses` tables\n\n**5. Event Pool User Flow** ğŸ­\n- Complete two-stage matching model UI\n- User registration with soft preferences (budget, cuisine, social goals, dietary restrictions)\n- Pool registration status display in EventsPage\n- New components: `EventPoolRegistrationPage`, `PoolRegistrationCard`\n\n**6. WebSocket Real-time Notifications** ğŸ””\n- POOL_MATCHED event with instant user notifications\n- Toast notifications with temperature emoji and match details\n- Auto-cache invalidation and tab switching on match\n- Complete bidirectional sync: Admin â†’ Backend â†’ Users\n\n**7. Event Pool Discovery Fix** ğŸ”\n- Fixed `/api/event-pools` endpoint to display admin-created blind box events\n- Unified status to `active` (replaced `published`/`recruiting`)\n- Schema synchronized across all required fields\n\n---\n\n## ğŸ¯ Executive Summary\n\nJoyJoin is an AI-powered social networking platform that connects individuals locally through small, curated micro-events (5-10 attendees). The platform uses sophisticated personality-based matching algorithms to create meaningful connections while emphasizing psychological safety and inclusivity.\n\n### Key Value Propositions\n\n- **AI-Driven Matching:** 14 personality archetypes with 5-dimensional compatibility scoring\n- **Micro-Event Format:** Small group sizes (5-10 people) for meaningful interactions\n- **Blind Box Experience:** Gamified event discovery with surprise reveals\n- **Data-Driven Insights:** Comprehensive feedback system to refine matching algorithms\n- **Subscription Model:** Â¥98/month or Â¥294/3-month with WeChat Pay integration\n\n---\n\n## ğŸŒŸ Product Vision\n\n### Mission Statement\nFoster meaningful local connections through AI-powered matching that understands personality, interests, and social compatibility.\n\n### Target Users\n\n**Primary Audience:**\n- Urban professionals aged 22-35 in Hong Kong/Shenzhen\n- Seeking authentic local friendships and social experiences\n- Value quality over quantity in social interactions\n- Comfortable with digital-first experiences\n\n**User Personas:**\n\n1. **æ¢ç´¢è€… Lisa (Explorer)** - 28, Marketing Manager\n   - Moved to Shenzhen 6 months ago\n   - Wants to meet like-minded professionals\n   - Values deep conversations over small talk\n\n2. **ç«èŠ±å¡ David (Spark Plug)** - 26, Startup Founder\n   - Naturally outgoing, energizes groups\n   - Looking to expand professional network\n   - Enjoys facilitating connections\n\n3. **è¿æ¥è€… Amy (Connector)** - 30, HR Director\n   - Observant and empathetic\n   - Enjoys helping others meet\n   - Values harmony and inclusion\n\n---\n\n## ğŸ“± User App Features\n\n### 1. User Onboarding & Registration\n\n**File Location:** `client/src/pages/RegistrationPage.tsx`, `client/src/pages/ProfileSetupPage.tsx`\n\n#### 1.1 Phone Authentication\n- **Method:** SMS verification (6-digit code)\n- **Session:** 7-day persistent login\n- **Database:** PostgreSQL session store\n- **Security:** Bcrypt password hashing\n\n**User Journey:**\n```\nLanding Page â†’ Phone Number Entry â†’ SMS Code Verification â†’ Profile Setup\n```\n\n**API Endpoints:**\n- `POST /api/phone/register` - Send SMS code\n- `POST /api/phone/verify` - Verify code and create session\n- `POST /api/phone/login` - Existing user login\n\n#### 1.2 Multi-Step Profile Setup\n\n**Step 1: Basic Information**\n- Full Name (Chinese/English)\n- Gender (Male/Female/Non-binary/Prefer not to say)\n- Birth Year (Age calculation)\n- Location (Hong Kong/Shenzhen districts)\n\n**Step 2: Interests & Topics** (`InterestsTopicsPage.tsx`)\n- 40+ interest tags across 8 categories:\n  - ğŸ¨ Arts & Culture\n  - ğŸ’¼ Career & Business\n  - ğŸƒ Sports & Fitness\n  - ğŸ® Entertainment\n  - ğŸœ Food & Dining\n  - âœˆï¸ Travel & Adventure\n  - ğŸ“š Learning & Growth\n  - ğŸ’¡ Lifestyle & Values\n\n**Step 3: Personality Test** (See Section 1.3)\n\n**Step 4: Optional Background**\n- Education (school, degree, major)\n- Work (company, role, industry)\n- Personal description (bio)\n\n---\n\n### 1.3 Personality Test System â­\n\n**File Location:** `client/src/pages/PersonalityTestPage.tsx`, `client/src/pages/PersonalityTestResultPage.tsx`\n\n#### Architecture Overview\n\n**14 Personality Archetypes** (8 Core + 6 Extended):\n\n**Core Archetypes (Mapped in Test):**\n1. ğŸ™Œ **ç«èŠ±å¡ (Spark Plug)** - Energizer, icebreaker, topic initiator\n2. ğŸ§­ **æ¢ç´¢è€… (Explorer)** - Curious, deep thinker, knowledge seeker\n3. ğŸ“– **æ•…äº‹å®¶ (Storyteller)** - Shares experiences, emotional connector\n4. âš¡ **æŒ‘æˆ˜è€… (Challenger)** - Critical thinker, debate lover\n5. ğŸ¤ **è¿æ¥è€… (Connector)** - Social bridge, empathetic observer\n6. ğŸ¯ **åè°ƒè€… (Coordinator)** - Mediator, consensus builder\n7. ğŸ­ **æ°›å›´ç»„ (Vibe Keeper)** - Humor, lightness, energy\n8. ğŸŒŸ **è‚¯å®šè€… (Affirmer)** - Encourager, supporter, validator\n\n**Extended Archetypes (Configured but not mapped):**\n9. ğŸ¦‰ æ™ºè€… (Sage)\n10. ğŸ›¡ï¸ å®ˆæŠ¤è€… (Guardian)\n11. ğŸŒˆ æ¢¦æƒ³å®¶ (Dreamer)\n12. ğŸ¨ è‰ºæœ¯å®¶ (Artist)\n13. ğŸ“‹ ç»„ç»‡è€… (Organizer)\n14. ğŸ”§ å®å¹²å®¶ (Pragmatist)\n\n#### Test Structure - 10 Questions\n\n**Question Types:**\n- **Single Choice (6 questions):** Q1, Q3, Q4, Q8, Q9, Q10\n  - User selects 1 option â†’ +2 points to mapped archetype\n  \n- **Dual Choice (4 questions):** Q2, Q5, Q6, Q7\n  - \"Most like me\" â†’ +2 points\n  - \"Second most like me\" â†’ +1 point\n  - Cannot select same option twice\n\n**Question Categories:**\n\n**åŸºç¡€è¡Œä¸ºæ¨¡å¼ (Basic Behavioral Patterns) - Q1-Q4:**\n- Q1: èšä¼šå¼€åœºè¡Œä¸º (Opening behavior at gatherings)\n- Q2: é™Œç”Ÿè¯é¢˜ååº” (Reaction to unfamiliar topics)\n- Q3: æƒ…æ„Ÿæ—¶åˆ»å“åº” (Response to emotional moments)\n- Q4: äº‰è®ºè§‚ç‚¹ (Attitude toward debates)\n\n**ååº”åå¥½ (Response Preferences) - Q5-Q7:**\n- Q5: ä¸åŒæ„è§å¤„ç† (Handling disagreements)\n- Q6: è´¡çŒ®æ–¹å¼ (Contribution style)\n- Q7: è¯é¢˜æ¨åŠ¨æ–¹å‘ (Topic development approach)\n\n**è‡ªæˆ‘è®¤çŸ¥ (Self-Awareness) - Q8-Q10:**\n- Q8: ç¤¾äº¤ç„¦è™‘æ¥æº (Social anxiety triggers)\n- Q9: æœ€ä¸å¯èƒ½è§’è‰² (Least likely role)\n- Q10: æœ‹å‹å½¢å®¹è¯ (How friends describe you)\n\n**Example Question (Dual Choice):**\n```\nQ7: æœ‰è¶£ä½†å¤æ‚çš„è¯é¢˜è¢«æèµ·æ—¶ä½ æ›´æ¨åŠ¨ï¼š\nA. å‘ä¸‹æŒ–æ˜ï¼šä¸ºä»€ä¹ˆä¸æœ¬è´¨ï¼Œè¿½æ±‚æ·±åº¦ â†’ æ¢ç´¢è€…\nB. å‘å¤–å‘æ•£ï¼šè¿˜æœ‰ä»€ä¹ˆç›¸å…³ï¼Œè¿½æ±‚å¹¿åº¦ â†’ ç«èŠ±å¡\nC. å‘å†…è¿æ¥ï¼šæˆ‘ä»¬å¦‚ä½•æ„Ÿå—ï¼Œè”ç³»ä½“éªŒ â†’ æ•…äº‹å®¶\nD. å‘å‰æ¨è¿›ï¼šæ‰€ä»¥å‘¢ï¼Ÿèƒ½åšä»€ä¹ˆï¼Ÿå¯¼å‘è¡ŒåŠ¨ â†’ åè°ƒè€…\n```\n\n#### Scoring Algorithm\n\n**Backend File:** `server/routes.ts` (Lines 16-168)\n\n**Step 1: Calculate Archetype Scores**\n```typescript\nfunction calculateRoleScores(responses):\n  scores = { ç«èŠ±å¡: 0, æ¢ç´¢è€…: 0, ... } // 8 archetypes\n  \n  for each question:\n    if (single choice):\n      scores[mappedRole] += 2\n    else if (dual choice):\n      scores[mostLikeRole] += 2\n      scores[secondLikeRole] += 1\n  \n  return scores\n```\n\n**Maximum Possible Scores:**\n- Single questions: 6 Ã— 2 = 12 points\n- Dual questions: 4 Ã— (2+1) = 12 points\n- **Total: 24 points distributed**\n\n**Step 2: Determine Primary & Secondary Roles**\n```\nsorted_scores = sort(scores, descending)\nprimaryRole = scores[0]\nsecondaryRole = scores[1]\n```\n\n**Step 3: Calculate 6-Dimensional Trait Scores**\n\nEach archetype has base trait profiles (0-10 scale):\n\n| Archetype | Affinity | Openness | Conscientiousness | Emotional Stability | Extraversion | Positivity |\n|-----------|----------|----------|-------------------|---------------------|--------------|------------|\n| ç«èŠ±å¡ | 7 | 9 | 5 | 7 | 9 | 8 |\n| æ¢ç´¢è€… | 6 | 9 | 8 | 7 | 6 | 7 |\n| æ•…äº‹å®¶ | 9 | 7 | 6 | 6 | 8 | 7 |\n| æŒ‘æˆ˜è€… | 5 | 9 | 8 | 8 | 7 | 6 |\n| è¿æ¥è€… | 10 | 7 | 7 | 8 | 6 | 8 |\n| åè°ƒè€… | 7 | 6 | 9 | 9 | 7 | 7 |\n| æ°›å›´ç»„ | 8 | 7 | 6 | 7 | 10 | 10 |\n| è‚¯å®šè€… | 10 | 6 | 7 | 8 | 7 | 10 |\n\n**Blending Formula:**\n```\nFinal Score = (Primary Ã— 70%) + (Secondary Ã— 30%)\n```\n\n**Step 4: Generate Personalized Insights**\n\nFor each archetype, pre-configured:\n- **Strengths:** ä½ æ“…é•¿æ‰“å¼€è¯é¢˜ã€å¸¦åŠ¨æ°”æ°›... (What you're good at)\n- **Challenges:** æœ‰æ—¶å¯èƒ½ä¼šè·³è·ƒå¤ªå¿«... (Potential blind spots)\n- **Ideal Friend Types:** [åè°ƒè€…, è¿æ¥è€…, æ¢ç´¢è€…] (Top 3 compatible archetypes)\n\n**Step 5: Determine Subtype**\n```typescript\nsubtypes = {\n  \"ç«èŠ±å¡\": [\"è”æƒ³å®¶\", \"æé—®è€…\"],\n  \"æ¢ç´¢è€…\": [\"ä¸“å®¶å‹\", \"è€ƒè¯æ´¾\"],\n  ...\n}\nroleSubtype = subtypes[primaryRole][0] // Simplified: always first\n```\n\n#### UI/UX Features\n\n**During Test:**\n- âœ¨ **Progress Indicator:** Visual progress bar + question counter (1/10)\n- ğŸ“Š **Mini Radar Chart:** Real-time progress visualization\n- ğŸ‰ **Milestone Animation:** After Q5 - \"æœ‰æ„æ€ï¼æˆ‘ä»¬å·²ç»å‘ç°äº†ä½ çš„ä¸€ä¸ªéšè—ç‰¹è´¨...\"\n- ğŸ **Blind Box Reveal:** 3-second rotating gift box animation on submission\n\n**Results Page Components:**\n\n1. **Hero Section (70vh)**\n   - Gradient background (archetype-specific color)\n   - Large emoji avatar (ğŸ™Œ for ç«èŠ±å¡)\n   - Primary role name + description\n   - Secondary role avatar + name (if applicable)\n\n2. **Six-Dimensional Radar Chart**\n   - Interactive Recharts visualization\n   - 6 axes: Affinity, Openness, Conscientiousness, Emotional Stability, Extraversion, Positivity\n   - Strengths text\n   - Challenges warning\n   - Ideal friend type badges\n\n3. **Social Distribution Card**\n   - \"ä½ åœ¨äººç¾¤ä¸­çš„ä½ç½®\" (Your position in the crowd)\n   - Percentage of users with same archetype\n   - Top 4 archetype distribution preview\n\n4. **Chemistry Matching Prediction**\n   - Top 3 compatible archetypes\n   - Compatibility percentage (85%-94%)\n   - Animated progress bars\n   - AI algorithm explanation\n\n5. **Action Buttons**\n   - ğŸ“¤ Share Results (Native Web Share API)\n   - ğŸš€ Start Exploring Events\n   - ğŸ”„ Retake Test\n\n**Data Storage:**\n```sql\nUPDATE users SET\n  primary_role = 'ç«èŠ±å¡',\n  secondary_role = 'æ¢ç´¢è€…',\n  role_subtype = 'è”æƒ³å®¶',\n  affinity_score = 7,\n  openness_score = 9,\n  conscientiousness_score = 6,\n  emotional_stability_score = 7,\n  extraversion_score = 8,\n  positivity_score = 8,\n  strengths = 'ä½ æ“…é•¿...',\n  challenges = 'æœ‰æ—¶å¯èƒ½...',\n  ideal_friend_types = ARRAY['åè°ƒè€…', 'è¿æ¥è€…', 'æ¢ç´¢è€…'],\n  completed_personality_test = true\nWHERE id = user_id;\n```\n\n---\n\n### 1.4 Event Discovery & Blind Box System\n\n**File Location:** `client/src/pages/DiscoverPage.tsx`, `client/src/pages/BlindBoxEventDetailPage.tsx`\n\n#### Event Types\n\n**1. Blind Box Events (ç›²ç›’æ´»åŠ¨)** - Primary Focus\n- **Mystery Format:** Title + theme revealed, attendees hidden\n- **AI-Matched Groups:** 5-10 participants selected by algorithm\n- **Tiered Reveal System:**\n  - Before Payment: Event theme, venue, time\n  - After Payment: 2-part match score (ä½ ä»¬/æ°”æ°› + ä½ /ä¸ªä½“)\n  - 72h Before: Attendee preview cards with personality insights\n  - Event Day: Full attendee list + chat access\n\n**2. Regular Events (æ™®é€šæ´»åŠ¨)**\n- Traditional RSVP format\n- Visible attendee list\n- First-come-first-served\n\n#### Blind Box Event Lifecycle\n\n**Phase 1: Discovery (Matching Phase)**\n```\nEvent Status: \"matching\"\nUser Sees: \n  - Event theme (e.g., \"æ·±å¤œé£Ÿå ‚ï¼šè¡—è¾¹ç¾é£Ÿæ¢é™©\")\n  - Venue type (e.g., \"å°–æ²™å’€ç‰¹è‰²èŒ¶é¤å…\")\n  - Date & time\n  - Price (Â¥98 members / Â¥148 non-members)\n  - \"AIæ­£åœ¨ä¸ºä½ åŒ¹é…æœ€åˆé€‚çš„ä¼™ä¼´...\"\n```\n\n**Phase 2: Registration Open**\n```\nEvent Status: \"registration_open\"\nUser Action: Click \"ç«‹å³åŠ å…¥ç›²ç›’\" â†’ Payment Page\n```\n\n**Phase 3: Post-Payment Reveal**\n```\nAfter Payment:\n  1. Match Score Reveal (2-Part System):\n     - ğŸ­ Group Chemistry (ä½ ä»¬/æ°”æ°›): 89%\n       \"æ ¹æ®æ€§æ ¼äº’è¡¥æ€§ï¼Œé¢„æµ‹æ•´ä½“æ°›å›´å’Œè°åº¦\"\n     - ğŸ’« Personal Fit (ä½ /ä¸ªä½“): 92%\n       \"æ ¹æ®å…´è¶£ã€èƒŒæ™¯ã€æ„å›¾ï¼Œé¢„æµ‹ä½ ä¸ä»–äººçš„è¿æ¥æ·±åº¦\"\n  \n  2. StackedAttendeeCards Preview:\n     - Attendee count: \"5äººå·²åŠ å…¥\"\n     - Stacked avatar placeholders\n     - \"72å°æ—¶åè§£é”å‚ä¸è€…é¢„è§ˆ\"\n```\n\n**Phase 4: 72-Hour Pre-Event Window**\n```\nEvent Status: \"confirmed\"\nUnlocked Features:\n  1. AttendeePreviewCard for each participant:\n     - Emoji avatar + name\n     - Primary archetype badge\n     - Shared interests (top 3)\n     - Match chemistry with you (e.g., \"ä¸ä½ æœ‰ 88% åŒ–å­¦ååº”\")\n  \n  2. Group Summary:\n     - Archetype distribution pie chart\n     - \"Meet Your Table\" personality breakdown\n     - Conversation topic suggestions\n```\n\n**Phase 5: Event Day**\n```\nEvent Status: \"in_progress\" (day of event)\nFull Access:\n  - Event chat room enabled\n  - Full attendee profiles visible\n  - Venue address + map\n  - Check-in functionality\n```\n\n**Phase 6: Post-Event**\n```\nEvent Status: \"completed\"\nUser Actions:\n  - Leave feedback (æ°›å›´æ¸©åº¦è®¡ + Connection Radar)\n  - Optional deep feedback\n  - Rate individual connections\n```\n\n#### Two-Part Match Scoring System\n\n**Frontend Component:** `client/src/components/MatchScoreDisplay.tsx`\n\n**Group Chemistry Score (ç¾¤ä½“åŒ–å­¦ååº”):**\n```typescript\nCalculation:\n  - Average compatibility across all NÃ—(N-1) pairs\n  - Weighted by personality chemistry matrix\n  - Range: 70-95%\n  \nVisual:\n  - ğŸ­ Icon\n  - Circular progress indicator\n  - \"æ•´ä½“æ°›å›´å’Œè°åº¦\" label\n```\n\n**Personal Fit Score (ä¸ªäººå¥‘åˆåº¦):**\n```typescript\nCalculation:\n  - User's average match with all other attendees\n  - 5-dimensional scoring:\n    * Personality (40%): Based on 14Ã—14 chemistry matrix\n    * Interests (25%): Jaccard similarity of interest tags\n    * Background (15%): Education/career alignment\n    * Conversation (10%): Openness + Extraversion scores\n    * Intent (10%): Event participation motivation\n  - Range: 75-98%\n\nVisual:\n  - ğŸ’« Icon\n  - Circular progress indicator\n  - \"ä½ çš„ä¸ªäººå¥‘åˆåº¦\" label\n```\n\n#### AttendeePreviewCard Component\n\n**File:** `client/src/components/AttendeePreviewCard.tsx`\n\n```typescript\nDisplay:\n  - Avatar: Gradient circle + archetype emoji\n  - Name: \"å¼ å°æ˜\"\n  - Archetype Badge: \"ğŸ§­ æ¢ç´¢è€…\"\n  - Bio Snippet: First 50 chars\n  - Shared Interests: Top 3 overlapping tags\n  - Chemistry Bar: \"ä¸ä½ æœ‰ 88% åŒ–å­¦ååº”\"\n  - Hover Effect: Expand to show full traits\n```\n\n---\n\n### 1.5 Subscription & Payment System\n\n**File Location:** `client/src/pages/BlindBoxPaymentPage.tsx`\n\n#### Subscription Tiers\n\n| Plan | Price | Duration | Benefits |\n|------|-------|----------|----------|\n| **æœˆåº¦ä¼šå‘˜** | Â¥98 | 30 days | Unlimited blind box events, priority matching |\n| **å­£åº¦ä¼šå‘˜** | Â¥294 | 90 days | 15% discount, exclusive quarterly events |\n| **å•æ¬¡ç¥¨** | Â¥148 | Per event | No commitment, higher price |\n\n#### Payment Integration - WeChat Pay\n\n**Service File:** `server/paymentService.ts`\n\n**Payment Flow:**\n```\n1. User selects subscription tier\n   â†“\n2. Frontend POST /api/payments/create\n   {\n     amount: 9800, // cents\n     type: \"subscription\",\n     subscriptionTier: \"monthly\"\n   }\n   â†“\n3. Backend creates payment record (status: \"pending\")\n   â†“\n4. WeChat Pay JSAPI called\n   {\n     appId, timeStamp, nonceStr, package, signType, paySign\n   }\n   â†“\n5. User completes payment in WeChat\n   â†“\n6. WeChat webhook POST /api/payments/webhook\n   â†“\n7. Backend verifies signature & updates:\n   - payment.status = \"completed\"\n   - subscription.status = \"active\"\n   - subscription.startDate = now\n   - subscription.endDate = now + 30 days\n   â†“\n8. WebSocket notification to user\n   \"æ”¯ä»˜æˆåŠŸï¼ä¼šå‘˜å·²æ¿€æ´»\"\n```\n\n**Database Schema:**\n```sql\n-- Payments table\nCREATE TABLE payments (\n  id SERIAL PRIMARY KEY,\n  user_id INTEGER REFERENCES users(id),\n  amount INTEGER NOT NULL, -- in cents\n  currency VARCHAR(3) DEFAULT 'CNY',\n  payment_method VARCHAR(50), -- 'wechat_pay'\n  status VARCHAR(20), -- pending/completed/failed/refunded\n  external_transaction_id VARCHAR(255), -- WeChat transaction ID\n  metadata JSONB,\n  created_at TIMESTAMP DEFAULT NOW()\n);\n\n-- Subscriptions table\nCREATE TABLE subscriptions (\n  id SERIAL PRIMARY KEY,\n  user_id INTEGER REFERENCES users(id),\n  tier VARCHAR(50), -- monthly/quarterly\n  status VARCHAR(20), -- active/expired/cancelled\n  start_date TIMESTAMP,\n  end_date TIMESTAMP,\n  auto_renew BOOLEAN DEFAULT false,\n  payment_id INTEGER REFERENCES payments(id)\n);\n```\n\n**Auto-Expiry System:**\n\n**File:** `server/subscriptionService.ts`\n```typescript\n// Cron job runs daily at 2 AM\nasync function checkExpiredSubscriptions() {\n  const expired = await db\n    .select()\n    .from(subscriptions)\n    .where(\n      and(\n        eq(subscriptions.status, 'active'),\n        lt(subscriptions.endDate, new Date())\n      )\n    );\n  \n  for (const sub of expired) {\n    await db.update(subscriptions)\n      .set({ status: 'expired' })\n      .where(eq(subscriptions.id, sub.id));\n    \n    // Send notification\n    await notifyUser(sub.userId, 'æ‚¨çš„ä¼šå‘˜å·²è¿‡æœŸ');\n  }\n}\n```\n\n#### Coupon System\n\n**File:** `client/src/pages/admin/AdminCouponsPage.tsx`\n\n**Coupon Types:**\n- **Percentage Discount:** 20% off\n- **Fixed Amount:** Â¥30 off\n- **Free Trial:** 7-day free membership\n\n**Coupon Properties:**\n```typescript\ninterface Coupon {\n  code: string;              // \"WELCOME2025\"\n  type: 'percentage' | 'fixed_amount' | 'free_trial';\n  value: number;             // 20 (for 20%) or 3000 (Â¥30 in cents)\n  maxUses: number | null;    // null = unlimited\n  usedCount: number;\n  expiryDate: Date | null;\n  minimumPurchase: number | null; // Minimum order amount\n  applicableTiers: string[]; // [\"monthly\", \"quarterly\"]\n  isActive: boolean;\n}\n```\n\n**Application Logic:**\n```typescript\n// Apply coupon at checkout\nPOST /api/coupons/validate\n{\n  code: \"WELCOME2025\",\n  subscriptionTier: \"monthly\"\n}\n\nResponse:\n{\n  valid: true,\n  discount: 1960, // Â¥19.60 off\n  finalAmount: 7840 // Â¥78.40\n}\n```\n\n---\n\n### 1.6 Chat System\n\n**File Location:** `client/src/pages/EventChatDetailPage.tsx`, `client/src/pages/DirectChatPage.tsx`\n\n#### Event Group Chat\n\n**Access Control:**\n```typescript\n// User can access chat if:\n1. User has registered for the event (payment completed)\n2. Event status is \"in_progress\" (day of event)\n3. User is not banned from chat\n```\n\n**Features:**\n- âœ… Real-time messaging (100ms latency via WebSocket)\n- âœ… Message history (stored in PostgreSQL)\n- âœ… User mentions (@å¼ å°æ˜)\n- âœ… Read receipts\n- âœ… \"Someone is typing...\" indicator\n- âœ… Image/emoji support\n- âœ… Message reporting system\n\n**Message Schema:**\n```sql\nCREATE TABLE chat_messages (\n  id SERIAL PRIMARY KEY,\n  event_id INTEGER REFERENCES events(id),\n  sender_id INTEGER REFERENCES users(id),\n  content TEXT NOT NULL,\n  message_type VARCHAR(20) DEFAULT 'text', -- text/image/system\n  mentioned_user_ids INTEGER[],\n  created_at TIMESTAMP DEFAULT NOW(),\n  is_deleted BOOLEAN DEFAULT false\n);\n```\n\n**Real-Time Protocol:**\n```typescript\n// WebSocket message format\n{\n  type: \"chat_message\",\n  payload: {\n    eventId: 123,\n    senderId: 456,\n    content: \"å¤§å®¶å¥½ï¼å¾ˆæœŸå¾…ä»Šå¤©çš„èšä¼š ğŸ˜Š\",\n    timestamp: \"2025-11-14T10:30:00Z\"\n  }\n}\n\n// Server broadcasts to all event attendees\nwsService.broadcastToEvent(eventId, message);\n```\n\n#### Direct Messages (1-on-1)\n\n**Thread Management:**\n```sql\nCREATE TABLE direct_message_threads (\n  id SERIAL PRIMARY KEY,\n  participant1_id INTEGER REFERENCES users(id),\n  participant2_id INTEGER REFERENCES users(id),\n  last_message_at TIMESTAMP,\n  UNIQUE(participant1_id, participant2_id)\n);\n\nCREATE TABLE direct_messages (\n  id SERIAL PRIMARY KEY,\n  thread_id INTEGER REFERENCES direct_message_threads(id),\n  sender_id INTEGER REFERENCES users(id),\n  content TEXT NOT NULL,\n  read_at TIMESTAMP,\n  created_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n**Privacy Controls:**\n- Only attendees from same past events can DM\n- Block/report functionality\n- Message encryption (E2E planned for future)\n\n#### Chat Moderation System\n\n**File:** `client/src/pages/admin/AdminModerationPage.tsx`\n\n**User Reporting:**\n```typescript\n// Users can report messages\nPOST /api/chat/report\n{\n  messageId: 789,\n  reportType: \"inappropriate_content\" | \"harassment\" | \"spam\",\n  description: \"ç”¨æˆ·å‘é€äº†ä¸å½“è¨€è®º\"\n}\n\n// Creates chat_reports record\nCREATE TABLE chat_reports (\n  id SERIAL PRIMARY KEY,\n  reporter_id INTEGER REFERENCES users(id),\n  reported_message_id INTEGER REFERENCES chat_messages(id),\n  reported_user_id INTEGER REFERENCES users(id),\n  report_type VARCHAR(50),\n  description TEXT,\n  status VARCHAR(20) DEFAULT 'pending', -- pending/reviewed/resolved\n  admin_notes TEXT,\n  reviewed_by INTEGER REFERENCES users(id),\n  created_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n**Admin Moderation Actions:**\n1. **Review Reports:** See all pending reports in queue\n2. **View Context:** Read surrounding messages\n3. **Take Action:**\n   - Delete message\n   - Warn user\n   - Temporarily mute (24h)\n   - Ban from future chats\n   - Dismiss report (no action)\n4. **Log Actions:** All moderation actions logged\n\n**Chat Logging System:**\n\n**File:** `client/src/pages/admin/AdminChatLogsPage.tsx`\n\n```sql\nCREATE TABLE chat_logs (\n  id SERIAL PRIMARY KEY,\n  event_id INTEGER REFERENCES events(id),\n  user_id INTEGER REFERENCES users(id),\n  action_type VARCHAR(50), -- 'message_sent' | 'message_deleted' | 'user_muted'\n  details JSONB,\n  ip_address VARCHAR(50),\n  user_agent TEXT,\n  created_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n**Admin Query Interface:**\n- Search by event, user, date range\n- Filter by action type\n- Export logs as CSV\n- Audit trail for compliance\n\n---\n\n### 1.7 Feedback System (æ°›å›´æ¸©åº¦è®¡)\n\n**File Location:** `client/src/pages/EventFeedbackFlow.tsx`, `client/src/pages/DeepFeedbackFlow.tsx`\n\n#### Two-Tier Feedback Architecture\n\n**Tier 1: Basic Feedback (Required)**\n\nAppears immediately after event ends (status: \"completed\")\n\n**Step 1: Atmosphere Score (æ°›å›´æ¸©åº¦è®¡)**\n```typescript\n// Visual: Thermometer with 5 levels\n1 â„ï¸  å†°ç‚¹ - æ°”æ°›å†·æ·¡ï¼Œéš¾ä»¥å±•å¼€å¯¹è¯\n2 ğŸŒ¥ï¸  å¾®å‡‰ - å¯¹è¯æœ‰äº›æ‹˜è°¨ï¼Œéœ€è¦ç ´å†°\n3 â˜€ï¸  æ¸©æš– - æ°”æ°›å’Œè°ï¼Œäº¤æµé¡ºç•…\n4 ğŸ”¥  çƒ­çƒˆ - äº’åŠ¨é¢‘ç¹ï¼Œæ°›å›´æ´»è·ƒ\n5 ğŸŒˆ  å®Œç¾ - åŒ–å­¦ååº”çˆ†æ£šï¼Œæ„çŠ¹æœªå°½\n```\n\n**Step 2: Connection Radar (è¿æ¥é›·è¾¾å›¾)**\n\n**Component:** `client/src/components/feedback/ConnectionRadar.tsx`\n\n4-dimensional assessment (0-10 scale):\n```typescript\n1. è¯é¢˜æ·±åº¦ (Topic Depth)\n   - \"è‚¤æµ…é—²èŠ\" â†’ \"æ·±åº¦æ¢è®¨\"\n   \n2. æƒ…æ„Ÿå…±é¸£ (Emotional Resonance)\n   - \"æ— æ„Ÿ\" â†’ \"å¼ºçƒˆå…±é¸£\"\n   \n3. ä»·å€¼è§‚å¥‘åˆ (Value Alignment)\n   - \"è§‚å¿µå†²çª\" â†’ \"æƒºæƒºç›¸æƒœ\"\n   \n4. åç»­æ„æ„¿ (Future Intent)\n   - \"ç¤¼è²Œå‘Šåˆ«\" â†’ \"æœŸå¾…ä¸‹æ¬¡\"\n```\n\n**Visual:** Recharts RadarChart with custom styling\n\n**Step 3: Select Meaningful Connections**\n\n**Component:** `client/src/components/feedback/SelectConnectionsStep.tsx`\n\n```typescript\n// User selects attendees they connected with\nInterface:\n  - Grid of attendee cards\n  - Multi-select checkboxes\n  - \"è‡³å°‘é€‰æ‹©1ä½ä½ æ„Ÿè§‰è¿æ¥è¾ƒæ·±çš„ä¼™ä¼´\"\n  \nData Stored:\n  connected_user_ids: [123, 456, 789]\n```\n\n**Step 4: Attendee Trait Tags (å‚ä¸è€…å°è±¡æ ‡ç­¾)**\n\n**Component:** `client/src/components/feedback/TraitTagsWall.tsx`\n\nFor EACH selected connection:\n```typescript\n// 20+ pre-defined trait tags\nPositive Traits:\n  - ğŸ¯ æ·±åº¦æ€è€ƒè€…\n  - ğŸ˜Š å¹½é»˜é£è¶£\n  - ğŸ¤ å–„äºå€¾å¬\n  - ğŸ’¡ è§‚ç‚¹ç‹¬ç‰¹\n  - ğŸŒŸ ç§¯æä¹è§‚\n  - ğŸ“š åšå­¦å¤šè¯†\n  \nNeutral/Constructive:\n  - ğŸ¤” è¯é¢˜ä¸»å¯¼è€…\n  - ğŸ˜Œ ç›¸å¯¹å®‰é™\n  - ğŸ­ å–„äºè°ƒèŠ‚\n  \nUser Action:\n  - Tap tags to apply to attendee\n  - Can select multiple per person\n  - Minimum 2 tags per person\n```\n\n**Step 5: Improvement Suggestions**\n\nFree-text input:\n```typescript\nPrompt: \"æœ‰ä»€ä¹ˆå¯ä»¥æ”¹è¿›æ´»åŠ¨ä½“éªŒçš„å»ºè®®å—ï¼Ÿï¼ˆå¯é€‰ï¼‰\"\n\nExamples:\n  - \"æ—¶é—´å¯ä»¥å»¶é•¿30åˆ†é’Ÿ\"\n  - \"å¸Œæœ›æœ‰æ›´å¤šè¯é¢˜å¼•å¯¼\"\n  - \"é¤å…æœ‰ç‚¹åµï¼Œé€‚åˆæ›´å®‰é™çš„åœºåœ°\"\n```\n\n**Tier 2: Deep Feedback (Optional, Anonymous)**\n\n**Trigger:** After basic feedback submission\n```\nPrompt: \"æ„¿æ„èŠ±2åˆ†é’Ÿå¸®åŠ©æˆ‘ä»¬ä¼˜åŒ–åŒ¹é…ç®—æ³•å—ï¼Ÿ\n        æ‚¨çš„åé¦ˆå°†åŒ¿åå¤„ç†ï¼Œç”¨äºæ”¹è¿›æœªæ¥çš„åŒ¹é…è´¨é‡ã€‚\"\n```\n\n**Deep Feedback Questions:**\n\n1. **åŒ¹é…å‡†ç¡®åº¦è¯„åˆ† (Match Accuracy)**\n   ```\n   Q: \"è¿™æ¬¡æ´»åŠ¨çš„å‚ä¸è€…ä¸ä½ çš„æœŸå¾…åŒ¹é…åº¦å¦‚ä½•ï¼Ÿ\"\n   Scale: 1-10\n   1 = å®Œå…¨ä¸ç¬¦åˆæœŸå¾…\n   10 = è¶…å‡ºæœŸå¾…\n   ```\n\n2. **ç†æƒ³ç¾¤ä½“ç”»åƒ (Ideal Group Profile)**\n   ```\n   Q: \"ä½ ç†æƒ³ä¸­çš„èšä¼šä¼™ä¼´æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ\"\n   Multi-select:\n   - å¹´é¾„æ®µåå¥½ (22-25, 26-30, 31-35)\n   - èŒä¸šç±»å‹ (ç§‘æŠ€, é‡‘è, åˆ›æ„, æœåŠ¡ä¸š, è‡ªç”±èŒä¸š)\n   - æ€§æ ¼å€¾å‘ (å¤–å‘æ´»æ³¼, å†…æ•›æ·±æ²‰, å¹³è¡¡å‹)\n   - å¯¹è¯é£æ ¼ (è½»æ¾é—²èŠ, æ·±åº¦æ¢è®¨, çµæ´»åˆ‡æ¢)\n   ```\n\n3. **ä¸åŒ¹é…å› ç´  (Mismatch Factors)**\n   ```\n   Q: \"å¦‚æœæœ‰æ„Ÿåˆ°ä¸å¤ªåˆé€‚çš„åœ°æ–¹ï¼Œä¸»è¦æ˜¯å› ä¸ºï¼š\"\n   Options:\n   - å¹´é¾„å·®è·è¾ƒå¤§\n   - å…´è¶£é‡å è¾ƒå°‘\n   - æ€§æ ¼å·®å¼‚æ˜æ˜¾\n   - å¯¹è¯é£æ ¼ä¸åˆ\n   - æ´»åŠ¨å½¢å¼ä¸é€‚åˆ\n   - å…¶ä»– (è¯·è¯´æ˜)\n   ```\n\n4. **ç®—æ³•å»ºè®® (Algorithm Suggestions)**\n   ```\n   Free text:\n   \"å¯¹æˆ‘ä»¬çš„åŒ¹é…ç®—æ³•æœ‰ä»€ä¹ˆå»ºè®®ï¼Ÿ\"\n   ```\n\n**Data Storage:**\n```sql\nCREATE TABLE event_feedback (\n  id SERIAL PRIMARY KEY,\n  event_id INTEGER REFERENCES events(id),\n  user_id INTEGER REFERENCES users(id),\n  \n  -- Basic Feedback\n  atmosphere_score INTEGER CHECK (atmosphere_score BETWEEN 1 AND 5),\n  topic_depth INTEGER,\n  emotional_resonance INTEGER,\n  value_alignment INTEGER,\n  future_intent INTEGER,\n  connected_user_ids INTEGER[],\n  attendee_traits JSONB, -- { \"123\": [\"æ·±åº¦æ€è€ƒè€…\", \"å¹½é»˜é£è¶£\"], ... }\n  improvement_suggestions TEXT,\n  \n  -- Deep Feedback (nullable)\n  match_accuracy_score INTEGER,\n  ideal_age_ranges TEXT[],\n  ideal_professions TEXT[],\n  ideal_personalities TEXT[],\n  ideal_conversation_styles TEXT[],\n  mismatch_factors TEXT[],\n  algorithm_suggestions TEXT,\n  \n  is_anonymous BOOLEAN DEFAULT false,\n  created_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n#### Feedback Analytics Integration\n\n**Admin Portal Usage:**\n\n1. **AdminFeedbackPage.tsx:**\n   - View all feedback submissions\n   - Filter by event, date, atmosphere score\n   - Read improvement suggestions\n   - Export feedback data\n\n2. **AdminDataInsightsPage.tsx:**\n   - Aggregate atmosphere scores â†’ \"Event Quality Index\"\n   - Trending improvement themes\n   - Match accuracy over time\n   - Connection depth distributions\n\n3. **AdminMatchingLabPage.tsx:**\n   - Use deep feedback to tune algorithm weights\n   - A/B test different matching strategies\n   - Validate chemistry matrix accuracy\n\n---\n\n### 1.8 User Profile Management\n\n**File Location:** `client/src/pages/ProfilePage.tsx`, `client/src/pages/Edit*.tsx`\n\n#### Profile Sections\n\n**1. Basic Info** (`EditBasicInfoPage.tsx`)\n- Name\n- Gender\n- Birth year\n- Location (district)\n- Profile photo upload\n\n**2. Interests & Topics** (`EditInterestsPage.tsx`)\n- 40+ interest tags\n- Top 5 highlighted in profile\n\n**3. Personality** (`EditPersonalPage.tsx`)\n- View personality test results\n- 6-dimensional radar chart\n- Retake test option\n- Primary/secondary archetype display\n\n**4. Education** (`EditEducationPage.tsx`)\n- School/University\n- Degree level\n- Major/Field of study\n- Graduation year\n\n**5. Work** (`EditWorkPage.tsx`)\n- Company\n- Job title\n- Industry\n- Years of experience\n\n**6. Intent** (`EditIntentPage.tsx`)\n```typescript\n// Why user joined JoyJoin\nOptions:\n  - æ‰©å±•æœ‹å‹åœˆ (Expand friend circle)\n  - å¯»æ‰¾å…´è¶£ä¼™ä¼´ (Find hobby partners)\n  - è¡Œä¸šäº¤æµ (Professional networking)\n  - æ¢ç´¢åŸå¸‚ç”Ÿæ´» (Explore city life)\n  - è„±å•äº¤å‹ (Dating - not primary focus)\n```\n\n#### Privacy Settings\n\n**Visibility Controls:**\n```typescript\ninterface PrivacySettings {\n  profileVisibility: 'public' | 'events_only' | 'private';\n  showAge: boolean;\n  showEducation: boolean;\n  showWorkplace: boolean;\n  allowDirectMessages: 'everyone' | 'connections_only' | 'none';\n}\n```\n\n---\n\n### 1.9 Navigation & User Flow\n\n**File:** `client/src/App.tsx`\n\n#### Bottom Navigation Bar (5 Tabs)\n\n```typescript\n1. ğŸ  é¦–é¡µ (Home) â†’ /\n   - Upcoming events\n   - Quick actions\n   \n2. ğŸ¯ å‘ç° (Discover) â†’ /discover\n   - Browse blind box events\n   - Filter by theme, date, location\n   \n3. ğŸ“… æˆ‘çš„æ´»åŠ¨ (My Events) â†’ /events\n   - Registered events\n   - Past events\n   - Event history\n   \n4. ğŸ’¬ æ¶ˆæ¯ (Messages) â†’ /chats\n   - Event group chats\n   - Direct messages\n   - Unread badge\n   \n5. ğŸ‘¤ æˆ‘çš„ (Profile) â†’ /profile\n   - User profile\n   - Settings\n   - Subscription status\n```\n\n#### Protected Routes\n\n```typescript\n// Requires authentication\nMiddleware: isPhoneAuthenticated\n\nProtected Routes:\n  - /discover\n  - /events\n  - /events/:id\n  - /blind-box/:id\n  - /blind-box/:id/payment\n  - /chats\n  - /chats/event/:id\n  - /chats/direct/:threadId\n  - /profile\n  - /personality-test/results\n  - /feedback/:eventId\n  \nPublic Routes:\n  - /\n  - /login\n  - /register\n  - /personality-test (can be taken before full registration)\n```\n\n---\n\n## ğŸ›¡ï¸ Admin Portal Features\n\n**Access:** `https://joyjoin.app/admin` (Desktop-optimized)\n\n**Authentication:** \n- Admin users have `is_admin: true` in database\n- Middleware: `requireAdmin` on all `/api/admin/*` routes\n- Test account: Phone `19896500978` / Password `Lasalle11`\n\n---\n\n### 2.1 Admin Dashboard\n\n**File:** `client/src/pages/admin/AdminDashboard.tsx`\n\n#### Key Metrics (Top Cards)\n\n```typescript\n1. æ€»ç”¨æˆ·æ•° (Total Users)\n   - Count + 7-day growth %\n   - Icon: Users\n   \n2. æ´»è·ƒè®¢é˜… (Active Subscriptions)\n   - Current active count\n   - MRR (Monthly Recurring Revenue)\n   - Icon: CreditCard\n   \n3. æœ¬æœˆæ´»åŠ¨ (Events This Month)\n   - Scheduled + completed\n   - Average attendance rate\n   - Icon: Calendar\n   \n4. å¹³å‡æ»¡æ„åº¦ (Avg Satisfaction)\n   - Mean atmosphere score (1-5)\n   - Trend arrow\n   - Icon: Sparkles\n```\n\n#### Recent Activity Feed\n\nReal-time stream of:\n- ğŸ†• New user registrations\n- ğŸ’³ Payment completions\n- ğŸ‰ Event confirmations\n- ğŸ’¬ Chat reports (flagged)\n- â­ High-quality feedback submissions\n\n**WebSocket Integration:**\n```typescript\n// Admin receives real-time notifications\nuseWebSocket((message) => {\n  if (message.type === 'admin_notification') {\n    addToActivityFeed(message.payload);\n    showToast(message.payload.summary);\n  }\n});\n```\n\n#### Quick Actions\n\n```typescript\nButtons:\n  - åˆ›å»ºæ–°æ´»åŠ¨ â†’ /admin/events (new event form)\n  - æŸ¥çœ‹å¾…å¤„ç†ä¸¾æŠ¥ â†’ /admin/moderation\n  - ç”Ÿæˆæœ¬å‘¨æŠ¥è¡¨ â†’ Download CSV\n  - å‘é€ç³»ç»Ÿé€šçŸ¥ â†’ /admin/notifications\n```\n\n---\n\n### 2.2 User Management\n\n**File:** `client/src/pages/admin/AdminUsersPage.tsx`\n\n#### User List View\n\n**Table Columns:**\n- ID\n- Name\n- Phone (masked: 198****0978)\n- Primary Archetype badge\n- Registration Date\n- Subscription Status badge\n- Last Active\n- Actions dropdown\n\n**Filters:**\n```typescript\n- Subscription Status: All | Active | Expired | Never\n- Archetype: All | ç«èŠ±å¡ | æ¢ç´¢è€… | ...\n- Registration Date Range\n- Search: Name, phone, email\n```\n\n**Sorting:**\n- Registration date (newest/oldest)\n- Last active (most/least recent)\n- Subscription end date\n\n#### User Detail View\n\n**Tabs:**\n\n**1. åŸºæœ¬ä¿¡æ¯ (Basic Info)**\n- Full profile data\n- Edit capabilities (admin override)\n- Account status toggle (active/suspended)\n\n**2. è®¢é˜…å†å² (Subscription History)**\n- All subscription records\n- Payment history table\n- Manual subscription grant button\n- Refund issuance\n\n**3. æ´»åŠ¨è®°å½• (Event History)**\n- All registered events\n- Attendance status\n- Feedback submissions\n- No-show rate\n\n**4. è¡Œä¸ºæ—¥å¿— (Activity Logs)**\n- Login history\n- Chat messages sent\n- Reports filed\n- Reports received\n\n**Admin Actions:**\n```typescript\nActions Dropdown:\n  - ğŸ”’ Suspend Account (temporary ban)\n  - âœ‰ï¸ Send Direct Message\n  - ğŸ Grant Free Subscription\n  - ğŸ’° Issue Refund\n  - ğŸ—‘ï¸ Delete Account (requires confirmation)\n  - ğŸ“Š View Full Analytics\n```\n\n---\n\n### 2.3 Subscription & Payment Management\n\n**File:** `client/src/pages/admin/AdminSubscriptionsPage.tsx`\n\n#### Subscription Overview\n\n**Metrics:**\n```typescript\nTop Cards:\n  1. Active Subscriptions Count\n  2. MRR (Monthly Recurring Revenue): Â¥45,680\n  3. Churn Rate: 12% this month\n  4. Average Lifetime Value: Â¥586\n```\n\n**Subscription Table:**\n\nColumns:\n- User Name + ID\n- Tier (æœˆåº¦/å­£åº¦)\n- Start Date\n- End Date\n- Status (active/expired/cancelled)\n- Auto-Renew toggle\n- Actions\n\n**Filters:**\n- Status: Active | Expiring Soon (< 7 days) | Expired\n- Tier: All | Monthly | Quarterly\n- Auto-Renew: Yes | No\n\n**Bulk Actions:**\n```typescript\n- Export subscribers list (CSV)\n- Send renewal reminder emails\n- Apply bulk discount (e.g., 20% off renewal)\n```\n\n#### Payment History\n\n**File:** `client/src/pages/admin/AdminFinancePage.tsx`\n\n**Revenue Dashboard:**\n\n**Charts:**\n1. **Daily Revenue Line Chart** (Last 30 days)\n2. **Revenue by Tier** (Pie chart: Monthly vs Quarterly vs Single)\n3. **Payment Method Distribution** (WeChat Pay 98%, Alipay 2%)\n\n**Payment Records Table:**\n\nColumns:\n- Transaction ID (WeChat external ID)\n- User\n- Amount\n- Type (subscription/event_ticket/refund)\n- Payment Method\n- Status\n- Created At\n- Actions (View Receipt, Refund)\n\n**Filters:**\n- Date range picker\n- Payment status\n- Payment method\n- Amount range (Â¥0 - Â¥500)\n\n**Refund Management:**\n```typescript\nPOST /api/admin/payments/refund\n{\n  paymentId: 123,\n  amount: 9800, // Full or partial\n  reason: \"ç”¨æˆ·è¦æ±‚é€€æ¬¾ - æ´»åŠ¨å–æ¶ˆ\",\n  notifyUser: true\n}\n\nProcess:\n1. Create refund record in database\n2. Call WeChat Pay refund API\n3. Update payment status to \"refunded\"\n4. Update subscription status to \"cancelled\"\n5. Send notification to user\n6. Log admin action\n```\n\n---\n\n### 2.4 Venue Management\n\n**File:** `client/src/pages/admin/AdminVenuesPage.tsx`\n\n#### Venue Database\n\n**Purpose:** Maintain partnerships with local restaurants, cafes, bars for hosting events\n\n**Venue Schema:**\n```sql\nCREATE TABLE venues (\n  id SERIAL PRIMARY KEY,\n  name VARCHAR(255) NOT NULL,\n  name_en VARCHAR(255),\n  category VARCHAR(50), -- restaurant/cafe/bar/coworking/outdoor\n  address TEXT NOT NULL,\n  district VARCHAR(50), -- å°–æ²™å’€, ä¸­ç¯, å—å±±, ç¦ç”°\n  city VARCHAR(50), -- Hong Kong/Shenzhen\n  google_maps_url TEXT,\n  \n  -- Capacity\n  min_capacity INTEGER DEFAULT 5,\n  max_capacity INTEGER DEFAULT 15,\n  \n  -- Availability\n  available_days TEXT[], -- ['monday', 'tuesday', ...]\n  available_time_slots JSONB, -- {\"18:00-20:00\": true, ...}\n  \n  -- Pricing\n  price_per_person INTEGER, -- in cents\n  minimum_spend INTEGER,\n  \n  -- Ratings\n  ambiance_score INTEGER, -- 1-10\n  noise_level VARCHAR(20), -- quiet/moderate/lively\n  \n  -- Features\n  has_wifi BOOLEAN DEFAULT false,\n  has_projector BOOLEAN DEFAULT false,\n  accessibility_friendly BOOLEAN DEFAULT false,\n  \n  -- Partnership\n  partnership_status VARCHAR(20), -- active/inactive/pending\n  commission_rate DECIMAL(5,2), -- 15% = 15.00\n  contact_person VARCHAR(100),\n  contact_phone VARCHAR(20),\n  contact_email VARCHAR(100),\n  \n  notes TEXT,\n  created_at TIMESTAMP DEFAULT NOW(),\n  updated_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n**Admin Interface:**\n\n**List View:**\n- Cards with venue photo, name, district, capacity\n- Filter by city, category, availability\n- Search by name or address\n- Status badges (active/inactive)\n\n**Detail View:**\n```typescript\nTabs:\n  1. åŸºæœ¬ä¿¡æ¯ (Basic Info)\n     - Edit all venue details\n     - Upload photos\n     - Set availability schedule\n  \n  2. æ´»åŠ¨å†å² (Event History)\n     - All events hosted at this venue\n     - Average attendance\n     - Average satisfaction score\n     - Revenue generated\n  \n  3. å¯ç”¨æ—¶æ®µ (Availability)\n     - Calendar view\n     - Block specific dates\n     - Recurring availability patterns\n```\n\n**Venue Matching Algorithm:**\n\n**File:** `server/venueMatchingService.ts`\n\n```typescript\nfunction scoreVenue(venue, event, attendees) {\n  let score = 0;\n  \n  // Capacity match\n  if (attendees.length >= venue.minCapacity && \n      attendees.length <= venue.maxCapacity) {\n    score += 30;\n  }\n  \n  // Location preference\n  const attendeeDistricts = attendees.map(a => a.district);\n  const mostCommonDistrict = mode(attendeeDistricts);\n  if (venue.district === mostCommonDistrict) {\n    score += 20;\n  }\n  \n  // Ambiance match (based on event theme + attendee personalities)\n  const avgExtroversion = mean(attendees.map(a => a.extraversionScore));\n  if (avgExtroversion > 7 && venue.noiseLevel === 'lively') {\n    score += 15;\n  } else if (avgExtroversion < 5 && venue.noiseLevel === 'quiet') {\n    score += 15;\n  }\n  \n  // Historical performance\n  if (venue.averageSatisfaction > 4.0) {\n    score += 10;\n  }\n  \n  // Availability\n  if (isAvailable(venue, event.datetime)) {\n    score += 25;\n  } else {\n    score = 0; // Hard constraint\n  }\n  \n  return score;\n}\n\n// Return top 3 venue recommendations\nfunction matchVenue(event, attendees) {\n  const venues = await db.select().from(venues)\n    .where(eq(venues.partnershipStatus, 'active'));\n  \n  const scored = venues.map(v => ({\n    venue: v,\n    score: scoreVenue(v, event, attendees)\n  }));\n  \n  return scored.sort((a, b) => b.score - a.score).slice(0, 3);\n}\n```\n\n**Booking System:**\n\n```typescript\n// When admin confirms event with venue\nPOST /api/admin/events/book-venue\n{\n  eventId: 123,\n  venueId: 456,\n  confirmedDateTime: \"2025-11-20T19:00:00Z\",\n  expectedAttendees: 8,\n  specialRequests: \"éœ€è¦æŠ•å½±ä»ª\"\n}\n\nProcess:\n1. Check venue availability (with transaction lock)\n   BEGIN TRANSACTION;\n   SELECT * FROM venue_bookings \n   WHERE venue_id = 456 \n   AND datetime = '2025-11-20 19:00:00'\n   FOR UPDATE; -- Row-level lock\n   \n2. If available, create booking:\n   INSERT INTO venue_bookings (\n     venue_id, event_id, datetime, status\n   ) VALUES (456, 123, '2025-11-20 19:00:00', 'confirmed');\n   \n3. Update event with venue details\n   COMMIT;\n   \n4. Send confirmation to venue contact\n5. Broadcast to attendees via WebSocket\n```\n\n---\n\n### 2.5 Event Template System\n\n**File:** `client/src/pages/admin/AdminEventTemplatesPage.tsx`\n\n#### Purpose\n\nCreate reusable event templates for recurring themes to streamline event creation.\n\n**Template Schema:**\n```sql\nCREATE TABLE event_templates (\n  id SERIAL PRIMARY KEY,\n  title VARCHAR(255) NOT NULL,\n  title_en VARCHAR(255),\n  category VARCHAR(50), -- dining/outdoor/creative/learning/sports\n  description TEXT,\n  \n  -- Default Settings\n  default_max_attendees INTEGER DEFAULT 8,\n  default_price_member INTEGER, -- in cents\n  default_price_non_member INTEGER,\n  default_duration_minutes INTEGER DEFAULT 120,\n  \n  -- Matching Preferences\n  preferred_archetypes TEXT[], -- Ideal personality mix\n  min_diversity_score INTEGER, -- Minimum personality diversity\n  \n  -- Venue Requirements\n  preferred_venue_categories TEXT[],\n  required_venue_features TEXT[], -- ['wifi', 'projector']\n  \n  -- Images\n  cover_image_url TEXT,\n  gallery_images TEXT[],\n  \n  is_active BOOLEAN DEFAULT true,\n  usage_count INTEGER DEFAULT 0,\n  created_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n**Example Templates:**\n\n1. **æ·±å¤œé£Ÿå ‚ï¼šè¡—è¾¹ç¾é£Ÿæ¢é™©**\n   ```typescript\n   {\n     category: \"dining\",\n     description: \"æ¢ç´¢æœ¬åœ°ç‰¹è‰²å°åƒï¼Œä»å¤§æ’æ¡£åˆ°æ·±å¤œç”œå“\",\n     defaultMaxAttendees: 6,\n     priceMember: 9800,\n     priceNonMember: 14800,\n     preferredArchetypes: [\"æ¢ç´¢è€…\", \"æ•…äº‹å®¶\", \"æ°›å›´ç»„\"],\n     preferredVenueCategories: [\"restaurant\"],\n     requiredVenueFeatures: []\n   }\n   ```\n\n2. **å‘¨æœ«å¾’æ­¥ï¼šåŸå¸‚è¾¹ç¼˜çš„ç»¿é‡**\n   ```typescript\n   {\n     category: \"outdoor\",\n     description: \"é€ƒç¦»åŸå¸‚å–§åš£ï¼Œåœ¨è‡ªç„¶ä¸­æ·±åº¦å¯¹è¯\",\n     defaultMaxAttendees: 10,\n     priceMember: 6800,\n     priceNonMember: 9800,\n     preferredArchetypes: [\"æ¢ç´¢è€…\", \"è¿æ¥è€…\", \"è‚¯å®šè€…\"],\n     preferredVenueCategories: [\"outdoor\"],\n     requiredVenueFeatures: []\n   }\n   ```\n\n3. **è¯»ä¹¦ä¼šï¼šéè™šæ„ä½œå“åˆ†äº«**\n   ```typescript\n   {\n     category: \"learning\",\n     description: \"å›´ç»•ä¸€æœ¬ä¹¦å±•å¼€æ·±åº¦è®¨è®ºï¼Œåˆ†äº«è§‚ç‚¹ä¸å¯å‘\",\n     defaultMaxAttendees: 8,\n     priceMember: 8800,\n     priceNonMember: 12800,\n     preferredArchetypes: [\"æ¢ç´¢è€…\", \"æŒ‘æˆ˜è€…\", \"æ™ºè€…\"],\n     preferredVenueCategories: [\"cafe\", \"coworking\"],\n     requiredVenueFeatures: [\"wifi\", \"quiet\"]\n   }\n   ```\n\n**Admin Interface:**\n\n**Create Event from Template:**\n```typescript\nFlow:\n1. Admin selects template\n2. Pre-filled form appears with template defaults\n3. Admin can override:\n   - Date & time\n   - Venue (choose from recommendations)\n   - Max attendees\n   - Price\n   - Description\n4. Click \"å‘å¸ƒæ´»åŠ¨\"\n5. Event created with status \"matching\"\n```\n\n---\n\n### 2.6 Event Management\n\n**File:** `client/src/pages/admin/AdminEventsPage.tsx`\n\n#### Event Lifecycle Management\n\n**Event Status States:**\n```typescript\ntype EventStatus = \n  | \"draft\"              // Admin creating\n  | \"matching\"           // AI finding participants\n  | \"registration_open\"  // Accepting sign-ups\n  | \"confirmed\"          // Min attendees met, venue booked\n  | \"in_progress\"        // Day of event\n  | \"completed\"          // Event finished\n  | \"cancelled\";         // Admin cancelled\n\nStatus Transitions:\ndraft â†’ matching â†’ registration_open â†’ confirmed â†’ in_progress â†’ completed\n   â†“         â†“              â†“              â†“\ncancelled  cancelled    cancelled     cancelled\n```\n\n**Admin Event Dashboard:**\n\n**Views:**\n\n1. **Calendar View**\n   - Full calendar grid (month view)\n   - Color-coded by status\n   - Click date to create new event\n   - Drag-and-drop to reschedule\n\n2. **List View (Default)**\n   \n   **Tabs:**\n   - å³å°†ä¸¾è¡Œ (Upcoming) - confirmed + in_progress\n   - æ‹›å‹Ÿä¸­ (Recruiting) - matching + registration_open\n   - å·²å®Œæˆ (Completed)\n   - å·²å–æ¶ˆ (Cancelled)\n   - å…¨éƒ¨ (All)\n   \n   **Table Columns:**\n   - Event Title\n   - Template badge (if from template)\n   - Date & Time\n   - Venue\n   - Attendees (X/Y)\n   - Status badge\n   - Avg Match Score\n   - Actions\n\n**Event Detail Page:**\n\n**Tabs:**\n\n**1. æ´»åŠ¨ä¿¡æ¯ (Event Info)**\n```typescript\nEditable Fields:\n  - Title (Chinese + English)\n  - Description\n  - Category\n  - Date & Time\n  - Duration\n  - Max attendees\n  - Price (member/non-member)\n  - Cover image\n  - Status (admin override)\n```\n\n**2. å‚ä¸è€… (Attendees)**\n```typescript\nDisplay:\n  - Attendee list with profile cards\n  - Archetype distribution pie chart\n  - Average group chemistry score\n  - Individual match scores\n  \nActions:\n  - Manually add/remove attendees\n  - Send group message\n  - Export attendee list\n```\n\n**3. åŒ¹é…åˆ†æ (Matching Analysis)**\n```typescript\nShow:\n  - 5-dimensional match scores breakdown\n  - Personality distribution chart\n  - Interest overlap matrix\n  - Predicted conversation topics\n  - Warning flags:\n    âš ï¸ \"ç¾¤ä½“è¿‡äºåŒè´¨åŒ–ï¼Œå»ºè®®å¢åŠ å¤šæ ·æ€§\"\n    âš ï¸ \"æ£€æµ‹åˆ°æ½œåœ¨æ€§æ ¼å†²çªï¼ˆæŒ‘æˆ˜è€…Ã—3ï¼‰\"\n```\n\n**4. åœºåœ°é¢„è®¢ (Venue Booking)**\n```typescript\nDisplay:\n  - Selected venue details\n  - Booking confirmation status\n  - Venue contact info\n  - Special requests\n  \nActions:\n  - Change venue (shows recommendations)\n  - Confirm/Cancel booking\n  - Add special requests\n```\n\n**5. èŠå¤©ç›‘æ§ (Chat Monitoring)**\n```typescript\nLive Feed:\n  - Real-time event group chat messages\n  - Flagged messages highlighted\n  - User reports appear inline\n  \nAdmin Actions:\n  - Delete message\n  - Mute user\n  - Join chat as admin (visible to all)\n```\n\n**6. åé¦ˆæ€»ç»“ (Feedback Summary)**\n```typescript\nAfter event completion:\n  - Atmosphere score distribution\n  - Connection radar averages\n  - Attendee trait word cloud\n  - Improvement suggestions list\n  - Export feedback report\n```\n\n#### Bulk Event Operations\n\n**Filters:**\n- Date range\n- Status\n- Category\n- Venue\n- Min/Max attendees\n- Match score range\n\n**Bulk Actions:**\n```typescript\nSelect multiple events â†’ Actions:\n  - Send notification to all attendees\n  - Cancel events (with refund)\n  - Export event data (CSV)\n  - Duplicate events (create copies)\n  - Change category\n```\n\n#### Event Cancellation Flow\n\n```typescript\nWhen admin cancels event:\n\n1. Confirmation dialog:\n   \"ç¡®å®šè¦å–æ¶ˆæ´»åŠ¨å—ï¼Ÿè¿™å°†å½±å“ X ä½å·²æ³¨å†Œç”¨æˆ·\"\n   \n2. Cancellation reason (required):\n   - äººæ•°ä¸è¶³\n   - åœºåœ°é—®é¢˜\n   - ä¸å¯æŠ—åŠ›\n   - å…¶ä»–\n\n3. Refund options:\n   - å…¨é¢é€€æ¬¾ (Full refund)\n   - é€€æ¬¾è‡³é’±åŒ… (Refund to wallet credit)\n   - è½¬æ¢ä¸ºä¸‹æ¬¡æ´»åŠ¨æŠµç”¨åˆ¸ (Convert to event voucher)\n\n4. Process:\n   a) Update event status to \"cancelled\"\n   b) Process refunds via WeChat Pay\n   c) Send push notification to all attendees\n   d) Send apology email with reason\n   e) Log admin action\n   f) Release venue booking\n\n5. Follow-up (optional):\n   \"ä¸ºå—å½±å“ç”¨æˆ·æ¨èç±»ä¼¼æ´»åŠ¨\"\n   â†’ System suggests 3 similar upcoming events\n```\n\n---\n\n### 2.7 Matching Lab (ç®—æ³•è°ƒä¼˜å®éªŒå®¤)\n\n**File:** `client/src/pages/admin/AdminMatchingLabPage.tsx`\n\n#### Purpose\n\nInteractive tool for admins to:\n- Tune matching algorithm weights\n- Test matching outcomes with real user data\n- A/B test different matching strategies\n- Validate chemistry matrix accuracy\n\n#### Interface Components\n\n**1. Weight Adjustment Panel**\n\n```typescript\ninterface MatchingWeights {\n  personality: number;      // 40% default\n  interests: number;        // 25% default\n  background: number;       // 15% default\n  conversation: number;     // 10% default\n  intent: number;          // 10% default\n}\n\nUI:\n  - 5 sliders (0-100%)\n  - Auto-normalizes to 100% total\n  - \"Reset to Default\" button\n  - \"Save as Preset\" button\n  \nValidation:\n  - Sum must equal 100%\n  - Each weight >= 5% (prevent over-optimization)\n```\n\n**2. Test Matching Simulator**\n\n```typescript\nWorkflow:\n1. Admin selects event template\n2. System randomly samples N users from database\n   - Filters: City, age range, subscription status\n   - Sample size: 20-50 users\n\n3. Run matching algorithm with current weights\n   - Forms groups of 5-10\n   - Calculates match scores\n\n4. Display results:\n   a) Group Formation Table\n      - Group A: [User1, User2, ...]\n      - Avg Chemistry: 87%\n      - Archetype Mix: ğŸ™Œ ğŸ§­ ğŸ“– ğŸ¤ ğŸ¯\n      - Interest Overlap: 6 shared tags\n   \n   b) Score Distribution Chart\n      - Histogram of individual match scores\n      - Mean, median, std deviation\n   \n   c) Warnings/Insights\n      - \"Group C åŒè´¨åŒ–ç¨‹åº¦è¿‡é«˜ (92% éƒ½æ˜¯æ¢ç´¢è€…)\"\n      - \"Group A é¢„æµ‹å¯¹è¯æ·±åº¦: 8.2/10\"\n\n5. Admin can:\n   - Adjust weights â†’ Re-run\n   - Manually swap users between groups\n   - Export results for analysis\n```\n\n**3. A/B Testing Dashboard**\n\n```typescript\nCreate Test:\n  - Control: Current production weights\n  - Variant: New experimental weights\n  - Split: 50/50\n  - Duration: 2 weeks\n  - Success Metrics:\n    * Atmosphere score > 4.0\n    * Connection radar avg > 7.0\n    * User retention rate\n\nMonitor Results:\n  - Live stats table comparing Control vs Variant\n  - Statistical significance calculator\n  - Feedback quality comparison\n  - User satisfaction NPS\n\nDecision:\n  - \"Roll out to 100%\" button\n  - \"Discard variant\" button\n  - \"Run another week\" button\n```\n\n**4. Chemistry Matrix Editor**\n\n**14Ã—14 Compatibility Matrix:**\n\n```typescript\n// Example: ç«èŠ±å¡ compatibility with others\nconst chemistryMatrix = {\n  \"ç«èŠ±å¡\": {\n    \"ç«èŠ±å¡\": 75,    // Two spark plugs can compete\n    \"æ¢ç´¢è€…\": 92,    // High chemistry\n    \"æ•…äº‹å®¶\": 88,\n    \"æŒ‘æˆ˜è€…\": 78,\n    \"è¿æ¥è€…\": 85,\n    \"åè°ƒè€…\": 85,\n    \"æ°›å›´ç»„\": 82,\n    \"è‚¯å®šè€…\": 80,\n    ...\n  },\n  ...\n};\n\nUI:\n  - Heatmap visualization (green = high, red = low)\n  - Click cell to edit value (0-100)\n  - \"Import from CSV\" button\n  - \"Validate symmetry\" button (ensure Aâ†’B = Bâ†’A if desired)\n  - \"Reset to research-based defaults\" button\n\nValidation:\n  - Values between 0-100\n  - Warn if any pair < 50 (potential mismatch)\n  - Show impact simulation after edits\n```\n\n**5. Historical Performance Analytics**\n\n```typescript\nCharts:\n  1. Match Score vs Atmosphere Score (Scatter plot)\n     - X-axis: Predicted match score\n     - Y-axis: Actual atmosphere score\n     - Regression line\n     - RÂ² correlation coefficient\n  \n  2. Weight Impact Over Time (Line chart)\n     - Track how weight changes affect outcomes\n     - Compare periods before/after adjustments\n  \n  3. Archetype Pairing Success Rate (Heatmap)\n     - Which archetype pairs get highest feedback?\n     - Which pairs underperform?\n\nInsights:\n  - \"æ¢ç´¢è€… + æŒ‘æˆ˜è€… pairings consistently score 4.5+ atmosphere\"\n  - \"Increasing background weight from 15% â†’ 20% improved connection depth by 12%\"\n```\n\n---\n\n### 2.8 Content Management System\n\n**File:** `client/src/pages/admin/AdminContentPage.tsx`\n\n#### Purpose\n\nManage platform-wide content:\n- Announcements\n- FAQs\n- Community Guidelines\n- Terms of Service\n- Privacy Policy\n\n**Content Schema:**\n```sql\nCREATE TABLE contents (\n  id SERIAL PRIMARY KEY,\n  type VARCHAR(50), -- announcement/faq/guideline/terms/policy\n  title VARCHAR(255) NOT NULL,\n  title_en VARCHAR(255),\n  body TEXT NOT NULL,\n  body_en TEXT,\n  \n  -- Publishing\n  status VARCHAR(20) DEFAULT 'draft', -- draft/published/archived\n  publish_date TIMESTAMP,\n  expiry_date TIMESTAMP,\n  \n  -- Targeting\n  target_audience VARCHAR(50), -- all/new_users/subscribers/specific_city\n  city VARCHAR(50), -- Hong Kong/Shenzhen/All\n  \n  -- Display\n  priority INTEGER DEFAULT 0, -- Higher = shown first\n  show_in_app BOOLEAN DEFAULT true,\n  show_on_website BOOLEAN DEFAULT true,\n  \n  -- Metadata\n  author_id INTEGER REFERENCES users(id),\n  created_at TIMESTAMP DEFAULT NOW(),\n  updated_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n#### Admin Interface\n\n**Content List View:**\n\n**Tabs by Type:**\n- ğŸ“¢ Announcements\n- â“ FAQs\n- ğŸ“‹ Guidelines\n- ğŸ“„ Legal (Terms/Privacy)\n\n**Table Columns:**\n- Title\n- Type badge\n- Status badge\n- Target Audience\n- Publish Date\n- Views count\n- Actions\n\n**Create/Edit Content:**\n\n```typescript\nRich Text Editor:\n  - Markdown support\n  - Image upload\n  - Link insertion\n  - Preview mode\n  \nFields:\n  - Title (ä¸­æ–‡)\n  - Title (English)\n  - Body (ä¸­æ–‡) - Rich text\n  - Body (English) - Rich text\n  - Type dropdown\n  - Status: Draft/Published/Archived\n  - Publish date picker (schedule publishing)\n  - Expiry date (auto-archive)\n  - Target audience dropdown\n  - City filter\n  - Priority (0-10)\n  - Display toggles: App / Website\n  \nActions:\n  - Save as Draft\n  - Publish Now\n  - Schedule Publish\n  - Preview\n```\n\n**Announcement Publishing Flow:**\n\n```typescript\nWhen admin publishes announcement:\n\n1. Content status â†’ \"published\"\n2. If \"show_in_app\" = true:\n   - Push notification to targeted users\n   - Show banner in app home page\n   - Add to notification center\n3. If \"show_on_website\" = true:\n   - Display on website homepage\n4. Log publication event\n\nAuto-Archive:\n  - Daily cron job checks expiry_date\n  - If past expiry, status â†’ \"archived\"\n  - Remove from active displays\n```\n\n---\n\n### 2.9 Notification Push System\n\n**File:** `client/src/pages/admin/AdminNotificationsPage.tsx`\n\n#### Notification Types\n\n**System Notifications:**\n1. **Event Reminders**\n   - 72h before: \"æ‚¨çš„æ´»åŠ¨å³å°†å¼€å§‹ï¼Œå‚ä¸è€…ä¿¡æ¯å·²è§£é”\"\n   - 24h before: \"æ˜å¤©çš„æ´»åŠ¨åˆ«å¿˜äº†ï¼\"\n   - 2h before: \"æ´»åŠ¨å³å°†åœ¨2å°æ—¶åå¼€å§‹\"\n\n2. **Subscription Alerts**\n   - 7 days before expiry: \"æ‚¨çš„ä¼šå‘˜å³å°†åˆ°æœŸ\"\n   - On expiry: \"ä¼šå‘˜å·²è¿‡æœŸï¼Œç»­è´¹äº«85æŠ˜ä¼˜æƒ \"\n\n3. **Social Updates**\n   - New direct message\n   - Event chat mention\n   - New connection request\n\n**Admin Broadcast Notifications:**\n\n**Interface:**\n\n```typescript\nCreate Notification:\n\n1. Select Audience:\n   - å…¨éƒ¨ç”¨æˆ· (All users)\n   - æ´»è·ƒä¼šå‘˜ (Active subscribers)\n   - æ–°ç”¨æˆ· (Registered < 30 days)\n   - æµå¤±ç”¨æˆ· (Inactive > 60 days)\n   - ç‰¹å®šåŸå¸‚ (Hong Kong / Shenzhen)\n   - ç‰¹å®šæ€§æ ¼ (By archetype)\n   - è‡ªå®šä¹‰ç­›é€‰ (Custom filters)\n\n2. Compose Message:\n   - Title (Chinese + English)\n   - Body (Chinese + English)\n   - Action button:\n     * æŸ¥çœ‹è¯¦æƒ… â†’ Deep link URL\n     * ç«‹å³æŠ¥å â†’ Event ID\n     * ç«‹å³ç»­è´¹ â†’ Subscription page\n     * None\n   - Image (optional)\n\n3. Delivery Settings:\n   - Send immediately\n   - Schedule send (date + time)\n   - Send as test (to admin only)\n\n4. Preview:\n   - See how notification appears\n   - iOS vs Android preview\n   - In-app banner preview\n\n5. Send:\n   - Confirm audience size\n   - Click \"å‘é€é€šçŸ¥\"\n   - Show delivery progress\n   - View delivery report (opened/clicked rates)\n```\n\n**Delivery Logs:**\n\n**Table:**\n- Notification Title\n- Audience Size\n- Sent At\n- Delivery Rate (98.5%)\n- Open Rate (45.2%)\n- Click Rate (12.3%)\n- Actions (View Details, Resend)\n\n---\n\n### 2.10 Moderation System (Content & User Reports)\n\n**File:** `client/src/pages/admin/AdminModerationPage.tsx`, `client/src/pages/admin/AdminReportsPage.tsx`\n\n#### Chat Moderation Queue\n\n**Report Sources:**\n1. User-submitted reports (via \"ä¸¾æŠ¥\" button in chat)\n2. Auto-flagged messages (keyword detection)\n3. Multiple user blocks (same person blocked by 3+ users)\n\n**Moderation Dashboard:**\n\n**Tabs:**\n- å¾…å¤„ç† (Pending) - New reports\n- å¤„ç†ä¸­ (In Review) - Admin reviewing\n- å·²è§£å†³ (Resolved) - Action taken\n- å·²é©³å› (Dismissed) - No action needed\n\n**Report Card:**\n\n```typescript\nDisplay:\n  - Reporter: User A (ID: 123)\n  - Reported User: User B (ID: 456)\n  - Report Type: ä¸å½“è¨€è®º / éªšæ‰° / åƒåœ¾ä¿¡æ¯\n  - Reported Message: \"...\" (with context - 3 messages before/after)\n  - Event: æ·±å¤œé£Ÿå ‚æ´»åŠ¨ #789\n  - Timestamp: 2025-11-14 20:35:12\n  - Report Description: \"ç”¨æˆ·ä½¿ç”¨ä¸å°Šé‡çš„è¯­è¨€\"\n  \nContext Panel:\n  - User B's profile summary\n  - User B's past reports (received + filed)\n  - Event chat history (full conversation)\n  \nAdmin Actions:\n  1. åˆ é™¤æ¶ˆæ¯ (Delete message)\n     - Remove from database\n     - Notify reported user\n  \n  2. è­¦å‘Šç”¨æˆ· (Warn user)\n     - Send warning notification\n     - Log warning count\n     - No immediate penalty\n  \n  3. ä¸´æ—¶ç¦è¨€ (Mute - 24/48/72 hours)\n     - User can read but not send messages\n     - Applies to all chats\n  \n  4. æ°¸ä¹…ç¦è¨€ (Permanent chat ban)\n     - User cannot access any chat features\n     - Can still attend events\n  \n  5. å°ç¦è´¦å· (Suspend account)\n     - User cannot login\n     - All future events cancelled with refund\n     - Lasts: 7/30/90 days or permanent\n  \n  6. é©³å›ä¸¾æŠ¥ (Dismiss report)\n     - No action taken\n     - Add admin notes explaining why\n\nAdmin Notes:\n  - Text field for moderation decision rationale\n  - Required for all actions\n  - Logged for audit trail\n```\n\n**Automated Flagging System:**\n\n```typescript\n// Keyword detection\nconst flaggedKeywords = {\n  harassment: [\"å‚»é€¼\", \"æ»šè›‹\", \"å»æ­»\", ...],\n  spam: [\"åŠ å¾®ä¿¡\", \"ä¹°å–\", \"æŠ•èµ„\", ...],\n  inappropriate: [\"è‰²æƒ…\", \"èµŒåš\", ...],\n};\n\n// Message processing\nonNewMessage((message) => {\n  for (const [category, keywords] of Object.entries(flaggedKeywords)) {\n    if (keywords.some(kw => message.content.includes(kw))) {\n      createAutoReport({\n        messageId: message.id,\n        category: category,\n        confidence: 0.8,\n        requiresHumanReview: true\n      });\n    }\n  }\n});\n```\n\n#### User Report Management\n\n**File:** `client/src/pages/admin/AdminReportsPage.tsx`\n\n**Report Types:**\n- ğŸš« ä¸å½“è¡Œä¸º (Inappropriate behavior) - At events\n- ğŸ’¬ èŠå¤©è¿è§„ (Chat violation)\n- ğŸ“¸ ä¸å½“å¤´åƒ/èµ„æ–™ (Inappropriate profile)\n- ğŸ’° æ”¯ä»˜çº çº· (Payment dispute)\n- ğŸ› ç³»ç»Ÿé—®é¢˜ (Bug report)\n- ğŸ’¡ åŠŸèƒ½å»ºè®® (Feature suggestion)\n\n**Report Workflow:**\n\n**User submits report:**\n```typescript\nPOST /api/reports/submit\n{\n  reportType: \"inappropriate_behavior\",\n  targetUserId: 456,\n  eventId: 789,\n  description: \"ç”¨æˆ·åœ¨æ´»åŠ¨ä¸­æœ‰å†’çŠ¯æ€§è¨€è®º\",\n  evidence: [\"screenshot_url_1.jpg\"]\n}\n```\n\n**Admin reviews:**\n1. View full context (event, chat logs, user history)\n2. Contact reporter for more details (optional)\n3. Contact reported user for their side (optional)\n4. Make decision\n5. Take action (warn/suspend/ban)\n6. Notify both parties of outcome\n7. Close report with resolution notes\n\n**Report Analytics:**\n```typescript\nMetrics:\n  - Reports by type (pie chart)\n  - Reports over time (line chart)\n  - Repeat offenders list\n  - Average resolution time\n  - Admin response time\n```\n\n---\n\n### 2.11 Data Insights Dashboard (è¿è¥å†³ç­–æŒ‡æŒ¥ä¸­å¿ƒ)\n\n**File:** `client/src/pages/admin/AdminDataInsightsPage.tsx`\n\n#### Purpose\n\nComprehensive analytics dashboard for data-driven decision making.\n\n#### Module 1: User Scale Metrics (ç”¨æˆ·è§„æ¨¡æŒ‡æ ‡)\n\n**Metrics:**\n\n1. **Total Registered Users**\n   ```typescript\n   Count: 2,458\n   7-day growth: +12.3%\n   30-day growth: +45.6%\n   ```\n\n2. **Active Users (å®šä¹‰ï¼š30å¤©å†…æœ‰æ´»åŠ¨)**\n   ```typescript\n   DAU (Daily Active): 245\n   WAU (Weekly Active): 856\n   MAU (Monthly Active): 1,823\n   \n   Chart: DAU/MAU trend (last 90 days)\n   ```\n\n3. **User Acquisition Funnel**\n   ```mermaid\n   Landing Page Views: 10,000\n         â†“ 45%\n   Started Registration: 4,500\n         â†“ 68%\n   Completed Profile: 3,060\n         â†“ 55%\n   Took Personality Test: 1,683\n         â†“ 48%\n   Attended First Event: 808\n   ```\n\n4. **User Distribution**\n   - By City: Hong Kong 62% | Shenzhen 38%\n   - By Age: 22-25 (28%) | 26-30 (45%) | 31-35 (27%)\n   - By Gender: F 58% | M 39% | Other 3%\n\n#### Module 2: Business Health (ä¸šåŠ¡å¥åº·åº¦)\n\n**Revenue Metrics:**\n\n```typescript\n1. MRR (Monthly Recurring Revenue)\n   Current: Â¥45,680\n   Growth: +8.2% MoM\n   \n2. ARR (Annual Run Rate)\n   Projection: Â¥548,160\n\n3. Revenue Breakdown\n   - Subscriptions: 78%\n   - Single Event Tickets: 22%\n   \n4. Subscription Distribution\n   - Monthly: 65%\n   - Quarterly: 35%\n\n5. ARPU (Average Revenue Per User)\n   - All users: Â¥18.60\n   - Subscribers only: Â¥98.50\n   \n6. LTV (Customer Lifetime Value)\n   - Average: Â¥586\n   - By cohort chart (first-month cohort retention)\n```\n\n**Health Indicators:**\n\n```typescript\n1. Churn Rate\n   Monthly: 12.3%\n   Target: < 15%\n   Status: âœ… Healthy\n   \n2. Subscription Renewal Rate\n   Auto-renew enabled: 68%\n   Manual renewal: 23%\n   \n3. Payment Success Rate\n   WeChat Pay: 98.7%\n   \n4. Refund Rate\n   Current month: 2.1%\n   Target: < 5%\n   Status: âœ… Healthy\n```\n\n#### Module 3: Matching Efficiency (åŒ¹é…æ•ˆç‡)\n\n**Algorithm Performance:**\n\n```typescript\n1. Average Match Score\n   Group Chemistry: 87.3%\n   Personal Fit: 89.1%\n   \n2. Match Score Distribution\n   Histogram:\n   - 90-100%: 35% of events\n   - 80-89%: 52% of events\n   - 70-79%: 11% of events\n   - < 70%: 2% of events\n   \n3. Match Accuracy (é¢„æµ‹ vs å®é™…)\n   Correlation Analysis:\n   - Predicted Match Score vs Actual Atmosphere Score\n   - RÂ² = 0.73 (strong correlation)\n   - Scatter plot with regression line\n```\n\n**Matching Success Metrics:**\n\n```typescript\n1. Event Fill Rate\n   - Events reaching min capacity: 94%\n   - Events reaching max capacity: 67%\n   \n2. Average Time to Fill\n   - From \"matching\" to \"confirmed\": 3.2 days\n   \n3. Archetype Distribution in Events\n   - Stacked bar chart showing mix across events\n   - Highlight: Most diverse events score higher\n   \n4. Interest Overlap Quality\n   - Average shared interests per event: 4.8\n   - Sweet spot: 4-6 shared interests = best outcomes\n```\n\n#### Module 4: User Retention (ç”¨æˆ·ç•™å­˜)\n\n**Cohort Analysis:**\n\n```typescript\n// Retention table by registration month\nMonth 0: 100% (baseline)\nMonth 1: 45%  â† Critical drop-off point\nMonth 2: 32%\nMonth 3: 28%\nMonth 6: 22%\nMonth 12: 18%\n\nVisualization: Retention curve by cohort\n```\n\n**Engagement Metrics:**\n\n```typescript\n1. Events per User\n   - 0 events: 35% (æœªæ¿€æ´»)\n   - 1 event: 28% (ä½“éªŒç”¨æˆ·)\n   - 2-5 events: 25% (æ´»è·ƒç”¨æˆ·)\n   - 6+ events: 12% (è¶…çº§ç”¨æˆ·)\n   \n2. Repeat Event Rate\n   - Users who attend 2+ events: 37%\n   - Target: > 40%\n   \n3. Social Graph Density\n   - Average connections per user: 3.2\n   - Users with 5+ connections: 18%\n   - Connection â†’ Retention correlation: +0.65\n```\n\n**Reactivation Metrics:**\n\n```typescript\n1. Dormant Users (60+ days inactive)\n   Count: 423\n   Reactivation attempts: 120\n   Reactivated: 28 (23% success rate)\n   \n2. Churn Prevention\n   - Users flagged as at-risk: 87\n   - Intervention: Personalized event recommendations\n   - Saved: 34 (39% save rate)\n```\n\n#### Module 5: Activity Quality (æ´»åŠ¨è´¨é‡)\n\n**Event Satisfaction:**\n\n```typescript\n1. Atmosphere Score Distribution\n   Average: 4.2 / 5.0\n   \n   5 stars (ğŸŒˆ å®Œç¾): 38%\n   4 stars (ğŸ”¥ çƒ­çƒˆ): 45%\n   3 stars (â˜€ï¸ æ¸©æš–): 14%\n   2 stars (ğŸŒ¥ï¸ å¾®å‡‰): 2.5%\n   1 star (â„ï¸ å†°ç‚¹): 0.5%\n   \n2. Connection Depth (Radar Metrics)\n   - è¯é¢˜æ·±åº¦: 7.8 / 10\n   - æƒ…æ„Ÿå…±é¸£: 7.5 / 10\n   - ä»·å€¼è§‚å¥‘åˆ: 7.2 / 10\n   - åç»­æ„æ„¿: 8.1 / 10\n   \n3. Event NPS (Net Promoter Score)\n   - Promoters (9-10): 52%\n   - Passives (7-8): 38%\n   - Detractors (0-6): 10%\n   - NPS: +42 (Excellent)\n```\n\n**Quality Trends:**\n\n```typescript\n1. Satisfaction by Event Type\n   - Dining: 4.3 â­\n   - Outdoor: 4.5 â­\n   - Learning: 4.0 â­\n   - Creative: 4.2 â­\n   \n2. Satisfaction by Group Size\n   - 5-6 people: 4.4 â­\n   - 7-8 people: 4.2 â­\n   - 9-10 people: 3.9 â­\n   Insight: Smaller = better\n   \n3. Venue Performance\n   - Top 5 venues by avg satisfaction\n   - Bottom 5 venues needing improvement\n```\n\n#### Module 6: Revenue Conversion Funnel\n\n```typescript\nStage 1: Landing Page Visit\n  â†“ 45% conversion\nStage 2: Started Registration\n  â†“ 68% completion\nStage 3: Completed Profile\n  â†“ 35% take personality test\nStage 4: Completed Personality Test\n  â†“ 25% browse events\nStage 5: Clicked Event\n  â†“ 40% initiated payment\nStage 6: Completed Payment\n  (FIRST REVENUE)\n  \nRevenue Conversion Rate: 2.7%\nAverage Time to First Payment: 5.2 days\n\nOptimization Opportunities:\n  - Biggest drop: Profile â†’ Personality Test (65% drop)\n  - Action: Gamify test, show example results\n```\n\n#### Module 7: Social Role Distribution (ç¤¾äº¤è§’è‰²åˆ†å¸ƒ)\n\n**Archetype Analytics:**\n\n```typescript\n1. Overall Distribution\n   Pie Chart:\n   - è¿æ¥è€…: 18.5%\n   - æ¢ç´¢è€…: 16.2%\n   - æ•…äº‹å®¶: 14.8%\n   - ç«èŠ±å¡: 13.1%\n   - è‚¯å®šè€…: 12.3%\n   - æ°›å›´ç»„: 10.7%\n   - åè°ƒè€…: 9.4%\n   - æŒ‘æˆ˜è€…: 5.0%\n   \n2. Archetype Engagement\n   - Highest retention: è¿æ¥è€… (28% at 6 months)\n   - Most active: ç«èŠ±å¡ (avg 4.8 events)\n   - Best feedback givers: æ¢ç´¢è€… (85% provide deep feedback)\n   \n3. Archetype Pairing Success\n   Heatmap: 8x8 matrix\n   - Best pairs: æ¢ç´¢è€… Ã— ç«èŠ±å¡ (4.6 avg atmosphere)\n   - Challenging pairs: æŒ‘æˆ˜è€… Ã— æŒ‘æˆ˜è€… (3.8 avg)\n   \n4. Archetype Trends Over Time\n   - Are certain archetypes growing?\n   - Seasonality in archetype registrations?\n   Line chart: Monthly archetype sign-ups\n```\n\n**Strategic Insights:**\n\n```typescript\nAuto-Generated Insights:\n  âœ… \"è¿æ¥è€… archetype has highest retention - recruit more!\"\n  âš ï¸ \"æŒ‘æˆ˜è€… users are underrepresented (5%) - adjust marketing\"\n  ğŸ’¡ \"Events with 2+ ç«èŠ±å¡ have 15% higher satisfaction\"\n  ğŸ“Š \"æ¢ç´¢è€… users prefer learning events (2.3x attendance)\"\n```\n\n---\n\n### 2.12 Feedback Management\n\n**File:** `client/src/pages/admin/AdminFeedbackPage.tsx`\n\n#### Interface\n\n**Filters:**\n```typescript\n- Event: Dropdown (all events)\n- Date Range: Picker\n- Atmosphere Score: 1-5 stars filter\n- Has Deep Feedback: Yes/No\n- Search: By user name or event title\n```\n\n**Feedback List View:**\n\n**Card Display:**\n```typescript\nFor each feedback:\n  - Event title + date\n  - User name + archetype badge\n  - æ°›å›´æ¸©åº¦è®¡: â­â­â­â­â­ (5/5)\n  - Connection Radar mini-chart (spark line)\n  - Connected with: 3 attendees\n  - Deep feedback badge (if exists)\n  - Click to expand\n```\n\n**Expanded Feedback Detail:**\n\n```typescript\nModal/Panel showing:\n\n1. Basic Feedback Section:\n   - Atmosphere Score: Large thermometer visual\n   - Connection Radar: Full-size chart\n   - Connected Users: Avatars + names\n   - Attendee Traits Applied:\n     User A: ğŸ¯ æ·±åº¦æ€è€ƒè€…, ğŸ˜Š å¹½é»˜é£è¶£\n     User B: ğŸ¤ å–„äºå€¾å¬, ğŸ’¡ è§‚ç‚¹ç‹¬ç‰¹\n   - Improvement Suggestions: Full text\n\n2. Deep Feedback Section (if exists):\n   - Match Accuracy: 8/10\n   - Ideal Group Profile: Age 26-30, Tech/Creative, æ·±åº¦æ¢è®¨\n   - Mismatch Factors: \"æ€§æ ¼å·®å¼‚æ˜æ˜¾\"\n   - Algorithm Suggestions: User's text feedback\n\n3. Admin Notes:\n   - Text area to add internal notes\n   - Not visible to user\n   - Saved to database\n\n4. Actions:\n   - Export this feedback\n   - Flag for review\n   - Mark as addressed\n```\n\n**Feedback Statistics Panel:**\n\n```typescript\nTop Summary Cards:\n  - Total Feedbacks: 1,234\n  - Avg Atmosphere: 4.2 / 5.0\n  - Deep Feedback Rate: 34%\n  - Response Rate: 78%\n\nCharts:\n  1. Atmosphere Distribution (Bar chart)\n  2. Connection Depth Trends (Line chart over time)\n  3. Top Improvement Themes (Word cloud)\n     - \"å»¶é•¿æ—¶é—´\"\n     - \"æ›´å®‰é™åœºåœ°\"\n     - \"è¯é¢˜å¼•å¯¼\"\n  4. Match Accuracy Distribution (Histogram)\n```\n\n**Export Options:**\n```typescript\n- Export filtered feedbacks as CSV\n- Export aggregate statistics as PDF report\n- Export deep feedback insights for matching lab\n```\n\n---\n\n### 2.13 Real-Time WebSocket Integration\n\n**File:** `server/wsService.ts`, `client/src/hooks/useWebSocket.ts`\n\n#### Architecture\n\n**Backend WebSocket Service:**\n\n```typescript\n// server/wsService.ts\nclass WebSocketService {\n  private wss: WebSocketServer;\n  private userConnections: Map<userId, WebSocket>;\n  \n  // Broadcast to specific user\n  sendToUser(userId: number, message: any) {\n    const ws = this.userConnections.get(userId);\n    if (ws?.readyState === WebSocket.OPEN) {\n      ws.send(JSON.stringify(message));\n    }\n  }\n  \n  // Broadcast to all event attendees\n  broadcastToEvent(eventId: number, message: any) {\n    const attendees = await getEventAttendees(eventId);\n    for (const attendee of attendees) {\n      this.sendToUser(attendee.userId, message);\n    }\n  }\n  \n  // Broadcast to all admins\n  broadcastToAdmins(message: any) {\n    const admins = await getAdminUsers();\n    for (const admin of admins) {\n      this.sendToUser(admin.id, message);\n    }\n  }\n}\n```\n\n**Message Types:**\n\n```typescript\n// User app messages\ntype WSMessage = \n  | { type: 'chat_message'; payload: ChatMessage }\n  | { type: 'event_updated'; payload: { eventId, status } }\n  | { type: 'new_connection'; payload: { fromUser } }\n  | { type: 'typing_indicator'; payload: { userId, isTyping } }\n  | { type: 'subscription_activated'; payload: { tier, endDate } }\n\n// Admin messages\ntype AdminWSMessage =\n  | { type: 'new_user_registered'; payload: User }\n  | { type: 'payment_completed'; payload: Payment }\n  | { type: 'chat_report_filed'; payload: ChatReport }\n  | { type: 'event_filled'; payload: Event }\n  | { type: 'high_quality_feedback'; payload: Feedback }\n```\n\n**Frontend Hook:**\n\n```typescript\n// client/src/hooks/useWebSocket.ts\nexport function useWebSocket() {\n  const [isConnected, setIsConnected] = useState(false);\n  const ws = useRef<WebSocket>();\n  \n  useEffect(() => {\n    // Connect with auth token\n    ws.current = new WebSocket(\n      `wss://${window.location.host}/ws?token=${getAuthToken()}`\n    );\n    \n    ws.current.onopen = () => setIsConnected(true);\n    ws.current.onclose = () => setIsConnected(false);\n    \n    ws.current.onmessage = (event) => {\n      const message = JSON.parse(event.data);\n      handleMessage(message);\n    };\n    \n    return () => ws.current?.close();\n  }, []);\n  \n  const handleMessage = (message: WSMessage) => {\n    switch (message.type) {\n      case 'chat_message':\n        queryClient.invalidateQueries(['/api/chats', message.payload.eventId]);\n        break;\n      case 'event_updated':\n        queryClient.invalidateQueries(['/api/events', message.payload.eventId]);\n        showToast('æ´»åŠ¨ä¿¡æ¯å·²æ›´æ–°');\n        break;\n      // ... other handlers\n    }\n  };\n  \n  return { isConnected, send: (msg) => ws.current?.send(JSON.stringify(msg)) };\n}\n```\n\n**Use Cases:**\n\n1. **Event Status Changes**\n   ```typescript\n   // Admin confirms event\n   await updateEventStatus(eventId, 'confirmed');\n   broadcastToEvent(eventId, {\n     type: 'event_updated',\n     payload: { eventId, status: 'confirmed' }\n   });\n   // All attendees' UI updates instantly\n   ```\n\n2. **Chat Messages**\n   ```typescript\n   // User sends message\n   const message = await createChatMessage({ eventId, content });\n   broadcastToEvent(eventId, {\n     type: 'chat_message',\n     payload: message\n   });\n   // All participants see message in real-time\n   ```\n\n3. **Payment Confirmation**\n   ```typescript\n   // WeChat webhook confirms payment\n   await markPaymentCompleted(paymentId);\n   sendToUser(userId, {\n     type: 'subscription_activated',\n     payload: { tier: 'monthly', endDate: ... }\n   });\n   // User sees confirmation instantly\n   ```\n\n4. **Admin Notifications**\n   ```typescript\n   // New user registers\n   const user = await createUser(userData);\n   broadcastToAdmins({\n     type: 'new_user_registered',\n     payload: user\n   });\n   // Admin dashboard updates in real-time\n   ```\n\n---\n\n## ğŸ—ï¸ Technical Architecture\n\n### 3.1 Technology Stack\n\n**Frontend:**\n- React 18 + TypeScript\n- Vite (build tool)\n- Wouter (routing)\n- TanStack Query v5 (server state)\n- Radix UI + shadcn/ui (components)\n- Tailwind CSS (styling)\n- Recharts (data visualization)\n- Framer Motion (animations)\n\n**Backend:**\n- Node.js + Express.js\n- TypeScript\n- PostgreSQL (Neon serverless)\n- Drizzle ORM\n- WebSocket (ws library)\n- Express Session (authentication)\n\n**Authentication:**\n- Phone number + SMS verification\n- bcrypt password hashing\n- PostgreSQL session store (7-day persistence)\n\n**Payment:**\n- WeChat Pay JSAPI integration\n- Webhook signature verification\n- Idempotency handling\n\n**Real-Time:**\n- WebSocket connections\n- Event-based message broadcasting\n- Auto-reconnection on disconnect\n\n---\n\n### 3.2 Database Schema Summary\n\n**Core Tables:**\n\n1. **users** - User profiles + personality data\n2. **subscriptions** - Subscription records\n3. **payments** - Payment transactions\n4. **coupons** - Discount codes\n5. **events** - Event listings\n6. **event_templates** - Reusable event templates\n7. **event_attendance** - User-event registrations\n8. **event_feedback** - Post-event feedback\n9. **venues** - Partner venue database\n10. **venue_bookings** - Event-venue reservations\n11. **chat_messages** - Event group chat\n12. **direct_message_threads** - 1-on-1 conversation containers\n13. **direct_messages** - 1-on-1 messages\n14. **chat_reports** - User-reported messages\n15. **chat_logs** - Technical chat audit logs\n16. **contents** - CMS content (announcements, FAQs)\n17. **notifications** - Push notification records\n18. **event_pools** - Admin-created blind box event pools\n19. **event_pool_registrations** - User registrations with soft preferences\n20. **event_pool_groups** - Matched groups (v1.1: added `energyBalance`, `temperatureLevel`)\n21. **matching_thresholds** - Configurable matching parameters (NEW v1.1)\n22. **pool_matching_logs** - Matching decision history (NEW v1.1)\n23. **invitations** - User invitation records\n24. **invitation_uses** - Invitation reward tracking (NEW v1.1)\n25. **user_coupons** - User coupon assignments (NEW v1.1)\n\n**Full schema:** See `shared/schema.ts` (3000+ lines)\n\n---\n\n### 3.3 API Endpoints Summary\n\n**Public Routes:**\n- `POST /api/phone/register` - Send SMS verification\n- `POST /api/phone/verify` - Verify code + create session\n- `POST /api/phone/login` - Existing user login\n\n**User Routes** (requires authentication):\n- `GET /api/auth/user` - Get current user\n- `POST /api/personality-test/submit` - Submit test answers\n- `GET /api/personality-test/results` - Get test results\n- `GET /api/personality-test/stats` - Get archetype distribution\n- `GET /api/events` - List events\n- `GET /api/events/:id` - Event details\n- `POST /api/events/:id/register` - Register for event\n- `POST /api/payments/create` - Create payment\n- `POST /api/coupons/validate` - Validate coupon code\n- `GET /api/chats/:eventId` - Get event chat messages\n- `POST /api/chats/:eventId/message` - Send message\n- `POST /api/chat/report` - Report message\n- `POST /api/feedback/submit` - Submit event feedback\n- `PATCH /api/profile` - Update profile\n\n**Admin Routes** (requires admin role):\n- `GET /api/admin/stats` - Dashboard metrics\n- `GET /api/admin/users` - List users\n- `GET /api/admin/users/:id` - User details\n- `PATCH /api/admin/users/:id` - Update user\n- `DELETE /api/admin/users/:id` - Delete user\n- `GET /api/admin/subscriptions` - List subscriptions\n- `POST /api/admin/subscriptions/grant` - Grant free subscription\n- `GET /api/admin/payments` - Payment history\n- `POST /api/admin/payments/refund` - Issue refund\n- `GET /api/admin/venues` - List venues\n- `POST /api/admin/venues` - Create venue\n- `GET /api/admin/event-templates` - List templates\n- `POST /api/admin/event-templates` - Create template\n- `GET /api/admin/events` - List all events (admin view)\n- `POST /api/admin/events` - Create event\n- `PATCH /api/admin/events/:id` - Update event\n- `DELETE /api/admin/events/:id` - Cancel event\n- `POST /api/admin/events/book-venue` - Book venue\n- `GET /api/admin/feedbacks` - List feedbacks\n- `GET /api/admin/feedbacks/:id` - Feedback details\n- `GET /api/admin/feedbacks/stats` - Aggregate stats\n- `GET /api/admin/moderation/reports` - Chat reports\n- `PATCH /api/admin/moderation/reports/:id` - Take action\n- `GET /api/admin/chat-logs` - Query chat logs\n- `GET /api/admin/contents` - CMS content list\n- `POST /api/admin/contents` - Create content\n- `POST /api/admin/notifications/broadcast` - Send notification\n- `GET /api/admin/data-insights` - Analytics data\n- `POST /api/admin/matching/test` - Test matching algorithm\n- `PATCH /api/admin/matching/weights` - Update weights\n- `GET /api/admin/matching-thresholds` - Get pool matching thresholds (NEW v1.1)\n- `PUT /api/admin/matching-thresholds/:poolId` - Update thresholds (NEW v1.1)\n- `POST /api/admin/trigger-matching/:poolId` - Manually trigger matching (NEW v1.1)\n- `GET /api/admin/matching-logs` - Get matching decision history (NEW v1.1)\n\n**Full API documentation:** See `server/routes.ts` (3400+ lines)\n\n---\n\n### 3.4 Matching Algorithm Deep Dive\n\n#### Traditional Event Matching (1-on-1 Compatibility)\n\n**File:** `server/userMatchingService.ts`\n\n**5-Dimensional Scoring System:**\n\n```typescript\nfunction calculateUserMatchScore(user1, user2, weights) {\n  // 1. Personality Compatibility (40% default)\n  const personalityScore = chemistryMatrix[user1.primaryRole][user2.primaryRole];\n  \n  // 2. Interest Overlap (25% default)\n  const sharedInterests = intersection(user1.interests, user2.interests);\n  const interestScore = (sharedInterests.length / \n    union(user1.interests, user2.interests).length) * 100;\n  \n  // 3. Background Alignment (15% default)\n  const educationMatch = user1.educationLevel === user2.educationLevel ? 80 : 50;\n  const industryMatch = user1.industry === user2.industry ? 90 : 60;\n  const backgroundScore = (educationMatch + industryMatch) / 2;\n  \n  // 4. Conversation Compatibility (10% default)\n  const opennessGap = Math.abs(user1.opennessScore - user2.opennessScore);\n  const extraversionGap = Math.abs(user1.extraversionScore - user2.extraversionScore);\n  const conversationScore = 100 - ((opennessGap + extraversionGap) / 20 * 100);\n  \n  // 5. Intent Alignment (10% default)\n  const intentMatch = user1.intent === user2.intent ? 100 : 70;\n  \n  // Weighted sum\n  return (\n    personalityScore * weights.personality +\n    interestScore * weights.interests +\n    backgroundScore * weights.background +\n    conversationScore * weights.conversation +\n    intentMatch * weights.intent\n  );\n}\n```\n\n**Group Formation Algorithm:**\n\n```typescript\nfunction matchUsersToGroups(users, eventMaxAttendees, weights) {\n  // 1. Calculate all pairwise match scores\n  const scores = {};\n  for (const u1 of users) {\n    for (const u2 of users) {\n      if (u1.id < u2.id) {\n        scores[`${u1.id}-${u2.id}`] = calculateUserMatchScore(u1, u2, weights);\n      }\n    }\n  }\n  \n  // 2. Greedy clustering algorithm\n  const groups = [];\n  const assigned = new Set();\n  \n  while (assigned.size < users.length) {\n    const group = [];\n    \n    // Start with highest-scoring unassigned user\n    const seed = users\n      .filter(u => !assigned.has(u.id))\n      .sort((a, b) => b.totalConnectionScore - a.totalConnectionScore)[0];\n    \n    group.push(seed);\n    assigned.add(seed.id);\n    \n    // Add users with best average match to group\n    while (group.length < eventMaxAttendees) {\n      const candidates = users.filter(u => !assigned.has(u.id));\n      if (candidates.length === 0) break;\n      \n      const bestCandidate = candidates.map(candidate => {\n        const avgScore = mean(group.map(member => \n          scores[`${Math.min(member.id, candidate.id)}-${Math.max(member.id, candidate.id)}`]\n        ));\n        return { user: candidate, score: avgScore };\n      }).sort((a, b) => b.score - a.score)[0];\n      \n      group.push(bestCandidate.user);\n      assigned.add(bestCandidate.user.id);\n    }\n    \n    groups.push(group);\n  }\n  \n  return groups;\n}\n```\n\n**Chemistry Matrix (14Ã—14):**\n\nStored in: `server/archetypeChemistry.ts`\n\nSample values:\n```typescript\nconst chemistryMatrix = {\n  \"ç«èŠ±å¡\": {\n    \"ç«èŠ±å¡\": 75, \"æ¢ç´¢è€…\": 92, \"æ•…äº‹å®¶\": 88, \"æŒ‘æˆ˜è€…\": 78,\n    \"è¿æ¥è€…\": 85, \"åè°ƒè€…\": 85, \"æ°›å›´ç»„\": 82, \"è‚¯å®šè€…\": 80, ...\n  },\n  \"æ¢ç´¢è€…\": {\n    \"ç«èŠ±å¡\": 92, \"æ¢ç´¢è€…\": 80, \"æ•…äº‹å®¶\": 86, \"æŒ‘æˆ˜è€…\": 90,\n    \"è¿æ¥è€…\": 86, \"åè°ƒè€…\": 84, \"æ°›å›´ç»„\": 75, \"è‚¯å®šè€…\": 82, ...\n  },\n  // ... 14Ã—14 = 196 unique compatibility scores\n};\n```\n\n---\n\n#### Event Pool Matching (Blind Box Group Formation)\n\n**Files:** `server/poolMatchingService.ts`, `server/archetypeChemistry.ts`\n\n**Two-Stage Matching Model:**\n\n**Stage 1:** Admin creates event pools with hard constraints\n- Time, location, gender/industry/seniority restrictions\n- Pool capacity (e.g., 50 users â†’ 5 groups of 10)\n\n**Stage 2:** Users register with soft preferences, AI matches within pool\n- Combines permanent user profiles with temporary event preferences\n- Forms optimal groups balancing compatibility, diversity, and energy\n\n**Corrected Scoring Formula (Nov 20, 2025):**\n\n**CRITICAL FIX:** Removed diversity double-counting bug\n\n```typescript\n// Pair Compatibility Score (é…å¯¹å…¼å®¹æ€§) - 100%\nfunction calculatePairScore(user1, user2, reg1, reg2) {\n  // 1. Chemistry (37.5%) - Personality archetype compatibility\n  const chemistry = CHEMISTRY_MATRIX[user1.primaryRole][user2.primaryRole];\n  \n  // 2. Interest Overlap (31.25%) - Shared topics\n  const sharedInterests = intersection(user1.interests, user2.interests);\n  const interest = (sharedInterests.length / \n    union(user1.interests, user2.interests).length) * 100;\n  \n  // 3. Event Preferences (25%) - Budget, cuisine, goals alignment\n  const budgetMatch = budgetsOverlap(reg1.budgetRange, reg2.budgetRange) ? 90 : 50;\n  const cuisineMatch = overlap(reg1.cuisinePreferences, reg2.cuisinePreferences);\n  const goalMatch = overlap(reg1.socialGoals, reg2.socialGoals);\n  const preference = (budgetMatch + cuisineMatch + goalMatch) / 3;\n  \n  // 4. Language Compatibility (18.75%) - Communication ability\n  const language = overlap(reg1.languages, reg2.languages);\n  \n  // Pure compatibility score (NO diversity counted here)\n  return chemistry * 0.375 + interest * 0.3125 + preference * 0.25 + language * 0.1875;\n}\n\n// Group Diversity Score (ç¾¤ä½“å¤šæ ·æ€§) - Separate calculation\nfunction calculateGroupDiversity(group) {\n  // Diversity metrics (only counted ONCE at group level)\n  const uniqueIndustries = new Set(group.map(u => u.industry)).size;\n  const uniqueEducation = new Set(group.map(u => u.educationLevel)).size;\n  const uniqueRoles = new Set(group.map(u => u.primaryRole)).size;\n  \n  const industryDiversity = (uniqueIndustries / group.length) * 100;\n  const educationDiversity = (uniqueEducation / group.length) * 100;\n  const roleDiversity = (uniqueRoles / group.length) * 100;\n  \n  return (industryDiversity + educationDiversity + roleDiversity) / 3;\n}\n\n// Energy Balance Score (èƒ½é‡å¹³è¡¡åº¦) - NEW in v1.1\nfunction calculateEnergyBalance(group) {\n  // Map each archetype to energy level (0-100 scale)\n  const energyLevels = group.map(u => ARCHETYPE_ENERGY[u.primaryRole]);\n  const avgEnergy = mean(energyLevels);\n  const stdDev = standardDeviation(energyLevels);\n  \n  // Ideal: average energy 50-70, low standard deviation\n  const avgScore = avgEnergy >= 50 && avgEnergy <= 70 ? 100 : \n                   Math.max(0, 100 - Math.abs(avgEnergy - 60) * 2);\n  const harmonyScore = Math.max(0, 100 - stdDev * 3);\n  \n  return (avgScore + harmonyScore) / 2;\n}\n\n// Overall Group Score (ç»¼åˆåˆ†æ•°) - UPDATED FORMULA\nfunction formOptimalGroups(pool) {\n  // For each candidate group:\n  const avgPairScore = mean(allPairScores); // Average compatibility\n  const groupDiversity = calculateGroupDiversity(group); // Background richness\n  const energyBalance = calculateEnergyBalance(group); // Energy harmony\n  \n  // New weighted formula (changed from 70/30 to 60/25/15)\n  const overallScore = \n    avgPairScore * 0.6 +      // Pair compatibility (similarity)\n    groupDiversity * 0.25 +   // Group diversity (richness)\n    energyBalance * 0.15;     // Energy balance (harmony)\n  \n  return overallScore;\n}\n```\n\n**Conceptual Clarity:**\n- **Pair Compatibility** (60%): Do members get along? (similarity)\n- **Group Diversity** (25%): Is the group interesting? (richness)\n- **Energy Balance** (15%): Is the energy level balanced? (harmony)\n\n**Anti-Repetition System:**\n\n```typescript\n// Prevent users from being matched together repeatedly\nconst matchHistory = await db\n  .select()\n  .from(matchHistory)\n  .where(and(\n    eq(matchHistory.userId1, user1.id),\n    eq(matchHistory.userId2, user2.id)\n  ));\n\nif (matchHistory.length > 0) {\n  pairScore *= 0.7; // 30% penalty for repeat matching\n}\n```\n\n---\n\n### 3.5 Temperature Concept System ğŸŒ¡ï¸\n\n**NEW in v1.1** (Nov 20, 2025)\n\n**Files:** `server/archetypeChemistry.ts`, `shared/schema.ts`, `shared/wsEvents.ts`\n\n**Purpose:** Provide intuitive visual feedback on match quality using dual-temperature metaphor\n\n#### Dual-Temperature System\n\n**1. Social Energy Temperature (ç¤¾äº¤èƒ½é‡æ¸©åº¦)**\n\nMaps 14 personality archetypes to energy levels (0-100 scale) to prevent unbalanced groups.\n\n```typescript\nconst ARCHETYPE_ENERGY = {\n  // High Energy (80-95)\n  ç¤¾äº¤è´è¶: 95,        // Social Butterfly - Highest energy\n  æ´»åŠ¨ç­–åˆ’è€…: 90,      // Event Planner\n  å¹½é»˜å¤§å¸ˆ: 85,        // Humor Master\n  æ°›å›´è¥é€ è€…: 82,      // Atmosphere Creator\n  \n  // Medium-High Energy (60-75)\n  çŸ¥è¯†åˆ†äº«è€…: 60,      // Knowledge Sharer\n  åˆ›æ„æ€è€ƒè€…: 55,      // Creative Thinker\n  \n  // Medium Energy (45-55)\n  å€¾å¬è€…: 50,          // Listener\n  å¹³è¡¡åè°ƒè€…: 52,      // Balanced Coordinator\n  \n  // Low Energy (25-40)\n  æ·±åº¦å¯¹è¯è€…: 40,      // Deep Conversationalist\n  è§‚å¯Ÿè€…: 30,          // Observer\n  ç‹¬ç«‹æ€è€ƒè€…: 25,      // Independent Thinker - Lowest energy\n  \n  // ... all 14 archetypes mapped\n};\n```\n\n**Energy Balance Calculation:**\n\n```typescript\nfunction calculateEnergyBalance(group) {\n  const energyLevels = group.map(user => ARCHETYPE_ENERGY[user.primaryRole]);\n  const avgEnergy = mean(energyLevels);\n  const stdDev = standardDeviation(energyLevels);\n  \n  // Ideal: Average energy 50-70 (balanced, not too high or too low)\n  const avgScore = (avgEnergy >= 50 && avgEnergy <= 70) ? 100 : \n                   Math.max(0, 100 - Math.abs(avgEnergy - 60) * 2);\n  \n  // Ideal: Low standard deviation (harmony, not too much variance)\n  const harmonyScore = Math.max(0, 100 - stdDev * 3);\n  \n  return (avgScore + harmonyScore) / 2;\n}\n```\n\n**Why This Matters:**\n- Prevents all-é«˜èƒ½é‡ groups (exhausting, chaotic)\n- Prevents all-ä½èƒ½é‡ groups (awkward silences, low engagement)\n- Creates balanced social dynamics with natural conversation flow\n\n**2. Chemistry Reaction Temperature (åŒ–å­¦ååº”æ¸©åº¦)**\n\nVisual emoji indicators for overall match quality, displayed to users and admins.\n\n```typescript\nfunction getTemperatureLevel(score) {\n  if (score >= 85) return \"ğŸ”¥ ç‚½çƒ­\"; // Fire - Exceptional compatibility\n  if (score >= 70) return \"ğŸŒ¡ï¸ æ¸©æš–\"; // Warm - Strong compatibility\n  if (score >= 55) return \"ğŸŒ¤ï¸ é€‚å®œ\"; // Mild - Moderate compatibility\n  return \"â„ï¸ å†·æ·¡\";                  // Cold - Low compatibility\n}\n```\n\n| Emoji | Chinese | English | Score | Meaning |\n|-------|---------|---------|-------|---------|\n| ğŸ”¥ | ç‚½çƒ­ | Fire | â‰¥85 | Exceptional match - Instant chemistry |\n| ğŸŒ¡ï¸ | æ¸©æš– | Warm | 70-84 | Strong match - Good compatibility |\n| ğŸŒ¤ï¸ | é€‚å®œ | Mild | 55-69 | Moderate match - Acceptable fit |\n| â„ï¸ | å†·æ·¡ | Cold | <55 | Low match - Poor compatibility |\n\n#### UI Integration\n\n**Admin Matching Logs Page:**\n```tsx\n// Display temperature emoji next to average score\n<div className=\"text-2xl font-bold text-green-600\">\n  {getTemperatureEmoji(log.avgGroupScore)} {log.avgGroupScore}åˆ†\n</div>\n```\n\n**User WebSocket Notifications:**\n```typescript\n// POOL_MATCHED event includes temperatureLevel\ninterface PoolMatchedData {\n  poolId: string;\n  poolTitle: string;\n  groupId: string;\n  groupNumber: number;\n  matchScore: number;\n  memberCount: number;\n  temperatureLevel: string; // \"ğŸ”¥ ç‚½çƒ­\", \"ğŸŒ¡ï¸ æ¸©æš–\", etc.\n}\n\n// Toast notification displays temperature\ntoast({\n  title: `ğŸ‰ åŒ¹é…æˆåŠŸï¼`,\n  description: `${data.temperatureLevel} Â· å°ç»„ ${data.groupNumber} Â· åŒ¹é…åº¦ ${data.matchScore}åˆ†`,\n});\n```\n\n**Group Explanation Text:**\n```typescript\nfunction generateGroupExplanation(group, scores) {\n  const energyDesc = scores.energyBalance >= 70 ? \n    \"å°ç»„èƒ½é‡åˆ†å¸ƒå‡è¡¡ï¼Œæ—¢æœ‰æ´»è·ƒçš„å¼•å¯¼è€…ï¼Œä¹Ÿæœ‰å–„äºå€¾å¬çš„æˆå‘˜\" :\n    \"å°ç»„èƒ½é‡è¾ƒä¸ºé›†ä¸­ï¼Œå»ºè®®é€‚å½“è°ƒæ•´äº’åŠ¨èŠ‚å¥\";\n    \n  const tempDesc = scores.temperatureLevel === \"ğŸ”¥ ç‚½çƒ­\" ?\n    \"è¿™æ˜¯ä¸€ä¸ªåŒ–å­¦ååº”æå¼ºçš„å°ç»„ï¼\" :\n    scores.temperatureLevel === \"ğŸŒ¡ï¸ æ¸©æš–\" ?\n    \"è¿™ä¸ªå°ç»„æœ‰å¾ˆå¥½çš„åŒ¹é…åº¦\" :\n    \"è¿™ä¸ªå°ç»„æœ‰ä¸€å®šçš„åŒ¹é…åº¦\";\n    \n  return `${tempDesc} ${energyDesc}`;\n}\n```\n\n#### Database Schema\n\n**eventPoolGroups table (updated):**\n```sql\nCREATE TABLE event_pool_groups (\n  id VARCHAR PRIMARY KEY,\n  pool_id VARCHAR REFERENCES event_pools(id),\n  group_number INTEGER,\n  \n  -- Existing scores\n  avg_pair_score INTEGER,      -- Average pairwise compatibility\n  diversity_score INTEGER,      -- Group background diversity\n  overall_score INTEGER,        -- Final weighted score\n  \n  -- NEW in v1.1\n  energy_balance INTEGER,       -- Social energy harmony score (0-100)\n  temperature_level VARCHAR,    -- Visual indicator: \"ğŸ”¥ ç‚½çƒ­\", \"ğŸŒ¡ï¸ æ¸©æš–\", etc.\n  \n  created_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n#### Impact & Benefits\n\n**For Users:**\n- Intuitive understanding of match quality (emoji > number)\n- Transparent expectations before event\n- Reduces anxiety about \"will I fit in?\"\n\n**For Admins:**\n- Quick visual scan of matching quality in logs\n- Easier to spot problematic groups\n- Data-driven insights for algorithm tuning\n\n**For Algorithm:**\n- Prevents edge cases (all introverts or all extroverts)\n- Balances similarity (pair score) with diversity and energy\n- More nuanced group formation\n\n---\n\n## ğŸ“Š Implementation Status\n\n### Feature Completion Matrix\n\n| Module | Status | Files | Notes |\n|--------|--------|-------|-------|\n| **User Registration** | âœ… Complete | `RegistrationPage.tsx`, `phoneAuth.ts` | SMS + bcrypt |\n| **Personality Test** | âœ… Complete | `PersonalityTestPage.tsx`, 10 questions | 14 archetypes |\n| **Event Discovery** | âœ… Complete | `DiscoverPage.tsx`, `BlindBoxEventDetailPage.tsx` | Blind box system |\n| **Match Scoring** | âœ… Complete | `userMatchingService.ts` | 5-dimensional |\n| **Payment Integration** | âœ… Complete | `paymentService.ts`, WeChat Pay | Webhook handling |\n| **Subscription Management** | âœ… Complete | `subscriptionService.ts` | Auto-expiry |\n| **Chat System** | âœ… Complete | `EventChatDetailPage.tsx`, WebSocket | Real-time |\n| **Feedback System** | âœ… Complete | `EventFeedbackFlow.tsx`, 2-tier | Basic + Deep |\n| **Admin Dashboard** | âœ… Complete | `AdminDashboard.tsx` | 5 key metrics |\n| **User Management** | âœ… Complete | `AdminUsersPage.tsx` | CRUD + analytics |\n| **Venue Management** | âœ… Complete | `AdminVenuesPage.tsx`, `venueMatchingService.ts` | Auto-matching |\n| **Event Templates** | âœ… Complete | `AdminEventTemplatesPage.tsx` | Reusable configs |\n| **Matching Lab** | âœ… Complete | `AdminMatchingLabPage.tsx` | Weight tuning |\n| **Content Management** | âœ… Complete | `AdminContentPage.tsx` | CMS for announcements |\n| **Notification System** | âœ… Complete | `AdminNotificationsPage.tsx` | Broadcast |\n| **Moderation System** | âœ… Complete | `AdminModerationPage.tsx`, `AdminReportsPage.tsx` | Report handling |\n| **Chat Logs** | âœ… Complete | `AdminChatLogsPage.tsx` | Audit trail |\n| **Data Insights** | âœ… Complete | `AdminDataInsightsPage.tsx` | 7 analytics modules |\n| **Feedback Management** | âœ… Complete | `AdminFeedbackPage.tsx` | Review interface |\n| **WebSocket Sync** | âœ… Complete | `wsService.ts`, `useWebSocket.ts` | Bidirectional |\n| **Temperature Concept** | âœ… Complete (v1.1) | `archetypeChemistry.ts`, `poolMatchingService.ts` | Dual-temperature system |\n| **Real-time Dynamic Matching** | âœ… Complete (v1.1) | `poolRealtimeMatchingService.ts`, `AdminMatchingConfigPage.tsx` | Three-tier threshold system |\n| **Invitation & Viral Growth** | âœ… Complete (v1.1) | `poolMatchingService.ts`, `user_coupons` table | Auto-coupon issuance |\n| **Event Pool User Flow** | âœ… Complete (v1.1) | `EventPoolRegistrationPage.tsx`, `PoolRegistrationCard.tsx` | Two-stage matching UI |\n\n---\n\n## ğŸ” Security & Privacy\n\n**Authentication:**\n- Session-based with 7-day TTL\n- HTTP-only cookies\n- CSRF protection\n\n**Data Privacy:**\n- Phone numbers masked in admin UI (198****0978)\n- Deep feedback is anonymous (user_id nullable)\n- Chat logs encrypted at rest\n\n**Payment Security:**\n- PCI DSS compliant (via WeChat Pay)\n- Webhook signature verification\n- Idempotency keys for duplicate prevention\n\n**Moderation:**\n- Automated keyword flagging\n- Manual admin review required for bans\n- All moderation actions logged for audit\n\n---\n\n## ğŸš€ Deployment & Environment\n\n**Production Environment:**\n- Database: PostgreSQL (Neon serverless)\n- Session Store: PostgreSQL\n- File Storage: (TBD - planned: Replit Object Storage)\n- Real-time: WebSocket over WSS\n\n**Environment Variables:**\n```bash\nDATABASE_URL=postgresql://...\nSESSION_SECRET=...\nWECHAT_PAY_APP_ID=...\nWECHAT_PAY_MCH_ID=...\nWECHAT_PAY_API_KEY=...\nNODE_ENV=production\n```\n\n**Build Command:**\n```bash\nnpm run build\n```\n\n**Start Command:**\n```bash\nnpm run dev\n```\n\n---\n\n## ğŸ“ File Structure Reference\n\n```\njoyjoin/\nâ”œâ”€â”€ client/src/\nâ”‚   â”œâ”€â”€ pages/\nâ”‚   â”‚   â”œâ”€â”€ admin/                    # 18 admin pages\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminDashboard.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminUsersPage.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminSubscriptionsPage.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminCouponsPage.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminVenuesPage.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminEventTemplatesPage.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminEventsPage.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminFinancePage.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminDataInsightsPage.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminFeedbackPage.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminMatchingLabPage.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminContentPage.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminNotificationsPage.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminModerationPage.tsx\nâ”‚   â”‚   â”‚   â”œâ”€â”€ AdminReportsPage.tsx\nâ”‚   â”‚   â”‚   â””â”€â”€ AdminChatLogsPage.tsx\nâ”‚   â”‚   â”œâ”€â”€ RegistrationPage.tsx      # Phone auth\nâ”‚   â”‚   â”œâ”€â”€ PersonalityTestPage.tsx   # 10 questions\nâ”‚   â”‚   â”œâ”€â”€ PersonalityTestResultPage.tsx\nâ”‚   â”‚   â”œâ”€â”€ DiscoverPage.tsx          # Event browsing\nâ”‚   â”‚   â”œâ”€â”€ BlindBoxEventDetailPage.tsx\nâ”‚   â”‚   â”œâ”€â”€ BlindBoxPaymentPage.tsx\nâ”‚   â”‚   â”œâ”€â”€ EventChatDetailPage.tsx\nâ”‚   â”‚   â”œâ”€â”€ EventFeedbackFlow.tsx\nâ”‚   â”‚   â”œâ”€â”€ DeepFeedbackFlow.tsx\nâ”‚   â”‚   â””â”€â”€ ... (30+ pages total)\nâ”‚   â”œâ”€â”€ components/\nâ”‚   â”‚   â”œâ”€â”€ ui/                       # shadcn components\nâ”‚   â”‚   â”œâ”€â”€ PersonalityRadarChart.tsx\nâ”‚   â”‚   â”œâ”€â”€ AttendeePreviewCard.tsx\nâ”‚   â”‚   â”œâ”€â”€ StackedAttendeeCards.tsx\nâ”‚   â”‚   â””â”€â”€ feedback/\nâ”‚   â”‚       â”œâ”€â”€ ConnectionRadar.tsx\nâ”‚   â”‚       â”œâ”€â”€ TraitTagsWall.tsx\nâ”‚   â”‚       â””â”€â”€ SelectConnectionsStep.tsx\nâ”‚   â”œâ”€â”€ lib/\nâ”‚   â”‚   â”œâ”€â”€ archetypes.ts            # 14 archetype configs\nâ”‚   â”‚   â”œâ”€â”€ archetypeAvatars.ts      # Gradients + emojis\nâ”‚   â”‚   â”œâ”€â”€ matchExplanation.ts\nâ”‚   â”‚   â””â”€â”€ queryClient.ts\nâ”‚   â””â”€â”€ hooks/\nâ”‚       â”œâ”€â”€ useAuth.ts\nâ”‚       â””â”€â”€ useWebSocket.ts\nâ”œâ”€â”€ server/\nâ”‚   â”œâ”€â”€ routes.ts                    # 3400+ lines, all API routes\nâ”‚   â”œâ”€â”€ storage.ts                   # Database layer\nâ”‚   â”œâ”€â”€ phoneAuth.ts                 # SMS verification\nâ”‚   â”œâ”€â”€ paymentService.ts            # WeChat Pay\nâ”‚   â”œâ”€â”€ subscriptionService.ts       # Auto-expiry\nâ”‚   â”œâ”€â”€ venueMatchingService.ts      # Venue algorithm\nâ”‚   â”œâ”€â”€ userMatchingService.ts       # User matching (5D)\nâ”‚   â”œâ”€â”€ wsService.ts                 # WebSocket server\nâ”‚   â””â”€â”€ eventBroadcast.ts            # Real-time sync\nâ”œâ”€â”€ shared/\nâ”‚   â””â”€â”€ schema.ts                    # 3000+ lines, full DB schema\nâ””â”€â”€ db/\n    â””â”€â”€ index.ts                     # Drizzle connection\n```\n\n---\n\n## ğŸ“ Onboarding Quick Start\n\n**For New Developers:**\n\n1. **Setup:**\n   ```bash\n   git clone <repo>\n   npm install\n   npm run db:push  # Sync database schema\n   npm run dev      # Start development server\n   ```\n\n2. **Admin Login:**\n   - Phone: `19896500978`\n   - Password: `Lasalle11`\n   - Navigate to `/admin`\n\n3. **Key Files to Read First:**\n   - `replit.md` - Project overview\n   - `shared/schema.ts` - Database structure\n   - `server/routes.ts` - API endpoints\n   - `client/src/App.tsx` - Routing\n\n4. **Common Tasks:**\n   - Add new API endpoint â†’ `server/routes.ts`\n   - Add new admin page â†’ `client/src/pages/admin/`\n   - Modify matching â†’ `server/userMatchingService.ts`\n   - Update schema â†’ `shared/schema.ts` + `npm run db:push`\n\n**For Product Managers:**\n\n- User flows: See Section 1 (User App Features)\n- Admin capabilities: See Section 2 (Admin Portal Features)\n- Analytics: AdminDataInsightsPage provides all metrics\n- Feedback: AdminFeedbackPage shows user sentiment\n\n**For Designers:**\n\n- Design system: shadcn/ui components in `client/src/components/ui/`\n- Color palette: Defined in `client/src/index.css`\n- Personality archetype branding: `client/src/lib/archetypeAvatars.ts`\n- Dark mode: Fully supported via Tailwind classes\n\n---\n\n## ğŸ“ Changelog & Version History\n\n**v1.0 (Current) - November 14, 2025**\n- âœ… Complete user app with blind box events\n- âœ… 14 personality archetype system\n- âœ… 5-dimensional matching algorithm\n- âœ… WeChat Pay integration\n- âœ… Comprehensive admin portal (18 pages)\n- âœ… Real-time WebSocket sync\n- âœ… Two-tier feedback system\n- âœ… Data insights dashboard\n- âœ… Chat moderation system\n\n**Planned for v1.1:**\n- [ ] Mobile app (React Native)\n- [ ] AI-generated conversation starters\n- [ ] Video introduction profiles\n- [ ] Advanced A/B testing framework\n- [ ] Multi-language support (English full launch)\n\n---\n\n## ğŸ“ Support & Resources\n\n**Documentation:**\n- This PRD\n- `replit.md` - Project architecture\n- API docs: See `server/routes.ts` inline comments\n- Component docs: See component prop interfaces\n\n**Developer Resources:**\n- Database tool: Use `/api/admin` routes or execute_sql_tool\n- Testing: Use run_test tool for playwright tests\n- Logs: Check workflow logs in Replit\n\n**Contact:**\n- Technical lead: [TBD]\n- Product owner: [TBD]\n- Design lead: [TBD]\n\n---\n\n**End of Product Requirements Document**\n\n*Last updated: November 14, 2025*  \n*Document version: 1.0*  \n*Total pages: ~50 (Markdown equivalent)*\n","size_bytes":97595},"client/src/pages/admin/AdminEventPoolsPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n  FormDescription,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Calendar, Users, CheckCircle, Clock, Play, Eye } from \"lucide-react\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { format } from \"date-fns\";\nimport { zhCN } from \"date-fns/locale\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\n\n// Form schema for creating event pool\nconst createPoolSchema = z.object({\n  title: z.string().min(1, \"æ´»åŠ¨æ ‡é¢˜ä¸èƒ½ä¸ºç©º\"),\n  description: z.string().optional(),\n  eventType: z.enum([\"é¥­å±€\", \"é…’å±€\", \"å…¶ä»–\"]),\n  city: z.enum([\"æ·±åœ³\", \"é¦™æ¸¯\"]),\n  district: z.string().optional(),\n  dateTime: z.string().min(1, \"è¯·é€‰æ‹©æ´»åŠ¨æ—¶é—´\"),\n  registrationDeadline: z.string().min(1, \"è¯·é€‰æ‹©æŠ¥åæˆªæ­¢æ—¶é—´\"),\n  genderRestriction: z.string().optional(),\n  industryRestrictions: z.array(z.string()).optional(),\n  seniorityRestrictions: z.array(z.string()).optional(),\n  educationLevelRestrictions: z.array(z.string()).optional(),\n  ageRangeMin: z.union([z.number(), z.undefined()]).optional(),\n  ageRangeMax: z.union([z.number(), z.undefined()]).optional(),\n  minGroupSize: z.number().min(2).max(10).default(4),\n  maxGroupSize: z.number().min(2).max(10).default(6),\n  targetGroups: z.number().min(1).default(1),\n});\n\ninterface EventPool {\n  id: string;\n  title: string;\n  description: string | null;\n  eventType: string;\n  city: string;\n  district: string | null;\n  dateTime: string;\n  registrationDeadline: string;\n  status: string;\n  totalRegistrations: number;\n  successfulMatches: number;\n  minGroupSize: number;\n  maxGroupSize: number;\n  targetGroups: number;\n  createdAt: string;\n  registrationCount?: number;\n  matchedCount?: number;\n  pendingCount?: number;\n}\n\nconst STATUS_MAP: Record<string, { label: string; variant: \"default\" | \"secondary\" | \"destructive\" | \"outline\" }> = {\n  active: { label: \"æ‹›å‹Ÿä¸­\", variant: \"secondary\" },\n  matching: { label: \"åŒ¹é…ä¸­\", variant: \"default\" },\n  matched: { label: \"å·²åŒ¹é…\", variant: \"default\" },\n  completed: { label: \"å·²å®Œæˆ\", variant: \"outline\" },\n  cancelled: { label: \"å·²å–æ¶ˆ\", variant: \"destructive\" },\n};\n\n// Industry options matching user schema\nconst INDUSTRY_OPTIONS = [\n  \"äº’è”ç½‘/ç§‘æŠ€\",\n  \"é‡‘è/æŠ•èµ„\",\n  \"å’¨è¯¢/ä¸“ä¸šæœåŠ¡\",\n  \"æ•™è‚²/åŸ¹è®­\",\n  \"åŒ»ç–—/å¥åº·\",\n  \"æ–‡åŒ–/åˆ›æ„\",\n  \"åˆ¶é€ ä¸š\",\n  \"é›¶å”®/ç”µå•†\",\n  \"æˆ¿åœ°äº§/å»ºç­‘\",\n  \"å…¶ä»–\",\n];\n\n// Seniority options\nconst SENIORITY_OPTIONS = [\n  \"Intern\",\n  \"Junior\",\n  \"Mid\",\n  \"Senior\",\n  \"Founder\",\n  \"Executive\",\n];\n\n// Education levels\nconst EDUCATION_OPTIONS = [\n  \"High school/below\",\n  \"Some college/Associate\",\n  \"Bachelor's\",\n  \"Master's\",\n  \"Doctorate\",\n  \"Trade/Vocational\",\n];\n\nexport default function AdminEventPoolsPage() {\n  const [filterStatus, setFilterStatus] = useState<\"all\" | \"active\" | \"matched\" | \"completed\">(\"all\");\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [selectedPool, setSelectedPool] = useState<EventPool | null>(null);\n  const [showDetailsDialog, setShowDetailsDialog] = useState(false);\n  \n  const { toast } = useToast();\n\n  const { data: pools = [], isLoading } = useQuery<EventPool[]>({\n    queryKey: [\"/api/admin/event-pools\"],\n  });\n\n  const form = useForm({\n    resolver: zodResolver(createPoolSchema),\n    defaultValues: {\n      title: \"\",\n      description: \"\",\n      eventType: \"é¥­å±€\" as const,\n      city: \"æ·±åœ³\" as const,\n      district: \"\",\n      dateTime: \"\",\n      registrationDeadline: \"\",\n      genderRestriction: \"\",\n      industryRestrictions: [],\n      seniorityRestrictions: [],\n      educationLevelRestrictions: [],\n      ageRangeMin: undefined,\n      ageRangeMax: undefined,\n      minGroupSize: 4,\n      maxGroupSize: 6,\n      targetGroups: 1,\n    },\n  });\n\n  const createPoolMutation = useMutation({\n    mutationFn: (data: any) => apiRequest(\"/api/admin/event-pools\", \"POST\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/event-pools\"] });\n      setShowCreateDialog(false);\n      form.reset();\n      toast({\n        title: \"åˆ›å»ºæˆåŠŸ\",\n        description: \"æ´»åŠ¨æ± å·²åˆ›å»ºï¼Œç­‰å¾…ç”¨æˆ·æŠ¥å\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"åˆ›å»ºå¤±è´¥\",\n        description: error.message || \"æ— æ³•åˆ›å»ºæ´»åŠ¨æ± ï¼Œè¯·é‡è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const triggerMatchingMutation = useMutation({\n    mutationFn: (poolId: string) => apiRequest(`/api/admin/event-pools/${poolId}/match`, \"POST\", {}),\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/event-pools\"] });\n      toast({\n        title: \"åŒ¹é…å®Œæˆ\",\n        description: `æˆåŠŸåŒ¹é…${data.groupCount}ä¸ªå°ç»„ï¼Œå…±${data.totalMatched}äºº`,\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"åŒ¹é…å¤±è´¥\",\n        description: error.message || \"æ— æ³•å®ŒæˆåŒ¹é…ï¼Œè¯·æ£€æŸ¥æŠ¥åäººæ•°æ˜¯å¦å……è¶³\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleViewDetails = (pool: EventPool) => {\n    setSelectedPool(pool);\n    setShowDetailsDialog(true);\n  };\n\n  const handleTriggerMatching = (poolId: string) => {\n    if (confirm(\"ç¡®å®šè¦å¼€å§‹åŒ¹é…å—ï¼ŸåŒ¹é…åå°†æ— æ³•æ’¤é”€ã€‚\")) {\n      triggerMatchingMutation.mutate(poolId);\n    }\n  };\n\n  const onSubmit = (data: any) => {\n    // Convert form data to API format\n    const poolData = {\n      ...data,\n      ageRangeMin: data.ageRangeMin || null,\n      ageRangeMax: data.ageRangeMax || null,\n      industryRestrictions: data.industryRestrictions || [],\n      seniorityRestrictions: data.seniorityRestrictions || [],\n      educationLevelRestrictions: data.educationLevelRestrictions || [],\n    };\n    \n    createPoolMutation.mutate(poolData);\n  };\n\n  const filteredPools = filterStatus === \"all\" \n    ? pools \n    : pools.filter(p => p.status === filterStatus);\n\n  const totalPools = pools.length;\n  const activeCount = pools.filter(p => p.status === \"active\").length;\n  const matchedCount = pools.filter(p => p.status === \"matched\").length;\n  const completedCount = pools.filter(p => p.status === \"completed\").length;\n\n  const formatDateTime = (dateTimeStr: string) => {\n    try {\n      const date = new Date(dateTimeStr);\n      return format(date, \"yyyyå¹´MMæœˆddæ—¥ HH:mm\", { locale: zhCN });\n    } catch (e) {\n      return dateTimeStr;\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"space-y-6\">\n          <div className=\"grid gap-4 md:grid-cols-4\">\n            {[1, 2, 3, 4].map(i => (\n              <Card key={i} data-testid={`skeleton-metric-${i}`}>\n                <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">åŠ è½½ä¸­...</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">--</div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between gap-1\">\n        <div>\n          <h1 className=\"text-3xl font-bold tracking-tight\">æ´»åŠ¨æ± ç®¡ç†</h1>\n          <p className=\"text-muted-foreground\">ä¸¤é˜¶æ®µåŒ¹é…æ¨¡å‹ - Adminåˆ›å»ºæ´»åŠ¨æ± ï¼Œç”¨æˆ·æŠ¥åå¹¶ç”±AIæ™ºèƒ½åˆ†ç»„</p>\n        </div>\n        <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-pool\">\n              <Calendar className=\"mr-2 h-4 w-4\" />\n              åˆ›å»ºæ´»åŠ¨æ± \n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>åˆ›å»ºæ–°æ´»åŠ¨æ± </DialogTitle>\n            </DialogHeader>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                {/* Basic Info */}\n                <FormField\n                  control={form.control}\n                  name=\"title\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>æ´»åŠ¨æ ‡é¢˜ *</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"ä¾‹å¦‚ï¼šå‘¨äº”å¤œèŠé…’å±€\" {...field} data-testid=\"input-title\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"description\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>æ´»åŠ¨æè¿°</FormLabel>\n                      <FormControl>\n                        <Textarea placeholder=\"æ´»åŠ¨ç®€ä»‹...\" {...field} data-testid=\"textarea-description\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"eventType\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>æ´»åŠ¨ç±»å‹ *</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-event-type\">\n                              <SelectValue placeholder=\"é€‰æ‹©ç±»å‹\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"é¥­å±€\">é¥­å±€</SelectItem>\n                            <SelectItem value=\"é…’å±€\">é…’å±€</SelectItem>\n                            <SelectItem value=\"å…¶ä»–\">å…¶ä»–</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"city\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>åŸå¸‚ *</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-city\">\n                              <SelectValue placeholder=\"é€‰æ‹©åŸå¸‚\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"æ·±åœ³\">æ·±åœ³</SelectItem>\n                            <SelectItem value=\"é¦™æ¸¯\">é¦™æ¸¯</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <FormField\n                  control={form.control}\n                  name=\"district\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>åŒºåŸŸ</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"ä¾‹å¦‚ï¼šå—å±±åŒºã€æ¹¾ä»”\" {...field} data-testid=\"input-district\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"dateTime\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>æ´»åŠ¨æ—¶é—´ *</FormLabel>\n                        <FormControl>\n                          <Input type=\"datetime-local\" {...field} data-testid=\"input-datetime\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"registrationDeadline\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>æŠ¥åæˆªæ­¢ *</FormLabel>\n                        <FormControl>\n                          <Input type=\"datetime-local\" {...field} data-testid=\"input-deadline\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                {/* Hard Constraints */}\n                <div className=\"border-t pt-4 mt-4\">\n                  <h3 className=\"font-semibold mb-3\">ç¡¬çº¦æŸæ¡ä»¶ï¼ˆå¯é€‰ï¼‰</h3>\n                  \n                  <FormField\n                    control={form.control}\n                    name=\"genderRestriction\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>æ€§åˆ«é™åˆ¶</FormLabel>\n                        <Select onValueChange={field.onChange} defaultValue={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"select-gender\">\n                              <SelectValue placeholder=\"ä¸é™\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"\">ä¸é™</SelectItem>\n                            <SelectItem value=\"Woman\">ä»…é™å¥³æ€§</SelectItem>\n                            <SelectItem value=\"Man\">ä»…é™ç”·æ€§</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormDescription>ç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶æ€§åˆ«</FormDescription>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-2 gap-4 mt-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"ageRangeMin\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>æœ€å°å¹´é¾„</FormLabel>\n                          <FormControl>\n                            <Input\n                              type=\"number\"\n                              placeholder=\"ä¾‹å¦‚ï¼š25\"\n                              {...field}\n                              onChange={(e) => field.onChange(e.target.value ? parseInt(e.target.value) : undefined)}\n                              data-testid=\"input-age-min\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"ageRangeMax\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>æœ€å¤§å¹´é¾„</FormLabel>\n                          <FormControl>\n                            <Input\n                              type=\"number\"\n                              placeholder=\"ä¾‹å¦‚ï¼š35\"\n                              {...field}\n                              onChange={(e) => field.onChange(e.target.value ? parseInt(e.target.value) : undefined)}\n                              data-testid=\"input-age-max\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* Group Configuration */}\n                <div className=\"border-t pt-4 mt-4\">\n                  <h3 className=\"font-semibold mb-3\">ç»„å±€é…ç½®</h3>\n                  \n                  <div className=\"grid grid-cols-3 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"minGroupSize\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>æœ€å°äººæ•° *</FormLabel>\n                          <FormControl>\n                            <Input\n                              type=\"number\"\n                              min=\"2\"\n                              max=\"10\"\n                              {...field}\n                              onChange={(e) => field.onChange(parseInt(e.target.value))}\n                              data-testid=\"input-min-size\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"maxGroupSize\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>æœ€å¤§äººæ•° *</FormLabel>\n                          <FormControl>\n                            <Input\n                              type=\"number\"\n                              min=\"2\"\n                              max=\"10\"\n                              {...field}\n                              onChange={(e) => field.onChange(parseInt(e.target.value))}\n                              data-testid=\"input-max-size\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"targetGroups\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>ç›®æ ‡ç»„æ•° *</FormLabel>\n                          <FormControl>\n                            <Input\n                              type=\"number\"\n                              min=\"1\"\n                              {...field}\n                              onChange={(e) => field.onChange(parseInt(e.target.value))}\n                              data-testid=\"input-target-groups\"\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                <DialogFooter>\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setShowCreateDialog(false)}>\n                    å–æ¶ˆ\n                  </Button>\n                  <Button type=\"submit\" disabled={createPoolMutation.isPending} data-testid=\"button-submit-pool\">\n                    {createPoolMutation.isPending ? \"åˆ›å»ºä¸­...\" : \"åˆ›å»ºæ´»åŠ¨æ± \"}\n                  </Button>\n                </DialogFooter>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {/* Metrics */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card data-testid=\"metric-total\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ€»æ´»åŠ¨æ± æ•°</CardTitle>\n            <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{totalPools}</div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"metric-active\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">æ‹›å‹Ÿä¸­</CardTitle>\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{activeCount}</div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"metric-matched\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">å·²åŒ¹é…</CardTitle>\n            <CheckCircle className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{matchedCount}</div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"metric-completed\">\n          <CardHeader className=\"flex flex-row items-center justify-between gap-1 space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">å·²å®Œæˆ</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{completedCount}</div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Filters */}\n      <Tabs value={filterStatus} onValueChange={(v: any) => setFilterStatus(v)}>\n        <TabsList>\n          <TabsTrigger value=\"all\" data-testid=\"filter-all\">å…¨éƒ¨</TabsTrigger>\n          <TabsTrigger value=\"active\" data-testid=\"filter-active\">æ‹›å‹Ÿä¸­</TabsTrigger>\n          <TabsTrigger value=\"matched\" data-testid=\"filter-matched\">å·²åŒ¹é…</TabsTrigger>\n          <TabsTrigger value=\"completed\" data-testid=\"filter-completed\">å·²å®Œæˆ</TabsTrigger>\n        </TabsList>\n      </Tabs>\n\n      {/* Event Pools List */}\n      <div className=\"grid gap-4\">\n        {filteredPools.length === 0 ? (\n          <Card>\n            <CardContent className=\"py-10 text-center text-muted-foreground\">\n              æš‚æ— æ´»åŠ¨æ± \n            </CardContent>\n          </Card>\n        ) : (\n          filteredPools.map((pool) => (\n            <Card key={pool.id} data-testid={`pool-card-${pool.id}`}>\n              <CardHeader>\n                <div className=\"flex items-start justify-between gap-2\">\n                  <div className=\"flex-1\">\n                    <CardTitle className=\"flex items-center gap-2\">\n                      {pool.title}\n                      <Badge variant={STATUS_MAP[pool.status]?.variant || \"default\"}>\n                        {STATUS_MAP[pool.status]?.label || pool.status}\n                      </Badge>\n                    </CardTitle>\n                    <CardDescription className=\"mt-2\">\n                      {pool.description || \"æ— æè¿°\"}\n                    </CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n                  <div>\n                    <div className=\"text-muted-foreground\">æ´»åŠ¨ç±»å‹</div>\n                    <div className=\"font-medium\">{pool.eventType}</div>\n                  </div>\n                  <div>\n                    <div className=\"text-muted-foreground\">åœ°ç‚¹</div>\n                    <div className=\"font-medium\">{pool.city}{pool.district ? ` Â· ${pool.district}` : \"\"}</div>\n                  </div>\n                  <div>\n                    <div className=\"text-muted-foreground\">æ´»åŠ¨æ—¶é—´</div>\n                    <div className=\"font-medium\">{formatDateTime(pool.dateTime)}</div>\n                  </div>\n                  <div>\n                    <div className=\"text-muted-foreground\">æŠ¥åæˆªæ­¢</div>\n                    <div className=\"font-medium\">{formatDateTime(pool.registrationDeadline)}</div>\n                  </div>\n                </div>\n\n                <div className=\"flex items-center gap-4 text-sm\">\n                  <div className=\"flex items-center gap-1\">\n                    <Users className=\"h-4 w-4\" />\n                    <span>æ€»æŠ¥å: {pool.registrationCount || 0}</span>\n                  </div>\n                  <div className=\"flex items-center gap-1\">\n                    <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                    <span>å·²åŒ¹é…: {pool.matchedCount || 0}</span>\n                  </div>\n                  <div className=\"flex items-center gap-1\">\n                    <Clock className=\"h-4 w-4 text-yellow-600\" />\n                    <span>å¾…åŒ¹é…: {pool.pendingCount || 0}</span>\n                  </div>\n                  <div className=\"text-muted-foreground\">\n                    ç›®æ ‡: {pool.targetGroups}ç»„ ({pool.minGroupSize}-{pool.maxGroupSize}äºº/ç»„)\n                  </div>\n                </div>\n\n                <div className=\"flex gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => handleViewDetails(pool)}\n                    data-testid={`button-view-${pool.id}`}\n                  >\n                    <Eye className=\"h-4 w-4 mr-1\" />\n                    æŸ¥çœ‹è¯¦æƒ…\n                  </Button>\n                  {pool.status === \"active\" && (pool.pendingCount || 0) >= (pool.minGroupSize || 4) && (\n                    <Button\n                      size=\"sm\"\n                      onClick={() => handleTriggerMatching(pool.id)}\n                      disabled={triggerMatchingMutation.isPending}\n                      data-testid={`button-match-${pool.id}`}\n                    >\n                      <Play className=\"h-4 w-4 mr-1\" />\n                      å¼€å§‹åŒ¹é…\n                    </Button>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          ))\n        )}\n      </div>\n\n      {/* Details Dialog */}\n      <Dialog open={showDetailsDialog} onOpenChange={setShowDetailsDialog}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>{selectedPool?.title} - è¯¦ç»†ä¿¡æ¯</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4 text-sm\">\n              <div>\n                <div className=\"text-muted-foreground\">çŠ¶æ€</div>\n                <Badge variant={STATUS_MAP[selectedPool?.status || \"\"]?.variant || \"default\"}>\n                  {STATUS_MAP[selectedPool?.status || \"\"]?.label || selectedPool?.status}\n                </Badge>\n              </div>\n              <div>\n                <div className=\"text-muted-foreground\">åˆ›å»ºæ—¶é—´</div>\n                <div>{selectedPool?.createdAt && formatDateTime(selectedPool.createdAt)}</div>\n              </div>\n            </div>\n            <div className=\"border-t pt-4\">\n              <p className=\"text-sm text-muted-foreground\">\n                æŠ¥åäººæ•°: {selectedPool?.registrationCount || 0} | \n                å·²åŒ¹é…: {selectedPool?.matchedCount || 0} | \n                å¾…åŒ¹é…: {selectedPool?.pendingCount || 0}\n              </p>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":28236},"server/poolMatchingService.ts":{"content":"/**\n * Pool-Based Matching Service (æ± å†…åŒ¹é…æœåŠ¡)\n * ä¸¤é˜¶æ®µåŒ¹é…æ¨¡å‹ - Stage 2: ç”¨æˆ·æŠ¥ååï¼Œåœ¨æ´»åŠ¨æ± å†…è¿›è¡Œæ™ºèƒ½åˆ†ç»„\n * \n * åŒ¹é…é€»è¾‘ï¼š\n * 1. ç¡¬çº¦æŸè¿‡æ»¤ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç¬¦åˆæ´»åŠ¨æ± çš„ç¡¬æ€§é™åˆ¶ï¼ˆæ€§åˆ«ã€è¡Œä¸šã€å¹´é¾„ç­‰ï¼‰\n * 2. è½¯çº¦æŸè¯„åˆ†ï¼šåŸºäº5ä¸ªç»´åº¦è®¡ç®—ç”¨æˆ·ä¹‹é—´çš„åŒ¹é…åˆ†æ•°\n *    - Personality Chemistry (æ€§æ ¼å…¼å®¹æ€§)\n *    - Interest Overlap (å…´è¶£é‡å åº¦)\n *    - Background Diversity (èƒŒæ™¯å¤šæ ·æ€§)\n *    - Conversation Compatibility (è¯­è¨€æ²Ÿé€š)\n *    - Event Preferences (æ´»åŠ¨åå¥½: é¢„ç®—ã€é¥®é£Ÿã€ç¤¾äº¤ç›®çš„)\n * 3. æ™ºèƒ½åˆ†ç»„ï¼šä½¿ç”¨è´ªå©ª+ä¼˜åŒ–ç®—æ³•å½¢æˆé«˜è´¨é‡å°ç»„\n */\n\nimport { db } from \"./db\";\nimport { \n  eventPools, \n  eventPoolRegistrations, \n  eventPoolGroups,\n  users, \n  matchingConfig,\n  invitationUses,\n  invitations,\n  coupons,\n  userCoupons\n} from \"@shared/schema\";\nimport { eq, and, inArray } from \"drizzle-orm\";\nimport { wsService } from \"./wsService\";\nimport type { PoolMatchedData } from \"../shared/wsEvents\";\nimport { chemistryMatrix as CHEMISTRY_MATRIX, ARCHETYPE_ENERGY } from \"./archetypeChemistry\";\n\nexport interface UserWithProfile {\n  userId: string;\n  registrationId: string;\n  \n  // User profile (permanent)\n  gender: string | null;\n  age: number | null;\n  industry: string | null;\n  seniority: string | null;\n  educationLevel: string | null;\n  archetype: string | null;\n  secondaryArchetype: string | null;\n  interestsTop: string[] | null;\n  languagesComfort: string[] | null;\n  \n  // Event preferences (temporary, from registration)\n  budgetRange: string[] | null;\n  preferredLanguages: string[] | null;\n  socialGoals: string[] | null;\n  cuisinePreferences: string[] | null;\n  dietaryRestrictions: string[] | null;\n  tasteIntensity: string[] | null;\n}\n\nexport interface MatchGroup {\n  members: UserWithProfile[];\n  avgPairScore: number;  // å¹³å‡é…å¯¹å…¼å®¹æ€§åˆ†æ•°ï¼ˆchemistry + interest + preference + languageï¼‰\n  diversityScore: number;  // å°ç»„å¤šæ ·æ€§åˆ†æ•°\n  energyBalance: number;  // èƒ½é‡å¹³è¡¡åˆ†æ•°ï¼ˆ0-100ï¼Œè¯„ä¼°å°ç»„ç¤¾äº¤èƒ½é‡çš„å¹³è¡¡åº¦ï¼‰\n  overallScore: number;  // ç»¼åˆåˆ†æ•° = avgPairScore Ã— 0.6 + diversityScore Ã— 0.25 + energyBalance Ã— 0.15\n  temperatureLevel: string;  // åŒ–å­¦ååº”æ¸©åº¦ç­‰çº§ï¼šfire(ğŸ”¥ç‚½çƒ­85+) | warm(ğŸŒ¡ï¸æ¸©æš–70-84) | mild(ğŸŒ¤ï¸é€‚å®œ55-69) | cold(â„ï¸å†·æ·¡<55)\n  explanation: string;\n}\n\n/**\n * ç¡¬çº¦æŸæ£€æŸ¥ï¼šéªŒè¯ç”¨æˆ·æ˜¯å¦ç¬¦åˆæ´»åŠ¨æ± çš„æ‰€æœ‰é™åˆ¶\n */\nfunction meetsHardConstraints(\n  user: UserWithProfile, \n  pool: typeof eventPools.$inferSelect\n): boolean {\n  // æ€§åˆ«é™åˆ¶\n  if (pool.genderRestriction && user.gender !== pool.genderRestriction) {\n    return false;\n  }\n  \n  // è¡Œä¸šé™åˆ¶\n  if (pool.industryRestrictions && pool.industryRestrictions.length > 0) {\n    if (!user.industry || !pool.industryRestrictions.includes(user.industry)) {\n      return false;\n    }\n  }\n  \n  // èŒçº§é™åˆ¶\n  if (pool.seniorityRestrictions && pool.seniorityRestrictions.length > 0) {\n    if (!user.seniority || !pool.seniorityRestrictions.includes(user.seniority)) {\n      return false;\n    }\n  }\n  \n  // å­¦å†é™åˆ¶\n  if (pool.educationLevelRestrictions && pool.educationLevelRestrictions.length > 0) {\n    if (!user.educationLevel || !pool.educationLevelRestrictions.includes(user.educationLevel)) {\n      return false;\n    }\n  }\n  \n  // å¹´é¾„é™åˆ¶\n  if (pool.ageRangeMin && user.age && user.age < pool.ageRangeMin) {\n    return false;\n  }\n  if (pool.ageRangeMax && user.age && user.age > pool.ageRangeMax) {\n    return false;\n  }\n  \n  return true;\n}\n\n/**\n * è®¡ç®—ä¸¤ä¸ªç”¨æˆ·ä¹‹é—´çš„æ€§æ ¼åŒ–å­¦ååº”åˆ†æ•° (0-100)\n * è€ƒè™‘ä¸»è§’è‰²ï¼ˆ70%ï¼‰å’Œæ¬¡è¦è§’è‰²çš„äº¤å‰å…¼å®¹æ€§ï¼ˆå„15%ï¼Œå…±30%ï¼‰\n */\nfunction calculateChemistryScore(user1: UserWithProfile, user2: UserWithProfile): number {\n  const primary1 = (user1.archetype || \"æš–å¿ƒç†Š\") as keyof typeof CHEMISTRY_MATRIX;\n  const primary2 = (user2.archetype || \"æš–å¿ƒç†Š\") as keyof typeof CHEMISTRY_MATRIX;\n  const secondary1 = (user1.secondaryArchetype || \"æš–å¿ƒç†Š\") as keyof typeof CHEMISTRY_MATRIX;\n  const secondary2 = (user2.secondaryArchetype || \"æš–å¿ƒç†Š\") as keyof typeof CHEMISTRY_MATRIX;\n  \n  // ä¸»è§’è‰²åŒ–å­¦ååº”ï¼ˆ70%æƒé‡ï¼‰\n  const primaryChemistry = (CHEMISTRY_MATRIX[primary1]?.[primary2] || 50) * 0.70;\n  \n  // æ¬¡è¦è§’è‰²äº¤å‰åŠ æˆï¼ˆå„15%æƒé‡ï¼Œå…±30%ï¼‰\n  const crossChemistry1 = (CHEMISTRY_MATRIX[primary1]?.[secondary2] || 50) * 0.15;\n  const crossChemistry2 = (CHEMISTRY_MATRIX[secondary1]?.[primary2] || 50) * 0.15;\n  \n  return Math.round(primaryChemistry + crossChemistry1 + crossChemistry2);\n}\n\n/**\n * è®¡ç®—å…´è¶£é‡å åº¦ (0-100)\n * ä½¿ç”¨Jaccardç³»æ•°ï¼šäº¤é›† / å¹¶é›†\n */\nfunction calculateInterestScore(user1: UserWithProfile, user2: UserWithProfile): number {\n  const interests1 = user1.interestsTop || [];\n  const interests2 = user2.interestsTop || [];\n  \n  if (interests1.length === 0 && interests2.length === 0) return 70; // éƒ½æ²¡æœ‰å…´è¶£è®°å½•ï¼Œé»˜è®¤ä¸­ç­‰åˆ†æ•°\n  if (interests1.length === 0 || interests2.length === 0) return 30; // ä¸€æ–¹æ²¡æœ‰è®°å½•ï¼Œä½åˆ†\n  \n  const overlap = interests1.filter(i => interests2.includes(i)).length;\n  const union = new Set([...interests1, ...interests2]).size;\n  \n  // Jaccardç³»æ•°ï¼š(äº¤é›†å¤§å° / å¹¶é›†å¤§å°) * 85 + 15\n  // æ— é‡å =15åˆ†ï¼Œå®Œå…¨é‡å =100åˆ†\n  const jaccardRatio = overlap / union;\n  return Math.round(jaccardRatio * 85 + 15);\n}\n\n/**\n * è®¡ç®—è¯­è¨€æ²Ÿé€šå…¼å®¹æ€§ (0-100)\n */\nfunction calculateLanguageScore(user1: UserWithProfile, user2: UserWithProfile): number {\n  const langs1 = user1.languagesComfort || user1.preferredLanguages || [];\n  const langs2 = user2.languagesComfort || user2.preferredLanguages || [];\n  \n  if (langs1.length === 0 || langs2.length === 0) return 70; // é»˜è®¤å‡è®¾å¯ä»¥æ²Ÿé€š\n  \n  const overlap = langs1.filter(l => langs2.includes(l)).length;\n  return overlap > 0 ? 100 : 30; // æœ‰å…±åŒè¯­è¨€=100ï¼Œæ— å…±åŒè¯­è¨€=30\n}\n\n/**\n * è®¡ç®—æ´»åŠ¨åå¥½å…¼å®¹æ€§ (0-100)\n * è€ƒè™‘ï¼šé¢„ç®—ã€é¥®é£Ÿåå¥½ã€ç¤¾äº¤ç›®çš„\n */\nfunction calculatePreferenceScore(user1: UserWithProfile, user2: UserWithProfile): number {\n  let score = 0;\n  let factors = 0;\n  \n  // é¢„ç®—å…¼å®¹æ€§\n  const budget1 = user1.budgetRange || [];\n  const budget2 = user2.budgetRange || [];\n  if (budget1.length > 0 && budget2.length > 0) {\n    const budgetOverlap = budget1.filter(b => budget2.includes(b)).length;\n    score += (budgetOverlap / Math.max(budget1.length, budget2.length)) * 100;\n    factors++;\n  }\n  \n  // é¥®é£Ÿåå¥½å…¼å®¹æ€§\n  const cuisine1 = user1.cuisinePreferences || [];\n  const cuisine2 = user2.cuisinePreferences || [];\n  if (cuisine1.length > 0 && cuisine2.length > 0) {\n    const cuisineOverlap = cuisine1.filter(c => cuisine2.includes(c)).length;\n    score += (cuisineOverlap / Math.max(cuisine1.length, cuisine2.length)) * 100;\n    factors++;\n  }\n  \n  // ç¤¾äº¤ç›®çš„å…¼å®¹æ€§\n  const goals1 = user1.socialGoals || [];\n  const goals2 = user2.socialGoals || [];\n  if (goals1.length > 0 && goals2.length > 0) {\n    const goalsOverlap = goals1.filter(g => goals2.includes(g)).length;\n    score += (goalsOverlap / Math.max(goals1.length, goals2.length)) * 100;\n    factors++;\n  }\n  \n  return factors > 0 ? Math.round(score / factors) : 60; // é»˜è®¤ä¸­ç­‰å…¼å®¹\n}\n\n/**\n * è®¡ç®—èƒŒæ™¯å¤šæ ·æ€§åˆ†æ•° (0-100)\n * ä¸åŒè¡Œä¸šã€èŒçº§ = æ›´é«˜åˆ†ï¼ˆé¼“åŠ±å¤šæ ·æ€§ï¼‰\n */\nfunction calculateDiversityScore(user1: UserWithProfile, user2: UserWithProfile): number {\n  let diversityPoints = 0;\n  \n  // ä¸åŒè¡Œä¸š +50\n  if (user1.industry && user2.industry && user1.industry !== user2.industry) {\n    diversityPoints += 50;\n  }\n  \n  // ä¸åŒèŒçº§ +30\n  if (user1.seniority && user2.seniority && user1.seniority !== user2.seniority) {\n    diversityPoints += 30;\n  }\n  \n  // ä¸åŒæ€§åˆ« +20\n  if (user1.gender && user2.gender && user1.gender !== user2.gender) {\n    diversityPoints += 20;\n  }\n  \n  return Math.min(diversityPoints, 100);\n}\n\n/**\n * è®¡ç®—ä¸¤ä¸ªç”¨æˆ·çš„é…å¯¹å…¼å®¹æ€§åˆ†æ•° (0-100)\n * æ³¨æ„ï¼šdiversityåœ¨å°ç»„å±‚é¢å•ç‹¬è®¡ç®—ï¼Œä¸åœ¨é…å¯¹å±‚é¢é‡å¤è®¡ç®—\n */\nfunction calculatePairScore(user1: UserWithProfile, user2: UserWithProfile): number {\n  const chemistry = calculateChemistryScore(user1, user2);\n  const interest = calculateInterestScore(user1, user2);\n  const language = calculateLanguageScore(user1, user2);\n  const preference = calculatePreferenceScore(user1, user2);\n  \n  // æƒé‡é…ç½®ï¼šä»…åŒ…å«é…å¯¹å…¼å®¹æ€§ç»´åº¦ï¼ˆæ€»å’Œ100%ï¼‰\n  // diversityåœ¨å°ç»„å±‚é¢å•ç‹¬è®¡ç®—ï¼Œé¿å…é‡å¤è®¡ç®—\n  const weights = {\n    chemistry: 0.35,   // æ€§æ ¼å…¼å®¹æ€§ 35%\n    interest: 0.30,    // å…´è¶£é‡å  30%\n    preference: 0.20,  // æ´»åŠ¨åå¥½ 20%\n    language: 0.15     // è¯­è¨€æ²Ÿé€š 15%\n  };\n  \n  const totalScore = \n    chemistry * weights.chemistry +\n    interest * weights.interest +\n    preference * weights.preference +\n    language * weights.language;\n  \n  return Math.round(totalScore);\n}\n\n/**\n * è®¡ç®—å°ç»„å†…æ‰€æœ‰æˆå‘˜çš„å¹³å‡é…å¯¹å…¼å®¹æ€§åˆ†æ•°\n * åŒ…å«ï¼šchemistry + interest + preference + languageï¼ˆä¸å«diversityï¼‰\n */\nfunction calculateGroupPairScore(members: UserWithProfile[]): number {\n  if (members.length < 2) return 0;\n  \n  let totalScore = 0;\n  let pairCount = 0;\n  \n  for (let i = 0; i < members.length; i++) {\n    for (let j = i + 1; j < members.length; j++) {\n      totalScore += calculatePairScore(members[i], members[j]);\n      pairCount++;\n    }\n  }\n  \n  return pairCount > 0 ? Math.round(totalScore / pairCount) : 0;\n}\n\n/**\n * è®¡ç®—å°ç»„çš„å¤šæ ·æ€§åˆ†æ•°\n */\nfunction calculateGroupDiversity(members: UserWithProfile[]): number {\n  const uniqueIndustries = new Set(members.map(m => m.industry).filter(Boolean)).size;\n  const uniqueSeniorities = new Set(members.map(m => m.seniority).filter(Boolean)).size;\n  const uniqueGenders = new Set(members.map(m => m.gender).filter(Boolean)).size;\n  const uniqueArchetypes = new Set(members.map(m => m.archetype).filter(Boolean)).size;\n  \n  // å½’ä¸€åŒ–åˆ° 0-100\n  const maxDiversity = members.length;\n  const diversityScore = \n    (uniqueIndustries / maxDiversity) * 25 +\n    (uniqueSeniorities / maxDiversity) * 25 +\n    (uniqueGenders / maxDiversity) * 25 +\n    (uniqueArchetypes / maxDiversity) * 25;\n  \n  return Math.round(diversityScore * 100);\n}\n\n/**\n * è®¡ç®—å°ç»„çš„èƒ½é‡å¹³è¡¡åˆ†æ•° (0-100)\n * ç†æƒ³çš„å°ç»„åº”è¯¥æœ‰å¹³è¡¡çš„èƒ½é‡åˆ†å¸ƒï¼š\n * - å¹³å‡èƒ½é‡åœ¨50-70ä¹‹é—´ï¼ˆæ—¢ä¸å…¨æ˜¯é«˜èƒ½é‡ï¼Œä¹Ÿä¸å…¨æ˜¯ä½èƒ½é‡ï¼‰\n * - æ ‡å‡†å·®è¶Šå°è¶Šå¥½ï¼ˆæˆå‘˜ä¹‹é—´èƒ½é‡å·®å¼‚ä¸èƒ½å¤ªå¤§ï¼‰\n */\nfunction calculateEnergyBalance(members: UserWithProfile[]): number {\n  if (members.length === 0) return 0;\n  \n  // 1. è·å–æ¯ä¸ªæˆå‘˜çš„èƒ½é‡å€¼\n  const energyLevels = members.map(m => {\n    const archetype = (m.archetype || \"æš–å¿ƒç†Š\") as keyof typeof ARCHETYPE_ENERGY;\n    return ARCHETYPE_ENERGY[archetype] || 50;\n  });\n  \n  // 2. è®¡ç®—å¹³å‡èƒ½é‡\n  const avgEnergy = energyLevels.reduce((sum, e) => sum + e, 0) / energyLevels.length;\n  \n  // 3. è®¡ç®—æ ‡å‡†å·®\n  const variance = energyLevels.reduce((sum, e) => sum + Math.pow(e - avgEnergy, 2), 0) / energyLevels.length;\n  const stdDev = Math.sqrt(variance);\n  \n  // 4. è¯„åˆ†é€»è¾‘\n  // 4.1 å¹³å‡èƒ½é‡å¾—åˆ†ï¼šç›®æ ‡èŒƒå›´50-70ï¼Œè¶Šæ¥è¿‘è¶Šå¥½\n  let avgEnergyScore = 0;\n  if (avgEnergy >= 50 && avgEnergy <= 70) {\n    avgEnergyScore = 100; // ç†æƒ³èŒƒå›´\n  } else if (avgEnergy >= 40 && avgEnergy < 50) {\n    avgEnergyScore = 80 + (avgEnergy - 40) * 2; // 40-49: 80-100åˆ†\n  } else if (avgEnergy > 70 && avgEnergy <= 80) {\n    avgEnergyScore = 100 - (avgEnergy - 70); // 70-80: 100-90åˆ†\n  } else if (avgEnergy >= 30 && avgEnergy < 40) {\n    avgEnergyScore = 60 + (avgEnergy - 30) * 2; // 30-39: 60-80åˆ†\n  } else if (avgEnergy > 80 && avgEnergy <= 90) {\n    avgEnergyScore = 90 - (avgEnergy - 80) * 2; // 80-90: 90-70åˆ†\n  } else {\n    avgEnergyScore = Math.max(0, 100 - Math.abs(avgEnergy - 60) * 2); // å…¶ä»–èŒƒå›´é€’å‡\n  }\n  \n  // 4.2 æ ‡å‡†å·®å¾—åˆ†ï¼šæ ‡å‡†å·®è¶Šå°è¶Šå¥½ï¼ˆç›®æ ‡<15ï¼‰\n  let stdDevScore = 0;\n  if (stdDev <= 15) {\n    stdDevScore = 100;\n  } else if (stdDev <= 25) {\n    stdDevScore = 100 - (stdDev - 15) * 4; // 15-25: 100-60åˆ†\n  } else {\n    stdDevScore = Math.max(0, 60 - (stdDev - 25) * 2); // >25: é€’å‡\n  }\n  \n  // 5. ç»¼åˆå¾—åˆ†ï¼šå¹³å‡èƒ½é‡60% + æ ‡å‡†å·®40%\n  const balanceScore = Math.round(avgEnergyScore * 0.6 + stdDevScore * 0.4);\n  \n  return balanceScore;\n}\n\n/**\n * æ ¹æ®ç»¼åˆåˆ†æ•°è·å–åŒ–å­¦ååº”æ¸©åº¦ç­‰çº§\n */\nfunction getTemperatureLevel(overallScore: number): string {\n  if (overallScore >= 85) return \"fire\";    // ğŸ”¥ç‚½çƒ­\n  if (overallScore >= 70) return \"warm\";    // ğŸŒ¡ï¸æ¸©æš–\n  if (overallScore >= 55) return \"mild\";    // ğŸŒ¤ï¸é€‚å®œ\n  return \"cold\";                             // â„ï¸å†·æ·¡\n}\n\n/**\n * è·å–æ¸©åº¦ç­‰çº§çš„emojiæ˜¾ç¤º\n */\nexport function getTemperatureEmoji(temperatureLevel: string): string {\n  const emojiMap: Record<string, string> = {\n    \"fire\": \"ğŸ”¥\",\n    \"warm\": \"ğŸŒ¡ï¸\",\n    \"mild\": \"ğŸŒ¤ï¸\",\n    \"cold\": \"â„ï¸\"\n  };\n  return emojiMap[temperatureLevel] || \"ğŸŒ¤ï¸\";\n}\n\n/**\n * ç”Ÿæˆå°ç»„åŒ¹é…è§£é‡Šæ–‡æ¡ˆ\n */\nfunction generateGroupExplanation(group: MatchGroup): string {\n  const archetypes = group.members.map(m => m.archetype || \"æœªçŸ¥\").filter((v, i, a) => a.indexOf(v) === i);\n  const industries = group.members.map(m => m.industry || \"æœªçŸ¥\").filter((v, i, a) => a.indexOf(v) === i);\n  const tempEmoji = getTemperatureEmoji(group.temperatureLevel);\n  \n  return `${tempEmoji} è¿™ä¸ªå°ç»„æœ‰${group.members.length}ä½æˆå‘˜ï¼ŒåŒ…å«${archetypes.length}ç§äººæ ¼ç±»å‹ï¼ˆ${archetypes.join(\"ã€\")}ï¼‰ï¼Œæ¥è‡ª${industries.length}ä¸ªè¡Œä¸šã€‚é…å¯¹å…¼å®¹æ€§${group.avgPairScore}åˆ†ï¼Œå¤šæ ·æ€§${group.diversityScore}åˆ†ï¼Œèƒ½é‡å¹³è¡¡${group.energyBalance}åˆ†ï¼Œç»¼åˆåŒ¹é…åº¦${group.overallScore}åˆ†ã€‚`;\n}\n\n/**\n * ä¸»åŒ¹é…ç®—æ³•ï¼šè´ªå©ª+ä¼˜åŒ–ç­–ç•¥\n * 1. æŒ‰åŒ¹é…åˆ†æ•°æ’åºæ‰€æœ‰å¯èƒ½çš„é…å¯¹\n * 2. è´ªå©ªåœ°ç»„å»ºå°ç»„ï¼Œç¡®ä¿æ¯ä¸ªå°ç»„è´¨é‡\n * 3. ä¼˜åŒ–ï¼šè°ƒæ•´è¾¹ç•Œæˆå‘˜ä»¥æå‡æ•´ä½“åˆ†æ•°\n */\nexport async function matchEventPool(poolId: string): Promise<MatchGroup[]> {\n  // 1. è·å–æ´»åŠ¨æ± é…ç½®\n  const pool = await db.query.eventPools.findFirst({\n    where: eq(eventPools.id, poolId)\n  });\n  \n  if (!pool) {\n    throw new Error(\"æ´»åŠ¨æ± ä¸å­˜åœ¨\");\n  }\n  \n  // 2. è·å–æ‰€æœ‰æŠ¥åè€… + ç”¨æˆ·èµ„æ–™\n  const registrations = await db\n    .select({\n      registrationId: eventPoolRegistrations.id,\n      userId: eventPoolRegistrations.userId,\n      budgetRange: eventPoolRegistrations.budgetRange,\n      preferredLanguages: eventPoolRegistrations.preferredLanguages,\n      socialGoals: eventPoolRegistrations.socialGoals,\n      cuisinePreferences: eventPoolRegistrations.cuisinePreferences,\n      dietaryRestrictions: eventPoolRegistrations.dietaryRestrictions,\n      tasteIntensity: eventPoolRegistrations.tasteIntensity,\n      gender: users.gender,\n      age: users.age,\n      industry: users.industry,\n      seniority: users.seniority,\n      educationLevel: users.educationLevel,\n      archetype: users.archetype,\n      secondaryArchetype: users.secondaryRole,\n      interestsTop: users.interestsTop,\n      languagesComfort: users.languagesComfort,\n    })\n    .from(eventPoolRegistrations)\n    .innerJoin(users, eq(eventPoolRegistrations.userId, users.id))\n    .where(\n      and(\n        eq(eventPoolRegistrations.poolId, poolId),\n        eq(eventPoolRegistrations.matchStatus, \"pending\")\n      )\n    );\n  \n  // 3. ç¡¬çº¦æŸè¿‡æ»¤\n  const eligibleUsers = registrations.filter((reg: any) => \n    meetsHardConstraints(reg as UserWithProfile, pool)\n  );\n  \n  if (eligibleUsers.length < (pool.minGroupSize || 4)) {\n    throw new Error(`æŠ¥åäººæ•°ä¸è¶³ï¼Œè‡³å°‘éœ€è¦${pool.minGroupSize}äºº`);\n  }\n  \n  // 3.5 è·å–é‚€è¯·å…³ç³» (invitation relationships)\n  // Query all invitation uses for registrations in this pool\n  const registrationIds = eligibleUsers.map(u => u.registrationId);\n  \n  // Build invitation map: inviteeUserId -> inviterUserId\n  // This will help us prioritize matching invited users with their inviters\n  const invitationPairs: Array<{inviterId: string, inviteeId: string}> = [];\n  \n  for (const user of eligibleUsers) {\n    // Check if this user was invited (is an invitee)\n    const [inviteUse] = await db\n      .select()\n      .from(invitationUses)\n      .where(eq(invitationUses.poolRegistrationId, user.registrationId))\n      .limit(1);\n    \n    if (inviteUse && inviteUse.invitationId) {\n      // Get the invitation to find who invited this user\n      const [invitation] = await db\n        .select()\n        .from(invitations)\n        .where(eq(invitations.code, inviteUse.invitationId))\n        .limit(1);\n      \n      if (invitation) {\n        // Check if inviter is also in this pool\n        const inviter = eligibleUsers.find(u => u.userId === invitation.inviterId);\n        if (inviter) {\n          invitationPairs.push({\n            inviterId: inviter.userId,\n            inviteeId: user.userId\n          });\n        }\n      }\n    }\n  }\n  \n  // 4. è´ªå©ªåˆ†ç»„ç®—æ³•ï¼ˆä¼˜å…ˆå¤„ç†é‚€è¯·å…³ç³»ï¼‰\n  const groups: MatchGroup[] = [];\n  const used = new Set<string>();\n  const targetGroupSize = pool.maxGroupSize || 6;\n  const minGroupSize = pool.minGroupSize || 4;\n  \n  // è®¡ç®—æ‰€æœ‰å¯èƒ½çš„é…å¯¹åˆ†æ•°ï¼Œå¹¶ä¸ºé‚€è¯·å…³ç³»åŠ æƒ\n  const pairScores: { user1: UserWithProfile; user2: UserWithProfile; score: number; isInvited: boolean }[] = [];\n  for (let i = 0; i < eligibleUsers.length; i++) {\n    for (let j = i + 1; j < eligibleUsers.length; j++) {\n      let score = calculatePairScore(\n        eligibleUsers[i] as UserWithProfile, \n        eligibleUsers[j] as UserWithProfile\n      );\n      \n      // Check if this pair has an invitation relationship\n      const user1 = eligibleUsers[i] as UserWithProfile;\n      const user2 = eligibleUsers[j] as UserWithProfile;\n      const isInvited = invitationPairs.some(pair => \n        (pair.inviterId === user1.userId && pair.inviteeId === user2.userId) ||\n        (pair.inviterId === user2.userId && pair.inviteeId === user1.userId)\n      );\n      \n      // Boost score for invited pairs (soft constraint)\n      if (isInvited) {\n        score = Math.min(100, score + 20); // Add 20 points bonus\n      }\n      \n      pairScores.push({\n        user1,\n        user2,\n        score,\n        isInvited\n      });\n    }\n  }\n  \n  // æŒ‰åˆ†æ•°é™åºæ’åºï¼ˆé‚€è¯·å…³ç³»ä¼šè‡ªåŠ¨æ’åœ¨å‰é¢å› ä¸ºæœ‰åŠ åˆ†ï¼‰\n  pairScores.sort((a, b) => b.score - a.score);\n  \n  // è´ªå©ªç»„å»ºå°ç»„\n  for (const pair of pairScores) {\n    if (used.has(pair.user1.userId) || used.has(pair.user2.userId)) continue;\n    \n    // ä»¥è¿™å¯¹é«˜åˆ†ç”¨æˆ·ä¸ºæ ¸å¿ƒï¼Œæ‰¾åˆ°å…¶ä»–åˆé€‚çš„æˆå‘˜\n    const groupMembers = [pair.user1, pair.user2];\n    used.add(pair.user1.userId);\n    used.add(pair.user2.userId);\n    \n    // ç»§ç»­æ·»åŠ æˆå‘˜ç›´åˆ°è¾¾åˆ°ç›®æ ‡äººæ•°\n    while (groupMembers.length < targetGroupSize) {\n      let bestCandidate: UserWithProfile | null = null;\n      let bestScore = 0;\n      \n      for (const candidate of eligibleUsers as UserWithProfile[]) {\n        if (used.has(candidate.userId)) continue;\n        \n        // è®¡ç®—å€™é€‰äººä¸å½“å‰å°ç»„æˆå‘˜çš„å¹³å‡åˆ†æ•°\n        let totalScore = 0;\n        for (const member of groupMembers) {\n          totalScore += calculatePairScore(candidate, member);\n        }\n        const avgScore = totalScore / groupMembers.length;\n        \n        if (avgScore > bestScore) {\n          bestScore = avgScore;\n          bestCandidate = candidate;\n        }\n      }\n      \n      if (bestCandidate && bestScore >= 60) { // æœ€ä½è´¨é‡é—¨æ§›\n        groupMembers.push(bestCandidate);\n        used.add(bestCandidate.userId);\n      } else {\n        break; // æ²¡æœ‰åˆé€‚çš„å€™é€‰äºº\n      }\n    }\n    \n    // åªä¿ç•™è¾¾åˆ°æœ€å°äººæ•°çš„å°ç»„\n    if (groupMembers.length >= minGroupSize) {\n      const avgPairScore = calculateGroupPairScore(groupMembers);\n      const diversity = calculateGroupDiversity(groupMembers);\n      const energyBalance = calculateEnergyBalance(groupMembers);\n      const overall = Math.round((avgPairScore * 0.6) + (diversity * 0.25) + (energyBalance * 0.15));\n      const temperatureLevel = getTemperatureLevel(overall);\n      \n      const group: MatchGroup = {\n        members: groupMembers,\n        avgPairScore: avgPairScore,\n        diversityScore: diversity,\n        energyBalance: energyBalance,\n        overallScore: overall,\n        temperatureLevel: temperatureLevel,\n        explanation: \"\"\n      };\n      \n      group.explanation = generateGroupExplanation(group);\n      groups.push(group);\n    } else {\n      // é‡Šæ”¾è¿™äº›æˆå‘˜ï¼Œå…è®¸ä»–ä»¬åŠ å…¥å…¶ä»–ç»„\n      groupMembers.forEach(m => used.delete(m.userId));\n    }\n    \n    // è¾¾åˆ°ç›®æ ‡ç»„æ•°å°±åœæ­¢\n    if (groups.length >= (pool.targetGroups || 1)) {\n      break;\n    }\n  }\n  \n  return groups;\n}\n\n/**\n * ä¿å­˜åŒ¹é…ç»“æœåˆ°æ•°æ®åº“\n */\nexport async function saveMatchResults(poolId: string, groups: MatchGroup[]): Promise<void> {\n  // è·å–æ´»åŠ¨æ± ä¿¡æ¯ç”¨äºé€šçŸ¥\n  const [pool] = await db.select().from(eventPools).where(eq(eventPools.id, poolId));\n  \n  // 1. åˆ›å»ºå°ç»„è®°å½•å¹¶å‘é€WebSocketé€šçŸ¥\n  for (let i = 0; i < groups.length; i++) {\n    const group = groups[i];\n    \n    const [groupRecord] = await db.insert(eventPoolGroups).values({\n      poolId,\n      groupNumber: i + 1,\n      memberCount: group.members.length,\n      avgChemistryScore: group.avgPairScore,\n      diversityScore: group.diversityScore,\n      energyBalance: group.energyBalance,\n      overallScore: group.overallScore,\n      temperatureLevel: group.temperatureLevel,\n      matchExplanation: group.explanation,\n      status: \"confirmed\"\n    }).returning();\n    \n    // 2. æ›´æ–°ç”¨æˆ·æŠ¥åçŠ¶æ€\n    const memberRegistrationIds = group.members.map(m => m.registrationId);\n    await db.update(eventPoolRegistrations)\n      .set({\n        matchStatus: \"matched\",\n        assignedGroupId: groupRecord.id,\n        matchScore: group.overallScore,\n        updatedAt: new Date()\n      })\n      .where(inArray(eventPoolRegistrations.id, memberRegistrationIds));\n    \n    // 3. å‘é€WebSocketé€šçŸ¥ç»™æ¯ä¸ªåŒ¹é…åˆ°çš„ç”¨æˆ·\n    const memberUserIds = group.members.map(m => m.userId);\n    const notificationData: PoolMatchedData = {\n      poolId,\n      poolTitle: pool?.title || \"æ´»åŠ¨æ± \",\n      groupId: groupRecord.id,\n      groupNumber: i + 1,\n      matchScore: group.overallScore,\n      memberCount: group.members.length,\n      temperatureLevel: group.temperatureLevel\n    };\n    \n    memberUserIds.forEach(userId => {\n      wsService.broadcastToUser(userId, {\n        type: \"POOL_MATCHED\",\n        data: notificationData,\n        timestamp: new Date().toISOString()\n      });\n    });\n    \n    console.log(`[Pool Matching] Sent POOL_MATCHED notification to ${memberUserIds.length} users for group ${i + 1}`);\n  }\n  \n  // 4. æ›´æ–°æ´»åŠ¨æ± çŠ¶æ€\n  await db.update(eventPools)\n    .set({\n      status: \"matched\",\n      successfulMatches: groups.reduce((sum, g) => sum + g.members.length, 0),\n      matchedAt: new Date(),\n      updatedAt: new Date()\n    })\n    .where(eq(eventPools.id, poolId));\n  \n  // 5. æ ‡è®°æœªåŒ¹é…ç”¨æˆ·\n  await db.update(eventPoolRegistrations)\n    .set({\n      matchStatus: \"unmatched\",\n      updatedAt: new Date()\n    })\n    .where(\n      and(\n        eq(eventPoolRegistrations.poolId, poolId),\n        eq(eventPoolRegistrations.matchStatus, \"pending\")\n      )\n    );\n  \n  // 6. å‘æ”¾é‚€è¯·å¥–åŠ±ä¼˜æƒ åˆ¸ (Invitation Reward Coupons)\n  await processInvitationRewards(poolId, groups);\n}\n\n/**\n * å¤„ç†é‚€è¯·å¥–åŠ±ï¼šä¸ºæˆåŠŸåŒ¹é…çš„é‚€è¯·å…³ç³»å‘æ”¾ä¼˜æƒ åˆ¸\n */\nasync function processInvitationRewards(poolId: string, groups: MatchGroup[]): Promise<void> {\n  // æŸ¥æ‰¾é‚€è¯·å¥–åŠ±ä¼˜æƒ åˆ¸ï¼ˆç®¡ç†å‘˜éœ€è¦é¢„å…ˆåˆ›å»ºcodeä¸º\"INVITE_REWARD\"çš„ä¼˜æƒ åˆ¸ï¼‰\n  const [inviteRewardCoupon] = await db.select()\n    .from(coupons)\n    .where(eq(coupons.code, \"INVITE_REWARD\"))\n    .limit(1);\n  \n  if (!inviteRewardCoupon || !inviteRewardCoupon.isActive) {\n    console.log('[Invitation Reward] No active INVITE_REWARD coupon found, skipping rewards');\n    return;\n  }\n  \n  // è·å–è¯¥poolçš„æ‰€æœ‰æˆåŠŸåŒ¹é…çš„ç”¨æˆ·\n  const allMatchedUserIds = groups.flatMap(g => g.members.map(m => m.userId));\n  \n  // æŸ¥æ‰¾æ‰€æœ‰æ¶‰åŠè¯¥poolçš„é‚€è¯·ä½¿ç”¨è®°å½•\n  const poolRegistrations = await db.select()\n    .from(eventPoolRegistrations)\n    .where(eq(eventPoolRegistrations.poolId, poolId));\n  \n  const registrationIds = poolRegistrations.map(r => r.id);\n  \n  if (registrationIds.length === 0) return;\n  \n  const inviteUses = await db.select()\n    .from(invitationUses)\n    .where(inArray(invitationUses.poolRegistrationId, registrationIds));\n  \n  // å¯¹äºæ¯ä¸ªé‚€è¯·ä½¿ç”¨è®°å½•ï¼Œæ£€æŸ¥æ˜¯å¦æˆåŠŸåŒ¹é…åˆ°åŒä¸€å±€\n  for (const inviteUse of inviteUses) {\n    if (inviteUse.rewardIssued || !inviteUse.invitationId) continue;\n    \n    // è·å–é‚€è¯·ä¿¡æ¯\n    const [invitation] = await db.select()\n      .from(invitations)\n      .where(eq(invitations.code, inviteUse.invitationId))\n      .limit(1);\n    \n    if (!invitation) continue;\n    \n    const inviterId = invitation.inviterId;\n    const inviteeId = inviteUse.inviteeId;\n    \n    // æ£€æŸ¥inviterå’Œinviteeæ˜¯å¦éƒ½åœ¨åŒ¹é…ç”¨æˆ·åˆ—è¡¨ä¸­\n    if (!allMatchedUserIds.includes(inviterId) || !allMatchedUserIds.includes(inviteeId)) {\n      continue;\n    }\n    \n    // æ£€æŸ¥ä»–ä»¬æ˜¯å¦åœ¨åŒä¸€ä¸ªgroupä¸­\n    let matchedTogether = false;\n    for (const group of groups) {\n      const groupUserIds = group.members.map(m => m.userId);\n      if (groupUserIds.includes(inviterId) && groupUserIds.includes(inviteeId)) {\n        matchedTogether = true;\n        break;\n      }\n    }\n    \n    if (matchedTogether) {\n      // å‘æ”¾ä¼˜æƒ åˆ¸ç»™é‚€è¯·äºº\n      try {\n        await db.insert(userCoupons).values({\n          userId: inviterId,\n          couponId: inviteRewardCoupon.id,\n          source: \"invitation_reward\",\n          sourceId: invitation.id,\n          isUsed: false\n        });\n        \n        // æ ‡è®°å¥–åŠ±å·²å‘æ”¾\n        await db.update(invitationUses)\n          .set({\n            matchedTogether: true,\n            rewardIssued: true,\n            matchedAt: new Date()\n          })\n          .where(eq(invitationUses.id, inviteUse.id));\n        \n        console.log(`[Invitation Reward] Issued coupon to user ${inviterId} for inviting ${inviteeId}`);\n      } catch (error) {\n        console.error(`[Invitation Reward] Failed to issue coupon:`, error);\n      }\n    }\n  }\n}\n","size_bytes":26569},"client/src/components/PoolRegistrationCard.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Calendar, MapPin, Users, Clock, Sparkles, XCircle, UserPlus, UserCheck } from \"lucide-react\";\nimport { format, parseISO } from \"date-fns\";\nimport { zhCN } from \"date-fns/locale\";\nimport { useLocation } from \"wouter\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\n\ninterface PoolRegistration {\n  id: string;\n  poolId: string;\n  matchStatus: \"pending\" | \"matched\" | \"completed\";\n  assignedGroupId: string | null;\n  matchScore: number | null;\n  registeredAt: string;\n  poolTitle: string;\n  poolEventType: string;\n  poolCity: string;\n  poolDistrict: string;\n  poolDateTime: string;\n  poolStatus: string;\n  budgetRange: string[];\n  preferredLanguages: string[];\n  socialGoals: string[];\n  invitationRole?: \"inviter\" | \"invitee\" | null;\n  relatedUserName?: string | null;\n}\n\ninterface PoolRegistrationCardProps {\n  registration: PoolRegistration;\n}\n\nexport default function PoolRegistrationCard({ registration }: PoolRegistrationCardProps) {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const poolDateTime = parseISO(registration.poolDateTime);\n  \n  const cancelMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"DELETE\", `/api/pool-registrations/${registration.id}`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"å·²å–æ¶ˆæŠ¥å\",\n        description: \"ä½ å·²æˆåŠŸå–æ¶ˆæ­¤æ´»åŠ¨æ± æŠ¥å\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/my-pool-registrations\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"å–æ¶ˆå¤±è´¥\",\n        description: error.message || \"æ— æ³•å–æ¶ˆæŠ¥åï¼Œè¯·ç¨åå†è¯•\",\n        variant: \"destructive\",\n      });\n    },\n  });\n  \n  const handleViewGroup = () => {\n    if (registration.assignedGroupId) {\n      setLocation(`/pool-groups/${registration.assignedGroupId}`);\n    }\n  };\n  \n  const getStatusBadge = () => {\n    if (registration.matchStatus === \"matched\") {\n      return <Badge className=\"bg-green-500 hover:bg-green-600\">å·²åŒ¹é…</Badge>;\n    } else if (registration.matchStatus === \"completed\") {\n      return <Badge variant=\"secondary\">å·²å®Œæˆ</Badge>;\n    } else {\n      return <Badge variant=\"outline\">åŒ¹é…ä¸­</Badge>;\n    }\n  };\n\n  const getMatchInfo = () => {\n    if (registration.matchStatus === \"matched\" && registration.matchScore !== null) {\n      return (\n        <div className=\"flex items-center gap-2 text-sm\">\n          <Sparkles className=\"h-4 w-4 text-primary\" />\n          <span className=\"text-muted-foreground\">\n            åŒ¹é…åº¦: <span className=\"font-semibold text-foreground\">{(registration.matchScore * 100).toFixed(0)}%</span>\n          </span>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  const getInvitationBadge = () => {\n    if (registration.invitationRole === \"inviter\" && registration.relatedUserName) {\n      return (\n        <Badge variant=\"outline\" className=\"bg-purple-50 dark:bg-purple-950 border-purple-300 dark:border-purple-800 text-purple-700 dark:text-purple-300\">\n          <UserPlus className=\"h-3 w-3 mr-1\" />\n          å·²é‚€è¯· {registration.relatedUserName}\n        </Badge>\n      );\n    } else if (registration.invitationRole === \"invitee\" && registration.relatedUserName) {\n      return (\n        <Badge variant=\"outline\" className=\"bg-blue-50 dark:bg-blue-950 border-blue-300 dark:border-blue-800 text-blue-700 dark:text-blue-300\">\n          <UserCheck className=\"h-3 w-3 mr-1\" />\n          {registration.relatedUserName} é‚€è¯·çš„\n        </Badge>\n      );\n    }\n    return null;\n  };\n\n  return (\n    <Card data-testid={`card-pool-registration-${registration.id}`}>\n      <CardHeader>\n        <div className=\"flex items-start justify-between gap-2\">\n          <div className=\"flex-1\">\n            <CardTitle className=\"text-lg\">{registration.poolTitle}</CardTitle>\n            <div className=\"flex items-center gap-2 mt-2 flex-wrap\">\n              <Badge variant=\"secondary\">{registration.poolEventType}</Badge>\n              {getStatusBadge()}\n              {getInvitationBadge()}\n            </div>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        <div className=\"flex items-center gap-2 text-sm\">\n          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          <span>{format(poolDateTime, 'MMæœˆddæ—¥ EEEE HH:mm', { locale: zhCN })}</span>\n        </div>\n        \n        <div className=\"flex items-center gap-2 text-sm\">\n          <MapPin className=\"h-4 w-4 text-muted-foreground\" />\n          <span>{registration.poolCity} Â· {registration.poolDistrict}</span>\n        </div>\n\n        {getMatchInfo()}\n\n        {registration.matchStatus === \"pending\" && (\n          <div className=\"pt-2 border-t space-y-3\">\n            <div className=\"text-sm text-muted-foreground space-y-1\">\n              <div className=\"flex items-center gap-2\">\n                <Clock className=\"h-4 w-4\" />\n                <span>AIæ­£åœ¨ä¸ºä½ å¯»æ‰¾æœ€ä½³åŒ¹é…...</span>\n              </div>\n            </div>\n            \n            <AlertDialog>\n              <AlertDialogTrigger asChild>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\"\n                  className=\"w-full\"\n                  data-testid={`button-cancel-registration-${registration.id}`}\n                >\n                  <XCircle className=\"h-4 w-4 mr-2\" />\n                  å–æ¶ˆæŠ¥å\n                </Button>\n              </AlertDialogTrigger>\n              <AlertDialogContent>\n                <AlertDialogHeader>\n                  <AlertDialogTitle>ç¡®è®¤å–æ¶ˆæŠ¥åï¼Ÿ</AlertDialogTitle>\n                  <AlertDialogDescription>\n                    ä½ ç¡®å®šè¦å–æ¶ˆæŠ¥åå—ï¼Ÿå–æ¶ˆåéœ€è¦é‡æ–°æŠ¥åæ‰èƒ½å‚åŠ æ­¤æ´»åŠ¨æ± ã€‚\n                  </AlertDialogDescription>\n                </AlertDialogHeader>\n                <AlertDialogFooter>\n                  <AlertDialogCancel data-testid=\"button-cancel-dialog-cancel\">å–æ¶ˆ</AlertDialogCancel>\n                  <AlertDialogAction\n                    onClick={() => cancelMutation.mutate()}\n                    disabled={cancelMutation.isPending}\n                    data-testid=\"button-cancel-dialog-confirm\"\n                  >\n                    {cancelMutation.isPending ? \"å–æ¶ˆä¸­...\" : \"ç¡®è®¤å–æ¶ˆ\"}\n                  </AlertDialogAction>\n                </AlertDialogFooter>\n              </AlertDialogContent>\n            </AlertDialog>\n          </div>\n        )}\n\n        {registration.matchStatus === \"matched\" && (\n          <div className=\"pt-2\">\n            <Button \n              className=\"w-full\" \n              size=\"sm\"\n              onClick={handleViewGroup}\n              data-testid={`button-view-group-${registration.id}`}\n            >\n              <Users className=\"h-4 w-4 mr-2\" />\n              æŸ¥çœ‹å°ç»„æˆå‘˜\n            </Button>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":7438},"client/src/pages/EventPoolRegistrationPage.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useRoute, useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport MobileHeader from \"@/components/MobileHeader\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage, FormDescription } from \"@/components/ui/form\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Calendar, MapPin, Users, Loader2, Check, Clock } from \"lucide-react\";\nimport { format, parseISO } from \"date-fns\";\nimport { zhCN } from \"date-fns/locale\";\n\ninterface EventPool {\n  id: string;\n  title: string;\n  description: string;\n  eventType: string;\n  city: string;\n  district: string;\n  dateTime: string;\n  registrationDeadline: string;\n  status: string;\n  registrationCount: number;\n  spotsLeft: number;\n  minGroupSize: number;\n  maxGroupSize: number;\n  targetGroups: number;\n}\n\nconst budgetOptions = [\"100å…ƒä»¥ä¸‹\", \"100-200\", \"200-300\", \"300-500\", \"500+\"];\nconst languageOptions = [\"ç²¤è¯­\", \"æ™®é€šè¯\", \"è‹±è¯­\"];\nconst socialGoalOptions = [\"è®¤è¯†æ–°æœ‹å‹\", \"æ‹“å±•äººè„‰\", \"è½»æ¾èŠå¤©\", \"æ·±åº¦äº¤æµ\", \"å…´è¶£æ¢ç´¢\"];\nconst cuisineOptions = [\"ç²¤èœ\", \"å·èœ\", \"æ—¥æ–™\", \"è¥¿é¤\", \"ç«é”…\", \"çƒ§çƒ¤\", \"å…¶ä»–\"];\nconst dietaryOptions = [\"æ— é™åˆ¶\", \"ç´ é£Ÿ\", \"æ¸…çœŸ\", \"æµ·é²œè¿‡æ•\", \"å…¶ä»–è¿‡æ•\"];\n\nconst registrationSchema = z.object({\n  budgetRange: z.array(z.string()).min(1, \"è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé¢„ç®—èŒƒå›´\"),\n  preferredLanguages: z.array(z.string()).min(1, \"è¯·è‡³å°‘é€‰æ‹©ä¸€ç§è¯­è¨€\"),\n  socialGoals: z.array(z.string()).min(1, \"è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç¤¾äº¤ç›®æ ‡\"),\n  cuisinePreferences: z.array(z.string()).optional(),\n  dietaryRestrictions: z.array(z.string()).optional(),\n  tasteIntensity: z.enum([\"light\", \"medium\", \"strong\"]),\n});\n\ntype RegistrationFormData = z.infer<typeof registrationSchema>;\n\nexport default function EventPoolRegistrationPage() {\n  const [, params] = useRoute(\"/event-pool/:id/register\");\n  const poolId = params?.id;\n  const [, navigate] = useLocation();\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const [paymentStep, setPaymentStep] = useState<\"form\" | \"payment\" | \"success\">(\"form\");\n\n  // Fetch event pool details\n  const { data: pool, isLoading } = useQuery<EventPool>({\n    queryKey: [\"/api/event-pools\", poolId],\n    enabled: !!poolId,\n  });\n\n  const form = useForm<RegistrationFormData>({\n    resolver: zodResolver(registrationSchema),\n    defaultValues: {\n      budgetRange: [],\n      preferredLanguages: [],\n      socialGoals: [],\n      cuisinePreferences: [],\n      dietaryRestrictions: [],\n      tasteIntensity: \"medium\",\n    },\n  });\n\n  // Registration mutation\n  const registerMutation = useMutation({\n    mutationFn: async (data: RegistrationFormData) => {\n      return await apiRequest(\"POST\", `/api/event-pools/${poolId}/register`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/my-pool-registrations\"] });\n      setPaymentStep(\"success\");\n      setTimeout(() => {\n        navigate(\"/events\");\n      }, 2000);\n    },\n    onError: (error: any) => {\n      // Check if error is subscription related\n      if (error.code === \"NO_ACTIVE_SUBSCRIPTION\" || error.message?.includes(\"Subscription required\")) {\n        toast({\n          title: \"éœ€è¦è®¢é˜…ä¼šå‘˜\",\n          description: \"æ´»åŠ¨æ± æŠ¥åä»…é™JoyJoinä¼šå‘˜ã€‚è®¢é˜…åå¯å…è´¹å‚åŠ æ‰€æœ‰æ´»åŠ¨æ± ï¼\",\n          variant: \"destructive\",\n        });\n      } else {\n        toast({\n          title: \"æŠ¥åå¤±è´¥\",\n          description: error.message || \"æ— æ³•å®ŒæˆæŠ¥åï¼Œè¯·é‡è¯•\",\n          variant: \"destructive\",\n        });\n      }\n      setPaymentStep(\"form\");\n    },\n  });\n\n  const onSubmit = (data: RegistrationFormData) => {\n    if (!user) {\n      toast({\n        title: \"è¯·å…ˆç™»å½•\",\n        description: \"éœ€è¦ç™»å½•æ‰èƒ½æŠ¥åæ´»åŠ¨\",\n        variant: \"destructive\",\n      });\n      navigate(\"/\");\n      return;\n    }\n\n    // For now, skip payment step and register directly\n    // In production, integrate with WeChat Pay here\n    registerMutation.mutate(data);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <MobileHeader title=\"æ´»åŠ¨æŠ¥å\" />\n        <div className=\"flex items-center justify-center py-12\">\n          <div className=\"text-center space-y-4\">\n            <div className=\"h-8 w-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n            <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!pool) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <MobileHeader title=\"æ´»åŠ¨æŠ¥å\" />\n        <div className=\"p-6 text-center\">\n          <p className=\"text-muted-foreground\">æ´»åŠ¨ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (paymentStep === \"success\") {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <MobileHeader title=\"æŠ¥åæˆåŠŸ\" />\n        <div className=\"flex items-center justify-center py-12\">\n          <div className=\"text-center space-y-4\">\n            <div className=\"h-16 w-16 rounded-full bg-green-500/10 flex items-center justify-center mx-auto\">\n              <Check className=\"h-8 w-8 text-green-500\" />\n            </div>\n            <div>\n              <h3 className=\"text-xl font-semibold mb-2\">æŠ¥åæˆåŠŸï¼</h3>\n              <p className=\"text-sm text-muted-foreground\">å³å°†è·³è½¬åˆ°æ´»åŠ¨é¡µé¢...</p>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const poolDateTime = parseISO(pool.dateTime);\n  const deadline = parseISO(pool.registrationDeadline);\n\n  return (\n    <div className=\"min-h-screen bg-background pb-6\">\n      <MobileHeader title=\"æ´»åŠ¨æŠ¥å\" />\n\n      <div className=\"px-4 py-6 space-y-6\">\n        {/* Event Pool Info Card */}\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-start justify-between gap-2\">\n              <div className=\"flex-1\">\n                <CardTitle className=\"text-xl\">{pool.title}</CardTitle>\n                <CardDescription className=\"mt-2\">{pool.description}</CardDescription>\n              </div>\n              <Badge>{pool.eventType}</Badge>\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"flex items-center gap-2 text-sm\">\n              <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n              <span>{format(poolDateTime, 'yyyyå¹´MMæœˆddæ—¥ EEEE HH:mm', { locale: zhCN })}</span>\n            </div>\n            <div className=\"flex items-center gap-2 text-sm\">\n              <MapPin className=\"h-4 w-4 text-muted-foreground\" />\n              <span>{pool.city} Â· {pool.district}</span>\n            </div>\n            <div className=\"flex items-center gap-2 text-sm\">\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\n              <span>å·²æŠ¥å {pool.registrationCount} äººï¼Œå‰©ä½™ {pool.spotsLeft} ä¸ªåé¢</span>\n            </div>\n            <div className=\"flex items-center gap-2 text-sm\">\n              <Clock className=\"h-4 w-4 text-muted-foreground\" />\n              <span>æŠ¥åæˆªæ­¢ï¼š{format(deadline, 'MMæœˆddæ—¥ HH:mm', { locale: zhCN })}</span>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Registration Form */}\n        <Card>\n          <CardHeader>\n            <CardTitle>åå¥½è®¾ç½®</CardTitle>\n            <CardDescription>\n              å¡«å†™æ‚¨çš„åå¥½ï¼ŒAIå°†æ ¹æ®è¿™äº›ä¿¡æ¯ä¸ºæ‚¨åŒ¹é…æœ€åˆé€‚çš„å°ç»„\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n                {/* Budget Range */}\n                <FormField\n                  control={form.control}\n                  name=\"budgetRange\"\n                  render={() => (\n                    <FormItem>\n                      <FormLabel>é¢„ç®—èŒƒå›´ *</FormLabel>\n                      <FormDescription>å¯å¤šé€‰</FormDescription>\n                      <div className=\"space-y-2\">\n                        {budgetOptions.map((option) => (\n                          <FormField\n                            key={option}\n                            control={form.control}\n                            name=\"budgetRange\"\n                            render={({ field }) => (\n                              <FormItem className=\"flex items-center gap-2 space-y-0\">\n                                <FormControl>\n                                  <Checkbox\n                                    checked={field.value?.includes(option)}\n                                    onCheckedChange={(checked) => {\n                                      return checked\n                                        ? field.onChange([...field.value, option])\n                                        : field.onChange(field.value?.filter((v) => v !== option));\n                                    }}\n                                    data-testid={`checkbox-budget-${option}`}\n                                  />\n                                </FormControl>\n                                <Label className=\"font-normal cursor-pointer\">{option}</Label>\n                              </FormItem>\n                            )}\n                          />\n                        ))}\n                      </div>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* Preferred Languages */}\n                <FormField\n                  control={form.control}\n                  name=\"preferredLanguages\"\n                  render={() => (\n                    <FormItem>\n                      <FormLabel>è¯­è¨€åå¥½ *</FormLabel>\n                      <FormDescription>å¯å¤šé€‰</FormDescription>\n                      <div className=\"space-y-2\">\n                        {languageOptions.map((option) => (\n                          <FormField\n                            key={option}\n                            control={form.control}\n                            name=\"preferredLanguages\"\n                            render={({ field }) => (\n                              <FormItem className=\"flex items-center gap-2 space-y-0\">\n                                <FormControl>\n                                  <Checkbox\n                                    checked={field.value?.includes(option)}\n                                    onCheckedChange={(checked) => {\n                                      return checked\n                                        ? field.onChange([...field.value, option])\n                                        : field.onChange(field.value?.filter((v) => v !== option));\n                                    }}\n                                    data-testid={`checkbox-language-${option}`}\n                                  />\n                                </FormControl>\n                                <Label className=\"font-normal cursor-pointer\">{option}</Label>\n                              </FormItem>\n                            )}\n                          />\n                        ))}\n                      </div>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* Social Goals */}\n                <FormField\n                  control={form.control}\n                  name=\"socialGoals\"\n                  render={() => (\n                    <FormItem>\n                      <FormLabel>ç¤¾äº¤ç›®æ ‡ *</FormLabel>\n                      <FormDescription>å¯å¤šé€‰</FormDescription>\n                      <div className=\"space-y-2\">\n                        {socialGoalOptions.map((option) => (\n                          <FormField\n                            key={option}\n                            control={form.control}\n                            name=\"socialGoals\"\n                            render={({ field }) => (\n                              <FormItem className=\"flex items-center gap-2 space-y-0\">\n                                <FormControl>\n                                  <Checkbox\n                                    checked={field.value?.includes(option)}\n                                    onCheckedChange={(checked) => {\n                                      return checked\n                                        ? field.onChange([...field.value, option])\n                                        : field.onChange(field.value?.filter((v) => v !== option));\n                                    }}\n                                    data-testid={`checkbox-goal-${option}`}\n                                  />\n                                </FormControl>\n                                <Label className=\"font-normal cursor-pointer\">{option}</Label>\n                              </FormItem>\n                            )}\n                          />\n                        ))}\n                      </div>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* Cuisine Preferences */}\n                <FormField\n                  control={form.control}\n                  name=\"cuisinePreferences\"\n                  render={() => (\n                    <FormItem>\n                      <FormLabel>é¥®é£Ÿåå¥½</FormLabel>\n                      <FormDescription>å¯å¤šé€‰ï¼ˆå¯é€‰ï¼‰</FormDescription>\n                      <div className=\"space-y-2\">\n                        {cuisineOptions.map((option) => (\n                          <FormField\n                            key={option}\n                            control={form.control}\n                            name=\"cuisinePreferences\"\n                            render={({ field }) => (\n                              <FormItem className=\"flex items-center gap-2 space-y-0\">\n                                <FormControl>\n                                  <Checkbox\n                                    checked={field.value?.includes(option)}\n                                    onCheckedChange={(checked) => {\n                                      return checked\n                                        ? field.onChange([...(field.value || []), option])\n                                        : field.onChange(field.value?.filter((v) => v !== option));\n                                    }}\n                                    data-testid={`checkbox-cuisine-${option}`}\n                                  />\n                                </FormControl>\n                                <Label className=\"font-normal cursor-pointer\">{option}</Label>\n                              </FormItem>\n                            )}\n                          />\n                        ))}\n                      </div>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* Dietary Restrictions */}\n                <FormField\n                  control={form.control}\n                  name=\"dietaryRestrictions\"\n                  render={() => (\n                    <FormItem>\n                      <FormLabel>é¥®é£Ÿé™åˆ¶</FormLabel>\n                      <FormDescription>å¯å¤šé€‰ï¼ˆå¯é€‰ï¼‰</FormDescription>\n                      <div className=\"space-y-2\">\n                        {dietaryOptions.map((option) => (\n                          <FormField\n                            key={option}\n                            control={form.control}\n                            name=\"dietaryRestrictions\"\n                            render={({ field }) => (\n                              <FormItem className=\"flex items-center gap-2 space-y-0\">\n                                <FormControl>\n                                  <Checkbox\n                                    checked={field.value?.includes(option)}\n                                    onCheckedChange={(checked) => {\n                                      return checked\n                                        ? field.onChange([...(field.value || []), option])\n                                        : field.onChange(field.value?.filter((v) => v !== option));\n                                    }}\n                                    data-testid={`checkbox-dietary-${option}`}\n                                  />\n                                </FormControl>\n                                <Label className=\"font-normal cursor-pointer\">{option}</Label>\n                              </FormItem>\n                            )}\n                          />\n                        ))}\n                      </div>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* Taste Intensity */}\n                <FormField\n                  control={form.control}\n                  name=\"tasteIntensity\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>å£å‘³åå¥½</FormLabel>\n                      <FormControl>\n                        <RadioGroup\n                          onValueChange={field.onChange}\n                          defaultValue={field.value}\n                          className=\"space-y-2\"\n                        >\n                          <FormItem className=\"flex items-center gap-2 space-y-0\">\n                            <FormControl>\n                              <RadioGroupItem value=\"light\" data-testid=\"radio-taste-light\" />\n                            </FormControl>\n                            <Label className=\"font-normal cursor-pointer\">æ¸…æ·¡</Label>\n                          </FormItem>\n                          <FormItem className=\"flex items-center gap-2 space-y-0\">\n                            <FormControl>\n                              <RadioGroupItem value=\"medium\" data-testid=\"radio-taste-medium\" />\n                            </FormControl>\n                            <Label className=\"font-normal cursor-pointer\">é€‚ä¸­</Label>\n                          </FormItem>\n                          <FormItem className=\"flex items-center gap-2 space-y-0\">\n                            <FormControl>\n                              <RadioGroupItem value=\"strong\" data-testid=\"radio-taste-strong\" />\n                            </FormControl>\n                            <Label className=\"font-normal cursor-pointer\">é‡å£å‘³</Label>\n                          </FormItem>\n                        </RadioGroup>\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <Button\n                  type=\"submit\"\n                  className=\"w-full\"\n                  disabled={registerMutation.isPending}\n                  data-testid=\"button-submit-registration\"\n                >\n                  {registerMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                      æäº¤ä¸­...\n                    </>\n                  ) : (\n                    \"ç¡®è®¤æŠ¥å\"\n                  )}\n                </Button>\n              </form>\n            </Form>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":19973},"client/src/pages/PoolGroupDetailPage.tsx":{"content":"import { useParams, useLocation } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ArrowLeft, Clock, MapPin, Users, Navigation, AlertCircle, Sparkles } from \"lucide-react\";\nimport PostMatchEventCard from \"@/components/PostMatchEventCard\";\nimport IcebreakerTool from \"@/components/IcebreakerTool\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { calculateAge } from \"@shared/utils\";\nimport type { AttendeeData } from \"@/lib/attendeeAnalytics\";\n\ninterface PoolGroupResponse {\n  group: {\n    id: string;\n    groupNumber: number;\n    memberCount: number;\n    matchScore: number | null;\n    matchExplanation: string | null;\n    venueName: string | null;\n    venueAddress: string | null;\n    finalDateTime: string | null;\n    status: string;\n  };\n  pool: {\n    id: string;\n    title: string;\n    description: string | null;\n    eventType: string;\n    city: string;\n    district: string | null;\n    dateTime: string;\n  };\n  members: AttendeeData[];\n}\n\nexport default function PoolGroupDetailPage() {\n  const { groupId } = useParams();\n  const [, setLocation] = useLocation();\n  const { user } = useAuth();\n\n  const { data, isLoading } = useQuery<PoolGroupResponse>({\n    queryKey: [\"/api/pool-groups\", groupId],\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <div className=\"flex items-center justify-center py-12\">\n          <div className=\"text-center space-y-4\">\n            <div className=\"h-8 w-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto\" />\n            <p className=\"text-sm text-muted-foreground\">åŠ è½½ä¸­...</p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!data) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <div className=\"text-center py-12\">\n          <p className=\"text-muted-foreground\">å°ç»„ä¸å­˜åœ¨</p>\n        </div>\n      </div>\n    );\n  }\n\n  const { group, pool, members } = data;\n\n  const formatDateTime = (dateTime: string) => {\n    const date = new Date(dateTime);\n    const month = date.getMonth() + 1;\n    const day = date.getDate();\n    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];\n    const weekday = weekdays[date.getDay()];\n    const hours = date.getHours().toString().padStart(2, '0');\n    const minutes = date.getMinutes().toString().padStart(2, '0');\n    return `${month}æœˆ${day}æ—¥ ${weekday} ${hours}:${minutes}`;\n  };\n\n  const getCountdown = (dateTime: string) => {\n    const now = new Date();\n    const eventDate = new Date(dateTime);\n    const diff = eventDate.getTime() - now.getTime();\n    \n    if (diff <= 0) return \"æ´»åŠ¨è¿›è¡Œä¸­\";\n    \n    const days = Math.floor(diff / (1000 * 60 * 60 * 24));\n    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n    \n    if (days > 0) {\n      return `è¿˜å‰© ${days}å¤© ${hours}å°æ—¶`;\n    } else {\n      return `è¿˜å‰© ${hours}å°æ—¶`;\n    }\n  };\n\n  const handleNavigation = () => {\n    if (group.venueName && group.venueAddress) {\n      const venueName = encodeURIComponent(group.venueName);\n      \n      // æ·±åœ³ä½¿ç”¨é«˜å¾·åœ°å›¾ï¼Œé¦™æ¸¯ä½¿ç”¨Google Maps\n      if (pool.city === 'æ·±åœ³') {\n        window.open(`https://uri.amap.com/marker?name=${venueName}&address=${encodeURIComponent(group.venueAddress)}`, '_blank');\n      } else {\n        window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(group.venueAddress)}`, '_blank');\n      }\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background pb-20\">\n      {/* Header */}\n      <div className=\"sticky top-0 z-40 bg-background/95 backdrop-blur-sm border-b\">\n        <div className=\"flex items-center h-14 px-4\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            onClick={() => setLocation(\"/events\")}\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <h1 className=\"ml-2 font-semibold\">æ´»åŠ¨è¯¦æƒ…</h1>\n        </div>\n      </div>\n\n      <div className=\"px-4 py-4 space-y-4\">\n        {/* é¡¶éƒ¨æ‘˜è¦ */}\n        <Card>\n          <CardContent className=\"p-4 space-y-3\">\n            <div className=\"space-y-1\">\n              <div className=\"flex items-start justify-between gap-3\">\n                <div className=\"flex-1\">\n                  <h2 className=\"text-xl font-bold\">{pool.title}</h2>\n                  <p className=\"text-sm text-muted-foreground mt-1\">{pool.eventType}</p>\n                </div>\n                <Badge className=\"bg-gradient-to-r from-purple-500 to-pink-500\">\n                  <Sparkles className=\"h-3 w-3 mr-1\" />\n                  #{group.groupNumber}ç»„\n                </Badge>\n              </div>\n              <p className=\"text-sm text-muted-foreground\">\n                {formatDateTime(group.finalDateTime || pool.dateTime)}\n              </p>\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Clock className=\"h-4 w-4 text-primary\" />\n                <span className=\"font-medium text-primary\">\n                  {getCountdown(group.finalDateTime || pool.dateTime)}\n                </span>\n              </div>\n            </div>\n\n            <div className=\"flex items-center gap-2 text-sm\">\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"font-medium\">{group.memberCount}äººå°ç»„</span>\n              {group.matchScore && (\n                <Badge variant=\"secondary\" className=\"ml-auto\">\n                  åŒ¹é…åº¦ {group.matchScore}åˆ†\n                </Badge>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* åœ°ç‚¹ä¿¡æ¯ */}\n        {group.venueName && (\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base\">åœ°ç‚¹ä¿¡æ¯</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-2\">\n                  <MapPin className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                  <div className=\"flex-1\">\n                    <p className=\"font-medium\">{group.venueName}</p>\n                    <p className=\"text-sm text-muted-foreground\">{group.venueAddress}</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {pool.city}{pool.district ? `â€¢${pool.district}` : ''}\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              <Button \n                variant=\"outline\" \n                className=\"w-full\"\n                onClick={handleNavigation}\n                data-testid=\"button-navigate\"\n              >\n                <Navigation className=\"h-4 w-4 mr-2\" />\n                åˆ°è¿™å»\n              </Button>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* æ´»åŠ¨æ± æè¿° */}\n        {pool.description && (\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base\">æ´»åŠ¨ä»‹ç»</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <p className=\"text-sm text-muted-foreground\">{pool.description}</p>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Post-Match Event Card: Member Insights & Match Explanation */}\n        {members && members.length > 0 && (\n          <PostMatchEventCard \n            matchedAttendees={members.map(m => ({\n              userId: m.userId,\n              displayName: m.displayName,\n              archetype: m.archetype,\n              topInterests: m.topInterests,\n              industry: m.industry,\n              ageVisible: m.ageVisible,\n              industryVisible: m.industryVisible,\n            }))}\n            matchExplanation={group.matchExplanation || undefined}\n            userInterests={(user?.interestsRankedTop3 as string[] | undefined) || []}\n            userEducationLevel={user?.educationLevel || undefined}\n            userIndustry={user?.industry || undefined}\n            userAge={user?.birthdate ? calculateAge(user.birthdate) : undefined}\n            userGender={user?.gender || undefined}\n            userRelationshipStatus={user?.relationshipStatus || undefined}\n            userChildren={user?.children || undefined}\n            userStudyLocale={user?.studyLocale || undefined}\n            userOverseasRegions={user?.overseasRegions as string[] | undefined}\n            userSeniority={user?.seniority || undefined}\n            userFieldOfStudy={user?.fieldOfStudy || undefined}\n            userLanguages={user?.languagesComfort as string[] | undefined}\n            userHometownCountry={user?.hometownCountry || undefined}\n            userHometownRegionCity={user?.hometownRegionCity || undefined}\n            userHometownAffinityOptin={user?.hometownAffinityOptin ?? undefined}\n          />\n        )}\n\n        {/* ç ´å†°å·¥å…· */}\n        <IcebreakerTool />\n\n        {/* è§„åˆ™ä¸åˆ°åœºæŒ‡å— */}\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-base\">è§„åˆ™ä¸åˆ°åœºæŒ‡å—</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-2 text-sm\">\n            <div className=\"flex items-start gap-2\">\n              <AlertCircle className=\"h-4 w-4 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0\" />\n              <p>è¯·æå‰10åˆ†é’Ÿåˆ°åœº</p>\n            </div>\n            <div className=\"flex items-start gap-2\">\n              <AlertCircle className=\"h-4 w-4 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0\" />\n              <p>å¼€å±€å‰24å°æ—¶å†…ä¸å¯é€€</p>\n            </div>\n            <div className=\"flex items-start gap-2\">\n              <AlertCircle className=\"h-4 w-4 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0\" />\n              <p>è¿Ÿåˆ°/ç¼ºå¸­å°†å½±å“ä¿¡ç”¨åˆ†</p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":10175},"client/src/pages/InvitationLandingPage.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useParams, useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Loader2, MapPin, Calendar, Users, Clock, DollarSign, User } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { zhCN } from \"date-fns/locale\";\n\ninterface InvitationData {\n  inviter: {\n    id: string;\n    displayName: string;\n    firstName: string;\n    lastName: string;\n  };\n  event: {\n    id: string;\n    title: string;\n    poolId: string;\n    dateTime: string;\n    location?: string;\n    budget?: string[];\n    status: string;\n    groupId?: string;\n  };\n  invitationType: 'pre_match' | 'post_match';\n  code: string;\n}\n\nexport default function InvitationLandingPage() {\n  const { code } = useParams<{ code: string }>();\n  const [, setLocation] = useLocation();\n\n  const { data: invitation, isLoading, error } = useQuery<InvitationData>({\n    queryKey: ['/api/invitations', code],\n    enabled: !!code,\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-b from-background to-accent/10\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  if (error || !invitation) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center p-4 bg-gradient-to-b from-background to-accent/10\">\n        <Card className=\"max-w-md w-full\">\n          <CardHeader>\n            <h2 className=\"text-xl font-semibold text-center\">é‚€è¯·å·²å¤±æ•ˆ</h2>\n          </CardHeader>\n          <CardContent className=\"text-center space-y-4\">\n            <p className=\"text-muted-foreground\">\n              {error?.message || \"è¯¥é‚€è¯·é“¾æ¥ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ\"}\n            </p>\n            <Button \n              onClick={() => setLocation(\"/\")}\n              data-testid=\"button-home\"\n            >\n              è¿”å›é¦–é¡µ\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const { inviter, event, invitationType } = invitation;\n  const inviterName = inviter.displayName || `${inviter.firstName} ${inviter.lastName}`;\n\n  const handleAccept = () => {\n    // Store invitation code for registration process\n    localStorage.setItem('invitation_code', code!);\n    \n    if (invitationType === 'pre_match') {\n      // Navigate to event pool registration with pre-filled data\n      setLocation(`/event-pools/${event.poolId}/register?invite=${code}`);\n    } else {\n      // Post-match: direct join to existing group\n      setLocation(`/pool-groups/${event.groupId}/join?invite=${code}`);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-background to-accent/10 p-4\">\n      <div className=\"max-w-2xl mx-auto pt-8 space-y-6\">\n        {/* Hero Section */}\n        <div className=\"text-center space-y-3\">\n          <div className=\"flex items-center justify-center gap-2\">\n            <User className=\"h-6 w-6 text-primary\" />\n            <h1 className=\"text-2xl font-bold\">\n              {inviterName} é‚€è¯·ä½ åŠ å…¥\n            </h1>\n          </div>\n          <p className=\"text-muted-foreground\">\n            {invitationType === 'pre_match' \n              ? 'ä¸€èµ·æŠ¥åå‚åŠ ç›²ç›’æ´»åŠ¨ï¼Œä¼˜å…ˆåŒ¹é…åˆ°åŒä¸€å±€'\n              : 'ç›´æ¥åŠ å…¥å·²åŒ¹é…çš„æ´»åŠ¨å°ç»„'}\n          </p>\n        </div>\n\n        {/* Event Details Card */}\n        <Card>\n          <CardHeader className=\"space-y-2\">\n            <div className=\"flex items-start justify-between gap-2\">\n              <h2 className=\"text-xl font-semibold\">{event.title}</h2>\n              <Badge variant={event.status === 'matched' ? 'default' : 'secondary'}>\n                {event.status === 'matched' ? 'å·²åŒ¹é…' : 'ç­‰å¾…åŒ¹é…'}\n              </Badge>\n            </div>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {/* Time & Location */}\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center gap-3 text-sm\">\n                <Calendar className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                <span>\n                  {format(new Date(event.dateTime), 'yyyyå¹´MMæœˆddæ—¥ EEEE', { locale: zhCN })}\n                </span>\n              </div>\n              <div className=\"flex items-center gap-3 text-sm\">\n                <Clock className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                <span>\n                  {format(new Date(event.dateTime), 'HH:mm')}\n                </span>\n              </div>\n              {event.location && (\n                <div className=\"flex items-center gap-3 text-sm\">\n                  <MapPin className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                  <span>{event.location}</span>\n                </div>\n              )}\n              {event.budget && event.budget.length > 0 && (\n                <div className=\"flex items-center gap-3 text-sm\">\n                  <DollarSign className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                  <div className=\"flex flex-wrap gap-1\">\n                    {event.budget.map((range) => (\n                      <Badge key={range} variant=\"outline\" className=\"text-xs\">\n                        {range}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n            </div>\n\n            {/* Invitation Type Info */}\n            <div className=\"bg-accent/30 rounded-lg p-4\">\n              {invitationType === 'pre_match' ? (\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Users className=\"h-4 w-4 text-primary\" />\n                    <span className=\"font-medium text-sm\">ä¼˜å…ˆåŒ¹é…</span>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    æ¥å—é‚€è¯·åï¼Œç³»ç»Ÿä¼šä¼˜å…ˆå°†ä½ å’Œ {inviterName} åŒ¹é…åˆ°åŒä¸€æ´»åŠ¨å°ç»„\n                  </p>\n                </div>\n              ) : (\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Users className=\"h-4 w-4 text-primary\" />\n                    <span className=\"font-medium text-sm\">ç›´æ¥åŠ å…¥</span>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    æ¥å—é‚€è¯·åï¼Œä½ å°†ç›´æ¥åŠ å…¥ {inviterName} æ‰€åœ¨çš„æ´»åŠ¨å°ç»„\n                  </p>\n                </div>\n              )}\n            </div>\n\n            {/* Action Button */}\n            <Button \n              className=\"w-full\"\n              size=\"lg\"\n              onClick={handleAccept}\n              data-testid=\"button-accept-invite\"\n            >\n              æ¥å—é‚€è¯·\n            </Button>\n          </CardContent>\n        </Card>\n\n        {/* Info Footer */}\n        <div className=\"text-center text-xs text-muted-foreground space-y-1\">\n          <p>é€šè¿‡é‚€è¯·é“¾æ¥åŠ å…¥ï¼Œè®©è®¤è¯†çš„äººä¸€èµ·å‚åŠ æ´»åŠ¨</p>\n          <p>é‚€è¯·æˆåŠŸåï¼Œé‚€è¯·äººå°†è·å¾—ä¼˜æƒ åˆ¸å¥–åŠ±</p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":7249},"server/poolRealtimeMatchingService.ts":{"content":"/**\n * Pool Real-time Matching Service (æ± å†…å®æ—¶åŒ¹é…è°ƒåº¦æœåŠ¡)\n * \n * æ ¸å¿ƒåŠŸèƒ½ï¼š\n * 1. å®æ—¶æ‰«æï¼šæ¯æ¬¡æœ‰ç”¨æˆ·æŠ¥åæ—¶è§¦å‘æ‰«æ\n * 2. åŠ¨æ€é˜ˆå€¼ï¼šæ ¹æ®é…ç½®å’Œæ—¶é—´è¡°å‡è°ƒæ•´åŒ¹é…æ ‡å‡†\n * 3. æ™ºèƒ½å†³ç­–ï¼šé«˜å…¼å®¹ç«‹å³åŒ¹é…ï¼Œä¸­ç­‰å…¼å®¹ç­‰å¾…ï¼Œä½å…¼å®¹ç»§ç»­ç­‰\n * 4. å®Œæ•´æ—¥å¿—ï¼šè®°å½•æ¯æ¬¡æ‰«æçš„å†³ç­–è¿‡ç¨‹\n */\n\nimport { db } from \"./db\";\nimport { \n  eventPools,\n  eventPoolRegistrations,\n  matchingThresholds,\n  poolMatchingLogs,\n} from \"@shared/schema\";\nimport { eq, and } from \"drizzle-orm\";\nimport { matchEventPool, saveMatchResults } from \"./poolMatchingService\";\nimport type { MatchGroup } from \"./poolMatchingService\";\n\ninterface ScanResult {\n  decision: \"matched\" | \"waiting\" | \"insufficient\";\n  reason: string;\n  groupsFormed: number;\n  usersMatched: number;\n  avgGroupScore: number;\n  currentThreshold: number;\n}\n\n/**\n * è·å–å½“å‰æ¿€æ´»çš„åŒ¹é…é˜ˆå€¼é…ç½®\n */\nasync function getActiveThresholds() {\n  const [config] = await db\n    .select()\n    .from(matchingThresholds)\n    .where(eq(matchingThresholds.isActive, true))\n    .limit(1);\n\n  // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œè¿”å›é»˜è®¤å€¼\n  if (!config) {\n    return {\n      highCompatibilityThreshold: 82,\n      mediumCompatibilityThreshold: 67,\n      lowCompatibilityThreshold: 52,\n      timeDecayEnabled: true,\n      timeDecayRate: 5,\n      minThresholdAfterDecay: 50,\n      minGroupSizeForMatch: 4,\n      optimalGroupSize: 6,\n    };\n  }\n\n  return config;\n}\n\n/**\n * è®¡ç®—æ—¶é—´è¡°å‡åçš„å®é™…é˜ˆå€¼\n * \n * é€»è¾‘ï¼š\n * - è·ç¦»æ´»åŠ¨å¼€å§‹è¶Šè¿‘ï¼Œé˜ˆå€¼è¶Šä½ï¼ˆæ›´å®¹æ˜“åŒ¹é…ï¼‰\n * - æ¯24å°æ—¶é™ä½ timeDecayRate åˆ†\n * - æœ€ä½ä¸ä½äº minThresholdAfterDecay\n */\nfunction calculateDecayedThreshold(\n  baseThreshold: number,\n  hoursUntilEvent: number,\n  config: Awaited<ReturnType<typeof getActiveThresholds>>\n): number {\n  if (!config.timeDecayEnabled) {\n    return baseThreshold;\n  }\n\n  const daysUntilEvent = hoursUntilEvent / 24;\n  const decay = Math.floor(daysUntilEvent) * (config.timeDecayRate || 5);\n  const decayedThreshold = Math.max(\n    baseThreshold - decay,\n    config.minThresholdAfterDecay || 50\n  );\n\n  return decayedThreshold;\n}\n\n/**\n * è¯„ä¼°ä¸€ç»„åŒ¹é…ç»“æœæ˜¯å¦è¾¾åˆ°é˜ˆå€¼æ ‡å‡†\n */\nfunction evaluateMatchQuality(\n  groups: MatchGroup[],\n  currentThreshold: number,\n  config: Awaited<ReturnType<typeof getActiveThresholds>>\n): { shouldMatch: boolean; reason: string } {\n  if (groups.length === 0) {\n    return { shouldMatch: false, reason: \"æ— æ³•å½¢æˆä»»ä½•å°ç»„\" };\n  }\n\n  // è®¡ç®—æ‰€æœ‰ç»„çš„å¹³å‡åˆ†æ•°\n  const avgScore = Math.round(\n    groups.reduce((sum, g) => sum + g.overallScore, 0) / groups.length\n  );\n\n  // é«˜å…¼å®¹æ€§ï¼šç«‹å³åŒ¹é…\n  if (avgScore >= (config.highCompatibilityThreshold || 85)) {\n    return {\n      shouldMatch: true,\n      reason: `é«˜å…¼å®¹æ€§åŒ¹é…ï¼ˆå¹³å‡åˆ†${avgScore}â‰¥${config.highCompatibilityThreshold}ï¼‰ï¼Œç«‹å³æˆå±€`,\n    };\n  }\n\n  // ä¸­ç­‰å…¼å®¹æ€§ï¼šæ ¹æ®è¡°å‡é˜ˆå€¼å†³å®š\n  if (avgScore >= currentThreshold) {\n    return {\n      shouldMatch: true,\n      reason: `è¾¾åˆ°å½“å‰é˜ˆå€¼ï¼ˆå¹³å‡åˆ†${avgScore}â‰¥${currentThreshold}ï¼‰ï¼Œå¯ä»¥æˆå±€`,\n    };\n  }\n\n  // ä½å…¼å®¹æ€§ï¼šç»§ç»­ç­‰å¾…\n  return {\n    shouldMatch: false,\n    reason: `å…¼å®¹æ€§æœªè¾¾æ ‡ï¼ˆå¹³å‡åˆ†${avgScore}<${currentThreshold}ï¼‰ï¼Œç­‰å¾…æ›´å¤šç”¨æˆ·æˆ–æ—¶é—´è¡°å‡`,\n  };\n}\n\n/**\n * æ‰«æå•ä¸ªæ´»åŠ¨æ± å¹¶å†³ç­–æ˜¯å¦åŒ¹é…\n * \n * @param poolId æ´»åŠ¨æ± ID\n * @param scanType æ‰«æç±»å‹ï¼šrealtime | scheduled | manual\n * @param triggeredBy è§¦å‘è€…ï¼šuser_registration | cron_job | admin_manual\n */\nexport async function scanPoolAndMatch(\n  poolId: string,\n  scanType: \"realtime\" | \"scheduled\" | \"manual\",\n  triggeredBy: string\n): Promise<ScanResult> {\n  // 1. è·å–æ´»åŠ¨æ± ä¿¡æ¯\n  const pool = await db.query.eventPools.findFirst({\n    where: eq(eventPools.id, poolId),\n  });\n\n  if (!pool || pool.status !== \"active\") {\n    return {\n      decision: \"insufficient\",\n      reason: \"æ´»åŠ¨æ± ä¸å­˜åœ¨æˆ–çŠ¶æ€ä¸æ˜¯active\",\n      groupsFormed: 0,\n      usersMatched: 0,\n      avgGroupScore: 0,\n      currentThreshold: 0,\n    };\n  }\n\n  // 2. ç»Ÿè®¡å¾…åŒ¹é…ç”¨æˆ·æ•°\n  const pendingRegistrations = await db\n    .select()\n    .from(eventPoolRegistrations)\n    .where(\n      and(\n        eq(eventPoolRegistrations.poolId, poolId),\n        eq(eventPoolRegistrations.matchStatus, \"pending\")\n      )\n    );\n\n  const pendingUsersCount = pendingRegistrations.length;\n\n  // 3. è·å–å½“å‰åŒ¹é…é…ç½®\n  const config = await getActiveThresholds();\n\n  // 4. è®¡ç®—è·ç¦»æ´»åŠ¨å¼€å§‹çš„å°æ—¶æ•°\n  const now = new Date();\n  const eventTime = new Date(pool.dateTime);\n  const hoursUntilEvent = Math.max(\n    0,\n    Math.floor((eventTime.getTime() - now.getTime()) / (1000 * 60 * 60))\n  );\n\n  // 5. è®¡ç®—å½“å‰é˜ˆå€¼ï¼ˆè€ƒè™‘æ—¶é—´è¡°å‡ï¼‰\n  const currentThreshold = calculateDecayedThreshold(\n    config.mediumCompatibilityThreshold || 70,\n    hoursUntilEvent,\n    config\n  );\n\n  // 6. æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„äººæ•°\n  const minGroupSize = config.minGroupSizeForMatch || pool.minGroupSize || 4;\n  if (pendingUsersCount < minGroupSize) {\n    // è®°å½•æ—¥å¿—\n    await db.insert(poolMatchingLogs).values({\n      poolId,\n      scanType,\n      pendingUsersCount,\n      currentThreshold,\n      timeUntilEvent: hoursUntilEvent,\n      groupsFormed: 0,\n      usersMatched: 0,\n      avgGroupScore: 0,\n      decision: \"insufficient\",\n      reason: `äººæ•°ä¸è¶³ï¼ˆ${pendingUsersCount}/${minGroupSize}ï¼‰`,\n      triggeredBy,\n    });\n\n    return {\n      decision: \"insufficient\",\n      reason: `äººæ•°ä¸è¶³ï¼ˆ${pendingUsersCount}/${minGroupSize}ï¼‰`,\n      groupsFormed: 0,\n      usersMatched: 0,\n      avgGroupScore: 0,\n      currentThreshold,\n    };\n  }\n\n  // 7. è¿è¡ŒåŒ¹é…ç®—æ³•ï¼ˆä¸ä¿å­˜ï¼Œä»…è¯„ä¼°ï¼‰\n  let groups: MatchGroup[] = [];\n  try {\n    groups = await matchEventPool(poolId);\n  } catch (error: any) {\n    await db.insert(poolMatchingLogs).values({\n      poolId,\n      scanType,\n      pendingUsersCount,\n      currentThreshold,\n      timeUntilEvent: hoursUntilEvent,\n      groupsFormed: 0,\n      usersMatched: 0,\n      avgGroupScore: 0,\n      decision: \"insufficient\",\n      reason: `åŒ¹é…ç®—æ³•å¤±è´¥: ${error.message}`,\n      triggeredBy,\n    });\n\n    return {\n      decision: \"insufficient\",\n      reason: `åŒ¹é…ç®—æ³•å¤±è´¥: ${error.message}`,\n      groupsFormed: 0,\n      usersMatched: 0,\n      avgGroupScore: 0,\n      currentThreshold,\n    };\n  }\n\n  // 8. è¯„ä¼°åŒ¹é…è´¨é‡\n  const evaluation = evaluateMatchQuality(groups, currentThreshold, config);\n\n  const avgGroupScore = groups.length > 0\n    ? Math.round(groups.reduce((sum, g) => sum + g.overallScore, 0) / groups.length)\n    : 0;\n\n  // 9. å†³ç­–ï¼šæ˜¯å¦ç«‹å³åŒ¹é…\n  if (evaluation.shouldMatch) {\n    // ç«‹å³åŒ¹é…ï¼ä¿å­˜ç»“æœ\n    await saveMatchResults(poolId, groups);\n\n    const usersMatched = groups.reduce((sum, g) => sum + g.members.length, 0);\n\n    // è®°å½•æ—¥å¿—\n    await db.insert(poolMatchingLogs).values({\n      poolId,\n      scanType,\n      pendingUsersCount,\n      currentThreshold,\n      timeUntilEvent: hoursUntilEvent,\n      groupsFormed: groups.length,\n      usersMatched,\n      avgGroupScore,\n      decision: \"matched\",\n      reason: evaluation.reason,\n      triggeredBy,\n    });\n\n    console.log(`[Realtime Matching] âœ“ æ±  ${pool.title} å®ŒæˆåŒ¹é…: ${groups.length}ç»„, ${usersMatched}äºº`);\n\n    return {\n      decision: \"matched\",\n      reason: evaluation.reason,\n      groupsFormed: groups.length,\n      usersMatched,\n      avgGroupScore,\n      currentThreshold,\n    };\n  } else {\n    // ç»§ç»­ç­‰å¾…\n    await db.insert(poolMatchingLogs).values({\n      poolId,\n      scanType,\n      pendingUsersCount,\n      currentThreshold,\n      timeUntilEvent: hoursUntilEvent,\n      groupsFormed: 0,\n      usersMatched: 0,\n      avgGroupScore,\n      decision: \"waiting\",\n      reason: evaluation.reason,\n      triggeredBy,\n    });\n\n    console.log(`[Realtime Matching] â³ æ±  ${pool.title} ç»§ç»­ç­‰å¾…: ${evaluation.reason}`);\n\n    return {\n      decision: \"waiting\",\n      reason: evaluation.reason,\n      groupsFormed: 0,\n      usersMatched: 0,\n      avgGroupScore,\n      currentThreshold,\n    };\n  }\n}\n\n/**\n * æ‰«ææ‰€æœ‰ active çŠ¶æ€çš„æ´»åŠ¨æ± ï¼ˆå®šæ—¶ä»»åŠ¡è°ƒç”¨ï¼‰\n */\nexport async function scanAllActivePools(): Promise<void> {\n  const activePools = await db\n    .select()\n    .from(eventPools)\n    .where(eq(eventPools.status, \"active\"));\n\n  console.log(`[Scheduled Scan] å¼€å§‹æ‰«æ ${activePools.length} ä¸ªæ´»åŠ¨æ± `);\n\n  for (const pool of activePools) {\n    try {\n      await scanPoolAndMatch(pool.id, \"scheduled\", \"cron_job\");\n    } catch (error: any) {\n      console.error(`[Scheduled Scan] æ±  ${pool.id} æ‰«æå¤±è´¥:`, error.message);\n    }\n  }\n\n  console.log(`[Scheduled Scan] æ‰«æå®Œæˆ`);\n}\n","size_bytes":8798},"client/src/pages/admin/AdminMatchingConfigPage.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, Save, RefreshCw } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\ninterface MatchingThresholds {\n  id?: string;\n  highCompatibilityThreshold: number;\n  mediumCompatibilityThreshold: number;\n  lowCompatibilityThreshold: number;\n  timeDecayEnabled: boolean;\n  timeDecayRate: number;\n  minThresholdAfterDecay: number;\n  minGroupSizeForMatch: number;\n  optimalGroupSize: number;\n  scanIntervalMinutes: number;\n  notes?: string;\n}\n\nexport default function AdminMatchingConfigPage() {\n  const { toast } = useToast();\n  const [formData, setFormData] = useState<MatchingThresholds>({\n    highCompatibilityThreshold: 85,\n    mediumCompatibilityThreshold: 70,\n    lowCompatibilityThreshold: 55,\n    timeDecayEnabled: true,\n    timeDecayRate: 5,\n    minThresholdAfterDecay: 50,\n    minGroupSizeForMatch: 4,\n    optimalGroupSize: 6,\n    scanIntervalMinutes: 60,\n    notes: \"\",\n  });\n\n  // Fetch current config\n  const { data: config, isLoading } = useQuery<MatchingThresholds>({\n    queryKey: [\"/api/admin/matching-thresholds\"],\n  });\n\n  useEffect(() => {\n    if (config) {\n      setFormData(config);\n    }\n  }, [config]);\n\n  // Update config mutation\n  const updateConfigMutation = useMutation({\n    mutationFn: async (data: MatchingThresholds) => {\n      return apiRequest(\"/api/admin/matching-thresholds\", \"PUT\", data);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"é…ç½®å·²æ›´æ–°\",\n        description: \"åŒ¹é…é˜ˆå€¼é…ç½®å·²æˆåŠŸä¿å­˜\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/admin/matching-thresholds\"] });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"æ›´æ–°å¤±è´¥\",\n        description: error.message || \"æ— æ³•ä¿å­˜é…ç½®\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    updateConfigMutation.mutate(formData);\n  };\n\n  const handleReset = () => {\n    if (config) {\n      setFormData(config);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-full\">\n        <Loader2 className=\"h-8 w-8 animate-spin\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\">å®æ—¶åŒ¹é…é…ç½®</h1>\n        <p className=\"text-muted-foreground\">\n          è°ƒæ•´åŒ¹é…é˜ˆå€¼å’Œæ—¶é—´è¡°å‡å‚æ•°ï¼Œä¼˜åŒ–ç›²ç›’æ´»åŠ¨çš„åŒ¹é…æ•ˆæœ\n        </p>\n      </div>\n\n      <form onSubmit={handleSubmit}>\n        <div className=\"grid gap-6\">\n          {/* Compatibility Thresholds */}\n          <Card data-testid=\"card-compatibility-thresholds\">\n            <CardHeader>\n              <CardTitle>å…¼å®¹æ€§é˜ˆå€¼</CardTitle>\n              <CardDescription>\n                è®¾ç½®ä¸åŒå…¼å®¹æ€§çº§åˆ«çš„åˆ†æ•°é—¨æ§›ï¼ˆ0-100åˆ†ï¼‰\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"highThreshold\">\n                  é«˜å…¼å®¹æ€§é˜ˆå€¼ï¼ˆç«‹å³åŒ¹é…ï¼‰\n                </Label>\n                <Input\n                  id=\"highThreshold\"\n                  type=\"number\"\n                  min=\"0\"\n                  max=\"100\"\n                  value={formData.highCompatibilityThreshold}\n                  onChange={(e) =>\n                    setFormData({\n                      ...formData,\n                      highCompatibilityThreshold: parseInt(e.target.value),\n                    })\n                  }\n                  data-testid=\"input-high-threshold\"\n                />\n                <p className=\"text-sm text-muted-foreground\">\n                  å½“ç»„å±€å¹³å‡åˆ† â‰¥ æ­¤å€¼æ—¶ï¼Œç«‹å³å®ŒæˆåŒ¹é…ï¼ˆæ¨èï¼š85åˆ†ï¼‰\n                </p>\n              </div>\n\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"mediumThreshold\">\n                  ä¸­ç­‰å…¼å®¹æ€§é˜ˆå€¼ï¼ˆåŸºå‡†çº¿ï¼‰\n                </Label>\n                <Input\n                  id=\"mediumThreshold\"\n                  type=\"number\"\n                  min=\"0\"\n                  max=\"100\"\n                  value={formData.mediumCompatibilityThreshold}\n                  onChange={(e) =>\n                    setFormData({\n                      ...formData,\n                      mediumCompatibilityThreshold: parseInt(e.target.value),\n                    })\n                  }\n                  data-testid=\"input-medium-threshold\"\n                />\n                <p className=\"text-sm text-muted-foreground\">\n                  æ—¶é—´è¡°å‡çš„èµ·å§‹é˜ˆå€¼ï¼ˆæ¨èï¼š70åˆ†ï¼‰\n                </p>\n              </div>\n\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"lowThreshold\">\n                  ä½å…¼å®¹æ€§é˜ˆå€¼ï¼ˆå‚è€ƒçº¿ï¼‰\n                </Label>\n                <Input\n                  id=\"lowThreshold\"\n                  type=\"number\"\n                  min=\"0\"\n                  max=\"100\"\n                  value={formData.lowCompatibilityThreshold}\n                  onChange={(e) =>\n                    setFormData({\n                      ...formData,\n                      lowCompatibilityThreshold: parseInt(e.target.value),\n                    })\n                  }\n                  data-testid=\"input-low-threshold\"\n                />\n                <p className=\"text-sm text-muted-foreground\">\n                  æœ€ä½å¯æ¥å—çš„åŒ¹é…è´¨é‡ï¼ˆæ¨èï¼š55åˆ†ï¼‰\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Time Decay Settings */}\n          <Card data-testid=\"card-time-decay\">\n            <CardHeader>\n              <CardTitle>æ—¶é—´è¡°å‡æœºåˆ¶</CardTitle>\n              <CardDescription>\n                éšç€æ´»åŠ¨ä¸´è¿‘ï¼Œé€æ­¥é™ä½åŒ¹é…æ ‡å‡†ä»¥æé«˜æˆå±€ç‡\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"space-y-0.5\">\n                  <Label htmlFor=\"timeDecay\">å¯ç”¨æ—¶é—´è¡°å‡</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    è·ç¦»æ´»åŠ¨è¶Šè¿‘ï¼Œé˜ˆå€¼è¶Šä½\n                  </p>\n                </div>\n                <Switch\n                  id=\"timeDecay\"\n                  checked={formData.timeDecayEnabled}\n                  onCheckedChange={(checked) =>\n                    setFormData({ ...formData, timeDecayEnabled: checked })\n                  }\n                  data-testid=\"switch-time-decay\"\n                />\n              </div>\n\n              {formData.timeDecayEnabled && (\n                <>\n                  <div className=\"grid gap-2\">\n                    <Label htmlFor=\"decayRate\">\n                      è¡°å‡é€Ÿç‡ï¼ˆåˆ†/å¤©ï¼‰\n                    </Label>\n                    <Input\n                      id=\"decayRate\"\n                      type=\"number\"\n                      min=\"0\"\n                      max=\"20\"\n                      value={formData.timeDecayRate}\n                      onChange={(e) =>\n                        setFormData({\n                          ...formData,\n                          timeDecayRate: parseInt(e.target.value),\n                        })\n                      }\n                      data-testid=\"input-decay-rate\"\n                    />\n                    <p className=\"text-sm text-muted-foreground\">\n                      æ¯è¿‡24å°æ—¶ï¼Œé˜ˆå€¼é™ä½å¤šå°‘åˆ†ï¼ˆæ¨èï¼š5åˆ†/å¤©ï¼‰\n                    </p>\n                  </div>\n\n                  <div className=\"grid gap-2\">\n                    <Label htmlFor=\"minThreshold\">\n                      è¡°å‡åæœ€ä½é˜ˆå€¼\n                    </Label>\n                    <Input\n                      id=\"minThreshold\"\n                      type=\"number\"\n                      min=\"0\"\n                      max=\"100\"\n                      value={formData.minThresholdAfterDecay}\n                      onChange={(e) =>\n                        setFormData({\n                          ...formData,\n                          minThresholdAfterDecay: parseInt(e.target.value),\n                        })\n                      }\n                      data-testid=\"input-min-threshold\"\n                    />\n                    <p className=\"text-sm text-muted-foreground\">\n                      æ— è®ºè·ç¦»æ´»åŠ¨å¤šè¿‘ï¼Œé˜ˆå€¼ä¸ä¼šä½äºæ­¤å€¼ï¼ˆæ¨èï¼š50åˆ†ï¼‰\n                    </p>\n                  </div>\n                </>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Group Size Settings */}\n          <Card data-testid=\"card-group-size\">\n            <CardHeader>\n              <CardTitle>ç»„å±€é…ç½®</CardTitle>\n              <CardDescription>\n                è®¾ç½®å°ç»„æˆå±€çš„äººæ•°è¦æ±‚\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"minGroupSize\">\n                  æœ€å°æˆå±€äººæ•°\n                </Label>\n                <Input\n                  id=\"minGroupSize\"\n                  type=\"number\"\n                  min=\"2\"\n                  max=\"10\"\n                  value={formData.minGroupSizeForMatch}\n                  onChange={(e) =>\n                    setFormData({\n                      ...formData,\n                      minGroupSizeForMatch: parseInt(e.target.value),\n                    })\n                  }\n                  data-testid=\"input-min-group-size\"\n                />\n              </div>\n\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"optimalGroupSize\">\n                  æœ€ä¼˜ç»„å±€äººæ•°\n                </Label>\n                <Input\n                  id=\"optimalGroupSize\"\n                  type=\"number\"\n                  min=\"2\"\n                  max=\"12\"\n                  value={formData.optimalGroupSize}\n                  onChange={(e) =>\n                    setFormData({\n                      ...formData,\n                      optimalGroupSize: parseInt(e.target.value),\n                    })\n                  }\n                  data-testid=\"input-optimal-group-size\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Scan Interval */}\n          <Card data-testid=\"card-scan-interval\">\n            <CardHeader>\n              <CardTitle>æ‰«æé¢‘ç‡</CardTitle>\n              <CardDescription>\n                å®šæ—¶ä»»åŠ¡æ‰«ææ‰€æœ‰æ´»åŠ¨æ± çš„é—´éš”ï¼ˆåˆ†é’Ÿï¼‰\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"scanInterval\">\n                  æ‰«æé—´éš”ï¼ˆåˆ†é’Ÿï¼‰\n                </Label>\n                <Input\n                  id=\"scanInterval\"\n                  type=\"number\"\n                  min=\"1\"\n                  max=\"1440\"\n                  value={formData.scanIntervalMinutes}\n                  onChange={(e) =>\n                    setFormData({\n                      ...formData,\n                      scanIntervalMinutes: parseInt(e.target.value),\n                    })\n                  }\n                  data-testid=\"input-scan-interval\"\n                />\n                <p className=\"text-sm text-muted-foreground\">\n                  å½“å‰è®¾ç½®ï¼šæ¯ {formData.scanIntervalMinutes} åˆ†é’Ÿæ‰«æä¸€æ¬¡\n                  ï¼ˆæ³¨æ„ï¼šä¿®æ”¹åéœ€è¦é‡å¯æœåŠ¡å™¨ç”Ÿæ•ˆï¼‰\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Notes */}\n          <Card data-testid=\"card-notes\">\n            <CardHeader>\n              <CardTitle>å¤‡æ³¨</CardTitle>\n              <CardDescription>\n                è®°å½•æœ¬æ¬¡é…ç½®è°ƒæ•´çš„åŸå› æˆ–è¯´æ˜\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Textarea\n                placeholder=\"ä¾‹å¦‚ï¼šæ ¹æ®å‰100ä¸ªç”¨æˆ·çš„åŒ¹é…æ•°æ®ï¼Œå°†é«˜å…¼å®¹é˜ˆå€¼ä»80æå‡åˆ°85\"\n                value={formData.notes || \"\"}\n                onChange={(e) =>\n                  setFormData({ ...formData, notes: e.target.value })\n                }\n                data-testid=\"textarea-notes\"\n              />\n            </CardContent>\n          </Card>\n\n          {/* Action Buttons */}\n          <div className=\"flex justify-end gap-2\">\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={handleReset}\n              disabled={updateConfigMutation.isPending}\n              data-testid=\"button-reset\"\n            >\n              <RefreshCw className=\"h-4 w-4 mr-2\" />\n              é‡ç½®\n            </Button>\n            <Button\n              type=\"submit\"\n              disabled={updateConfigMutation.isPending}\n              data-testid=\"button-save\"\n            >\n              {updateConfigMutation.isPending ? (\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              ) : (\n                <Save className=\"h-4 w-4 mr-2\" />\n              )}\n              ä¿å­˜é…ç½®\n            </Button>\n          </div>\n        </div>\n      </form>\n    </div>\n  );\n}\n","size_bytes":13719},"client/src/pages/admin/AdminMatchingLogsPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Loader2, Clock, Users, TrendingUp, AlertCircle, CheckCircle, HourglassIcon } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { zhCN } from \"date-fns/locale\";\n\n// æ¸©åº¦ç­‰çº§emojiè¾…åŠ©å‡½æ•°\nfunction getTemperatureEmoji(score: number): string {\n  if (score >= 85) return \"ğŸ”¥\"; // ç‚½çƒ­\n  if (score >= 70) return \"ğŸŒ¡ï¸\"; // æ¸©æš–\n  if (score >= 55) return \"ğŸŒ¤ï¸\"; // é€‚å®œ\n  return \"â„ï¸\"; // å†·æ·¡\n}\n\ninterface MatchingLog {\n  id: string;\n  poolId: string;\n  poolTitle: string;\n  scanType: \"realtime\" | \"scheduled\" | \"manual\";\n  pendingUsersCount: number;\n  currentThreshold: number;\n  timeUntilEvent: number;\n  groupsFormed: number;\n  usersMatched: number;\n  avgGroupScore: number | null;\n  decision: \"matched\" | \"waiting\" | \"insufficient\";\n  reason: string;\n  triggeredBy: string;\n  createdAt: string;\n}\n\nconst SCAN_TYPE_MAP: Record<string, { label: string; variant: any }> = {\n  realtime: { label: \"å®æ—¶è§¦å‘\", variant: \"default\" },\n  scheduled: { label: \"å®šæ—¶æ‰«æ\", variant: \"secondary\" },\n  manual: { label: \"æ‰‹åŠ¨è§¦å‘\", variant: \"outline\" },\n};\n\nconst DECISION_MAP: Record<string, { label: string; variant: any; icon: any }> = {\n  matched: { label: \"å·²åŒ¹é…\", variant: \"default\", icon: CheckCircle },\n  waiting: { label: \"ç»§ç»­ç­‰å¾…\", variant: \"secondary\", icon: HourglassIcon },\n  insufficient: { label: \"äººæ•°ä¸è¶³\", variant: \"destructive\", icon: AlertCircle },\n};\n\nexport default function AdminMatchingLogsPage() {\n  const [scanTypeFilter, setScanTypeFilter] = useState<string>(\"all\");\n  const [decisionFilter, setDecisionFilter] = useState<string>(\"all\");\n\n  const { data: logs, isLoading } = useQuery<MatchingLog[]>({\n    queryKey: [\"/api/admin/matching-logs\", { scanType: scanTypeFilter !== \"all\" ? scanTypeFilter : undefined, decision: decisionFilter !== \"all\" ? decisionFilter : undefined }],\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-full\">\n        <Loader2 className=\"h-8 w-8 animate-spin\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\">åŒ¹é…æ‰«ææ—¥å¿—</h1>\n        <p className=\"text-muted-foreground\">\n          æŸ¥çœ‹æ¯æ¬¡æ‰«æçš„å†³ç­–è¿‡ç¨‹å’ŒåŒ¹é…ç»“æœ\n        </p>\n      </div>\n\n      {/* Filters */}\n      <div className=\"flex gap-4\">\n        <div className=\"w-[200px]\">\n          <Select value={scanTypeFilter} onValueChange={setScanTypeFilter}>\n            <SelectTrigger data-testid=\"select-scan-type\">\n              <SelectValue placeholder=\"æ‰«æç±»å‹\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">æ‰€æœ‰ç±»å‹</SelectItem>\n              <SelectItem value=\"realtime\">å®æ—¶è§¦å‘</SelectItem>\n              <SelectItem value=\"scheduled\">å®šæ—¶æ‰«æ</SelectItem>\n              <SelectItem value=\"manual\">æ‰‹åŠ¨è§¦å‘</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n\n        <div className=\"w-[200px]\">\n          <Select value={decisionFilter} onValueChange={setDecisionFilter}>\n            <SelectTrigger data-testid=\"select-decision\">\n              <SelectValue placeholder=\"å†³ç­–ç»“æœ\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">æ‰€æœ‰ç»“æœ</SelectItem>\n              <SelectItem value=\"matched\">å·²åŒ¹é…</SelectItem>\n              <SelectItem value=\"waiting\">ç»§ç»­ç­‰å¾…</SelectItem>\n              <SelectItem value=\"insufficient\">äººæ•°ä¸è¶³</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      {/* Logs List */}\n      <div className=\"space-y-4\">\n        {logs && logs.length === 0 ? (\n          <Card>\n            <CardContent className=\"py-8 text-center text-muted-foreground\">\n              æš‚æ— æ‰«ææ—¥å¿—\n            </CardContent>\n          </Card>\n        ) : (\n          logs?.map((log) => {\n            const DecisionIcon = DECISION_MAP[log.decision]?.icon || AlertCircle;\n            \n            return (\n              <Card key={log.id} data-testid={`log-card-${log.id}`}>\n                <CardHeader>\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"space-y-1\">\n                      <CardTitle className=\"text-lg\">{log.poolTitle}</CardTitle>\n                      <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <Clock className=\"h-4 w-4\" />\n                        <span>\n                          {format(new Date(log.createdAt), \"PPP HH:mm:ss\", { locale: zhCN })}\n                        </span>\n                        <Badge variant={SCAN_TYPE_MAP[log.scanType]?.variant || \"secondary\"}>\n                          {SCAN_TYPE_MAP[log.scanType]?.label || log.scanType}\n                        </Badge>\n                      </div>\n                    </div>\n                    <Badge\n                      variant={DECISION_MAP[log.decision]?.variant || \"secondary\"}\n                      className=\"flex items-center gap-1\"\n                    >\n                      <DecisionIcon className=\"h-3 w-3\" />\n                      {DECISION_MAP[log.decision]?.label || log.decision}\n                    </Badge>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  {/* Metrics */}\n                  <div className=\"grid grid-cols-4 gap-4 text-sm\">\n                    <div className=\"space-y-1\">\n                      <div className=\"text-muted-foreground\">å¾…åŒ¹é…ç”¨æˆ·</div>\n                      <div className=\"text-2xl font-bold flex items-center gap-1\">\n                        <Users className=\"h-4 w-4\" />\n                        {log.pendingUsersCount}\n                      </div>\n                    </div>\n                    <div className=\"space-y-1\">\n                      <div className=\"text-muted-foreground\">å½“å‰é˜ˆå€¼</div>\n                      <div className=\"text-2xl font-bold flex items-center gap-1\">\n                        <TrendingUp className=\"h-4 w-4\" />\n                        {log.currentThreshold}åˆ†\n                      </div>\n                    </div>\n                    <div className=\"space-y-1\">\n                      <div className=\"text-muted-foreground\">è·ç¦»æ´»åŠ¨</div>\n                      <div className=\"text-2xl font-bold flex items-center gap-1\">\n                        <Clock className=\"h-4 w-4\" />\n                        {log.timeUntilEvent}h\n                      </div>\n                    </div>\n                    {log.decision === \"matched\" && (\n                      <div className=\"space-y-1\">\n                        <div className=\"text-muted-foreground\">å¹³å‡åˆ†æ•°</div>\n                        <div className=\"text-2xl font-bold text-green-600\">\n                          {getTemperatureEmoji(log.avgGroupScore || 0)} {log.avgGroupScore}åˆ†\n                        </div>\n                      </div>\n                    )}\n                  </div>\n\n                  {/* Match Results (if matched) */}\n                  {log.decision === \"matched\" && (\n                    <div className=\"bg-green-50 dark:bg-green-950 p-4 rounded-lg border border-green-200 dark:border-green-800\">\n                      <div className=\"flex items-center justify-between text-sm\">\n                        <span className=\"font-medium text-green-900 dark:text-green-100\">\n                          æˆåŠŸåŒ¹é…\n                        </span>\n                        <span className=\"text-green-700 dark:text-green-300\">\n                          {log.groupsFormed} ç»„ï¼Œå…± {log.usersMatched} äºº\n                        </span>\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Reason */}\n                  <div className=\"bg-muted p-4 rounded-lg\">\n                    <div className=\"text-sm font-medium mb-1\">å†³ç­–åŸå› </div>\n                    <div className=\"text-sm text-muted-foreground\">{log.reason}</div>\n                  </div>\n\n                  {/* Metadata */}\n                  <div className=\"text-xs text-muted-foreground\">\n                    è§¦å‘æ–¹å¼ï¼š{log.triggeredBy}\n                  </div>\n                </CardContent>\n              </Card>\n            );\n          })\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":8755},"DEVELOPER_QUICK_REFERENCE.md":{"content":"# JoyJoin Developer Quick Reference Guide\n\n**Version:** 1.1  \n**Last Updated:** November 20, 2025  \n**For:** Tech Team Onboarding & Codebase Navigation\n\n---\n\n## ğŸ¯ Quick Start\n\n### Database Migration (REQUIRED)\n```bash\n# Run this FIRST after pulling latest changes\nnpm run db:push\n```\n\n**Why:** New columns added to `eventPoolGroups` table (`energyBalance`, `temperatureLevel`)\n\n### Development Server\n```bash\nnpm run dev\n# Runs on port 5000 - both frontend and backend\n```\n\n---\n\n## ğŸ“‚ Codebase Structure\n\n```\njoyjoin/\nâ”œâ”€â”€ client/src/               # Frontend (React + TypeScript)\nâ”‚   â”œâ”€â”€ pages/                # Page components\nâ”‚   â”‚   â”œâ”€â”€ admin/            # Admin portal pages\nâ”‚   â”‚   â””â”€â”€ *.tsx             # User-facing pages\nâ”‚   â””â”€â”€ components/           # Reusable UI components\nâ”‚\nâ”œâ”€â”€ server/                   # Backend (Express + TypeScript)\nâ”‚   â”œâ”€â”€ routes.ts             # API endpoints (3400+ lines)\nâ”‚   â”œâ”€â”€ *Service.ts           # Business logic services\nâ”‚   â”œâ”€â”€ db.ts                 # Database connection\nâ”‚   â””â”€â”€ index.ts              # Server entry point\nâ”‚\nâ””â”€â”€ shared/                   # Shared types & schemas\n    â”œâ”€â”€ schema.ts             # Drizzle ORM database schema\n    â””â”€â”€ wsEvents.ts           # WebSocket event interfaces\n```\n\n---\n\n## ğŸ”¥ Feature 1: Temperature Concept System\n\n**What:** Dual-temperature visualization for match quality (Social Energy + Chemistry Reaction)\n\n### Files to Know\n\n| File | Purpose | Key Functions |\n|------|---------|---------------|\n| `server/archetypeChemistry.ts` | Core temperature logic | `ARCHETYPE_ENERGY` (energy mappings)<br>`calculateEnergyBalance()` (group energy calculation)<br>`getTemperatureLevel()` (emoji mapping)<br>`generateGroupExplanation()` (user-facing text) |\n| `server/poolMatchingService.ts` | Integration into matching | `formOptimalGroups()` - uses energy balance in scoring<br>`saveMatchResults()` - stores energy & temperature to DB |\n| `shared/schema.ts` | Database schema | `eventPoolGroups.energyBalance` (integer)<br>`eventPoolGroups.temperatureLevel` (varchar) |\n| `shared/wsEvents.ts` | WebSocket interface | `PoolMatchedData.temperatureLevel` (string) |\n| `client/src/pages/admin/AdminMatchingLogsPage.tsx` | Admin UI | `getTemperatureEmoji()` helper<br>Displays emoji next to avg score |\n| `client/src/pages/EventsPage.tsx` | User notifications | Toast displays temperature emoji |\n\n### Algorithm Formula (UPDATED)\n\n```typescript\n// OLD (Flawed): 70/30 split with diversity counted twice\noverallScore = avgPairScore Ã— 0.7 + groupDiversity Ã— 0.3\n\n// NEW (Corrected): 60/25/15 split\noverallScore = avgPairScore Ã— 0.6 + groupDiversity Ã— 0.25 + energyBalance Ã— 0.15\n```\n\n### Energy Levels Reference\n\n```typescript\nHigh Energy (80-95):    ç¤¾äº¤è´è¶ (95), æ´»åŠ¨ç­–åˆ’è€… (90), å¹½é»˜å¤§å¸ˆ (85)\nMedium Energy (45-60):  çŸ¥è¯†åˆ†äº«è€… (60), åˆ›æ„æ€è€ƒè€… (55), å€¾å¬è€… (50)\nLow Energy (25-40):     æ·±åº¦å¯¹è¯è€… (40), è§‚å¯Ÿè€… (30), ç‹¬ç«‹æ€è€ƒè€… (25)\n```\n\n### Temperature Thresholds\n\n```typescript\nğŸ”¥ ç‚½çƒ­ (Fire):   score â‰¥ 85  // Exceptional compatibility\nğŸŒ¡ï¸ æ¸©æš– (Warm):   score 70-84 // Strong compatibility\nğŸŒ¤ï¸ é€‚å®œ (Mild):   score 55-69 // Moderate compatibility\nâ„ï¸ å†·æ·¡ (Cold):   score < 55  // Low compatibility\n```\n\n### Debugging Tips\n- Check `ARCHETYPE_ENERGY` constant for energy value mappings\n- Verify `calculateEnergyBalance()` logic if groups feel unbalanced\n- Monitor `eventPoolGroups` table for stored energy/temperature values\n- Admin Matching Logs page shows temperature emoji for visual verification\n\n---\n\n## ğŸ”§ Feature 2: Matching Algorithm Fix (Diversity Double-Counting)\n\n**What:** Removed critical bug where diversity was counted twice in scoring\n\n### Files Modified\n\n| File | Change | Impact |\n|------|--------|--------|\n| `server/archetypeChemistry.ts` | Removed diversity from `calculatePairScore()` | Pair score now pure compatibility (chemistry + interest + preference + language) |\n| `server/poolMatchingService.ts` | Updated `formOptimalGroups()` formula | Changed from 70/30 to 60/25/15 weighting |\n\n### What Changed\n\n**Old Logic (FLAWED):**\n```typescript\n// calculatePairScore() included 10% diversity\npairScore = chemistry Ã— 0.4 + interest Ã— 0.3 + preference Ã— 0.2 + diversity Ã— 0.1\n\n// Then diversity counted AGAIN at group level\noverallScore = avgPairScore Ã— 0.7 + groupDiversity Ã— 0.3\n// Result: Diversity weighted at ~37% total! ğŸ˜±\n```\n\n**New Logic (CORRECTED):**\n```typescript\n// Pair Compatibility Score - 100% pure compatibility (NO diversity)\npairScore = chemistry Ã— 0.375 + interest Ã— 0.3125 + preference Ã— 0.25 + language Ã— 0.1875\n\n// Diversity only counted ONCE at group level\noverallScore = avgPairScore Ã— 0.6 + groupDiversity Ã— 0.25 + energyBalance Ã— 0.15\n```\n\n### Variable Renames for Clarity\n\n| Old Name | New Name | Reason |\n|----------|----------|--------|\n| `avgChemistry` | `avgPairScore` | More accurate - it's average of all pair compatibility scores |\n| `calculateGroupChemistry()` | `calculateGroupPairScore()` | Clarifies it's calculating pairwise compatibility |\n\n### Testing Impact\n- Groups should now have better balance between similarity (60%) and diversity (25%)\n- Energy balance (15%) prevents extreme energy groups\n- Monitor feedback: Are users happier with matches?\n\n---\n\n## âš¡ Feature 3: Real-time Dynamic Matching System\n\n**What:** Automated continuous matching with adaptive thresholds (no manual admin intervention)\n\n### Files to Know\n\n| File | Purpose | Key Functions |\n|------|---------|---------------|\n| `server/poolRealtimeMatchingService.ts` | Core matching engine | `scanAllPools()` - Main scheduler function<br>`scanPoolForMatching()` - Single pool scan<br>`calculateTimeDecayThreshold()` - Adaptive thresholds<br>`logMatchingDecision()` - Audit trail |\n| `server/poolMatchingService.ts` | Group formation logic | `matchEventPool()` - Creates optimal groups<br>`saveMatchResults()` - Persists to database |\n| `shared/schema.ts` | Database tables | `matchingThresholds` - Configurable parameters<br>`poolMatchingLogs` - Decision history |\n| `client/src/pages/admin/AdminMatchingConfigPage.tsx` | Admin configuration UI | Threshold tuning interface |\n| `client/src/pages/admin/AdminMatchingLogsPage.tsx` | Decision history viewer | Visualizes scan results |\n| `server/routes.ts` | API endpoints | `GET /api/admin/matching-thresholds`<br>`PUT /api/admin/matching-thresholds/:poolId`<br>`POST /api/admin/trigger-matching/:poolId`<br>`GET /api/admin/matching-logs` |\n\n### Three-Tier Threshold System\n\n```typescript\nconst DEFAULT_THRESHOLDS = {\n  highQualityThreshold: 85,    // Instant match (exceptional compatibility)\n  mediumQualityThreshold: 70,  // Wait for better options\n  lowQualityThreshold: 55,     // Wait until deadline\n  // < 55: Reject (insufficient compatibility)\n};\n```\n\n### Time Decay Algorithm\n\n```typescript\nfunction calculateTimeDecayThreshold(hoursUntilEvent, baseThreshold) {\n  if (hoursUntilEvent > 72) return baseThreshold;         // Full threshold\n  if (hoursUntilEvent > 48) return baseThreshold - 5;     // -5 points\n  if (hoursUntilEvent > 24) return baseThreshold - 10;    // -10 points\n  if (hoursUntilEvent > 12) return baseThreshold - 15;    // -15 points\n  return Math.max(50, baseThreshold - 20);                // -20 points (min 50)\n}\n```\n\n**Why:** Ensures users get matched even as deadline approaches (prevents last-minute unmatched users)\n\n### Matching Triggers\n\n1. **Instant Scan:** When user registers for event pool â†’ `scanPoolForMatching(poolId)`\n2. **Hourly Scan:** Cron job every 60 minutes â†’ `scanAllPools()`\n3. **Final 24h Scan:** Every 30 minutes in last 24 hours\n4. **Manual Trigger:** Admin clicks \"Trigger Matching\" â†’ API call\n\n### Database Tables\n\n**matchingThresholds:**\n```sql\nCREATE TABLE matching_thresholds (\n  pool_id VARCHAR PRIMARY KEY REFERENCES event_pools(id),\n  high_quality_threshold INTEGER DEFAULT 85,\n  medium_quality_threshold INTEGER DEFAULT 70,\n  low_quality_threshold INTEGER DEFAULT 55,\n  updated_at TIMESTAMP\n);\n```\n\n**poolMatchingLogs:**\n```sql\nCREATE TABLE pool_matching_logs (\n  id VARCHAR PRIMARY KEY,\n  pool_id VARCHAR REFERENCES event_pools(id),\n  scan_type VARCHAR,                  -- \"realtime\" | \"scheduled\" | \"manual\"\n  pending_users_count INTEGER,\n  current_threshold INTEGER,\n  time_until_event INTEGER,\n  groups_formed INTEGER,\n  users_matched INTEGER,\n  avg_group_score INTEGER,\n  decision VARCHAR,                   -- \"matched\" | \"waiting\" | \"insufficient\"\n  reason TEXT,\n  triggered_by VARCHAR,               -- \"user_registration\" | \"cron_job\" | \"admin_manual\"\n  created_at TIMESTAMP\n);\n```\n\n### Debugging Tips\n- Check `poolMatchingLogs` table for decision history\n- Monitor `scanType` to see trigger source\n- Review `reason` field for why matching succeeded/failed\n- Admin Matching Logs page shows visual history\n- Use Admin Matching Config to tune thresholds per pool\n\n---\n\n## ğŸ Feature 4: Invitation & Viral Growth System\n\n**What:** Auto-issue Â¥50 INVITE_REWARD coupon when invited users match together\n\n### Files to Know\n\n| File | Purpose | Key Logic |\n|------|---------|-----------|\n| `server/poolMatchingService.ts` | Auto-coupon issuance | `saveMatchResults()` - Checks invitation relationships<br>Issues coupon to inviter when invitees match |\n| `shared/schema.ts` | Database tables | `invitations` - Tracks who invited whom<br>`invitation_uses` - Tracks coupon rewards<br>`user_coupons` - Coupon assignments |\n| Frontend UI components | Badge display | Purple \"å·²é‚€è¯· [name]\" for inviters<br>Blue \"[name] é‚€è¯·çš„\" for invitees |\n\n### Invitation Flow\n\n```typescript\n// 1. User A invites User B (creates invitation record)\nINSERT INTO invitations (inviter_id, invitee_id, invitation_code);\n\n// 2. User B registers using invitation code\nUPDATE invitations SET status = 'accepted' WHERE invitation_code = code;\n\n// 3. User B gets matched in an event pool\n// saveMatchResults() checks: \"Is User B an invitee?\"\nconst invitation = await db.select().from(invitations)\n  .where(and(\n    eq(invitations.inviteeId, userB.id),\n    eq(invitations.status, 'accepted')\n  ));\n\n// 4. If yes, issue Â¥50 coupon to User A (inviter)\nINSERT INTO user_coupons (user_id, coupon_type, amount, source)\nVALUES (invitationRecord.inviterId, 'INVITE_REWARD', 50, 'invitation_reward');\n\n// 5. Log the reward\nINSERT INTO invitation_uses (invitation_id, event_pool_id, rewarded_at);\n```\n\n### Database Tables\n\n**invitations:**\n```sql\nCREATE TABLE invitations (\n  id VARCHAR PRIMARY KEY,\n  inviter_id VARCHAR REFERENCES users(id),\n  invitee_id VARCHAR REFERENCES users(id),\n  invitation_code VARCHAR UNIQUE,\n  status VARCHAR,  -- \"pending\" | \"accepted\" | \"expired\"\n  created_at TIMESTAMP\n);\n```\n\n**invitation_uses:**\n```sql\nCREATE TABLE invitation_uses (\n  id VARCHAR PRIMARY KEY,\n  invitation_id VARCHAR REFERENCES invitations(id),\n  event_pool_id VARCHAR REFERENCES event_pools(id),\n  rewarded_at TIMESTAMP\n);\n```\n\n**user_coupons:**\n```sql\nCREATE TABLE user_coupons (\n  id VARCHAR PRIMARY KEY,\n  user_id VARCHAR REFERENCES users(id),\n  coupon_type VARCHAR,\n  amount INTEGER,\n  source VARCHAR,  -- \"invitation_reward\" | \"admin_grant\" | etc.\n  status VARCHAR,  -- \"available\" | \"used\" | \"expired\"\n  created_at TIMESTAMP\n);\n```\n\n### Debugging Tips\n- Check `invitation_uses` table to see if coupons were issued\n- Verify `invitations.status = 'accepted'` before expecting rewards\n- Monitor `user_coupons` for coupon assignments\n- Test with 2 test users: one invites, one accepts and gets matched\n\n---\n\n## ğŸ­ Feature 5: Event Pool User Flow\n\n**What:** Complete two-stage matching model UI (users register for pools with soft preferences)\n\n### Files to Know\n\n| File | Purpose | Key Components |\n|------|---------|----------------|\n| `client/src/pages/DiscoverPage.tsx` | Event pool discovery | Fetches `/api/event-pools`<br>Displays blind box event cards |\n| `client/src/pages/EventPoolRegistrationPage.tsx` | User registration | Soft preference selection form<br>Budget, cuisine, social goals, dietary restrictions |\n| `client/src/pages/EventsPage.tsx` | Registration status | Displays pool registrations alongside events<br>Status-based filtering (pending/matched/completed) |\n| `client/src/components/PoolRegistrationCard.tsx` | Status display card | Shows registration status and match scores |\n| `client/src/components/BlindBoxEventCard.tsx` | Event pool card | Navigates to registration page on click |\n| `server/routes.ts` | API endpoints | `GET /api/event-pools` - List active pools<br>`POST /api/event-pools/:id/register` - Register with preferences |\n| `shared/schema.ts` | Database tables | `eventPools` - Admin-created pools<br>`eventPoolRegistrations` - User signups + preferences<br>`eventPoolGroups` - Matched groups |\n\n### User Journey\n\n```\nDiscoverPage \n  â†“ (Click blind box event)\nEventPoolRegistrationPage \n  â†“ (Submit preferences)\nEventsPage â†’ \"å¾…åŒ¹é…\" tab\n  â†“ (Matching happens in background)\nEventsPage â†’ \"å·²åŒ¹é…\" tab (auto-switch via WebSocket)\n  â†“\nPoolRegistrationCard shows match score & temperature\n```\n\n### Registration Preferences (Soft Constraints)\n\n```typescript\ninterface EventPoolRegistration {\n  userId: string;\n  poolId: string;\n  \n  // Soft preferences (used in matching algorithm)\n  budgetRange: string[];          // [\"50-100\", \"100-200\"]\n  languages: string[];            // [\"ç²¤è¯­\", \"è‹±è¯­\", \"æ™®é€šè¯\"]\n  socialGoals: string[];          // [\"è®¤è¯†æ–°æœ‹å‹\", \"æ‰©å±•äººè„‰\", \"æ·±åº¦äº¤æµ\"]\n  cuisinePreferences: string[];   // [\"ç²¤èœ\", \"è¥¿é¤\", \"æ—¥æ–™\"]\n  dietaryRestrictions: string[];  // [\"ç´ é£Ÿ\", \"æ¸…çœŸ\", \"æ— \"]\n  tasteIntensity: string;         // \"æ¸…æ·¡\" | \"é€‚ä¸­\" | \"é‡å£å‘³\"\n  \n  status: string;                 // \"pending\" | \"matched\" | \"completed\" | \"cancelled\"\n  matchedGroupId: string | null;\n  matchScore: number | null;\n}\n```\n\n### Database Tables\n\n**eventPools:**\n```sql\nCREATE TABLE event_pools (\n  id VARCHAR PRIMARY KEY,\n  title VARCHAR,\n  description TEXT,\n  event_type VARCHAR,\n  event_date_time TIMESTAMP,\n  location VARCHAR,\n  \n  -- Hard constraints (admin-set)\n  gender_restrictions VARCHAR[],\n  industry_restrictions VARCHAR[],\n  seniority_restrictions VARCHAR[],\n  education_level_restrictions VARCHAR[],\n  \n  status VARCHAR,  -- \"active\" | \"matching\" | \"completed\" | \"cancelled\"\n  created_at TIMESTAMP\n);\n```\n\n**eventPoolRegistrations:**\n```sql\nCREATE TABLE event_pool_registrations (\n  id VARCHAR PRIMARY KEY,\n  user_id VARCHAR REFERENCES users(id),\n  pool_id VARCHAR REFERENCES event_pools(id),\n  \n  -- Soft preferences\n  budget_range VARCHAR[],\n  languages VARCHAR[],\n  social_goals VARCHAR[],\n  cuisine_preferences VARCHAR[],\n  dietary_restrictions VARCHAR[],\n  taste_intensity VARCHAR,\n  \n  status VARCHAR,\n  matched_group_id VARCHAR REFERENCES event_pool_groups(id),\n  match_score INTEGER,\n  created_at TIMESTAMP\n);\n```\n\n**eventPoolGroups:**\n```sql\nCREATE TABLE event_pool_groups (\n  id VARCHAR PRIMARY KEY,\n  pool_id VARCHAR REFERENCES event_pools(id),\n  group_number INTEGER,\n  \n  -- Scoring\n  avg_pair_score INTEGER,\n  diversity_score INTEGER,\n  energy_balance INTEGER,        -- NEW in v1.1\n  overall_score INTEGER,\n  temperature_level VARCHAR,     -- NEW in v1.1\n  \n  explanation TEXT,\n  created_at TIMESTAMP\n);\n```\n\n### API Endpoints\n\n```typescript\n// List active event pools\nGET /api/event-pools\nResponse: EventPool[]\n\n// Register for event pool\nPOST /api/event-pools/:poolId/register\nBody: {\n  budgetRange: string[],\n  languages: string[],\n  socialGoals: string[],\n  cuisinePreferences: string[],\n  dietaryRestrictions: string[],\n  tasteIntensity: string\n}\nResponse: { registrationId: string }\n\n// Get user's pool registrations\nGET /api/event-pool-registrations\nResponse: EventPoolRegistration[]\n```\n\n### Debugging Tips\n- Check `/api/event-pools` endpoint returns active pools\n- Verify `eventPools.status = 'active'` for discoverable pools\n- Monitor `eventPoolRegistrations` table for user signups\n- Check `EventsPage` properly filters by status (pending/matched/completed)\n- WebSocket `POOL_MATCHED` event should trigger auto-switch to \"å·²åŒ¹é…\" tab\n\n---\n\n## ğŸ”” Feature 6: WebSocket Real-time Notifications\n\n**What:** Instant user notifications when matched (POOL_MATCHED event)\n\n### Files to Know\n\n| File | Purpose | Key Logic |\n|------|---------|-----------|\n| `server/poolMatchingService.ts` | Broadcasts match event | `saveMatchResults()` calls `wsService.broadcastToUser()`<br>Sends `POOL_MATCHED` event to all matched users |\n| `shared/wsEvents.ts` | Event interface | `PoolMatchedData` interface with all match details |\n| `client/src/pages/EventsPage.tsx` | Event subscription | Subscribes to `POOL_MATCHED` via WebSocket<br>Displays toast notification<br>Invalidates cache + auto-switches to \"å·²åŒ¹é…\" tab |\n| `server/wsService.ts` | WebSocket server | Manages connections and broadcasts |\n\n### WebSocket Event Flow\n\n```typescript\n// 1. Admin completes matching (or auto-matching triggers)\nawait matchEventPool(poolId);\n\n// 2. Backend saves results and broadcasts\nfor (const userId of matchedUserIds) {\n  wsService.broadcastToUser(userId, {\n    type: 'POOL_MATCHED',\n    data: {\n      poolId: pool.id,\n      poolTitle: pool.title,\n      groupId: group.id,\n      groupNumber: group.groupNumber,\n      matchScore: group.overallScore,\n      memberCount: group.members.length,\n      temperatureLevel: group.temperatureLevel  // NEW in v1.1\n    }\n  });\n}\n\n// 3. Frontend receives event\nuseEffect(() => {\n  const ws = new WebSocket('/ws');\n  ws.onmessage = (event) => {\n    const message = JSON.parse(event.data);\n    if (message.type === 'POOL_MATCHED') {\n      // Show toast notification\n      toast({\n        title: \"ğŸ‰ åŒ¹é…æˆåŠŸï¼\",\n        description: `${message.data.temperatureLevel} Â· å°ç»„ ${message.data.groupNumber} Â· åŒ¹é…åº¦ ${message.data.matchScore}åˆ†`\n      });\n      \n      // Invalidate cache\n      queryClient.invalidateQueries(['/api/event-pool-registrations']);\n      \n      // Auto-switch to matched tab\n      setActiveTab('matched');\n    }\n  };\n}, []);\n```\n\n### WebSocket Event Interface\n\n```typescript\n// shared/wsEvents.ts\nexport interface PoolMatchedData {\n  poolId: string;\n  poolTitle: string;\n  groupId: string;\n  groupNumber: number;\n  matchScore: number;\n  memberCount: number;\n  temperatureLevel: string;  // \"ğŸ”¥ ç‚½çƒ­\", \"ğŸŒ¡ï¸ æ¸©æš–\", etc. (NEW in v1.1)\n}\n\nexport interface WebSocketMessage {\n  type: 'POOL_MATCHED' | 'EVENT_STATUS_CHANGED' | ...;\n  data: PoolMatchedData | ...;\n}\n```\n\n### Debugging Tips\n- Check WebSocket connection in browser DevTools (Network tab â†’ WS)\n- Monitor `ws.readyState` to verify connection status\n- Log `ws.onmessage` events to see incoming messages\n- Verify `wsService.broadcastToUser()` is called in `saveMatchResults()`\n- Check toast notifications appear when `POOL_MATCHED` received\n- Confirm cache invalidation triggers re-fetch of registrations\n\n---\n\n## ğŸ” Feature 7: Event Pool Discovery Fix\n\n**What:** Fixed `/api/event-pools` endpoint to display admin-created blind box events\n\n### Files Modified\n\n| File | Change | Impact |\n|------|--------|--------|\n| `server/routes.ts` | Fixed `/api/event-pools` endpoint | Now returns active pools correctly |\n| `shared/schema.ts` | Schema synchronization | Added missing columns: `description`, `eventType`, `educationLevelRestrictions` |\n| `client/src/pages/DiscoverPage.tsx` | Data fetching | Successfully fetches and displays event pools |\n\n### What Was Broken\n\n**Before:**\n- `/api/event-pools` returned empty array even with active pools\n- Status was inconsistent (`published` vs `recruiting` vs `active`)\n- Missing required columns in database schema\n\n**After:**\n- Unified status to `active` for all discoverable pools\n- Schema synchronized with all required fields\n- DiscoverPage successfully displays event pools\n\n### Database Schema Sync\n\n```sql\n-- Ensure these columns exist\nALTER TABLE event_pools \nADD COLUMN IF NOT EXISTS description TEXT,\nADD COLUMN IF NOT EXISTS event_type VARCHAR,\nADD COLUMN IF NOT EXISTS education_level_restrictions VARCHAR[];\n\n-- Unified status values\nUPDATE event_pools SET status = 'active' WHERE status IN ('published', 'recruiting');\n```\n\n### API Endpoint\n\n```typescript\n// GET /api/event-pools\napp.get(\"/api/event-pools\", async (req, res) => {\n  const pools = await db\n    .select()\n    .from(eventPools)\n    .where(eq(eventPools.status, 'active'))  // Unified to 'active'\n    .orderBy(desc(eventPools.createdAt));\n  \n  res.json(pools);\n});\n```\n\n### Debugging Tips\n- Verify `eventPools.status = 'active'` in database\n- Check schema has all required columns (description, eventType, etc.)\n- Test `/api/event-pools` endpoint directly (should return array)\n- Confirm DiscoverPage fetches and renders event pools\n\n---\n\n## ğŸ—„ï¸ Database Schema Updates (v1.1)\n\n### New Columns\n\n**eventPoolGroups:**\n```sql\nALTER TABLE event_pool_groups \nADD COLUMN energy_balance INTEGER,\nADD COLUMN temperature_level VARCHAR;\n```\n\n### New Tables\n\n**matchingThresholds:**\n```sql\nCREATE TABLE matching_thresholds (\n  pool_id VARCHAR PRIMARY KEY REFERENCES event_pools(id),\n  high_quality_threshold INTEGER DEFAULT 85,\n  medium_quality_threshold INTEGER DEFAULT 70,\n  low_quality_threshold INTEGER DEFAULT 55,\n  updated_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n**poolMatchingLogs:**\n```sql\nCREATE TABLE pool_matching_logs (\n  id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),\n  pool_id VARCHAR REFERENCES event_pools(id),\n  scan_type VARCHAR,\n  pending_users_count INTEGER DEFAULT 0,\n  current_threshold INTEGER,\n  time_until_event INTEGER,\n  groups_formed INTEGER DEFAULT 0,\n  users_matched INTEGER DEFAULT 0,\n  avg_group_score INTEGER,\n  decision VARCHAR,\n  reason TEXT,\n  triggered_by VARCHAR,\n  created_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n---\n\n## ğŸ”Œ New API Endpoints (v1.1)\n\n### Admin Matching Configuration\n\n```typescript\n// Get matching thresholds for a pool\nGET /api/admin/matching-thresholds?poolId={poolId}\nResponse: MatchingThreshold\n\n// Update matching thresholds\nPUT /api/admin/matching-thresholds/:poolId\nBody: {\n  highQualityThreshold: number,\n  mediumQualityThreshold: number,\n  lowQualityThreshold: number\n}\nResponse: MatchingThreshold\n\n// Manually trigger matching scan\nPOST /api/admin/trigger-matching/:poolId\nResponse: { message: string, scanResult: MatchingScanResult }\n\n// Get matching decision history\nGET /api/admin/matching-logs?poolId={poolId}&scanType={type}&decision={decision}&limit={limit}\nResponse: PoolMatchingLog[]\n```\n\n---\n\n## ğŸ§ª Testing Checklist\n\n### Temperature Concept\n- [ ] Verify `ARCHETYPE_ENERGY` mappings are correct\n- [ ] Test `calculateEnergyBalance()` with different group compositions\n- [ ] Check temperature emoji displays in Admin Matching Logs\n- [ ] Confirm WebSocket notifications include `temperatureLevel`\n- [ ] Validate toast notifications show correct temperature\n\n### Matching Algorithm\n- [ ] Verify diversity is only counted once (not twice)\n- [ ] Test scoring formula: 60% pair + 25% diversity + 15% energy\n- [ ] Check `avgPairScore` calculation excludes diversity\n- [ ] Monitor match quality feedback from users\n\n### Real-time Matching\n- [ ] Test instant scan on user registration\n- [ ] Verify hourly scheduled scans run correctly\n- [ ] Check time decay algorithm lowers thresholds near deadline\n- [ ] Confirm manual trigger works from Admin UI\n- [ ] Review `poolMatchingLogs` for decision history\n\n### Invitation System\n- [ ] Test invitation creation and acceptance flow\n- [ ] Verify Â¥50 coupon auto-issued when invitee matches\n- [ ] Check `invitation_uses` table records rewards\n- [ ] Confirm badges display correctly (purple/blue)\n\n### Event Pool User Flow\n- [ ] Test user registration with soft preferences\n- [ ] Verify status filtering (pending/matched/completed)\n- [ ] Check `PoolRegistrationCard` displays correctly\n- [ ] Confirm navigation from DiscoverPage to RegistrationPage\n\n### WebSocket Notifications\n- [ ] Verify WebSocket connection establishes successfully\n- [ ] Test `POOL_MATCHED` event broadcasts to all matched users\n- [ ] Check toast notifications display with correct data\n- [ ] Confirm cache invalidation triggers re-fetch\n- [ ] Verify auto-switch to \"å·²åŒ¹é…\" tab\n\n### Event Pool Discovery\n- [ ] Test `/api/event-pools` returns active pools\n- [ ] Verify DiscoverPage displays event pools\n- [ ] Check all required schema columns exist\n- [ ] Confirm status unified to `active`\n\n---\n\n## ğŸš¨ Common Issues & Solutions\n\n### Issue: \"Column does not exist: energy_balance\"\n**Solution:** Run `npm run db:push` to sync schema\n\n### Issue: Diversity still counted twice\n**Solution:** Check `calculatePairScore()` in `server/archetypeChemistry.ts` - should NOT include diversity parameter\n\n### Issue: WebSocket notifications not received\n**Solution:** \n1. Check WebSocket connection in browser DevTools\n2. Verify `wsService.broadcastToUser()` is called in `saveMatchResults()`\n3. Confirm user ID matches WebSocket connection\n\n### Issue: Temperature emoji not showing\n**Solution:**\n1. Check `getTemperatureLevel()` function returns correct emoji string\n2. Verify `temperatureLevel` stored in `eventPoolGroups` table\n3. Confirm frontend displays `{temperatureLevel}` not just `{score}`\n\n### Issue: Event pools not showing in DiscoverPage\n**Solution:**\n1. Check `eventPools.status = 'active'` in database\n2. Verify schema has all required columns\n3. Test `/api/event-pools` endpoint directly\n\n### Issue: Matching not triggering automatically\n**Solution:**\n1. Check `server/index.ts` starts realtime matching scheduler\n2. Verify cron job interval (default: 60 minutes)\n3. Monitor `poolMatchingLogs` for scan records\n\n---\n\n## ğŸ“š Key Concepts for Tech Team\n\n### Pair Score vs Group Diversity\n- **Pair Score:** Measures compatibility between two individuals (similarity)\n- **Group Diversity:** Measures richness of backgrounds in the group (variety)\n- These are orthogonal dimensions - both contribute to group quality\n\n### Energy Balance\n- **High Energy Groups:** All extroverts â†’ exhausting, chaotic\n- **Low Energy Groups:** All introverts â†’ awkward silences, low engagement\n- **Balanced Groups:** Mix of energy levels â†’ natural conversation flow\n\n### Hard Constraints vs Soft Preferences\n- **Hard Constraints:** Admin-set restrictions (gender, industry, seniority) - must match\n- **Soft Preferences:** User preferences (budget, cuisine, goals) - used in scoring, not filtering\n\n### Real-time vs Scheduled Matching\n- **Real-time:** Triggered immediately on user registration (instant scan)\n- **Scheduled:** Cron job runs every 60 minutes (batch scan)\n- **Final 24h:** Every 30 minutes in last 24 hours (intensive scan)\n\n---\n\n## ğŸ› ï¸ Development Workflow\n\n### Making Changes to Matching Algorithm\n\n1. **Update algorithm logic:** `server/poolMatchingService.ts` or `server/archetypeChemistry.ts`\n2. **Update PRD documentation:** `PRODUCT_REQUIREMENTS.md` Section 3.4/3.5\n3. **Test with real data:** Use Admin Matching Lab to test changes\n4. **Monitor feedback:** Check `poolMatchingLogs` and user feedback\n5. **Iterate:** Adjust weights/thresholds based on data\n\n### Adding New Features\n\n1. **Update database schema:** `shared/schema.ts`\n2. **Run migration:** `npm run db:push`\n3. **Add backend logic:** `server/routes.ts` + `server/*Service.ts`\n4. **Add frontend UI:** `client/src/pages/*.tsx`\n5. **Update PRD:** `PRODUCT_REQUIREMENTS.md`\n6. **Update this guide:** `DEVELOPER_QUICK_REFERENCE.md`\n\n### Debugging Production Issues\n\n1. **Check logs:** `refresh_all_logs` in Replit\n2. **Query database:** Use `execute_sql_tool` to inspect data\n3. **Monitor WebSocket:** Browser DevTools â†’ Network â†’ WS\n4. **Review matching logs:** Admin Matching Logs page\n5. **Test locally:** Replicate issue in development environment\n\n---\n\n## ğŸ“ Need Help?\n\n- **Algorithm Questions:** Review `server/poolMatchingService.ts` and `server/archetypeChemistry.ts`\n- **Database Questions:** Check `shared/schema.ts` for schema definitions\n- **API Questions:** See `server/routes.ts` for endpoint implementations\n- **UI Questions:** Explore `client/src/pages/` for page components\n\n**Remember:** This is a living codebase. When in doubt, read the code!\n\n---\n\n**Last Updated:** November 20, 2025  \n**Maintainer:** JoyJoin Development Team\n","size_bytes":28282},"1. PRODUCT_REQUIREMENTS.md":{"content":"","size_bytes":0},"client/src/data/personalityQuestions.ts":{"content":"/**\n * 12ä¸ªç¤¾äº¤æ°›å›´åŸå‹æ€§æ ¼æµ‹è¯„é¢˜åº“\n * 10é¢˜ç²¾å‡†åŒºåˆ†ï¼šå¼€å¿ƒæŸ¯åŸºã€å¤ªé˜³é¸¡ã€å¤¸å¤¸è±šã€æœºæ™ºç‹ã€æ·¡å®šæµ·è±šã€ç»‡ç½‘è››ã€æš–å¿ƒç†Šã€çµæ„Ÿç« é±¼ã€æ²‰æ€çŒ«å¤´é¹°ã€å®šå¿ƒå¤§è±¡ã€ç¨³å¦‚é¾Ÿã€éšèº«çŒ«\n */\n\nexport interface QuestionOption {\n  value: string;\n  text: string;\n  roleMapping: string; // æ˜ å°„åˆ°12ä¸ªåŸå‹ä¹‹ä¸€\n}\n\nexport interface Question {\n  id: number;\n  category: string;\n  questionText: string;\n  scenarioText?: string;\n  questionType: \"single\" | \"dual\";\n  options: QuestionOption[];\n}\n\nexport const personalityQuestions: Question[] = [\n  {\n    id: 1,\n    category: \"ç¤¾äº¤å¯åŠ¨æ–¹å¼\",\n    scenarioText: \"ğŸ‰ æœ‹å‹ç”Ÿæ—¥èšä¼šï¼Œä½ èµ°è¿›åŒ…å¢ï¼Œå‘ç°æœ‰5ä¸ªäººä½ éƒ½ä¸è®¤è¯†...\",\n    questionText: \"åˆšè¿›é—¨ï¼Œä½ æœ€è‡ªç„¶çš„ååº”æ˜¯ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"ä¸»åŠ¨è‡ªæˆ‘ä»‹ç»ï¼Œç”¨å¹½é»˜å¼€åœºè®©å¤§å®¶ç¬‘èµ·æ¥ï¼\", roleMapping: \"å¼€å¿ƒæŸ¯åŸº\" },\n      { value: \"B\", text: \"å¾®ç¬‘ç€ç¯é¡¾å››å‘¨ï¼Œç­‰å¾…åˆé€‚æ—¶æœºåŠ å…¥å¯¹è¯ã€‚\", roleMapping: \"æ·¡å®šæµ·è±š\" },\n      { value: \"C\", text: \"æ‰¾ä¸ªä½å­åä¸‹ï¼Œå®‰é™è§‚å¯Ÿå¤§å®¶çš„äº’åŠ¨èŠ‚å¥ã€‚\", roleMapping: \"éšèº«çŒ«\" },\n      { value: \"D\", text: \"ä¸»åŠ¨è¯¢é—®\\\"å¤§å®¶æ€ä¹ˆè®¤è¯†å¯¿æ˜Ÿçš„\\\"ï¼Œå»ºç«‹è¿æ¥ã€‚\", roleMapping: \"ç»‡ç½‘è››\" },\n    ],\n  },\n  \n  {\n    id: 2,\n    category: \"èƒ½é‡é‡Šæ”¾æ¨¡å¼\",\n    scenarioText: \"ğŸ’¬ è¯é¢˜èŠèµ·æ¥äº†ï¼Œæœ‰äººæåˆ°æœ€è¿‘å‘ç°çš„ä¸€å®¶ç¥ç§˜å’–å•¡é¦†...\",\n    questionText: \"å¬åˆ°è¿™ä¸ªæ–°é²œäº‹ï¼Œä½ çš„ååº”æ˜¯ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"å“‡ï¼åœ¨å“ªé‡Œï¼Ÿæˆ‘ä»¬ç»„å›¢å»æ‰“å¡å§ï¼\\\" ç«‹é©¬å……æ»¡è¡ŒåŠ¨åŠ›\", roleMapping: \"æœºæ™ºç‹\" },\n      { value: \"B\", text: \"\\\"å¬èµ·æ¥ä¸é”™å‘€ï½\\\" å¾®ç¬‘å›åº”ï¼Œç»™taé¼“åŠ±å’Œè‚¯å®š\", roleMapping: \"å¤¸å¤¸è±š\" },\n      { value: \"C\", text: \"\\\"æˆ‘ä¹‹å‰ä¹Ÿå»è¿‡ç±»ä¼¼çš„ï¼Œé‚£æ¬¡...\\\" åˆ†äº«è‡ªå·±çš„ç›¸å…³æ•…äº‹\", roleMapping: \"æš–å¿ƒç†Š\" },\n      { value: \"D\", text: \"\\\"å’–å•¡é¦†çš„è®¾è®¡ç†å¿µæ˜¯ä»€ä¹ˆï¼Ÿ\\\" æ€è€ƒèƒŒåçš„æ·±å±‚é€»è¾‘\", roleMapping: \"æ²‰æ€çŒ«å¤´é¹°\" },\n    ],\n  },\n  \n  {\n    id: 3,\n    category: \"æƒ…ç»ªè°ƒèŠ‚è§’è‰²\",\n    scenarioText: \"ğŸ˜” æ°”æ°›çªç„¶å®‰é™ä¸‹æ¥ï¼Œæœ‰äººåˆ†äº«äº†ä¸€æ®µå¤±è½çš„ç»å†...\",\n    questionText: \"é¢å¯¹è¿™ä¸ªæƒ…ç»ªä½ç‚¹ï¼Œä½ ä¼šï¼Ÿ\",\n    questionType: \"dual\",\n    options: [\n      { value: \"A\", text: \"\\\"æˆ‘æ‡‚ä½ çš„æ„Ÿå—...\\\" ç”¨å…±æƒ…çš„æ–¹å¼æ·±åº¦å€¾å¬\", roleMapping: \"æš–å¿ƒç†Š\" },\n      { value: \"B\", text: \"\\\"æ²¡äº‹çš„ï¼Œæˆ‘ä»¬éƒ½æ”¯æŒä½ ï¼\\\" æ¸©æš–é¼“åŠ±taç»§ç»­å‰è¿›\", roleMapping: \"å¤ªé˜³é¸¡\" },\n      { value: \"C\", text: \"é»˜é»˜é€’çº¸å·¾ï¼Œç”¨å®‰é™çš„é™ªä¼´è¡¨è¾¾æ”¯æŒ\", roleMapping: \"éšèº«çŒ«\" },\n      { value: \"D\", text: \"é€‚æ—¶è°ƒæ•´è¯é¢˜èŠ‚å¥ï¼Œé¿å…æ°›å›´è¿‡äºæ²‰é‡\", roleMapping: \"æ·¡å®šæµ·è±š\" },\n    ],\n  },\n  \n  {\n    id: 4,\n    category: \"æ€ç»´è¡¨è¾¾æ–¹å¼\",\n    scenarioText: \"ğŸŒŸ å¤§å®¶åœ¨è®¨è®ºï¼š\\\"å¦‚æœèƒ½å¼€ä¸€å®¶æ¢¦æƒ³å°åº—ï¼Œä½ ä¼šå¼€ä»€ä¹ˆï¼Ÿ\\\"\",\n    questionText: \"ä½ çš„å¤§è„‘ä¼šï¼Ÿ\",\n    questionType: \"dual\",\n    options: [\n      { value: \"A\", text: \"ç¬é—´å†’å‡º10ä¸ªç‚¹å­ï¼š\\\"çŒ«å’–ï¼æ·±å¤œä¹¦åº—ï¼ç§»åŠ¨å¥¶èŒ¶è½¦ï¼\\\"\", roleMapping: \"çµæ„Ÿç« é±¼\" },\n      { value: \"B\", text: \"æ€è€ƒæ ¸å¿ƒåŸåˆ™ï¼š\\\"é¦–å…ˆè¦æƒ³æ¸…æ¥šç›®æ ‡å®¢æˆ·æ˜¯è°...\\\"\", roleMapping: \"æ²‰æ€çŒ«å¤´é¹°\" },\n      { value: \"C\", text: \"è¿æ¥ä¸åŒäººçš„æƒ³æ³•ï¼š\\\"Açš„æƒ³æ³•+Bçš„è§‚ç‚¹å¯ä»¥ç»“åˆï¼\\\"\", roleMapping: \"ç»‡ç½‘è››\" },\n      { value: \"D\", text: \"å…³æ³¨å®æ“ï¼š\\\"ç§Ÿé‡‘å¤šå°‘ï¼Ÿéœ€è¦å¤šå°‘å¯åŠ¨èµ„é‡‘ï¼Ÿ\\\"\", roleMapping: \"å®šå¿ƒå¤§è±¡\" },\n    ],\n  },\n  \n  {\n    id: 5,\n    category: \"å†²çªåº”å¯¹ç­–ç•¥\",\n    scenarioText: \"ğŸ¤” ä¸¤ä¸ªäººå°±\\\"å¥¶èŒ¶è¯¥å–å…¨ç³–è¿˜æ˜¯å°‘ç³–\\\"å¼€å§‹è®¤çœŸäº‰è®ºï¼Œæ°”æ°›æœ‰ç‚¹ç´§å¼ ...\",\n    questionText: \"ä½ ä¼šå¦‚ä½•åº”å¯¹ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"å“å‘€åˆ«äº‰å•¦ï½å’±ä»¬å„ä¹°å„çš„ä¸å°±å¥½äº†ï¼\\\" ç”¨å¹½é»˜åŒ–è§£\", roleMapping: \"å¼€å¿ƒæŸ¯åŸº\" },\n      { value: \"B\", text: \"\\\"ä¸¤è¾¹éƒ½æœ‰é“ç†ï¼Œä¹Ÿè®¸å¯ä»¥ç‚¹åŠç³–è¯•è¯•...\\\" å¯»æ‰¾å¹³è¡¡ç‚¹\", roleMapping: \"æ·¡å®šæµ·è±š\" },\n      { value: \"C\", text: \"ä¿æŒæ²‰é»˜ï¼Œç­‰å¾…äº‰è®ºè‡ªç„¶ç»“æŸå†è¯´è¯\", roleMapping: \"ç¨³å¦‚é¾Ÿ\" },\n      { value: \"D\", text: \"\\\"æ¢ä¸ªè§’åº¦æƒ³ï¼Œå…¶å®å£å‘³æ˜¯å¾ˆä¸»è§‚çš„...\\\" æä¾›ç¬¬ä¸‰æ–¹è§†è§’\", roleMapping: \"çµæ„Ÿç« é±¼\" },\n    ],\n  },\n  \n  {\n    id: 6,\n    category: \"è´¡çŒ®ä»·å€¼æ–¹å¼\",\n    scenarioText: \"ğŸ’¡ è¯é¢˜è½¬å‘\\\"å¤§å®¶ä»Šå¹´æœ€å¤§çš„æˆé•¿æ˜¯ä»€ä¹ˆ\\\"...\",\n    questionText: \"ä½ å€¾å‘äºè´¡çŒ®ä»€ä¹ˆï¼Ÿ\",\n    questionType: \"dual\",\n    options: [\n      { value: \"A\", text: \"\\\"æˆ‘å‘ç°äº†ä¸€ä¸ªæ–°è§†è§’...\\\" åˆ†äº«ç‹¬ç‰¹çš„æ€è€ƒæ´å¯Ÿ\", roleMapping: \"ç¨³å¦‚é¾Ÿ\" },\n      { value: \"B\", text: \"\\\"ä½ ä»¬éƒ½å¥½æ£’ï¼æˆ‘ä¹Ÿæƒ³...\\\" é¼“æŒå¹¶åˆ†äº«æ­£èƒ½é‡\", roleMapping: \"å¤¸å¤¸è±š\" },\n      { value: \"C\", text: \"\\\"è¯´åˆ°æˆé•¿ï¼Œæˆ‘æƒ³èµ·...\\\" è®²è¿°ä¸€ä¸ªæ„Ÿäººçš„æ•…äº‹\", roleMapping: \"æš–å¿ƒç†Š\" },\n      { value: \"D\", text: \"\\\"æˆ‘è§‰å¾—æœ€é‡è¦çš„æ˜¯ä¿æŒç¨³å®š...\\\" æä¾›å¯é çš„å»ºè®®\", roleMapping: \"å®šå¿ƒå¤§è±¡\" },\n    ],\n  },\n  \n  {\n    id: 7,\n    category: \"ç¤¾äº¤èˆ’é€‚åŒº\",\n    scenarioText: \"ğŸ¯ èšä¼šè¿›è¡Œåˆ°ä¸€åŠï¼Œä½ æ„Ÿè§‰æœ€èˆ’æœçš„çŠ¶æ€æ˜¯ï¼Ÿ\",\n    questionText: \"ä»¥ä¸‹å“ªç§æè¿°æœ€ç¬¦åˆä½ ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"æˆä¸ºç„¦ç‚¹ï¼Œå¸¦åŠ¨å…¨åœºèŠ‚å¥ï¼Œæ„Ÿè§‰æ´»åŠ›æ»¡æ»¡ï¼\", roleMapping: \"å¼€å¿ƒæŸ¯åŸº\" },\n      { value: \"B\", text: \"æ•£å‘æ¸©æš–èƒ½é‡ï¼Œè®©æ¯ä¸ªäººéƒ½æ„Ÿåˆ°è¢«å…³æ³¨å’Œç…§é¡¾\", roleMapping: \"å¤ªé˜³é¸¡\" },\n      { value: \"C\", text: \"å‘ç°æœ‰è¶£çš„äººï¼ŒæŒ–æ˜æ–°çš„ä½“éªŒå’Œä¿¡æ¯\", roleMapping: \"æœºæ™ºç‹\" },\n      { value: \"D\", text: \"åšä¸ªå®‰é™çš„è§‚å¯Ÿè€…ï¼Œäº«å—æ—è§‚çš„è‡ªåœ¨\", roleMapping: \"éšèº«çŒ«\" },\n    ],\n  },\n  \n  {\n    id: 8,\n    category: \"æ·±åº¦äº¤æµåå¥½\",\n    scenarioText: \"ğŸ§  æœ‰äººæè®®ç©\\\"çµé­‚æ‹·é—®\\\"æ¸¸æˆï¼Œæ¯äººå›ç­”ä¸€ä¸ªæ·±åº¦é—®é¢˜...\",\n    questionText: \"ä½ çš„æ€åº¦æ˜¯ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"å¥½ç©ï¼ä½†é—®é¢˜åˆ«å¤ªæ²‰é‡å“¦ï½\\\" å–œæ¬¢è½»æ¾çš„æ·±åº¦\", roleMapping: \"å¤¸å¤¸è±š\" },\n      { value: \"B\", text: \"\\\"ç»ˆäºï¼æˆ‘å°±ç­‰æ·±åº¦å¯¹è¯å‘¢ï¼\\\" æ¸´æœ›å“²å­¦è®¨è®º\", roleMapping: \"æ²‰æ€çŒ«å¤´é¹°\" },\n      { value: \"C\", text: \"\\\"å¯ä»¥å‘€ï¼Œæˆ‘æ¥å¸®å¤§å®¶æ‰¾åˆ°å…±é¸£ç‚¹ï½\\\" è¿æ¥ä¸åŒçš„ç­”æ¡ˆ\", roleMapping: \"ç»‡ç½‘è››\" },\n      { value: \"D\", text: \"\\\"æˆ‘å¬å¤§å®¶çš„ï¼Œä¸å¤ªæƒ³åšç¬¬ä¸€ä¸ªå›ç­”çš„äºº...\\\" è§‚æœ›ä¸ºä¸»\", roleMapping: \"ç¨³å¦‚é¾Ÿ\" },\n    ],\n  },\n  \n  {\n    id: 9,\n    category: \"ç¤¾äº¤èƒ½é‡æ¶ˆè€—\",\n    scenarioText: \"âš¡ èšä¼šç»“æŸåï¼Œä½ çš„çŠ¶æ€æ˜¯ï¼Ÿ\",\n    questionText: \"å›åˆ°å®¶ï¼Œä½ çš„æ„Ÿå—æ˜¯ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"å¥½ç´¯ä½†å¥½çˆ½ï¼ä»Šæ™šèŠå¾—å¤ªå¼€å¿ƒäº†ï¼\\\" èƒ½é‡æ¶ˆè€—ä½†æ»¡è¶³\", roleMapping: \"å¼€å¿ƒæŸ¯åŸº\" },\n      { value: \"B\", text: \"\\\"æ„Ÿè§‰å¾ˆå……å®ï½å¤§å®¶éƒ½å¾ˆæ¸©æš–ï½\\\" èƒ½é‡å¹³ç¨³ï¼Œå¿ƒæƒ…æ„‰æ‚¦\", roleMapping: \"å¤ªé˜³é¸¡\" },\n      { value: \"C\", text: \"\\\"å—¯ï¼Œè¿˜ä¸é”™ï¼Œä½†éœ€è¦ç‹¬å¤„å……ç”µä¸€ä¼šå„¿...\\\" è½»åº¦ç–²æƒ«\", roleMapping: \"å®šå¿ƒå¤§è±¡\" },\n      { value: \"D\", text: \"\\\"ç»ˆäºå¯ä»¥å®‰é™äº†...\\\" ç¤¾äº¤ç”µé‡å½»åº•è€—å°½\", roleMapping: \"éšèº«çŒ«\" },\n    ],\n  },\n  \n  {\n    id: 10,\n    category: \"æ ¸å¿ƒç¤¾äº¤åŠ¨æœº\",\n    scenarioText: \"ğŸ å¦‚æœæœ‹å‹è¦ç”¨ä¸€å¥è¯ä»‹ç»ä½ ç»™æ–°æœ‹å‹...\",\n    questionText: \"ä½ å¸Œæœ›taæ€ä¹ˆè¯´ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"Taæ˜¯ä¸ªäººé—´å°å¤ªé˜³ï¼Œå’Œtaåœ¨ä¸€èµ·å¾ˆæ¸©æš–ï¼\\\"\", roleMapping: \"å¤ªé˜³é¸¡\" },\n      { value: \"B\", text: \"\\\"Taç‰¹åˆ«ä¼šç©ï¼Œæ€»èƒ½å‘ç°æœ‰è¶£çš„æ–°ä¸œè¥¿ï¼\\\"\", roleMapping: \"æœºæ™ºç‹\" },\n      { value: \"C\", text: \"\\\"Taçš„è„‘æ´è¶…å¤§ï¼Œåˆ›æ„æ— ç©·æ— å°½ï¼\\\"\", roleMapping: \"çµæ„Ÿç« é±¼\" },\n      { value: \"D\", text: \"\\\"Taå¾ˆé è°±ï¼Œå…³é”®æ—¶åˆ»ç‰¹åˆ«ç¨³ï¼\\\"\", roleMapping: \"å®šå¿ƒå¤§è±¡\" },\n    ],\n  },\n];\n\n/**\n * è§’è‰²æ˜ å°„è¡¨ï¼ˆç”¨äºåç«¯è®¡åˆ†ï¼‰\n * æ¯ä¸ªé—®é¢˜IDå¯¹åº”æ¯ä¸ªé€‰é¡¹å€¼åˆ°è§’è‰²çš„æ˜ å°„\n */\nexport const roleMapping: Record<number, Record<string, string>> = {\n  1: { A: \"å¼€å¿ƒæŸ¯åŸº\", B: \"æ·¡å®šæµ·è±š\", C: \"éšèº«çŒ«\", D: \"ç»‡ç½‘è››\" },\n  2: { A: \"æœºæ™ºç‹\", B: \"å¤¸å¤¸è±š\", C: \"æš–å¿ƒç†Š\", D: \"æ²‰æ€çŒ«å¤´é¹°\" },\n  3: { A: \"æš–å¿ƒç†Š\", B: \"å¤ªé˜³é¸¡\", C: \"éšèº«çŒ«\", D: \"æ·¡å®šæµ·è±š\" },\n  4: { A: \"çµæ„Ÿç« é±¼\", B: \"æ²‰æ€çŒ«å¤´é¹°\", C: \"ç»‡ç½‘è››\", D: \"å®šå¿ƒå¤§è±¡\" },\n  5: { A: \"å¼€å¿ƒæŸ¯åŸº\", B: \"æ·¡å®šæµ·è±š\", C: \"ç¨³å¦‚é¾Ÿ\", D: \"çµæ„Ÿç« é±¼\" },\n  6: { A: \"ç¨³å¦‚é¾Ÿ\", B: \"å¤¸å¤¸è±š\", C: \"æš–å¿ƒç†Š\", D: \"å®šå¿ƒå¤§è±¡\" },\n  7: { A: \"å¼€å¿ƒæŸ¯åŸº\", B: \"å¤ªé˜³é¸¡\", C: \"æœºæ™ºç‹\", D: \"éšèº«çŒ«\" },\n  8: { A: \"å¤¸å¤¸è±š\", B: \"æ²‰æ€çŒ«å¤´é¹°\", C: \"ç»‡ç½‘è››\", D: \"ç¨³å¦‚é¾Ÿ\" },\n  9: { A: \"å¼€å¿ƒæŸ¯åŸº\", B: \"å¤ªé˜³é¸¡\", C: \"å®šå¿ƒå¤§è±¡\", D: \"éšèº«çŒ«\" },\n  10: { A: \"å¤ªé˜³é¸¡\", B: \"æœºæ™ºç‹\", C: \"çµæ„Ÿç« é±¼\", D: \"å®šå¿ƒå¤§è±¡\" },\n};\n\n/**\n * æ£€æŸ¥é¢˜åº“è¦†ç›–åº¦\n * ç¡®ä¿12ä¸ªåŸå‹éƒ½æœ‰è¶³å¤Ÿçš„é¢˜ç›®è¦†ç›–\n */\nexport function validateCoverage(): Record<string, number> {\n  const coverage: Record<string, number> = {};\n  \n  personalityQuestions.forEach(q => {\n    q.options.forEach(opt => {\n      coverage[opt.roleMapping] = (coverage[opt.roleMapping] || 0) + 1;\n    });\n  });\n  \n  return coverage;\n}\n\n/**\n * è¡¥æµ‹é¢˜åº“ - ç”¨äºç²¾å‡†åŒºåˆ†ç›¸ä¼¼åŸå‹\n * å½“åŸºç¡€æµ‹è¯•çš„top2åŸå‹åˆ†æ•°å·®è·<3åˆ†æ—¶ï¼Œä»è¿™é‡Œé€‰æ‹©é’ˆå¯¹æ€§é¢˜ç›®\n */\nexport const supplementaryQuestions: Question[] = [\n  // 1. å¼€å¿ƒæŸ¯åŸº vs å¤ªé˜³é¸¡ - åŒºåˆ†ç‚¹ï¼šæç¬‘æ´»æ³¼ vs æ¸©æš–ç¨³å®š\n  {\n    id: 101,\n    category: \"èƒ½é‡è¡¨è¾¾é£æ ¼\",\n    scenarioText: \"ğŸ¤ KTVèšä¼šï¼Œå¤§å®¶ç‚¹å®Œæ­Œåœ¨èŠå¤©...\",\n    questionText: \"ä½ æ›´å¯èƒ½åšä»€ä¹ˆï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"ä¸»åŠ¨ç‚¹æç¬‘æ­Œæ›²ï¼Œå¸¦åŠ¨å…¨åœºä¸€èµ·å—¨ï¼\", roleMapping: \"å¼€å¿ƒæŸ¯åŸº\" },\n      { value: \"B\", text: \"æ¸©æŸ”åœ°é¼“åŠ±å®³ç¾çš„æœ‹å‹ï¼š\\\"ä½ å”±å¾—å¾ˆå¥½å¬ï¼Œæ¥ä¸€é¦–å§ï½\\\"\", roleMapping: \"å¤ªé˜³é¸¡\" },\n    ],\n  },\n  {\n    id: 102,\n    category: \"ç¤¾äº¤èŠ‚å¥åå¥½\",\n    scenarioText: \"ğŸŠ èšä¼šè¿›è¡Œåˆ°ååŠæ®µï¼Œæ°”æ°›æœ‰ç‚¹ç–²æƒ«...\",\n    questionText: \"ä½ çš„ååº”æ˜¯ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"æ¥æ¥æ¥ï¼ç©ä¸ªæ¸¸æˆé†’é†’ç¥ï¼\\\" æè®®ç ´å†°æ´»åŠ¨\", roleMapping: \"å¼€å¿ƒæŸ¯åŸº\" },\n      { value: \"B\", text: \"\\\"å¤§å®¶éƒ½è¾›è‹¦å•¦ï½è¦ä¸è¦åƒç‚¹ç”œå“ä¼‘æ¯ä¸€ä¸‹ï¼Ÿ\\\" æ¸©æŸ”ç…§é¡¾\", roleMapping: \"å¤ªé˜³é¸¡\" },\n    ],\n  },\n\n  // 2. æ·¡å®šæµ·è±š vs ç»‡ç½‘è›› - åŒºåˆ†ç‚¹ï¼šæ°›å›´å¹³è¡¡ vs äººé™…è¿æ¥\n  {\n    id: 103,\n    category: \"ç¤¾äº¤å…³æ³¨ç„¦ç‚¹\",\n    scenarioText: \"ğŸœ ä¸€ç¾¤äººåƒé¥­ï¼Œå‘ç°æœ‰ä¸¤ä¸ªäººå…¨ç¨‹æ²¡æ€ä¹ˆè¯´è¯...\",\n    questionText: \"ä½ ä¼šæ€ä¹ˆåšï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"è§‚å¯Ÿæ•´ä½“æ°›å›´ï¼Œé€‚æ—¶è°ƒæ•´è¯é¢˜è®©æ‰€æœ‰äººéƒ½èƒ½å‚ä¸\", roleMapping: \"æ·¡å®šæµ·è±š\" },\n      { value: \"B\", text: \"ä¸»åŠ¨è·Ÿè¿™ä¸¤ä¸ªäººèŠå¤©ï¼Œé—®\\\"ä½ æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ\\\"å»ºç«‹è¿æ¥\", roleMapping: \"ç»‡ç½‘è››\" },\n    ],\n  },\n  {\n    id: 104,\n    category: \"å†²çªå¤„ç†æ–¹å¼\",\n    scenarioText: \"ğŸ’¬ å¾®ä¿¡ç¾¤é‡Œä¸¤ä¸ªäººå› ä¸ºé€‰æ—¥æœŸèµ·äº†å°äº‰æ‰§...\",\n    questionText: \"ä½ çš„ç¬¬ä¸€ååº”æ˜¯ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"ç§èŠå…¶ä¸­ä¸€æ–¹ï¼š\\\"è¦ä¸å’±ä»¬å¦¥åä¸€ä¸‹ï¼Ÿ\\\" åè°ƒå¹³è¡¡\", roleMapping: \"æ·¡å®šæµ·è±š\" },\n      { value: \"B\", text: \"ç¾¤é‡Œ@ç¬¬ä¸‰ä¸ªäººï¼š\\\"XXä½ è§‰å¾—å‘¢ï¼Ÿ\\\" å¼•å…¥æ›´å¤šè§†è§’\", roleMapping: \"ç»‡ç½‘è››\" },\n    ],\n  },\n\n  // 3. æ²‰æ€çŒ«å¤´é¹° vs ç¨³å¦‚é¾Ÿ - åŒºåˆ†ç‚¹ï¼šä¸»åŠ¨æ€è€ƒåˆ†äº« vs æ²‰é»˜è§‚å¯Ÿ\n  {\n    id: 105,\n    category: \"å‘è¨€é¢‘ç‡\",\n    scenarioText: \"ğŸ§  å¤§å®¶åœ¨è®¨è®ºä¸€ä¸ªæœ‰æ·±åº¦çš„è¯é¢˜...\",\n    questionText: \"ä½ çš„å‚ä¸æ–¹å¼æ˜¯ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"é¢‘ç¹å‘è¨€ï¼Œæå‡ºå°–é”é—®é¢˜ï¼š\\\"ä½†è¿™ä¸ªé€»è¾‘æœ‰ä¸ªæ¼æ´...\\\"\", roleMapping: \"æ²‰æ€çŒ«å¤´é¹°\" },\n      { value: \"B\", text: \"å¤§éƒ¨åˆ†æ—¶é—´æ²‰é»˜æ€è€ƒï¼Œåªåœ¨å…³é”®æ—¶åˆ»è¯´ä¸€å¥æ€»ç»“\", roleMapping: \"ç¨³å¦‚é¾Ÿ\" },\n    ],\n  },\n  {\n    id: 106,\n    category: \"æ€è€ƒè¡¨è¾¾é£æ ¼\",\n    scenarioText: \"ğŸ’¡ æœ‰äººé—®ä½ å¯¹æŸä¸ªç¤¾ä¼šç°è±¡çš„çœ‹æ³•...\",\n    questionText: \"ä½ ä¼šï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"é©¬ä¸Šåˆ†æï¼š\\\"è¿™èƒŒååæ˜ äº†ä¸‰ä¸ªé—®é¢˜...\\\" å±•å¼€æ·±åº¦è®ºè¿°\", roleMapping: \"æ²‰æ€çŒ«å¤´é¹°\" },\n      { value: \"B\", text: \"åœé¡¿ä¸€ä¸‹ï¼š\\\"å—¯...æˆ‘å†æƒ³æƒ³\\\" ä¸æ€¥äºè¡¨è¾¾\", roleMapping: \"ç¨³å¦‚é¾Ÿ\" },\n    ],\n  },\n\n  // 4. æœºæ™ºç‹ vs çµæ„Ÿç« é±¼ - åŒºåˆ†ç‚¹ï¼šè¡ŒåŠ¨æ¢ç´¢ vs åˆ›æ„å‘æ•£\n  {\n    id: 107,\n    category: \"æ–°é²œäº‹ç‰©åå¥½\",\n    scenarioText: \"ğŸ¨ æœ‹å‹æ¨èäº†ä¸€ä¸ªæ–°å¼€çš„å±•è§ˆ...\",\n    questionText: \"ä½ çš„å…´å¥‹ç‚¹åœ¨å“ªï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"å“‡ï¼åœ¨å“ªé‡Œï¼Ÿæˆ‘ä»¬å‘¨æœ«å°±å»ï¼\\\" ç«‹åˆ»è§„åˆ’è¡ŒåŠ¨\", roleMapping: \"æœºæ™ºç‹\" },\n      { value: \"B\", text: \"\\\"å¥½æœ‰æ„æ€ï¼è¿™è®©æˆ‘æƒ³åˆ°å¯ä»¥åšä¸ª...\\\" è„‘æ´è”æƒ³åˆ›æ„\", roleMapping: \"çµæ„Ÿç« é±¼\" },\n    ],\n  },\n  {\n    id: 108,\n    category: \"ä¿¡æ¯å¤„ç†æ–¹å¼\",\n    scenarioText: \"ğŸ“± åˆ·åˆ°ä¸€ä¸ªæ–°å¥‡çš„ç”Ÿæ´»æ–¹å¼åˆ†äº«...\",\n    questionText: \"ä½ ä¼šï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"æˆ‘ä¹Ÿè¦è¯•è¯•ï¼\\\" æ”¶è—å¹¶è®¡åˆ’ä¸‹å‘¨å®è·µ\", roleMapping: \"æœºæ™ºç‹\" },\n      { value: \"B\", text: \"\\\"å¦‚æœæŠŠè¿™ä¸ªå’Œé‚£ä¸ªç»“åˆ...\\\" äº§ç”Ÿæ–°çš„åˆ›æ„çµæ„Ÿ\", roleMapping: \"çµæ„Ÿç« é±¼\" },\n    ],\n  },\n\n  // 5. æš–å¿ƒç†Š vs å¤¸å¤¸è±š - åŒºåˆ†ç‚¹ï¼šæ·±åº¦å…±æƒ… vs çƒ­æƒ…é¼“åŠ±\n  {\n    id: 109,\n    category: \"æƒ…æ„Ÿå›åº”æ–¹å¼\",\n    scenarioText: \"ğŸ˜¢ æœ‹å‹è¯´\\\"æˆ‘æœ€è¿‘å‹åŠ›å¥½å¤§...\\\"\",\n    questionText: \"ä½ ä¼šæ€ä¹ˆå›åº”ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"æˆ‘æ‡‚...ä¸Šæ¬¡æˆ‘ä¹Ÿç»å†è¿‡ç±»ä¼¼çš„...\\\" æ·±åº¦å…±æƒ…å¹¶åˆ†äº«æ•…äº‹\", roleMapping: \"æš–å¿ƒç†Š\" },\n      { value: \"B\", text: \"\\\"ä½ å·²ç»å¾ˆæ£’äº†ï¼åŠ æ²¹ï¼æˆ‘ç›¸ä¿¡ä½ å¯ä»¥çš„ï¼\\\" çƒ­æƒ…é¼“åŠ±\", roleMapping: \"å¤¸å¤¸è±š\" },\n    ],\n  },\n  {\n    id: 110,\n    category: \"æ”¯æŒè¡¨è¾¾æ–¹å¼\",\n    scenarioText: \"ğŸ¯ æœ‹å‹åˆ†äº«äº†ä¸€ä¸ªå°æˆå°±...\",\n    questionText: \"ä½ çš„ååº”æ˜¯ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"æˆ‘çŸ¥é“ä½ ä¸ºæ­¤ä»˜å‡ºäº†å¤šå°‘åŠªåŠ›...\\\" çœ‹åˆ°èƒŒåçš„æ•…äº‹\", roleMapping: \"æš–å¿ƒç†Š\" },\n      { value: \"B\", text: \"\\\"å“‡ï¼å¤ªå‰å®³äº†ï¼ä½ ç®€ç›´æ˜¯å¤©æ‰ï¼\\\" å¤¸å¼ å¼èµç¾\", roleMapping: \"å¤¸å¤¸è±š\" },\n    ],\n  },\n\n  // 6. å®šå¿ƒå¤§è±¡ vs æ·¡å®šæµ·è±š - åŒºåˆ†ç‚¹ï¼šè¢«åŠ¨ç¨³å®š vs ä¸»åŠ¨å¹³è¡¡\n  {\n    id: 111,\n    category: \"ç¾¤ä½“è§’è‰²å®šä½\",\n    scenarioText: \"ğŸ­ èšä¼šä¸Šå¤§å®¶æ„è§åˆ†æ­§ï¼Œæ°”æ°›æœ‰ç‚¹ä¹±...\",\n    questionText: \"ä½ å€¾å‘äºï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"ä¿æŒç¨³å®šå­˜åœ¨ï¼Œç»™å¤§å®¶å®‰å…¨æ„Ÿï¼Œä¸ä¸»åŠ¨ä»‹å…¥\", roleMapping: \"å®šå¿ƒå¤§è±¡\" },\n      { value: \"B\", text: \"ä¸»åŠ¨åè°ƒï¼š\\\"æˆ‘ä»¬å…ˆå¬å¬Açš„æƒ³æ³•ï¼Œå†å¬Bçš„...\\\"\", roleMapping: \"æ·¡å®šæµ·è±š\" },\n    ],\n  },\n  {\n    id: 112,\n    category: \"åº”å¯¹å˜åŒ–æ€åº¦\",\n    scenarioText: \"ğŸ“ åŸå®šè®¡åˆ’ä¸´æ—¶æ”¹äº†åœ°ç‚¹å’Œæ—¶é—´...\",\n    questionText: \"ä½ çš„ååº”æ˜¯ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"æ²¡äº‹ï¼Œæˆ‘éƒ½å¯ä»¥ï½\\\" åŒ…å®¹æ¥çº³å˜åŒ–\", roleMapping: \"å®šå¿ƒå¤§è±¡\" },\n      { value: \"B\", text: \"\\\"é‚£æˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆè°ƒæ•´æ¯”è¾ƒå¥½...\\\" ä¸»åŠ¨åè°ƒæ–¹æ¡ˆ\", roleMapping: \"æ·¡å®šæµ·è±š\" },\n    ],\n  },\n\n  // 7. éšèº«çŒ« vs ç¨³å¦‚é¾Ÿ - åŒºåˆ†ç‚¹ï¼šå®Œå…¨éšèº« vs ä½é¢‘ä½†æœ‰è´¨é‡çš„å‘è¨€\n  {\n    id: 113,\n    category: \"å­˜åœ¨æ„Ÿç®¡ç†\",\n    scenarioText: \"ğŸ’¬ ç¾¤èŠå¾ˆçƒ­é—¹ï¼Œå¤§å®¶éƒ½åœ¨å‘è¨€...\",\n    questionText: \"ä½ é€šå¸¸ä¼šï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"å…¨ç¨‹æ½œæ°´ï¼Œå¶å°”ç‚¹ä¸ªèµè¡¨ç¤ºåœ¨çœ‹\", roleMapping: \"éšèº«çŒ«\" },\n      { value: \"B\", text: \"è§‚å¯Ÿå¾ˆä¹…ï¼Œæœ€åå‘ä¸€æ¡é«˜è´¨é‡æ€»ç»“\", roleMapping: \"ç¨³å¦‚é¾Ÿ\" },\n    ],\n  },\n  {\n    id: 114,\n    category: \"è‡ªæˆ‘è¡¨è¾¾å€¾å‘\",\n    scenarioText: \"ğŸ¤ æœ‰äººç‚¹åé—®ä½ çš„æƒ³æ³•...\",\n    questionText: \"ä½ çš„å†…å¿ƒç‹¬ç™½æ˜¯ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"å•Š...è¢«cueåˆ°äº†...\\\" å¸Œæœ›å¿«é€Ÿåº”ä»˜è¿‡å»\", roleMapping: \"éšèº«çŒ«\" },\n      { value: \"B\", text: \"\\\"å—¯ï¼Œæˆ‘æ€è€ƒäº†ä¸€ä¸‹...\\\" è®¤çœŸåˆ†äº«è‡ªå·±çš„æ´å¯Ÿ\", roleMapping: \"ç¨³å¦‚é¾Ÿ\" },\n    ],\n  },\n\n  // 8. å¼€å¿ƒæŸ¯åŸº vs æœºæ™ºç‹ - åŒºåˆ†ç‚¹ï¼šç¤¾äº¤èƒ½é‡é‡Šæ”¾ vs å¥½å¥‡æ¢ç´¢\n  {\n    id: 115,\n    category: \"å‘¨æœ«è§„åˆ’\",\n    scenarioText: \"ğŸŒ… å‘¨äº”æ™šä¸Šï¼Œçªç„¶æœ‰ä¸€æ•´ä¸ªå‘¨æœ«ç©ºé—²...\",\n    questionText: \"ä½ æœ€æƒ³åšä»€ä¹ˆï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"å¬é›†æœ‹å‹å¼€æ´¾å¯¹ï¼\\\" ç¤¾äº¤èšä¼šå……ç”µ\", roleMapping: \"å¼€å¿ƒæŸ¯åŸº\" },\n      { value: \"B\", text: \"\\\"å»æ¢ç´¢é‚£å®¶æ–°å¼€çš„åº—ï¼\\\" å‘ç°æ–°é²œä½“éªŒ\", roleMapping: \"æœºæ™ºç‹\" },\n    ],\n  },\n\n  // 9. å¤ªé˜³é¸¡ vs æš–å¿ƒç†Š - åŒºåˆ†ç‚¹ï¼šæ™®ç…§æ¸©æš– vs æ·±åº¦é™ªä¼´\n  {\n    id: 116,\n    category: \"å…³æ€€èŒƒå›´\",\n    scenarioText: \"ğŸ‘¥ 10äººèšä¼šï¼Œä½ æ³¨æ„åˆ°ä¸€ä¸ªäººæƒ…ç»ªä½è½...\",\n    questionText: \"ä½ ä¼šï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"æå‡æ•´ä½“æ°›å›´è®©å¤§å®¶éƒ½å¼€å¿ƒï¼ŒåŒ…æ‹¬ta\", roleMapping: \"å¤ªé˜³é¸¡\" },\n      { value: \"B\", text: \"æ‰¾æœºä¼šå•ç‹¬é™ªä¼´taï¼Œæ·±åº¦å€¾å¬taçš„çƒ¦æ¼\", roleMapping: \"æš–å¿ƒç†Š\" },\n    ],\n  },\n\n  // 10. ç»‡ç½‘è›› vs æœºæ™ºç‹ - åŒºåˆ†ç‚¹ï¼šè¿æ¥äºº vs æ¢ç´¢äº‹\n  {\n    id: 117,\n    category: \"ç¤¾äº¤åŠ¨æœº\",\n    scenarioText: \"ğŸª æœ‰ä¸ªè·¨ç•Œæ²™é¾™æ´»åŠ¨ï¼Œå„è¡Œä¸šçš„äººéƒ½æœ‰...\",\n    questionText: \"ä½ æœ€å…´å¥‹çš„ç‚¹æ˜¯ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"å¯ä»¥è®¤è¯†å¥½å¤šæœ‰è¶£çš„äººï¼\\\" å»ºç«‹äººè„‰ç½‘ç»œ\", roleMapping: \"ç»‡ç½‘è››\" },\n      { value: \"B\", text: \"\\\"å¯ä»¥äº†è§£å¥½å¤šæ–°é¢†åŸŸï¼\\\" è·å–æ–°çŸ¥è¯†\", roleMapping: \"æœºæ™ºç‹\" },\n    ],\n  },\n\n  // 11. çµæ„Ÿç« é±¼ vs æ²‰æ€çŒ«å¤´é¹° - åŒºåˆ†ç‚¹ï¼šå‘æ•£åˆ›æ„ vs é€»è¾‘åˆ†æ\n  {\n    id: 118,\n    category: \"é—®é¢˜è§£å†³æ–¹å¼\",\n    scenarioText: \"ğŸ§© æœ‹å‹é‡åˆ°èŒä¸šé€‰æ‹©éš¾é¢˜...\",\n    questionText: \"ä½ ä¼šæä¾›ä»€ä¹ˆå¸®åŠ©ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"å“‡ï¼ä½ å¯ä»¥è¯•è¯•ABCï¼Œè¿˜å¯ä»¥...\\\" æä¾›10ä¸ªè„‘æ´æ–¹å‘\", roleMapping: \"çµæ„Ÿç« é±¼\" },\n      { value: \"B\", text: \"\\\"æˆ‘ä»¬å…ˆåˆ†ææ ¸å¿ƒé—®é¢˜æ˜¯ä»€ä¹ˆ...\\\" é€»è¾‘æ‹†è§£\", roleMapping: \"æ²‰æ€çŒ«å¤´é¹°\" },\n    ],\n  },\n\n  // 12. å®šå¿ƒå¤§è±¡ vs ç¨³å¦‚é¾Ÿ - åŒºåˆ†ç‚¹ï¼šæ¸©æš–åŒ…å®¹ vs å†·é™è§‚å¯Ÿ\n  {\n    id: 119,\n    category: \"ç¨³å®šæ€§æ¥æº\",\n    scenarioText: \"ğŸŒŠ å›¢é˜Ÿé‡åˆ°æŒ«æŠ˜ï¼Œæ°”æ°›ä½è¿·...\",\n    questionText: \"ä½ çš„å­˜åœ¨æ„Ÿä½“ç°åœ¨ï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"æ²¡äº‹çš„ï¼Œæˆ‘ä»¬ä¸€èµ·åº¦è¿‡ï½\\\" æ¸©æš–çš„æ”¯æŒåŒ…å®¹\", roleMapping: \"å®šå¿ƒå¤§è±¡\" },\n      { value: \"B\", text: \"ä¿æŒå†·é™ï¼Œè§‚å¯Ÿå±€åŠ¿ï¼Œç­‰å¾…åˆé€‚æ—¶æœºå‘è¨€\", roleMapping: \"ç¨³å¦‚é¾Ÿ\" },\n    ],\n  },\n\n  // 13. å¤¸å¤¸è±š vs å¤ªé˜³é¸¡ - åŒºåˆ†ç‚¹ï¼šä¸»åŠ¨èµç¾ vs æ•£å‘æ¸©æš–\n  {\n    id: 120,\n    category: \"æ­£èƒ½é‡è¡¨è¾¾\",\n    scenarioText: \"ğŸ¨ æœ‹å‹å±•ç¤ºäº†ä¸€å¹…ç”»ä½œ...\",\n    questionText: \"ä½ ä¼šï¼Ÿ\",\n    questionType: \"single\",\n    options: [\n      { value: \"A\", text: \"\\\"å“‡ï¼å¤ªæ£’äº†ï¼ä½ å¤ªæœ‰æ‰åäº†ï¼\\\" çƒ­æƒ…èµç¾\", roleMapping: \"å¤¸å¤¸è±š\" },\n      { value: \"B\", text: \"\\\"ç”»å¾—çœŸå¥½ï½\\\" æ¸©æŸ”å¾®ç¬‘ï¼Œæ•£å‘è‚¯å®šèƒ½é‡\", roleMapping: \"å¤ªé˜³é¸¡\" },\n    ],\n  },\n];\n\n/**\n * è¡¥æµ‹é¢˜æ˜ å°„è¡¨\n */\nexport const supplementaryRoleMapping: Record<number, Record<string, string>> = {\n  101: { A: \"å¼€å¿ƒæŸ¯åŸº\", B: \"å¤ªé˜³é¸¡\" },\n  102: { A: \"å¼€å¿ƒæŸ¯åŸº\", B: \"å¤ªé˜³é¸¡\" },\n  103: { A: \"æ·¡å®šæµ·è±š\", B: \"ç»‡ç½‘è››\" },\n  104: { A: \"æ·¡å®šæµ·è±š\", B: \"ç»‡ç½‘è››\" },\n  105: { A: \"æ²‰æ€çŒ«å¤´é¹°\", B: \"ç¨³å¦‚é¾Ÿ\" },\n  106: { A: \"æ²‰æ€çŒ«å¤´é¹°\", B: \"ç¨³å¦‚é¾Ÿ\" },\n  107: { A: \"æœºæ™ºç‹\", B: \"çµæ„Ÿç« é±¼\" },\n  108: { A: \"æœºæ™ºç‹\", B: \"çµæ„Ÿç« é±¼\" },\n  109: { A: \"æš–å¿ƒç†Š\", B: \"å¤¸å¤¸è±š\" },\n  110: { A: \"æš–å¿ƒç†Š\", B: \"å¤¸å¤¸è±š\" },\n  111: { A: \"å®šå¿ƒå¤§è±¡\", B: \"æ·¡å®šæµ·è±š\" },\n  112: { A: \"å®šå¿ƒå¤§è±¡\", B: \"æ·¡å®šæµ·è±š\" },\n  113: { A: \"éšèº«çŒ«\", B: \"ç¨³å¦‚é¾Ÿ\" },\n  114: { A: \"éšèº«çŒ«\", B: \"ç¨³å¦‚é¾Ÿ\" },\n  115: { A: \"å¼€å¿ƒæŸ¯åŸº\", B: \"æœºæ™ºç‹\" },\n  116: { A: \"å¤ªé˜³é¸¡\", B: \"æš–å¿ƒç†Š\" },\n  117: { A: \"ç»‡ç½‘è››\", B: \"æœºæ™ºç‹\" },\n  118: { A: \"çµæ„Ÿç« é±¼\", B: \"æ²‰æ€çŒ«å¤´é¹°\" },\n  119: { A: \"å®šå¿ƒå¤§è±¡\", B: \"ç¨³å¦‚é¾Ÿ\" },\n  120: { A: \"å¤¸å¤¸è±š\", B: \"å¤ªé˜³é¸¡\" },\n};\n\n/**\n * è·å–é’ˆå¯¹ç‰¹å®šåŸå‹å¯¹çš„è¡¥æµ‹é¢˜\n * @param archetype1 ç¬¬ä¸€ä¸ªåŸå‹\n * @param archetype2 ç¬¬äºŒä¸ªåŸå‹\n * @param count éœ€è¦çš„é¢˜ç›®æ•°é‡ï¼ˆé»˜è®¤3é¢˜ï¼‰\n */\nexport function getSupplementaryQuestions(\n  archetype1: string,\n  archetype2: string,\n  count: number = 3\n): Question[] {\n  const relevantQuestions = supplementaryQuestions.filter(q => {\n    const options = q.options.map(opt => opt.roleMapping);\n    return (\n      (options.includes(archetype1) && options.includes(archetype2)) ||\n      (options.includes(archetype2) && options.includes(archetype1))\n    );\n  });\n\n  // éšæœºæ‰“ä¹±å¹¶å–å‰countä¸ª\n  const shuffled = relevantQuestions.sort(() => Math.random() - 0.5);\n  return shuffled.slice(0, Math.min(count, shuffled.length));\n}\n\n// éªŒè¯è¦†ç›–åº¦ï¼ˆå¼€å‘ç¯å¢ƒè‡ªåŠ¨æ£€æŸ¥ï¼‰\nif (import.meta.env.DEV) {\n  const coverage = validateCoverage();\n  console.log(\"ğŸ“Š 12ä¸ªåŸå‹åŸºç¡€é¢˜åº“è¦†ç›–åº¦:\", coverage);\n  \n  const allArchetypes = [\n    \"å¼€å¿ƒæŸ¯åŸº\", \"å¤ªé˜³é¸¡\", \"å¤¸å¤¸è±š\", \"æœºæ™ºç‹\",\n    \"æ·¡å®šæµ·è±š\", \"ç»‡ç½‘è››\", \"æš–å¿ƒç†Š\", \"çµæ„Ÿç« é±¼\",\n    \"æ²‰æ€çŒ«å¤´é¹°\", \"å®šå¿ƒå¤§è±¡\", \"ç¨³å¦‚é¾Ÿ\", \"éšèº«çŒ«\"\n  ];\n  \n  const missing = allArchetypes.filter(a => !coverage[a] || coverage[a] < 2);\n  if (missing.length > 0) {\n    console.warn(\"âš ï¸ ä»¥ä¸‹åŸå‹è¦†ç›–ä¸è¶³ï¼ˆå°‘äº2é¢˜ï¼‰:\", missing);\n  }\n\n  // æµ‹è¯•è¡¥æµ‹é¢˜ç­›é€‰\n  console.log(\"ğŸ¯ è¡¥æµ‹é¢˜åº“æµ‹è¯•:\");\n  console.log(\"æŸ¯åŸºvså¤ªé˜³é¸¡:\", getSupplementaryQuestions(\"å¼€å¿ƒæŸ¯åŸº\", \"å¤ªé˜³é¸¡\", 3).length, \"é¢˜\");\n  console.log(\"æµ·è±švsè››:\", getSupplementaryQuestions(\"æ·¡å®šæµ·è±š\", \"ç»‡ç½‘è››\", 3).length, \"é¢˜\");\n}\n","size_bytes":22221},"server/archetypeConfig.ts":{"content":"/**\n * 12ä¸ªç¤¾äº¤æ°›å›´åŸå‹çš„å…­ç»´ç‰¹è´¨åˆ†æ•°å’Œæ´å¯Ÿé…ç½®\n */\n\nexport const roleTraits: Record<string, {\n  affinity: number;\n  openness: number;\n  conscientiousness: number;\n  emotionalStability: number;\n  extraversion: number;\n  positivity: number;\n}> = {\n  \"å¼€å¿ƒæŸ¯åŸº\": { affinity: 8, openness: 8, conscientiousness: 5, emotionalStability: 7, extraversion: 10, positivity: 10 },\n  \"å¤ªé˜³é¸¡\": { affinity: 9, openness: 7, conscientiousness: 7, emotionalStability: 9, extraversion: 9, positivity: 10 },\n  \"å¤¸å¤¸è±š\": { affinity: 9, openness: 6, conscientiousness: 6, emotionalStability: 7, extraversion: 8, positivity: 10 },\n  \"æœºæ™ºç‹\": { affinity: 7, openness: 10, conscientiousness: 6, emotionalStability: 7, extraversion: 8, positivity: 8 },\n  \"æ·¡å®šæµ·è±š\": { affinity: 8, openness: 7, conscientiousness: 8, emotionalStability: 10, extraversion: 7, positivity: 8 },\n  \"ç»‡ç½‘è››\": { affinity: 10, openness: 8, conscientiousness: 7, emotionalStability: 8, extraversion: 7, positivity: 7 },\n  \"æš–å¿ƒç†Š\": { affinity: 10, openness: 7, conscientiousness: 7, emotionalStability: 7, extraversion: 7, positivity: 8 },\n  \"çµæ„Ÿç« é±¼\": { affinity: 6, openness: 10, conscientiousness: 5, emotionalStability: 6, extraversion: 7, positivity: 7 },\n  \"æ²‰æ€çŒ«å¤´é¹°\": { affinity: 6, openness: 9, conscientiousness: 9, emotionalStability: 8, extraversion: 5, positivity: 6 },\n  \"å®šå¿ƒå¤§è±¡\": { affinity: 8, openness: 6, conscientiousness: 9, emotionalStability: 10, extraversion: 5, positivity: 7 },\n  \"ç¨³å¦‚é¾Ÿ\": { affinity: 7, openness: 8, conscientiousness: 8, emotionalStability: 9, extraversion: 3, positivity: 6 },\n  \"éšèº«çŒ«\": { affinity: 5, openness: 6, conscientiousness: 7, emotionalStability: 7, extraversion: 2, positivity: 5 },\n};\n\nexport const roleInsights: Record<string, {\n  strengths: string;\n  challenges: string;\n  idealFriendTypes: string[];\n}> = {\n  \"å¼€å¿ƒæŸ¯åŸº\": {\n    strengths: \"ä½ æ˜¯å›¢é˜Ÿçš„æ°¸åŠ¨æœºï¼æ“…é•¿ç”¨å¹½é»˜å’Œæ´»åŠ›ç‚¹ç‡ƒæ°”æ°›ï¼Œè®©é™Œç”Ÿäººç¬é—´æ‰“å¼€å¿ƒæ‰‰ã€‚ä½ çš„ç ´å†°èƒ½åŠ›ä¸€æµï¼Œèƒ½å¿«é€Ÿè®©èšä¼šä»å°´å°¬èµ°å‘æ¬¢ä¹ã€‚\",\n    challenges: \"æœ‰æ—¶èƒ½é‡è¿‡äºå……æ²›ï¼Œå¯èƒ½è®©å†…å‘çš„æœ‹å‹æ„Ÿåˆ°å‹åŠ›ï¼›éœ€è¦æ³¨æ„å€¾å¬å’Œç»™äºˆä»–äººå‘è¨€ç©ºé—´ï¼Œé¿å…è¿‡åº¦ä¸»å¯¼å¯¹è¯ã€‚\",\n    idealFriendTypes: [\"æš–å¿ƒç†Š\", \"å¤¸å¤¸è±š\", \"æ·¡å®šæµ·è±š\"],\n  },\n  \"å¤ªé˜³é¸¡\": {\n    strengths: \"ä½ æ˜¯äººé—´å°æš–æ°”ï¼æ•£å‘ç¨³å®šæ¸©æš–çš„æ­£èƒ½é‡ï¼Œè®©æ¯ä¸ªäººéƒ½æ„Ÿåˆ°è¢«ç…§é¡¾å’Œé‡è§†ã€‚ä½ çš„ä¹è§‚æ„ŸæŸ“åŠ›å¼ºï¼Œèƒ½æå‡æ•´ä½“å¹¸ç¦æ„Ÿã€‚\",\n    challenges: \"å¯èƒ½è¿‡äºè¿½æ±‚å’Œè°è€Œå¿½è§†å†²çªçš„å»ºè®¾æ€§ï¼›æœ‰æ—¶éœ€è¦å…è®¸ä¸€äº›ã€ŒçœŸå®çš„ä¸èˆ’æœã€æ¥ä¿ƒè¿›æ·±åº¦äº¤æµã€‚\",\n    idealFriendTypes: [\"æ·¡å®šæµ·è±š\", \"æš–å¿ƒç†Š\", \"å®šå¿ƒå¤§è±¡\"],\n  },\n  \"å¤¸å¤¸è±š\": {\n    strengths: \"ä½ æ˜¯æŒå£°å‘åŠ¨æœºï¼å–„äºå‘ç°å’Œæ”¾å¤§ä»–äººçš„ä¼˜ç‚¹ï¼Œæä¾›ç§¯æåé¦ˆå’Œé¼“åŠ±ã€‚ä½ çš„çƒ­æƒ…å›åº”èƒ½å¢å¼ºå›¢é˜Ÿä¿¡å¿ƒï¼Œè®©å®³ç¾çš„äººä¹Ÿæ•¢å‘å£°ã€‚\",\n    challenges: \"å¯èƒ½è¿‡äºé¿å…æ‰¹è¯„è€Œç¼ºä¹çœŸå®æ„è§ï¼›éœ€è¦åœ¨é¼“åŠ±ä»–äººçš„åŒæ—¶ä¹Ÿå‹‡äºè¡¨è¾¾å»ºè®¾æ€§åé¦ˆã€‚\",\n    idealFriendTypes: [\"æ²‰æ€çŒ«å¤´é¹°\", \"ç¨³å¦‚é¾Ÿ\", \"æš–å¿ƒç†Š\"],\n  },\n  \"æœºæ™ºç‹\": {\n    strengths: \"ä½ æ˜¯åŸå¸‚æ¢é™©å®¶ï¼å¥½å¥‡å¿ƒå¼ºã€ä¿¡æ¯çµé€šï¼Œæ€»èƒ½å‘ç°æ–°é²œæœ‰è¶£çš„ä½“éªŒã€‚ä½ å‹‡äºå°è¯•ï¼Œèƒ½ä¸ºèšä¼šå¸¦æ¥æƒŠå–œå’Œæ–°é²œæ„Ÿã€‚\",\n    challenges: \"å¯èƒ½è¿‡äºè¿½é€æ–°é²œè€Œç¼ºä¹æ·±åº¦ï¼›éœ€è¦å¹³è¡¡æ¢ç´¢å¹¿åº¦ä¸ä½“éªŒæ·±åº¦ï¼Œé¿å…æµ…å°è¾„æ­¢ã€‚\",\n    idealFriendTypes: [\"çµæ„Ÿç« é±¼\", \"ç»‡ç½‘è››\", \"å¤ªé˜³é¸¡\"],\n  },\n  \"æ·¡å®šæµ·è±š\": {\n    strengths: \"ä½ æ˜¯æ°”æ°›è°ƒé¢‘æ‰‹ï¼æƒ…å•†é«˜ã€åº”å˜åŠ›å¼ºï¼Œå–„äºå¹³è¡¡ç¾¤ä½“æ°›å›´ã€‚ä½ èƒ½å¯Ÿè§‰å¾®å¦™çš„æƒ…ç»ªæ³¢åŠ¨ï¼ŒåŠæ—¶åŒ–è§£æ½œåœ¨å†²çªã€‚\",\n    challenges: \"å¯èƒ½è¿‡äºå…³æ³¨å¹³è¡¡è€Œç¼ºä¹ä¸ªäººç«‹åœºï¼›æœ‰æ—¶éœ€è¦å‹‡äºè¡¨è¾¾çœŸå®æƒ³æ³•ï¼Œè€Œéåªæ˜¯åè°ƒä»–äººã€‚\",\n    idealFriendTypes: [\"å®šå¿ƒå¤§è±¡\", \"å¼€å¿ƒæŸ¯åŸº\", \"å¤ªé˜³é¸¡\"],\n  },\n  \"ç»‡ç½‘è››\": {\n    strengths: \"ä½ æ˜¯ç¤¾äº¤é»åˆå‰‚ï¼è§‚å¯Ÿæ•é”ï¼Œå–„äºå‘ç°ä¸åŒäººä¹‹é—´çš„å…±åŒç‚¹å¹¶å»ºç«‹è¿æ¥ã€‚ä½ çš„äººè„‰å¹¿æ³›ï¼Œèƒ½æ„å»ºä¸°å¯Œçš„ç¤¾äº¤ç½‘ç»œã€‚\",\n    challenges: \"å¯èƒ½è¿‡äºnetworkingè€Œç¼ºä¹æ·±åº¦å…³ç³»ï¼›éœ€è¦å¹³è¡¡å¹¿åº¦è¿æ¥ä¸æ·±åº¦å‹è°Šï¼Œé¿å…æµäºè¡¨é¢ã€‚\",\n    idealFriendTypes: [\"æœºæ™ºç‹\", \"æš–å¿ƒç†Š\", \"æ·¡å®šæµ·è±š\"],\n  },\n  \"æš–å¿ƒç†Š\": {\n    strengths: \"ä½ æ˜¯æ•…äº‹æ”¶è—å®¶ï¼å–„äºå€¾å¬å’Œå…±æƒ…ï¼Œèƒ½é€šè¿‡æ•…äº‹å»ºç«‹æ·±åº¦æƒ…æ„Ÿè¿æ¥ã€‚ä½ çš„æ¸©æš–åŒ…å®¹è®©äººæ„¿æ„æ•å¼€å¿ƒæ‰‰ã€‚\",\n    challenges: \"å¯èƒ½è¿‡äºæ„Ÿæ€§è€Œå¿½è§†ç†æ€§åˆ†æï¼›éœ€è¦å¹³è¡¡æƒ…æ„Ÿè¡¨è¾¾ä¸å®¢è§‚æ€è€ƒï¼Œé¿å…è¿‡åº¦å…±æƒ…å¯¼è‡´ç–²æƒ«ã€‚\",\n    idealFriendTypes: [\"æ²‰æ€çŒ«å¤´é¹°\", \"å¼€å¿ƒæŸ¯åŸº\", \"å®šå¿ƒå¤§è±¡\"],\n  },\n  \"çµæ„Ÿç« é±¼\": {\n    strengths: \"ä½ æ˜¯åˆ›æ„å–·å°„å™¨ï¼æ€ç»´è·³è·ƒã€è”æƒ³ä¸°å¯Œï¼Œèƒ½æ¿€å‘é›†ä½“è„‘æš´ã€‚ä½ çš„å¤šçº¿ç¨‹å‘æ•£æ€ç»´ä¸ºå›¢é˜Ÿå¸¦æ¥æ— ç©·åˆ›æ„ã€‚\",\n    challenges: \"å¯èƒ½è¿‡äºå‘æ•£è€Œç¼ºä¹è½åœ°æ€§ï¼›éœ€è¦æ³¨æ„æ”¶æ•›æ€ç»´ï¼Œå°†åˆ›æ„è½¬åŒ–ä¸ºå¯æ‰§è¡Œçš„æ–¹æ¡ˆã€‚\",\n    idealFriendTypes: [\"æœºæ™ºç‹\", \"å®šå¿ƒå¤§è±¡\", \"æ²‰æ€çŒ«å¤´é¹°\"],\n  },\n  \"æ²‰æ€çŒ«å¤´é¹°\": {\n    strengths: \"ä½ æ˜¯å“²å­¦å¸¦å¸ˆï¼é€»è¾‘æ€§å¼ºã€å–„äºæé—®ï¼Œèƒ½æå‡å¯¹è¯è´¨é‡å¹¶æ¿€å‘æ·±åº¦æ€è€ƒã€‚ä½ çš„æ´å¯ŸåŠ›èƒ½å‘ç°ç›²ç‚¹ã€‚\",\n    challenges: \"å¯èƒ½è¿‡äºä¸¥è‚ƒè€Œç¼ºä¹è½»æ¾æ„Ÿï¼›éœ€è¦å¹³è¡¡æ·±åº¦ä¸è¶£å‘³æ€§ï¼Œé¿å…è®©è®¨è®ºè¿‡äºå­¦æœ¯åŒ–ã€‚\",\n    idealFriendTypes: [\"ç¨³å¦‚é¾Ÿ\", \"æš–å¿ƒç†Š\", \"çµæ„Ÿç« é±¼\"],\n  },\n  \"å®šå¿ƒå¤§è±¡\": {\n    strengths: \"ä½ æ˜¯å›¢é˜Ÿå®šç›˜æ˜Ÿï¼ç¨³é‡å¯é ã€åŒ…å®¹è±è¾¾ï¼Œç»™äººå¼ºçƒˆçš„å®‰å…¨æ„Ÿã€‚ä½ çš„ç¨³å®šæ”¯æŒæ˜¯å›¢é˜Ÿçš„åç›¾ã€‚\",\n    challenges: \"å¯èƒ½è¿‡äºç¨³å®šè€Œç¼ºä¹å˜åŒ–ï¼›æœ‰æ—¶éœ€è¦é€‚å½“å†’é™©å’Œå°è¯•æ–°äº‹ç‰©ï¼Œé¿å…è¿‡äºä¿å®ˆã€‚\",\n    idealFriendTypes: [\"æ·¡å®šæµ·è±š\", \"æš–å¿ƒç†Š\", \"å¤ªé˜³é¸¡\"],\n  },\n  \"ç¨³å¦‚é¾Ÿ\": {\n    strengths: \"ä½ æ˜¯äººé—´è§‚å¯Ÿå®¶ï¼æ€è€ƒæ·±å…¥ã€è¨€ç®€æ„èµ…ï¼Œèƒ½æä¾›ç‹¬åˆ°è§è§£å’Œæ·±åº¦æ´å¯Ÿã€‚ä½ çš„ä½é¢‘å‘è¨€å¾€å¾€ä¸€é’ˆè§è¡€ã€‚\",\n    challenges: \"å¯èƒ½è¿‡äºæ²‰é»˜è€Œéš¾ä»¥è¢«ç†è§£ï¼›éœ€è¦é€‚å½“å¢åŠ è¡¨è¾¾é¢‘ç‡ï¼Œè®©ä»–äººäº†è§£ä½ çš„æ™ºæ…§ã€‚\",\n    idealFriendTypes: [\"éšèº«çŒ«\", \"æ²‰æ€çŒ«å¤´é¹°\", \"æš–å¿ƒç†Š\"],\n  },\n  \"éšèº«çŒ«\": {\n    strengths: \"ä½ æ˜¯å®‰é™é™ªä¼´è€…ï¼å­˜åœ¨æ„Ÿä½ä½†ä¸æ–½åŠ å‹åŠ›ï¼Œäº«å—æ—è§‚å¹¶æä¾›è½»æ¾æ°›å›´ã€‚ä½ çš„å®‰é™è®©ä»–äººæ„Ÿåˆ°è‡ªåœ¨ã€‚\",\n    challenges: \"å¯èƒ½è¿‡äºéšèº«è€Œè¢«å¿½è§†ï¼›éœ€è¦é€‚å½“è¡¨è¾¾è‡ªå·±çš„éœ€æ±‚å’Œæƒ³æ³•ï¼Œé¿å…å®Œå…¨è¾¹ç¼˜åŒ–ã€‚\",\n    idealFriendTypes: [\"ç¨³å¦‚é¾Ÿ\", \"å®šå¿ƒå¤§è±¡\", \"æš–å¿ƒç†Š\"],\n  },\n};\n","size_bytes":6501},"client/src/lib/archetypeCompatibility.ts":{"content":"// Archetype Compatibility Matrix\n// 12x12 compatibility scoring based on energy levels and social styles\n// Scores range from 0 to 100, where:\n// 90-100: Best Matches (complementary personalities)\n// 70-89: Good Matches (compatible with some chemistry)\n// 50-69: Moderate Matches (can work but may need adjustment)\n// 30-49: Challenging Matches (different vibes, requires effort)\n// 0-29: Difficult Matches (very different energies)\n\nconst archetypes = [\n  'å¼€å¿ƒæŸ¯åŸº',   // 0: High energy, warm & extroverted\n  'å¤ªé˜³é¸¡',     // 1: High energy, optimistic & expressive\n  'å¤¸å¤¸è±š',     // 2: High energy, affirming & supportive\n  'æœºæ™ºç‹',     // 3: High energy, clever & observant\n  'æ·¡å®šæµ·è±š',   // 4: Medium energy, calm & intuitive\n  'ç»‡ç½‘è››',     // 5: Medium energy, thoughtful & connector\n  'æš–å¿ƒç†Š',     // 6: Medium energy, nurturing & protective\n  'çµæ„Ÿç« é±¼',   // 7: Medium energy, creative & expressive\n  'æ²‰æ€çŒ«å¤´é¹°', // 8: Low energy, analytical & thoughtful\n  'å®šå¿ƒå¤§è±¡',   // 9: Low energy, stable & grounded\n  'ç¨³å¦‚é¾Ÿ',     // 10: Very low energy, steady & peaceful\n  'éšèº«çŒ«',     // 11: Very low energy, introspective & observant\n];\n\n// Compatibility matrix (symmetric)\nexport const compatibilityMatrix: Record<string, Record<string, number>> = {\n  'å¼€å¿ƒæŸ¯åŸº': {\n    'å¼€å¿ƒæŸ¯åŸº': 85,\n    'å¤ªé˜³é¸¡': 92,\n    'å¤¸å¤¸è±š': 88,\n    'æœºæ™ºç‹': 80,\n    'æ·¡å®šæµ·è±š': 70,\n    'ç»‡ç½‘è››': 72,\n    'æš–å¿ƒç†Š': 75,\n    'çµæ„Ÿç« é±¼': 78,\n    'æ²‰æ€çŒ«å¤´é¹°': 55,\n    'å®šå¿ƒå¤§è±¡': 58,\n    'ç¨³å¦‚é¾Ÿ': 45,\n    'éšèº«çŒ«': 48,\n  },\n  'å¤ªé˜³é¸¡': {\n    'å¼€å¿ƒæŸ¯åŸº': 92,\n    'å¤ªé˜³é¸¡': 88,\n    'å¤¸å¤¸è±š': 85,\n    'æœºæ™ºç‹': 82,\n    'æ·¡å®šæµ·è±š': 72,\n    'ç»‡ç½‘è››': 70,\n    'æš–å¿ƒç†Š': 78,\n    'çµæ„Ÿç« é±¼': 80,\n    'æ²‰æ€çŒ«å¤´é¹°': 58,\n    'å®šå¿ƒå¤§è±¡': 62,\n    'ç¨³å¦‚é¾Ÿ': 48,\n    'éšèº«çŒ«': 52,\n  },\n  'å¤¸å¤¸è±š': {\n    'å¼€å¿ƒæŸ¯åŸº': 88,\n    'å¤ªé˜³é¸¡': 85,\n    'å¤¸å¤¸è±š': 86,\n    'æœºæ™ºç‹': 78,\n    'æ·¡å®šæµ·è±š': 74,\n    'ç»‡ç½‘è››': 76,\n    'æš–å¿ƒç†Š': 82,\n    'çµæ„Ÿç« é±¼': 79,\n    'æ²‰æ€çŒ«å¤´é¹°': 60,\n    'å®šå¿ƒå¤§è±¡': 64,\n    'ç¨³å¦‚é¾Ÿ': 50,\n    'éšèº«çŒ«': 54,\n  },\n  'æœºæ™ºç‹': {\n    'å¼€å¿ƒæŸ¯åŸº': 80,\n    'å¤ªé˜³é¸¡': 82,\n    'å¤¸å¤¸è±š': 78,\n    'æœºæ™ºç‹': 84,\n    'æ·¡å®šæµ·è±š': 75,\n    'ç»‡ç½‘è››': 80,\n    'æš–å¿ƒç†Š': 72,\n    'çµæ„Ÿç« é±¼': 82,\n    'æ²‰æ€çŒ«å¤´é¹°': 68,\n    'å®šå¿ƒå¤§è±¡': 65,\n    'ç¨³å¦‚é¾Ÿ': 52,\n    'éšèº«çŒ«': 60,\n  },\n  'æ·¡å®šæµ·è±š': {\n    'å¼€å¿ƒæŸ¯åŸº': 70,\n    'å¤ªé˜³é¸¡': 72,\n    'å¤¸å¤¸è±š': 74,\n    'æœºæ™ºç‹': 75,\n    'æ·¡å®šæµ·è±š': 82,\n    'ç»‡ç½‘è››': 85,\n    'æš–å¿ƒç†Š': 80,\n    'çµæ„Ÿç« é±¼': 84,\n    'æ²‰æ€çŒ«å¤´é¹°': 72,\n    'å®šå¿ƒå¤§è±¡': 75,\n    'ç¨³å¦‚é¾Ÿ': 65,\n    'éšèº«çŒ«': 70,\n  },\n  'ç»‡ç½‘è››': {\n    'å¼€å¿ƒæŸ¯åŸº': 72,\n    'å¤ªé˜³é¸¡': 70,\n    'å¤¸å¤¸è±š': 76,\n    'æœºæ™ºç‹': 80,\n    'æ·¡å®šæµ·è±š': 85,\n    'ç»‡ç½‘è››': 80,\n    'æš–å¿ƒç†Š': 82,\n    'çµæ„Ÿç« é±¼': 86,\n    'æ²‰æ€çŒ«å¤´é¹°': 75,\n    'å®šå¿ƒå¤§è±¡': 78,\n    'ç¨³å¦‚é¾Ÿ': 68,\n    'éšèº«çŒ«': 72,\n  },\n  'æš–å¿ƒç†Š': {\n    'å¼€å¿ƒæŸ¯åŸº': 75,\n    'å¤ªé˜³é¸¡': 78,\n    'å¤¸å¤¸è±š': 82,\n    'æœºæ™ºç‹': 72,\n    'æ·¡å®šæµ·è±š': 80,\n    'ç»‡ç½‘è››': 82,\n    'æš–å¿ƒç†Š': 84,\n    'çµæ„Ÿç« é±¼': 80,\n    'æ²‰æ€çŒ«å¤´é¹°': 70,\n    'å®šå¿ƒå¤§è±¡': 76,\n    'ç¨³å¦‚é¾Ÿ': 62,\n    'éšèº«çŒ«': 66,\n  },\n  'çµæ„Ÿç« é±¼': {\n    'å¼€å¿ƒæŸ¯åŸº': 78,\n    'å¤ªé˜³é¸¡': 80,\n    'å¤¸å¤¸è±š': 79,\n    'æœºæ™ºç‹': 82,\n    'æ·¡å®šæµ·è±š': 84,\n    'ç»‡ç½‘è››': 86,\n    'æš–å¿ƒç†Š': 80,\n    'çµæ„Ÿç« é±¼': 82,\n    'æ²‰æ€çŒ«å¤´é¹°': 74,\n    'å®šå¿ƒå¤§è±¡': 72,\n    'ç¨³å¦‚é¾Ÿ': 64,\n    'éšèº«çŒ«': 68,\n  },\n  'æ²‰æ€çŒ«å¤´é¹°': {\n    'å¼€å¿ƒæŸ¯åŸº': 55,\n    'å¤ªé˜³é¸¡': 58,\n    'å¤¸å¤¸è±š': 60,\n    'æœºæ™ºç‹': 68,\n    'æ·¡å®šæµ·è±š': 72,\n    'ç»‡ç½‘è››': 75,\n    'æš–å¿ƒç†Š': 70,\n    'çµæ„Ÿç« é±¼': 74,\n    'æ²‰æ€çŒ«å¤´é¹°': 80,\n    'å®šå¿ƒå¤§è±¡': 85,\n    'ç¨³å¦‚é¾Ÿ': 78,\n    'éšèº«çŒ«': 82,\n  },\n  'å®šå¿ƒå¤§è±¡': {\n    'å¼€å¿ƒæŸ¯åŸº': 58,\n    'å¤ªé˜³é¸¡': 62,\n    'å¤¸å¤¸è±š': 64,\n    'æœºæ™ºç‹': 65,\n    'æ·¡å®šæµ·è±š': 75,\n    'ç»‡ç½‘è››': 78,\n    'æš–å¿ƒç†Š': 76,\n    'çµæ„Ÿç« é±¼': 72,\n    'æ²‰æ€çŒ«å¤´é¹°': 85,\n    'å®šå¿ƒå¤§è±¡': 82,\n    'ç¨³å¦‚é¾Ÿ': 80,\n    'éšèº«çŒ«': 84,\n  },\n  'ç¨³å¦‚é¾Ÿ': {\n    'å¼€å¿ƒæŸ¯åŸº': 45,\n    'å¤ªé˜³é¸¡': 48,\n    'å¤¸å¤¸è±š': 50,\n    'æœºæ™ºç‹': 52,\n    'æ·¡å®šæµ·è±š': 65,\n    'ç»‡ç½‘è››': 68,\n    'æš–å¿ƒç†Š': 62,\n    'çµæ„Ÿç« é±¼': 64,\n    'æ²‰æ€çŒ«å¤´é¹°': 78,\n    'å®šå¿ƒå¤§è±¡': 80,\n    'ç¨³å¦‚é¾Ÿ': 85,\n    'éšèº«çŒ«': 88,\n  },\n  'éšèº«çŒ«': {\n    'å¼€å¿ƒæŸ¯åŸº': 48,\n    'å¤ªé˜³é¸¡': 52,\n    'å¤¸å¤¸è±š': 54,\n    'æœºæ™ºç‹': 60,\n    'æ·¡å®šæµ·è±š': 70,\n    'ç»‡ç½‘è››': 72,\n    'æš–å¿ƒç†Š': 66,\n    'çµæ„Ÿç« é±¼': 68,\n    'æ²‰æ€çŒ«å¤´é¹°': 82,\n    'å®šå¿ƒå¤§è±¡': 84,\n    'ç¨³å¦‚é¾Ÿ': 88,\n    'éšèº«çŒ«': 86,\n  },\n};\n\nexport function getArchetypeCompatibility(primaryRole: string, targetRole: string): number {\n  return compatibilityMatrix[primaryRole]?.[targetRole] ?? 50;\n}\n\nexport function getTopCompatibleArchetypes(primaryRole: string, limit: number = 5) {\n  const compatibility = compatibilityMatrix[primaryRole];\n  if (!compatibility) return [];\n\n  return archetypes\n    .filter((arch) => arch !== primaryRole)\n    .map((arch) => ({\n      archetype: arch,\n      score: compatibility[arch],\n    }))\n    .sort((a, b) => b.score - a.score)\n    .slice(0, limit);\n}\n\nexport function getCompatibilityCategory(score: number): string {\n  if (score >= 90) return 'æœ€ä½³æ­æ¡£';\n  if (score >= 70) return 'å¥½æ­æ¡£';\n  if (score >= 50) return 'å¯æ­æ¡£';\n  if (score >= 30) return 'éœ€è¦ç£¨åˆ';\n  return 'å·®å¼‚è¾ƒå¤§';\n}\n","size_bytes":5639}},"version":2}